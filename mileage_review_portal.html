<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alice.care - Mileage Review v3.8</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #E5ECF3;
            min-height: 100vh;
            padding: 20px;
        }
        
        .nav-bar {
            max-width: 1400px;
            margin: 0 auto 20px;
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
        }
        
        .logo .alice {
            color: #F57600;
            font-weight: 700;
        }
        
        .logo .dot {
            color: #F57600;
            font-weight: 700;
            margin: 0 -2px;
        }
        
        .logo .care {
            color: #1A365C;
            font-weight: 400;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15);
            overflow: hidden;
        }
        
        .header {
            background: #1A365C;
            color: white;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .lookup-section {
            padding: 30px;
            background: #E5ECF3;
            border-bottom: 2px solid #D3D7DF;
        }
        
        .lookup-title {
            font-size: 18px;
            color: #1A365C;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .lookup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 13px;
            color: #1A365C;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .required {
            color: #FF7475;
        }
        
        input[type="text"],
        input[type="number"] {
            padding: 10px 14px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #F57600;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 118, 0, 0.3);
        }
        
        .btn-success {
            background: #62B790;
            color: white;
            margin-left: 10px;
        }
        
        .btn-success:hover {
            background: #52a780;
            transform: translateY(-2px);
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #E5ECF3;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #F57600;
        }
        
        .stat-card h3 {
            font-size: 12px;
            color: #3D3D3D;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .stat-card .number {
            font-size: 28px;
            color: #1A365C;
            font-weight: 700;
        }
        
        .review-section {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #3D3D3D;
        }
        
        .loading-spinner {
            border: 4px solid #E5ECF3;
            border-top: 4px solid #F57600;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Full Page Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #F57600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-overlay .loading-text {
            color: white;
            font-size: 16px;
            margin-top: 16px;
            font-weight: 500;
        }
        
        .loading-overlay .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-top: 8px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Collapsible Export Section */
        .export-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid #D3D7DF;
            margin-bottom: 0;
        }
        
        .export-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .export-header-left:hover {
            opacity: 0.7;
        }
        
        .export-header-left h3 {
            font-size: 16px;
            color: #1A365C;
            font-weight: 600;
            margin: 0;
        }
        
        .export-toggle {
            width: 24px;
            height: 24px;
            background: #1A365C;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        
        .export-toggle.expanded {
            transform: rotate(45deg);
        }
        
        .export-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .export-content.expanded {
            max-height: 1000px;
        }
        
        .export-content-inner {
            padding-top: 20px;
        }
        
        .notice-box {
            background: #FFF4E5;
            border-left: 4px solid #F57600;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .notice-box p {
            color: #3D3D3D;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* Rate Reminder Banner */
        .rate-reminder-banner {
            background: linear-gradient(135deg, #FFF4E5 0%, #FFE4CC 100%);
            border: 2px solid #F57600;
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .rate-reminder-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .rate-reminder-icon {
            font-size: 32px;
        }
        
        .rate-reminder-text h3 {
            color: #1A365C;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .rate-reminder-text p {
            color: #3D3D3D;
            font-size: 13px;
        }
        
        .rate-reminder-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .rate-reminder-actions .btn {
            white-space: nowrap;
        }
        
        /* Rate Settings in Nav */
        .rate-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #3D3D3D;
        }
        
        .rate-badge {
            background: #E5ECF3;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            color: #1A365C;
        }
        
        .rate-edit-btn {
            background: none;
            border: none;
            color: #F57600;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .rate-edit-btn:hover {
            background: #FFF4E5;
        }
        
        /* Rate Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #1A365C;
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9CA3AF;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #3D3D3D;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .rate-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .rate-input-group label {
            font-size: 14px;
            color: #3D3D3D;
            min-width: 120px;
        }
        
        .rate-input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            font-family: inherit;
            text-align: center;
        }
        
        .rate-input-group input:focus {
            outline: none;
            border-color: #F57600;
        }
        
        .rate-input-prefix {
            font-size: 18px;
            font-weight: 600;
            color: #1A365C;
        }
        
        .rate-history {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .rate-history h4 {
            font-size: 13px;
            color: #6B7280;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .rate-history-item {
            font-size: 13px;
            color: #3D3D3D;
            padding: 5px 0;
            border-bottom: 1px solid #E5ECF3;
        }
        
        .rate-history-item:last-child {
            border-bottom: none;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-footer .btn {
            padding: 10px 20px;
        }
        
        .btn-secondary {
            background: #E5ECF3;
            color: #1A365C;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-secondary:hover {
            background: #D3D7DF;
        }
        
        .current-rate-display {
            text-align: center;
            padding: 15px;
            background: #E5ECF3;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .current-rate-display .rate-value {
            font-size: 36px;
            font-weight: 700;
            color: #1A365C;
        }
        
        .current-rate-display .rate-label {
            font-size: 13px;
            color: #6B7280;
        }
        
        /* Import Section Styles */
        .import-section {
            padding: 30px;
            background: #E5ECF3;
            border-bottom: 2px solid #D3D7DF;
        }
        
        .import-title {
            font-size: 18px;
            color: #1A365C;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .import-box {
            background: white;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #F57600;
        }
        
        .import-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .import-row .file-input-wrapper {
            flex: 1;
            min-width: 0;
        }
        
        .import-row .btn {
            flex-shrink: 0;
            white-space: nowrap;
            margin: 0;
        }
        
        .file-input-wrapper input[type="file"] {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            background: white;
        }
        
        .file-input-wrapper input[type="file"]::file-selector-button {
            padding: 8px 16px;
            background: #1A365C;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            margin-right: 10px;
        }
        
        .file-input-wrapper input[type="file"]::file-selector-button:hover {
            background: #2d4a73;
        }
        
        .import-info {
            font-size: 12px;
            color: #3D3D3D;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .import-info::before {
            content: "‚ÑπÔ∏è";
        }
        
        .import-message {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }
        
        .import-message.success {
            background: #D1FAE5;
            color: #065F46;
            border-left: 4px solid #10B981;
        }
        
        .import-message.error {
            background: #FEE2E2;
            color: #991B1B;
            border-left: 4px solid #EF4444;
        }
        
        .import-loading {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 13px;
            color: #3D3D3D;
        }
        
        .import-spinner {
            border: 3px solid #E5ECF3;
            border-top: 3px solid #F57600;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        /* Table Styles */
        .review-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .review-table thead tr {
            background: #1A365C;
            color: white;
        }
        
        .review-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        
        .review-table tbody tr {
            border-bottom: 1px solid #E5ECF3;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .review-table tbody tr:hover {
            background: #F9FAFB;
        }
        
        .review-table tbody tr.expanded {
            background: #E5ECF3;
        }
        
        .review-table td {
            padding: 15px 12px;
            font-size: 14px;
            color: #3D3D3D;
        }
        
        .employee-id {
            font-weight: 600;
            color: #1A365C;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-submitted {
            background: #D4F4E2;
            color: #0A7D4A;
        }
        
        .status-pending {
            background: #FFF4E5;
            color: #D97706;
        }
        
        .expand-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 18px;
            text-align: center;
            border: 2px solid #1A365C;
            border-radius: 4px;
            color: #1A365C;
            font-weight: 700;
            font-size: 16px;
            margin-right: 8px;
            transition: all 0.2s;
        }
        
        tr.expanded .expand-icon {
            background: #1A365C;
            color: white;
        }
        
        /* Detail Row Styles */
        .detail-row {
            display: none;
        }
        
        .detail-row.show {
            display: table-row;
        }
        
        .detail-cell {
            padding: 0 !important;
            background: #F9FAFB;
        }
        
        .detail-content {
            padding: 20px 30px;
        }
        
        .services-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .services-table thead tr {
            background: #E5ECF3;
            color: #1A365C;
        }
        
        .services-table th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }
        
        .services-table td {
            padding: 10px 12px;
            font-size: 13px;
            border-bottom: 1px solid #E5ECF3;
        }
        
        .services-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .commute-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: #9CA3AF;
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .services-table tfoot {
            background: #E5ECF3;
            font-weight: 600;
        }
        
        .services-table tfoot td {
            padding: 12px;
            border-top: 2px solid #1A365C;
        }
        
        .export-section {
            background: #E5ECF3;
            padding: 25px 30px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .export-section h3 {
            font-size: 16px;
            color: #1A365C;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .text-preview {
            background: white;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #1A365C;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            white-space: pre;
        }
        
        .text-right {
            text-align: left;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .nav-bar {
                padding: 12px 15px;
                margin-bottom: 15px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .import-section {
                padding: 20px 15px;
            }
            
            .import-grid {
                grid-template-columns: 1fr;
            }
            
            .import-box {
                padding: 20px 15px;
            }
            
            .lookup-section {
                padding: 20px 15px;
            }
            
            .lookup-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 12px;
            }
            
            .review-section {
                padding: 20px 15px;
            }
            
            .export-section {
                padding: 15px;
            }
            
            .btn {
                width: 100%;
                padding: 14px 20px;
                margin-left: 0 !important;
                margin-top: 10px;
            }
            
            /* Make tables scrollable on mobile */
            .review-table, .services-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .review-table td, .review-table th,
            .services-table td, .services-table th {
                min-width: 80px;
                white-space: nowrap;
            }
            
            /* Adjust detail rows for mobile */
            .detail-row td {
                padding: 10px !important;
            }
            
            .text-preview {
                font-size: 11px;
                max-height: 200px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .lookup-title {
                font-size: 16px;
            }
            
            .stat-card .number {
                font-size: 22px;
            }
            
            .expand-icon {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Processing...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait</div>
    </div>

    <!-- Rate Settings Modal -->
    <div id="rateModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Mileage Rate Settings</h2>
                <button class="modal-close" onclick="closeRateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="current-rate-display">
                    <div class="rate-value" id="modalCurrentRate">$0.70</div>
                    <div class="rate-label">Current Rate per Mile</div>
                </div>
                
                <div class="rate-input-group">
                    <label>New Rate:</label>
                    <span class="rate-input-prefix">$</span>
                    <input type="number" id="newRateInput" step="0.01" min="0" max="5" placeholder="0.70">
                    <span style="color: #6B7280; font-size: 13px;">per mile</span>
                </div>
                
                <div class="notice-box" style="margin-bottom: 0;">
                    <p><strong>Note:</strong> The IRS standard mileage rate typically updates annually on January 1st.</p>
                    <p>Check <a href="https://www.irs.gov/tax-professionals/standard-mileage-rates" target="_blank" style="color: #F57600;">IRS.gov</a> for the current federal rate.</p>
                </div>
                
                <div class="rate-history" id="rateHistory">
                    <h4>Rate Update History</h4>
                    <div id="rateHistoryList">No history available</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRateUnchanged()">Rate Unchanged</button>
                <button class="btn btn-success" onclick="saveNewRate()">Save New Rate</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="logo">
            <span class="alice">alice</span><span class="dot">.</span><span class="care">care</span>
        </div>
        <div class="rate-display">
            <span>Mileage Rate:</span>
            <span class="rate-badge" id="navRateBadge">$0.70/mi</span>
            <button class="rate-edit-btn" onclick="openRateModal()">‚úèÔ∏è Edit</button>
        </div>
    </div>

    <div class="container">
        <!-- Rate Reminder Banner (shown after Jan 1 if not yet updated) -->
        <div id="rateReminderBanner" class="rate-reminder-banner" style="display: none;">
            <div class="rate-reminder-content">
                <div class="rate-reminder-icon">‚ö†Ô∏è</div>
                <div class="rate-reminder-text">
                    <h3>Annual Rate Review Reminder</h3>
                    <p>It's a new year! Please verify the mileage reimbursement rate is current for <span id="reminderYear">2025</span>.</p>
                </div>
            </div>
            <div class="rate-reminder-actions">
                <button class="btn btn-secondary" onclick="dismissReminder()">Dismiss</button>
                <button class="btn btn-primary" onclick="openRateModal()">Review Rate</button>
            </div>
        </div>

        <div class="header">
            <h1>Mileage Review Portal</h1>
            <p>Review on-call reports and manual mileage entries, generate reimbursement files</p>
        </div>

        <!-- Import Section -->
        <div class="import-section">
            <div class="import-title">üì§ Import Schedule Data</div>
            <div class="import-box">
                <label for="scheduleFile" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #3D3D3D;">Upload CSV File (Columns A-G)</label>
                <div class="import-row">
                    <div class="file-input-wrapper">
                        <input type="file" id="scheduleFile" accept=".csv">
                    </div>
                    <button class="btn btn-primary" onclick="uploadScheduleFile()">Upload & Import</button>
                </div>
                <div class="import-info">
                    Import CSV data to columns A-G. Header row will be skipped. Formulas in columns H+ will be copied automatically.
                </div>
                <div class="import-loading" id="importLoading">
                    <div class="import-spinner"></div>
                    <span>Importing data...</span>
                </div>
                <div class="import-message" id="importMessage"></div>
            </div>
        </div>

        <div class="lookup-section">
            <div class="lookup-title">Select Week to Review</div>
            <div class="lookup-grid">
                <div class="form-group">
                     <label>Week Number <span class="required">* <a href="week_number_reference.html" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #F57600; color: white; text-decoration: none; border-radius: 50%; font-weight: bold; font-size: 16px;" title="Find Week Number">?</a></span></label>
                    <input type="number" id="weekNumber" min="1" max="53" placeholder="46">
                </div>
                <div class="form-group">
                    <label>Year <span class="required">*</span></label>
                    <input type="number" id="year" min="2020" max="2030" placeholder="2025">
                </div>
            </div>
            <button class="btn btn-primary" onclick="loadSubmissions()">Load Reports</button>
        </div>

        <div id="statsSection" style="display: none;">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Total Employees</h3>
                    <div class="number" id="totalEmployees">0</div>
                </div>
                <div class="stat-card">
                    <h3>Submitted Reports</h3>
                    <div class="number" id="submittedReports">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Reimbursable Miles</h3>
                    <div class="number" id="totalMiles">0.0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Reimbursement</h3>
                    <div class="number" id="totalAmount">$0.00</div>
                </div>
            </div>
        </div>

        <div class="review-section">
            <div id="loadingIndicator" style="display: none;">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading reports...</p>
                </div>
            </div>

            <div id="reportsTable"></div>

            <!-- Manual Entries Section -->
            <div id="manualEntriesSection" style="display: none; margin-top: 30px;"></div>

            <div id="exportSection" style="display: none;">
                <div class="export-section">
                    <div class="export-header-row">
                        <div class="export-header-left" onclick="toggleExportSection()">
                            <div class="export-toggle" id="exportToggle">+</div>
                            <h3>üìÑ Export Text File</h3>
                        </div>
                        <button class="btn btn-success" onclick="downloadTextFile()" style="margin: 0;">
                            Download Text File
                        </button>
                    </div>
                    <div class="export-content" id="exportContent">
                        <div class="export-content-inner">
                            <div class="notice-box" style="margin-bottom: 15px;">
                                <p><strong>Format:</strong> Each data line will be formatted as: EMPLOYEE_ID,MLE,AMOUNT,,,,,</p>
                                <p><strong>Rate:</strong> $0.70 per mile (federal reimbursement rate)</p>
                                <p><strong>Sections:</strong> File includes ON-CALL SUBMITTED, MANUAL MILEAGE, and PENDING sections</p>
                                <p><strong>Includes:</strong> Both on-call mileage reports AND manual mileage entries</p>
                            </div>
                            <div class="text-preview" id="textPreview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace this URL with your actual Google Apps Script web app URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyoge_hluInEjc7ovFBnxttmqxY4GgXi-wTKdDeHzNUk3-jhMGAnwn9oYt2219A2FVU/exec';
        
        // ==========================================
        // MILEAGE RATE MANAGEMENT
        // ==========================================
        
        const RATE_STORAGE_KEY = 'aliceCare_mileageRate';
        const RATE_HISTORY_KEY = 'aliceCare_rateHistory';
        const RATE_REVIEW_KEY = 'aliceCare_lastRateReview';
        
        // Default rate - will be overridden by localStorage if available
        let REIMBURSEMENT_RATE = 0.70;
        
        function initializeRateSettings() {
            // Load saved rate from localStorage
            const savedRate = localStorage.getItem(RATE_STORAGE_KEY);
            if (savedRate) {
                REIMBURSEMENT_RATE = parseFloat(savedRate);
            }
            
            // Update UI
            updateRateDisplay();
            
            // Check if we need to show the reminder
            checkRateReminder();
        }
        
        function updateRateDisplay() {
            // Update nav badge
            const navBadge = document.getElementById('navRateBadge');
            if (navBadge) {
                navBadge.textContent = `$${REIMBURSEMENT_RATE.toFixed(2)}/mi`;
            }
            
            // Update modal current rate
            const modalRate = document.getElementById('modalCurrentRate');
            if (modalRate) {
                modalRate.textContent = `$${REIMBURSEMENT_RATE.toFixed(2)}`;
            }
            
            // Update export section info if it exists
            updateExportRateInfo();
        }
        
        function updateExportRateInfo() {
            const exportContent = document.querySelector('.export-content-inner .notice-box');
            if (exportContent) {
                const rateParagraph = exportContent.querySelector('p:nth-child(2)');
                if (rateParagraph) {
                    rateParagraph.innerHTML = `<strong>Rate:</strong> $${REIMBURSEMENT_RATE.toFixed(2)} per mile (current reimbursement rate)`;
                }
            }
        }
        
        function checkRateReminder() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth(); // 0 = January
            const currentDay = new Date().getDate();
            
            // Only show reminder starting January 1st
            if (currentMonth !== 0) {
                // Not January, hide reminder
                document.getElementById('rateReminderBanner').style.display = 'none';
                return;
            }
            
            // Check if already reviewed this year
            const lastReview = localStorage.getItem(RATE_REVIEW_KEY);
            if (lastReview) {
                const reviewData = JSON.parse(lastReview);
                if (reviewData.year === currentYear) {
                    // Already reviewed this year
                    document.getElementById('rateReminderBanner').style.display = 'none';
                    return;
                }
            }
            
            // Show the reminder banner
            document.getElementById('reminderYear').textContent = currentYear;
            document.getElementById('rateReminderBanner').style.display = 'flex';
        }
        
        function openRateModal() {
            const modal = document.getElementById('rateModal');
            modal.classList.remove('hidden');
            
            // Pre-fill with current rate
            document.getElementById('newRateInput').value = REIMBURSEMENT_RATE.toFixed(2);
            document.getElementById('modalCurrentRate').textContent = `$${REIMBURSEMENT_RATE.toFixed(2)}`;
            
            // Load and display history
            loadRateHistory();
        }
        
        function closeRateModal() {
            document.getElementById('rateModal').classList.add('hidden');
        }
        
        function loadRateHistory() {
            const historyList = document.getElementById('rateHistoryList');
            const history = localStorage.getItem(RATE_HISTORY_KEY);
            
            if (!history) {
                historyList.innerHTML = '<div class="rate-history-item" style="color: #9CA3AF;">No history available</div>';
                return;
            }
            
            const historyData = JSON.parse(history);
            if (historyData.length === 0) {
                historyList.innerHTML = '<div class="rate-history-item" style="color: #9CA3AF;">No history available</div>';
                return;
            }
            
            // Show last 5 entries (most recent first)
            const recentHistory = historyData.slice(-5).reverse();
            historyList.innerHTML = recentHistory.map(entry => {
                const date = new Date(entry.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const action = entry.changed ? 
                    `Changed to <strong>$${entry.rate.toFixed(2)}</strong>` : 
                    `Confirmed at <strong>$${entry.rate.toFixed(2)}</strong> (unchanged)`;
                return `<div class="rate-history-item">${date}: ${action}</div>`;
            }).join('');
        }
        
        function saveNewRate() {
            const newRateInput = document.getElementById('newRateInput');
            const newRate = parseFloat(newRateInput.value);
            
            if (isNaN(newRate) || newRate <= 0 || newRate > 5) {
                alert('Please enter a valid rate between $0.01 and $5.00');
                return;
            }
            
            const oldRate = REIMBURSEMENT_RATE;
            const rateChanged = Math.abs(newRate - oldRate) > 0.001;
            
            // Update the rate
            REIMBURSEMENT_RATE = newRate;
            localStorage.setItem(RATE_STORAGE_KEY, newRate.toString());
            
            // Record in history
            addToRateHistory(newRate, rateChanged);
            
            // Mark as reviewed for this year
            markRateReviewed();
            
            // Update UI
            updateRateDisplay();
            
            // Hide reminder if shown
            document.getElementById('rateReminderBanner').style.display = 'none';
            
            // Close modal
            closeRateModal();
            
            // Show confirmation
            if (rateChanged) {
                alert(`Mileage rate updated from $${oldRate.toFixed(2)} to $${newRate.toFixed(2)} per mile.`);
            } else {
                alert(`Mileage rate confirmed at $${newRate.toFixed(2)} per mile for ${new Date().getFullYear()}.`);
            }
            
            // Regenerate text preview if data is loaded
            if (currentSubmissions || currentManualEntries) {
                generateCombinedTextPreview();
            }
        }
        
        function confirmRateUnchanged() {
            // Keep current rate but record that it was reviewed
            addToRateHistory(REIMBURSEMENT_RATE, false);
            markRateReviewed();
            
            // Hide reminder if shown
            document.getElementById('rateReminderBanner').style.display = 'none';
            
            // Close modal
            closeRateModal();
            
            alert(`Rate confirmed unchanged at $${REIMBURSEMENT_RATE.toFixed(2)} per mile for ${new Date().getFullYear()}.`);
        }
        
        function addToRateHistory(rate, changed) {
            let history = localStorage.getItem(RATE_HISTORY_KEY);
            let historyData = history ? JSON.parse(history) : [];
            
            historyData.push({
                date: new Date().toISOString(),
                rate: rate,
                changed: changed,
                year: new Date().getFullYear()
            });
            
            // Keep only last 20 entries
            if (historyData.length > 20) {
                historyData = historyData.slice(-20);
            }
            
            localStorage.setItem(RATE_HISTORY_KEY, JSON.stringify(historyData));
        }
        
        function markRateReviewed() {
            const reviewData = {
                year: new Date().getFullYear(),
                date: new Date().toISOString()
            };
            localStorage.setItem(RATE_REVIEW_KEY, JSON.stringify(reviewData));
        }
        
        function dismissReminder() {
            // Just hide the banner for this session (doesn't mark as reviewed)
            document.getElementById('rateReminderBanner').style.display = 'none';
        }
        
        let currentSubmissions = null;
        let currentManualEntries = null;
        let currentWeek = null;
        let currentYear = null;
        
        // ==========================================
        // LOADING OVERLAY FUNCTIONS
        // ==========================================
        
        function showLoading(text, subtext) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            loadingText.textContent = text || 'Processing...';
            loadingSubtext.textContent = subtext || 'Please wait';
            
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        // ==========================================
        // EXPORT SECTION TOGGLE
        // ==========================================
        
        function toggleExportSection() {
            const content = document.getElementById('exportContent');
            const toggle = document.getElementById('exportToggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '+';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '+';
            }
        }

        function loadSubmissions() {
            const weekNumber = document.getElementById('weekNumber').value.trim();
            const year = document.getElementById('year').value.trim();

            if (!weekNumber || !year) {
                alert('Please enter both week number and year');
                return;
            }

            currentWeek = weekNumber;
            currentYear = year;
            
            // Show loading overlay
            showLoading('Loading Reports...', `Week ${weekNumber} of ${year}`);

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('reportsTable').innerHTML = '';
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            document.getElementById('manualEntriesSection').style.display = 'none';

            // Track completion of both requests
            let onCallComplete = false;
            let manualComplete = false;
            
            function checkBothComplete() {
                if (onCallComplete && manualComplete) {
                    hideLoading();
                    document.getElementById('loadingIndicator').style.display = 'none';
                    displayAllReports();
                }
            }

            // ========== LOAD ON-CALL SUBMISSIONS ==========
            const callbackName = 'jsonpCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                console.log('Received on-call data:', data);
                
                if (data.error) {
                    console.error('Error loading on-call:', data.error);
                    currentSubmissions = { submissions: [] };
                } else {
                    currentSubmissions = data;
                }
                
                delete window[callbackName];
                onCallComplete = true;
                checkBothComplete();
            };

            const url = GOOGLE_SCRIPT_URL + 
                '?action=getSubmissions' +
                '&week=' + encodeURIComponent(weekNumber) +
                '&year=' + encodeURIComponent(year) +
                '&callback=' + callbackName;

            console.log('Fetching on-call:', url);

            const script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                console.error('Failed to load on-call reports');
                currentSubmissions = { submissions: [] };
                delete window[callbackName];
                onCallComplete = true;
                checkBothComplete();
            };
            document.body.appendChild(script);

            // ========== LOAD MANUAL MILEAGE ENTRIES ==========
            const manualCallbackName = 'manualCallback_' + Date.now();
            
            window[manualCallbackName] = function(data) {
                console.log('Received manual entries:', data);
                
                if (data.error) {
                    console.error('Error loading manual entries:', data.error);
                    currentManualEntries = [];
                } else {
                    currentManualEntries = Array.isArray(data) ? data : (data.entries || []);
                }
                
                delete window[manualCallbackName];
                manualComplete = true;
                checkBothComplete();
            };

            const manualUrl = GOOGLE_SCRIPT_URL + 
                '?action=getAllManualMileage' +
                '&week=' + encodeURIComponent(weekNumber) +
                '&year=' + encodeURIComponent(year) +
                '&callback=' + manualCallbackName;

            console.log('Fetching manual entries:', manualUrl);

            const manualScript = document.createElement('script');
            manualScript.src = manualUrl;
            manualScript.onerror = function() {
                console.error('Failed to load manual entries');
                currentManualEntries = [];
                delete window[manualCallbackName];
                manualComplete = true;
                checkBothComplete();
            };
            document.body.appendChild(manualScript);
        }

        function displayAllReports() {
            const hasOnCall = currentSubmissions && currentSubmissions.submissions && currentSubmissions.submissions.length > 0;
            const hasManual = currentManualEntries && currentManualEntries.length > 0;
            
            // Display on-call reports
            if (hasOnCall) {
                displayReports(currentSubmissions);
            } else {
                document.getElementById('reportsTable').innerHTML = `
                    <div class="notice-box">
                        <p><strong>No on-call reports found for Week ${currentWeek}, ${currentYear}</strong></p>
                        <p>There are no on-call services for this week.</p>
                    </div>
                `;
            }
            
            // Display manual entries
            if (hasManual) {
                displayManualEntries(currentManualEntries);
            }
            
            // Show export section if there's ANY data (on-call OR manual)
            if (hasOnCall || hasManual) {
                updateCombinedStats();
            } else {
                // No data at all
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
            }
        }

        function displayReports(data) {
            if (!data.submissions || data.submissions.length === 0) {
                return;
            }

            // Build table for on-call reports
            let html = `
                <h3 style="font-size: 18px; color: #1A365C; margin-bottom: 15px;">üìã On-Call Mileage Reports</h3>
                <table class="review-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th class="text-center">Status</th>
                            <th class="text-right">Total Services</th>
                            <th class="text-right">Reimbursable Miles</th>
                            <th class="text-right">Reimbursement</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.submissions.forEach((emp, index) => {
                const statusClass = emp.isSubmitted ? 'status-submitted' : 'status-pending';
                const statusText = emp.isSubmitted ? 'Submitted' : 'Pending';
                
                html += `
                    <tr onclick="toggleDetails(${index})">
                        <td>
                            <span class="expand-icon" id="icon_${index}">+</span>
                        </td>
                        <td class="employee-id">${emp.employeeId}</td>
                        <td>${emp.lastName}, ${emp.firstName}</td>
                        <td class="text-center">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td class="text-right">${emp.serviceCount}</td>
                        <td class="text-right">${emp.totalReimbursableMiles.toFixed(1)} mi</td>
                        <td class="text-right">$${emp.reimbursementAmount.toFixed(2)}</td>
                    </tr>
                    <tr class="detail-row" id="detail_${index}">
                        <td colspan="7" class="detail-cell">
                            <div class="detail-content">
                                ${generateServiceDetails(emp)}
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('reportsTable').innerHTML = html;
        }

        function displayManualEntries(entries) {
            if (!entries || entries.length === 0) {
                return;
            }

            // Group entries by employee
            const employeeMap = new Map();
            
            entries.forEach(entry => {
                const empId = entry.employeeId || entry.Employee_ID || 'Unknown';
                if (!employeeMap.has(empId)) {
                    employeeMap.set(empId, {
                        employeeId: empId,
                        firstName: entry.firstName || entry.First_Name || '',
                        lastName: entry.lastName || entry.Last_Name || '',
                        entries: [],
                        totalMiles: 0,
                        submittedCount: 0,
                        pendingCount: 0
                    });
                }
                
                const emp = employeeMap.get(empId);
                emp.entries.push(entry);
                
                const miles = parseFloat(entry.totalMileage || entry.Total_Mileage || 0);
                emp.totalMiles += miles;
                
                const status = (entry.status || entry.Status || '').toLowerCase();
                if (status === 'submitted' || status === 'approved' || status === 'reviewed') {
                    emp.submittedCount++;
                } else {
                    emp.pendingCount++;
                }
            });

            // Build manual entries table
            let html = `
                <h3 style="font-size: 18px; color: #1A365C; margin-bottom: 15px; margin-top: 30px;">üöó Manual Mileage Entries</h3>
                <div class="notice-box" style="margin-bottom: 20px;">
                    <p><strong>Note:</strong> These are manually submitted mileage entries (not from on-call services).</p>
                </div>
                <table class="review-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th class="text-center">Status</th>
                            <th class="text-right">Entries</th>
                            <th class="text-right">Total Miles</th>
                            <th class="text-right">Reimbursement</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let manualIndex = 0;
            employeeMap.forEach((emp, empId) => {
                const allSubmitted = emp.pendingCount === 0;
                const statusClass = allSubmitted ? 'status-submitted' : 'status-pending';
                const statusText = allSubmitted ? 'Reviewed' : `${emp.submittedCount}/${emp.entries.length} Reviewed`;
                const reimbursement = emp.totalMiles * REIMBURSEMENT_RATE;
                
                html += `
                    <tr onclick="toggleManualDetails(${manualIndex})">
                        <td>
                            <span class="expand-icon" id="manual_icon_${manualIndex}">+</span>
                        </td>
                        <td class="employee-id">${emp.employeeId}</td>
                        <td>${emp.lastName}, ${emp.firstName}</td>
                        <td class="text-center">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td class="text-right">${emp.entries.length}</td>
                        <td class="text-right">${emp.totalMiles.toFixed(1)} mi</td>
                        <td class="text-right">$${reimbursement.toFixed(2)}</td>
                        <td class="text-center">
                            ${!allSubmitted ? `<button class="btn btn-success" style="padding: 6px 12px; font-size: 12px; margin: 0;" onclick="event.stopPropagation(); approveManualEntries('${empId}')">Approve All</button>` : '<span style="color: #62B790; font-weight: 600;">‚úì</span>'}
                        </td>
                    </tr>
                    <tr class="detail-row" id="manual_detail_${manualIndex}">
                        <td colspan="8" class="detail-cell">
                            <div class="detail-content">
                                ${generateManualEntryDetails(emp)}
                            </div>
                        </td>
                    </tr>
                `;
                manualIndex++;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('manualEntriesSection').innerHTML = html;
            document.getElementById('manualEntriesSection').style.display = 'block';
        }

        function generateManualEntryDetails(employee) {
            let html = `
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Client</th>
                            <th>Reason</th>
                            <th class="text-right">Start Mi</th>
                            <th class="text-right">End Mi</th>
                            <th class="text-right">Total Miles</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let totalMiles = 0;

            employee.entries.forEach(entry => {
                const miles = parseFloat(entry.totalMileage || entry.Total_Mileage || 0);
                totalMiles += miles;
                
                const status = (entry.status || entry.Status || 'Submitted').toLowerCase();
                const statusClass = (status === 'submitted' || status === 'approved' || status === 'reviewed') ? 'status-submitted' : 'status-pending';
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                const date = entry.date || entry.Date || '';
                const time = entry.time || entry.Time || '';
                const clientName = entry.clientName || entry.Client_Name || '-';
                const reason = entry.reason || entry.Reason || '-';
                const startMiles = parseFloat(entry.startMiles || entry.Start_Miles || 0);
                const endMiles = parseFloat(entry.endMiles || entry.End_Miles || 0);

                html += `
                    <tr>
                        <td>${formatDate(date)}</td>
                        <td>${time}</td>
                        <td>${clientName}</td>
                        <td style="font-size: 12px;">${reason}</td>
                        <td class="text-right">${startMiles.toFixed(1)}</td>
                        <td class="text-right">${endMiles.toFixed(1)}</td>
                        <td class="text-right" style="font-weight: 600; color: #F57600;">${miles.toFixed(1)} mi</td>
                        <td class="text-center">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            });

            const reimbursement = totalMiles * REIMBURSEMENT_RATE;

            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="text-right">TOTAL:</td>
                            <td class="text-right" style="color: #F57600; font-weight: 700;">${totalMiles.toFixed(1)} mi</td>
                            <td class="text-center" style="font-weight: 600;">$${reimbursement.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            return html;
        }

        function toggleManualDetails(index) {
            const detailRow = document.getElementById('manual_detail_' + index);
            const icon = document.getElementById('manual_icon_' + index);
            const mainRow = detailRow.previousElementSibling;
            
            if (detailRow.classList.contains('show')) {
                detailRow.classList.remove('show');
                icon.textContent = '+';
                mainRow.classList.remove('expanded');
            } else {
                detailRow.classList.add('show');
                icon.textContent = '‚àí';
                mainRow.classList.add('expanded');
            }
        }

        function approveManualEntries(employeeId) {
            if (!confirm(`Are you sure you want to approve all manual mileage entries for Employee ${employeeId}?`)) {
                return;
            }

            // Show loading overlay
            showLoading('Approving Entries...', `Processing Employee ${employeeId}`);

            // Call backend to approve
            const callbackName = 'approveCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                console.log('Approve response:', response);
                delete window[callbackName];
                hideLoading();
                
                if (response.success) {
                    alert('Manual entries approved successfully!');
                    // Reload the data
                    loadSubmissions();
                } else {
                    alert('Error approving entries: ' + (response.message || 'Unknown error'));
                }
            };

            const url = GOOGLE_SCRIPT_URL + 
                '?action=approveManualMileage' +
                '&employeeId=' + encodeURIComponent(employeeId) +
                '&week=' + encodeURIComponent(currentWeek) +
                '&year=' + encodeURIComponent(currentYear) +
                '&callback=' + callbackName;

            const script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                delete window[callbackName];
                hideLoading();
                alert('Failed to approve entries. Please try again.');
            };
            document.body.appendChild(script);
        }

        function updateCombinedStats() {
            console.log('=== updateCombinedStats ===');
            
            // Calculate on-call totals
            let onCallEmployees = 0;
            let onCallSubmitted = 0;
            let onCallMiles = 0;
            let onCallAmount = 0;

            if (currentSubmissions && currentSubmissions.submissions) {
                onCallEmployees = currentSubmissions.submissions.length;
                currentSubmissions.submissions.forEach(emp => {
                    if (emp.isSubmitted) {
                        onCallSubmitted++;
                        onCallMiles += emp.totalReimbursableMiles;
                        onCallAmount += emp.reimbursementAmount;
                    }
                });
            }

            // Calculate manual entry totals
            let manualEmployees = 0;
            let manualMiles = 0;
            let manualAmount = 0;
            const manualEmployeeSet = new Set();

            if (currentManualEntries && currentManualEntries.length > 0) {
                currentManualEntries.forEach(entry => {
                    const empId = entry.employeeId || entry.Employee_ID;
                    manualEmployeeSet.add(empId);
                    const miles = parseFloat(entry.totalMileage || entry.Total_Mileage || 0);
                    manualMiles += miles;
                });
                manualEmployees = manualEmployeeSet.size;
                manualAmount = manualMiles * REIMBURSEMENT_RATE;
            }

            console.log('On-call employees:', onCallEmployees, 'Manual employees:', manualEmployees);
            console.log('On-call miles:', onCallMiles, 'Manual miles:', manualMiles);

            // Update stats display
            const hasOnCall = onCallEmployees > 0;
            const hasManual = manualEmployees > 0;

            // Always show stats and export if we have ANY data
            if (hasOnCall || hasManual) {
                document.getElementById('totalEmployees').textContent = onCallEmployees + (hasManual ? ` (+${manualEmployees} manual)` : '');
                document.getElementById('submittedReports').textContent = onCallSubmitted + (hasManual ? ` (+${manualEmployees} manual)` : '');
                document.getElementById('totalMiles').textContent = (onCallMiles + manualMiles).toFixed(1);
                document.getElementById('totalAmount').textContent = '$' + (onCallAmount + manualAmount).toFixed(2);
                document.getElementById('statsSection').style.display = 'block';

                // Generate text preview with both on-call and manual
                generateCombinedTextPreview();
                
                // Show export section
                document.getElementById('exportSection').style.display = 'block';
                console.log('Export section displayed');
            } else {
                console.log('No data - hiding export section');
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
            }
        }

        function generateCombinedTextPreview() {
            console.log('=== generateCombinedTextPreview ===');
            console.log('currentSubmissions:', currentSubmissions);
            console.log('currentManualEntries:', currentManualEntries);
            
            let text = '';
            
            // Add header
            text += `ALICE CARE MILEAGE REIMBURSEMENT\n`;
            text += `Week ${currentWeek}, ${currentYear}\n`;
            text += `Generated: ${new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}\n`;
            text += `\n`;

            // Calculate totals - handle null/undefined safely
            const submissions = (currentSubmissions && currentSubmissions.submissions) ? currentSubmissions.submissions : [];
            const manualEntries = currentManualEntries ? currentManualEntries : [];
            
            console.log('Submissions count:', submissions.length);
            console.log('Manual entries count:', manualEntries.length);
            
            const submitted = submissions.filter(emp => emp.isSubmitted);
            const notSubmitted = submissions.filter(emp => !emp.isSubmitted);
            
            // Group manual entries by employee
            const manualByEmployee = new Map();
            manualEntries.forEach(entry => {
                const empId = String(entry.employeeId || entry.Employee_ID || 'Unknown');
                if (!manualByEmployee.has(empId)) {
                    manualByEmployee.set(empId, {
                        employeeId: empId,
                        firstName: entry.firstName || entry.First_Name || '',
                        lastName: entry.lastName || entry.Last_Name || '',
                        totalMiles: 0,
                        entries: []
                    });
                }
                const emp = manualByEmployee.get(empId);
                emp.totalMiles += parseFloat(entry.totalMileage || entry.Total_Mileage || 0);
                emp.entries.push(entry);
            });

            // Summary
            text += `SUMMARY:\n`;
            text += `On-Call Employees: ${submissions.length} (${submitted.length} submitted)\n`;
            text += `Manual Entries: ${manualEntries.length} entries from ${manualByEmployee.size} employees\n`;
            text += `\n`;

            // ON-CALL SUBMITTED SECTION
            if (submitted.length > 0) {
                text += `ON-CALL - SUBMITTED:\n`;
                text += `---\n`;
                
                const sortedSubmitted = [...submitted].sort((a, b) => a.employeeId.localeCompare(b.employeeId));
                
                sortedSubmitted.forEach(emp => {
                    const employeeId = emp.employeeId.padStart(4, '0');
                    const amount = emp.reimbursementAmount.toFixed(2);
                    text += `${employeeId},MLE,${amount},,,,,\n`;
                });
                
                text += `---\n`;
                text += `On-Call Submitted Records: ${submitted.length}\n`;
                text += `\n`;
            }

            // MANUAL MILEAGE SECTION
            if (manualByEmployee.size > 0) {
                text += `MANUAL MILEAGE - SUBMITTED:\n`;
                text += `---\n`;
                
                const sortedManual = [...manualByEmployee.values()].sort((a, b) => a.employeeId.localeCompare(b.employeeId));
                
                sortedManual.forEach(emp => {
                    const employeeId = emp.employeeId.padStart(4, '0');
                    const amount = (emp.totalMiles * REIMBURSEMENT_RATE).toFixed(2);
                    text += `${employeeId},MLE,${amount},,,,,\n`;
                });
                
                text += `---\n`;
                text += `Manual Mileage Records: ${manualByEmployee.size}\n`;
                text += `\n`;
            }

            // ON-CALL NOT SUBMITTED SECTION
            if (notSubmitted.length > 0) {
                text += `ON-CALL - NOT SUBMITTED (PENDING):\n`;
                text += `---\n`;
                
                const sortedNotSubmitted = [...notSubmitted].sort((a, b) => a.employeeId.localeCompare(b.employeeId));
                
                sortedNotSubmitted.forEach(emp => {
                    const employeeId = emp.employeeId.padStart(4, '0');
                    const amount = emp.reimbursementAmount.toFixed(2);
                    text += `${employeeId},MLE,${amount},,,,,\n`;
                });
                
                text += `---\n`;
                text += `Pending Records: ${notSubmitted.length}\n`;
                text += `\n`;
            }

            // Calculate grand totals
            let totalOnCallAmount = 0;
            let totalManualAmount = 0;
            
            submitted.forEach(emp => totalOnCallAmount += emp.reimbursementAmount);
            manualByEmployee.forEach(emp => totalManualAmount += emp.totalMiles * REIMBURSEMENT_RATE);

            // Footer
            text += `TOTALS:\n`;
            text += `On-Call Reimbursement: $${totalOnCallAmount.toFixed(2)}\n`;
            text += `Manual Mileage Reimbursement: $${totalManualAmount.toFixed(2)}\n`;
            text += `Grand Total: $${(totalOnCallAmount + totalManualAmount).toFixed(2)}\n`;
            text += `\n`;
            text += `END OF REPORT\n`;

            document.getElementById('textPreview').textContent = text;
        }

        function generateServiceDetails(employee) {
            let html = `
                <table class="services-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Client</th>
                            <th class="text-right">Original Miles</th>
                            <th class="text-right">Adjusted Miles</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let originalTotal = 0;
            let adjustedTotal = 0;
            let reimbursableCount = 0;
            let commuteCount = 0;

            employee.services.forEach(service => {
                const isCommute = service.isCommute === true;
                const originalMileage = parseFloat(service.Mileage || 0);
                const adjustedMileage = service.Adjusted_Mileage ? parseFloat(service.Adjusted_Mileage) : null;
                const reason = service.Adjustment_Reason || '';
                
                // Only count non-commute in totals
                if (!isCommute) {
                    originalTotal += originalMileage;
                    adjustedTotal += (adjustedMileage !== null ? adjustedMileage : originalMileage);
                    reimbursableCount++;
                } else {
                    commuteCount++;
                }

                html += `
                    <tr style="${isCommute ? 'opacity: 0.6; background: #F9FAFB;' : ''}">
                        <td>
                            ${formatDate(service.Scheduled_Date)}
                            ${isCommute ? '<span class="commute-badge">Commute</span>' : ''}
                        </td>
                        <td>${formatTime(service.Scheduled_Time)}</td>
                        <td>${service.Service_Recipient_First_Name || 'N/A'}</td>
                        <td class="text-right">${originalMileage.toFixed(1)} mi</td>
                        <td class="text-right" style="${adjustedMileage !== null ? 'color: #F57600; font-weight: 600;' : ''}">
                            ${adjustedMileage !== null ? adjustedMileage.toFixed(1) + ' mi' : '-'}
                        </td>
                        <td style="font-size: 12px; color: #3D3D3D;">${reason || (isCommute ? 'N/A' : '-')}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-right">TOTAL REIMBURSABLE:</td>
                            <td class="text-right">${originalTotal.toFixed(1)} mi</td>
                            <td class="text-right" style="color: #F57600;">${adjustedTotal.toFixed(1)} mi</td>
                            <td style="font-size: 12px;">
                                ${reimbursableCount} service${reimbursableCount !== 1 ? 's' : ''}
                                ${commuteCount > 0 ? '<br><span style="color: #9CA3AF;">(' + commuteCount + ' commute excluded)</span>' : ''}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            `;

            return html;
        }

        function toggleDetails(index) {
            const detailRow = document.getElementById('detail_' + index);
            const icon = document.getElementById('icon_' + index);
            const mainRow = detailRow.previousElementSibling;
            
            if (detailRow.classList.contains('show')) {
                detailRow.classList.remove('show');
                icon.textContent = '+';
                mainRow.classList.remove('expanded');
            } else {
                detailRow.classList.add('show');
                icon.textContent = '‚àí';
                mainRow.classList.add('expanded');
            }
        }

        function downloadTextFile() {
            const text = document.getElementById('textPreview').textContent;
            
            if (!text || text.trim() === '') {
                alert('No data to download');
                return;
            }

            const filename = `mileage_week${currentWeek}_${currentYear}.txt`;

            // Create blob and download
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            console.log('Downloaded:', filename);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short',
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function formatTime(timeValue) {
            // Handle Google Sheets time format
            if (!timeValue) return '';
            
            try {
                // If it's already a string in HH:MM format, return it
                if (typeof timeValue === 'string' && /^\d{1,2}:\d{2}/.test(timeValue)) {
                    return timeValue;
                }
                
                // Convert to Date object
                let date;
                if (typeof timeValue === 'string') {
                    date = new Date(timeValue);
                } else if (typeof timeValue === 'number') {
                    // Google Sheets serial time (fraction of a day)
                    const hours = Math.floor(timeValue * 24);
                    const minutes = Math.floor((timeValue * 24 * 60) % 60);
                    return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                } else if (timeValue instanceof Date) {
                    date = timeValue;
                } else {
                    return String(timeValue);
                }
                
                // Extract time in HH:MM format
                const hours = date.getHours();
                const minutes = date.getMinutes();
                return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                
            } catch (error) {
                console.error('Error formatting time:', error, timeValue);
                return String(timeValue);
            }
        }

        // Upload Schedule File Function (CSV only - uses JSONP)
        function uploadScheduleFile() {
            const fileInput = document.getElementById('scheduleFile');
            const loadingDiv = document.getElementById('importLoading');
            const messageDiv = document.getElementById('importMessage');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showImportMessage('Please select a CSV file to upload', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name;
            
            // Validate file type - CSV only
            if (!fileName.toLowerCase().endsWith('.csv')) {
                showImportMessage('Please upload a CSV file only', 'error');
                return;
            }
            
            // Show loading overlay
            showLoading('Uploading Schedule...', `Processing ${fileName}`);
            
            // Show section loading
            loadingDiv.style.display = 'flex';
            messageDiv.style.display = 'none';
            
            // Read and parse CSV file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const data = parseCSVFile(csvText);
                    
                    if (!data || data.length === 0) {
                        hideLoading();
                        showImportMessage('No data found in CSV file', 'error');
                        loadingDiv.style.display = 'none';
                        return;
                    }
                    
                    console.log('Parsed CSV data:', data);
                    
                    // Send data to backend via JSONP
                    sendImportDataToSheet(data, fileInput, loadingDiv);
                    
                } catch (error) {
                    hideLoading();
                    loadingDiv.style.display = 'none';
                    showImportMessage('Error parsing CSV: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                hideLoading();
                loadingDiv.style.display = 'none';
                showImportMessage('Error reading file', 'error');
            };
            
            reader.readAsText(file);
        }
        
        function parseCSVFile(text) {
            const lines = text.split(/\r\n|\n|\r/);
            const result = [];
            let isFirstRow = true;
            
            for (let line of lines) {
                if (line.trim() === '') continue;
                
                // Skip header row
                if (isFirstRow) {
                    isFirstRow = false;
                    console.log('Skipping header row');
                    continue;
                }
                
                const row = [];
                let currentField = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            currentField += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim());
                
                // Take first 7 columns (A-G)
                const limitedRow = row.slice(0, 7);
                
                // Pad with empty strings if less than 7 columns
                while (limitedRow.length < 7) {
                    limitedRow.push('');
                }
                
                result.push(limitedRow);
            }
            
            console.log('Parsed', result.length, 'data rows (header skipped)');
            return result;
        }
        
        function sendImportDataToSheet(data, fileInput, loadingDiv) {
            const numRows = data.length;
            console.log('Calling import with', numRows, 'rows');
            
            // Update loading messages
            const loadingText = loadingDiv.querySelector('span');
            if (loadingText) {
                loadingText.textContent = 'Uploading ' + numRows + ' rows...';
            }
            document.getElementById('loadingSubtext').textContent = `Uploading ${numRows} rows...`;
            
            // Use POST request instead of JSONP (to handle large data)
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Required for Google Apps Script
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'importSchedule',
                    data: data
                })
            })
            .then(() => {
                // With no-cors, we can't read the response
                // Show processing message
                if (loadingText) {
                    loadingText.textContent = 'Processing ' + numRows + ' rows...';
                }
                document.getElementById('loadingSubtext').textContent = `Processing ${numRows} rows...`;
                
                // Wait a bit for server to process, then show success
                setTimeout(() => {
                    hideLoading();
                    loadingDiv.style.display = 'none';
                    showImportMessage(
                        'Import completed! ' + numRows + ' rows uploaded. Check your Schedule sheet to verify.',
                        'success'
                    );
                    fileInput.value = '';
                }, 2000); // Give server 2 seconds to process
            })
            .catch(error => {
                hideLoading();
                loadingDiv.style.display = 'none';
                showImportMessage('Failed to send import request: ' + error.message, 'error');
                console.error('Import error:', error);
            });
        }
        
        function showImportMessage(text, type) {
            const messageDiv = document.getElementById('importMessage');
            messageDiv.textContent = text;
            messageDiv.className = 'import-message ' + type;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Set current year as default
        document.getElementById('year').value = new Date().getFullYear();
        
        // Initialize rate settings on page load
        initializeRateSettings();
    </script>
</body>
</html>