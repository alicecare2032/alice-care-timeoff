<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alice.care: Employee Email Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #E5ECF3; min-height: 100vh; padding: 20px; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 54, 92, 0.7); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(3px); }
        .loading-overlay.active { display: flex; }
        .loading-content { background: white; padding: 40px 60px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
        .spinner { width: 60px; height: 60px; border: 5px solid #E5ECF3; border-top: 5px solid #F57600; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: #1A365C; font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .loading-subtext { color: #666; font-size: 13px; }
        
        .nav-tabs { max-width: 1400px; margin: 0 auto 20px; display: flex; gap: 10px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(26, 54, 92, 0.1); flex-wrap: wrap; }
        .tab-btn { flex: 1; min-width: 120px; padding: 12px 16px; background: transparent; border: none; border-radius: 8px; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 13px; color: #1A365C; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tab-btn.active { background: #F57600; color: white; }
        .tab-btn:hover:not(.active):not(.connection-status) { background: #E5ECF3; }
        .tab-btn svg { width: 18px; height: 18px; }
        .tab-btn.connection-status { background: #28A745; color: white; cursor: default; min-width: auto; flex: 0; }
        .tab-btn.connection-status.disconnected { background: #DC3545; }
        
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15); overflow: hidden; }
        .header { background: #1A365C; color: white; padding: 40px 30px; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; width: 300px; height: 300px; border: 40px solid rgba(245, 118, 0, 0.1); border-radius: 50%; top: -150px; right: -100px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; flex-wrap: wrap; gap: 20px; }
        .logo { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .logo .alice { color: #F57600; font-weight: 700; }
        .logo .dot { color: #F57600; font-weight: 700; margin: 0 -2px; }
        .logo .care { color: white; font-weight: 400; }
        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; }
        .header p { opacity: 0.9; font-size: 14px; font-weight: 400; }
        
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .section-title { font-size: 18px; font-weight: 600; color: #1A365C; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .section-title svg { width: 24px; height: 24px; color: #F57600; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #1A365C; margin-bottom: 8px; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #E5ECF3; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 14px; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #F57600; box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1); }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border: none; border-radius: 8px; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #F57600; color: white; }
        .btn-primary:hover { background: #E06900; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 118, 0, 0.3); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #1A365C; color: white; }
        .btn-secondary:hover { background: #152d4a; }
        .btn-outline { background: transparent; border: 2px solid #1A365C; color: #1A365C; }
        .btn-outline:hover { background: #1A365C; color: white; }
        .btn-danger { background: #DC3545; color: white; }
        .btn-danger:hover { background: #C82333; }
        .btn-success { background: #28A745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #FFC107; color: #1A365C; }
        .btn-warning:hover { background: #E0A800; }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        .btn svg { width: 16px; height: 16px; }
        
        .card { background: #F9FAFB; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #E5ECF3; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .card-title { font-size: 16px; font-weight: 600; color: #1A365C; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th { background: #1A365C; color: white; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 10; }
        .data-table th:first-child { border-radius: 8px 0 0 0; }
        .data-table th:last-child { border-radius: 0 8px 0 0; }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid #E5ECF3; color: #333; background: white; }
        .data-table tbody tr:hover td { background: #F9FAFB; }
        
        /* Scrollable table container for sticky header */
        .table-container { max-height: 600px; overflow-y: auto; border-radius: 8px; border: 1px solid #E5ECF3; }
        .table-container .data-table th:first-child { border-radius: 0; }
        .table-container .data-table th:last-child { border-radius: 0; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-warning-1 { background: #FFF3CD; color: #856404; }
        .badge-warning-2 { background: #FFE0B2; color: #E65100; }
        .badge-warning-3 { background: #FFCDD2; color: #C62828; }
        .badge-final { background: #F8D7DA; color: #721C24; }
        .badge-success { background: #D4EDDA; color: #155724; }
        .badge-info { background: #D1ECF1; color: #0C5460; }
        
        /* Date Status Styles */
        .date-cell { font-size: 13px; white-space: nowrap; }
        .date-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .date-status.ok { background: #D4EDDA; color: #155724; }
        .date-status.warning { background: #FFF3CD; color: #856404; }
        .date-status.urgent { background: #FFE0B2; color: #E65100; }
        .date-status.overdue { background: #F8D7DA; color: #721C24; }
        .date-status.na { background: #F9FAFB; color: #999; }
        .date-status svg { width: 14px; height: 14px; }
        .date-sub { font-size: 10px; color: #666; margin-top: 2px; }
        
        /* HCA Tracker Integration Styles */
        .hca-mismatch { background: #FFF3CD !important; }
        .hca-mismatch .employee-name { color: #856404; position: relative; }
        .hca-mismatch .employee-name::after { content: '⚠'; margin-left: 6px; font-size: 12px; }
        .hca-link { cursor: pointer; text-decoration: none; }
        .hca-link:hover { text-decoration: underline; }
        .hca-sync-info { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #666; }
        .hca-sync-info svg { width: 14px; height: 14px; color: #28A745; }
        .hca-sync-info.stale svg { color: #F57600; }
        
        /* Employee Card with Checkbox */
        .employee-card { background: white; border: 2px solid #E5ECF3; border-radius: 12px; padding: 15px; margin-bottom: 10px; transition: all 0.3s; cursor: pointer; user-select: none; }
        .employee-card:hover { border-color: #F57600; background: #FFFAF5; }
        .employee-card.selected { border-color: #F57600; box-shadow: 0 4px 12px rgba(245, 118, 0, 0.2); background: #FFF8F0; }
        .employee-card-inner { display: flex; align-items: center; gap: 12px; }
        .employee-checkbox { width: 24px; height: 24px; border: 2px solid #ccc; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; background: white; }
        .employee-card.selected .employee-checkbox { background: #F57600; border-color: #F57600; }
        .employee-checkbox svg { width: 16px; height: 16px; color: white; display: none; }
        .employee-card.selected .employee-checkbox svg { display: block; }
        .employee-avatar { width: 44px; height: 44px; background: #1A365C; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0; }
        .employee-details { flex: 1; min-width: 0; }
        .employee-details h3 { font-size: 15px; color: #1A365C; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .employee-details p { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .employee-badge { flex-shrink: 0; }
        
        /* Selection Controls */
        .selection-controls { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 12px 15px; background: #F9FAFB; border-radius: 8px; flex-wrap: wrap; }
        .selection-controls .select-actions { display: flex; gap: 10px; }
        .selection-controls .selected-count { font-size: 14px; color: #1A365C; font-weight: 600; margin-left: auto; }
        .selection-controls .selected-count span { color: #F57600; }
        
        .template-card { background: white; border: 2px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s; }
        .template-card:hover { border-color: #F57600; transform: translateY(-2px); }
        .template-card.selected { border-color: #F57600; background: #FFF8F0; }
        .template-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .template-name { font-weight: 600; color: #1A365C; font-size: 15px; }
        .template-category { font-size: 11px; text-transform: uppercase; padding: 4px 10px; background: #E5ECF3; color: #1A365C; border-radius: 4px; font-weight: 600; }
        .template-preview { font-size: 13px; color: #666; line-height: 1.5; max-height: 60px; overflow: hidden; }
        
        .variables-panel { background: #FFF8F0; border: 2px solid #F57600; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .variables-panel h4 { color: #F57600; margin-bottom: 15px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .variable-input { display: grid; grid-template-columns: 140px 1fr; gap: 10px; align-items: center; margin-bottom: 10px; }
        .variable-input label { font-size: 12px; font-weight: 600; color: #1A365C; font-family: monospace; background: #E5ECF3; padding: 4px 8px; border-radius: 4px; }
        .variable-input input { padding: 10px 14px; border: 2px solid #E5ECF3; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 13px; }
        .variable-input input:focus { outline: none; border-color: #F57600; }
        .variable-input input:disabled { background: #f5f5f5; color: #999; }
        
        .preview-panel { background: white; border: 2px solid #E5ECF3; border-radius: 12px; overflow: hidden; }
        .preview-header { background: #1A365C; color: white; padding: 15px 20px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .preview-header svg { width: 20px; height: 20px; }
        .preview-content { padding: 20px; }
        .preview-meta { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E5ECF3; }
        .preview-meta-row { display: flex; margin-bottom: 8px; font-size: 13px; }
        .preview-meta-row:last-child { margin-bottom: 0; }
        .preview-meta-label { font-weight: 600; color: #1A365C; width: 60px; flex-shrink: 0; }
        .preview-meta-value { color: #666; }
        .preview-subject { font-weight: 600; color: #1A365C; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid #E5ECF3; }
        .preview-body { color: #333; line-height: 1.7; white-space: pre-wrap; max-height: 250px; overflow-y: auto; }
        
        /* Recipients Display */
        .recipients-display { background: #E8F4FD; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px; }
        .recipients-display label { font-size: 12px; color: #0C5460; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .recipients-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .recipient-tag { background: white; border: 1px solid #B3D9F7; border-radius: 20px; padding: 4px 12px; font-size: 12px; color: #0C5460; display: flex; align-items: center; gap: 6px; }
        .recipient-tag .remove-recipient { cursor: pointer; opacity: 0.6; font-size: 16px; line-height: 1; }
        .recipient-tag .remove-recipient:hover { opacity: 1; color: #DC3545; }
        
        /* Test Email Banner */
        .test-email-banner { background: #FFF3CD; border: 2px solid #FFEEBA; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 12px; }
        .test-email-banner svg { color: #856404; flex-shrink: 0; width: 24px; height: 24px; }
        .test-email-banner .content { flex: 1; }
        .test-email-banner .content strong { color: #856404; font-size: 14px; }
        .test-email-banner .content p { color: #856404; font-size: 12px; margin-top: 2px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 54, 92, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(3px); padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 700px; max-height: 90vh; overflow: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .modal-header { background: #1A365C; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1; }
        .modal-header h2 { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: white; cursor: pointer; padding: 5px; }
        .modal-close svg { width: 24px; height: 24px; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 30px; background: #F9FAFB; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; position: sticky; bottom: 0; }
        
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; min-width: 280px; max-width: 400px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 4px solid #28A745; }
        .toast.error { border-left: 4px solid #DC3545; }
        .toast.warning { border-left: 4px solid #F57600; }
        .toast.info { border-left: 4px solid #17A2B8; }
        .toast-icon { width: 24px; height: 24px; flex-shrink: 0; }
        .toast.success .toast-icon { color: #28A745; }
        .toast.error .toast-icon { color: #DC3545; }
        .toast.warning .toast-icon { color: #F57600; }
        .toast.info .toast-icon { color: #17A2B8; }
        .toast-message { flex: 1; font-size: 14px; color: #333; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #666; }
        .empty-state svg { width: 60px; height: 60px; color: #E5ECF3; margin-bottom: 15px; }
        .empty-state h3 { color: #1A365C; margin-bottom: 8px; font-size: 16px; }
        .empty-state p { font-size: 13px; }
        
        .info-box { background: #E8F4FD; border: 1px solid #B3D9F7; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; display: flex; gap: 12px; }
        .info-box.warning { background: #FFF3CD; border-color: #FFEEBA; }
        .info-box.success { background: #D4EDDA; border-color: #C3E6CB; }
        .info-box svg { width: 24px; height: 24px; flex-shrink: 0; }
        .info-box.warning svg { color: #856404; }
        .info-box.success svg { color: #155724; }
        .info-box-content h4 { font-size: 14px; margin-bottom: 5px; }
        .info-box-content p { font-size: 13px; line-height: 1.5; }
        .info-box-content code { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        
        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 14px 20px 14px 50px; border: 2px solid #E5ECF3; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 14px; transition: all 0.3s; }
        .search-box input:focus { outline: none; border-color: #F57600; box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1); }
        .search-box svg { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: #999; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 1000px) { .grid-2 { grid-template-columns: 1fr; } }
        
        .scrollable-list { max-height: 320px; overflow-y: auto; padding-right: 5px; }
        .scrollable-list::-webkit-scrollbar { width: 6px; }
        .scrollable-list::-webkit-scrollbar-track { background: #E5ECF3; border-radius: 3px; }
        .scrollable-list::-webkit-scrollbar-thumb { background: #1A365C; border-radius: 3px; }
        
        .action-buttons { display: flex; gap: 8px; flex-wrap: nowrap; white-space: nowrap; }
        
        /* Employee Directory Filters */
        .employee-filters { display: flex; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .employee-filters .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .employee-filters .filter-group label { font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; }
        .employee-filters .filter-group select { padding: 8px 12px; border: 2px solid #E5ECF3; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 13px; min-width: 140px; cursor: pointer; transition: all 0.2s; background: white; }
        .employee-filters .filter-group select:focus { outline: none; border-color: #F57600; }
        .employee-filters .filter-group select:hover { border-color: #1A365C; }
        .employee-filters .clear-filters { align-self: flex-end; padding: 8px 14px; }
        
        /* HCA Only Alert */
        .hca-only-alert { background: #E8F4FD; border: 2px solid #B3D9F7; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .hca-only-header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .hca-only-header svg { width: 20px; height: 20px; color: #0C5460; flex-shrink: 0; }
        .hca-only-header span { flex: 1; color: #0C5460; font-size: 14px; }
        .hca-only-header strong { color: #F57600; }
        .hca-only-details { margin-top: 15px; padding-top: 15px; border-top: 1px solid #B3D9F7; }
        .hca-only-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
        .hca-only-item { background: white; border: 1px solid #B3D9F7; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 10px; }
        .hca-only-item .hca-avatar { width: 36px; height: 36px; background: #0C5460; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px; flex-shrink: 0; }
        .hca-only-item .hca-info { flex: 1; min-width: 0; }
        .hca-only-item .hca-name { font-weight: 600; color: #1A365C; font-size: 13px; }
        .hca-only-item .hca-exp { font-size: 11px; color: #666; }
        .hca-only-item .hca-note { font-size: 10px; color: #F57600; margin-top: 2px; }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #E5ECF3; text-align: center; }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; color: #1A365C; margin-bottom: 5px; }
        .stat-card .stat-label { font-size: 12px; color: #666; }
        .stat-card.warning .stat-value { color: #F57600; }
        .stat-card.danger .stat-value { color: #DC3545; }
        
        .setup-container { max-width: 550px; margin: 0 auto; padding: 40px 20px; }
        .setup-card { background: white; border-radius: 16px; padding: 40px; box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15); text-align: center; }
        .setup-card .logo { margin-bottom: 20px; }
        .setup-card h2 { color: #1A365C; margin-bottom: 10px; }
        .setup-card p { color: #666; margin-bottom: 30px; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 12px; }
        .toggle-switch { position: relative; width: 50px; height: 26px; background: #E5ECF3; border-radius: 13px; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: #F57600; }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch.active::after { left: 27px; }
        .toggle-label { font-size: 14px; font-weight: 600; color: #1A365C; }
        
        .step-list { counter-reset: step-counter; }
        .step-item { position: relative; padding-left: 45px; margin-bottom: 20px; }
        .step-item::before { counter-increment: step-counter; content: counter(step-counter); position: absolute; left: 0; top: 0; width: 28px; height: 28px; background: #F57600; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; }
        .step-item h4 { color: #1A365C; margin-bottom: 5px; font-size: 14px; }
        .step-item p { color: #666; font-size: 13px; line-height: 1.5; }
        
        @media (max-width: 600px) {
            .variable-input { grid-template-columns: 1fr; }
            .modal-content { margin: 10px; }
            .selection-controls { flex-direction: column; align-items: stretch; }
            .selection-controls .selected-count { margin-left: 0; margin-top: 10px; }
        }
        
        /* Variable Palette Styles */
        .variable-palette { background: #F0F7FF; border: 2px solid #B3D4FC; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .variable-palette-header { display: flex; align-items: center; gap: 8px; color: #1A365C; font-weight: 600; font-size: 13px; margin-bottom: 12px; }
        .variable-chips { display: flex; flex-direction: column; gap: 10px; }
        .variable-chip-group { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
        .chip-group-label { font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; min-width: 70px; }
        .variable-chip { background: white; border: 1px solid #B3D4FC; border-radius: 15px; padding: 4px 10px; font-size: 11px; font-family: 'Courier New', monospace; color: #1A365C; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .variable-chip:hover { background: #1A365C; color: white; border-color: #1A365C; transform: translateY(-1px); }
        .variable-chip:active { transform: translateY(0); }
        .variable-chip.auto-var { background: #E8F5E9; border-color: #4CAF50; color: #2E7D32; }
        .variable-chip.auto-var:hover { background: #4CAF50; color: white; border-color: #4CAF50; }
        .variable-chip.custom-add { background: #F57600; color: white; border-color: #F57600; font-family: 'Poppins', sans-serif; font-weight: 600; }
        .variable-chip.custom-add:hover { background: #E06900; border-color: #E06900; }
        .custom-variable-input { padding: 4px 10px; border: 1px solid #B3D4FC; border-radius: 15px; font-size: 11px; font-family: 'Courier New', monospace; width: 100px; }
        .custom-variable-input:focus { outline: none; border-color: #F57600; }
        .field-hint { font-size: 11px; color: #999; font-weight: 400; }
        
        /* Branded Email Preview Styles */
        .branded-preview { padding: 0 !important; background: #E5ECF3 !important; }
        .email-preview-container { max-width: 100%; margin: 0; border-radius: 0 0 12px 12px; overflow: hidden; }
        .email-preview-header { background: linear-gradient(135deg, #1A365C 0%, #2D4A6F 100%); padding: 20px; position: relative; }
        .email-preview-logo { font-size: 20px; font-weight: 700; }
        .logo-alice, .logo-dot { color: #F57600; }
        .logo-care { color: white; font-weight: 400; }
        .email-preview-tagline { color: rgba(255,255,255,0.7); font-size: 11px; margin-top: 4px; }
        .email-preview-meta { background: white; padding: 15px 20px; border-bottom: 1px solid #E5ECF3; }
        .email-preview-meta .preview-meta-row { margin-bottom: 6px; font-size: 12px; }
        .email-preview-meta .preview-meta-row:last-child { margin-bottom: 0; }
        .email-preview-meta .preview-meta-label { font-weight: 600; color: #1A365C; width: 55px; display: inline-block; }
        .email-preview-meta .preview-meta-value { color: #666; }
        .email-preview-body { background: white; padding: 20px; color: #333; font-size: 13px; line-height: 1.7; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        .email-preview-footer { background: #1A365C; padding: 15px 20px; color: rgba(255,255,255,0.7); font-size: 10px; line-height: 1.5; }
        .email-preview-footer strong { color: white; }
        .footer-company { margin-bottom: 8px; }
        .footer-location { color: rgba(255,255,255,0.5); }
        
        /* Rich Text Editor Styles */
        .rte-toolbar { display: flex; flex-wrap: wrap; gap: 5px; padding: 8px 10px; background: #F9FAFB; border: 2px solid #E5ECF3; border-bottom: none; border-radius: 8px 8px 0 0; align-items: center; }
        .rte-toolbar-group { display: flex; gap: 2px; padding-right: 10px; border-right: 1px solid #E5ECF3; }
        .rte-toolbar-group:last-child { border-right: none; padding-right: 0; }
        .rte-toolbar-right { margin-left: auto; }
        .rte-btn { width: 32px; height: 32px; padding: 6px; background: white; border: 1px solid #E5ECF3; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .rte-btn:hover { background: #E5ECF3; border-color: #1A365C; }
        .rte-btn:active { background: #1A365C; color: white; }
        .rte-btn svg { width: 16px; height: 16px; }
        .rte-btn-text { width: auto; padding: 6px 10px; font-size: 11px; font-weight: 600; font-family: monospace; }
        .rte-color-label { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: white; border: 1px solid #E5ECF3; border-radius: 6px; cursor: pointer; transition: all 0.2s; position: relative; }
        .rte-color-label:hover { background: #E5ECF3; border-color: #1A365C; }
        .rte-color-label svg { width: 16px; height: 16px; }
        .rte-color-label input[type="color"] { position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 20px; height: 6px; padding: 0; border: none; cursor: pointer; }
        .rte-select { padding: 6px 8px; border: 1px solid #E5ECF3; border-radius: 6px; font-size: 12px; font-family: 'Poppins', sans-serif; background: white; cursor: pointer; }
        .rte-select:hover { border-color: #1A365C; }
        .rte-editor { min-height: 200px; max-height: 350px; overflow-y: auto; padding: 16px; border: 2px solid #E5ECF3; border-top: 1px solid #E5ECF3; border-radius: 0 0 8px 8px; font-family: 'Poppins', sans-serif; font-size: 14px; line-height: 1.6; background: white; outline: none; }
        .rte-editor:focus { border-color: #F57600; box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1); }
        .rte-editor:empty:before { content: attr(placeholder); color: #999; pointer-events: none; }
        .rte-editor h2 { font-size: 18px; color: #1A365C; margin: 10px 0; }
        .rte-editor h3 { font-size: 16px; color: #1A365C; margin: 8px 0; }
        .rte-editor a { color: #F57600; text-decoration: underline; }
        .rte-editor ul, .rte-editor ol { margin: 10px 0; padding-left: 25px; }
        .rte-html-source { width: 100%; min-height: 200px; padding: 16px; border: 2px solid #E5ECF3; border-top: 1px solid #E5ECF3; border-radius: 0 0 8px 8px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; background: #2D2D2D; color: #F8F8F2; resize: vertical; }
        .rte-html-source:focus { outline: none; border-color: #F57600; }
        
        /* Log Filters Card Styles */
        .log-filters-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(26, 54, 92, 0.08); margin-bottom: 25px; overflow: hidden; border: 2px solid #E5ECF3; }
        .log-filters-header { display: flex; align-items: center; gap: 10px; padding: 15px 20px; background: linear-gradient(135deg, #1A365C 0%, #2D4A6F 100%); color: white; font-weight: 600; font-size: 14px; }
        .log-filters-header svg { width: 18px; height: 18px; opacity: 0.8; }
        .log-filters-header .btn-outline { background: transparent; border-color: rgba(255,255,255,0.3); color: white; font-size: 11px; padding: 6px 12px; }
        .log-filters-header .btn-outline:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.5); }
        .log-filters-body { padding: 20px; background: #F9FAFB; }
        .log-filter-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .log-filter-row:last-child { margin-bottom: 0; }
        .log-filter-group { flex: 1; min-width: 180px; }
        .log-filter-group.log-filter-search { flex: 2; min-width: 280px; }
        .log-filter-group label { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: #1A365C; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .log-filter-group label svg { width: 14px; height: 14px; color: #F57600; }
        .log-filter-group input, .log-filter-group select { width: 100%; padding: 12px 14px; border: 2px solid #E5ECF3; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 13px; background: white; transition: all 0.2s; }
        .log-filter-group input:focus, .log-filter-group select:focus { outline: none; border-color: #F57600; box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1); }
        .log-filter-group input::placeholder { color: #999; }
        .log-filters-footer { padding: 12px 20px; background: white; border-top: 1px solid #E5ECF3; }
        .log-results-count { font-size: 13px; color: #666; font-weight: 500; }
        .log-results-count strong { color: #1A365C; }
        
        /* Modal Enhancements */
        .modal-large .modal-content { max-width: 650px; }
        .modal-section-title { font-size: 13px; font-weight: 600; color: #1A365C; text-transform: uppercase; letter-spacing: 0.5px; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #E5ECF3; display: flex; align-items: center; gap: 8px; }
        .modal-section-title:first-of-type { margin-top: 0; }
        .modal-section-title svg { width: 16px; height: 16px; color: #F57600; }
        
        /* Automation Section Styles */
        .automation-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(26, 54, 92, 0.08); border: 2px solid #E5ECF3; overflow: hidden; }
        .automation-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #1A365C 0%, #2D4A6F 100%); color: white; }
        .automation-title { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 16px; }
        .automation-title svg { width: 20px; height: 20px; color: #F57600; }
        .automation-status { display: flex; align-items: center; gap: 8px; font-size: 12px; opacity: 0.8; }
        .automation-status .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #F57600; }
        .automation-status.active .status-dot { background: #28A745; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .automation-info { display: flex; gap: 12px; padding: 15px 20px; background: #F0F7FF; border-bottom: 1px solid #E5ECF3; }
        .automation-info svg { width: 20px; height: 20px; color: #1A365C; flex-shrink: 0; margin-top: 2px; }
        .automation-info p { margin: 0; font-size: 13px; color: #666; line-height: 1.5; }
        .automation-triggers { padding: 20px; }
        .trigger-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: #F9FAFB; border-radius: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .trigger-item:last-child { margin-bottom: 0; }
        .trigger-toggle { flex-shrink: 0; padding-top: 2px; }
        .trigger-content { flex: 1; min-width: 200px; }
        .trigger-name { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #1A365C; margin-bottom: 4px; }
        .trigger-name svg { width: 16px; height: 16px; color: #F57600; }
        .trigger-description { font-size: 12px; color: #666; }
        .trigger-template { min-width: 200px; }
        .trigger-template select { width: 100%; padding: 8px 12px; border: 2px solid #E5ECF3; border-radius: 6px; font-size: 12px; background: white; }
        .trigger-template select:focus { outline: none; border-color: #F57600; }
        .trigger-options { display: flex; align-items: center; gap: 8px; margin-top: 8px; width: 100%; }
        .trigger-options label { font-size: 12px; color: #666; }
        .trigger-options input { width: 70px; padding: 6px 10px; border: 2px solid #E5ECF3; border-radius: 6px; font-size: 12px; text-align: center; }
        .trigger-options input:focus { outline: none; border-color: #F57600; }
        .automation-actions { display: flex; gap: 10px; padding: 20px; background: #F9FAFB; border-top: 1px solid #E5ECF3; flex-wrap: wrap; }
        .automation-actions .btn { display: flex; align-items: center; gap: 8px; }
        .automation-actions .btn svg { width: 16px; height: 16px; }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
            <div class="loading-subtext" id="loadingSubtext">Please wait</div>
        </div>
    </div>
    
    <!-- Setup Screen -->
    <div id="setupScreen" style="display: none;">
        <div class="setup-container">
            <div class="setup-card">
                <div class="logo"><span class="alice">alice</span><span class="dot">.</span><span class="care">care</span></div>
                <h2>Employee Email Manager Setup</h2>
                <p>Connect to your Google Sheet to get started</p>
                
                <div class="form-group" style="text-align: left;">
                    <label>Google Apps Script Web App URL *</label>
                    <input type="text" id="setupWebAppUrl" placeholder="https://script.google.com/macros/s/...../exec">
                </div>
                
                <button class="btn btn-primary" onclick="connectToSheet()" style="width: 100%; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Connect to Google Sheet
                </button>
                
                <div class="info-box" style="margin-top: 30px; text-align: left;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <div class="info-box-content">
                        <h4>First Time Setup?</h4>
                        <p>1. Create a new Google Sheet<br>
                        2. Go to Extensions → Apps Script<br>
                        3. Paste the Code.gs script<br>
                        4. Deploy as Web App<br>
                        5. Paste the URL above</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="compose">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                Compose
            </button>
            <button class="tab-btn" data-tab="templates">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                Templates
            </button>
            <button class="tab-btn" data-tab="employees">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                Employees
            </button>
            <button class="tab-btn" data-tab="logs">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Logs
            </button>
            <button class="tab-btn" data-tab="settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Settings
            </button>
            <div class="tab-btn connection-status" id="connectionStatus" title="Connected to Google Sheets">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                Connected
            </div>
        </nav>
        
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <div>
                        <div class="logo"><span class="alice">alice</span><span class="dot">.</span><span class="care">care</span></div>
                        <h1>Employee Email Manager</h1>
                        <p>Connected to Google Sheets • Real-time sync</p>
                    </div>
                    <button class="btn btn-outline" onclick="refreshAllData()" style="border-color: white; color: white;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        Refresh
                    </button>
                </div>
            </div>
            
            <!-- Compose Tab -->
            <div class="tab-content active" id="tab-compose">
                <div class="grid-2">
                    <div>
                        <h3 class="section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Select Employees
                        </h3>
                        
                        <div class="search-box">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                            <input type="text" id="employeeSearch" placeholder="Search by name, email, department...">
                        </div>
                        
                        <div class="selection-controls">
                            <div class="select-actions">
                                <button class="btn btn-small btn-outline" onclick="selectAllEmployees()">Select All</button>
                                <button class="btn btn-small btn-outline" onclick="clearEmployeeSelection()">Clear</button>
                            </div>
                            <div class="selected-count">Selected: <span id="selectedCount">0</span></div>
                        </div>
                        
                        <div id="employeeList" class="scrollable-list"></div>
                        
                        <h3 class="section-title" style="margin-top: 25px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Select Template
                        </h3>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <select id="templateCategory" onchange="renderTemplateList()">
                                <option value="">All Categories</option>
                                <option value="warning">Warnings</option>
                                <option value="reminder">Reminders</option>
                                <option value="announcement">Announcements</option>
                                <option value="hr">HR Communications</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div id="templateList" class="scrollable-list"></div>
                    </div>
                    
                    <div>
                        <!-- Test Mode Toggle -->
                        <div class="card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div class="toggle-container">
                                    <div class="toggle-switch" id="testModeToggle" onclick="toggleTestMode()"></div>
                                    <span class="toggle-label">Test Mode</span>
                                </div>
                                <div class="form-group" style="margin: 0; flex: 1; min-width: 180px;" id="testEmailGroup">
                                    <input type="email" id="testEmailAddress" placeholder="Test email address" style="padding: 10px 14px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Mode Banner -->
                        <div class="test-email-banner" id="testModeBanner" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            <div class="content">
                                <strong>Test Mode Active</strong>
                                <p>Emails will be sent to your test address only</p>
                            </div>
                        </div>
                        
                        <!-- Recipients Display -->
                        <div class="recipients-display" id="recipientsDisplay" style="display: none;">
                            <label>Recipients (<span id="recipientCount">0</span>)</label>
                            <div class="recipients-list" id="recipientsList"></div>
                        </div>
                        
                        <!-- Variables Panel -->
                        <div class="variables-panel" id="variablesPanel" style="display: none;">
                            <h4>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                                Template Variables
                            </h4>
                            <div id="variableInputs"></div>
                        </div>
                        
                        <!-- Preview Panel -->
                        <div class="preview-panel">
                            <div class="preview-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                Email Preview
                                <span style="margin-left: auto; font-size: 11px; font-weight: 400; opacity: 0.7;">Branded HTML</span>
                            </div>
                            <div class="preview-content branded-preview">
                                <!-- Branded Email Preview -->
                                <div class="email-preview-container">
                                    <div class="email-preview-header">
                                        <div class="email-preview-logo">
                                            <span class="logo-alice">alice</span><span class="logo-dot">.</span><span class="logo-care">care</span>
                                        </div>
                                        <div class="email-preview-tagline">Home Care Organization</div>
                                    </div>
                                    <div class="email-preview-meta">
                                        <div class="preview-meta-row"><span class="preview-meta-label">To:</span><span class="preview-meta-value" id="previewTo">Select employee(s)</span></div>
                                        <div class="preview-meta-row"><span class="preview-meta-label">From:</span><span class="preview-meta-value" id="previewFrom"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="71190331101d1812145f12100314">[email&#160;protected]</a></span></div>
                                        <div class="preview-meta-row"><span class="preview-meta-label">Subject:</span><span class="preview-meta-value" id="previewSubject">Select a template</span></div>
                                    </div>
                                    <div class="email-preview-body" id="previewBody">Select employee(s) and a template to preview the email.</div>
                                    <div class="email-preview-footer">
                                        <div class="footer-company">
                                            <strong>alice.care</strong><br>
                                            TEKKS LLC DBA alice.care<br>
                                            CDSS Licensed #344700080
                                        </div>
                                        <div class="footer-location">Fair Oaks, California</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Send Buttons -->
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="sendEmails()" id="sendBtn" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                <span id="sendBtnText">Send Email</span>
                            </button>
                            <button class="btn btn-warning" onclick="sendTestEmail()" id="testSendBtn" style="display: none;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                Send Test
                            </button>
                            <button class="btn btn-outline" onclick="resetCompose()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Templates Tab -->
            <div class="tab-content" id="tab-templates">
                <div class="card-header" style="margin-bottom: 20px;">
                    <h3 class="section-title" style="margin: 0;">Email Templates</h3>
                    <button class="btn btn-primary" onclick="openTemplateModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Template
                    </button>
                </div>
                <div class="info-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <div class="info-box-content">
                        <h4>Template Variables</h4>
                        <p>Click <strong>Add</strong> or <strong>Edit</strong> to open the template editor with clickable variable buttons. No need to remember syntax!</p>
                    </div>
                </div>
                <div id="templatesGrid"></div>
            </div>
            
            <!-- Employees Tab -->
            <div class="tab-content" id="tab-employees">
                <div class="card-header" style="margin-bottom: 20px;">
                    <h3 class="section-title" style="margin: 0;">Employee Directory</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div class="hca-sync-info" id="hcaSyncInfo" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            <span id="hcaSyncStatus">HCA synced</span>
                        </div>
                        <button class="btn btn-outline btn-small" onclick="syncHCAData()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                            Sync HCA
                        </button>
                        <button class="btn btn-primary" onclick="openEmployeeModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Add Employee
                        </button>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Employees</div></div>
                    <div class="stat-card warning"><div class="stat-value" id="statWarnings">0</div><div class="stat-label">With Warnings</div></div>
                    <div class="stat-card danger"><div class="stat-value" id="statFinal">0</div><div class="stat-label">Final Warning</div></div>
                    <div class="stat-card"><div class="stat-value" id="statEmails">0</div><div class="stat-label">Emails (30d)</div></div>
                </div>
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    <input type="text" id="employeeDirectorySearch" placeholder="Search by name, email, department...">
                </div>
                <div class="employee-filters">
                    <div class="filter-group">
                        <label>Position</label>
                        <select id="filterPosition" onchange="renderEmployeeDirectory()">
                            <option value="">All Positions</option>
                            <option value="HCA" selected>HCA Only</option>
                            <option value="other">Non-HCA Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>HCA Sync Status</label>
                        <select id="filterMismatch" onchange="renderEmployeeDirectory()">
                            <option value="">All Employees</option>
                            <option value="mismatch">⚠ Not in HCA Tracker</option>
                            <option value="matched">✓ Matched in HCA</option>
                            <option value="hca-only">📋 In HCA Only (not here)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>HCA Expiration</label>
                        <select id="filterHCA" onchange="renderEmployeeDirectory()">
                            <option value="">All Statuses</option>
                            <option value="overdue">🔴 Overdue</option>
                            <option value="urgent">🟠 Urgent</option>
                            <option value="warning">🟡 Warning</option>
                            <option value="ok">🟢 OK</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>TB Test Due</label>
                        <select id="filterTB" onchange="renderEmployeeDirectory()">
                            <option value="">All Statuses</option>
                            <option value="overdue">🔴 Overdue</option>
                            <option value="urgent">🟠 Urgent</option>
                            <option value="warning">🟡 Warning</option>
                            <option value="ok">🟢 OK</option>
                            <option value="xray">✓ X-Ray</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Training Due</label>
                        <select id="filterTraining" onchange="renderEmployeeDirectory()">
                            <option value="">All Statuses</option>
                            <option value="overdue">🔴 Overdue</option>
                            <option value="urgent">🟠 Urgent</option>
                            <option value="warning">🟡 Warning</option>
                            <option value="ok">🟢 OK</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>
                    <button class="btn btn-small btn-outline clear-filters" onclick="clearEmployeeFilters()">Clear Filters</button>
                </div>
                <!-- HCA Only Alert -->
                <div class="hca-only-alert" id="hcaOnlyAlert" style="display: none;">
                    <div class="hca-only-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        <span><strong id="hcaOnlyCount">0</strong> employees in HCA Tracker not in this list</span>
                        <button class="btn btn-small btn-outline" onclick="toggleHCAOnlyDetails()">Show Details</button>
                    </div>
                    <div class="hca-only-details" id="hcaOnlyDetails" style="display: none;">
                        <div class="hca-only-list" id="hcaOnlyList"></div>
                    </div>
                </div>
                <div class="table-container" style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>Employee</th><th>Position</th><th>Warning Level</th><th>HCA Expiration</th><th>TB Date Taken</th><th>Training Taken</th><th>Actions</th></tr></thead>
                        <tbody id="employeeTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div class="tab-content" id="tab-logs">
                <h3 class="section-title">Email History</h3>
                
                <!-- Branded Filter Card -->
                <div class="log-filters-card">
                    <div class="log-filters-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                        <span>Search & Filter</span>
                        <button class="btn btn-small btn-outline" onclick="clearLogFilters()" style="margin-left: auto;">Clear All</button>
                    </div>
                    <div class="log-filters-body">
                        <div class="log-filter-row">
                            <div class="log-filter-group log-filter-search">
                                <label>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                    Employee Search
                                </label>
                                <input type="text" id="logSearchInput" placeholder="Search by name or email..." oninput="renderLogs()">
                            </div>
                            <div class="log-filter-group">
                                <label>Department</label>
                                <select id="logDepartmentFilter" onchange="renderLogs()">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                        </div>
                        <div class="log-filter-row">
                            <div class="log-filter-group">
                                <label>Template</label>
                                <select id="logTemplateFilter" onchange="renderLogs()">
                                    <option value="">All Templates</option>
                                </select>
                            </div>
                            <div class="log-filter-group">
                                <label>Category</label>
                                <select id="logCategoryFilter" onchange="renderLogs()">
                                    <option value="">All Categories</option>
                                    <option value="warning">Warnings</option>
                                    <option value="reminder">Reminders</option>
                                    <option value="announcement">Announcements</option>
                                    <option value="hr">HR</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="log-filter-group">
                                <label>Date Range</label>
                                <select id="logDateFilter" onchange="renderLogs()">
                                    <option value="all">All Time</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">Last Year</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="log-filters-footer">
                        <span class="log-results-count" id="logResultsCount">0 emails found</span>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>Date/Time</th><th>Employee</th><th>Department</th><th>Template</th><th>Subject</th><th>Actions</th></tr></thead>
                        <tbody id="logsTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="grid-2">
                    <div>
                        <h3 class="section-title">Google Sheet Connection</h3>
                        <div class="card">
                            <div class="info-box success" style="margin-bottom: 15px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                <div class="info-box-content">
                                    <h4>Connected</h4>
                                    <p id="connectedUrl" style="word-break: break-all; font-size: 11px;"></p>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-outline btn-small" onclick="showChangeUrlModal()">Change URL</button>
                                <button class="btn btn-danger btn-small" onclick="disconnectSheet()">Reset Connection</button>
                            </div>
                        </div>
                        
                        <h3 class="section-title" style="margin-top: 25px;">Email Aliases</h3>
                        <div class="card">
                            <div class="card-header"><div class="card-title">Active Aliases</div><button class="btn btn-small btn-primary" onclick="openAliasModal()">Add</button></div>
                            <div id="aliasesList"></div>
                        </div>
                        <div class="card">
                            <div class="card-title" style="margin-bottom: 10px;">Default Send From</div>
                            <select id="defaultAlias" onchange="saveDefaultAlias()" style="width: 100%; padding: 10px; border: 2px solid #E5ECF3; border-radius: 8px;"></select>
                        </div>
                    </div>
                    <div>
                        <h3 class="section-title">Setup Guide</h3>
                        <div class="card">
                            <div class="step-list">
                                <div class="step-item"><h4>Create Google Sheet</h4><p>Create a new Google Sheet</p></div>
                                <div class="step-item"><h4>Open Apps Script</h4><p>Extensions → Apps Script</p></div>
                                <div class="step-item"><h4>Paste Code</h4><p>Copy Code.gs and paste</p></div>
                                <div class="step-item"><h4>Deploy</h4><p>Deploy → New deployment → Web app</p></div>
                                <div class="step-item"><h4>Connect</h4><p>Paste URL in setup screen</p></div>
                            </div>
                        </div>
                        
                        <h3 class="section-title" style="margin-top: 25px;">Data Management</h3>
                        <div class="card">
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="exportData()">Export</button>
                                <button class="btn btn-outline btn-small" onclick="document.getElementById('importFile').click()">Import</button>
                                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
                                <button class="btn btn-danger btn-small" onclick="confirmClearData()">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Automation Section -->
                <h3 class="section-title" style="margin-top: 30px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Email Automation
                </h3>
                
                <div class="automation-card">
                    <div class="automation-header">
                        <div class="automation-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
                            Automated Email Triggers
                        </div>
                        <div class="automation-status" id="automationStatus">
                            <span class="status-dot"></span>
                            <span>Configure triggers below</span>
                        </div>
                    </div>
                    
                    <div class="automation-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        <p>Automated emails are sent daily to <strong>active employees only</strong>. The "days before due" settings also control the <strong>color warning thresholds</strong> in the Employee Directory table. <strong>TB, Training, and HCA reminders are sent only to employees with "HCA" in their position.</strong> You must run the automation manually or set up a daily trigger in Google Apps Script.</p>
                    </div>
                    
                    <div class="automation-triggers">
                        <!-- Hire Anniversary -->
                        <div class="trigger-item">
                            <div class="trigger-toggle">
                                <div class="toggle-switch" id="triggerHireAnniversary" onclick="toggleAutomation('hireAnniversary')"></div>
                            </div>
                            <div class="trigger-content">
                                <div class="trigger-name">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    Hire Anniversary
                                </div>
                                <div class="trigger-description">Send congratulations on work anniversary (hire date each year)</div>
                            </div>
                            <div class="trigger-template">
                                <select id="templateHireAnniversary" onchange="saveAutomationSettings()">
                                    <option value="">Select template...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Birthday -->
                        <div class="trigger-item">
                            <div class="trigger-toggle">
                                <div class="toggle-switch" id="triggerBirthday" onclick="toggleAutomation('birthday')"></div>
                            </div>
                            <div class="trigger-content">
                                <div class="trigger-name">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M12 2v2"/></svg>
                                    Birthday Wishes
                                </div>
                                <div class="trigger-description">Send birthday greetings on employee's birth date</div>
                            </div>
                            <div class="trigger-template">
                                <select id="templateBirthday" onchange="saveAutomationSettings()">
                                    <option value="">Select template...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- TB Test Reminder -->
                        <div class="trigger-item">
                            <div class="trigger-toggle">
                                <div class="toggle-switch" id="triggerTBReminder" onclick="toggleAutomation('tbReminder')"></div>
                            </div>
                            <div class="trigger-content">
                                <div class="trigger-name">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                    TB Test Reminder
                                </div>
                                <div class="trigger-description">Remind employee when TB test is due - <strong style="color: #F57600;">HCA positions only</strong> (excludes X-Ray)</div>
                            </div>
                            <div class="trigger-template">
                                <select id="templateTBReminder" onchange="saveAutomationSettings()">
                                    <option value="">Select template...</option>
                                </select>
                            </div>
                            <div class="trigger-options">
                                <label>Days before due:</label>
                                <input type="number" id="tbReminderDays" value="30" min="1" max="90" onchange="saveAutomationSettings()">
                            </div>
                        </div>
                        
                        <!-- Training Reminder -->
                        <div class="trigger-item">
                            <div class="trigger-toggle">
                                <div class="toggle-switch" id="triggerTrainingReminder" onclick="toggleAutomation('trainingReminder')"></div>
                            </div>
                            <div class="trigger-content">
                                <div class="trigger-name">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                    Training Reminder
                                </div>
                                <div class="trigger-description">Remind employee when annual training is due - <strong style="color: #F57600;">HCA positions only</strong></div>
                            </div>
                            <div class="trigger-template">
                                <select id="templateTrainingReminder" onchange="saveAutomationSettings()">
                                    <option value="">Select template...</option>
                                </select>
                            </div>
                            <div class="trigger-options">
                                <label>Days before due:</label>
                                <input type="number" id="trainingReminderDays" value="30" min="1" max="90" onchange="saveAutomationSettings()">
                            </div>
                        </div>
                        
                        <!-- HCA Certification Reminder -->
                        <div class="trigger-item">
                            <div class="trigger-toggle">
                                <div class="toggle-switch" id="triggerHCAReminder" onclick="toggleAutomation('hcaReminder')"></div>
                            </div>
                            <div class="trigger-content">
                                <div class="trigger-name">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    HCA Certification Reminder
                                </div>
                                <div class="trigger-description">Remind employee when HCA certification renewal is approaching - <strong style="color: #F57600;">HCA positions only</strong></div>
                            </div>
                            <div class="trigger-template">
                                <select id="templateHCAReminder" onchange="saveAutomationSettings()">
                                    <option value="">Select template...</option>
                                </select>
                            </div>
                            <div class="trigger-options">
                                <label>Days before due:</label>
                                <input type="number" id="hcaReminderDays" value="60" min="1" max="180" onchange="saveAutomationSettings()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="automation-actions">
                        <button class="btn btn-primary" onclick="runAutomation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Run Automation Now
                        </button>
                        <button class="btn btn-outline" onclick="previewAutomation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            Preview Pending Emails
                        </button>
                        <button class="btn btn-secondary" onclick="createDefaultAutomationTemplates()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                            Create Default Templates
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Employee Modal -->
    <div class="modal" id="employeeModal">
        <div class="modal-content modal-large">
            <div class="modal-header"><h2 id="employeeModalTitle">Add Employee</h2><button class="modal-close" onclick="closeModal('employeeModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body">
                <input type="hidden" id="editEmployeeId">
                
                <h4 class="modal-section-title">Basic Information</h4>
                <div class="form-row">
                    <div class="form-group"><label>First Name *</label><input type="text" id="empFirstName" placeholder="John"></div>
                    <div class="form-group"><label>Last Name *</label><input type="text" id="empLastName" placeholder="Doe"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Email Address *</label><input type="email" id="empEmail" placeholder="john.doe@example.com"></div>
                    <div class="form-group"><label>Status</label>
                        <select id="empStatus">
                            <option value="active">Active</option>
                            <option value="terminated">Terminated</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Department</label><input type="text" id="empDepartment" placeholder="Caregiving"></div>
                    <div class="form-group"><label>Position</label><input type="text" id="empPosition" placeholder="Caregiver"></div>
                </div>
                <div class="form-group"><label>Supervisor Name</label><input type="text" id="empSupervisor" placeholder="Jane Smith"></div>
                
                <h4 class="modal-section-title">Important Dates</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hire Date</label>
                        <input type="date" id="empHireDate">
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="empBirthDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>TB Test Date</label>
                        <input type="date" id="empTBDate">
                        <div class="checkbox-row" style="margin-top: 8px;">
                            <input type="checkbox" id="empTBXray" style="width: auto; margin-right: 8px;">
                            <label for="empTBXray" style="font-weight: 400; font-size: 13px; color: #666; margin: 0; cursor: pointer;">X-Ray (no renewal required)</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Training Date</label>
                        <input type="date" id="empTrainingDate">
                        <span class="field-hint">Last training completion</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>HCA Certification Date</label>
                        <input type="date" id="empHCADate">
                        <span class="field-hint">HCA certification date</span>
                    </div>
                    <div class="form-group"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('employeeModal')">Cancel</button><button class="btn btn-primary" onclick="saveEmployee()">Save</button></div>
        </div>
    </div>
    
    <!-- Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="templateModalTitle">Add Template</h2><button class="modal-close" onclick="closeModal('templateModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body">
                <input type="hidden" id="editTemplateId">
                <div class="form-row">
                    <div class="form-group"><label>Name *</label><input type="text" id="tplName" placeholder="First Warning - Attendance"></div>
                    <div class="form-group"><label>Category *</label><select id="tplCategory"><option value="warning">Warning</option><option value="reminder">Reminder</option><option value="announcement">Announcement</option><option value="hr">HR</option><option value="custom">Custom</option></select></div>
                </div>
                
                <!-- Variable Palette -->
                <div class="variable-palette">
                    <div class="variable-palette-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                        <span>Click to insert variable:</span>
                    </div>
                    <div class="variable-chips">
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Employee</span>
                            <button type="button" class="variable-chip" onclick="insertVariable('first_name')">{{first_name}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('last_name')">{{last_name}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('supervisor_name')">{{supervisor_name}}</button>
                        </div>
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Dates</span>
                            <button type="button" class="variable-chip" onclick="insertVariable('date')">{{date}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('incident_date')">{{incident_date}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('effective_date')">{{effective_date}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('due_date')">{{due_date}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('previous_warning_date')">{{previous_warning_date}}</button>
                        </div>
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Details</span>
                            <button type="button" class="variable-chip" onclick="insertVariable('issue_description')">{{issue_description}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('issue_type')">{{issue_type}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('policy_name')">{{policy_name}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('policy_details')">{{policy_details}}</button>
                        </div>
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Schedule</span>
                            <button type="button" class="variable-chip" onclick="insertVariable('previous_schedule')">{{previous_schedule}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('new_schedule')">{{new_schedule}}</button>
                        </div>
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Training</span>
                            <button type="button" class="variable-chip" onclick="insertVariable('training_name')">{{training_name}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('training_duration')">{{training_duration}}</button>
                            <button type="button" class="variable-chip" onclick="insertVariable('training_link')">{{training_link}}</button>
                        </div>
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Compliance (Auto-filled)</span>
                            <button type="button" class="variable-chip auto-var" onclick="insertVariable('hca_expiration_date')" title="Auto-filled from HCA Tracker or employee record">{{hca_expiration_date}}</button>
                            <button type="button" class="variable-chip auto-var" onclick="insertVariable('days_until_hca_expiration')" title="Auto-calculated days remaining">{{days_until_hca_expiration}}</button>
                            <button type="button" class="variable-chip auto-var" onclick="insertVariable('tb_due_date')" title="Auto-calculated: TB date + 2 years">{{tb_due_date}}</button>
                            <button type="button" class="variable-chip auto-var" onclick="insertVariable('days_until_tb_due')" title="Auto-calculated days remaining">{{days_until_tb_due}}</button>
                            <button type="button" class="variable-chip auto-var" onclick="insertVariable('training_due_date')" title="Auto-calculated: Training date + 1 year">{{training_due_date}}</button>
                            <button type="button" class="variable-chip auto-var" onclick="insertVariable('days_until_training_due')" title="Auto-calculated days remaining">{{days_until_training_due}}</button>
                        </div>
                        <div class="variable-chip-group">
                            <span class="chip-group-label">Custom</span>
                            <input type="text" id="customVariableName" placeholder="custom_var" class="custom-variable-input">
                            <button type="button" class="variable-chip custom-add" onclick="insertCustomVariable()">+ Add</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Subject * <span class="field-hint">(click in field, then click variable above)</span></label>
                    <input type="text" id="tplSubject" placeholder="{{first_name}} {{last_name}} - Warning">
                </div>
                <div class="form-group">
                    <label>Body * <span class="field-hint">(use toolbar to format, click variable buttons to insert)</span></label>
                    
                    <!-- Rich Text Editor Toolbar -->
                    <div class="rte-toolbar">
                        <div class="rte-toolbar-group">
                            <button type="button" class="rte-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/></svg>
                            </button>
                            <button type="button" class="rte-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/></svg>
                            </button>
                            <button type="button" class="rte-btn" onclick="formatText('underline')" title="Underline (Ctrl+U)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/><line x1="4" y1="21" x2="20" y2="21"/></svg>
                            </button>
                        </div>
                        <div class="rte-toolbar-group">
                            <button type="button" class="rte-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="9" y1="6" x2="20" y2="6"/><line x1="9" y1="12" x2="20" y2="12"/><line x1="9" y1="18" x2="20" y2="18"/><circle cx="4" cy="6" r="1" fill="currentColor"/><circle cx="4" cy="12" r="1" fill="currentColor"/><circle cx="4" cy="18" r="1" fill="currentColor"/></svg>
                            </button>
                            <button type="button" class="rte-btn" onclick="formatText('insertOrderedList')" title="Numbered List">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="10" y1="6" x2="21" y2="6"/><line x1="10" y1="12" x2="21" y2="12"/><line x1="10" y1="18" x2="21" y2="18"/><text x="4" y="7" font-size="6" fill="currentColor">1</text><text x="4" y="13" font-size="6" fill="currentColor">2</text><text x="4" y="19" font-size="6" fill="currentColor">3</text></svg>
                            </button>
                        </div>
                        <div class="rte-toolbar-group">
                            <button type="button" class="rte-btn" onclick="insertLink()" title="Insert Link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                            </button>
                            <button type="button" class="rte-btn" onclick="removeLink()" title="Remove Link">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/><line x1="4" y1="4" x2="20" y2="20" stroke="#DC3545"/></svg>
                            </button>
                        </div>
                        <div class="rte-toolbar-group">
                            <label class="rte-color-label" title="Text Color">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16"/><path d="M9.5 4L5 16h2l1-3h6l1 3h2L12.5 4z"/></svg>
                                <input type="color" id="textColorPicker" value="#1A365C" onchange="applyTextColor(this.value)">
                            </label>
                            <label class="rte-color-label" title="Highlight Color">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" fill="#FFF3CD"/><path d="M9.5 8L5 18h2l1-2.5h6l1 2.5h2L12.5 8z"/></svg>
                                <input type="color" id="highlightColorPicker" value="#FFF3CD" onchange="applyHighlightColor(this.value)">
                            </label>
                        </div>
                        <div class="rte-toolbar-group">
                            <select onchange="applyHeading(this.value); this.value='';" class="rte-select" title="Text Style">
                                <option value="">Style</option>
                                <option value="p">Normal</option>
                                <option value="h2">Heading</option>
                                <option value="h3">Subheading</option>
                            </select>
                        </div>
                        <div class="rte-toolbar-group rte-toolbar-right">
                            <button type="button" class="rte-btn rte-btn-text" onclick="toggleHtmlView()" title="View/Edit HTML">
                                &lt;/&gt; HTML
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rich Text Editor Content Area -->
                    <div id="tplBody" class="rte-editor" contenteditable="true" placeholder="Dear {{first_name}},

Write your email content here..."></div>
                    
                    <!-- HTML Source View (hidden by default) -->
                    <textarea id="tplBodyHtml" class="rte-html-source" style="display: none;" placeholder="HTML source code..."></textarea>
                </div>
                <div class="form-group"><label>Warning Level</label><select id="tplWarningLevel"><option value="0">Not a Warning</option><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option><option value="4">Final</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('templateModal')">Cancel</button><button class="btn btn-primary" onclick="saveTemplate()">Save</button></div>
        </div>
    </div>
    
    <!-- Alias Modal -->
    <div class="modal" id="aliasModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header"><h2>Add Alias</h2><button class="modal-close" onclick="closeModal('aliasModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body">
                <div class="form-group"><label>Name *</label><input type="text" id="aliasName" placeholder="HR Department"></div>
                <div class="form-group"><label>Email *</label><input type="email" id="aliasEmail" placeholder="hr@alice.care"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('aliasModal')">Cancel</button><button class="btn btn-primary" onclick="saveAlias()">Save</button></div>
        </div>
    </div>
    
    <!-- View Log Modal -->
    <div class="modal" id="logModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Email Details</h2><button class="modal-close" onclick="closeModal('logModal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
            <div class="modal-body" id="logModalContent"></div>
            <div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('logModal')">Close</button><button class="btn btn-primary" onclick="resendFromLog()">Resend</button></div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // STATE
        // ============================================
        const STORAGE_KEY = 'alicecare_webapp_url';
        let WEB_APP_URL = '';
        let employees = [];
        let templates = [];
        let emailLogs = [];
        let aliases = [];
        let settings = {};
        let selectedEmployeeIds = new Set();
        let selectedTemplate = null;
        let variableValues = {};
        let testMode = false;
        let viewingLogId = null;
        
        // HCA Tracker Integration
        const HCA_TRACKER_SHEET_ID = '1m5Pr9aYo314GJ-rPX9wVha-wClXMXwaHOBks0ZU4Amg';
        const HCA_TRACKER_URL = 'https://alicecare2032.github.io/alice-care-timeoff/hca-tracker-dashboard.html';
        let hcaTrackerData = []; // Stores { firstName, lastName, expirationDate } from HCA Tracker
        let hcaLastSync = null;
        
        // ============================================
        // HELPERS
        // ============================================
        function escapeHtml(text) { 
            if (!text) return ''; 
            return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); 
        }
        function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
        function formatDate(d) { if (!d) return 'N/A'; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function formatDateTime(d) { if (!d) return 'N/A'; return new Date(d).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }); }
        function getFullName(emp) { 
            // Handle both old (name) and new (firstName/lastName) structures
            if (emp.firstName || emp.lastName) {
                return ((emp.firstName || '') + ' ' + (emp.lastName || '')).trim() || 'Unknown';
            }
            return emp.name || 'Unknown';
        }
        function getInitials(emp) { 
            if (emp.firstName || emp.lastName) {
                return ((emp.firstName?.[0] || '') + (emp.lastName?.[0] || '')).toUpperCase() || '?';
            }
            // Fallback for old 'name' field
            if (emp.name) {
                const parts = emp.name.trim().split(/\s+/);
                return ((parts[0]?.[0] || '') + (parts[1]?.[0] || '')).toUpperCase() || '?';
            }
            return '?';
        }
        
        function getEmployeeWarningLevel(empId) {
            const id = String(empId);
            const logs = emailLogs.filter(l => String(l.employeeId) === id && parseInt(l.warningLevel) > 0);
            if (logs.length === 0) return 0;
            return Math.max(...logs.map(l => parseInt(l.warningLevel) || 0));
        }
        
        function getLastEmailDate(empId) {
            const id = String(empId);
            const logs = emailLogs.filter(l => String(l.employeeId) === id).sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
            return logs.length > 0 ? logs[0].sentAt : null;
        }
        
        // Check if employee has HCA position (for TB, Training, HCA notifications)
        function isHCAPosition(emp) {
            const position = (emp.position || '').toLowerCase();
            return position.includes('hca') || position.includes('home care aide');
        }
        
        // ============================================
        // API - Using JSONP for all requests to avoid CORS
        // ============================================
        let jsonpCounter = 0;
        
        function apiCall(params, method = 'GET') {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + (++jsonpCounter) + '_' + Date.now();
                const timeout = setTimeout(() => { 
                    delete window[cb]; 
                    reject(new Error('Request timeout - check your connection')); 
                }, 30000);
                
                window[cb] = (data) => { 
                    clearTimeout(timeout); 
                    delete window[cb]; 
                    resolve(data); 
                };
                
                // Always use JSONP (GET) to avoid CORS issues with local files
                const url = new URL(WEB_APP_URL);
                url.searchParams.append('callback', cb);
                
                // For POST data, encode it as a URL parameter
                if (method === 'POST') {
                    // Aggressively compress HTML content to reduce payload size
                    if (params.body && typeof params.body === 'string') {
                        params.body = params.body
                            .replace(/\r\n/g, '\n')
                            .replace(/\n\s+/g, '\n')
                            .replace(/\s+\n/g, '\n')
                            .replace(/>\s+</g, '><')
                            .replace(/\s{2,}/g, ' ')
                            .trim();
                    }
                    
                    // Send data as base64 encoded JSON to handle special characters
                    const jsonData = JSON.stringify(params);
                    const encodedData = btoa(unescape(encodeURIComponent(jsonData)));
                    
                    url.searchParams.append('postData', encodedData);
                    url.searchParams.append('method', 'POST');
                } else {
                    // For GET, add params directly
                    Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
                }
                
                const script = document.createElement('script');
                script.src = url.toString();
                script.onerror = () => { 
                    clearTimeout(timeout); 
                    delete window[cb]; 
                    reject(new Error('Network error - check Web App URL')); 
                };
                document.body.appendChild(script);
                script.onload = () => script.remove();
            });
        }
        
        // ============================================
        // TOAST & LOADING
        // ============================================
        function showToast(msg, type = 'info') {
            const icons = { success: '✓', error: '✗', warning: '⚠', info: 'ℹ' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="toast-icon">${icons[type]}</div><div class="toast-message">${msg}</div>`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }
        
        function showLoading(show, text = 'Loading...', subtext = '') {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // ============================================
        // INIT & CONNECTION
        // ============================================
        
        // Default Web App URL - change this to your deployed Google Apps Script URL
        const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzPAaZv4xOUiUIP_OV1PZuDPDSMJIM965pRNaw2jVc3iaXuj9dwiW800qABEj-_i3uZxA/exec';
        
        async function init() {
            // Use saved URL or default
            WEB_APP_URL = localStorage.getItem(STORAGE_KEY) || DEFAULT_WEB_APP_URL;
            
            // Always go to main app (no setup screen)
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('connectedUrl').textContent = WEB_APP_URL;
            
            // Save the URL if not already saved
            if (!localStorage.getItem(STORAGE_KEY) && WEB_APP_URL) {
                localStorage.setItem(STORAGE_KEY, WEB_APP_URL);
            }
            
            await loadAllData();
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Tab buttons
            document.querySelectorAll('.tab-btn[data-tab]').forEach(btn => {
                btn.addEventListener('click', () => showTab(btn.dataset.tab));
            });
            
            // Search inputs with debounce
            const empSearch = document.getElementById('employeeSearch');
            const empDirSearch = document.getElementById('employeeDirectorySearch');
            let searchTimeout;
            
            empSearch.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => renderEmployeeList(), 150);
            });
            
            empDirSearch.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => renderEmployeeDirectory(), 150);
            });
        }
        
        async function connectToSheet() {
            const url = document.getElementById('setupWebAppUrl').value.trim();
            if (!url || !url.startsWith('https://script.google.com/')) {
                showToast('Please enter a valid Google Apps Script URL', 'error');
                return;
            }
            
            showLoading(true, 'Connecting...');
            WEB_APP_URL = url;
            
            try {
                const check = await apiCall({ action: 'checkInitialized' });
                if (!check.success) throw new Error(check.error || 'Connection failed');
                
                if (!check.initialized) {
                    showLoading(true, 'Initializing...', 'Creating sheet structure');
                    const init = await apiCall({ action: 'initialize' });
                    if (!init.success) throw new Error(init.error);
                    showToast('Sheet initialized!', 'success');
                }
                
                localStorage.setItem(STORAGE_KEY, url);
                showToast('Connected!', 'success');
                await init();
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function disconnectSheet() {
            if (!confirm('Reset connection? This will clear your saved URL and reload the page.')) return;
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
        
        function showChangeUrlModal() {
            const currentUrl = WEB_APP_URL || '';
            const newUrl = prompt('Enter Google Apps Script Web App URL:', currentUrl);
            
            if (newUrl === null) return; // Cancelled
            
            if (!newUrl || !newUrl.startsWith('https://script.google.com/')) {
                showToast('Please enter a valid Google Apps Script URL', 'error');
                return;
            }
            
            if (newUrl === currentUrl) {
                showToast('URL unchanged', 'info');
                return;
            }
            
            // Save and reload
            localStorage.setItem(STORAGE_KEY, newUrl);
            showToast('URL updated! Reloading...', 'success');
            setTimeout(() => location.reload(), 1000);
        }
        
        async function loadAllData() {
            showLoading(true, 'Loading data...');
            try {
                const result = await apiCall({ action: 'getAllData' });
                console.log('Raw API result:', result);
                if (!result.success) throw new Error(result.error);
                
                employees = result.data.employees || [];
                templates = result.data.templates || [];
                emailLogs = result.data.emailLogs || [];
                aliases = result.data.aliases || [];
                settings = result.data.settings || {};
                
                console.log('Loaded employees:', employees);
                console.log('First employee structure:', employees[0]);
                console.log('Loaded templates:', templates.length);
                console.log('Loaded logs:', emailLogs.length);
                
                renderEmployeeList();
                renderTemplateList();
                updatePreview();
                loadAutomationSettings();
            } catch (e) {
                console.error('Load error:', e);
                showToast('Load failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function refreshAllData() { await loadAllData(); showToast('Refreshed!', 'success'); }
        
        // ============================================
        // TABS
        // ============================================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'compose') { renderEmployeeList(); renderTemplateList(); }
            else if (tabName === 'templates') renderTemplatesGrid();
            else if (tabName === 'employees') { renderEmployeeDirectory(); updateStats(); }
            else if (tabName === 'logs') { populateLogFilters(); renderLogs(); }
            else if (tabName === 'settings') { renderAliases(); renderAutomationUI(); }
        }
        
        // ============================================
        // COMPOSE - EMPLOYEES
        // ============================================
        function renderEmployeeList() {
            const container = document.getElementById('employeeList');
            const search = (document.getElementById('employeeSearch')?.value || '').toLowerCase().trim();
            
            let filtered = employees;
            if (search) {
                filtered = employees.filter(e => {
                    const name = getFullName(e).toLowerCase();
                    const email = (e.email || '').toLowerCase();
                    const dept = (e.department || '').toLowerCase();
                    return name.includes(search) || email.includes(search) || dept.includes(search);
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><h3>${employees.length ? 'No Results' : 'No Employees'}</h3><p>${employees.length ? 'Try different search' : 'Add employees first'}</p></div>`;
                updateSelectedCount();
                return;
            }
            
            container.innerHTML = filtered.map(emp => {
                const empIdStr = String(emp.id);
                const isSelected = selectedEmployeeIds.has(empIdStr);
                const level = getEmployeeWarningLevel(emp.id);
                const badge = level > 0 ? `<span class="badge badge-warning-${Math.min(level, 3)} employee-badge">${level >= 4 ? 'Final' : 'L' + level}</span>` : '';
                
                return `<div class="employee-card ${isSelected ? 'selected' : ''}" data-id="${empIdStr}">
                    <div class="employee-card-inner">
                        <div class="employee-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>
                        <div class="employee-avatar">${getInitials(emp)}</div>
                        <div class="employee-details">
                            <h3>${escapeHtml(getFullName(emp))}</h3>
                            <p>${escapeHtml(emp.email || 'No email')}</p>
                        </div>
                        ${badge}
                    </div>
                </div>`;
            }).join('');
            
            // Add click handlers
            container.querySelectorAll('.employee-card').forEach(card => {
                card.addEventListener('click', () => toggleEmployee(card.dataset.id));
            });
            
            updateSelectedCount();
        }
        
        function toggleEmployee(empId) {
            const id = String(empId);
            if (selectedEmployeeIds.has(id)) {
                selectedEmployeeIds.delete(id);
            } else {
                selectedEmployeeIds.add(id);
            }
            renderEmployeeList();
            updateRecipientsDisplay();
            updatePreview();
            checkCanSend();
            
            // Update variables for single selection
            if (selectedEmployeeIds.size === 1) {
                const emp = employees.find(e => String(e.id) === [...selectedEmployeeIds][0]);
                if (emp) {
                    variableValues['first_name'] = emp.firstName || '';
                    variableValues['last_name'] = emp.lastName || '';
                    variableValues['supervisor_name'] = emp.supervisor || '';
                    
                    // Auto-calculate compliance dates
                    populateComplianceDates(emp);
                }
            }
            extractVariables();
        }
        
        // Helper: Populate auto-calculated compliance date variables
        function populateComplianceDates(emp) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // HCA Expiration - from HCA Tracker or calculated
            const hcaMatch = findHCATrackerMatch(emp.firstName, emp.lastName);
            let hcaExpDate = null;
            if (hcaMatch && hcaMatch.expirationDate) {
                hcaExpDate = new Date(hcaMatch.expirationDate);
                variableValues['hca_expiration_date'] = formatDateForDisplay(hcaExpDate);
            } else if (emp.hcaDate) {
                hcaExpDate = new Date(emp.hcaDate);
                hcaExpDate.setFullYear(hcaExpDate.getFullYear() + 2);
                variableValues['hca_expiration_date'] = formatDateForDisplay(hcaExpDate);
            } else {
                variableValues['hca_expiration_date'] = 'N/A';
            }
            
            if (hcaExpDate && !isNaN(hcaExpDate.getTime())) {
                const daysUntilHCA = Math.ceil((hcaExpDate - today) / (1000 * 60 * 60 * 24));
                variableValues['days_until_hca_expiration'] = daysUntilHCA > 0 ? daysUntilHCA + ' days' : (daysUntilHCA === 0 ? 'Today' : Math.abs(daysUntilHCA) + ' days overdue');
            } else {
                variableValues['days_until_hca_expiration'] = 'N/A';
            }
            
            // TB Due Date - tbDate + 2 years
            if (emp.tbDate) {
                const tbDueDate = new Date(emp.tbDate);
                tbDueDate.setFullYear(tbDueDate.getFullYear() + 2);
                variableValues['tb_due_date'] = formatDateForDisplay(tbDueDate);
                
                const daysUntilTB = Math.ceil((tbDueDate - today) / (1000 * 60 * 60 * 24));
                variableValues['days_until_tb_due'] = daysUntilTB > 0 ? daysUntilTB + ' days' : (daysUntilTB === 0 ? 'Today' : Math.abs(daysUntilTB) + ' days overdue');
            } else {
                variableValues['tb_due_date'] = 'N/A';
                variableValues['days_until_tb_due'] = 'N/A';
            }
            
            // Training Due Date - trainingDate + 1 year
            if (emp.trainingDate) {
                const trainingDueDate = new Date(emp.trainingDate);
                trainingDueDate.setFullYear(trainingDueDate.getFullYear() + 1);
                variableValues['training_due_date'] = formatDateForDisplay(trainingDueDate);
                
                const daysUntilTraining = Math.ceil((trainingDueDate - today) / (1000 * 60 * 60 * 24));
                variableValues['days_until_training_due'] = daysUntilTraining > 0 ? daysUntilTraining + ' days' : (daysUntilTraining === 0 ? 'Today' : Math.abs(daysUntilTraining) + ' days overdue');
            } else {
                variableValues['training_due_date'] = 'N/A';
                variableValues['days_until_training_due'] = 'N/A';
            }
        }
        
        // Helper: Format date for display (MM/DD/YYYY)
        function formatDateForDisplay(date) {
            if (!date || isNaN(date.getTime())) return 'N/A';
            return (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
        }
        
        function selectAllEmployees() {
            const search = (document.getElementById('employeeSearch')?.value || '').toLowerCase().trim();
            let filtered = employees;
            if (search) {
                filtered = employees.filter(e => {
                    const name = getFullName(e).toLowerCase();
                    return name.includes(search) || (e.email || '').toLowerCase().includes(search) || (e.department || '').toLowerCase().includes(search);
                });
            }
            filtered.forEach(e => selectedEmployeeIds.add(String(e.id)));
            renderEmployeeList();
            updateRecipientsDisplay();
            updatePreview();
            checkCanSend();
        }
        
        function clearEmployeeSelection() {
            selectedEmployeeIds.clear();
            renderEmployeeList();
            updateRecipientsDisplay();
            updatePreview();
            checkCanSend();
        }
        
        function removeRecipient(empId) {
            selectedEmployeeIds.delete(String(empId));
            renderEmployeeList();
            updateRecipientsDisplay();
            updatePreview();
            checkCanSend();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedEmployeeIds.size;
        }
        
        function updateRecipientsDisplay() {
            const display = document.getElementById('recipientsDisplay');
            const list = document.getElementById('recipientsList');
            const count = document.getElementById('recipientCount');
            
            if (selectedEmployeeIds.size === 0) {
                display.style.display = 'none';
                return;
            }
            
            display.style.display = 'block';
            count.textContent = selectedEmployeeIds.size;
            
            const selected = employees.filter(e => selectedEmployeeIds.has(String(e.id)));
            list.innerHTML = selected.map(emp => 
                `<div class="recipient-tag">${escapeHtml(getFullName(emp))}<span class="remove-recipient" onclick="event.stopPropagation(); removeRecipient('${emp.id}')">×</span></div>`
            ).join('');
        }
        
        // ============================================
        // COMPOSE - TEMPLATES
        // ============================================
        function renderTemplateList() {
            const container = document.getElementById('templateList');
            const cat = document.getElementById('templateCategory')?.value || '';
            const filtered = templates.filter(t => !cat || t.category === cat);
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg><h3>No Templates</h3><p>Create templates first</p></div>`;
                return;
            }
            
            container.innerHTML = filtered.map(t => {
                const isSelected = selectedTemplate && selectedTemplate.id === t.id;
                const preview = (t.body || '').substring(0, 60) + ((t.body || '').length > 60 ? '...' : '');
                return `<div class="template-card ${isSelected ? 'selected' : ''}" data-id="${t.id}">
                    <div class="template-header"><div class="template-name">${escapeHtml(t.name)}</div><div class="template-category">${t.category}</div></div>
                    <div class="template-preview">${escapeHtml(preview)}</div>
                </div>`;
            }).join('');
            
            container.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', () => selectTemplate(card.dataset.id));
            });
        }
        
        function selectTemplate(tplId) {
            selectedTemplate = templates.find(t => t.id === tplId);
            renderTemplateList();
            extractVariables();
            updatePreview();
            checkCanSend();
        }
        
        // ============================================
        // COMPOSE - VARIABLES & PREVIEW
        // ============================================
        function extractVariables() {
            const panel = document.getElementById('variablesPanel');
            const inputs = document.getElementById('variableInputs');
            
            if (!selectedTemplate) { panel.style.display = 'none'; return; }
            
            const text = (selectedTemplate.subject || '') + ' ' + (selectedTemplate.body || '');
            const matches = [...text.matchAll(/\{\{(\w+)\}\}/g)];
            const vars = [...new Set(matches.map(m => m[1]))];
            
            if (vars.length === 0) { panel.style.display = 'none'; return; }
            
            // Set defaults
            variableValues['date'] = variableValues['date'] || new Date().toLocaleDateString();
            if (selectedEmployeeIds.size === 1) {
                const emp = employees.find(e => String(e.id) === [...selectedEmployeeIds][0]);
                if (emp) {
                    variableValues['first_name'] = emp.firstName || '';
                    variableValues['last_name'] = emp.lastName || '';
                    variableValues['supervisor_name'] = emp.supervisor || '';
                }
            }
            
            panel.style.display = 'block';
            inputs.innerHTML = vars.map(v => {
                const val = variableValues[v] || '';
                const isAuto = (v === 'first_name' || v === 'last_name') && selectedEmployeeIds.size > 1;
                return `<div class="variable-input">
                    <label>{{${v}}}</label>
                    <input type="text" value="${escapeHtml(val)}" ${isAuto ? 'disabled placeholder="Auto per employee"' : ''} oninput="updateVariable('${v}', this.value)">
                </div>`;
            }).join('');
        }
        
        function updateVariable(name, value) { variableValues[name] = value; updatePreview(); }
        
        function replaceVars(text, empOverride = null) {
            // Build complete variable values including auto-calculated compliance dates
            let vars = { ...variableValues };
            
            if (empOverride) {
                vars['first_name'] = empOverride.firstName || '';
                vars['last_name'] = empOverride.lastName || '';
                vars['supervisor_name'] = empOverride.supervisor || vars['supervisor_name'] || '';
                
                // Calculate compliance dates for this specific employee
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // HCA Expiration
                const hcaMatch = findHCATrackerMatch(empOverride.firstName, empOverride.lastName);
                let hcaExpDate = null;
                if (hcaMatch && hcaMatch.expirationDate) {
                    hcaExpDate = new Date(hcaMatch.expirationDate);
                    vars['hca_expiration_date'] = formatDateForDisplay(hcaExpDate);
                } else if (empOverride.hcaDate) {
                    hcaExpDate = new Date(empOverride.hcaDate);
                    hcaExpDate.setFullYear(hcaExpDate.getFullYear() + 2);
                    vars['hca_expiration_date'] = formatDateForDisplay(hcaExpDate);
                } else {
                    vars['hca_expiration_date'] = 'N/A';
                }
                
                if (hcaExpDate && !isNaN(hcaExpDate.getTime())) {
                    const daysUntilHCA = Math.ceil((hcaExpDate - today) / (1000 * 60 * 60 * 24));
                    vars['days_until_hca_expiration'] = daysUntilHCA > 0 ? daysUntilHCA + ' days' : (daysUntilHCA === 0 ? 'Today' : Math.abs(daysUntilHCA) + ' days overdue');
                } else {
                    vars['days_until_hca_expiration'] = 'N/A';
                }
                
                // TB Due Date
                if (empOverride.tbDate) {
                    const tbDueDate = new Date(empOverride.tbDate);
                    tbDueDate.setFullYear(tbDueDate.getFullYear() + 2);
                    vars['tb_due_date'] = formatDateForDisplay(tbDueDate);
                    const daysUntilTB = Math.ceil((tbDueDate - today) / (1000 * 60 * 60 * 24));
                    vars['days_until_tb_due'] = daysUntilTB > 0 ? daysUntilTB + ' days' : (daysUntilTB === 0 ? 'Today' : Math.abs(daysUntilTB) + ' days overdue');
                } else {
                    vars['tb_due_date'] = 'N/A';
                    vars['days_until_tb_due'] = 'N/A';
                }
                
                // Training Due Date
                if (empOverride.trainingDate) {
                    const trainingDueDate = new Date(empOverride.trainingDate);
                    trainingDueDate.setFullYear(trainingDueDate.getFullYear() + 1);
                    vars['training_due_date'] = formatDateForDisplay(trainingDueDate);
                    const daysUntilTraining = Math.ceil((trainingDueDate - today) / (1000 * 60 * 60 * 24));
                    vars['days_until_training_due'] = daysUntilTraining > 0 ? daysUntilTraining + ' days' : (daysUntilTraining === 0 ? 'Today' : Math.abs(daysUntilTraining) + ' days overdue');
                } else {
                    vars['training_due_date'] = 'N/A';
                    vars['days_until_training_due'] = 'N/A';
                }
            }
            
            return text.replace(/\{\{(\w+)\}\}/g, (match, v) => {
                return vars[v] !== undefined ? vars[v] : match;
            });
        }
        
        function updatePreview() {
            const toEl = document.getElementById('previewTo');
            const fromEl = document.getElementById('previewFrom');
            const subjEl = document.getElementById('previewSubject');
            const bodyEl = document.getElementById('previewBody');
            
            fromEl.textContent = settings.defaultAlias || 'hr@alice.care';
            
            if (testMode) {
                toEl.textContent = (document.getElementById('testEmailAddress').value || 'test@example.com') + ' (Test)';
            } else if (selectedEmployeeIds.size === 0) {
                toEl.textContent = 'Select employee(s)';
            } else if (selectedEmployeeIds.size === 1) {
                const emp = employees.find(e => String(e.id) === [...selectedEmployeeIds][0]);
                toEl.textContent = emp ? emp.email : 'Unknown';
            } else {
                toEl.textContent = selectedEmployeeIds.size + ' employees';
            }
            
            if (selectedTemplate) {
                const emp = selectedEmployeeIds.size === 1 ? employees.find(e => String(e.id) === [...selectedEmployeeIds][0]) : null;
                subjEl.textContent = replaceVars(selectedTemplate.subject || '', emp);
                // Render HTML content in preview
                bodyEl.innerHTML = replaceVars(selectedTemplate.body || '', emp);
            } else {
                subjEl.textContent = 'Select a template';
                bodyEl.innerHTML = 'Select employee(s) and a template to preview the email.';
            }
        }
        
        function checkCanSend() {
            const can = selectedEmployeeIds.size > 0 && selectedTemplate;
            document.getElementById('sendBtn').disabled = !can;
            document.getElementById('sendBtnText').textContent = selectedEmployeeIds.size > 1 ? `Send to ${selectedEmployeeIds.size} Employees` : 'Send Email';
        }
        
        function resetCompose() {
            selectedEmployeeIds.clear();
            selectedTemplate = null;
            variableValues = {};
            document.getElementById('employeeSearch').value = '';
            document.getElementById('templateCategory').value = '';
            document.getElementById('variablesPanel').style.display = 'none';
            document.getElementById('recipientsDisplay').style.display = 'none';
            renderEmployeeList();
            renderTemplateList();
            updatePreview();
            checkCanSend();
        }
        
        // ============================================
        // TEST MODE
        // ============================================
        function toggleTestMode() {
            testMode = !testMode;
            document.getElementById('testModeToggle').classList.toggle('active', testMode);
            document.getElementById('testModeBanner').style.display = testMode ? 'flex' : 'none';
            document.getElementById('testSendBtn').style.display = testMode ? 'inline-flex' : 'none';
            updatePreview();
        }
        
        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmailAddress').value.trim();
            if (!testEmail || !isValidEmail(testEmail)) { showToast('Enter valid test email', 'error'); return; }
            if (!selectedTemplate) { showToast('Select a template', 'error'); return; }
            
            showLoading(true, 'Sending test...');
            try {
                const data = {
                    action: 'sendEmail',
                    employeeId: 'TEST',
                    employeeName: 'Test User',
                    employeeEmail: testEmail,
                    templateId: selectedTemplate.id,
                    templateName: '[TEST] ' + selectedTemplate.name,
                    templateCategory: selectedTemplate.category,
                    warningLevel: 0,
                    subject: '[TEST] ' + replaceVars(selectedTemplate.subject || ''),
                    body: replaceVars(selectedTemplate.body || ''),
                    variables: { ...variableValues },
                    sentFrom: settings.defaultAlias || 'hr@alice.care'
                };
                
                const result = await apiCall(data, 'POST');
                if (!result.success) throw new Error(result.error);
                showToast('Test email sent!', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function sendEmails() {
            if (selectedEmployeeIds.size === 0 || !selectedTemplate) return;
            
            const selected = employees.filter(e => selectedEmployeeIds.has(String(e.id)));
            if (selected.length > 1 && !confirm(`Send to ${selected.length} employees?`)) return;
            
            showLoading(true, 'Sending...', `0 of ${selected.length}`);
            let sent = 0, failed = 0;
            
            for (const emp of selected) {
                try {
                    const data = {
                        action: 'sendEmail',
                        employeeId: emp.id,
                        employeeName: getFullName(emp),
                        employeeEmail: emp.email,
                        templateId: selectedTemplate.id,
                        templateName: selectedTemplate.name,
                        templateCategory: selectedTemplate.category,
                        warningLevel: selectedTemplate.warningLevel || 0,
                        subject: replaceVars(selectedTemplate.subject || '', emp),
                        body: replaceVars(selectedTemplate.body || '', emp),
                        variables: { ...variableValues, first_name: emp.firstName, last_name: emp.lastName },
                        sentFrom: settings.defaultAlias || 'hr@alice.care'
                    };
                    
                    const result = await apiCall(data, 'POST');
                    if (result.success) {
                        emailLogs.unshift({ ...data, id: result.data?.id, sentAt: new Date().toISOString() });
                        sent++;
                    } else {
                        failed++;
                    }
                } catch (e) {
                    failed++;
                }
                document.getElementById('loadingSubtext').textContent = `${sent} of ${selected.length}`;
            }
            
            showLoading(false);
            showToast(failed ? `${sent} sent, ${failed} failed` : `${sent} email(s) sent!`, failed ? 'warning' : 'success');
            resetCompose();
        }
        
        // ============================================
        // TEMPLATES TAB
        // ============================================
        function renderTemplatesGrid() {
            const container = document.getElementById('templatesGrid');
            if (templates.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>No Templates</h3><p>Click Add Template to create one</p></div>';
                return;
            }
            
            container.innerHTML = templates.map(t => {
                // Strip HTML for preview text
                const plainBody = (t.body || '').replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
                const preview = plainBody.substring(0, 100) + (plainBody.length > 100 ? '...' : '');
                const badge = parseInt(t.warningLevel) > 0 ? `<span class="badge badge-warning-${Math.min(parseInt(t.warningLevel), 3)}">${parseInt(t.warningLevel) >= 4 ? 'Final' : 'Level ' + t.warningLevel}</span>` : '';
                return `<div class="card">
                    <div class="card-header">
                        <div><div class="card-title">${escapeHtml(t.name)}</div><div style="margin-top: 5px;"><span class="template-category">${t.category}</span> ${badge}</div></div>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-outline" onclick="editTemplate('${t.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTemplate('${t.id}')">Delete</button>
                        </div>
                    </div>
                    <div style="font-size: 13px;"><strong>Subject:</strong> ${escapeHtml(t.subject)}</div>
                    <div style="color: #666; font-size: 13px; margin-top: 10px;">${escapeHtml(preview)}</div>
                </div>`;
            }).join('');
        }
        
        function openTemplateModal(tplId = null) {
            document.getElementById('templateModalTitle').textContent = tplId ? 'Edit Template' : 'Add Template';
            document.getElementById('editTemplateId').value = tplId || '';
            
            // Reset HTML view if active
            if (isHtmlView) {
                toggleHtmlView();
            }
            
            if (tplId) {
                const t = templates.find(x => x.id === tplId);
                if (t) {
                    document.getElementById('tplName').value = t.name || '';
                    document.getElementById('tplCategory').value = t.category || 'warning';
                    document.getElementById('tplSubject').value = t.subject || '';
                    // Convert plain text to HTML if needed (preserve line breaks)
                    let bodyContent = t.body || '';
                    if (!bodyContent.includes('<') && bodyContent.includes('\n')) {
                        bodyContent = bodyContent.replace(/\n/g, '<br>');
                    }
                    setEditorContent(bodyContent);
                    document.getElementById('tplWarningLevel').value = t.warningLevel || '0';
                }
            } else {
                document.getElementById('tplName').value = '';
                document.getElementById('tplCategory').value = 'warning';
                document.getElementById('tplSubject').value = '';
                setEditorContent('');
                document.getElementById('tplWarningLevel').value = '0';
            }
            
            // Reset custom variable input
            document.getElementById('customVariableName').value = '';
            
            // Reset last focused field and set up listeners
            lastFocusedField = document.getElementById('tplBody');
            setupVariableInsertion();
            
            document.getElementById('templateModal').classList.add('active');
            
            // Focus body field by default for immediate variable insertion
            setTimeout(() => { document.getElementById('tplBody').focus(); }, 100);
        }
        
        function editTemplate(id) { openTemplateModal(id); }
        
        // Track last focused field for variable insertion
        let lastFocusedField = null;
        
        function setupVariableInsertion() {
            const subjectField = document.getElementById('tplSubject');
            const bodyField = document.getElementById('tplBody');
            const htmlSource = document.getElementById('tplBodyHtml');
            
            subjectField.addEventListener('focus', () => { lastFocusedField = subjectField; });
            bodyField.addEventListener('focus', () => { lastFocusedField = bodyField; });
            htmlSource.addEventListener('focus', () => { lastFocusedField = htmlSource; });
        }
        
        function insertVariable(varName) {
            const variable = `{{${varName}}}`;
            insertTextAtCursor(variable);
        }
        
        function insertCustomVariable() {
            const input = document.getElementById('customVariableName');
            const varName = input.value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
            if (!varName) {
                showToast('Enter a variable name', 'warning');
                return;
            }
            insertVariable(varName);
            input.value = '';
        }
        
        function insertTextAtCursor(text) {
            // Use last focused field, default to body
            let field = lastFocusedField;
            if (!field || (field.id !== 'tplSubject' && field.id !== 'tplBody' && field.id !== 'tplBodyHtml')) {
                field = isHtmlView ? document.getElementById('tplBodyHtml') : document.getElementById('tplBody');
            }
            
            // Focus the field
            field.focus();
            
            // For contenteditable div (tplBody)
            if (field.id === 'tplBody' && field.contentEditable === 'true') {
                document.execCommand('insertText', false, text);
            } else if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                // For input/textarea (including HTML source)
                const start = field.selectionStart;
                const end = field.selectionEnd;
                const value = field.value;
                field.value = value.substring(0, start) + text + value.substring(end);
                const newPos = start + text.length;
                field.setSelectionRange(newPos, newPos);
            }
            
            // Flash effect to show insertion
            field.style.backgroundColor = '#FFF8E0';
            setTimeout(() => { field.style.backgroundColor = ''; }, 200);
            
            showToast(`Inserted ${text}`, 'success');
        }
        
        // ============================================
        // RICH TEXT EDITOR FUNCTIONS
        // ============================================
        let isHtmlView = false;
        
        function formatText(command) {
            const editor = document.getElementById('tplBody');
            editor.focus();
            document.execCommand(command, false, null);
        }
        
        function insertLink() {
            const url = prompt('Enter URL:', 'https://');
            if (url) {
                const editor = document.getElementById('tplBody');
                editor.focus();
                document.execCommand('createLink', false, url);
            }
        }
        
        function removeLink() {
            const editor = document.getElementById('tplBody');
            editor.focus();
            document.execCommand('unlink', false, null);
        }
        
        function applyTextColor(color) {
            const editor = document.getElementById('tplBody');
            editor.focus();
            document.execCommand('foreColor', false, color);
        }
        
        function applyHighlightColor(color) {
            const editor = document.getElementById('tplBody');
            editor.focus();
            document.execCommand('hiliteColor', false, color);
        }
        
        function applyHeading(tag) {
            if (!tag) return;
            const editor = document.getElementById('tplBody');
            editor.focus();
            document.execCommand('formatBlock', false, tag);
        }
        
        function toggleHtmlView() {
            const editor = document.getElementById('tplBody');
            const htmlSource = document.getElementById('tplBodyHtml');
            const toolbar = document.querySelector('.rte-toolbar');
            
            isHtmlView = !isHtmlView;
            
            if (isHtmlView) {
                // Switch to HTML view
                htmlSource.value = editor.innerHTML;
                editor.style.display = 'none';
                htmlSource.style.display = 'block';
                // Disable toolbar buttons except HTML toggle
                toolbar.querySelectorAll('.rte-btn:not(.rte-btn-text), .rte-select, .rte-color-label').forEach(btn => {
                    btn.style.opacity = '0.5';
                    btn.style.pointerEvents = 'none';
                });
            } else {
                // Switch back to rich text view
                editor.innerHTML = htmlSource.value;
                htmlSource.style.display = 'none';
                editor.style.display = 'block';
                // Re-enable toolbar buttons
                toolbar.querySelectorAll('.rte-btn:not(.rte-btn-text), .rte-select, .rte-color-label').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                });
            }
        }
        
        function getEditorContent() {
            const editor = document.getElementById('tplBody');
            const htmlSource = document.getElementById('tplBodyHtml');
            
            if (isHtmlView) {
                return htmlSource.value;
            }
            return editor.innerHTML;
        }
        
        function setEditorContent(html) {
            const editor = document.getElementById('tplBody');
            const htmlSource = document.getElementById('tplBodyHtml');
            
            editor.innerHTML = html || '';
            htmlSource.value = html || '';
        }
        
        async function saveTemplate() {
            const id = document.getElementById('editTemplateId').value;
            const name = document.getElementById('tplName').value.trim();
            const category = document.getElementById('tplCategory').value;
            const subject = document.getElementById('tplSubject').value.trim();
            const body = getEditorContent().trim();
            const warningLevel = parseInt(document.getElementById('tplWarningLevel').value);
            
            if (!name || !subject || !body) { showToast('Fill required fields', 'error'); return; }
            
            showLoading(true, 'Saving...');
            try {
                // Compress body for size check
                const compressedBody = body
                    .replace(/\r\n/g, '\n')
                    .replace(/\n\s+/g, '\n')
                    .replace(/\s+\n/g, '\n')
                    .replace(/>\s+</g, '><')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
                
                // Check if payload is too large - if so, use chunked save
                const testPayload = JSON.stringify({ action: 'updateTemplate', id, name, category, subject, body: compressedBody, warningLevel });
                const encodedSize = btoa(unescape(encodeURIComponent(testPayload))).length;
                
                if (encodedSize > 5000) {
                    // Chunked save: First save metadata, then body separately
                    showLoading(true, 'Saving template...');
                    
                    // Step 1: Save/create template with placeholder body
                    const metaData = { 
                        action: id ? 'updateTemplate' : 'addTemplate', 
                        id: id || undefined, 
                        name, 
                        category, 
                        subject, 
                        body: '[Loading...]', // Placeholder
                        warningLevel 
                    };
                    const metaResult = await apiCall(metaData, 'POST');
                    if (!metaResult.success) throw new Error(metaResult.error);
                    
                    const templateId = id || metaResult.data.id;
                    
                    // Step 2: Update body in chunks if needed
                    showLoading(true, 'Saving content...');
                    const chunkSize = 3000; // Characters per chunk
                    const chunks = [];
                    for (let i = 0; i < compressedBody.length; i += chunkSize) {
                        chunks.push(compressedBody.substring(i, i + chunkSize));
                    }
                    
                    // Send body chunks
                    for (let i = 0; i < chunks.length; i++) {
                        showLoading(true, `Saving content (${i + 1}/${chunks.length})...`);
                        const chunkData = {
                            action: 'updateTemplateBody',
                            id: templateId,
                            bodyChunk: chunks[i],
                            chunkIndex: i,
                            totalChunks: chunks.length,
                            isLast: i === chunks.length - 1
                        };
                        const chunkResult = await apiCall(chunkData, 'POST');
                        if (!chunkResult.success) throw new Error(chunkResult.error);
                    }
                    
                    // Update local state
                    if (id) {
                        const idx = templates.findIndex(t => String(t.id) === String(id));
                        if (idx !== -1) templates[idx] = { ...templates[idx], name, category, subject, body: compressedBody, warningLevel };
                    } else {
                        templates.push({ id: templateId, name, category, subject, body: compressedBody, warningLevel });
                    }
                } else {
                    // Small payload - single request
                    const data = { action: id ? 'updateTemplate' : 'addTemplate', id: id || undefined, name, category, subject, body: compressedBody, warningLevel };
                    const result = await apiCall(data, 'POST');
                    if (!result.success) throw new Error(result.error);
                    
                    if (id) {
                        const idx = templates.findIndex(t => String(t.id) === String(id));
                        if (idx !== -1) templates[idx] = { ...templates[idx], name, category, subject, body: compressedBody, warningLevel };
                    } else {
                        templates.push({ id: result.data.id, name, category, subject, body: compressedBody, warningLevel });
                    }
                }
                
                closeModal('templateModal');
                renderTemplatesGrid();
                showToast('Template saved!', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function deleteTemplate(id) {
            if (!confirm('Delete template?')) return;
            showLoading(true, 'Deleting...');
            try {
                const result = await apiCall({ action: 'deleteTemplate', id }, 'POST');
                if (!result.success) throw new Error(result.error);
                templates = templates.filter(t => t.id !== id);
                renderTemplatesGrid();
                showToast('Deleted', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ============================================
        // EMPLOYEES TAB
        // ============================================
        
        // Helper: Calculate date status for compliance dates
        function getDateStatus(dateStr, yearsValid, warningDays) {
            if (!dateStr) return { status: 'na', label: 'N/A', daysLeft: null, dueDate: null };
            
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return { status: 'na', label: 'Invalid', daysLeft: null, dueDate: null };
                
                const dueDate = new Date(date);
                dueDate.setFullYear(dueDate.getFullYear() + yearsValid);
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                dueDate.setHours(0, 0, 0, 0);
                
                const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let status = 'ok';
                if (daysLeft < 0) {
                    status = 'overdue';
                } else if (daysLeft <= Math.floor(warningDays / 2)) {
                    status = 'urgent';
                } else if (daysLeft <= warningDays) {
                    status = 'warning';
                }
                
                return { 
                    status, 
                    daysLeft, 
                    dueDate,
                    label: daysLeft < 0 ? `${Math.abs(daysLeft)}d overdue` : 
                           daysLeft === 0 ? 'Due today' :
                           daysLeft <= warningDays ? `${daysLeft}d left` : ''
                };
            } catch (e) {
                return { status: 'na', label: 'Error', daysLeft: null, dueDate: null };
            }
        }
        
        // Helper: Format date for display
        function formatDateShort(date) {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Helper: Get icon SVG for date status
        function getStatusIcon(status) {
            if (status === 'ok') return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            if (status === 'warning') return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
            if (status === 'urgent') return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
            if (status === 'overdue') return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
            return '';
        }
        
        // Helper: Render date cell with status
        function renderDateCell(dateStr, yearsValid, warningDays, showExpiration = false, showDueDateBelow = false) {
            const statusInfo = getDateStatus(dateStr, yearsValid, warningDays);
            
            if (statusInfo.status === 'na') {
                return '<span class="date-status na">N/A</span>';
            }
            
            const displayDate = showExpiration && statusInfo.dueDate ? 
                formatDateShort(statusInfo.dueDate) : 
                formatDateShort(dateStr);
            
            const icon = getStatusIcon(statusInfo.status);
            
            // Show due date below if requested, otherwise show days left label
            let labelHtml = '';
            if (showDueDateBelow && statusInfo.dueDate) {
                labelHtml = `<div class="date-sub">Due: ${formatDateShort(statusInfo.dueDate)}${statusInfo.label ? ' (' + statusInfo.label + ')' : ''}</div>`;
            } else if (statusInfo.label) {
                labelHtml = `<div class="date-sub">${statusInfo.label}</div>`;
            }
            
            return `<div class="date-cell">
                <span class="date-status ${statusInfo.status}">${icon}${displayDate}</span>
                ${labelHtml}
            </div>`;
        }
        
        function renderEmployeeDirectory() {
            const container = document.getElementById('employeeTableBody');
            const search = (document.getElementById('employeeDirectorySearch')?.value || '').toLowerCase().trim();
            
            // Get filter values
            const filterPosition = document.getElementById('filterPosition')?.value || '';
            const filterMismatch = document.getElementById('filterMismatch')?.value || '';
            const filterHCA = document.getElementById('filterHCA')?.value || '';
            const filterTB = document.getElementById('filterTB')?.value || '';
            const filterTraining = document.getElementById('filterTraining')?.value || '';
            
            // Get warning day thresholds from automation settings (with safe defaults if not yet loaded)
            const autoSettings = typeof automationSettings !== 'undefined' ? automationSettings : {};
            const hcaDays = autoSettings.hcaReminder?.daysBefore || 60;
            const tbDays = autoSettings.tbReminder?.daysBefore || 30;
            const trainingDays = autoSettings.trainingReminder?.daysBefore || 30;
            
            // Helper to get HCA status for an employee
            function getEmployeeHCAStatus(emp) {
                const hcaMatch = findHCATrackerMatch(emp.firstName, emp.lastName);
                if (hcaMatch && hcaMatch.expirationDate) {
                    return getHCADateStatus(hcaMatch.expirationDate, hcaDays);
                } else if (emp.hcaDate) {
                    return getDateStatus(emp.hcaDate, 2, hcaDays);
                }
                return { status: 'na' };
            }
            
            // Helper to get HCA date status (for direct expiration date)
            function getHCADateStatus(expirationDateStr, warningDays) {
                if (!expirationDateStr) return { status: 'na' };
                try {
                    const expDate = new Date(expirationDateStr);
                    if (isNaN(expDate.getTime())) return { status: 'na' };
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    expDate.setHours(0, 0, 0, 0);
                    const daysLeft = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    let status = 'ok';
                    if (daysLeft < 0) status = 'overdue';
                    else if (daysLeft <= Math.floor(warningDays / 2)) status = 'urgent';
                    else if (daysLeft <= warningDays) status = 'warning';
                    return { status, daysLeft };
                } catch (e) {
                    return { status: 'na' };
                }
            }
            
            let filtered = employees;
            
            // Apply text search filter
            if (search) {
                filtered = filtered.filter(e => {
                    const name = getFullName(e).toLowerCase();
                    return name.includes(search) || (e.email || '').toLowerCase().includes(search) || (e.department || '').toLowerCase().includes(search);
                });
            }
            
            // Apply position filter
            if (filterPosition) {
                filtered = filtered.filter(e => {
                    const position = (e.position || '').toLowerCase();
                    if (filterPosition === 'HCA') {
                        return position.includes('hca') || position.includes('home care aide');
                    } else if (filterPosition === 'other') {
                        return !position.includes('hca') && !position.includes('home care aide');
                    }
                    return true;
                });
            }
            
            // Apply mismatch filter
            if (filterMismatch && hcaTrackerData.length > 0) {
                if (filterMismatch === 'hca-only') {
                    // For HCA-only, clear the table and show alert
                    const hcaOnly = getHCAOnlyEmployees();
                    if (hcaOnly.length > 0) {
                        container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px;">
                            <div style="color: #0C5460;">
                                <strong>${hcaOnly.length} employee${hcaOnly.length > 1 ? 's' : ''}</strong> found in HCA Tracker but not in Email Manager.<br>
                                <span style="font-size: 13px;">See the blue alert above for details.</span>
                            </div>
                        </td></tr>`;
                        updateHCAOnlyAlert();
                        // Show the details automatically
                        document.getElementById('hcaOnlyDetails').style.display = 'block';
                        const btn = document.querySelector('#hcaOnlyAlert button');
                        if (btn) btn.textContent = 'Hide Details';
                        return;
                    } else {
                        container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px;">All HCA Tracker employees are in this list</td></tr>`;
                        return;
                    }
                }
                filtered = filtered.filter(e => {
                    const hasMatch = !!findHCATrackerMatch(e.firstName, e.lastName);
                    if (filterMismatch === 'mismatch') return !hasMatch;
                    if (filterMismatch === 'matched') return hasMatch;
                    return true;
                });
            }
            
            // Apply HCA status filter
            if (filterHCA) {
                filtered = filtered.filter(e => {
                    const hcaStatus = getEmployeeHCAStatus(e);
                    return hcaStatus.status === filterHCA;
                });
            }
            
            // Apply TB status filter
            if (filterTB) {
                filtered = filtered.filter(e => {
                    // Handle X-Ray filter
                    if (filterTB === 'xray') {
                        return e.tbXray === true || e.tbXray === 'true';
                    }
                    // If employee has X-Ray, they don't match other TB statuses
                    if (e.tbXray === true || e.tbXray === 'true') {
                        return false;
                    }
                    const tbStatus = getDateStatus(e.tbDate, 2, tbDays);
                    return tbStatus.status === filterTB;
                });
            }
            
            // Apply Training status filter
            if (filterTraining) {
                filtered = filtered.filter(e => {
                    const trainingStatus = getDateStatus(e.trainingDate, 1, trainingDays);
                    return trainingStatus.status === filterTraining;
                });
            }
            
            if (filtered.length === 0) {
                const hasFilters = search || filterPosition || filterMismatch || filterHCA || filterTB || filterTraining;
                container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px;">${employees.length ? (hasFilters ? 'No employees match filters' : 'No results') : 'No employees yet'}</td></tr>`;
                return;
            }
            
            container.innerHTML = filtered.map(emp => {
                const level = getEmployeeWarningLevel(emp.id);
                let badge = '<span class="badge badge-success">Clear</span>';
                if (level === 1) badge = '<span class="badge badge-warning-1">Level 1</span>';
                else if (level === 2) badge = '<span class="badge badge-warning-2">Level 2</span>';
                else if (level === 3) badge = '<span class="badge badge-warning-3">Level 3</span>';
                else if (level >= 4) badge = '<span class="badge badge-final">Final</span>';
                
                // Look up HCA data from HCA Tracker
                const hcaMatch = findHCATrackerMatch(emp.firstName, emp.lastName);
                const hasHCASync = hcaTrackerData.length > 0;
                const hcaMismatch = hasHCASync && !hcaMatch;
                
                // Use HCA Tracker expiration if available, otherwise use local hcaDate
                // Note: HCA Tracker stores expiration directly, local hcaDate needs +2 years
                let hcaCell;
                if (hcaMatch && hcaMatch.expirationDate) {
                    // HCA Tracker provides expiration date directly
                    hcaCell = renderHCADateCell(hcaMatch.expirationDate, hcaDays);
                } else if (emp.hcaDate) {
                    // Fallback to local date (add 2 years for expiration)
                    hcaCell = renderDateCell(emp.hcaDate, 2, hcaDays, true);
                } else {
                    hcaCell = '<span class="date-status na">N/A</span>';
                }
                
                // TB: Shows date taken, warns when approaching 2-year renewal (unless X-Ray)
                let tbCell;
                if (emp.tbXray === true || emp.tbXray === 'true') {
                    // X-Ray - always valid, no renewal required
                    tbCell = `<div class="date-cell">
                        <span class="date-status ok"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>X-Ray</span>
                    </div>`;
                } else {
                    tbCell = renderDateCell(emp.tbDate, 2, tbDays, false, true);
                }
                
                // Training: Shows last training, warns when approaching 1-year renewal
                const trainingCell = renderDateCell(emp.trainingDate, 1, trainingDays, false, true);
                
                // Row class for mismatch highlighting
                const rowClass = hcaMismatch ? 'hca-mismatch' : '';
                const nameClass = hcaMismatch ? 'employee-name' : '';
                const mismatchTitle = hcaMismatch ? 'title="Not found in HCA Tracker - verify name spelling"' : '';
                
                return `<tr class="${rowClass}">
                    <td><div style="display: flex; align-items: center; gap: 10px;">
                        <div class="employee-avatar" style="width: 36px; height: 36px; font-size: 14px;">${getInitials(emp)}</div>
                        <div><div style="font-weight: 600;" class="${nameClass}" ${mismatchTitle}>${escapeHtml(getFullName(emp))}</div><div style="font-size: 12px; color: #666;">${escapeHtml(emp.email || '')}</div></div>
                    </div></td>
                    <td>${escapeHtml(emp.position || 'N/A')}</td>
                    <td>${badge}</td>
                    <td>${hcaCell}</td>
                    <td>${tbCell}</td>
                    <td>${trainingCell}</td>
                    <td><div class="action-buttons">
                        <button class="btn btn-small btn-outline" onclick="editEmployee('${emp.id}')">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteEmployee('${emp.id}')">Delete</button>
                    </div></td>
                </tr>`;
            }).join('');
            
            // Update HCA sync status indicator
            updateHCASyncStatus();
            
            // Update HCA Only alert
            updateHCAOnlyAlert();
        }
        
        // Helper: Find matching HCA Tracker entry by name
        function findHCATrackerMatch(firstName, lastName) {
            if (!hcaTrackerData.length) return null;
            
            const empFirst = (firstName || '').toLowerCase().trim();
            const empLast = (lastName || '').toLowerCase().trim();
            
            return hcaTrackerData.find(hca => {
                const hcaFirst = (hca.firstName || '').toLowerCase().trim();
                const hcaLast = (hca.lastName || '').toLowerCase().trim();
                return hcaFirst === empFirst && hcaLast === empLast;
            });
        }
        
        // Helper: Render HCA date cell with direct expiration date (from HCA Tracker)
        function renderHCADateCell(expirationDateStr, warningDays) {
            if (!expirationDateStr) return '<span class="date-status na">N/A</span>';
            
            try {
                const expDate = new Date(expirationDateStr);
                if (isNaN(expDate.getTime())) return '<span class="date-status na">Invalid</span>';
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                expDate.setHours(0, 0, 0, 0);
                
                const daysLeft = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                
                let status = 'ok';
                if (daysLeft < 0) {
                    status = 'overdue';
                } else if (daysLeft <= Math.floor(warningDays / 2)) {
                    status = 'urgent';
                } else if (daysLeft <= warningDays) {
                    status = 'warning';
                }
                
                const label = daysLeft < 0 ? `${Math.abs(daysLeft)}d overdue` : 
                              daysLeft === 0 ? 'Due today' :
                              daysLeft <= warningDays ? `${daysLeft}d left` : '';
                
                const icon = getStatusIcon(status);
                const displayDate = formatDateShort(expDate);
                const labelHtml = label ? `<div class="date-sub">${label}</div>` : '';
                
                return `<div class="date-cell">
                    <a href="${HCA_TRACKER_URL}" target="_blank" class="hca-link date-status ${status}" title="Click to open HCA Tracker">${icon}${displayDate}</a>
                    ${labelHtml}
                </div>`;
            } catch (e) {
                return '<span class="date-status na">Error</span>';
            }
        }
        
        // Update HCA sync status indicator
        function updateHCASyncStatus() {
            const infoEl = document.getElementById('hcaSyncInfo');
            const statusEl = document.getElementById('hcaSyncStatus');
            
            if (!infoEl || !statusEl) return;
            
            if (hcaTrackerData.length > 0 && hcaLastSync) {
                infoEl.style.display = 'flex';
                const mismatchCount = countHCAMismatches();
                if (mismatchCount > 0) {
                    statusEl.textContent = `${mismatchCount} name mismatch${mismatchCount > 1 ? 'es' : ''}`;
                    infoEl.classList.add('stale');
                } else {
                    statusEl.textContent = `HCA synced (${hcaTrackerData.length})`;
                    infoEl.classList.remove('stale');
                }
            } else {
                infoEl.style.display = 'none';
            }
        }
        
        // Clear all employee directory filters (reset to defaults)
        function clearEmployeeFilters() {
            document.getElementById('employeeDirectorySearch').value = '';
            document.getElementById('filterPosition').value = 'HCA'; // Default to HCA
            document.getElementById('filterMismatch').value = '';
            document.getElementById('filterHCA').value = '';
            document.getElementById('filterTB').value = '';
            document.getElementById('filterTraining').value = '';
            renderEmployeeDirectory();
        }
        
        // Count employees not found in HCA Tracker
        function countHCAMismatches() {
            if (!hcaTrackerData.length) return 0;
            return employees.filter(emp => !findHCATrackerMatch(emp.firstName, emp.lastName)).length;
        }
        
        // Get HCA Tracker entries not found in Email Manager
        function getHCAOnlyEmployees() {
            if (!hcaTrackerData.length) return [];
            return hcaTrackerData.filter(hca => {
                const hcaFirst = (hca.firstName || '').toLowerCase().trim();
                const hcaLast = (hca.lastName || '').toLowerCase().trim();
                return !employees.find(emp => {
                    const empFirst = (emp.firstName || '').toLowerCase().trim();
                    const empLast = (emp.lastName || '').toLowerCase().trim();
                    return empFirst === hcaFirst && empLast === hcaLast;
                });
            });
        }
        
        // Count HCA-only employees
        function countHCAOnlyEmployees() {
            return getHCAOnlyEmployees().length;
        }
        
        // Update HCA Only alert display
        function updateHCAOnlyAlert() {
            const alertEl = document.getElementById('hcaOnlyAlert');
            const countEl = document.getElementById('hcaOnlyCount');
            const listEl = document.getElementById('hcaOnlyList');
            
            if (!alertEl) return;
            
            const hcaOnly = getHCAOnlyEmployees();
            
            if (hcaOnly.length > 0) {
                alertEl.style.display = 'block';
                countEl.textContent = hcaOnly.length;
                
                // Render the list
                listEl.innerHTML = hcaOnly.map(hca => {
                    const initials = ((hca.firstName || '').charAt(0) + (hca.lastName || '').charAt(0)).toUpperCase();
                    const name = `${hca.firstName || ''} ${hca.lastName || ''}`.trim();
                    const exp = hca.expirationDate ? `Exp: ${formatDateShort(hca.expirationDate)}` : 'No expiration';
                    return `<div class="hca-only-item">
                        <div class="hca-avatar">${initials}</div>
                        <div class="hca-info">
                            <div class="hca-name">${escapeHtml(name)}</div>
                            <div class="hca-exp">${exp}</div>
                            <div class="hca-note">In HCA Tracker, not in Email Manager</div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                alertEl.style.display = 'none';
            }
        }
        
        // Toggle HCA Only details visibility
        function toggleHCAOnlyDetails() {
            const detailsEl = document.getElementById('hcaOnlyDetails');
            const btn = document.querySelector('#hcaOnlyAlert button');
            
            if (detailsEl.style.display === 'none') {
                detailsEl.style.display = 'block';
                btn.textContent = 'Hide Details';
            } else {
                detailsEl.style.display = 'none';
                btn.textContent = 'Show Details';
            }
        }
        
        // Sync HCA data from HCA Tracker Google Sheet
        async function syncHCAData() {
            showLoading(true, 'Syncing HCA data...', 'Fetching from HCA Tracker');
            
            try {
                const result = await apiCall({ action: 'getHCATrackerData' }, 'POST');
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch HCA data');
                }
                
                hcaTrackerData = result.data || [];
                hcaLastSync = new Date();
                
                // Re-render the employee directory with HCA data
                renderEmployeeDirectory();
                
                const mismatchCount = countHCAMismatches();
                if (mismatchCount > 0) {
                    showToast(`HCA synced: ${hcaTrackerData.length} records. ${mismatchCount} employee${mismatchCount > 1 ? 's' : ''} not found in HCA Tracker.`, 'warning');
                } else {
                    showToast(`HCA synced: ${hcaTrackerData.length} records`, 'success');
                }
                
            } catch (e) {
                console.error('HCA Sync error:', e);
                showToast('HCA sync failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function updateStats() {
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentEmails = emailLogs.filter(l => new Date(l.sentAt) >= thirtyDaysAgo);
            let warnings = 0, final = 0;
            employees.forEach(e => {
                const level = getEmployeeWarningLevel(e.id);
                if (level > 0 && level < 4) warnings++;
                if (level >= 4) final++;
            });
            
            document.getElementById('statTotal').textContent = employees.length;
            document.getElementById('statWarnings').textContent = warnings;
            document.getElementById('statFinal').textContent = final;
            document.getElementById('statEmails').textContent = recentEmails.length;
        }
        
        function openEmployeeModal(empId = null) {
            document.getElementById('employeeModalTitle').textContent = empId ? 'Edit Employee' : 'Add Employee';
            document.getElementById('editEmployeeId').value = empId || '';
            
            // Clear fields first
            document.getElementById('empFirstName').value = '';
            document.getElementById('empLastName').value = '';
            document.getElementById('empEmail').value = '';
            document.getElementById('empStatus').value = 'active';
            document.getElementById('empDepartment').value = '';
            document.getElementById('empPosition').value = '';
            document.getElementById('empSupervisor').value = '';
            document.getElementById('empHireDate').value = '';
            document.getElementById('empBirthDate').value = '';
            document.getElementById('empTBDate').value = '';
            document.getElementById('empTBXray').checked = false;
            document.getElementById('empTrainingDate').value = '';
            document.getElementById('empHCADate').value = '';
            
            if (empId) {
                // Convert to string for comparison (handles both number and string IDs)
                const searchId = String(empId);
                const emp = employees.find(e => String(e.id) === searchId);
                console.log('Looking for employee ID:', empId, '(as string:', searchId, ')');
                console.log('Found employee:', emp);
                
                if (emp) {
                    // Handle both old structure (name) and new structure (firstName/lastName)
                    let firstName = emp.firstName || '';
                    let lastName = emp.lastName || '';
                    
                    // If using old 'name' field, try to split it
                    if (!firstName && !lastName && emp.name) {
                        const parts = String(emp.name).trim().split(/\s+/);
                        firstName = parts[0] || '';
                        lastName = parts.slice(1).join(' ') || '';
                    }
                    
                    document.getElementById('empFirstName').value = firstName;
                    document.getElementById('empLastName').value = lastName;
                    document.getElementById('empEmail').value = emp.email || '';
                    document.getElementById('empStatus').value = emp.status || 'active';
                    document.getElementById('empDepartment').value = emp.department || '';
                    document.getElementById('empPosition').value = emp.position || '';
                    document.getElementById('empSupervisor').value = emp.supervisor || '';
                    
                    // Date fields - format for date input (YYYY-MM-DD)
                    document.getElementById('empHireDate').value = formatDateForInput(emp.hireDate);
                    document.getElementById('empBirthDate').value = formatDateForInput(emp.birthDate);
                    document.getElementById('empTBDate').value = formatDateForInput(emp.tbDate);
                    document.getElementById('empTBXray').checked = emp.tbXray === true || emp.tbXray === 'true';
                    document.getElementById('empTrainingDate').value = formatDateForInput(emp.trainingDate);
                    document.getElementById('empHCADate').value = formatDateForInput(emp.hcaDate);
                    
                    console.log('Populated fields:', { firstName, lastName, email: emp.email, status: emp.status });
                } else {
                    console.error('Employee not found in local array!');
                    console.log('Available IDs:', employees.map(e => e.id));
                    showToast('Employee not found - try refreshing', 'error');
                }
            }
            document.getElementById('employeeModal').classList.add('active');
        }
        
        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return '';
                return d.toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        }
        
        function editEmployee(id) { 
            console.log('Edit button clicked for ID:', id);
            openEmployeeModal(id); 
        }
        
        async function saveEmployee() {
            const id = document.getElementById('editEmployeeId').value;
            const firstName = document.getElementById('empFirstName').value.trim();
            const lastName = document.getElementById('empLastName').value.trim();
            const email = document.getElementById('empEmail').value.trim();
            const status = document.getElementById('empStatus').value;
            const department = document.getElementById('empDepartment').value.trim();
            const position = document.getElementById('empPosition').value.trim();
            const supervisor = document.getElementById('empSupervisor').value.trim();
            const hireDate = document.getElementById('empHireDate').value || null;
            const birthDate = document.getElementById('empBirthDate').value || null;
            const tbDate = document.getElementById('empTBDate').value || null;
            const tbXray = document.getElementById('empTBXray').checked;
            const trainingDate = document.getElementById('empTrainingDate').value || null;
            const hcaDate = document.getElementById('empHCADate').value || null;
            
            if (!firstName || !lastName || !email) { showToast('First name, last name, and email required', 'error'); return; }
            if (!isValidEmail(email)) { showToast('Invalid email', 'error'); return; }
            
            // Check for duplicate email - use String() for ID comparison, handle null emails
            const dup = employees.find(e => e.email && e.email.toLowerCase() === email.toLowerCase() && String(e.id) !== String(id));
            if (dup) { showToast('Email already exists for another employee', 'error'); return; }
            
            showLoading(true, 'Saving...');
            try {
                const data = { 
                    action: id ? 'updateEmployee' : 'addEmployee', 
                    id: id || undefined, 
                    firstName, lastName, email, status, department, position, supervisor,
                    hireDate, birthDate, tbDate, tbXray, trainingDate, hcaDate
                };
                const result = await apiCall(data, 'POST');
                if (!result.success) throw new Error(result.error);
                
                const empData = { firstName, lastName, email, status, department, position, supervisor, hireDate, birthDate, tbDate, tbXray, trainingDate, hcaDate };
                if (id) {
                    const idx = employees.findIndex(e => String(e.id) === String(id));
                    if (idx !== -1) employees[idx] = { ...employees[idx], ...empData };
                } else {
                    employees.push({ id: result.data.id, ...empData });
                }
                
                closeModal('employeeModal');
                renderEmployeeDirectory();
                updateStats();
                showToast('Employee saved!', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function deleteEmployee(id) {
            if (!confirm('Delete employee?')) return;
            showLoading(true, 'Deleting...');
            try {
                const result = await apiCall({ action: 'deleteEmployee', id }, 'POST');
                if (!result.success) throw new Error(result.error);
                employees = employees.filter(e => e.id !== id);
                renderEmployeeDirectory();
                updateStats();
                showToast('Deleted', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ============================================
        // LOGS TAB
        // ============================================
        function populateLogFilters() {
            // Populate department filter
            const deptSelect = document.getElementById('logDepartmentFilter');
            const departments = [...new Set(employees.map(e => e.department).filter(Boolean))].sort();
            deptSelect.innerHTML = '<option value="">All Departments</option>' + 
                departments.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');
            
            // Populate template filter
            const tplSelect = document.getElementById('logTemplateFilter');
            tplSelect.innerHTML = '<option value="">All Templates</option>' + 
                templates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
        }
        
        function clearLogFilters() {
            document.getElementById('logSearchInput').value = '';
            document.getElementById('logDepartmentFilter').value = '';
            document.getElementById('logTemplateFilter').value = '';
            document.getElementById('logCategoryFilter').value = '';
            document.getElementById('logDateFilter').value = '30';
            renderLogs();
        }
        
        function renderLogs() {
            const container = document.getElementById('logsTableBody');
            const searchInput = document.getElementById('logSearchInput').value.toLowerCase().trim();
            const deptFilter = document.getElementById('logDepartmentFilter').value;
            const tplFilter = document.getElementById('logTemplateFilter').value;
            const catFilter = document.getElementById('logCategoryFilter').value;
            const dateFilter = document.getElementById('logDateFilter').value;
            
            let filtered = emailLogs;
            
            // Search filter (name or email)
            if (searchInput) {
                filtered = filtered.filter(l => {
                    const name = (l.employeeName || '').toLowerCase();
                    const email = (l.employeeEmail || '').toLowerCase();
                    return name.includes(searchInput) || email.includes(searchInput);
                });
            }
            
            // Department filter
            if (deptFilter) {
                filtered = filtered.filter(l => {
                    const emp = employees.find(e => String(e.id) === String(l.employeeId));
                    return emp && emp.department === deptFilter;
                });
            }
            
            // Template filter
            if (tplFilter) filtered = filtered.filter(l => String(l.templateId) === String(tplFilter));
            
            // Category filter
            if (catFilter) filtered = filtered.filter(l => l.templateCategory === catFilter);
            
            // Date filter
            if (dateFilter !== 'all') {
                const days = parseInt(dateFilter);
                const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
                filtered = filtered.filter(l => new Date(l.sentAt) >= cutoff);
            }
            
            // Sort by date descending
            filtered.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
            
            // Update results count
            const countEl = document.getElementById('logResultsCount');
            countEl.innerHTML = `<strong>${filtered.length}</strong> email${filtered.length !== 1 ? 's' : ''} found`;
            
            if (filtered.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">No emails match your filters</td></tr>';
                return;
            }
            
            container.innerHTML = filtered.map(log => {
                const emp = employees.find(e => String(e.id) === String(log.employeeId));
                const dept = emp?.department || '-';
                return `<tr>
                    <td>${formatDateTime(log.sentAt)}</td>
                    <td><div style="font-weight: 600;">${escapeHtml(log.employeeName)}</div><div style="font-size: 12px; color: #666;">${escapeHtml(log.employeeEmail)}</div></td>
                    <td>${escapeHtml(dept)}</td>
                    <td><span class="template-category">${log.templateCategory || ''}</span> ${escapeHtml(log.templateName)}</td>
                    <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(log.subject)}</td>
                    <td><button class="btn btn-small btn-outline" onclick="viewLog('${log.id}')">View</button></td>
                </tr>`;
            }).join('');
        }
        
        function viewLog(logId) {
            viewingLogId = logId;
            const log = emailLogs.find(l => l.id === logId);
            if (!log) return;
            
            document.getElementById('logModalContent').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div><label style="font-size: 11px; color: #666; text-transform: uppercase;">To</label><p style="font-weight: 600;">${escapeHtml(log.employeeName)}</p><p style="font-size: 13px; color: #666;">${escapeHtml(log.employeeEmail)}</p></div>
                    <div><label style="font-size: 11px; color: #666; text-transform: uppercase;">From</label><p>${escapeHtml(log.sentFrom)}</p></div>
                    <div><label style="font-size: 11px; color: #666; text-transform: uppercase;">Date</label><p>${formatDateTime(log.sentAt)}</p></div>
                    <div><label style="font-size: 11px; color: #666; text-transform: uppercase;">Template</label><p>${escapeHtml(log.templateName)}</p></div>
                </div>
                <div class="preview-panel">
                    <div class="preview-header">Email Content</div>
                    <div class="preview-content">
                        <div class="preview-subject">Subject: ${escapeHtml(log.subject)}</div>
                        <div class="preview-body" style="max-height: 300px; overflow-y: auto;">${log.body}</div>
                    </div>
                </div>`;
            document.getElementById('logModal').classList.add('active');
        }
        
        function resendFromLog() {
            const log = emailLogs.find(l => l.id === viewingLogId);
            if (!log) return;
            
            const emp = employees.find(e => String(e.id) === String(log.employeeId));
            const tpl = templates.find(t => t.id === log.templateId);
            
            if (emp) { selectedEmployeeIds.clear(); selectedEmployeeIds.add(String(emp.id)); }
            if (tpl) selectedTemplate = tpl;
            variableValues = log.variables || {};
            
            closeModal('logModal');
            showTab('compose');
            renderEmployeeList();
            renderTemplateList();
            extractVariables();
            updateRecipientsDisplay();
            updatePreview();
            checkCanSend();
            showToast('Loaded for resending', 'info');
        }
        
        // ============================================
        // SETTINGS TAB
        // ============================================
        function renderAliases() {
            const container = document.getElementById('aliasesList');
            const select = document.getElementById('defaultAlias');
            
            if (aliases.length === 0) {
                container.innerHTML = '<p style="color: #666;">No aliases</p>';
            } else {
                container.innerHTML = aliases.map(a => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #E5ECF3;">
                        <div><div style="font-weight: 600;">${escapeHtml(a.name)}</div><div style="font-size: 13px; color: #666;">${escapeHtml(a.email)}</div></div>
                        <button class="btn btn-small btn-danger" onclick="deleteAlias('${a.id}')">Delete</button>
                    </div>`).join('');
            }
            
            select.innerHTML = aliases.map(a => `<option value="${a.email}" ${settings.defaultAlias === a.email ? 'selected' : ''}>${escapeHtml(a.name)} (${escapeHtml(a.email)})</option>`).join('');
        }
        
        function openAliasModal() {
            document.getElementById('aliasName').value = '';
            document.getElementById('aliasEmail').value = '';
            document.getElementById('aliasModal').classList.add('active');
        }
        
        async function saveAlias() {
            const name = document.getElementById('aliasName').value.trim();
            const email = document.getElementById('aliasEmail').value.trim();
            if (!name || !email || !isValidEmail(email)) { showToast('Valid name and email required', 'error'); return; }
            if (aliases.find(a => a.email && a.email.toLowerCase() === email.toLowerCase())) { showToast('Alias exists', 'error'); return; }
            
            showLoading(true, 'Saving...');
            try {
                const result = await apiCall({ action: 'addAlias', name, email }, 'POST');
                if (!result.success) throw new Error(result.error);
                aliases.push({ id: result.data.id, name, email });
                closeModal('aliasModal');
                renderAliases();
                showToast('Alias added!', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function deleteAlias(id) {
            if (!confirm('Delete alias?')) return;
            showLoading(true, 'Deleting...');
            try {
                const result = await apiCall({ action: 'deleteAlias', id }, 'POST');
                if (!result.success) throw new Error(result.error);
                aliases = aliases.filter(a => a.id !== id);
                renderAliases();
                showToast('Deleted', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function saveDefaultAlias() {
            const value = document.getElementById('defaultAlias').value;
            showLoading(true, 'Saving...');
            try {
                const result = await apiCall({ action: 'updateSetting', key: 'defaultAlias', value }, 'POST');
                if (!result.success) throw new Error(result.error);
                settings.defaultAlias = value;
                showToast('Saved', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ============================================
        // AUTOMATION
        // ============================================
        let automationSettings = {
            hireAnniversary: { enabled: false, templateId: '' },
            birthday: { enabled: false, templateId: '' },
            tbReminder: { enabled: false, templateId: '', daysBefore: 30 },
            trainingReminder: { enabled: false, templateId: '', daysBefore: 30 },
            hcaReminder: { enabled: false, templateId: '', daysBefore: 60 }
        };
        
        function loadAutomationSettings() {
            const saved = settings.automationSettings;
            if (saved) {
                try {
                    automationSettings = typeof saved === 'string' ? JSON.parse(saved) : saved;
                } catch (e) {
                    console.error('Error parsing automation settings:', e);
                }
            }
            renderAutomationUI();
        }
        
        function renderAutomationUI() {
            // Update toggle states
            Object.keys(automationSettings).forEach(key => {
                const toggle = document.getElementById('trigger' + key.charAt(0).toUpperCase() + key.slice(1));
                if (toggle) {
                    toggle.classList.toggle('active', automationSettings[key].enabled);
                }
            });
            
            // Populate template dropdowns
            const templateOptions = '<option value="">Select template...</option>' + 
                templates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
            
            ['HireAnniversary', 'Birthday', 'TBReminder', 'TrainingReminder', 'HCAReminder'].forEach(name => {
                const select = document.getElementById('template' + name);
                if (select) {
                    select.innerHTML = templateOptions;
                    const key = name.charAt(0).toLowerCase() + name.slice(1);
                    if (automationSettings[key]?.templateId) {
                        select.value = automationSettings[key].templateId;
                    }
                }
            });
            
            // Set days before values
            if (automationSettings.tbReminder?.daysBefore) {
                document.getElementById('tbReminderDays').value = automationSettings.tbReminder.daysBefore;
            }
            if (automationSettings.trainingReminder?.daysBefore) {
                document.getElementById('trainingReminderDays').value = automationSettings.trainingReminder.daysBefore;
            }
            if (automationSettings.hcaReminder?.daysBefore) {
                document.getElementById('hcaReminderDays').value = automationSettings.hcaReminder.daysBefore;
            }
            
            // Update status
            const activeCount = Object.values(automationSettings).filter(s => s.enabled).length;
            const statusEl = document.getElementById('automationStatus');
            if (activeCount > 0) {
                statusEl.innerHTML = `<span class="status-dot"></span><span>${activeCount} trigger${activeCount > 1 ? 's' : ''} active</span>`;
                statusEl.classList.add('active');
            } else {
                statusEl.innerHTML = `<span class="status-dot"></span><span>Configure triggers below</span>`;
                statusEl.classList.remove('active');
            }
            
            // Refresh employee table to update date colors based on new thresholds
            if (document.getElementById('employeeTableBody')) {
                renderEmployeeDirectory();
            }
        }
        
        function toggleAutomation(key) {
            automationSettings[key].enabled = !automationSettings[key].enabled;
            saveAutomationSettings();
        }
        
        async function saveAutomationSettings() {
            // Get values from UI
            automationSettings.hireAnniversary.templateId = document.getElementById('templateHireAnniversary').value;
            automationSettings.birthday.templateId = document.getElementById('templateBirthday').value;
            automationSettings.tbReminder.templateId = document.getElementById('templateTBReminder').value;
            automationSettings.tbReminder.daysBefore = parseInt(document.getElementById('tbReminderDays').value) || 30;
            automationSettings.trainingReminder.templateId = document.getElementById('templateTrainingReminder').value;
            automationSettings.trainingReminder.daysBefore = parseInt(document.getElementById('trainingReminderDays').value) || 30;
            automationSettings.hcaReminder.templateId = document.getElementById('templateHCAReminder').value;
            automationSettings.hcaReminder.daysBefore = parseInt(document.getElementById('hcaReminderDays').value) || 60;
            
            renderAutomationUI();
            
            try {
                const result = await apiCall({ action: 'updateSetting', key: 'automationSettings', value: JSON.stringify(automationSettings) }, 'POST');
                if (!result.success) throw new Error(result.error);
                settings.automationSettings = JSON.stringify(automationSettings);
            } catch (e) {
                console.error('Failed to save automation settings:', e);
            }
        }
        
        async function runAutomation() {
            const activeCount = Object.values(automationSettings).filter(s => s.enabled && s.templateId).length;
            if (activeCount === 0) {
                showToast('No automation triggers configured', 'warning');
                return;
            }
            
            if (!confirm('Run automation now? This will send emails to all eligible active employees.')) return;
            
            showLoading(true, 'Running automation...');
            try {
                // Get HCA employee IDs for TB, Training, HCA notifications
                const hcaEmployeeIds = employees
                    .filter(e => e.status === 'active' && isHCAPosition(e))
                    .map(e => e.id);
                
                // Get non-X-Ray employee IDs for TB notifications
                const tbEligibleIds = employees
                    .filter(e => e.status === 'active' && isHCAPosition(e) && !(e.tbXray === true || e.tbXray === 'true'))
                    .map(e => e.id);
                
                const result = await apiCall({ 
                    action: 'runAutomation', 
                    settings: automationSettings,
                    hcaEmployeeIds: hcaEmployeeIds,
                    tbEligibleIds: tbEligibleIds
                }, 'POST');
                if (!result.success) throw new Error(result.error);
                
                const sent = result.data?.emailsSent || 0;
                showToast(`Automation complete! ${sent} email${sent !== 1 ? 's' : ''} sent.`, 'success');
                
                // Refresh logs
                await loadAllData();
            } catch (e) {
                showToast('Automation failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function previewAutomation() {
            showLoading(true, 'Checking pending emails...');
            try {
                // Get HCA employee IDs for TB, Training, HCA notifications
                const hcaEmployeeIds = employees
                    .filter(e => e.status === 'active' && isHCAPosition(e))
                    .map(e => e.id);
                
                // Get non-X-Ray employee IDs for TB notifications
                const tbEligibleIds = employees
                    .filter(e => e.status === 'active' && isHCAPosition(e) && !(e.tbXray === true || e.tbXray === 'true'))
                    .map(e => e.id);
                
                const result = await apiCall({ 
                    action: 'previewAutomation', 
                    settings: automationSettings,
                    hcaEmployeeIds: hcaEmployeeIds,
                    tbEligibleIds: tbEligibleIds
                }, 'POST');
                if (!result.success) throw new Error(result.error);
                
                const pending = result.data?.pending || [];
                if (pending.length === 0) {
                    showToast('No emails pending for today', 'info');
                    return;
                }
                
                // Show preview modal
                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                pending.forEach(p => {
                    html += `<div style="padding: 10px; background: #F9FAFB; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-weight: 600;">${escapeHtml(p.employeeName)}</div>
                        <div style="font-size: 12px; color: #666;">${escapeHtml(p.triggerType)} - ${escapeHtml(p.templateName)}</div>
                    </div>`;
                });
                html += '</div>';
                
                document.getElementById('logModalContent').innerHTML = html;
                document.getElementById('logModal').querySelector('.modal-header h2').textContent = `Pending Emails (${pending.length})`;
                document.getElementById('logModal').classList.add('active');
            } catch (e) {
                showToast('Preview failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function createDefaultAutomationTemplates() {
            if (!confirm('Create default automation templates? This will add new templates for each trigger type.')) return;
            
            const defaultTemplates = [
                {
                    name: 'Work Anniversary Congratulations',
                    category: 'hr',
                    subject: 'Happy Work Anniversary, {{first_name}}! 🎉',
                    body: `<p>Dear {{first_name}},</p>
<p><strong>Congratulations on your work anniversary with alice.care!</strong></p>
<p>We want to take a moment to express our sincere gratitude for your dedication, hard work, and commitment to providing excellent care to our clients.</p>
<p>Your contributions make a real difference in the lives of those we serve, and we are fortunate to have you as part of our team.</p>
<p>Here's to many more years of success together!</p>
<p>With appreciation,<br>
<strong>The alice.care Team</strong></p>`,
                    warningLevel: 0
                },
                {
                    name: 'Happy Birthday',
                    category: 'hr',
                    subject: 'Happy Birthday, {{first_name}}! 🎂',
                    body: `<p>Dear {{first_name}},</p>
<p><strong>Wishing you a very Happy Birthday!</strong></p>
<p>On behalf of everyone at alice.care, we hope your special day is filled with joy, laughter, and wonderful moments with family and friends.</p>
<p>Thank you for being such a valuable member of our team. We appreciate everything you do!</p>
<p>Enjoy your day!</p>
<p>Warm wishes,<br>
<strong>The alice.care Team</strong></p>`,
                    warningLevel: 0
                },
                {
                    name: 'TB Test Reminder',
                    category: 'reminder',
                    subject: 'TB Test Due {{tb_due_date}} - Action Required',
                    body: `<p>Dear {{first_name}},</p>
<p>This is a friendly reminder that your <strong>TB (Tuberculosis) test is due on {{tb_due_date}}</strong> ({{days_until_tb_due}} remaining).</p>
<p>As a healthcare worker, maintaining current TB testing is a requirement for your continued employment and ensures the safety of our clients.</p>
<p><strong>Please schedule your TB test as soon as possible.</strong></p>
<p>Once completed, please provide a copy of your results to HR so we can update your records.</p>
<p>If you have any questions or need assistance scheduling your test, please don't hesitate to reach out.</p>
<p>Thank you for your attention to this important matter.</p>
<p>Best regards,<br>
<strong>Human Resources</strong><br>
alice.care</p>`,
                    warningLevel: 0
                },
                {
                    name: 'Annual Training Reminder',
                    category: 'reminder',
                    subject: 'Annual Training Due {{training_due_date}} - Action Required',
                    body: `<p>Dear {{first_name}},</p>
<p>This is a reminder that your <strong>annual training is due on {{training_due_date}}</strong> ({{days_until_training_due}} remaining).</p>
<p>Completing your required training ensures you have the latest knowledge and skills to provide the best care to our clients, and is a requirement for continued employment.</p>
<p><strong>Please complete your training at your earliest convenience.</strong></p>
<p>If you have any questions about the training requirements or need access to training materials, please contact HR.</p>
<p>Thank you for your commitment to professional development.</p>
<p>Best regards,<br>
<strong>Human Resources</strong><br>
alice.care</p>`,
                    warningLevel: 0
                },
                {
                    name: 'HCA Certification Renewal Reminder',
                    category: 'reminder',
                    subject: 'HCA Certification Expires {{hca_expiration_date}} - Action Required',
                    body: `<p>Dear {{first_name}},</p>
<p>This is an important reminder that your <strong>HCA (Home Care Aide) certification expires on {{hca_expiration_date}}</strong> ({{days_until_hca_expiration}} remaining).</p>
<p>Maintaining a valid HCA certification is essential for your role at alice.care and is required by California state regulations.</p>
<p><strong>Please take steps to renew your certification before it expires.</strong></p>
<p>This may include completing continuing education requirements and submitting your renewal application to the appropriate state agency.</p>
<p>If you need assistance with the renewal process or have questions, please contact HR immediately.</p>
<p>Thank you for your attention to this important compliance matter.</p>
<p>Best regards,<br>
<strong>Human Resources</strong><br>
alice.care</p>`,
                    warningLevel: 0
                }
            ];
            
            showLoading(true, 'Creating templates...');
            let created = 0;
            
            try {
                for (const tpl of defaultTemplates) {
                    // Check if template with same name exists
                    if (templates.find(t => t.name === tpl.name)) {
                        continue;
                    }
                    
                    const result = await apiCall({ action: 'addTemplate', ...tpl }, 'POST');
                    if (result.success) {
                        templates.push({ id: result.data.id, ...tpl });
                        created++;
                    }
                }
                
                renderTemplatesGrid();
                renderAutomationUI();
                showToast(`Created ${created} new template${created !== 1 ? 's' : ''}`, 'success');
            } catch (e) {
                showToast('Failed to create templates: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ============================================
        // DATA MANAGEMENT
        // ============================================
        function exportData() {
            const data = { employees, templates, logs: emailLogs, aliases, settings, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `alicecare-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Exported!', 'success');
        }
        
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm('Replace all data?')) return;
                    showLoading(true, 'Importing...');
                    const result = await apiCall({ action: 'importData', ...data }, 'POST');
                    if (!result.success) throw new Error(result.error);
                    await loadAllData();
                    showToast('Imported!', 'success');
                } catch (e) {
                    showToast('Failed: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        async function confirmClearData() {
            if (!confirm('Clear ALL data?')) return;
            if (!confirm('Are you sure?')) return;
            showLoading(true, 'Clearing...');
            try {
                const result = await apiCall({ action: 'clearAllData' }, 'POST');
                if (!result.success) throw new Error(result.error);
                await loadAllData();
                showToast('Data cleared', 'success');
            } catch (e) {
                showToast('Failed: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
