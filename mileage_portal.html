<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>alice.care - Mileage v5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #E5ECF3;
            min-height: 100vh;
            padding: 20px;
        }
        
        .nav-bar {
            max-width: 1200px;
            margin: 0 auto 20px;
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
        }
        
        .logo .alice {
            color: #F57600;
            font-weight: 700;
        }
        
        .logo .dot {
            color: #F57600;
            font-weight: 700;
            margin: 0 -2px;
        }
        
        .logo .care {
            color: #1A365C;
            font-weight: 400;
        }
        
        /* Tab Navigation */
        .tab-nav {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: 2px solid #D3D7DF;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #3D3D3D;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            border-color: #F57600;
            color: #F57600;
        }
        
        .tab-btn.active {
            background: #1A365C;
            border-color: #1A365C;
            color: white;
        }
        
        .tab-btn .icon {
            font-size: 18px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15);
            overflow: hidden;
        }
        
        .header {
            background: #1A365C;
            color: white;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .lookup-section {
            padding: 30px;
            background: #E5ECF3;
            border-bottom: 2px solid #D3D7DF;
        }
        
        .lookup-title {
            font-size: 18px;
            color: #1A365C;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .lookup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 13px;
            color: #1A365C;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .required {
            color: #FF7475;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select {
            padding: 12px 14px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%233D3D3D' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #F57600;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 118, 0, 0.3);
        }
        
        .btn-primary:disabled {
            background: #D3D7DF;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #62B790;
            color: white;
        }
        
        .btn-success:hover {
            background: #52a780;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #E5ECF3;
            color: #1A365C;
            border: 2px solid #D3D7DF;
        }
        
        .btn-secondary:hover {
            background: #D3D7DF;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #E5ECF3;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #F57600;
        }
        
        .stat-card h3 {
            font-size: 12px;
            color: #3D3D3D;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .stat-card .number {
            font-size: 28px;
            color: #1A365C;
            font-weight: 700;
        }
        
        .report-section {
            padding: 30px;
        }
        
        .notice-box {
            background: #FFF4E5;
            border-left: 4px solid #F57600;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .notice-box p {
            color: #3D3D3D;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .notice-box.success {
            background: #D4F4E2;
            border-left-color: #62B790;
        }
        
        .service-card {
            background: white;
            border: 2px solid #E5ECF3;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .service-card:hover {
            border-color: #F57600;
            box-shadow: 0 4px 12px rgba(245, 118, 0, 0.1);
        }
        
        /* Table Styles */
        table {
            font-family: 'Poppins', sans-serif;
        }
        
        table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        table tbody tr {
            transition: all 0.2s;
        }
        
        table tbody tr:hover {
            background: #FFF4E5 !important;
            box-shadow: 0 2px 8px rgba(245, 118, 0, 0.1);
        }
        
        table input[type="number"]:focus,
        table input[type="text"]:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        table input[type="number"]:disabled,
        table input[type="text"]:disabled {
            background: #F5F5F5;
            cursor: not-allowed;
        }
        
        table label:hover {
            background: #FFF4E5;
            border-color: #F57600;
        }
        
        /* Responsive table */
        @media (max-width: 768px) {
            table {
                font-size: 12px;
            }
            
            table th,
            table td {
                padding: 8px 4px !important;
            }
            
            table input {
                font-size: 12px;
                padding: 4px 6px !important;
            }
        }
        
        
        .approval-section {
            background: #E5ECF3;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        
        .approval-section h3 {
            font-size: 18px;
            color: #1A365C;
            margin-bottom: 15px;
        }
        
        .approval-section p {
            font-size: 13px;
            color: #3D3D3D;
            margin-bottom: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-oncall {
            background: #FFE8CC;
            color: #F57600;
        }
        
        .badge-approved {
            background: #D4F4E2;
            color: #62B790;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #3D3D3D;
        }
        
        .empty-state h3 {
            font-size: 20px;
            color: #1A365C;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Section Divider */
        .section-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 30px 0 20px;
        }
        
        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            border-bottom: 2px solid #E5ECF3;
        }
        
        .section-divider span {
            padding: 0 16px;
            font-size: 16px;
            font-weight: 600;
            color: #1A365C;
            background: white;
        }
        
        /* Manual Entries Stats */
        .manual-stats {
            background: #E5ECF3;
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .manual-stat-item {
            text-align: center;
        }
        
        .manual-stat-item .stat-label {
            font-size: 11px;
            color: #3D3D3D;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .manual-stat-item .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1A365C;
        }
        
        .manual-stat-item .stat-value.highlight {
            color: #F57600;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #3D3D3D;
        }
        
        /* Spinner Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #E5ECF3;
            border-top: 4px solid #F57600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        .spinner.small {
            width: 20px;
            height: 20px;
            border-width: 3px;
            margin: 0;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Full Page Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #F57600;
        }
        
        .loading-overlay .loading-text {
            color: white;
            font-size: 16px;
            margin-top: 16px;
            font-weight: 500;
        }
        
        .loading-overlay .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-top: 8px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ========================================== */
        /* MOBILE MILEAGE ENTRY SECTION STYLES       */
        /* ========================================== */
        
        .mobile-entry-section {
            padding: 20px;
        }
        
        .mobile-form {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .mobile-form .form-group {
            margin-bottom: 16px;
        }
        
        .mobile-form label {
            font-size: 14px;
            font-weight: 600;
            color: #1A365C;
            margin-bottom: 8px;
            display: block;
        }
        
        .mobile-form input,
        .mobile-form select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #D3D7DF;
            border-radius: 10px;
        }
        
        .mobile-form input:focus,
        .mobile-form select:focus {
            border-color: #F57600;
            box-shadow: 0 0 0 4px rgba(245, 118, 0, 0.15);
        }
        
        .mileage-calculator {
            background: #E5ECF3;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .mileage-calculator h4 {
            font-size: 14px;
            color: #1A365C;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .mileage-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .mileage-result {
            background: white;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #62B790;
        }
        
        .mileage-result .label {
            font-size: 12px;
            color: #3D3D3D;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .mileage-result .value {
            font-size: 32px;
            font-weight: 700;
            color: #1A365C;
        }
        
        .mileage-result .unit {
            font-size: 14px;
            color: #3D3D3D;
            font-weight: 400;
        }
        
        .submit-section {
            margin-top: 24px;
        }
        
        .submit-section .btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
        }
        
        /* Trip Status Sections */
        .trip-mode-container {
            margin-bottom: 20px;
        }
        
        .incomplete-warning {
            background: #FFF4E5;
            border: 2px solid #F57600;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .incomplete-warning .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .incomplete-warning .warning-text {
            font-size: 13px;
            color: #3D3D3D;
            line-height: 1.5;
        }
        
        .incomplete-warning .warning-text strong {
            color: #1A365C;
        }
        
        /* Trip In Progress Card */
        .trip-in-progress {
            background: linear-gradient(135deg, #E5ECF3 0%, #D4E4F7 100%);
            border: 2px solid #1A365C;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .trip-in-progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .trip-in-progress-header h3 {
            font-size: 16px;
            color: #1A365C;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .trip-in-progress-header .pulse-dot {
            width: 10px;
            height: 10px;
            background: #F57600;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .trip-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .trip-detail-item {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
        }
        
        .trip-detail-item .label {
            font-size: 11px;
            color: #6B7280;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .trip-detail-item .value {
            font-size: 14px;
            color: #1A365C;
            font-weight: 600;
        }
        
        .trip-detail-item.full-width {
            grid-column: 1 / -1;
        }
        
        .complete-trip-form {
            background: white;
            padding: 16px;
            border-radius: 10px;
            margin-top: 16px;
        }
        
        .complete-trip-form h4 {
            font-size: 14px;
            color: #1A365C;
            margin-bottom: 12px;
        }
        
        .trip-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .trip-actions .btn {
            flex: 1;
        }
        
        .btn-danger {
            background: #FF7475;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background: #e65a5b;
        }
        
        /* Section Divider */
        .section-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
        }
        
        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            border-bottom: 2px solid #E5ECF3;
        }
        
        .section-divider span {
            padding: 0 16px;
            color: #9CA3AF;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        /* Odometer Conflict Modal */
        .odometer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .odometer-modal.hidden {
            display: none;
        }
        
        .odometer-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .odometer-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .odometer-modal-header .icon {
            font-size: 32px;
        }
        
        .odometer-modal-header h3 {
            font-size: 18px;
            color: #1A365C;
            font-weight: 600;
        }
        
        .odometer-modal-body {
            margin-bottom: 20px;
        }
        
        .odometer-modal-body p {
            font-size: 14px;
            color: #3D3D3D;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .conflict-details {
            background: #FFF4E5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .conflict-details .conflict-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }
        
        .conflict-details .conflict-row .label {
            color: #6B7280;
        }
        
        .conflict-details .conflict-row .value {
            font-weight: 600;
            color: #1A365C;
        }
        
        .conflict-details .conflict-row.error .value {
            color: #FF7475;
        }
        
        .justification-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .justification-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #F8FAFC;
            border: 2px solid #E5ECF3;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .justification-option:hover {
            border-color: #F57600;
        }
        
        .justification-option.selected {
            border-color: #F57600;
            background: #FFF4E5;
        }
        
        .justification-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #F57600;
        }
        
        .justification-option label {
            font-size: 14px;
            color: #3D3D3D;
            cursor: pointer;
            flex: 1;
        }
        
        .justification-other-input {
            margin-top: 10px;
            padding: 10px 12px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
        }
        
        .justification-other-input:focus {
            outline: none;
            border-color: #F57600;
        }
        
        .odometer-modal-footer {
            display: flex;
            gap: 10px;
        }
        
        .odometer-modal-footer .btn {
            flex: 1;
            padding: 12px;
        }
        
        .btn-secondary {
            background: #E5ECF3;
            color: #1A365C;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #D3D7DF;
        }
        
        /* Form Section Headers */
        .form-section-header {
            font-size: 14px;
            font-weight: 600;
            color: #1A365C;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E5ECF3;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            font-size: 18px;
        }
        
        /* Remember Me Row */
        .remember-me-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            margin-bottom: 8px;
            padding: 10px 12px;
            background: #F8FAFC;
            border-radius: 8px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #3D3D3D;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #F57600;
            cursor: pointer;
        }
        
        .clear-info-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #D3D7DF;
            border-radius: 6px;
            font-size: 12px;
            color: #3D3D3D;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
        }
        
        .clear-info-btn:hover {
            background: #FF7475;
            color: white;
            border-color: #FF7475;
        }
        
        /* Input with Now Button */
        .input-with-btn {
            display: flex;
            gap: 6px;
            align-items: stretch;
        }
        
        .input-with-btn input {
            flex: 1;
            min-width: 0;
        }
        
        .now-btn {
            padding: 10px 12px;
            background: #1A365C;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .portal-badge { background: #1A365C; color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; }
        
        .now-btn:hover {
            background: #2d4a73;
        }
        
        .now-btn:active {
            background: #F57600;
            transform: scale(0.98);
        }
        
        /* DateTime Row */
        .datetime-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .datetime-helper {
            font-size: 11px;
            color: #9CA3AF;
            text-align: center;
            margin-top: 6px;
            margin-bottom: 8px;
        }
        
        @media (max-width: 400px) {
            .datetime-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        /* View My Report Section */
        .view-report-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .view-report-divider {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .view-report-divider::before,
        .view-report-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #D3D7DF;
        }
        
        .view-report-divider span {
            padding: 0 16px;
            color: #9CA3AF;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        .view-report-btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            background: #1A365C;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-report-btn:hover {
            background: #2d4a73;
        }
        
        .view-report-hint {
            font-size: 12px;
            color: #9CA3AF;
            margin-top: 10px;
        }
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            min-width: 70px;
            text-align: center;
        }
        
        .entry-item .entry-status {
            font-size: 11px;
            margin-top: 4px;
        }
        
        .entry-item .entry-status.pending {
            color: #F57600;
        }
        
        .entry-item .entry-status.submitted {
            color: #62B790;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .nav-bar {
                padding: 12px 15px;
                margin-bottom: 15px;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .tab-nav {
                flex-direction: column;
                gap: 8px;
            }
            
            .tab-btn {
                padding: 14px 16px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .lookup-section {
                padding: 20px 15px;
            }
            
            .lookup-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 12px;
            }
            
            .report-section {
                padding: 20px 15px;
            }
            
            .btn {
                width: 100%;
                padding: 14px 20px;
            }
            
            /* Make table scrollable on mobile */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }
            
            table td, table th {
                min-width: 80px;
            }
            
            .mobile-entry-section {
                padding: 15px;
            }
            
            .mileage-inputs {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .lookup-title {
                font-size: 16px;
            }
            
            .stat-card .number {
                font-size: 22px;
            }
            
            .mileage-result .value {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Processing...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait</div>
    </div>

    <div class="nav-bar">
        <div class="logo">
            <span class="alice">alice</span><span class="dot">.</span><span class="care">care</span>
             <div class="portal-badge"><a href="https://alicecare2032.github.io/alice-care-timeoff/timecard_portal.html" class="portal-badge">Mileage Portal</a></div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('report')">
            <span class="icon">üìä</span>
            <span>View Report</span>
        </button>
        <button class="tab-btn" onclick="showTab('submit')">
            <span class="icon">‚ûï</span>
            <span>Log Mileage</span>
        </button>
    </div>

    <!-- REPORT TAB CONTENT -->
    <div id="reportTab" class="container">
        <div class="header">
            <h1>Mileage Report Portal</h1>
            <p>Review and submit your weekly mileage reports</p>
        </div>

        <div class="lookup-section">
            <div class="lookup-title">Lookup Your Report</div>
            <div class="lookup-grid">
                <div class="form-group">
                    <label>Employee ID <span class="required">*</span></label>
                    <input type="text" id="employeeId" placeholder="Enter Employee ID">
                </div>
                <div class="form-group">
                    <label>Last Name <span class="required">*</span></label>
                    <input type="text" id="lastName" placeholder="Enter Last Name">
                </div>
                <div class="form-group">
                    <label>Week Number <span class="required">* <a href="week_number_reference.html" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #F57600; color: white; text-decoration: none; border-radius: 50%; font-weight: bold; font-size: 16px;" title="Find Week Number">?</a></span></label>
                    <input type="number" id="weekNumber" placeholder="1-52" min="1" max="53">
                </div>
                <div class="form-group">
                    <label>Year <span class="required">*</span></label>
                    <input type="number" id="year" placeholder="2024" min="2020" max="2030">
                </div>
            </div>
            <button class="btn btn-primary" onclick="loadReport()">Load Report</button>
        </div>

        <div id="statsSection" class="stats-row hidden">
            <div class="stat-card">
                <h3>Total Services</h3>
                <div class="number" id="totalServices">0</div>
            </div>
            <div class="stat-card">
                <h3>Original Mileage</h3>
                <div class="number" id="originalMileage">0.0</div>
            </div>
            <div class="stat-card">
                <h3>Adjusted Mileage</h3>
                <div class="number" id="adjustedMileage">0.0</div>
            </div>
            <div class="stat-card">
                <h3>Status</h3>
                <div class="number" id="reportStatus" style="font-size: 16px;">-</div>
            </div>
        </div>

        <div id="reportSection" class="report-section hidden">
            <div class="notice-box">
                <p><strong>Note:</strong> This report displays all on-call services, including your first service (commute). Commute mileage is shown for reference but is <strong>not included in reimbursable totals</strong> and cannot be adjusted. Only review and adjust reimbursable services as needed, then submit when ready.</p>
            </div>

            <div id="servicesList"></div>

            <div class="approval-section">
                <h3>Ready to Submit?</h3>
                <p>Once you submit this report, the mileage data will be finalized and submitted for processing.</p>
                <button class="btn btn-success" onclick="approveReport()" id="approveBtn">Approve Report</button>
            </div>
        </div>
        
        <!-- Manual Mileage Entries Section -->
        <div id="manualEntriesSection" class="report-section hidden">
            <div class="section-divider">
                <span>üìù Manual Mileage Entries</span>
            </div>
            <div class="notice-box" style="background: #E8F4FD; border-left-color: #1A365C;">
                <p><strong>Manual Entries:</strong> These are mileage entries submitted manually by the employee (e.g., transportation, distance beyond 50mi). These entries are <strong>already submitted</strong> and shown here for review only.</p>
            </div>
            <div id="manualEntriesList"></div>
            <div id="manualEntriesStats" class="manual-stats"></div>
        </div>

        <div id="emptyState" class="empty-state hidden">
            <h3>No Report Found</h3>
            <p>No services found for the specified week. Please verify your Employee ID, Last Name, Week Number, and Year.</p>
        </div>

        <div id="loadingState" class="loading hidden">
            <p>Loading your report...</p>
        </div>
    </div>

    <!-- SUBMIT MILEAGE TAB CONTENT -->
    <div id="submitTab" class="container hidden">
        <div class="header">
            <h1>Log Mileage</h1>
            <p>Submit transportation mileage on-the-go</p>
        </div>

        <div class="mobile-entry-section">
            <div class="mobile-form">
                <!-- Incomplete Trip Warning -->
                <div class="incomplete-warning">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <div class="warning-text">
                        <strong>Note:</strong> Incomplete trips (started but not finished) are not considered for reimbursement until submitted with end mileage.
                    </div>
                </div>
                
                <!-- Employee Info Section -->
                <div class="form-section-header">
                    <span class="section-icon">üë§</span> Your Information
                </div>
                
                <div class="form-group">
                    <label>Employee ID <span class="required">*</span></label>
                    <input type="text" id="submitEmployeeId" placeholder="Enter your Employee ID" inputmode="numeric" onchange="checkRememberMe()">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" id="submitFirstName" placeholder="First Name" onchange="checkRememberMe()">
                    </div>
                    <div class="form-group">
                        <label>Last Name <span class="required">*</span></label>
                        <input type="text" id="submitLastName" placeholder="Last Name" onchange="checkRememberMe()">
                    </div>
                </div>
                
                <div class="remember-me-row">
                    <label class="checkbox-label">
                        <input type="checkbox" id="rememberEmployee" onchange="toggleRememberMe()">
                        <span class="checkmark"></span>
                        Remember my info on this device
                    </label>
                    <button type="button" class="clear-info-btn" onclick="clearSavedEmployee()" id="clearInfoBtn" style="display: none;">Clear</button>
                </div>
                
                <!-- ===================== -->
                <!-- TRIP IN PROGRESS CARD -->
                <!-- ===================== -->
                <div id="tripInProgressSection" class="trip-in-progress" style="display: none;">
                    <div class="trip-in-progress-header">
                        <h3><span class="pulse-dot"></span> Trip In Progress</h3>
                    </div>
                    
                    <div class="trip-details-grid">
                        <div class="trip-detail-item">
                            <div class="label">Client</div>
                            <div class="value" id="tripClientDisplay">-</div>
                        </div>
                        <div class="trip-detail-item">
                            <div class="label">Reason</div>
                            <div class="value" id="tripReasonDisplay">-</div>
                        </div>
                        <div class="trip-detail-item">
                            <div class="label">Started</div>
                            <div class="value" id="tripStartTimeDisplay">-</div>
                        </div>
                        <div class="trip-detail-item">
                            <div class="label">Start Miles</div>
                            <div class="value" id="tripStartMilesDisplay">-</div>
                        </div>
                    </div>
                    
                    <div class="complete-trip-form">
                        <h4>üìç Complete Your Trip</h4>
                        <div class="form-group">
                            <label>End Miles <span class="required">*</span></label>
                            <input type="number" id="tripEndMiles" placeholder="Enter ending odometer" inputmode="decimal" step="0.1" oninput="calculateTripMileage()">
                        </div>
                        <div class="mileage-result" style="margin-top: 12px;">
                            <div class="label">Total Mileage</div>
                            <div class="value" id="tripCalculatedMileage">0.0 <span class="unit">mi</span></div>
                        </div>
                        
                        <div class="trip-actions">
                            <button class="btn btn-danger" onclick="cancelTrip()">üóëÔ∏è Cancel</button>
                            <button class="btn btn-success" onclick="completeTrip()">‚úì Complete & Submit</button>
                        </div>
                    </div>
                </div>
                
                <!-- ===================== -->
                <!-- START NEW TRIP FORM -->
                <!-- ===================== -->
                <div id="startTripSection">
                    <div class="form-section-header" style="margin-top: 24px;">
                        <span class="section-icon">üìç</span> Start New Trip
                    </div>
                    
                    <!-- Client Name -->
                    <div class="form-group">
                        <label>Client Name <span class="required">*</span></label>
                        <input type="text" id="startTripClient" placeholder="Enter client's name">
                    </div>
                    
                    <!-- Reason Selection -->
                    <div class="form-group">
                        <label>Reason <span class="required">*</span></label>
                        <select id="startTripReason">
                            <option value="">Select a reason...</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Distance Beyond 50mi/1hr">Distance Beyond 50mi/1hr</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Start Odometer -->
                    <div class="mileage-calculator">
                        <h4>üìç Starting Odometer</h4>
                        <div class="form-group">
                            <label>Start Miles <span class="required">*</span></label>
                            <input type="number" id="startTripMiles" placeholder="e.g. 45230" inputmode="decimal" step="0.1">
                        </div>
                    </div>
                    
                    <!-- Start Trip Button -->
                    <div class="submit-section">
                        <button class="btn btn-primary" onclick="startTrip()" id="startTripBtn">
                            üöó Start Trip
                        </button>
                    </div>
                </div>
                
                <!-- ===================== -->
                <!-- SECTION DIVIDER -->
                <!-- ===================== -->
                <div class="section-divider">
                    <span>or log a completed trip</span>
                </div>
                
                <!-- ===================== -->
                <!-- LOG COMPLETED TRIP -->
                <!-- ===================== -->
                <div id="completedTripSection">
                    <div class="form-section-header">
                        <span class="section-icon">üìù</span> Log Completed Trip
                    </div>
                    
                    <!-- Client Name -->
                    <div class="form-group">
                        <label>Client Name <span class="required">*</span></label>
                        <input type="text" id="submitClientName" placeholder="Enter client's name">
                    </div>
                    
                    <!-- Reason Selection -->
                    <div class="form-group">
                        <label>Reason <span class="required">*</span></label>
                        <select id="submitReason">
                            <option value="">Select a reason...</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Distance Beyond 50mi/1hr">Distance Beyond 50mi/1hr</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Date and Time with NOW buttons -->
                    <div class="datetime-row">
                        <div class="form-group">
                            <label>Date <span class="required">*</span></label>
                            <div class="input-with-btn">
                                <input type="date" id="submitDate">
                                <button type="button" class="now-btn" onclick="setDateNow()">üìÖ</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Time <span class="required">*</span></label>
                            <div class="input-with-btn">
                                <input type="time" id="submitTime">
                                <button type="button" class="now-btn" onclick="setTimeNow()">‚è±Ô∏è</button>
                            </div>
                        </div>
                    </div>
                    <div class="datetime-helper">
                        Tap üìÖ for today's date, ‚è±Ô∏è for current time
                    </div>
                    
                    <!-- Mileage Calculator -->
                    <div class="mileage-calculator">
                        <h4>üìç Odometer Reading</h4>
                        <div class="mileage-inputs">
                            <div class="form-group">
                                <label>Start Miles <span class="required">*</span></label>
                                <input type="number" id="startMiles" placeholder="e.g. 45230" inputmode="decimal" step="0.1" oninput="calculateMileage()">
                            </div>
                            <div class="form-group">
                                <label>End Miles <span class="required">*</span></label>
                                <input type="number" id="endMiles" placeholder="e.g. 45248" inputmode="decimal" step="0.1" oninput="calculateMileage()">
                            </div>
                        </div>
                        <div class="mileage-result">
                            <div class="label">Total Mileage</div>
                            <div class="value" id="calculatedMileage">0.0 <span class="unit">mi</span></div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="submit-section">
                        <button class="btn btn-success" onclick="submitMileageEntry(false)" id="submitMileageBtn">
                            ‚úì Submit Mileage
                        </button>
                        <button class="btn btn-primary" onclick="submitMileageEntry(true)" id="submitAddAnotherBtn" style="margin-top: 10px;">
                            ‚úì Submit & Add Another Client
                        </button>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div id="submitSuccess" class="notice-box success hidden" style="margin-top: 20px;">
                    <p><strong>‚úì Mileage submitted successfully!</strong> <span id="successMessage">Your entry has been recorded.</span></p>
                </div>
                
                <!-- View My Report Section -->
                <div class="view-report-section">
                    <div class="view-report-divider">
                        <span>or</span>
                    </div>
                    <button type="button" class="btn btn-secondary view-report-btn" onclick="goToViewReport()">
                        üìä View My Weekly Report
                    </button>
                    <p class="view-report-hint">Review and submit your weekly mileage report</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Odometer Conflict Modal -->
    <div id="odometerModal" class="odometer-modal hidden">
        <div class="odometer-modal-content">
            <div class="odometer-modal-header">
                <span class="icon">‚ö†Ô∏è</span>
                <h3>Odometer Reading Conflict</h3>
            </div>
            <div class="odometer-modal-body">
                <p id="odometerConflictMessage">Your start miles appear to conflict with your previous entries.</p>
                
                <div class="conflict-details">
                    <div class="conflict-row">
                        <span class="label">Your last recorded end miles:</span>
                        <span class="value" id="lastEndMilesDisplay">-</span>
                    </div>
                    <div class="conflict-row error">
                        <span class="label">Your entered start miles:</span>
                        <span class="value" id="enteredStartMilesDisplay">-</span>
                    </div>
                </div>
                
                <p>Please select a reason for this discrepancy:</p>
                
                <div class="justification-options">
                    <div class="justification-option" onclick="selectJustification('Different Vehicle')">
                        <input type="radio" name="justification" value="Different Vehicle" id="justDiffVehicle">
                        <label for="justDiffVehicle">Different Vehicle</label>
                    </div>
                    <div class="justification-option" onclick="selectJustification('Rental Car')">
                        <input type="radio" name="justification" value="Rental Car" id="justRental">
                        <label for="justRental">Rental Car</label>
                    </div>
                    <div class="justification-option" onclick="selectJustification('Odometer Reset/Repair')">
                        <input type="radio" name="justification" value="Odometer Reset/Repair" id="justReset">
                        <label for="justReset">Odometer Reset/Repair</label>
                    </div>
                    <div class="justification-option" onclick="selectJustification('Other')">
                        <input type="radio" name="justification" value="Other" id="justOther">
                        <label for="justOther">Other</label>
                    </div>
                </div>
                <input type="text" id="justificationOtherText" class="justification-other-input" placeholder="Please specify..." style="display: none;">
            </div>
            <div class="odometer-modal-footer">
                <button class="btn btn-secondary" onclick="closeOdometerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmOdometerJustification()" id="confirmJustificationBtn">Continue</button>
            </div>
        </div>
    </div>

    <script>
        // REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyoge_hluInEjc7ovFBnxttmqxY4GgXi-wTKdDeHzNUk3-jhMGAnwn9oYt2219A2FVU/exec';
        
        let currentReport = null;
        let adjustments = {};
        let recentMileageEntries = [];
        
        // Trip in progress data
        const TRIP_STORAGE_KEY = 'aliceCare_tripInProgress';
        const LAST_ODOMETER_KEY = 'aliceCare_lastOdometer';
        let currentTripInProgress = null;
        let pendingOdometerAction = null; // Stores the action to perform after justification
        let selectedJustification = null;
        
        // ==========================================
        // LOADING OVERLAY FUNCTIONS
        // ==========================================
        
        function showLoading(text, subtext) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            loadingText.textContent = text || 'Processing...';
            loadingSubtext.textContent = subtext || 'Please wait';
            
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        // ==========================================
        // TRIP IN PROGRESS MANAGEMENT
        // ==========================================
        
        function initializeTripState() {
            // Check for existing trip in progress
            const savedTrip = localStorage.getItem(TRIP_STORAGE_KEY);
            if (savedTrip) {
                currentTripInProgress = JSON.parse(savedTrip);
                showTripInProgress();
            } else {
                hideTripInProgress();
            }
        }
        
        function showTripInProgress() {
            if (!currentTripInProgress) return;
            
            document.getElementById('tripInProgressSection').style.display = 'block';
            document.getElementById('startTripSection').style.display = 'none';
            
            // Populate display
            document.getElementById('tripClientDisplay').textContent = currentTripInProgress.clientName;
            document.getElementById('tripReasonDisplay').textContent = currentTripInProgress.reason;
            document.getElementById('tripStartMilesDisplay').textContent = parseFloat(currentTripInProgress.startMiles).toLocaleString() + ' mi';
            
            // Format start time
            const startDate = new Date(currentTripInProgress.startDateTime);
            document.getElementById('tripStartTimeDisplay').textContent = startDate.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }
        
        function hideTripInProgress() {
            document.getElementById('tripInProgressSection').style.display = 'none';
            document.getElementById('startTripSection').style.display = 'block';
            document.getElementById('tripEndMiles').value = '';
            document.getElementById('tripCalculatedMileage').innerHTML = '0.0 <span class="unit">mi</span>';
        }
        
        function calculateTripMileage() {
            if (!currentTripInProgress) return;
            
            const startMiles = parseFloat(currentTripInProgress.startMiles) || 0;
            const endMiles = parseFloat(document.getElementById('tripEndMiles').value) || 0;
            
            if (endMiles > startMiles) {
                const total = (endMiles - startMiles).toFixed(1);
                document.getElementById('tripCalculatedMileage').innerHTML = `${total} <span class="unit">mi</span>`;
            } else {
                document.getElementById('tripCalculatedMileage').innerHTML = '0.0 <span class="unit">mi</span>';
            }
        }
        
        function startTrip() {
            // Validate employee info
            const employeeId = document.getElementById('submitEmployeeId').value.trim();
            const firstName = document.getElementById('submitFirstName').value.trim();
            const lastName = document.getElementById('submitLastName').value.trim();
            
            if (!employeeId || !firstName || !lastName) {
                alert('Please fill in your employee information first.');
                return;
            }
            
            // Validate trip details
            const clientName = document.getElementById('startTripClient').value.trim();
            const reason = document.getElementById('startTripReason').value;
            const startMiles = document.getElementById('startTripMiles').value.trim();
            
            if (!clientName) {
                alert('Please enter the client name.');
                return;
            }
            
            if (!reason) {
                alert('Please select a reason.');
                return;
            }
            
            if (!startMiles) {
                alert('Please enter your starting odometer reading.');
                return;
            }
            
            // Check odometer against last recorded
            const lastOdometer = getLastOdometer(employeeId);
            if (lastOdometer && parseFloat(startMiles) < lastOdometer) {
                // Show conflict modal
                pendingOdometerAction = { type: 'startTrip', data: { clientName, reason, startMiles } };
                showOdometerConflict(lastOdometer, parseFloat(startMiles));
                return;
            }
            
            // Proceed to start trip
            proceedStartTrip(clientName, reason, startMiles, null);
        }
        
        function proceedStartTrip(clientName, reason, startMiles, justification) {
            const employeeId = document.getElementById('submitEmployeeId').value.trim();
            const firstName = document.getElementById('submitFirstName').value.trim();
            const lastName = document.getElementById('submitLastName').value.trim();
            
            // Create trip object
            currentTripInProgress = {
                id: 'trip_' + Date.now(),
                employeeId: employeeId,
                firstName: firstName,
                lastName: lastName,
                clientName: clientName,
                reason: reason,
                startMiles: startMiles,
                startDateTime: new Date().toISOString(),
                justification: justification
            };
            
            // Save to localStorage
            localStorage.setItem(TRIP_STORAGE_KEY, JSON.stringify(currentTripInProgress));
            
            // Show loading
            showLoading('Starting Trip...', `Recording ${clientName} visit`);
            
            // Save to Google Sheet as "In Progress"
            saveTripToSheet(currentTripInProgress, 'In Progress', null, function(success) {
                hideLoading();
                
                if (success) {
                    // Clear form
                    document.getElementById('startTripClient').value = '';
                    document.getElementById('startTripReason').value = '';
                    document.getElementById('startTripMiles').value = '';
                    
                    // Show trip in progress UI
                    showTripInProgress();
                    
                    alert('Trip started! Don\'t forget to complete it when you arrive.');
                } else {
                    // Still save locally even if server fails
                    showTripInProgress();
                    alert('Trip started locally. Server sync will retry when you complete the trip.');
                }
            });
        }
        
        function completeTrip() {
            if (!currentTripInProgress) {
                alert('No trip in progress.');
                return;
            }
            
            const endMiles = document.getElementById('tripEndMiles').value.trim();
            
            if (!endMiles) {
                alert('Please enter your ending odometer reading.');
                return;
            }
            
            const startMiles = parseFloat(currentTripInProgress.startMiles);
            const endMilesNum = parseFloat(endMiles);
            
            if (endMilesNum <= startMiles) {
                alert('End miles must be greater than start miles (' + startMiles.toLocaleString() + ').');
                return;
            }
            
            const totalMileage = endMilesNum - startMiles;
            
            if (totalMileage > 500) {
                if (!confirm(`Total mileage is ${totalMileage.toFixed(1)} miles. Is this correct?`)) {
                    return;
                }
            }
            
            showLoading('Completing Trip...', `Submitting ${totalMileage.toFixed(1)} miles`);
            
            // Update trip with end data
            const completedTrip = {
                ...currentTripInProgress,
                endMiles: endMiles,
                endDateTime: new Date().toISOString(),
                totalMileage: totalMileage.toFixed(1)
            };
            
            // Save to Google Sheet as "Submitted"
            saveTripToSheet(completedTrip, 'Submitted', completedTrip.id, function(success) {
                hideLoading();
                
                if (success) {
                    // Save last odometer
                    saveLastOdometer(completedTrip.employeeId, endMilesNum);
                    
                    // Clear trip in progress
                    currentTripInProgress = null;
                    localStorage.removeItem(TRIP_STORAGE_KEY);
                    
                    // Reset UI
                    hideTripInProgress();
                    
                    // Show success
                    document.getElementById('submitSuccess').classList.remove('hidden');
                    document.getElementById('successMessage').textContent = 
                        `Trip to ${completedTrip.clientName} completed: ${totalMileage.toFixed(1)} miles recorded.`;
                    
                    setTimeout(() => {
                        document.getElementById('submitSuccess').classList.add('hidden');
                    }, 5000);
                } else {
                    alert('Failed to submit trip. Please try again.');
                }
            });
        }
        
        function cancelTrip() {
            if (!confirm('Are you sure you want to cancel this trip? The entry will be deleted.')) {
                return;
            }
            
            showLoading('Cancelling Trip...', 'Removing entry');
            
            // If trip was saved to sheet, we need to delete it or mark as cancelled
            // For simplicity, we'll just remove locally - sheet entry stays as "In Progress"
            // which the review portal will handle
            
            currentTripInProgress = null;
            localStorage.removeItem(TRIP_STORAGE_KEY);
            
            hideLoading();
            hideTripInProgress();
            
            alert('Trip cancelled.');
        }
        
        function saveTripToSheet(trip, status, existingId, callback) {
            // Build the data payload
            const params = new URLSearchParams();
            params.append('action', 'submitManualMileage');
            params.append('employeeId', trip.employeeId);
            params.append('firstName', trip.firstName);
            params.append('lastName', trip.lastName);
            params.append('clientName', trip.clientName);
            params.append('reason', trip.reason);
            params.append('date', trip.startDateTime.split('T')[0]);
            params.append('time', new Date(trip.startDateTime).toTimeString().slice(0, 5));
            params.append('startMiles', trip.startMiles);
            params.append('endMiles', trip.endMiles || '');
            params.append('totalMileage', trip.totalMileage || '0');
            params.append('status', status);
            params.append('tripId', trip.id);
            params.append('justification', trip.justification || '');
            
            if (existingId) {
                params.append('updateExisting', 'true');
                params.append('existingTripId', existingId);
            }
            
            const callbackName = 'tripCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                delete window[callbackName];
                callback(response && response.success);
            };
            
            const url = GOOGLE_SCRIPT_URL + '?' + params.toString() + '&callback=' + callbackName;
            
            const script = document.createElement('script');
            script.src = url;
            script.onerror = function() {
                delete window[callbackName];
                callback(false);
            };
            
            // Timeout
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    callback(true); // Assume success on timeout
                }
            }, 10000);
            
            document.body.appendChild(script);
        }
        
        // ==========================================
        // ODOMETER VALIDATION
        // ==========================================
        
        function getLastOdometer(employeeId) {
            const stored = localStorage.getItem(LAST_ODOMETER_KEY);
            if (!stored) return null;
            
            const data = JSON.parse(stored);
            return data[employeeId] || null;
        }
        
        function saveLastOdometer(employeeId, miles) {
            let stored = localStorage.getItem(LAST_ODOMETER_KEY);
            let data = stored ? JSON.parse(stored) : {};
            data[employeeId] = miles;
            localStorage.setItem(LAST_ODOMETER_KEY, JSON.stringify(data));
        }
        
        function showOdometerConflict(lastMiles, enteredMiles) {
            document.getElementById('lastEndMilesDisplay').textContent = lastMiles.toLocaleString() + ' mi';
            document.getElementById('enteredStartMilesDisplay').textContent = enteredMiles.toLocaleString() + ' mi';
            
            if (enteredMiles < lastMiles) {
                document.getElementById('odometerConflictMessage').textContent = 
                    'Your start miles are less than your last recorded end miles. This may indicate an error or a different vehicle.';
            } else {
                document.getElementById('odometerConflictMessage').textContent = 
                    'There is a large gap between your last recorded miles and current reading.';
            }
            
            // Reset selection
            selectedJustification = null;
            document.querySelectorAll('.justification-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('input[name="justification"]').forEach(radio => radio.checked = false);
            document.getElementById('justificationOtherText').style.display = 'none';
            document.getElementById('justificationOtherText').value = '';
            
            document.getElementById('odometerModal').classList.remove('hidden');
        }
        
        function closeOdometerModal() {
            document.getElementById('odometerModal').classList.add('hidden');
            pendingOdometerAction = null;
            selectedJustification = null;
        }
        
        function selectJustification(value) {
            selectedJustification = value;
            
            // Update UI
            document.querySelectorAll('.justification-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Check the radio
            const radio = event.currentTarget.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
            
            // Show/hide other input
            if (value === 'Other') {
                document.getElementById('justificationOtherText').style.display = 'block';
            } else {
                document.getElementById('justificationOtherText').style.display = 'none';
            }
        }
        
        function confirmOdometerJustification() {
            if (!selectedJustification) {
                alert('Please select a reason for the odometer discrepancy.');
                return;
            }
            
            let justification = selectedJustification;
            if (selectedJustification === 'Other') {
                const otherText = document.getElementById('justificationOtherText').value.trim();
                if (!otherText) {
                    alert('Please specify the reason.');
                    return;
                }
                justification = 'Other: ' + otherText;
            }
            
            closeOdometerModal();
            
            // Proceed with the pending action
            if (pendingOdometerAction) {
                if (pendingOdometerAction.type === 'startTrip') {
                    const { clientName, reason, startMiles } = pendingOdometerAction.data;
                    proceedStartTrip(clientName, reason, startMiles, justification);
                } else if (pendingOdometerAction.type === 'submitCompleted') {
                    proceedSubmitMileage(pendingOdometerAction.data.addAnother, justification);
                }
            }
        }
        
        // ==========================================
        // TAB NAVIGATION
        // ==========================================
        
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            
            // Show/hide tab content
            if (tabName === 'report') {
                document.getElementById('reportTab').classList.remove('hidden');
                document.getElementById('submitTab').classList.add('hidden');
            } else {
                document.getElementById('reportTab').classList.add('hidden');
                document.getElementById('submitTab').classList.remove('hidden');
                
                // Load saved employee info
                loadSavedEmployee();
                
                // Set default date and time to now
                setDateNow();
                setTimeNow();
            }
        }
        
        // ==========================================
        // VIEW MY REPORT NAVIGATION
        // ==========================================
        
        function goToViewReport() {
            // Get employee info from the Log Mileage form
            const employeeId = document.getElementById('submitEmployeeId').value.trim();
            const lastName = document.getElementById('submitLastName').value.trim();
            
            // Calculate current week number
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            const currentWeek = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            const currentYear = now.getFullYear();
            
            // Switch to View Report tab
            document.getElementById('reportTab').classList.remove('hidden');
            document.getElementById('submitTab').classList.add('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn:first-child').classList.add('active');
            
            // Pre-fill the View Report form with employee info
            if (employeeId) {
                document.getElementById('employeeId').value = employeeId;
            }
            if (lastName) {
                document.getElementById('lastName').value = lastName;
            }
            document.getElementById('weekNumber').value = currentWeek;
            document.getElementById('year').value = currentYear;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // If we have employee info, auto-load the report
            if (employeeId && lastName) {
                setTimeout(function() {
                    loadReport();
                }, 300);
            }
        }
        
        // ==========================================
        // EMPLOYEE INFO REMEMBER
        // ==========================================
        
        function loadSavedEmployee() {
            const saved = JSON.parse(localStorage.getItem('savedEmployee') || 'null');
            if (saved) {
                document.getElementById('submitEmployeeId').value = saved.employeeId || '';
                document.getElementById('submitFirstName').value = saved.firstName || '';
                document.getElementById('submitLastName').value = saved.lastName || '';
                document.getElementById('rememberEmployee').checked = true;
                document.getElementById('clearInfoBtn').style.display = 'block';
            } else {
                document.getElementById('rememberEmployee').checked = false;
                document.getElementById('clearInfoBtn').style.display = 'none';
            }
        }
        
        function toggleRememberMe() {
            const checkbox = document.getElementById('rememberEmployee');
            if (checkbox.checked) {
                saveEmployeeInfo();
                document.getElementById('clearInfoBtn').style.display = 'block';
            } else {
                localStorage.removeItem('savedEmployee');
                document.getElementById('clearInfoBtn').style.display = 'none';
            }
        }
        
        function checkRememberMe() {
            // Auto-save if remember is checked
            if (document.getElementById('rememberEmployee').checked) {
                saveEmployeeInfo();
            }
        }
        
        function saveEmployeeInfo() {
            const employeeInfo = {
                employeeId: document.getElementById('submitEmployeeId').value.trim(),
                firstName: document.getElementById('submitFirstName').value.trim(),
                lastName: document.getElementById('submitLastName').value.trim()
            };
            localStorage.setItem('savedEmployee', JSON.stringify(employeeInfo));
        }
        
        function clearSavedEmployee() {
            localStorage.removeItem('savedEmployee');
            document.getElementById('submitEmployeeId').value = '';
            document.getElementById('submitFirstName').value = '';
            document.getElementById('submitLastName').value = '';
            document.getElementById('rememberEmployee').checked = false;
            document.getElementById('clearInfoBtn').style.display = 'none';
        }
        
        // ==========================================
        // DATE/TIME NOW BUTTONS
        // ==========================================
        
        function setDateNow() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('submitDate').value = today;
        }
        
        function setTimeNow() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('submitTime').value = hours + ':' + minutes;
        }
        
        // ==========================================
        // MILEAGE CALCULATION
        // ==========================================
        
        function calculateMileage() {
            const startMiles = parseFloat(document.getElementById('startMiles').value) || 0;
            const endMiles = parseFloat(document.getElementById('endMiles').value) || 0;
            
            let difference = endMiles - startMiles;
            
            // Ensure we don't show negative values
            if (difference < 0) {
                difference = 0;
            }
            
            document.getElementById('calculatedMileage').innerHTML = 
                difference.toFixed(1) + ' <span class="unit">mi</span>';
        }
        
        // ==========================================
        // SUBMIT MILEAGE ENTRY (Completed Trip)
        // ==========================================
        
        function submitMileageEntry(addAnother) {
            // Get form values
            const employeeId = document.getElementById('submitEmployeeId').value.trim();
            const firstName = document.getElementById('submitFirstName').value.trim();
            const lastName = document.getElementById('submitLastName').value.trim();
            const clientName = document.getElementById('submitClientName').value.trim();
            const reason = document.getElementById('submitReason').value;
            const date = document.getElementById('submitDate').value;
            const time = document.getElementById('submitTime').value;
            const startMiles = parseFloat(document.getElementById('startMiles').value) || 0;
            const endMiles = parseFloat(document.getElementById('endMiles').value) || 0;
            
            // Validation
            if (!employeeId) {
                alert('Please enter your Employee ID');
                document.getElementById('submitEmployeeId').focus();
                return;
            }
            if (!firstName) {
                alert('Please enter your First Name');
                document.getElementById('submitFirstName').focus();
                return;
            }
            if (!lastName) {
                alert('Please enter your Last Name');
                document.getElementById('submitLastName').focus();
                return;
            }
            if (!clientName) {
                alert('Please enter the Client Name');
                document.getElementById('submitClientName').focus();
                return;
            }
            if (!reason) {
                alert('Please select a reason');
                document.getElementById('submitReason').focus();
                return;
            }
            if (!date) {
                alert('Please enter the date');
                document.getElementById('submitDate').focus();
                return;
            }
            if (!time) {
                alert('Please enter the time');
                document.getElementById('submitTime').focus();
                return;
            }
            if (!startMiles || startMiles <= 0) {
                alert('Please enter valid start miles');
                document.getElementById('startMiles').focus();
                return;
            }
            if (!endMiles || endMiles <= 0) {
                alert('Please enter valid end miles');
                document.getElementById('endMiles').focus();
                return;
            }
            if (endMiles <= startMiles) {
                alert('End miles must be greater than start miles');
                document.getElementById('endMiles').focus();
                return;
            }
            
            // Check odometer against last recorded
            const lastOdometer = getLastOdometer(employeeId);
            if (lastOdometer && startMiles < lastOdometer) {
                // Show conflict modal
                pendingOdometerAction = { type: 'submitCompleted', data: { addAnother } };
                showOdometerConflict(lastOdometer, startMiles);
                return;
            }
            
            // Proceed with submission
            proceedSubmitMileage(addAnother, null);
        }
        
        function proceedSubmitMileage(addAnother, justification) {
            // Get form values again
            const employeeId = document.getElementById('submitEmployeeId').value.trim();
            const firstName = document.getElementById('submitFirstName').value.trim();
            const lastName = document.getElementById('submitLastName').value.trim();
            const clientName = document.getElementById('submitClientName').value.trim();
            const reason = document.getElementById('submitReason').value;
            const date = document.getElementById('submitDate').value;
            const time = document.getElementById('submitTime').value;
            const startMiles = parseFloat(document.getElementById('startMiles').value) || 0;
            const endMiles = parseFloat(document.getElementById('endMiles').value) || 0;
            
            const totalMileage = (endMiles - startMiles).toFixed(1);
            
            // Show loading overlay
            showLoading('Submitting Mileage...', `Recording ${totalMileage} miles for ${clientName}`);
            
            // Disable buttons
            const submitBtn = document.getElementById('submitMileageBtn');
            const addAnotherBtn = document.getElementById('submitAddAnotherBtn');
            submitBtn.disabled = true;
            addAnotherBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ Submitting...';
            addAnotherBtn.innerHTML = '‚è≥ Submitting...';
            
            // Prepare data
            const data = {
                action: 'submitManualMileage',
                employeeId: employeeId,
                firstName: firstName,
                lastName: lastName,
                clientName: clientName,
                reason: reason,
                date: date,
                time: time,
                startMiles: startMiles,
                endMiles: endMiles,
                totalMileage: parseFloat(totalMileage),
                submittedAt: new Date().toISOString(),
                justification: justification || ''
            };
            
            console.log('Submitting mileage entry:', data);
            
            // Use JSONP (GET request) for reliable cross-origin submission
            const callbackName = 'mileageSubmitCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                console.log('Mileage submission response:', response);
                
                // Hide loading overlay
                hideLoading();
                
                // Clean up
                delete window[callbackName];
                const scriptEl = document.getElementById('submit_script');
                if (scriptEl) scriptEl.remove();
                
                if (response.success) {
                    handleSubmitSuccess(data, totalMileage, addAnother, endMiles);
                } else {
                    alert('Error submitting mileage: ' + (response.message || 'Unknown error'));
                    // Re-enable buttons
                    submitBtn.disabled = false;
                    addAnotherBtn.disabled = false;
                    submitBtn.innerHTML = '‚úì Submit Mileage';
                    addAnotherBtn.innerHTML = '‚úì Submit & Add Another Client';
                }
            };
            
            // Build URL with all parameters
            const params = new URLSearchParams({
                action: 'submitManualMileage',
                employeeId: employeeId,
                firstName: firstName,
                lastName: lastName,
                clientName: clientName,
                reason: reason,
                date: date,
                time: time,
                startMiles: startMiles,
                endMiles: endMiles,
                totalMileage: totalMileage,
                justification: justification || '',
                status: 'Submitted',
                callback: callbackName
            });
            
            const script = document.createElement('script');
            script.id = 'submit_script';
            script.src = GOOGLE_SCRIPT_URL + '?' + params.toString();
            
            script.onerror = function() {
                console.error('Script load error');
                hideLoading();
                delete window[callbackName];
                // Assume success since the request was made
                handleSubmitSuccess(data, totalMileage, addAnother, endMiles);
            };
            
            // Add timeout in case callback never fires
            setTimeout(function() {
                if (window[callbackName]) {
                    console.log('Submission timeout - assuming success');
                    hideLoading();
                    delete window[callbackName];
                    handleSubmitSuccess(data, totalMileage, addAnother, endMiles);
                }
            }, 10000);
            
            document.head.appendChild(script);
        }
        
        function handleSubmitSuccess(data, totalMileage, addAnother, lastEndMiles) {
            // Hide loading (in case not already hidden)
            hideLoading();
            
            // Save last odometer reading for this employee
            saveLastOdometer(data.employeeId, lastEndMiles);
            
            // Save to local storage for recent entries display
            saveRecentEntry({
                date: data.date,
                time: data.time,
                clientName: data.clientName,
                reason: data.reason,
                mileage: totalMileage,
                status: 'Submitted'
            });
            
            // Show success message
            const successDiv = document.getElementById('submitSuccess');
            const successMsg = document.getElementById('successMessage');
            successDiv.classList.remove('hidden');
            
            if (addAnother) {
                successMsg.textContent = `Entry for ${data.clientName} recorded! Ready for next client.`;
            } else {
                successMsg.textContent = 'Your entry has been recorded.';
            }
            
            // Re-enable buttons
            const submitBtn = document.getElementById('submitMileageBtn');
            const addAnotherBtn = document.getElementById('submitAddAnotherBtn');
            submitBtn.disabled = false;
            addAnotherBtn.disabled = false;
            submitBtn.innerHTML = '‚úì Submit Mileage';
            addAnotherBtn.innerHTML = '‚úì Submit & Add Another Client';
            
            if (addAnother) {
                // Clear only trip-specific fields, keep employee info and date
                document.getElementById('submitClientName').value = '';
                document.getElementById('submitReason').value = '';
                
                // Set start miles to previous end miles for next trip
                document.getElementById('startMiles').value = lastEndMiles;
                document.getElementById('endMiles').value = '';
                document.getElementById('calculatedMileage').innerHTML = '0.0 <span class="unit">mi</span>';
                
                // Update time to now for the next entry
                setTimeNow();
                
                // Focus on client name for quick entry
                document.getElementById('submitClientName').focus();
                
                // Scroll to top of form
                document.querySelector('.mobile-entry-section').scrollIntoView({ behavior: 'smooth' });
            } else {
                // Full reset
                document.getElementById('submitClientName').value = '';
                document.getElementById('submitReason').value = '';
                document.getElementById('startMiles').value = '';
                document.getElementById('endMiles').value = '';
                document.getElementById('calculatedMileage').innerHTML = '0.0 <span class="unit">mi</span>';
                
                // Set new date/time
                setDateNow();
                setTimeNow();
            }
            
            // Hide success after 3 seconds
            setTimeout(function() {
                document.getElementById('submitSuccess').classList.add('hidden');
            }, 3000);
        }
        
        // ==========================================
        // RECENT ENTRIES (LOCAL STORAGE) - Keep for data persistence
        // ==========================================
        
        function saveRecentEntry(entry) {
            let entries = JSON.parse(localStorage.getItem('mileageEntries') || '[]');
            entries.unshift(entry); // Add to beginning
            entries = entries.slice(0, 50); // Keep last 50 for history
            localStorage.setItem('mileageEntries', JSON.stringify(entries));
        }
        
        // ==========================================
        // REPORT TAB FUNCTIONS (EXISTING)
        // ==========================================

        function loadReport() {
            const employeeId = document.getElementById('employeeId').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const weekNumber = document.getElementById('weekNumber').value.trim();
            const year = document.getElementById('year').value.trim();

            console.log('=== LOADING REPORT ===');
            console.log('Employee ID:', employeeId);
            console.log('Last Name:', lastName);
            console.log('Week:', weekNumber);
            console.log('Year:', year);

            if (!employeeId || !lastName || !weekNumber || !year) {
                alert('Please fill in all required fields');
                return;
            }

            // Show loading overlay
            showLoading('Loading Report...', `Week ${weekNumber} of ${year} for Employee ${employeeId}`);

            // Show loading state in the page as well
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('reportSection').classList.add('hidden');
            document.getElementById('manualEntriesSection').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            // Track completion of both requests
            let onCallComplete = false;
            let manualComplete = false;
            let hasOnCallServices = false;
            let hasManualEntries = false;
            
            function checkBothComplete() {
                if (onCallComplete && manualComplete) {
                    // Hide loading overlay
                    hideLoading();
                    document.getElementById('loadingState').classList.add('hidden');
                    
                    // Show empty state only if BOTH are empty
                    if (!hasOnCallServices && !hasManualEntries) {
                        document.getElementById('emptyState').classList.remove('hidden');
                    }
                }
            }

            // ========== LOAD ON-CALL SERVICES ==========
            const callbackName = 'mileageCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                console.log('Report data received via JSONP:', data);
                
                // Clean up
                delete window[callbackName];
                const scriptElement = document.getElementById('jsonp_script');
                if (scriptElement) {
                    scriptElement.remove();
                }
                
                // Process data
                currentReport = data;
                adjustments = {};
                
                if (data.error) {
                    console.error('Backend error:', data.error);
                    onCallComplete = true;
                    checkBothComplete();
                    return;
                }
                
                // Check if we have on-call services
                hasOnCallServices = data.services && data.services.length > 0;
                
                if (hasOnCallServices) {
                    displayReport(data);
                }
                
                onCallComplete = true;
                checkBothComplete();
            };
            
            // Create script tag for JSONP request
            const script = document.createElement('script');
            script.id = 'jsonp_script';
            script.type = 'text/javascript';
            script.src = GOOGLE_SCRIPT_URL + 
                '?action=getReport' +
                '&employeeId=' + encodeURIComponent(employeeId) +
                '&lastName=' + encodeURIComponent(lastName) +
                '&week=' + encodeURIComponent(weekNumber) +
                '&year=' + encodeURIComponent(year) +
                '&callback=' + callbackName;
            
            script.onerror = function() {
                console.error('JSONP request failed');
                delete window[callbackName];
                onCallComplete = true;
                checkBothComplete();
            };
            
            console.log('Loading on-call services via JSONP:', script.src);
            document.head.appendChild(script);
            
            // ========== LOAD MANUAL MILEAGE ENTRIES ==========
            const manualCallbackName = 'manualMileageCallback_' + Date.now();
            
            window[manualCallbackName] = function(data) {
                console.log('Manual mileage data received:', data);
                
                // Clean up
                delete window[manualCallbackName];
                const scriptElement = document.getElementById('jsonp_manual_script');
                if (scriptElement) {
                    scriptElement.remove();
                }
                
                // Entries are already filtered by week/year on the backend
                const entries = data.entries || [];
                hasManualEntries = entries.length > 0;
                
                console.log('Manual entries found:', entries.length);
                
                if (hasManualEntries) {
                    displayManualEntries(entries);
                }
                
                manualComplete = true;
                checkBothComplete();
            };
            
            // Create script tag for manual mileage JSONP request
            const manualScript = document.createElement('script');
            manualScript.id = 'jsonp_manual_script';
            manualScript.type = 'text/javascript';
            manualScript.src = GOOGLE_SCRIPT_URL + 
                '?action=getManualMileage' +
                '&employeeId=' + encodeURIComponent(employeeId) +
                '&week=' + encodeURIComponent(weekNumber) +
                '&year=' + encodeURIComponent(year) +
                '&callback=' + manualCallbackName;
            
            manualScript.onerror = function() {
                console.error('Manual mileage JSONP request failed');
                delete window[manualCallbackName];
                manualComplete = true;
                checkBothComplete();
            };
            
            console.log('Loading manual entries via JSONP:', manualScript.src);
            document.head.appendChild(manualScript);
        }
        
        function displayManualEntries(entries) {
            document.getElementById('manualEntriesSection').classList.remove('hidden');
            
            // Calculate totals
            let totalMileage = 0;
            entries.forEach(entry => {
                totalMileage += parseFloat(entry.totalMileage || 0);
            });
            
            // Build table
            let html = `
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background: #1A365C; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Date/Time</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Client</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Reason</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600;">Mileage</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600;">Status</th>
                    </tr>
                </thead>
                <tbody>`;
            
            entries.forEach((entry, index) => {
                const rowBg = index % 2 === 0 ? 'white' : '#F8FAFC';
                let dateFormatted = '-';
                
                if (entry.date) {
                    try {
                        dateFormatted = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        });
                    } catch (e) {
                        dateFormatted = entry.date;
                    }
                }
                
                html += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #E5ECF3;">
                        <td style="padding: 12px; font-size: 13px; color: #3D3D3D;">
                            ${dateFormatted}<br>
                            <span style="font-size: 11px; color: #9CA3AF;">${entry.time || ''}</span>
                        </td>
                        <td style="padding: 12px; font-size: 13px; color: #1A365C; font-weight: 500;">
                            ${entry.clientName || '-'}
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #3D3D3D;">
                            ${entry.reason || '-'}
                        </td>
                        <td style="padding: 12px; font-size: 14px; color: #1A365C; font-weight: 600; text-align: right;">
                            ${parseFloat(entry.totalMileage || 0).toFixed(1)} mi
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: #D4F4E2; color: #62B790; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">
                                ‚úì Submitted
                            </span>
                        </td>
                    </tr>`;
            });
            
            html += `
                </tbody>
                <tfoot>
                    <tr style="background: #E5ECF3; font-weight: 600;">
                        <td style="padding: 12px; font-size: 14px; color: #1A365C;" colspan="3">
                            MANUAL ENTRIES TOTAL
                        </td>
                        <td style="padding: 12px; font-weight: 700; font-size: 16px; color: #F57600; text-align: right;">
                            ${totalMileage.toFixed(1)} mi
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #3D3D3D; text-align: center;">
                            ${entries.length} entr${entries.length !== 1 ? 'ies' : 'y'}
                        </td>
                    </tr>
                </tfoot>
            </table>`;
            
            document.getElementById('manualEntriesList').innerHTML = html;
            
            // Stats section - only show entries count and total miles
            document.getElementById('manualEntriesStats').innerHTML = `
                <div class="manual-stat-item">
                    <div class="stat-label">Manual Entries</div>
                    <div class="stat-value">${entries.length}</div>
                </div>
                <div class="manual-stat-item">
                    <div class="stat-label">Total Miles</div>
                    <div class="stat-value highlight">${totalMileage.toFixed(1)}</div>
                </div>
            `;
        }

        function displayReport(data) {
            // Hide loading, show report
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('reportSection').classList.remove('hidden');

            // Calculate totals (excluding commute services)
            let originalTotal = 0;
            let adjustedTotal = 0;
            let reimbursableServices = 0;
            let commuteServices = 0;
            
            data.services.forEach(function(service) {
                const mileage = parseFloat(service.Mileage || 0);
                const adjusted = service.Adjusted_Mileage ? parseFloat(service.Adjusted_Mileage) : mileage;
                const isCommute = service.isCommute === true;
                
                if (isCommute) {
                    commuteServices++;
                } else {
                    originalTotal += mileage;
                    adjustedTotal += adjusted;
                    reimbursableServices++;
                }
            });

            // Update stats
            document.getElementById('totalServices').textContent = reimbursableServices;
            document.getElementById('originalMileage').textContent = originalTotal.toFixed(2);
            document.getElementById('adjustedMileage').textContent = adjustedTotal.toFixed(2);
            document.getElementById('reportStatus').textContent = data.approved ? 'Submitted' : 'Pending';
            document.getElementById('reportStatus').style.color = data.approved ? '#62B790' : '#F57600';

            // Build services table
            let servicesHtml = `
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background: #1A365C; color: white;">
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Date/Time</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Client</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600;">Original Mi</th>
                        <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600;">Adjusted Mi</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600;">Reason</th>
                    </tr>
                </thead>
                <tbody>`;

            data.services.forEach(function(service, index) {
                const isCommute = service.isCommute === true;
                const isSubmitted = data.approved || data.isApproved;
                const rowBg = isCommute ? '#F5F5F5' : (index % 2 === 0 ? 'white' : '#F8FAFC');
                const textColor = isCommute ? '#9CA3AF' : '#3D3D3D';
                
                // For adjusted mileage column
                let adjustedMileageCell;
                if (isCommute) {
                    adjustedMileageCell = '<span style="color: #9CA3AF; font-size: 12px;">N/A</span>';
                } else if (isSubmitted) {
                    // Show as read-only text for submitted reports
                    const adjValue = service.Adjusted_Mileage || service.Mileage;
                    adjustedMileageCell = `<span style="font-weight: 600; color: #1A365C;">${parseFloat(adjValue).toFixed(2)}</span>`;
                } else {
                    // Show editable input for pending reports
                    const inputValue = parseFloat(service.Adjusted_Mileage || service.Mileage).toFixed(2);
                    adjustedMileageCell = `<input type="number" 
                        id="adj_${index}" 
                        value="${inputValue}" 
                        step="0.01" 
                        min="0"
                        style="width: 70px; padding: 6px 8px; border: 1px solid #D3D7DF; border-radius: 6px; font-size: 13px; text-align: center;"
                        onchange="updateAdjustment(${index}, this.value)">`;
                }
                
                // For reason column
                let reasonCell;
                if (isCommute) {
                    reasonCell = '<span style="color: #9CA3AF; font-size: 12px; font-style: italic;">First service - not reimbursable</span>';
                } else if (isSubmitted) {
                    // Show as read-only text for submitted reports
                    const reasonValue = service.Adjustment_Reason || '-';
                    reasonCell = `<span style="font-size: 12px; color: #3D3D3D;">${reasonValue}</span>`;
                } else {
                    // Show editable input for pending reports
                    reasonCell = `<input type="text" 
                        id="reason_${index}" 
                        value="${service.Adjustment_Reason || ''}" 
                        placeholder="Reason if adjusted"
                        style="width: 100%; padding: 6px 8px; border: 1px solid #D3D7DF; border-radius: 6px; font-size: 12px;">`;
                }
                
                servicesHtml += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #E5ECF3;">
                        <td style="padding: 12px; font-size: 13px; color: ${textColor};">
                            ${formatDate(service.Scheduled_Date)}<br>
                            <span style="font-size: 11px; color: #9CA3AF;">${formatTime(service.Scheduled_Time)}</span>
                            ${isCommute ? '<br><span style="font-size: 10px; background: #E5ECF3; color: #9CA3AF; padding: 2px 6px; border-radius: 4px;">COMMUTE</span>' : ''}
                        </td>
                        <td style="padding: 12px; font-size: 13px; color: ${textColor};">
                            ${service.Service_Recipient_First_Name || '-'}
                        </td>
                        <td style="padding: 12px; font-size: 13px; color: ${textColor}; text-align: right;">
                            ${parseFloat(service.Mileage || 0).toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${adjustedMileageCell}
                        </td>
                        <td style="padding: 12px;">
                            ${reasonCell}
                        </td>
                    </tr>`;
            });

            servicesHtml += `
                </tbody>
                <tfoot>
                    <tr style="background: #E5ECF3; font-weight: 600;">
                        <td style="padding: 12px; font-size: 14px; color: #1A365C;" colspan="2">
                            TOTALS (Reimbursable Only)
                        </td>
                        <td style="padding: 12px; font-weight: 700; font-size: 16px; color: #1A365C; text-align: right;">
                            ${originalTotal.toFixed(2)} mi
                        </td>
                        <td style="padding: 12px; font-weight: 700; font-size: 16px; color: #F57600; text-align: center;">
                            ${adjustedTotal.toFixed(2)} mi
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #3D3D3D; text-align: center;">
                            ${reimbursableServices} reimbursable service${reimbursableServices !== 1 ? 's' : ''}
                            ${commuteServices > 0 ? '<br><span style="color: #9CA3AF; font-size: 11px;">(' + commuteServices + ' commute excluded)</span>' : ''}
                        </td>
                    </tr>
                </tfoot>
            </table>`;

            document.getElementById('servicesList').innerHTML = servicesHtml;
            
            // Pre-populate adjustments object with existing values
            adjustments = {};
            for (let i = 0; i < data.services.length; i++) {
                if (data.services[i].Adjusted_Mileage) {
                    adjustments[i] = {
                        adjustedMileage: parseFloat(data.services[i].Adjusted_Mileage)
                    };
                }
            }

            // Disable approve button if already submitted
            if (data.approved || data.isApproved) {
                document.getElementById('approveBtn').disabled = true;
                document.getElementById('approveBtn').textContent = '‚úì Report Already Submitted';
                document.getElementById('approveBtn').style.background = '#9CA3AF';
                document.getElementById('approveBtn').style.cursor = 'not-allowed';
                document.querySelector('.approval-section h3').textContent = 'Report Submitted';
                document.querySelector('.approval-section p').textContent = 'This report has been submitted and cannot be modified.';
                document.querySelector('.approval-section').style.background = '#D4F4E2';
            } else {
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('approveBtn').textContent = 'Submit Report';
                document.getElementById('approveBtn').style.background = '#62B790';
                document.getElementById('approveBtn').style.cursor = 'pointer';
                document.querySelector('.approval-section h3').textContent = 'Ready to Submit?';
                document.querySelector('.approval-section p').textContent = 'Once you submit this report, the mileage data will be finalized and submitted for processing.';
                document.querySelector('.approval-section').style.background = '#E5ECF3';
            }
        }

        function updateAdjustment(index, value) {
            const inputEl = document.getElementById('adj_' + index);
            
            if (!value || value === '') {
                delete adjustments[index];
            } else {
                if (!adjustments[index]) {
                    adjustments[index] = {};
                }
                const parsedValue = parseFloat(value);
                adjustments[index].adjustedMileage = parsedValue;
                
                // Format the input to 2 decimal places
                if (inputEl) {
                    inputEl.value = parsedValue.toFixed(2);
                }
            }
            
            // Recalculate total adjusted mileage (excluding commute services)
            let adjustedTotal = 0;
            for (let i = 0; i < currentReport.services.length; i++) {
                const service = currentReport.services[i];
                const isCommute = service.isCommute === true;
                
                // Skip commute services in total calculation
                if (!isCommute) {
                    if (adjustments[i] && adjustments[i].adjustedMileage) {
                        adjustedTotal += adjustments[i].adjustedMileage;
                    } else {
                        adjustedTotal += parseFloat(service.Mileage || 0);
                    }
                }
            }
            document.getElementById('adjustedMileage').textContent = adjustedTotal.toFixed(2);
            
            // Update the table footer as well
            const footerCell = document.querySelector('tfoot td:nth-child(3)');
            if (footerCell) {
                footerCell.textContent = adjustedTotal.toFixed(2) + ' mi';
            }
        }

        function approveReport() {
            if (!currentReport) {
                alert('No report loaded');
                return;
            }
            
            // Check if report is already submitted
            if (currentReport.approved || currentReport.isApproved) {
                alert('This report has already been submitted. No further changes can be made.');
                return;
            }
            
            // Double check by looking at the button state
            const approveBtn = document.getElementById('approveBtn');
            if (approveBtn.disabled) {
                alert('This report has already been submitted.');
                return;
            }

            if (!confirm('Are you sure you want to submit this mileage report? This action cannot be undone.')) {
                return;
            }

            const employeeId = document.getElementById('employeeId').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const weekNumber = document.getElementById('weekNumber').value.trim();
            const year = document.getElementById('year').value.trim();

            // Validate: If adjustment made, reason must be provided
            for (let i = 0; i < currentReport.services.length; i++) {
                const service = currentReport.services[i];
                const isCommute = service.isCommute === true;
                
                // Skip commute services
                if (isCommute) {
                    continue;
                }
                
                const adj = adjustments[i] || {};
                const reasonEl = document.getElementById('reason_' + i);
                const reason = reasonEl ? reasonEl.value.trim() : '';
                const originalMileage = parseFloat(service.Mileage);
                const adjustedMileage = adj.adjustedMileage;
                
                // Check if adjustment was made (adjusted value differs from original)
                if (adjustedMileage && Math.abs(adjustedMileage - originalMileage) > 0.01) {
                    if (!reason) {
                        alert('Please provide a reason for the mileage adjustment on ' + formatDate(service.Scheduled_Date) + ' at ' + formatTime(service.Scheduled_Time) + ' (' + service.Service_Recipient_First_Name + ')');
                        if (reasonEl) {
                            reasonEl.focus();
                            reasonEl.style.border = '2px solid #FF7475';
                        }
                        return;
                    }
                }
            }

            // Prepare adjustment data (only for non-commute services)
            const adjustmentData = [];
            for (let i = 0; i < currentReport.services.length; i++) {
                const service = currentReport.services[i];
                const isCommute = service.isCommute === true;
                
                // Skip commute services - they don't get saved to the sheet
                if (isCommute) {
                    continue;
                }
                
                const adj = adjustments[i] || {};
                const reasonEl = document.getElementById('reason_' + i);
                const reason = reasonEl ? reasonEl.value.trim() : '';
                
                adjustmentData.push({
                    scheduledDate: service.Scheduled_Date,
                    scheduledTime: service.Scheduled_Time,
                    originalMileage: service.Mileage,
                    adjustedMileage: adj.adjustedMileage || service.Mileage,
                    adjustmentReason: reason
                });
            }

            const data = {
                action: 'approve',
                employeeId: employeeId,
                lastName: lastName,
                week: weekNumber,
                year: year,
                adjustments: adjustmentData,
                approvalDate: new Date().toISOString()
            };

            console.log('=== SUBMITTING APPROVAL ===');
            console.log('Data:', JSON.stringify(data, null, 2));
            
            // Show loading overlay
            showLoading('Submitting Report...', 'Finalizing your mileage report');
            
            // Disable button immediately to prevent double-click
            approveBtn.disabled = true;
            approveBtn.textContent = 'Submitting...';
            approveBtn.style.background = '#9CA3AF';

            // Use no-cors mode for POST (same as time-off system)
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(function() {
                console.log('POST request completed (no-cors mode)');
                hideLoading();
                alert('Report submitted successfully!');
                
                // Reload report to show submitted status
                loadReport();
            })
            .catch(function(error) {
                console.error('POST request error:', error);
                hideLoading();
                // In no-cors mode, we can't distinguish success from failure
                // Assume success and reload
                alert('Report submitted successfully!');
                loadReport();
            });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short',
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function formatTime(timeValue) {
            // Handle Google Sheets time format (serial number or datetime string)
            if (!timeValue) return '';
            
            try {
                // If it's already a string in HH:MM format, return it
                if (typeof timeValue === 'string' && /^\d{1,2}:\d{2}/.test(timeValue)) {
                    return timeValue;
                }
                
                // Convert to Date object
                let date;
                if (typeof timeValue === 'string') {
                    date = new Date(timeValue);
                } else if (typeof timeValue === 'number') {
                    // Google Sheets serial time (fraction of a day)
                    const hours = Math.floor(timeValue * 24);
                    const minutes = Math.floor((timeValue * 24 * 60) % 60);
                    return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                } else if (timeValue instanceof Date) {
                    date = timeValue;
                } else {
                    return String(timeValue);
                }
                
                // Extract time in HH:MM format
                const hours = date.getHours();
                const minutes = date.getMinutes();
                return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                
            } catch (error) {
                console.error('Error formatting time:', error, timeValue);
                return String(timeValue);
            }
        }

        // Set current year as default
        document.getElementById('year').value = new Date().getFullYear();
        
        // Initialize trip state on page load
        initializeTripState();
    </script>
</body>
</html>
