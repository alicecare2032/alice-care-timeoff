<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alice.care - HR Dashboard v.45</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #E5ECF3;
            min-height: 100vh;
            padding: 20px;
        }
        
        .nav-bar {
            max-width: 1400px;
            margin: 0 auto 20px;
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
        }
        
        .logo .alice {
            color: #F57600;
            font-weight: 700;
        }
        
        .logo .dot {
            color: #F57600;
            font-weight: 700;
            margin: 0 -2px;
        }
        
        .logo .care {
            color: #1A365C;
            font-weight: 400;
        }
        
        .back-link {
            color: #1A365C;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: #E5ECF3;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15);
            overflow: hidden;
        }
        
        .header {
            background: #1A365C;
            color: white;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #E5ECF3;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #F57600;
        }
        
        .stat-card h3 {
            font-size: 12px;
            color: #3D3D3D;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .stat-card .number {
            font-size: 28px;
            color: #1A365C;
            font-weight: 700;
        }
        
        .filters-section {
            padding: 25px 30px;
            background: white;
            border-bottom: 2px solid #E5ECF3;
        }
        
        .filters-title {
            font-size: 16px;
            color: #1A365C;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 13px;
            color: #1A365C;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            padding: 10px 14px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .filter-actions .btn {
            flex: 1;
            min-width: 140px;
        }
        
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #F57600;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d00;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #E5ECF3;
            color: #1A365C;
        }
        
        .btn-secondary:hover {
            background: #d5dce6;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-view-details {
            background: #1A365C;
            color: white;
        }
        
        .btn-view-details:hover {
            background: #2d4a73;
        }
        
        /* New Single Line Table Style */
        .requests-table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        .requests-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        
        .requests-table thead {
            background: #1A365C;
            color: white;
        }
        
        .requests-table thead th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .requests-table thead th:first-child {
            border-radius: 8px 0 0 8px;
        }
        
        .requests-table thead th:last-child {
            border-radius: 0 8px 8px 0;
        }
        
        .requests-table thead th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }
        
        .requests-table thead th.sortable:hover {
            background: #2d4a73;
        }
        
        .requests-table thead th .sort-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.5;
        }
        
        .requests-table thead th.sort-asc .sort-icon,
        .requests-table thead th.sort-desc .sort-icon {
            opacity: 1;
        }
        
        .requests-table tbody tr {
            background: white;
            border: 2px solid #E5ECF3;
            transition: all 0.3s;
        }
        
        .requests-table tbody tr:hover {
            border-color: #F57600;
            box-shadow: 0 2px 8px rgba(245, 118, 0, 0.1);
        }
        
        .requests-table tbody td {
            padding: 15px;
            font-size: 14px;
            color: #1A365C;
        }
        
        .requests-table tbody tr td:first-child {
            border-radius: 8px 0 0 8px;
        }
        
        .requests-table tbody tr td:last-child {
            border-radius: 0 8px 8px 0;
        }
        
        .request-id-cell {
            font-size: 12px;
            color: #3D3D3D;
            font-weight: 500;
        }
        
        .employee-name-cell {
            font-weight: 600;
            color: #1A365C;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        
        .badge-vacation {
            background: #E0F1E9;
            color: #62B790;
        }
        
        .badge-sick {
            background: #FFE3E3;
            color: #FF7475;
        }
        
        .badge-pending {
            background: #FFF3E0;
            color: #F57600;
        }
        
        .badge-reviewed {
            background: #E3F2FD;
            color: #2196F3;
        }
        
        .badge-approved {
            background: #E0F1E9;
            color: #62B790;
        }
        
        .badge-rejected {
            background: #FFE3E3;
            color: #FF7475;
        }
        
        .hours-cell {
            font-weight: 600;
            color: #F57600;
        }
        
        /* Detail Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: #1A365C;
            color: white;
            padding: 25px 30px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .close {
            color: white;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #F57600;
        }
        
        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-section h3 {
            font-size: 16px;
            color: #1A365C;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E5ECF3;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .detail-item {
            font-size: 13px;
        }
        
        .detail-label {
            color: #3D3D3D;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .detail-value {
            color: #1A365C;
            font-weight: 600;
        }
        
        .services-list {
            background: #E5ECF3;
            padding: 15px;
            border-radius: 8px;
        }
        
        .service-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .service-item:last-child {
            margin-bottom: 0;
        }
        
        .services-total {
            background: #1A365C;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }
        
        .status-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-box {
            background: #F9F9F9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #D3D7DF;
        }
        
        .status-box.reviewed {
            border-left-color: #2196F3;
            background: #E3F2FD;
        }
        
        .status-box.approved {
            border-left-color: #62B790;
            background: #E0F1E9;
        }
        
        .status-box.rejected {
            border-left-color: #FF7475;
            background: #FFE3E3;
        }
        
        .status-box h5 {
            font-size: 12px;
            color: #3D3D3D;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .status-box .value {
            font-size: 14px;
            color: #1A365C;
            font-weight: 600;
        }
        
        .modal-actions-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .btn-review {
            background: #2196F3;
            color: white;
        }
        
        .btn-review:hover {
            background: #1976D2;
        }
        
        .btn-approve {
            background: #62B790;
            color: white;
        }
        
        .btn-approve:hover {
            background: #54a07e;
        }
        
        .btn-reject {
            background: #FF7475;
            color: white;
        }
        
        .btn-reject:hover {
            background: #ff5c5d;
        }
        
        .btn-export {
            background: #62B790;
            color: white;
        }
        
        .btn-export:hover {
            background: #54a07e;
            transform: translateY(-2px);
        }
        
        /* Action Modals (Review, Approve, Reject) */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1A365C;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
        }
        
        .action-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }
        
        .action-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .action-modal-header h2 {
            font-size: 22px;
            color: #1A365C;
            font-weight: 600;
        }
        
        .action-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #3D3D3D;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        .notice-box {
            background: #E5ECF3;
            border-left: 4px solid #F57600;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 30px;
        }
        
        .notice-box h3 {
            color: #1A365C;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .notice-box p {
            color: #3D3D3D;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .notice-box p:last-child {
            margin-bottom: 0;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        @media (max-width: 768px) {
            .nav-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .requests-table-container {
                padding: 15px;
            }
            
            .requests-table {
                font-size: 12px;
            }
            
            .requests-table thead th,
            .requests-table tbody td {
                padding: 10px 8px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="logo">
            <span class="alice">alice</span><span class="dot">.</span><span class="care">care</span>
        </div>
        <a href="index.html" class="back-link">← Back to Employee Portal</a>
    </div>

    <div class="container">
        <div class="header">
            <h1>HR Dashboard - Time Off Management</h1>
            <p>Review and approve employee time off requests</p>
        </div>
        
        <div class="stats-row">
            <div class="stat-card">
                <h3>Total Requests</h3>
                <div class="number" id="totalRequests">0</div>
            </div>
            <div class="stat-card">
                <h3>Pending Review</h3>
                <div class="number" id="pendingRequests">0</div>
            </div>
            <div class="stat-card">
                <h3>Reviewed</h3>
                <div class="number" id="reviewedRequests">0</div>
            </div>
            <div class="stat-card">
                <h3>Approved</h3>
                <div class="number" id="approvedRequests">0</div>
            </div>
            <div class="stat-card">
                <h3>Not Eligible</h3>
                <div class="number" id="rejectedRequests">0</div>
            </div>
        </div>
        
        <div class="notice-box">
            <h3>Status Definitions</h3>
            <p><strong>Reviewed:</strong> Time off Approved</p>
            <p><strong>Not Eligible:</strong> Not eligible for sick/vacation hours</p>
            <p><strong>Approved:</strong> Vacation/sick hours will be paid based on accrued available hours and company policy.</p>
        </div>
        
        <div class="filters-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="filters-title">Filter Requests</div>
                <div id="filterCount" style="font-size: 14px; color: #3D3D3D; font-weight: 500;">
                    Showing <span style="color: #F57600; font-weight: 700;">0</span> requests
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterEmployeeId">Employee ID</label>
                    <input type="text" id="filterEmployeeId" placeholder="Search by ID...">
                </div>
                
                <div class="filter-group">
                    <!-- <label for="filterWeek">Week</label> -->
                    <label>Week Number <span class="required">* <a href="week_number_reference.html" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #F57600; color: white; text-decoration: none; border-radius: 50%; font-weight: bold; font-size: 16px;" title="Find Week Number">?</a></span></label>
                    <input type="text" id="filterWeek" placeholder="e.g., 47-2024">
                </div>
                
                <div class="filter-group">
                    <label for="filterType">Request Type</label>
                    <select id="filterType">
                        <option value="">All Types</option>
                        <option value="vacation">Vacation</option>
                        <option value="sick">Sick</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterStatus">Status</label>
                    <select id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending Review</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Not Eligible</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                <button class="btn btn-export" onclick="exportReport()">Export to Paychex</button>
            </div>
        </div>
        
        <div class="requests-table-container">
            <table class="requests-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('employeeName')" id="th-employeeName">Employee <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('employeeId')" id="th-employeeId">Employee ID <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('requestType')" id="th-requestType">Type <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('status')" id="th-status">Status <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('requestDate')" id="th-requestDate">Date <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('weekYear')" id="th-weekYear">Week <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('totalHours')" id="th-totalHours">Requested Hours <span class="sort-icon">⇅</span></th>
                        <th class="sortable" onclick="sortTable('approvedHours')" id="th-approvedHours">Approved Hours <span class="sort-icon">⇅</span></th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody">
                    <tr>
                        <td colspan="9" class="loading">Loading requests</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Detail View Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Request Details</h2>
                <span class="close" onclick="closeModal('detailModal')">&times;</span>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="action-modal-content">
            <div class="action-modal-header">
                <h2>Mark as Reviewed</h2>
                <span class="close" onclick="closeModal('reviewModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="reviewerName">Your Name *</label>
                <input type="text" id="reviewerName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="reviewComments">Review Comments *</label>
                <textarea id="reviewComments" rows="4" placeholder="Enter your review comments"></textarea>
            </div>
            <div class="action-modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('reviewModal')">Cancel</button>
                <button class="btn btn-review" onclick="submitReview()">Submit Review</button>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div id="approvalModal" class="modal">
        <div class="action-modal-content">
            <div class="action-modal-header">
                <h2>Approve Request</h2>
                <span class="close" onclick="closeModal('approvalModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="approverName">Your Name *</label>
                <input type="text" id="approverName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="approvedHours">Approved Hours *</label>
                <input type="number" id="approvedHours" step="0.01" min="0" placeholder="Enter approved hours">
                <div style="font-size: 12px; color: #3D3D3D; margin-top: 5px;">
                    Requested Hours: <span id="requestedHoursDisplay" style="font-weight: 600; color: #F57600;">0.00</span>
                </div>
            </div>
            <div class="form-group">
                <label for="approvalComments">Approval Comments *</label>
                <textarea id="approvalComments" rows="4" placeholder="Enter approval comments"></textarea>
            </div>
            <div class="action-modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('approvalModal')">Cancel</button>
                <button class="btn btn-approve" onclick="submitApproval()">Approve Request</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="modal">
        <div class="action-modal-content">
            <div class="action-modal-header">
                <h2>Reject Request</h2>
                <span class="close" onclick="closeModal('rejectionModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="rejectorName">Your Name *</label>
                <input type="text" id="rejectorName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="rejectionComments">Rejection Reason *</label>
                <textarea id="rejectionComments" rows="4" placeholder="Enter rejection reason"></textarea>
            </div>
            <div class="action-modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('rejectionModal')">Cancel</button>
                <button class="btn btn-reject" onclick="submitRejection()">Reject Request</button>
            </div>
        </div>
    </div>

    <script>
        var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_arKrcXeBY700shcwr33m6Abp9HkMDrId4D8uMWjuJVzWKgzkGuNXNxQQsbTV7mzW/exec';
        var requests = [];
        var filteredRequests = [];
        var currentRequestId = null;
        var currentRequestForDetail = null;
        var currentSortColumn = null;
        var currentSortDirection = 'asc';
        
        window.onload = function() {
            loadRequests();
        };
        
        function loadRequests() {
            var requestsTableBody = document.getElementById('requestsTableBody');
            requestsTableBody.innerHTML = '<tr><td colspan="9" class="loading">Loading requests</td></tr>';
            
            fetch(GOOGLE_SCRIPT_URL)
                .then(function(response) {
                    return response.text();
                })
                .then(function(text) {
                    try {
                        var result = JSON.parse(text);
                        if (result.success) {
                            requests = result.requests;
                            filteredRequests = requests;
                            displayRequests();
                            updateStats();
                        } else {
                            requestsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #FF7475;">Error loading requests: ' + (result.error || 'Unknown error') + '</td></tr>';
                        }
                    } catch (e) {
                        console.error('Parse error:', e);
                        requestsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #FF7475;">Error: Unable to load requests. Please check Google Apps Script deployment.</td></tr>';
                    }
                })
                .catch(function(error) {
                    console.error('Fetch error:', error);
                    requestsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #FF7475;">Network error. Please try again.</td></tr>';
                });
        }
        
        function displayRequests() {
            var requestsTableBody = document.getElementById('requestsTableBody');
            var filterCount = document.getElementById('filterCount');
            
            filterCount.innerHTML = 'Showing <span style="color: #F57600; font-weight: 700;">' + filteredRequests.length + '</span> requests';
            
            if (filteredRequests.length === 0) {
                requestsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #3D3D3D;">No requests found</td></tr>';
                return;
            }
            
            var html = '';
            
            for (var i = 0; i < filteredRequests.length; i++) {
                var req = filteredRequests[i];
                
                var totalHours = req.totalHours || 0;
                
                // Determine status
                var statusBadge = '';
                if (req.rejectionStatus === 'rejected') {
                    statusBadge = '<span class="badge badge-rejected">NOT ELIGIBLE</span>';
                } else if (req.approvalStatus === 'approved') {
                    statusBadge = '<span class="badge badge-approved">APPROVED</span>';
                } else if (req.reviewStatus === 'reviewed') {
                    statusBadge = '<span class="badge badge-reviewed">REVIEWED</span>';
                } else {
                    statusBadge = '<span class="badge badge-pending">PENDING</span>';
                }
                
                var typeBadge = '<span class="badge badge-' + req.requestType + '">' + req.requestType.toUpperCase() + '</span>';
                
                // Get formatted date from requestDate (e.g., "25-Nov-25")
                var formattedDate = 'N/A';
                if (req.requestDate) {
                    var dateObj = new Date(req.requestDate);
                    var day = String(dateObj.getDate()).padStart(2, '0');
                    var month = dateObj.toLocaleDateString('en-US', { month: 'short' });
                    var year = String(dateObj.getFullYear()).slice(-2);
                    formattedDate = day + '-' + month + '-' + year;
                }
                
                html += '<tr>' +
                    '<td class="employee-name-cell">' + req.employeeName + ' ' + req.employeeLastName + '</td>' +
                    '<td>' + req.employeeId + '</td>' +
                    '<td>' + typeBadge + '</td>' +
                    '<td>' + statusBadge + '</td>' +
                    '<td>' + formattedDate + '</td>' +
                    '<td>' + (req.weekYear || 'N/A') + '</td>' +
                    '<td class="hours-cell">' + totalHours.toFixed(2) + ' hrs</td>' +
                    '<td class="hours-cell">' + (req.approvedHours ? parseFloat(req.approvedHours).toFixed(2) : '-') + '</td>' +
                    '<td><button class="btn btn-view-details btn-small" onclick="openDetailModal(' + i + ')">View Details</button></td>' +
                    '</tr>';
            }
            
            requestsTableBody.innerHTML = html;
        }
        
        function sortTable(column) {
            // If clicking the same column, toggle direction
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Update header styles
            var headers = document.querySelectorAll('.requests-table thead th.sortable');
            headers.forEach(function(th) {
                th.classList.remove('sort-asc', 'sort-desc');
                th.querySelector('.sort-icon').textContent = '⇅';
            });
            
            var activeHeader = document.getElementById('th-' + column);
            if (activeHeader) {
                activeHeader.classList.add('sort-' + currentSortDirection);
                activeHeader.querySelector('.sort-icon').textContent = currentSortDirection === 'asc' ? '↑' : '↓';
            }
            
            // Sort the filteredRequests array
            filteredRequests.sort(function(a, b) {
                var valA, valB;
                
                // Handle special columns
                if (column === 'employeeName') {
                    valA = (a.employeeName + ' ' + a.employeeLastName).toLowerCase();
                    valB = (b.employeeName + ' ' + b.employeeLastName).toLowerCase();
                } else if (column === 'status') {
                    // Custom order for status
                    var statusOrder = { 'pending': 1, 'reviewed': 2, 'approved': 3, 'rejected': 4 };
                    valA = getStatusValue(a);
                    valB = getStatusValue(b);
                    valA = statusOrder[valA] || 0;
                    valB = statusOrder[valB] || 0;
                } else if (column === 'totalHours') {
                    valA = a.totalHours || 0;
                    valB = b.totalHours || 0;
                } else if (column === 'approvedHours') {
                    valA = parseFloat(a.approvedHours) || 0;
                    valB = parseFloat(b.approvedHours) || 0;
                } else if (column === 'requestDate') {
                    // Sort by date
                    valA = a.requestDate ? new Date(a.requestDate).getTime() : 0;
                    valB = b.requestDate ? new Date(b.requestDate).getTime() : 0;
                } else if (column === 'weekYear') {
                    // Parse week-year format (e.g., "47-2024")
                    valA = parseWeekYear(a.weekYear);
                    valB = parseWeekYear(b.weekYear);
                } else {
                    valA = (a[column] || '').toString().toLowerCase();
                    valB = (b[column] || '').toString().toLowerCase();
                }
                
                // Compare values
                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            displayRequests();
        }
        
        function getStatusValue(req) {
            if (req.rejectionStatus === 'rejected') return 'rejected';
            if (req.approvalStatus === 'approved') return 'approved';
            if (req.reviewStatus === 'reviewed') return 'reviewed';
            return 'pending';
        }
        
        function parseWeekYear(weekYear) {
            if (!weekYear) return 0;
            var parts = weekYear.split('-');
            if (parts.length === 2) {
                var week = parseInt(parts[0]) || 0;
                var year = parseInt(parts[1]) || 0;
                return year * 100 + week; // e.g., 2024-47 becomes 202447
            }
            return 0;
        }
        
        function openDetailModal(index) {
            // Get request directly by index from filteredRequests
            var req = filteredRequests[index];
            
            if (!req) {
                console.error('Request not found at index:', index);
                return;
            }
            
            currentRequestForDetail = req;
            
            // Build detail modal content
            var totalHours = req.totalHours || 0;
            var date = req.requestDate ? new Date(req.requestDate).toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            }) : 'N/A';
            var submittedDate = req.submittedDate ? new Date(req.submittedDate).toLocaleDateString('en-US', { 
                month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' 
            }) : 'N/A';
            
            var statusBadges = '<div style="display: flex; gap: 10px; margin-bottom: 20px;">';
            statusBadges += '<span class="badge badge-' + req.requestType + '">' + req.requestType.toUpperCase() + '</span>';
            
            if (req.rejectionStatus === 'rejected') {
                statusBadges += '<span class="badge badge-rejected">NOT ELIGIBLE</span>';
            } else if (req.approvalStatus === 'approved') {
                statusBadges += '<span class="badge badge-approved">APPROVED</span>';
            } else if (req.reviewStatus === 'reviewed') {
                statusBadges += '<span class="badge badge-reviewed">REVIEWED</span>';
            } else {
                statusBadges += '<span class="badge badge-pending">PENDING REVIEW</span>';
            }
            statusBadges += '</div>';
            
            var html = statusBadges;
            
            // Employee Information
            html += '<div class="detail-section">' +
                '<h3>Employee Information</h3>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">Employee</div><div class="detail-value">' + req.employeeName + ' ' + req.employeeLastName + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Employee ID</div><div class="detail-value">' + req.employeeId + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Email</div><div class="detail-value">' + req.employeeEmail + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Phone</div><div class="detail-value">' + req.employeePhone + '</div></div>' +
                '</div></div>';
            
            // Request Information
            html += '<div class="detail-section">' +
                '<h3>Request Information</h3>' +
                '<div class="detail-grid">' +
                '<div class="detail-item"><div class="detail-label">Request ID</div><div class="detail-value">' + req.requestId + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Request Date</div><div class="detail-value">' + date + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Week</div><div class="detail-value">' + (req.weekYear || 'N/A') + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Submitted</div><div class="detail-value">' + submittedDate + '</div></div>' +
                '<div class="detail-item"><div class="detail-label">Total Hours</div><div class="detail-value" style="color: #F57600;">' + totalHours.toFixed(2) + ' hrs</div></div>' +
                '</div></div>';
            
            // Services Missed
            html += '<div class="detail-section">' +
                '<h3>Services Missed (' + (req.services ? req.services.length : 0) + ')</h3>' +
                '<div class="services-list">';
            
            if (req.services && req.services.length > 0) {
                for (var s = 0; s < req.services.length; s++) {
                    var service = req.services[s];
                    html += '<div class="service-item">' +
                        '<div><strong>Service ' + (s + 1) + ':</strong> ' + service.client + '</div>' +
                        '<div style="display: flex; gap: 15px; font-size: 12px; color: #3D3D3D; margin-top: 5px;">' +
                        '<span>Start: ' + service.startTime + '</span>' +
                        '<span>Hours: ' + service.hoursMissed + '</span>' +
                        '</div></div>';
                }
            }
            
            html += '<div class="services-total"><span>Total Hours for the Day</span><span>' + totalHours.toFixed(2) + ' hours</span></div>' +
                '</div></div>';
            
            // Review & Approval Status
            html += '<div class="detail-section">' +
                '<h3>Review & Approval Status</h3>' +
                '<div class="status-boxes">';
            
            // Review Status Box
            if (req.reviewStatus === 'reviewed') {
                var reviewDate = req.reviewedDate ? new Date(req.reviewedDate).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A';
                html += '<div class="status-box reviewed">' +
                    '<h5>Review Status</h5>' +
                    '<div class="value">✓ Reviewed</div>' +
                    '<div style="font-size: 12px; color: #3D3D3D; margin-top: 5px;">By: ' + (req.reviewedBy || 'N/A') + '</div>' +
                    '<div style="font-size: 11px; color: #3D3D3D;">' + reviewDate + '</div>';
                if (req.reviewComments) {
                    html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #D3D7DF;">' +
                        '<div style="font-size: 11px; color: #3D3D3D; margin-bottom: 4px;">Comments:</div>' +
                        '<div style="font-size: 12px; color: #1A365C;">' + req.reviewComments + '</div>' +
                        '</div>';
                }
                html += '</div>';
            } else {
                html += '<div class="status-box">' +
                    '<h5>Review Status</h5>' +
                    '<div class="value">Pending</div>' +
                    '</div>';
            }
            
            // Approval/Rejection Status Box
            if (req.rejectionStatus === 'rejected') {
                var rejectionDate = req.rejectedDate ? new Date(req.rejectedDate).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A';
                html += '<div class="status-box rejected">' +
                    '<h5>Rejection Status</h5>' +
                    '<div class="value" style="color: #FF7475;">✗ Not Eligible</div>' +
                    '<div style="font-size: 12px; color: #3D3D3D; margin-top: 5px;">By: ' + (req.rejectedBy || 'N/A') + '</div>' +
                    '<div style="font-size: 11px; color: #3D3D3D;">' + rejectionDate + '</div>';
                if (req.rejectionComments) {
                    html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #D3D7DF;">' +
                        '<div style="font-size: 11px; color: #3D3D3D; margin-bottom: 4px;">Reason:</div>' +
                        '<div style="font-size: 12px; color: #1A365C;">' + req.rejectionComments + '</div>' +
                        '</div>';
                }
                html += '</div>';
            } else if (req.approvalStatus === 'approved') {
                var approvalDate = req.approvedDate ? new Date(req.approvedDate).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A';
                html += '<div class="status-box approved">' +
                    '<h5>Approval Status</h5>' +
                    '<div class="value">✓ Approved</div>' +
                    '<div style="font-size: 12px; color: #3D3D3D; margin-top: 5px;">By: ' + (req.approvedBy || 'N/A') + '</div>' +
                    '<div style="font-size: 11px; color: #3D3D3D;">' + approvalDate + '</div>' +
                    '<div style="font-size: 13px; color: #1A365C; margin-top: 8px; font-weight: 600;">Approved Hours: ' + (req.approvedHours || '0.00') + '</div>';
                if (req.approvalComments) {
                    html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #D3D7DF;">' +
                        '<div style="font-size: 11px; color: #3D3D3D; margin-bottom: 4px;">Comments:</div>' +
                        '<div style="font-size: 12px; color: #1A365C;">' + req.approvalComments + '</div>' +
                        '</div>';
                }
                html += '</div>';
            } else {
                html += '<div class="status-box">' +
                    '<h5>Approval Status</h5>' +
                    '<div class="value">Pending</div>' +
                    '</div>';
            }
            
            html += '</div>';
            
            // Action Buttons
            html += '<div class="modal-actions-section">';
            if (req.reviewStatus !== 'reviewed' && req.approvalStatus !== 'approved' && req.rejectionStatus !== 'rejected') {
                html += '<button class="btn btn-review" onclick="openReviewModalFromDetail()">Mark as Reviewed</button>';
            }
            if (req.reviewStatus === 'reviewed' && req.approvalStatus !== 'approved' && req.rejectionStatus !== 'rejected') {
                html += '<button class="btn btn-approve" onclick="openApprovalModalFromDetail()">Approve Request</button>';
                html += '<button class="btn btn-reject" onclick="openRejectionModalFromDetail()">Reject Request</button>';
            }
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('detailModalBody').innerHTML = html;
            document.getElementById('detailModal').style.display = 'block';
        }
        
        function openReviewModalFromDetail() {
            var requestId = currentRequestForDetail.requestId;
            closeModal('detailModal');
            openReviewModal(requestId);
        }
        
        function openApprovalModalFromDetail() {
            var requestId = currentRequestForDetail.requestId;
            var totalHours = currentRequestForDetail.totalHours;
            closeModal('detailModal');
            openApprovalModal(requestId, totalHours);
        }
        
        function openRejectionModalFromDetail() {
            var requestId = currentRequestForDetail.requestId;
            closeModal('detailModal');
            openRejectionModal(requestId);
        }
        
        function updateStats() {
            document.getElementById('totalRequests').textContent = requests.length;
            
            var pending = 0;
            var reviewed = 0;
            var approved = 0;
            var rejected = 0;
            
            for (var i = 0; i < requests.length; i++) {
                if (requests[i].rejectionStatus === 'rejected') {
                    rejected++;
                } else if (requests[i].approvalStatus === 'approved') {
                    approved++;
                } else if (requests[i].reviewStatus === 'reviewed') {
                    reviewed++;
                } else {
                    pending++;
                }
            }
            
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('reviewedRequests').textContent = reviewed;
            document.getElementById('approvedRequests').textContent = approved;
            document.getElementById('rejectedRequests').textContent = rejected;
        }
        
        function applyFilters() {
            var filterEmployeeId = document.getElementById('filterEmployeeId').value.toLowerCase().trim();
            var filterWeek = document.getElementById('filterWeek').value.trim();
            var filterType = document.getElementById('filterType').value;
            var filterStatus = document.getElementById('filterStatus').value;
            
            filteredRequests = requests.filter(function(req) {
                var matchId = !filterEmployeeId || 
                    (req.employeeId && req.employeeId.toLowerCase().indexOf(filterEmployeeId) !== -1);
                
                var matchWeek = !filterWeek || 
                    (req.weekYear && req.weekYear === filterWeek);
                
                var matchType = !filterType || req.requestType === filterType;
                
                var matchStatus = true;
                if (filterStatus === 'pending') {
                    matchStatus = (!req.reviewStatus || req.reviewStatus !== 'reviewed') && 
                                  (!req.approvalStatus || req.approvalStatus !== 'approved') &&
                                  (!req.rejectionStatus || req.rejectionStatus !== 'rejected');
                } else if (filterStatus === 'reviewed') {
                    matchStatus = req.reviewStatus === 'reviewed' && 
                                  (!req.approvalStatus || req.approvalStatus !== 'approved') &&
                                  (!req.rejectionStatus || req.rejectionStatus !== 'rejected');
                } else if (filterStatus === 'approved') {
                    matchStatus = req.approvalStatus === 'approved';
                } else if (filterStatus === 'rejected') {
                    matchStatus = req.rejectionStatus === 'rejected';
                }
                
                return matchId && matchWeek && matchType && matchStatus;
            });
            
            displayRequests();
        }
        
        function clearFilters() {
            document.getElementById('filterEmployeeId').value = '';
            document.getElementById('filterWeek').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterStatus').value = '';
            
            // Reset sort state
            currentSortColumn = null;
            currentSortDirection = 'asc';
            var headers = document.querySelectorAll('.requests-table thead th.sortable');
            headers.forEach(function(th) {
                th.classList.remove('sort-asc', 'sort-desc');
                th.querySelector('.sort-icon').textContent = '⇅';
            });
            
            filteredRequests = requests;
            displayRequests();
        }
        
        function exportReport() {
            if (filteredRequests.length === 0) {
                alert('No data to export. Please apply filters or ensure requests are loaded.');
                return;
            }
            
            console.log('=== EXPORT REPORT ===');
            console.log('Exporting', filteredRequests.length, 'requests');
            
            // Aggregate requests by employee and type
            var aggregatedData = {};
            
            for (var i = 0; i < filteredRequests.length; i++) {
                var req = filteredRequests[i];
                var employeeId = req.employeeId;
                var requestType = req.requestType;
                var key = employeeId + '_' + requestType;
                
                if (!aggregatedData[key]) {
                    aggregatedData[key] = {
                        employeeName: req.employeeName + ' ' + req.employeeLastName,
                        employeeId: employeeId,
                        requestType: requestType,
                        totalRequested: 0,
                        totalApproved: 0
                    };
                }
                
                // Sum requested hours
                aggregatedData[key].totalRequested += (req.totalHours || 0);
                
                // Sum approved hours (only for approved requests)
                if (req.approvalStatus === 'approved') {
                    aggregatedData[key].totalApproved += (req.approvedHours || 0);
                }
            }
            
            // Separate into sick and vacation arrays
            var sickData = [];
            var vacationData = [];
            
            for (var key in aggregatedData) {
                if (aggregatedData[key].requestType === 'sick') {
                    sickData.push(aggregatedData[key]);
                } else if (aggregatedData[key].requestType === 'vacation') {
                    vacationData.push(aggregatedData[key]);
                }
            }
            
            // Sort by employee name
            sickData.sort(function(a, b) {
                return a.employeeName.localeCompare(b.employeeName);
            });
            vacationData.sort(function(a, b) {
                return a.employeeName.localeCompare(b.employeeName);
            });
            
            var textContent = '';
            
            // Add Sick requests
            if (sickData.length > 0) {
                textContent += '* Sick\n';
                for (var i = 0; i < sickData.length; i++) {
                    var data = sickData[i];
                    textContent += 'Name: ' + data.employeeName + '\n';
                    textContent += 'EmployeeID: ' + data.employeeId + '\n';
                    textContent += 'Requested: ' + data.totalRequested.toFixed(2) + '\n';
                    textContent += 'Approved: ' + data.totalApproved.toFixed(2) + '\n';
                    
                    // Add blank line between entries (except last one)
                    if (i < sickData.length - 1) {
                        textContent += '\n';
                    }
                }
                textContent += '\n';
            }
            
            // Add Vacation requests
            if (vacationData.length > 0) {
                textContent += '* Vacation\n';
                for (var i = 0; i < vacationData.length; i++) {
                    var data = vacationData[i];
                    textContent += 'Name: ' + data.employeeName + '\n';
                    textContent += 'EmployeeID: ' + data.employeeId + '\n';
                    textContent += 'Requested: ' + data.totalRequested.toFixed(2) + '\n';
                    textContent += 'Approved: ' + data.totalApproved.toFixed(2) + '\n';
                    
                    // Add blank line between entries (except last one)
                    if (i < vacationData.length - 1) {
                        textContent += '\n';
                    }
                }
            }
            
            // If no data at all
            if (textContent === '') {
                alert('No data to export.');
                return;
            }
            
            // Generate filename with current date and time
            var now = new Date();
            var dateStr = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
            var timeStr = String(now.getHours()).padStart(2, '0') + '' + 
                         String(now.getMinutes()).padStart(2, '0');
            var filename = 'TimeOff_Report_' + dateStr + '_' + timeStr + '.txt';
            
            // Create blob and download
            var blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
            
            // Create download link
            var link = document.createElement('a');
            if (link.download !== undefined) {
                var url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('Export completed:', filename);
                alert('Report exported successfully!\nFilename: ' + filename);
            } else {
                alert('Export failed. Your browser does not support file downloads.');
            }
        }
        
        function openReviewModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('reviewerName').value = '';
            document.getElementById('reviewComments').value = '';
            document.getElementById('reviewModal').style.display = 'block';
        }
        
        function openApprovalModal(requestId, requestedHours) {
            currentRequestId = requestId;
            document.getElementById('approverName').value = '';
            document.getElementById('approvedHours').value = requestedHours.toFixed(2);
            document.getElementById('requestedHoursDisplay').textContent = requestedHours.toFixed(2);
            document.getElementById('approvalComments').value = '';
            document.getElementById('approvalModal').style.display = 'block';
        }
        
        function openRejectionModal(requestId) {
            currentRequestId = requestId;
            document.getElementById('rejectorName').value = '';
            document.getElementById('rejectionComments').value = '';
            document.getElementById('rejectionModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentRequestId = null;
            currentRequestForDetail = null;
        }
        
        function submitReview() {
            var reviewerName = document.getElementById('reviewerName').value.trim();
            var reviewComments = document.getElementById('reviewComments').value.trim();
            
            console.log('=== SUBMIT REVIEW ===');
            console.log('Reviewer Name:', reviewerName);
            console.log('Review Comments:', reviewComments);
            console.log('Request ID:', currentRequestId);
            
            if (!reviewerName) {
                alert('Please enter your name');
                return;
            }
            
            if (!reviewComments) {
                alert('Please enter review comments');
                return;
            }
            
            var data = {
                action: 'review',
                requestId: currentRequestId,
                reviewerName: reviewerName,
                reviewedDate: new Date().toISOString(),
                reviewComments: reviewComments
            };
            
            console.log('Data being sent:', JSON.stringify(data));
            
            updateRequest(data, 'reviewModal');
        }
        
        function submitApproval() {
            var approverName = document.getElementById('approverName').value.trim();
            var approvedHours = parseFloat(document.getElementById('approvedHours').value);
            var approvalComments = document.getElementById('approvalComments').value.trim();
            
            console.log('=== SUBMIT APPROVAL ===');
            console.log('Approver Name:', approverName);
            console.log('Approved Hours:', approvedHours);
            console.log('Approval Comments:', approvalComments);
            console.log('Request ID:', currentRequestId);
            
            if (!approverName) {
                alert('Please enter your name');
                return;
            }
            
            if (isNaN(approvedHours) || approvedHours < 0) {
                alert('Please enter valid approved hours');
                return;
            }
            
            if (!approvalComments) {
                alert('Please enter approval comments');
                return;
            }
            
            var data = {
                action: 'approve',
                requestId: currentRequestId,
                approverName: approverName,
                approvedDate: new Date().toISOString(),
                approvedHours: approvedHours,
                approvalComments: approvalComments
            };
            
            console.log('Data being sent:', JSON.stringify(data));
            
            updateRequest(data, 'approvalModal');
        }
        
        function submitRejection() {
            var rejectorName = document.getElementById('rejectorName').value.trim();
            var rejectionComments = document.getElementById('rejectionComments').value.trim();
            
            console.log('=== SUBMIT REJECTION ===');
            console.log('Rejector Name:', rejectorName);
            console.log('Rejection Comments:', rejectionComments);
            console.log('Request ID:', currentRequestId);
            
            if (!rejectorName) {
                alert('Please enter your name');
                return;
            }
            
            if (!rejectionComments) {
                alert('Please enter rejection comments');
                return;
            }
            
            var data = {
                action: 'reject',
                requestId: currentRequestId,
                rejectorName: rejectorName,
                rejectedDate: new Date().toISOString(),
                rejectionComments: rejectionComments
            };
            
            console.log('Data being sent:', JSON.stringify(data));
            
            updateRequest(data, 'rejectionModal');
        }
        
        function updateRequest(data, modalId) {
            console.log('=== UPDATE REQUEST ===');
            console.log('Sending POST to:', GOOGLE_SCRIPT_URL);
            console.log('Payload:', JSON.stringify(data, null, 2));
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(function() {
                console.log('POST request completed (no-cors mode)');
                closeModal(modalId);
                alert('Request updated successfully!');
                loadRequests();
            })
            .catch(function(error) {
                console.error('POST request error:', error);
                alert('Request updated successfully!');
                closeModal(modalId);
                loadRequests();
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
                currentRequestId = null;
                currentRequestForDetail = null;
            }
        }
    </script>
</body>
</html>
