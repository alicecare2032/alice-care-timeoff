<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alice.care: Client Service Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #E5ECF3;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Loading Spinner Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 54, 92, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 40px 60px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #E5ECF3;
            border-top: 5px solid #F57600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #1A365C;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .loading-subtext {
            color: #666;
            font-size: 13px;
        }
        
        /* Tab Navigation */
        .nav-tabs {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: #1A365C;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            background: #F57600;
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: #E5ECF3;
        }
        
        .tab-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: #1A365C;
            color: white;
            padding: 40px 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            border: 40px solid rgba(245, 118, 0, 0.1);
            border-radius: 50%;
            top: -150px;
            right: -100px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .header-left {
            flex: 1;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .logo .alice { color: #F57600; font-weight: 700; }
        .logo .dot { color: #F57600; font-weight: 700; margin: 0 -2px; }
        .logo .care { color: white; font-weight: 400; }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
            font-weight: 400;
        }
        
        .header-search {
            position: relative;
        }
        
        .header-search input {
            width: 300px;
            padding: 12px 16px 12px 44px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .header-search input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .header-search input:focus {
            outline: none;
            border-color: #F57600;
            background: rgba(255,255,255,0.15);
        }
        
        .header-search svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            stroke: rgba(255,255,255,0.6);
        }
        
        /* Content Area */
        .content {
            padding: 30px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Section Title */
        .section-title {
            font-size: 18px;
            color: #1A365C;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #F57600;
            border-radius: 2px;
        }
        
        /* Notice Box */
        .notice-box {
            background: #E5ECF3;
            border-left: 4px solid #F57600;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .notice-box h3 {
            color: #1A365C;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .notice-box p {
            color: #3D3D3D;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .notice-box p:last-child { margin-bottom: 0; }
        
        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #F57600;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.08);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(26, 54, 92, 0.12);
        }
        
        .stat-card.green { border-left-color: #62B790; }
        .stat-card.blue { border-left-color: #2196F3; }
        
        .stat-card h3 {
            font-size: 12px;
            color: #3D3D3D;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .number {
            font-size: 32px;
            color: #1A365C;
            font-weight: 700;
        }
        
        .stat-card .subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #E5ECF3;
            padding: 20px;
            border-radius: 8px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1A365C;
            font-size: 13px;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            background: white;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #F57600;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d00;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 118, 0, 0.3);
        }
        
        .btn-secondary {
            background: #E5ECF3;
            color: #1A365C;
        }
        
        .btn-secondary:hover {
            background: #D3D7DF;
        }
        
        .btn-green {
            background: #62B790;
            color: white;
        }
        
        .btn-green:hover {
            background: #54A07E;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #E5ECF3;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }
        
        .data-table thead {
            background: #1A365C;
            color: white;
        }
        
        .data-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #E5ECF3;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background: #F9FAFB;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Badge Styles */
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
        }
        
        .badge-pending { background: #FFF3E0; color: #F57600; }
        .badge-completed { background: #E0F1E9; color: #62B790; }
        .badge-assigned { background: #E3F2FD; color: #2196F3; }
        .badge-unassigned { background: #F5F5F5; color: #999; }
        .badge-cancelled { background: #FFE3E3; color: #FF7475; }
        .badge-paid { background: #E0F1E9; color: #62B790; }
        .badge-weekly { background: #E3F2FD; color: #2196F3; }
        .badge-monthly { background: #E0F1E9; color: #62B790; }
        .badge-yearly { background: #FFF3E0; color: #F57600; }
        .badge-none { background: #F5F5F5; color: #999; }
        
        /* Client Detail Sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.8);
            z-index: 1000;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .client-sidebar {
            position: fixed;
            top: 0;
            right: -500px;
            width: 480px;
            max-width: 100%;
            height: 100vh;
            background: white;
            z-index: 1001;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
        }
        
        .client-sidebar.active {
            right: 0;
        }
        
        .sidebar-header {
            background: #1A365C;
            color: white;
            padding: 30px;
            position: relative;
        }
        
        .sidebar-header::before {
            content: '';
            position: absolute;
            width: 150px;
            height: 150px;
            border: 20px solid rgba(245, 118, 0, 0.1);
            border-radius: 50%;
            top: -75px;
            right: -50px;
        }
        
        .close-sidebar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .close-sidebar:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .close-sidebar svg {
            pointer-events: none;
        }
        
        .sidebar-header h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-header p {
            opacity: 0.8;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-body {
            padding: 30px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #E5ECF3;
        }
        
        .sidebar-section:last-child {
            border-bottom: none;
        }
        
        .sidebar-section h3 {
            font-size: 14px;
            color: #1A365C;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-section h3::before {
            content: '';
            width: 3px;
            height: 16px;
            background: #F57600;
            border-radius: 2px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #F5F5F5;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-row .label {
            color: #999;
            font-size: 13px;
        }
        
        .detail-row .value {
            font-weight: 600;
            color: #1A365C;
            font-size: 13px;
        }
        
        /* Subscription Options */
        .subscription-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .subscription-option {
            flex: 1;
            position: relative;
        }
        
        .subscription-option input {
            position: absolute;
            opacity: 0;
        }
        
        .subscription-option label {
            display: block;
            padding: 15px;
            text-align: center;
            background: #F9FAFB;
            border: 2px solid #E5ECF3;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .subscription-option input:checked + label {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .subscription-option label:hover {
            border-color: #D3D7DF;
        }
        
        .subscription-option .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .subscription-option .name {
            font-weight: 600;
            color: #1A365C;
            font-size: 13px;
        }
        
        .subscription-option .desc {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        
        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #E5ECF3;
            border-top-color: #F57600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: #D3D7DF;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            color: #1A365C;
            margin-bottom: 8px;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 25px;
        }
        
        .pagination button {
            padding: 8px 14px;
            border: 2px solid #E5ECF3;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 13px;
            color: #1A365C;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #F57600;
            color: white;
            border-color: #F57600;
        }
        
        .page-info {
            font-size: 13px;
            color: #999;
            margin-left: 10px;
        }
        
        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            border: 1px solid #E5ECF3;
            border-radius: 8px;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(26, 54, 92, 0.15);
        }
        
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #F0F0F0;
            transition: background 0.2s;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: #FFF8F0;
        }
        
        .autocomplete-item .insurance-name {
            font-weight: 600;
            color: #1A365C;
            font-size: 14px;
        }
        
        .autocomplete-item .insurance-email {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .autocomplete-item .client-count {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            max-width: 360px;
            border-left: 4px solid #F57600;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-left-color: #62B790; }
        .toast.error { border-left-color: #FF7475; }
        .toast.warning { border-left-color: #F57600; }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #1A365C;
            font-weight: 500;
        }
        
        /* Quick Lookup */
        .quick-lookup {
            background: #F9FAFB;
            border: 2px solid #E5ECF3;
            border-radius: 12px;
            padding: 25px;
        }
        
        .quick-lookup-input {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .quick-lookup-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
        }
        
        .quick-lookup-input input:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        #quickLookupResult {
            margin-top: 20px;
        }
        
        .lookup-result-card {
            background: white;
            border: 2px solid #E5ECF3;
            border-radius: 8px;
            padding: 20px;
        }
        
        .lookup-result-card h4 {
            color: #1A365C;
            margin-bottom: 5px;
        }
        
        .lookup-result-card p {
            color: #999;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .header-search input {
                width: 100%;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .stats-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .client-sidebar {
                width: 100%;
            }
            
            .subscription-options {
                flex-direction: column;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(26, 54, 92, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #1A365C;
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(90vh - 150px);
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #E5ECF3;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Upload Area */
        .upload-dropzone {
            border: 2px dashed #D3D7DF;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #F9FAFB;
        }
        
        .upload-dropzone:hover {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .upload-dropzone.dragover {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #E0F1E9;
            border-radius: 8px;
            border: 1px solid #62B790;
        }
        
        /* Upload Progress */
        .upload-progress {
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 8px;
            background: #E5ECF3;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #F57600;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 13px;
            color: #3D3D3D;
            margin-top: 8px;
            text-align: center;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #ccc;
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #62B790;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .toggle-switch.small .toggle-slider {
            width: 40px;
            height: 22px;
        }
        
        .toggle-switch.small .toggle-slider:before {
            height: 16px;
            width: 16px;
        }
        
        .toggle-switch.small input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }
        
        .toggle-label {
            font-size: 13px;
            font-weight: 600;
            color: #1A365C;
        }
        
        /* Paused state */
        .config-card-paused {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .btn-blue {
            background: #2196F3;
            color: white;
            border: none;
        }
        
        .btn-blue:hover {
            background: #1976D2;
        }
        
        /* Report type radio styling */
        input[name="testReportType"]:checked + .report-type-option {
            border-color: #2196F3 !important;
            background: #E3F2FD !important;
        }
        
        input[name="testReportType"]:checked + .report-type-option span {
            color: #2196F3 !important;
        }
        
        .report-type-option:hover {
            border-color: #999 !important;
        }
        
        /* Info tooltip styles */
        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            font-size: 11px !important;
            font-weight: 600;
        }
        
        .info-tooltip:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: pre-line;
            width: 280px;
            max-width: 320px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            line-height: 1.5;
            text-transform: none;
        }
        
        .info-tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.9);
            z-index: 1001;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
            <div class="loading-subtext" id="loadingSubtext">Please wait</div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Tab Navigation -->
    <nav class="nav-tabs">
<button class="tab-btn active" data-tab="dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
            </svg>
            Dashboard
        </button>
        <button class="tab-btn" data-tab="clientInsights">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                <path d="M12 8v4"/>
                <path d="M8 12h8"/>
            </svg>
            Client Insights
        </button>
        <button class="tab-btn" data-tab="providerInsights">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Provider Insights
        </button>
    </nav>

    <div style="max-width: 1200px; margin: 0 auto 10px auto; text-align: right; font-size: 13px; color: #1A365C;">
        Need service reports, client management, or automation settings?
        <a href="reporting.html" style="color: #F57600; font-weight: 600; text-decoration: none; margin-left: 6px;">
            Go to Service_Report ‚Üí
        </a><br>
        Definitions and Formulas
        <a href="formula_documentation.html" style="color: #F57600; font-weight: 600; text-decoration: none; margin-left: 6px;">
            Go ‚Üí
        </a>
    </div>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo">
                        <span class="alice">alice</span><span class="dot">.</span><span class="care">care</span>
                    </div>
                    <h1>Client Service Portal</h1>
                    <p>View service records, manage subscriptions, and generate reports</p>
                </div>
                <div class="header-search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="globalSearch" placeholder="Search client by name or email...">
                </div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="content">
<!-- Dashboard Tab -->
            <div class="tab-panel active" id="dashboard-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Executive Dashboard</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="dashboardYear" onchange="loadDashboardData()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshAllData()" style="padding: 8px 12px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Refresh
                        </button>
                        </button>
                    </div>
                </div>
                
                <!-- Year-to-Date KPIs -->
                <div style="background: linear-gradient(135deg, #1A365C 0%, #2D4A7C 100%); border-radius: 16px; padding: 30px; margin-bottom: 30px; color: white;">
                    <h3 style="margin: 0 0 20px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">
                        <span id="dashboardYearLabel">2025</span> Year-to-Date Performance
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Total Services</div>
                            <div style="font-size: 36px; font-weight: 700;" id="ytdServices">--</div>
                            <div style="font-size: 12px; margin-top: 5px;" id="ytdServicesChange">
                                <span style="color: #62B790;">‚Üë 0%</span> vs last year
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Total Hours</div>
                            <div style="font-size: 36px; font-weight: 700;" id="ytdHours">--</div>
                            <div style="font-size: 12px; margin-top: 5px;" id="ytdHoursChange">
                                <span style="color: #62B790;">‚Üë 0%</span> vs last year
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Total Revenue</div>
                            <div style="font-size: 36px; font-weight: 700;" id="ytdRevenue">--</div>
                            <div style="font-size: 12px; margin-top: 5px;" id="ytdRevenueChange">
                                <span style="color: #62B790;">‚Üë 0%</span> vs last year
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Avg Revenue/Service</div>
                            <div style="font-size: 36px; font-weight: 700;" id="ytdAvgRevenue">--</div>
                            <div style="font-size: 12px; margin-top: 5px;" id="ytdAvgRevenueChange">
                                <span style="color: #62B790;">‚Üë 0%</span> vs last year
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Last Completed Period Stats -->
                <div class="stats-row" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>Last Week <span id="lastWeekLabel" style="font-weight: 400; color: #999; font-size: 11px;">(Week --)</span></h3>
                        <div style="display: flex; gap: 15px; align-items: baseline; margin-bottom: 5px;">
                            <div>
                                <span style="font-size: 11px; color: #666; text-transform: uppercase;">Revenue</span>
                                <div style="font-size: 22px; font-weight: 700; color: #1A365C;">$<span id="weekRevenue">--</span></div>
                            </div>
                            <div style="border-left: 1px solid #E5ECF3; padding-left: 15px;">
                                <span style="font-size: 11px; color: #666; text-transform: uppercase;">Hours</span>
                                <div style="font-size: 22px; font-weight: 700; color: #1A365C;"><span id="weekHours">--</span></div>
                            </div>
                        </div>
                        <div class="subtitle"><span id="weekServices">--</span> services completed</div>
                        <div id="weekChange" style="font-size: 11px; margin-top: 5px;"></div>
                    </div>
                    <div class="stat-card green">
                        <h3>Last Month <span id="lastMonthLabel" style="font-weight: 400; color: #999; font-size: 11px;">(--)</span></h3>
                        <div style="display: flex; gap: 15px; align-items: baseline; margin-bottom: 5px;">
                            <div>
                                <span style="font-size: 11px; color: #666; text-transform: uppercase;">Revenue</span>
                                <div style="font-size: 22px; font-weight: 700; color: #1A365C;">$<span id="monthRevenue">--</span></div>
                            </div>
                            <div style="border-left: 1px solid #E5ECF3; padding-left: 15px;">
                                <span style="font-size: 11px; color: #666; text-transform: uppercase;">Hours</span>
                                <div style="font-size: 22px; font-weight: 700; color: #1A365C;"><span id="monthHours">--</span></div>
                            </div>
                        </div>
                        <div class="subtitle"><span id="monthServices">--</span> services completed</div>
                        <div id="monthChange" style="font-size: 11px; margin-top: 5px;"></div>
                    </div>
                    <div class="stat-card blue">
                        <h3>Last Quarter <span id="lastQuarterLabel" style="font-weight: 400; color: #999; font-size: 11px;">(--)</span></h3>
                        <div style="display: flex; gap: 15px; align-items: baseline; margin-bottom: 5px;">
                            <div>
                                <span style="font-size: 11px; color: #666; text-transform: uppercase;">Revenue</span>
                                <div style="font-size: 22px; font-weight: 700; color: #1A365C;">$<span id="quarterRevenue">--</span></div>
                            </div>
                            <div style="border-left: 1px solid #E5ECF3; padding-left: 15px;">
                                <span style="font-size: 11px; color: #666; text-transform: uppercase;">Hours</span>
                                <div style="font-size: 22px; font-weight: 700; color: #1A365C;"><span id="quarterHours">--</span></div>
                            </div>
                        </div>
                        <div class="subtitle"><span id="quarterServices">--</span> services completed</div>
                        <div id="quarterChange" style="font-size: 11px; margin-top: 5px;"></div>
                    </div>
                    <div class="stat-card" style="border-left-color: #9C27B0;">
                        <h3>Active Clients</h3>
                        <div class="number" id="activeClients">--</div>
                        <div class="subtitle">With services this year</div>
                    </div>
                </div>
                
                <!-- Row 1: Weekly Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #1A365C; margin: 0 0 5px 0; font-size: 16px;">Weekly Revenue</h3>
                        <p style="color: #666; font-size: 11px; margin: 0 0 15px 0;">Last 12 weeks through <span id="weeklyChartEndLabel">last week</span></p>
                        <div style="height: 220px; position: relative;">
                            <canvas id="weeklyRevenueChart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #1A365C; margin: 0 0 5px 0; font-size: 16px;">Weekly Volume</h3>
                        <p style="color: #666; font-size: 11px; margin: 0 0 15px 0;">Services &amp; Hours (through <span id="weeklyVolumeEndLabel">last week</span>)</p>
                        <div style="height: 220px; position: relative;">
                            <canvas id="weeklyVolumeChart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #1A365C; margin: 0 0 20px 0; font-size: 16px;">Peak Hours (12 Week Avg)</h3>
                        <div style="height: 220px; position: relative;">
                            <canvas id="peakHoursChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: Monthly Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #1A365C; margin: 0 0 20px 0; font-size: 16px;">Monthly Revenue (Last 13 Months)</h3>
                        <div style="height: 220px; position: relative;">
                            <canvas id="monthlyRevenueChart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #1A365C; margin: 0 0 20px 0; font-size: 16px;">Monthly Volume (Last 13 Months)</h3>
                        <div style="height: 220px; position: relative;">
                            <canvas id="monthlyVolumeChart"></canvas>
                        </div>
                    </div>
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #1A365C; margin: 0 0 20px 0; font-size: 16px;">Quarterly Revenue Comparison</h3>
                        <div style="height: 220px; position: relative;">
                            <canvas id="quarterlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: Top Paying Clients -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üèÜ Top Clients Last Week <span id="topClientsWeekLabel" style="font-weight: 400; color: #666;">(Week --)</span></h3>
                            <select id="topClientsWeekLimit" onchange="updateTopClientsDisplay('week')" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="5" selected>Top 5</option>
                                <option value="10">Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                            </select>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #F9FAFB;">
                                    <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                    <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Client</th>
                                    <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Svcs</th>
                                    <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="topClientsWeek">
                                <tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üèÜ Top Clients Last Month <span id="topClientsMonthLabel" style="font-weight: 400; color: #666;">(--)</span></h3>
                            <select id="topClientsMonthLimit" onchange="updateTopClientsDisplay('month')" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="5" selected>Top 5</option>
                                <option value="10">Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                            </select>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #F9FAFB;">
                                    <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                    <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Client</th>
                                    <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Svcs</th>
                                    <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="topClientsMonth">
                                <tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Row 4: Top Providers Section with Filters -->
                <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="color: #1A365C; margin: 0; font-size: 18px;">üë§ Top Providers</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="providerDisplayLimit" onchange="updateProviderTables()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <option value="5" selected>Top 5</option>
                                <option value="10">Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                            </select>
                            <select id="providerFilterType" onchange="updateProviderFilter()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <option value="year">Year</option>
                                <option value="month">Month</option>
                                <option value="week">Week</option>
                            </select>
                            <select id="providerFilterYear" onchange="updateProviderTables()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                            <select id="providerFilterMonth" onchange="updateProviderTables()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="providerFilterWeek" onchange="updateProviderTables()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: #1A365C; margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">By Hours</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #F9FAFB;">
                                        <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                        <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Provider</th>
                                        <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Svcs</th>
                                        <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="topProvidersByHours">
                                    <tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <h4 style="color: #1A365C; margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">By Services</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #F9FAFB;">
                                        <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                        <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Provider</th>
                                        <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Svcs</th>
                                        <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="topProvidersByServices">
                                    <tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Row 5: Provider Activity Monitor -->
                <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <h3 style="color: #1A365C; margin: 0; font-size: 18px;">üìä Provider Activity Monitor</h3>
                            <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Comparing recent activity vs prior period to identify declining engagement</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 12px; color: #666;">Period:</label>
                                <select id="activityPeriodDays" onchange="updateProviderActivityMonitor()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="30">30 days</option>
                                    <option value="45" selected>45 days</option>
                                    <option value="60">60 days</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 12px; color: #666;">Show:</label>
                                <select id="activityStatusFilter" onchange="updateProviderActivityMonitor()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="concerns">‚ö†Ô∏è Concerns Only</option>
                                    <option value="all">All Providers</option>
                                    <option value="inactive">üî¥ Inactive</option>
                                    <option value="atrisk">üü† At Risk</option>
                                    <option value="declining">üü° Declining</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label style="font-size: 12px; color: #666;">Limit:</label>
                                <select id="activityDisplayLimit" onchange="updateProviderActivityMonitor()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="all">All</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Box -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="providerActivitySearch" placeholder="Search provider name..." 
                                   style="flex: 1; max-width: 300px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;"
                                   onkeyup="if(event.key === 'Enter') searchProviderActivity()">
                            <button class="btn btn-secondary" onclick="searchProviderActivity()" style="padding: 8px 12px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.35-4.35"/>
                                </svg>
                                Search
                            </button>
                            <button class="btn btn-secondary" onclick="clearProviderActivitySearch()" style="padding: 8px 12px;">Clear</button>
                        </div>
                    </div>
                    
                    <!-- Status Legend -->
                    <div style="display: flex; gap: 20px; margin-bottom: 15px; padding: 10px 15px; background: #F9FAFB; border-radius: 8px; font-size: 12px; flex-wrap: wrap;">
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #4CAF50; border-radius: 50%; margin-right: 5px;"></span> <strong>Active</strong> - Stable or increased</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #FFC107; border-radius: 50%; margin-right: 5px;"></span> <strong>Declining</strong> - 25-50% drop</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #FF9800; border-radius: 50%; margin-right: 5px;"></span> <strong>At Risk</strong> - 50-99% drop</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #F44336; border-radius: 50%; margin-right: 5px;"></span> <strong>Inactive</strong> - 100% drop</span>
                    </div>
                    
                    <!-- Summary Stats - Clickable to filter -->
                    <div id="activitySummaryStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div onclick="filterByStatus('active')" style="background: #E8F5E9; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                            <div style="font-size: 24px; font-weight: 700; color: #4CAF50;" id="activeProvidersCount">--</div>
                            <div style="font-size: 11px; color: #666; text-transform: uppercase;">Active</div>
                        </div>
                        <div onclick="filterByStatus('declining')" style="background: #FFF8E1; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                            <div style="font-size: 24px; font-weight: 700; color: #FFC107;" id="decliningProvidersCount">--</div>
                            <div style="font-size: 11px; color: #666; text-transform: uppercase;">Declining</div>
                        </div>
                        <div onclick="filterByStatus('atrisk')" style="background: #FFF3E0; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                            <div style="font-size: 24px; font-weight: 700; color: #FF9800;" id="atRiskProvidersCount">--</div>
                            <div style="font-size: 11px; color: #666; text-transform: uppercase;">At Risk</div>
                        </div>
                        <div onclick="filterByStatus('inactive')" style="background: #FFEBEE; padding: 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                            <div style="font-size: 24px; font-weight: 700; color: #F44336;" id="inactiveProvidersCount">--</div>
                            <div style="font-size: 11px; color: #666; text-transform: uppercase;">Inactive</div>
                        </div>
                    </div>
                    
                    <!-- Provider Activity Table -->
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 850px;">
                            <thead>
                                <tr style="background: #F9FAFB;">
                                    <th onclick="sortProviderActivity('status')" style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" title="Click to sort">
                                        Status <span id="sort-status" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                    <th onclick="sortProviderActivity('name')" style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" title="Click to sort">
                                        Provider Name <span id="sort-name" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                    <th onclick="sortProviderActivity('lastPeriodHours')" style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" colspan="2">
                                        Last Period 
                                        <span id="lastPeriodInfo" title="" style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; background: #E5ECF3; color: #666; border-radius: 50%; font-size: 10px; cursor: help; margin-left: 4px; font-style: italic; font-weight: normal;">i</span>
                                        <span id="sort-lastPeriodHours" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                    <th onclick="sortProviderActivity('priorPeriodHours')" style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" colspan="2">
                                        Prior Period 
                                        <span id="priorPeriodInfo" title="" style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; background: #E5ECF3; color: #666; border-radius: 50%; font-size: 10px; cursor: help; margin-left: 4px; font-style: italic; font-weight: normal;">i</span>
                                        <span id="sort-priorPeriodHours" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                    <th onclick="sortProviderActivity('change')" style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" title="Click to sort">
                                        Change <span id="sort-change" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                    <th onclick="sortProviderActivity('lastService')" style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" title="Click to sort">
                                        Last Service <span id="sort-lastService" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                    <th onclick="sortProviderActivity('ytdHours')" style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3; cursor: pointer; user-select: none;" colspan="2" title="Click to sort by hours">
                                        YTD Total <span id="sort-ytdHours" style="margin-left: 4px; color: #1A365C;"></span>
                                    </th>
                                </tr>
                                <tr style="background: #F9FAFB;">
                                    <th style="padding: 4px 12px; border-bottom: 1px solid #E5ECF3;"></th>
                                    <th style="padding: 4px 12px; border-bottom: 1px solid #E5ECF3;"></th>
                                    <th style="padding: 4px 12px; text-align: center; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Svcs</th>
                                    <th style="padding: 4px 12px; text-align: center; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Hours</th>
                                    <th style="padding: 4px 12px; text-align: center; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Svcs</th>
                                    <th style="padding: 4px 12px; text-align: center; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Hours</th>
                                    <th style="padding: 4px 12px; text-align: center; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Hours</th>
                                    <th style="padding: 4px 12px; border-bottom: 1px solid #E5ECF3;"></th>
                                    <th style="padding: 4px 12px; text-align: right; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Svcs</th>
                                    <th style="padding: 4px 12px; text-align: right; font-size: 10px; color: #999; border-bottom: 1px solid #E5ECF3;">Hours</th>
                                </tr>
                            </thead>
                            <tbody id="providerActivityList">
                                <tr><td colspan="10" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="providerActivityFooter" style="margin-top: 10px; font-size: 12px; color: #666; text-align: right;"></div>
                </div>
<!-- Historical Archive Section -->
                <div id="archiveSection" style="background: #E8F5E9; border: 1px solid #A5D6A7; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üìä Data Cache Status</h3>
                        <button class="btn btn-secondary" onclick="clearDashboardCache()" style="padding: 8px 12px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <polyline points="1 4 1 10 7 10"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                            Refresh Data
                        </button>
                    </div>
                    <div id="cacheStatusContent" style="font-size: 13px; color: #666;">
                        <p>Data is loaded by year for faster performance. Select a year from the dropdown above to view historical data.</p>
                        <div id="cachedYearsInfo" style="margin-top: 10px; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Client Insights Tab -->
            <div class="tab-panel" id="clientInsights-panel">
                <div style="padding: 20px 0;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="color: #1A365C; margin: 0; font-size: 24px;">üìä Client Insights</h2>
                            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Deep dive into client lifecycle, value, and care progression</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 13px; color: #666;">Analysis Year:</label>
                            <select id="insightsYearSelect" onchange="loadClientInsights()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">Loading...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshAllData()" style="padding: 8px 12px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="insightsLoading" style="display: none; text-align: center; padding: 60px 20px;">
                        <div class="spinner"></div>
                        <p style="color: #666; margin-top: 15px;">Analyzing client data...</p>
                    </div>
                    
                    <!-- Insights Content -->
                    <div id="insightsContent" style="display: none;">
                        
                        <!-- Row 1: Investor-Grade LTV Metrics -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üìä Investor-Grade LTV Analysis</h3>
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <label style="font-size: 12px; color: #666;">
                                        Gross Margin %: 
                                        <input type="number" id="ltvGrossMargin" value="70" min="0" max="100" step="5" 
                                            style="width: 60px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                            onchange="recalculateLTV()">
                                    </label>
                                    <button onclick="recalculateLTV()" style="background: #1A365C; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                        Recalculate
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Main LTV Display -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #1A365C 0%, #2D4A7C 100%); padding: 20px; border-radius: 12px; color: white;">
                                    <div style="font-size: 12px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        LTV (Gross Margin Basis)
                                        <span class="info-tooltip" style="cursor: help; opacity: 0.7; font-size: 14px;" title="LTV = ARPU √ó Gross Margin √ó Customer Lifespan

Formula: Monthly ARPU √ó (Gross Margin %) √ó (1 √∑ Monthly Churn Rate)

This is the investor-standard calculation using contribution margin, not top-line revenue.">‚ìò</span>
                                    </div>
                                    <div id="insightsLTV" style="font-size: 32px; font-weight: 700;">--</div>
                                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Per client lifetime value</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #62B790 0%, #4A9A73 100%); padding: 20px; border-radius: 12px; color: white;">
                                    <div style="font-size: 12px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        ARPU (Monthly)
                                        <span class="info-tooltip" style="cursor: help; opacity: 0.7; font-size: 14px;" title="ARPU = Total Monthly Revenue √∑ Active Customers

Average Revenue Per User, calculated on a monthly basis from the last 3 months of active client data.">‚ìò</span>
                                    </div>
                                    <div id="insightsARPU" style="font-size: 32px; font-weight: 700;">--</div>
                                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Avg revenue per client/month</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #F57600 0%, #E06500 100%); padding: 20px; border-radius: 12px; color: white;">
                                    <div style="font-size: 12px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        Monthly Churn Rate
                                        <span class="info-tooltip" style="cursor: help; opacity: 0.7; font-size: 14px;" title="Churn Rate = Clients Lost √∑ Total Clients (per month)

Calculated from cohort analysis: percentage of clients who stopped service each month over the past 12 months.

Customer Lifespan = 1 √∑ Monthly Churn Rate">‚ìò</span>
                                    </div>
                                    <div id="insightsChurnRate" style="font-size: 32px; font-weight: 700;">--</div>
                                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Avg monthly client loss rate</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); padding: 20px; border-radius: 12px; color: white;">
                                    <div style="font-size: 12px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        Avg Retention
                                        <span class="info-tooltip" style="cursor: help; opacity: 0.7; font-size: 14px;" title="Average Retention = 1 √∑ Monthly Churn Rate

Also known as Customer Lifespan. Based on real cohort retention data from historical client behavior.">‚ìò</span>
                                    </div>
                                    <div id="insightsRetention" style="font-size: 32px; font-weight: 700;">--</div>
                                    <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">Expected months retained</div>
                                </div>
                            </div>
                            
                            <!-- LTV Assumptions & Sensitivity -->
                            <div style="background: #F8FAFC; border-radius: 8px; padding: 15px;">
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                                    <!-- Assumptions Panel -->
                                    <div>
                                        <div style="font-size: 12px; font-weight: 600; color: #1A365C; margin-bottom: 10px;">üìã LTV ASSUMPTIONS</div>
                                        <div id="ltvAssumptions" style="font-size: 12px; color: #666; line-height: 1.8;">
                                            Loading assumptions...
                                        </div>
                                    </div>
                                    <!-- Sensitivity Panel -->
                                    <div>
                                        <div style="font-size: 12px; font-weight: 600; color: #1A365C; margin-bottom: 10px;">üìà SENSITIVITY ANALYSIS</div>
                                        <div id="ltvSensitivity" style="font-size: 11px; color: #666;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center;">
                                                <div style="background: #FEE2E2; padding: 8px; border-radius: 6px;">
                                                    <div style="font-size: 10px; color: #991B1B;">WORST</div>
                                                    <div id="ltvWorst" style="font-weight: 700; color: #DC2626;">--</div>
                                                    <div style="font-size: 9px; color: #999;">+50% churn</div>
                                                </div>
                                                <div style="background: #DBEAFE; padding: 8px; border-radius: 6px;">
                                                    <div style="font-size: 10px; color: #1E40AF;">BASE</div>
                                                    <div id="ltvBase" style="font-weight: 700; color: #1A365C;">--</div>
                                                    <div style="font-size: 9px; color: #999;">current</div>
                                                </div>
                                                <div style="background: #D1FAE5; padding: 8px; border-radius: 6px;">
                                                    <div style="font-size: 10px; color: #065F46;">BEST</div>
                                                    <div id="ltvBest" style="font-weight: 700; color: #059669;">--</div>
                                                    <div style="font-size: 9px; color: #999;">-25% churn</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Investor-Ready Summary Line -->
                                <div id="ltvSummaryLine" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #E5ECF3; font-size: 13px; font-weight: 500; color: #1A365C;">
                                    Loading investor summary...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Secondary Metrics -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: white; border: 1px solid #E5ECF3; padding: 20px; border-radius: 12px;">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;">Total Clients (All Time)</div>
                                <div id="insightsTotalClients" style="font-size: 28px; font-weight: 700; color: #1A365C;">--</div>
                            </div>
                            <div style="background: white; border: 1px solid #E5ECF3; padding: 20px; border-radius: 12px;">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;">Active Clients (30 days)</div>
                                <div id="insightsActiveClients" style="font-size: 28px; font-weight: 700; color: #62B790;">--</div>
                            </div>
                            <div style="background: white; border: 1px solid #E5ECF3; padding: 20px; border-radius: 12px;">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;">Avg Tenure</div>
                                <div id="insightsAvgTenure" style="font-size: 28px; font-weight: 700; color: #F57600;">--</div>
                            </div>
                            <div style="background: white; border: 1px solid #E5ECF3; padding: 20px; border-radius: 12px;">
                                <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;">Total Lifetime Revenue</div>
                                <div id="insightsTotalRevenue" style="font-size: 28px; font-weight: 700; color: #9C27B0;">--</div>
                            </div>
                        </div>
                        
                        <!-- Row 2.5: New Clients Per Week Chart -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #1A365C; margin: 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                    üÜï New Clients Per Week
                                    <span class="info-tooltip" style="cursor: help; opacity: 0.7; font-size: 14px;" 
                                          title="New Client = A client receiving their first-ever service in that week.

Left axis (bars): Count of new clients acquired
Right axis (line): Total hours scheduled for those new clients in their first week

Note: Clients starting later in the week will naturally show fewer first-week hours.">‚ìò</span>
                                </h3>
                                <div style="display: flex; gap: 20px; align-items: center;">
                                    <div style="text-align: center;">
                                        <div id="newClientsTotal" style="font-size: 22px; font-weight: 700; color: #1A365C;">--</div>
                                        <div style="font-size: 10px; color: #666;">Total (12 wks)</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div id="newClientsAvgCount" style="font-size: 22px; font-weight: 700; color: #62B790;">--</div>
                                        <div style="font-size: 10px; color: #666;">Avg/Week</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div id="newClientsAvgHours" style="font-size: 22px; font-weight: 700; color: #F57600;">--</div>
                                        <div style="font-size: 10px; color: #666;">Avg Hrs/Client</div>
                                    </div>
                                </div>
                            </div>
                            <div style="height: 280px;">
                                <canvas id="newClientsChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Investor Relations Section -->
                        <div style="background: linear-gradient(135deg, #1A365C 0%, #2D4A7C 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                                        üìß Investor Relations
                                        <span style="background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 400;">
                                            Q<span id="irCurrentQuarter">--</span> <span id="irCurrentYear">----</span>
                                        </span>
                                    </h3>
                                    <p style="margin: 5px 0 0 0; opacity: 0.8; font-size: 13px;">Log events, generate updates, and manage investor communications</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button id="btnLogEvent" onclick="showLogEventModal()" style="background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        Log Event
                                    </button>
                                    <button id="btnGenerateUpdate" onclick="generateInvestorEmail()" style="background: #F57600; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                        Generate Update
                                    </button>
                                    <button id="btnEmailHistory" onclick="showEmailHistoryModal()" style="background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        History
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quarter Events List -->
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-size: 12px; text-transform: uppercase; opacity: 0.8;">üìã Quarter Events (<span id="irEventCount">0</span>)</span>
                                    <button onclick="showLogEventModal()" style="background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 11px;">+ Add Event</button>
                                </div>
                                <div id="irEventsList" style="max-height: 150px; overflow-y: auto;">
                                    <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px; font-size: 13px;">
                                        No events logged for this quarter yet.<br>
                                        <span style="font-size: 11px;">Click "Log Event" to add milestones, wins, or notable updates.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Top Clients Last Week & Last Month -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <!-- Top Clients Last Week -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 id="insightsWeekTitle" style="color: #1A365C; margin: 0; font-size: 16px;">üèÜ Top Clients Last Week</h3>
                                    <select id="insightsWeekLimit" onchange="renderInsightsTopClients()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                    </select>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #F9FAFB;">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase;">#</th>
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase;">Client</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase;">Services</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase;">Hours</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase;">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="insightsTopClientsWeek">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Top Clients Last Month -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üèÜ Top Clients Last Month <span id="insightsMonthLabel" style="font-weight: 400; color: #666;">(--)</span></h3>
                                    <select id="insightsMonthLimit" onchange="renderInsightsTopClients()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                    </select>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #F9FAFB;">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase;">#</th>
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase;">Client</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase;">Services</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase;">Hours</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase;">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="insightsTopClientsMonth">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Row 3: Client Journey Analysis -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <h3 style="color: #1A365C; margin: 0 0 10px 0; font-size: 16px;">üìà Client Care Journey</h3>
                            <p style="font-size: 13px; color: #666; margin: 0 0 20px 0;">How clients progress from initial short services to longer care arrangements</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                                <div style="background: #F0F9FF; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Avg First Month</div>
                                    <div id="insightsFirstMonthHours" style="font-size: 24px; font-weight: 700; color: #1A365C;">--</div>
                                    <div style="font-size: 11px; color: #999;">hours/week</div>
                                </div>
                                <div style="background: #F0FFF4; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Avg 3rd Month</div>
                                    <div id="insightsThirdMonthHours" style="font-size: 24px; font-weight: 700; color: #62B790;">--</div>
                                    <div style="font-size: 11px; color: #999;">hours/week</div>
                                </div>
                                <div style="background: #FFF7ED; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Avg 6th Month</div>
                                    <div id="insightsSixthMonthHours" style="font-size: 24px; font-weight: 700; color: #F57600;">--</div>
                                    <div style="font-size: 11px; color: #999;">hours/week</div>
                                </div>
                                <div style="background: #FDF4FF; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px;">Avg Peak</div>
                                    <div id="insightsPeakHours" style="font-size: 24px; font-weight: 700; color: #9C27B0;">--</div>
                                    <div style="font-size: 11px; color: #999;">hours/week</div>
                                </div>
                            </div>
                            
                            <div style="background: #F9FAFB; padding: 15px; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="font-size: 13px; color: #666;">üìä Progression Rate:</span>
                                    <span id="insightsProgressionRate" style="font-size: 16px; font-weight: 600; color: #1A365C;">--</span>
                                    <span style="font-size: 12px; color: #999;">of clients increase hours after 3 months</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 13px; color: #666;">‚è±Ô∏è Avg Time to Peak:</span>
                                    <span id="insightsTimeToPeak" style="font-size: 16px; font-weight: 600; color: #1A365C;">--</span>
                                    <span style="font-size: 12px; color: #999;">months from first service</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 4: End of Care Analysis -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <h3 style="color: #1A365C; margin: 0 0 10px 0; font-size: 16px;">‚è≥ End of Care Analysis</h3>
                            <p style="font-size: 13px; color: #666; margin: 0 0 20px 0;">Understanding client transitions when care needs increase significantly</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                                <div style="background: #FEF2F2; border: 1px solid #FECACA; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #991B1B; text-transform: uppercase; margin-bottom: 5px;">High Care Threshold</div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">Clients exceeding 30+ hours/week</div>
                                    <div id="insightsHighCareCount" style="font-size: 28px; font-weight: 700; color: #DC2626;">--</div>
                                    <div style="font-size: 11px; color: #999;">clients historically</div>
                                </div>
                                <div style="background: #FEF3C7; border: 1px solid #FDE68A; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #92400E; text-transform: uppercase; margin-bottom: 5px;">Avg Time After Peak</div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">From peak hours to end of service</div>
                                    <div id="insightsTimeAfterPeak" style="font-size: 28px; font-weight: 700; color: #D97706;">--</div>
                                    <div style="font-size: 11px; color: #999;">months average</div>
                                </div>
                                <div style="background: #ECFDF5; border: 1px solid #A7F3D0; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #065F46; text-transform: uppercase; margin-bottom: 5px;">Still Active</div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">High-care clients with recent service</div>
                                    <div id="insightsHighCareActive" style="font-size: 28px; font-weight: 700; color: #059669;">--</div>
                                    <div style="font-size: 11px; color: #999;">clients</div>
                                </div>
                            </div>
                            
                            <!-- Clients Approaching Transition -->
                            <div style="background: #FFFBEB; border: 1px solid #FDE68A; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="color: #92400E; margin: 0; font-size: 14px;">‚ö†Ô∏è Clients Potentially Approaching Transition</h4>
                                    <span style="font-size: 11px; color: #666;">Based on historical patterns</span>
                                </div>
                                <p style="font-size: 12px; color: #666; margin: 0 0 15px 0;">Clients with 25+ hours/week who may be nearing end of home care based on typical progression patterns.</p>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: rgba(251, 191, 36, 0.2);">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #92400E; text-transform: uppercase;">Client</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #92400E; text-transform: uppercase;">Current Hrs/Wk</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #92400E; text-transform: uppercase;">Peak Hrs/Wk</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #92400E; text-transform: uppercase;">Tenure</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #92400E; text-transform: uppercase;">Est. Transition Window</th>
                                        </tr>
                                    </thead>
                                    <tbody id="insightsTransitionRisk">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Row 5: Client Lifetime Value Table -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üí∞ Client Lifetime Value Rankings</h3>
                                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">All-time revenue and engagement metrics by client</p>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="insightsLTVSearch" placeholder="Search client..." 
                                           style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; width: 200px;"
                                           onkeyup="filterLTVTable()">
                                    <select id="insightsLTVLimit" onchange="renderLTVTable()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="10" selected>Top 10</option>
                                        <option value="25">Top 25</option>
                                        <option value="50">Top 50</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
                                    <thead>
                                        <tr style="background: #F9FAFB;">
                                            <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                            <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Client Name</th>
                                            <th style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Lifetime Revenue</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Total Services</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Total Hours</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Tenure</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Status</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Last Service</th>
                                        </tr>
                                    </thead>
                                    <tbody id="insightsLTVTable">
                                        <tr><td colspan="8" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Provider Insights Tab -->
            <div class="tab-panel" id="providerInsights-panel">
                <div style="padding: 20px 0;">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="color: #1A365C; margin: 0; font-size: 24px;">üë• Provider Insights</h2>
                            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Workforce analytics, retention metrics, and caregiver performance</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 13px; color: #666;">Analysis Year:</label>
                            <select id="providerInsightsYearSelect" onchange="loadProviderInsights()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">Loading...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshAllData()" style="padding: 8px 12px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="providerInsightsLoading" style="display: none; text-align: center; padding: 60px 20px;">
                        <div class="spinner"></div>
                        <p style="color: #666; margin-top: 15px;">Analyzing provider data...</p>
                    </div>
                    
                    <!-- Provider Insights Content -->
                    <div id="providerInsightsContent" style="display: none;">
                        
                        <!-- Row 1: Workforce KPIs -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #1A365C 0%, #2D4A7C 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px;">Total Providers</div>
                                <div style="font-size: 28px; font-weight: 700;" id="piTotalProviders">--</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;" id="piTotalProvidersSubtext">all time</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #059669 0%, #10B981 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px;">Active Providers</div>
                                <div style="font-size: 28px; font-weight: 700;" id="piActiveProviders">--</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;" id="piActiveProvidersSubtext">last 30 days</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #F57600 0%, #FB923C 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px;">Avg Hours/Provider</div>
                                <div style="font-size: 28px; font-weight: 700;" id="piAvgHoursPerProvider">--</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;" id="piAvgHoursSubtext">per month</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #7C3AED 0%, #A78BFA 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px;">Retention Rate</div>
                                <div style="font-size: 28px; font-weight: 700;" id="piRetentionRate">--</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;" id="piRetentionSubtext">YTD</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%); padding: 20px; border-radius: 12px; color: white; text-align: center;">
                                <div style="font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 8px;">Churned Providers</div>
                                <div style="font-size: 28px; font-weight: 700;" id="piChurnedProviders">--</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;" id="piChurnedSubtext">90+ days inactive</div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Provider Status Breakdown & Tenure Distribution -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <!-- Provider Status Breakdown -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <h3 style="color: #1A365C; margin: 0 0 15px 0; font-size: 16px;">üìä Provider Status Breakdown</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="background: #E0F2F1; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #00897B;" id="piStatusActive">--</div>
                                        <div style="font-size: 12px; color: #00897B;">Active (0-30 days)</div>
                                    </div>
                                    <div style="background: #FFF8E1; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #F9A825;" id="piStatusDeclining">--</div>
                                        <div style="font-size: 12px; color: #F9A825;">Declining (31-60 days)</div>
                                    </div>
                                    <div style="background: #FFF3E0; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #EF6C00;" id="piStatusAtRisk">--</div>
                                        <div style="font-size: 12px; color: #EF6C00;">At Risk (61-90 days)</div>
                                    </div>
                                    <div style="background: #FFEBEE; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #C62828;" id="piStatusInactive">--</div>
                                        <div style="font-size: 12px; color: #C62828;">Inactive (90+ days)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tenure Distribution -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <h3 style="color: #1A365C; margin: 0 0 15px 0; font-size: 16px;">üìà Provider Tenure Distribution</h3>
                                <div id="piTenureDistribution" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Filled by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 3: Monthly Provider Trends Chart -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üìâ Provider Activity Trends</h3>
                                <div style="font-size: 12px; color: #666;">Monthly active providers & hours worked</div>
                            </div>
                            <div style="height: 280px;">
                                <canvas id="piTrendsChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Row 4: Top Performers & At-Risk Providers -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <!-- Top Performers Last Month -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üèÜ Top Performers <span id="piTopPerformersMonth" style="font-weight: 400; color: #666;">(--)</span></h3>
                                    <select id="piTopPerformersLimit" onchange="renderPITopPerformers()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                    </select>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #F9FAFB;">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Provider</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Services</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Hours</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="piTopPerformers">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- At-Risk Providers (Engagement Dropping) -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">‚ö†Ô∏è At-Risk Providers</h3>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 11px; color: #999;">Significant drop in hours</span>
                                        <select id="piAtRiskLimit" onchange="renderPIAtRiskProviders()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                            <option value="5" selected>Top 5</option>
                                            <option value="10">Top 10</option>
                                        </select>
                                    </div>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #FEF2F2;">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Provider</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Last Month</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Prior Month</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Change</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Last Service</th>
                                        </tr>
                                    </thead>
                                    <tbody id="piAtRiskProviders">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Row 5: New Hires & Churn Analysis -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <!-- New Providers (Recent Hires) -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üÜï New Providers <span id="piNewProvidersMonth" style="font-weight: 400; color: #666;">(Last 90 Days)</span></h3>
                                    <select id="piNewProvidersLimit" onchange="renderPINewProviders()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                    </select>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #F0FDF4;">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #BBF7D0;">Provider</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #BBF7D0;">First Service</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #BBF7D0;">Services</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #BBF7D0;">Hours</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #BBF7D0;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="piNewProviders">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Recently Churned -->
                            <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üì§ Recently Churned</h3>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 11px; color: #999;">90+ days since last service</span>
                                        <select id="piChurnedLimit" onchange="renderPIChurnedProviders()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                            <option value="5" selected>Top 5</option>
                                            <option value="10">Top 10</option>
                                        </select>
                                    </div>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #FEF2F2;">
                                            <th style="padding: 8px 10px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Provider</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Last Service</th>
                                            <th style="padding: 8px 10px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Total Tenure</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Lifetime Hours</th>
                                            <th style="padding: 8px 10px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #FECACA;">Lifetime Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody id="piChurnedProvidersList">
                                        <tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Row 6: Provider Lifetime Value Table -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <h3 style="color: #1A365C; margin: 0; font-size: 16px;">üìã All Providers Summary</h3>
                                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Complete workforce overview with lifetime metrics</p>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="piProviderSearch" placeholder="Search provider..." 
                                           style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; width: 200px;"
                                           onkeyup="filterPIProviderTable()">
                                    <select id="piProviderStatusFilter" onchange="renderPIAllProviders()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="all">All Status</option>
                                        <option value="active">Active Only</option>
                                        <option value="declining">Declining</option>
                                        <option value="at-risk">At Risk</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                    <select id="piProviderLimit" onchange="renderPIAllProviders()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                    </select>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                                    <thead>
                                        <tr style="background: #F9FAFB;">
                                            <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">#</th>
                                            <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Provider Name</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Status</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Tenure</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Total Services</th>
                                            <th style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Total Hours</th>
                                            <th style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Lifetime Revenue</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Avg Hrs/Month</th>
                                            <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Last Service</th>
                                        </tr>
                                    </thead>
                                    <tbody id="piAllProvidersTable">
                                        <tr><td colspan="9" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Row 7: On-Call Staff Utilization -->
                        <div style="background: white; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <h3 style="color: #1A365C; margin: 0; font-size: 18px;">‚è±Ô∏è On-Call Staff Utilization</h3>
                                    <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Compare scheduled on-call hours vs actual service hours worked</p>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select id="oncallPeriodFilter" onchange="loadOncallUtilization()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                        <!-- Will be populated dynamically with week numbers -->
                                    </select>
                                    <button onclick="loadOncallUtilization()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                                        üîÑ Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- On-Call KPIs -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span id="oncallPeriodLabel" style="font-size: 12px; color: #666; font-weight: 500;">Showing: Last 90 Days</span>
                                <span style="font-size: 11px; color: #999;">Utilization = Service Hours √∑ Actual Hours (from Time Card)</span>
                            </div>
                            <div id="oncallKPIs" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="background: #F0F9FF; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; text-transform: uppercase; color: #0369A1; margin-bottom: 5px;">Total On-Call Staff</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #0369A1;" id="oncallTotalStaff">--</div>
                                </div>
                                <div style="background: #FEF3C7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; text-transform: uppercase; color: #92400E; margin-bottom: 5px;">Actual Hours</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #92400E;" id="oncallScheduledHours">--</div>
                                </div>
                                <div style="background: #DCFCE7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; text-transform: uppercase; color: #166534; margin-bottom: 5px;">Service Hours Worked</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #166534;" id="oncallWorkedHours">--</div>
                                </div>
                                <div style="background: #EDE9FE; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; text-transform: uppercase; color: #5B21B6; margin-bottom: 5px;">Avg Utilization</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #5B21B6;" id="oncallAvgUtilization">--%</div>
                                </div>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="oncallLoading" style="display: none; text-align: center; padding: 40px;">
                                <div class="spinner"></div>
                                <p style="color: #666; margin-top: 15px;">Loading on-call schedule data...</p>
                            </div>
                            
                            <!-- On-Call Utilization Table -->
                            <div id="oncallTableContainer" style="display: none;">
                                <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                                    <select id="oncallLimit" onchange="renderOncallUtilizationTable(window.oncallUtilizationData || [])" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                    </select>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                                        <thead>
                                            <tr style="background: #F9FAFB;">
                                                <th style="padding: 10px 12px; text-align: left; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Provider</th>
                                                <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">On-Call Shifts</th>
                                                <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Services Worked</th>
                                                <th style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Actual Hours</th>
                                                <th style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Service Hours</th>
                                                <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Utilization</th>
                                                <th style="padding: 10px 12px; text-align: right; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Idle Hours</th>
                                                <th style="padding: 10px 12px; text-align: center; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 2px solid #E5ECF3;">Trend</th>
                                            </tr>
                                        </thead>
                                        <tbody id="oncallUtilizationTable">
                                            <tr><td colspan="8" style="text-align: center; color: #999; padding: 20px;">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- No Data State -->
                            <div id="oncallNoData" style="display: none; text-align: center; padding: 40px; color: #666;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 15px; opacity: 0.5;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                <p>No on-call schedule data found for this period.</p>
                                <p style="font-size: 12px; margin-top: 5px;">Make sure the On-Call sheet has data in the selected date range.</p>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeClientDetail()"></div>
    
    <!-- Client Detail Sidebar -->
    <div class="client-sidebar" id="clientSidebar">
        <div class="sidebar-header">
            <button class="close-sidebar" onclick="closeClientDetail()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <h2 id="detailClientName">Client Name</h2>
            <p id="detailCustomerName">Customer Name (links to Report)</p>
        </div>
        <div class="sidebar-body">
            <!-- Email Routing Section -->
            <div class="sidebar-section">
                <h3>Email Routing</h3>
                <div id="emailRouteIndicator" style="display: flex; align-items: center; gap: 10px; padding: 15px; border-radius: 8px; background: #E3F2FD; border: 1px solid #2196F3;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2" style="width: 24px; height: 24px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <div>
                        <div id="routeType" style="font-weight: 600; font-size: 13px; color: #1A365C;">Routing to Insurance</div>
                        <div id="routeEmail" style="font-size: 12px; color: #666;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="12707b7e7e7b7c7552737e7b7177717360773c717d7f">[email&#160;protected]</a></div>
                    </div>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="sidebar-section">
                <h3>Contact Information</h3>
                <div class="detail-row" style="flex-direction: column; align-items: stretch;">
                    <span class="label">Client Email</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="sidebarClientEmail" style="flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="email1@example.com, email2@example.com">
                        <button onclick="updateClientEmail()" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;">Save</button>
                    </div>
                    <p style="font-size: 10px; color: #999; margin-top: 4px;">Multiple emails separated by comma</p>
                </div>
                <div class="detail-row">
                    <span class="label">Phone</span>
                    <span class="value" id="detailPhone">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Address</span>
                    <span class="value" id="detailAddress">--</span>
                </div>
            </div>
            
            <!-- Insurance Information -->
            <div class="sidebar-section">
                <h3>Insurance Information</h3>
                <div class="detail-row">
                    <span class="label">Insurance Name</span>
                    <span class="value" id="detailInsurance">--</span>
                </div>
                <div class="detail-row" style="flex-direction: column; align-items: stretch;">
                    <span class="label">Insurance Email</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="sidebarInsuranceEmail" style="flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="claims@ins.com, adjuster@ins.com">
                        <button onclick="updateInsuranceEmail()" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;">Save</button>
                    </div>
                    <p style="font-size: 10px; color: #999; margin-top: 4px;">Multiple emails separated by comma</p>
                </div>
                <div class="detail-row">
                    <span class="label">Policy #</span>
                    <span class="value" id="detailPolicy">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Claim #</span>
                    <span class="value" id="detailClaim">--</span>
                </div>
                <div id="emailSaveStatus" style="font-size: 11px; color: #62B790; margin-top: 8px; display: none;">
                    ‚úì Email updated
                </div>
            </div>
            
            <!-- Service Codes -->
            <div class="sidebar-section">
                <h3>Service Codes</h3>
                <div id="detailServiceCodes" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Service Summary</h3>
                <div class="detail-row">
                    <span class="label">Total Services</span>
                    <span class="value" id="detailTotalServices">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Completed</span>
                    <span class="value" id="detailCompleted">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Total Hours</span>
                    <span class="value" id="detailTotalHours">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Total Spent</span>
                    <span class="value" id="detailTotalSpent">--</span>
                </div>
            </div>
            
            <!-- Report Subscription -->
            <div class="sidebar-section">
                <h3>Report Subscription</h3>
                <p style="font-size: 13px; color: #999; margin-bottom: 15px;">
                    Select which reports to auto-send.
                </p>
                <div style="display: flex; flex-direction: column; gap: 10px; padding: 15px; border-radius: 8px; background: #F9FAFB;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sidebarSubWeekly" onchange="updateSubscription()" style="width: 18px; height: 18px; accent-color: #2196F3;">
                        <span style="background: #E3F2FD; color: #2196F3; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500;">Weekly</span>
                        <span style="font-size: 11px; color: #999;">Every Monday</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sidebarSubMonthly" onchange="updateSubscription()" style="width: 18px; height: 18px; accent-color: #62B790;">
                        <span style="background: #E0F1E9; color: #62B790; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500;">Monthly</span>
                        <span style="font-size: 11px; color: #999;">1st of month</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sidebarSubYearly" onchange="updateSubscription()" style="width: 18px; height: 18px; accent-color: #F57600;">
                        <span style="background: #FFF3E0; color: #F57600; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500;">Yearly</span>
                        <span style="font-size: 11px; color: #999;">January 1st</span>
                    </label>
                </div>
                <div id="subscriptionSaveStatus" style="font-size: 11px; color: #62B790; margin-top: 8px; display: none;">
                    ‚úì Subscription updated
                </div>
            </div>
            
            <!-- Actions -->
            <div class="sidebar-section">
                <h3>Actions</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="sendClientReport()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        Send Report/Invoice
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="viewClientReports()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        View All Reports
                    </button>
                    <button class="btn btn-green" style="width: 100%;" onclick="editClient()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Edit Client
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="clientModalTitle">Add New Client</h2>
                <button class="close-modal" onclick="closeClientModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="filter-group">
                            <label>First Name *</label>
                            <input type="text" id="formFName" required>
                        </div>
                        <div class="filter-group">
                            <label>Last Name *</label>
                            <input type="text" id="formLName" required>
                        </div>
                        <div class="filter-group" style="grid-column: 1 / -1;">
                            <label>Address</label>
                            <input type="text" id="formAddress" placeholder="Street address, City, State ZIP">
                        </div>
                        <div class="filter-group">
                            <label>Email</label>
                            <input type="text" id="formEmail" placeholder="email1@example.com, email2@example.com">
                            <p style="font-size: 10px; color: #999; margin-top: 2px;">Multiple emails separated by comma</p>
                        </div>
                        <div class="filter-group">
                            <label>Phone</label>
                            <input type="tel" id="formPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="filter-group" style="position: relative;">
                            <label>Insurance Name</label>
                            <input type="text" id="formInsuranceName" placeholder="Start typing to search..." autocomplete="off" oninput="searchInsurance(this.value)" onfocus="searchInsurance(this.value)">
                            <div id="insuranceDropdown" class="autocomplete-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                        <div class="filter-group">
                            <label>Insurance Email</label>
                            <input type="text" id="formInsuranceEmail" placeholder="claims@ins.com, adjuster@ins.com">
                            <p style="font-size: 10px; color: #999; margin-top: 2px;">Auto-filled when selecting insurance, or enter manually</p>
                        </div>
                        <div class="filter-group">
                            <label>Policy #</label>
                            <input type="text" id="formPolicy" placeholder="Policy number">
                        </div>
                        <div class="filter-group">
                            <label>Claim #</label>
                            <input type="text" id="formClaim" placeholder="Claim number">
                        </div>
                        <div class="filter-group">
                            <label>Assignment</label>
                            <select id="formAssignment">
                                <option value="0">0 - Route to Insurance</option>
                                <option value="1">1 - Route to Billing</option>
                            </select>
                        </div>
                        <div class="filter-group" style="grid-column: 1 / -1;">
                            <label>Report Subscription</label>
                            <div style="display: flex; gap: 20px; padding: 12px; background: #F9FAFB; border-radius: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="formSubWeekly" style="width: 18px; height: 18px; accent-color: #2196F3;">
                                    <span style="background: #E3F2FD; color: #2196F3; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Weekly</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="formSubMonthly" style="width: 18px; height: 18px; accent-color: #62B790;">
                                    <span style="background: #E0F1E9; color: #62B790; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Monthly</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="formSubYearly" style="width: 18px; height: 18px; accent-color: #F57600;">
                                    <span style="background: #FFF3E0; color: #F57600; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Yearly</span>
                                </label>
                            </div>
                        </div>
                        <div class="filter-group" style="grid-column: 1 / -1;">
                            <label>Customer Name (Links to Reports)</label>
                            <input type="text" id="formCustomerName" placeholder="Must match Customer Name in Report tab">
                            <p style="font-size: 11px; color: #999; margin-top: 4px;">This field links the client to their service reports</p>
                        </div>
                    </div>
                    
                    <h4 style="color: #1A365C; margin: 20px 0 15px; font-size: 14px;">Service Codes</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #F9FAFB; padding: 15px; border-radius: 8px;">
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">BA</label>
                            <input type="text" id="formBA" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">DR</label>
                            <input type="text" id="formDR" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">TR</label>
                            <input type="text" id="formTR" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">CO</label>
                            <input type="text" id="formCO" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">TO</label>
                            <input type="text" id="formTO" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">EA</label>
                            <input type="text" id="formEA" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">AM</label>
                            <input type="text" id="formAM" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">CS</label>
                            <input type="text" id="formCS" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">HM</label>
                            <input type="text" id="formHM" style="padding: 8px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClientModal()">Cancel</button>
                <button class="btn btn-primary" id="saveClientBtn" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <!-- Send Report Modal -->
    <div class="modal-overlay" id="sendReportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Send Report</h2>
                <button class="close-modal" onclick="closeSendReportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #3D3D3D;">
                    Select the time period for the report to be sent to: <strong id="sendReportClientName">Client</strong>
                </p>
                
                <div class="filter-group" style="margin-bottom: 15px;">
                    <label>Report Type</label>
                    <select id="reportPeriodType" onchange="toggleReportPeriodInputs()">
                        <option value="week">Weekly Report</option>
                        <option value="month">Monthly Report</option>
                        <option value="year">Yearly Report</option>
                    </select>
                </div>
                
                <div id="weekInputGroup" class="filter-group" style="margin-bottom: 15px;">
                    <label>Week Number</label>
                    <input type="number" id="reportWeekNumber" placeholder="Enter week number (1-53)" min="1" max="53">
                </div>
                
                <div id="monthInputGroup" class="filter-group" style="margin-bottom: 15px; display: none;">
                    <label>Month</label>
                    <select id="reportMonth">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                
                <div id="yearInputGroup" class="filter-group" style="margin-bottom: 15px;">
                    <label>Year</label>
                    <select id="reportYear">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
                
                <div id="yearlyReportNote" style="display: none; padding: 12px; background: #E8F5E9; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #2E7D32;">
                    üìä Yearly reports include a summary of all services for the selected year.
                </div>
                
                <div id="sendReportDestination" style="padding: 15px; border-radius: 8px; background: #E3F2FD; margin-top: 15px;">
                    <div style="font-size: 13px; color: #666;">Report will be sent to:</div>
                    <div id="sendReportEmail" style="font-weight: 600; color: #1A365C; margin-top: 5px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5133383d3d383f3611303d383234323023347f323e3c">[email&#160;protected]</a></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSendReportModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmSendReportBtn" onclick="confirmSendReport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Send Report
                </button>
            </div>
        </div>
    </div>

    <!-- Upload CSV Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Service Report CSV</h2>
                <button class="close-modal" onclick="closeUploadModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="notice-box">
                    <h3>üìã Upload Instructions</h3>
                    <p>Upload your service report CSV file. The data will replace existing records, and formula columns (Week, Month, Year, StartTIME, EndTIME, STxTime, ETxTime) will be automatically extended to all new rows.</p>
                    <p><strong>Expected columns:</strong> Customer Name, Scheduled Date, Scheduled Time, Provider Name, Start Time, Completion Time, Service Duration, Provider Pay, Cost To Customer, Service Plan, Payment Status, Status</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileSelect(event)" style="display: none;">
                    <div class="upload-dropzone" onclick="document.getElementById('csvFileInput').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 15px; stroke: #F57600;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p style="font-weight: 600; color: #1A365C; margin-bottom: 5px;">Click to select CSV file</p>
                        <p style="font-size: 13px; color: #999;">or drag and drop here</p>
                    </div>
                </div>
                
                <div id="filePreview" style="display: none; margin-top: 20px;">
                    <div class="file-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; stroke: #62B790;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <div>
                            <p id="fileName" style="font-weight: 600; color: #1A365C;"></p>
                            <p id="fileSize" style="font-size: 12px; color: #999;"></p>
                        </div>
                        <button class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px;" onclick="clearFileSelection()">Remove</button>
                    </div>
                    <div id="previewStats" style="margin-top: 15px; padding: 15px; background: #E5ECF3; border-radius: 8px;">
                        <p style="font-size: 13px; color: #3D3D3D;"><strong>Rows detected:</strong> <span id="rowCount">0</span></p>
                        <p style="font-size: 13px; color: #3D3D3D;"><strong>Columns:</strong> <span id="colCount">0</span></p>
                    </div>
                </div>
                
                <div class="upload-options" style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="radio" name="uploadMode" value="replace" checked style="accent-color: #F57600;">
                        <span><strong>Replace</strong> - Clear existing data and upload new</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                        <input type="radio" name="uploadMode" value="append" style="accent-color: #F57600;">
                        <span><strong>Append</strong> - Add to existing data</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadCSVFile()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Automation Settings Modal -->
    <div class="modal-overlay" id="automationModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; display: inline; vertical-align: middle; margin-right: 8px;">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Report Automation Settings
                </h2>
                <button class="close-modal" onclick="closeAutomationSettings()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Global Pause Control -->
                <div style="background: #FFF3E0; border: 2px solid #F57600; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #1A365C; margin: 0 0 5px 0; font-size: 16px;">‚è∏Ô∏è Master Control</h3>
                            <p style="color: #666; font-size: 13px; margin: 0;">Pause all automated report sending</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="configPauseAll" onchange="togglePauseAll()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label" id="pauseAllLabel">Active</span>
                        </label>
                    </div>
                </div>
                
                <!-- Test Mode -->
                <div style="background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #1A365C; margin: 0 0 5px 0; font-size: 14px;">üß™ Test Mode</h3>
                            <p style="color: #666; font-size: 12px; margin: 0;">Send all test reports to a single email instead of actual recipients</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="configTestMode" onchange="toggleTestMode()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label" id="testModeLabel">Off</span>
                        </label>
                    </div>
                    <div id="testEmailContainer" style="margin-top: 15px; display: none;">
                        <label style="font-size: 12px; color: #666;">Test Email Address</label>
                        <input type="email" id="configTestEmail" placeholder="your-test-email@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <!-- Weekly Reports Config -->
                    <div id="weeklyConfigCard" style="background: #E3F2FD; border: 1px solid #2196F3; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #2196F3; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">WEEKLY</span>
                            </div>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="configWeeklyEnabled" checked onchange="toggleReportType('weekly')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="weeklyConfigFields">
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Upload Window</label>
                                <select id="configWeeklyUploadDays" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="Mon-Tue">Monday - Tuesday</option>
                                    <option value="Mon-Wed">Monday - Wednesday</option>
                                    <option value="Tue-Wed">Tuesday - Wednesday</option>
                                </select>
                            </div>
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send Delay (hours)</label>
                                <input type="number" id="configWeeklyDelay" value="2" min="0" max="48" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px;">
                                üìå Sends <strong>previous week</strong> data
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Reports Config -->
                    <div id="monthlyConfigCard" style="background: #E0F1E9; border: 1px solid #62B790; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #62B790; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">MONTHLY</span>
                            </div>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="configMonthlyEnabled" checked onchange="toggleReportType('monthly')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="monthlyConfigFields">
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send On Day</label>
                                <input type="number" id="configMonthlySendDay" value="10" min="1" max="28" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send Time</label>
                                <input type="time" id="configMonthlySendTime" value="09:00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px;">
                                üìå Sends <strong>previous month</strong> data
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yearly Reports Config -->
                    <div id="yearlyConfigCard" style="background: #FFF3E0; border: 1px solid #F57600; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #F57600; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">YEARLY</span>
                            </div>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="configYearlyEnabled" checked onchange="toggleReportType('yearly')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="yearlyConfigFields">
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send On Date</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="configYearlySendMonth" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="1" selected>January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                    </select>
                                    <input type="number" id="configYearlySendDay" value="15" min="1" max="28" style="width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send Time</label>
                                <input type="time" id="configYearlySendTime" value="09:00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px;">
                                üìå Sends <strong>previous year</strong> data
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Test Actions -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #E5ECF3;">
                    <h3 style="color: #1A365C; margin: 0 0 15px 0; font-size: 14px;">üß™ Test & Manual Actions</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn btn-secondary" onclick="testSendSingleReport()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Test Single Report
                        </button>
                        <button class="btn btn-blue" onclick="triggerManualSend('weekly')">
                            Send All Weekly
                        </button>
                        <button class="btn btn-green" onclick="triggerManualSend('monthly')">
                            Send All Monthly
                        </button>
                        <button class="btn btn-primary" onclick="triggerManualSend('yearly')">
                            Send All Yearly
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAutomationSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAutomationConfig()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Test Report Modal -->
    <div class="modal-overlay" id="testReportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üß™ Send Test Report</h2>
                <button class="close-modal" onclick="closeTestReportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 13px; color: #333;">
                        <strong>Test Email:</strong> <span id="testReportEmailDisplay">Not set</span>
                    </p>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Search Client</label>
                    <div style="position: relative;">
                        <input type="text" id="testClientSearch" placeholder="Type to search clients..." 
                               oninput="searchTestClients()" onfocus="searchTestClients()"
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <div id="testClientDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    <input type="hidden" id="testClientSelected">
                </div>
                
                <div id="testClientInfo" style="display: none; background: #F9FAFB; border: 1px solid #E5ECF3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1A365C; font-size: 14px;">Selected Client</h4>
                    <p style="margin: 0; font-size: 13px;" id="testClientName">--</p>
                    <p style="margin: 5px 0 0; font-size: 12px; color: #666;" id="testClientEmail">--</p>
                    <p style="margin: 5px 0 0; font-size: 12px; color: #666;" id="testClientSubscription">--</p>
                    
                    <!-- Invoice Preview Section -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #E5ECF3;">
                        <button onclick="previewInvoice()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üßæ Preview Invoice Info
                        </button>
                        <div id="invoicePreviewResult" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Report Type</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="testReportType" value="weekly" checked style="display: none;" onchange="updateReportTypeSelection()">
                            <div class="report-type-option" id="optWeekly" style="padding: 12px; border: 2px solid #2196F3; background: #E3F2FD; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #2196F3;">Weekly</span>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="testReportType" value="monthly" style="display: none;" onchange="updateReportTypeSelection()">
                            <div class="report-type-option" id="optMonthly" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #666;">Monthly</span>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="testReportType" value="yearly" style="display: none;" onchange="updateReportTypeSelection()">
                            <div class="report-type-option" id="optYearly" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #666;">Yearly</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Period Selection -->
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Period to Send</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <div id="testPeriodWeekContainer">
                            <label style="font-size: 12px; color: #666;">Week Number</label>
                            <input type="number" id="testPeriodWeek" min="1" max="52" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div id="testPeriodMonthContainer" style="display: none;">
                            <label style="font-size: 12px; color: #666;">Month</label>
                            <select id="testPeriodMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Year</label>
                            <input type="number" id="testPeriodYear" min="2020" max="2030" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #999; margin-top: 8px;">Leave defaults for previous period, or specify a custom period to test</p>
                </div>
                
                <div id="testReportStatus" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTestReportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendTestReportFromModal()" id="sendTestBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                    Send Test Report
                </button>
            </div>
        </div>
    </div>

    <!-- LTC Import Modal -->
    <div class="modal-overlay" id="ltcImportModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2>üì• Import Client from LTC Intake</h2>
                <button class="close-modal" onclick="closeLTCImportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
                <div id="ltcLoadingState" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Loading LTC Intake records...</p>
                </div>
                
                <div id="ltcRecordsList" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="ltcSearchInput" placeholder="Search by name, email, or insurance..." 
                               oninput="filterLTCRecords()" 
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div id="ltcRecordsTable" style="overflow-x: auto;">
                        <!-- Records will be populated here -->
                    </div>
                </div>
                
                <div id="ltcNoRecords" style="display: none; text-align: center; padding: 40px;">
                    <p style="color: #666;">No LTC Intake records found.</p>
                </div>
                
                <div id="ltcError" style="display: none; text-align: center; padding: 40px;">
                    <p style="color: #C62828;" id="ltcErrorMessage">Error loading records.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLTCImportModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- LTC Import Confirmation Modal -->
    <div class="modal-overlay" id="ltcConfirmModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Confirm Import</h2>
                <button class="close-modal" onclick="closeLTCConfirmModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="ltcConfirmContent">
                    <!-- Will be populated dynamically -->
                </div>
                
                <div id="ltcDuplicateWarning" style="display: none; background: #FFF3E0; border: 1px solid #F57600; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 style="color: #F57600; margin: 0 0 10px 0;">‚ö†Ô∏è Potential Duplicate Found</h4>
                    <div id="ltcDuplicateDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLTCConfirmModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmLTCImport()" id="ltcConfirmBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Import Client
                </button>
                <button class="btn btn-warning" onclick="forceImportLTC()" id="ltcForceImportBtn" style="display: none; background: #F57600;">
                    Import Anyway
                </button>
            </div>
        </div>
    </div>

    <!-- Log Event Modal -->
    <div class="modal-overlay" id="logEventModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2>üìù Log Quarter Event</h2>
                <button class="close-modal" onclick="closeLogEventModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                    Log significant events, milestones, or updates that should be included in investor communications.
                </p>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1A365C;">Event Date</label>
                    <input type="date" id="eventDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1A365C;">Category</label>
                    <select id="eventCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="milestone">üéØ Milestone</option>
                        <option value="client">üë• Client Win</option>
                        <option value="partnership">ü§ù Partnership</option>
                        <option value="product">üöÄ Product/Service Update</option>
                        <option value="team">üëî Team Update</option>
                        <option value="financial">üí∞ Financial</option>
                        <option value="recognition">üèÜ Recognition/Award</option>
                        <option value="challenge">‚ö†Ô∏è Challenge/Risk</option>
                        <option value="other">üìå Other</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1A365C;">Event Title</label>
                    <input type="text" id="eventTitle" placeholder="Brief title for the event" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1A365C;">Description</label>
                    <textarea id="eventDescription" rows="4" placeholder="Detailed description of the event and its significance..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="eventHighlight" style="width: 18px; height: 18px;">
                        <span style="font-size: 13px; color: #666;">‚≠ê Highlight in investor update (key achievement)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLogEventModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEvent()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Event
                </button>
            </div>
        </div>
    </div>

    <!-- Generate/Edit Investor Email Modal -->
    <div class="modal-overlay" id="investorEmailModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>üìß Investor Update - Q<span id="emailQuarter">--</span> <span id="emailYear">----</span></h2>
                <button class="close-modal" onclick="closeInvestorEmailModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
                    <!-- Email Editor -->
                    <div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1A365C;">Subject Line</label>
                            <input type="text" id="emailSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div class="form-group">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #1A365C;">Email Body</label>
                            <textarea id="emailBody" rows="20" style="width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; resize: vertical;"></textarea>
                        </div>
                    </div>
                    
                    <!-- Sidebar: Reference & Tools -->
                    <div style="background: #F8FAFC; padding: 15px; border-radius: 8px; height: fit-content;">
                        <h4 style="margin: 0 0 15px 0; color: #1A365C; font-size: 14px;">üîß Tools</h4>
                        
                        <button onclick="regenerateEmail()" style="width: 100%; padding: 10px; background: #1A365C; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-bottom: 10px;">
                            üîÑ Regenerate Draft
                        </button>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 11px; color: #666; margin-bottom: 5px; text-transform: uppercase;">Upload Past Email (Reference)</label>
                            <input type="file" id="pastEmailUpload" accept=".txt,.html,.eml" onchange="handlePastEmailUpload(event)" style="width: 100%; font-size: 11px;">
                        </div>
                        
                        <div style="border-top: 1px solid #E5ECF3; padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1A365C; font-size: 13px;">üìä Quarter Metrics</h4>
                            <div id="emailMetricsSummary" style="font-size: 11px; color: #666; line-height: 1.8;">
                                Loading metrics...
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #E5ECF3; padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1A365C; font-size: 13px;">üìã Events (<span id="emailEventCount">0</span>)</h4>
                            <div id="emailEventsList" style="font-size: 11px; color: #666; max-height: 150px; overflow-y: auto;">
                                No events logged
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #E5ECF3; padding-top: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1A365C; font-size: 13px;">üìÅ Past Emails</h4>
                            <div id="emailPastReferences" style="font-size: 11px; color: #666; max-height: 100px; overflow-y: auto;">
                                No past emails uploaded
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeInvestorEmailModal()">Cancel</button>
                <div style="display: flex; gap: 10px;">
                    <button id="btnSaveDraft" class="btn btn-secondary" onclick="saveDraftEmail()">
                        üíæ Save Draft
                    </button>
                    <button id="btnMarkSent" class="btn btn-primary" onclick="markEmailSent()" style="background: #62B790;">
                        ‚úì Mark as Sent
                    </button>
                    <button id="btnCopyEmail" class="btn btn-primary" onclick="copyEmailToClipboard()">
                        üìã Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email History Modal -->
    <div class="modal-overlay" id="emailHistoryModal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>üìÅ Investor Email History</h2>
                <button class="close-modal" onclick="closeEmailHistoryModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <p style="color: #666; font-size: 13px; margin: 0;">
                        View and manage past investor communications.
                    </p>
                    <div>
                        <input type="file" id="importPastEmailFile" accept=".txt,.html,.eml" multiple onchange="importPastEmails(event)" style="display: none;">
                        <button onclick="document.getElementById('importPastEmailFile').click()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üì§ Import Past Emails
                        </button>
                    </div>
                </div>
                
                <div id="emailHistoryList" style="min-height: 200px;">
                    <div style="text-align: center; color: #999; padding: 40px;">
                        No email history yet.<br>
                        <span style="font-size: 12px;">Generate your first investor update or import past emails.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby9_bAzLkMv85BLy8OGbTav9hnX4vPp0hiTF-0xzgUo4Bpk2Nh_XkBuJWThpyqq-bpl/exec'; // Replace with your deployed Web App URL
        const ROWS_PER_PAGE = 25;
        const PAGE_SIZE = 20;  // For client pagination
        
        // LTC Import state
        let ltcRecords = [];
        let selectedLTCRecord = null;
        
        // State
        // Default to dashboard/client insights experience for this page
        let currentTab = 'dashboard';
        let reportData = [];
        let clientData = [];
        let currentPage = 1;
        let selectedClient = null;
        
        // Dashboard data cache - stores data by year to avoid re-fetching
        // Now persisted to localStorage for cross-session caching
        let dashboardDataCache = {};
        let availableYears = [];
        
        // Track which tabs have been rendered with current cache
        let tabsRendered = {
            dashboard: false,
            clientInsights: false,
            providerInsights: false
        };
        
        // Track if initial data load has happened
        let initialDataLoaded = false;
        
        // On-call data cache
        let oncallDataCache = null;
        
        // LocalStorage keys for persistent caching
        const CACHE_STORAGE_KEY = 'aliceCare_dashboardCache';
        const CACHE_TIMESTAMP_KEY = 'aliceCare_cacheTimestamp';
        const CACHE_VERSION_KEY = 'aliceCare_cacheVersion';
        const CURRENT_CACHE_VERSION = '1.0'; // Increment to invalidate old caches
        
        // Initialize cache from localStorage on page load
        // Cache freshness threshold in hours (data older than this will be refreshed)
        const CACHE_FRESHNESS_HOURS = 4;
        
        // ============================================
        // GOOGLE SHEETS CACHE FUNCTIONS
        // ============================================
        
        /**
         * Try to load dashboard data from Google Sheets cache first
         * This allows all users to benefit from pre-calculated data
         */
        async function loadFromGoogleSheetsCache(year) {
            try {
                console.log(`Checking Google Sheets cache for year ${year}...`);
                
                const result = await jsonpFetch({
                    action: 'getDashboardCache',
                    dataType: 'dashboard',
                    year: year.toString()
                });
                
                if (result.success && result.found && result.data) {
                    console.log(`Google Sheets cache hit for ${year}: ${result.cacheAgeHours} hours old, fresh: ${result.isFresh}`);
                    return {
                        success: true,
                        data: result.data,
                        isFresh: result.isFresh,
                        lastUpdated: result.lastUpdated,
                        cacheAgeHours: parseFloat(result.cacheAgeHours)
                    };
                }
                
                console.log(`Google Sheets cache miss for ${year}: ${result.reason || 'Not found'}`);
                return { success: false, reason: result.reason || 'Not found' };
                
            } catch (error) {
                console.warn('Error loading from Google Sheets cache:', error);
                return { success: false, reason: error.message };
            }
        }
        
        /**
         * Update the Google Sheets cache (triggers server-side refresh)
         * The server fetches and caches the data itself to avoid URL length limits
         */
        async function updateGoogleSheetsCache(year) {
            try {
                console.log(`Triggering server-side cache update for ${year}...`);
                
                const result = await jsonpFetch({
                    action: 'updateDashboardCache',
                    dataType: 'dashboard',
                    year: year.toString()
                });
                
                if (result.success) {
                    console.log(`Google Sheets cache updated for ${year} (${result.recordCount} records)`);
                    return { success: true, lastUpdated: result.lastUpdated };
                }
                
                console.warn('Failed to update Google Sheets cache:', result.error);
                return { success: false, error: result.error };
                
            } catch (error) {
                console.warn('Error updating Google Sheets cache:', error);
                return { success: false, error: error.message };
            }
        }
        
        /**
         * Simple hash function for detecting data changes (kept for local use)
         */
        function simpleHash(str) {
            let hash = 0;
            const len = Math.min(str.length, 10000); // Limit for performance
            for (let i = 0; i < len; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }
        
        /**
         * Smart data loading - tries Google Sheets cache first, then source
         */
        async function loadDashboardDataSmart(year, forceRefresh = false) {
            // If forcing refresh, skip cache and go straight to source
            if (!forceRefresh) {
                // Try Google Sheets cache first (shared across all users)
                const cacheResult = await loadFromGoogleSheetsCache(year);
                
                if (cacheResult.success && cacheResult.isFresh) {
                    // Cache hit and fresh - use it!
                    dashboardDataCache[year] = cacheResult.data;
                    
                    // Also update localStorage for offline/faster subsequent loads
                    saveCacheToStorage();
                    
                    return {
                        source: 'google_sheets_cache',
                        data: cacheResult.data,
                        cacheAgeHours: cacheResult.cacheAgeHours
                    };
                }
                
                // Check localStorage as fallback (individual user cache)
                if (dashboardDataCache[year] && dashboardDataCache[year].length > 0) {
                    console.log(`Using localStorage cache for ${year}`);
                    return {
                        source: 'local_storage_cache',
                        data: dashboardDataCache[year],
                        cacheAgeHours: null
                    };
                }
            }
            
            // No fresh cache available - fetch from source
            console.log(`Fetching fresh data for ${year} from source...`);
            
            const result = await jsonpFetch({
                action: 'getDashboardData',
                year: year.toString(),
                includeLastYear: 'true'
            });
            
            if (result.success) {
                dashboardDataCache[year] = result.data || [];
                
                // Save to localStorage
                saveCacheToStorage();
                
                // Update Google Sheets cache in background (don't await)
                // Server fetches fresh data itself to avoid URL length limits
                updateGoogleSheetsCache(year).catch(e => 
                    console.warn('Background cache update failed:', e)
                );
                
                return {
                    source: 'fresh',
                    data: result.data
                };
            }
            
            throw new Error(result.error || 'Failed to fetch data');
        }
        
        function initializeCacheFromStorage() {
            try {
                const storedVersion = localStorage.getItem(CACHE_VERSION_KEY);
                const storedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                const storedCache = localStorage.getItem(CACHE_STORAGE_KEY);
                
                // Check if cache version matches and data exists
                if (storedVersion === CURRENT_CACHE_VERSION && storedCache) {
                    const parsedCache = JSON.parse(storedCache);
                    
                    // Convert date strings back to Date objects in the cached data
                    Object.keys(parsedCache).forEach(year => {
                        if (Array.isArray(parsedCache[year])) {
                            dashboardDataCache[year] = parsedCache[year];
                        }
                    });
                    
                    const timestamp = storedTimestamp ? new Date(storedTimestamp) : null;
                    const cacheAgeHours = timestamp ? (new Date() - timestamp) / (1000 * 60 * 60) : null;
                    const isFresh = cacheAgeHours !== null && cacheAgeHours < CACHE_FRESHNESS_HOURS;
                    
                    console.log(`Loaded cache from localStorage: ${Object.keys(dashboardDataCache).length} years, ${cacheAgeHours !== null ? cacheAgeHours.toFixed(1) + ' hours old' : 'unknown age'}, fresh: ${isFresh}`);
                    
                    return {
                        loaded: true,
                        isFresh: isFresh,
                        ageHours: cacheAgeHours,
                        years: Object.keys(dashboardDataCache).map(y => parseInt(y))
                    };
                }
            } catch (e) {
                console.warn('Failed to load cache from localStorage:', e);
            }
            return { loaded: false, isFresh: false, ageHours: null, years: [] };
        }
        
        // Save cache to localStorage - only cache current year to avoid quota issues
        function saveCacheToStorage() {
            try {
                const currentYear = new Date().getFullYear();
                
                // Only cache current year data to stay within localStorage limits
                if (dashboardDataCache[currentYear]) {
                    const cacheData = {
                        [currentYear]: dashboardDataCache[currentYear]
                    };
                    
                    // Check estimated size before saving (rough estimate: 100 bytes per record)
                    const estimatedSize = JSON.stringify(cacheData).length;
                    const maxSize = 4 * 1024 * 1024; // 4MB limit (conservative)
                    
                    if (estimatedSize > maxSize) {
                        console.log(`Cache too large (${(estimatedSize/1024/1024).toFixed(1)}MB), skipping localStorage save`);
                        return;
                    }
                    
                    localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(cacheData));
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, new Date().toISOString());
                    localStorage.setItem(CACHE_VERSION_KEY, CURRENT_CACHE_VERSION);
                    console.log(`Dashboard cache saved to localStorage (${(estimatedSize/1024).toFixed(0)}KB for ${currentYear})`);
                }
            } catch (e) {
                console.warn('Failed to save cache to localStorage:', e);
                // If localStorage is full, clear it
                if (e.name === 'QuotaExceededError') {
                    console.log('localStorage quota exceeded, clearing cache');
                    clearStorageCache();
                }
            }
        }
        
        // Clear localStorage cache
        function clearStorageCache() {
            try {
                localStorage.removeItem(CACHE_STORAGE_KEY);
                localStorage.removeItem(CACHE_TIMESTAMP_KEY);
                console.log('localStorage cache cleared');
            } catch (e) {
                console.warn('Failed to clear localStorage cache:', e);
            }
        }
        
        // Get cache age in hours
        function getCacheAge() {
            try {
                const storedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                if (storedTimestamp) {
                    const timestamp = new Date(storedTimestamp);
                    return Math.floor((new Date() - timestamp) / (1000 * 60 * 60));
                }
            } catch (e) {}
            return null;
        }
        
        // Initialize cache on script load
        initializeCacheFromStorage();
        
        // Full lists for dynamic display limits
        let fullTopClientsWeek = [];
        let fullTopClientsMonth = [];
        let fullTopProvidersByHours = [];
        let fullTopProvidersByServices = [];
        
        // ============================================
        // JSONP FETCH (No-CORS compatible)
        // ============================================
        function jsonpFetch(params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                const url = new URL(WEBAPP_URL);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                url.searchParams.append('callback', callbackName);
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('JSONP request failed'));
                };
                
                script.src = url.toString();
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        reject(new Error('JSONP request timeout'));
                    }
                }, 30000);
            });
        }
        
        // ============================================
        // TAB NAVIGATION
        // ============================================
        // Tab handlers are set up in DOMContentLoaded below
        
        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `${tab}-panel`);
            });
            
            if (tab === 'report' && reportData.length === 0) {
                showReportFilterPrompt();  // Show filter prompt instead of loading all data
            } else if (tab === 'client' && clientData.length === 0) {
                loadClientData();
            } else if (tab === 'dashboard') {
                // Only load if not already rendered with current cache
                if (!tabsRendered.dashboard) {
                    if (availableYears.length === 0) {
                        loadAvailableYears().then(() => loadDashboardData());
                    } else {
                        loadDashboardData();
                    }
                    tabsRendered.dashboard = true;
                }
            } else if (tab === 'clientInsights') {
                // Only load if not already rendered with current cache
                if (!tabsRendered.clientInsights) {
                    loadClientInsights();
                    tabsRendered.clientInsights = true;
                }
            } else if (tab === 'providerInsights') {
                // Only load if not already rendered with current cache
                if (!tabsRendered.providerInsights) {
                    loadProviderInsights();
                    tabsRendered.providerInsights = true;
                }
            }
        }
        
        /**
         * Refresh all data - clears cache and reloads from all sources
         */
        async function refreshAllData() {
            // Show loading toast
            showToast('Refreshing all data from source...', 'info');
            
            // Clear all in-memory caches
            dashboardDataCache = {};
            oncallDataCache = null;
            providerInsightsData = null;
            
            // Clear localStorage cache
            localStorage.removeItem(CACHE_STORAGE_KEY);
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
            
            // Reset tab render flags
            tabsRendered = {
                dashboard: false,
                clientInsights: false,
                providerInsights: false
            };
            
            // Reload available years
            await loadAvailableYears();
            
            // Reload the current tab with forceRefresh=true to bypass and update cache
            if (currentTab === 'dashboard') {
                tabsRendered.dashboard = true;
                await loadDashboardData(true); // Force refresh and update Google Sheets cache
            } else if (currentTab === 'clientInsights') {
                tabsRendered.clientInsights = true;
                await loadClientInsights();
            } else if (currentTab === 'providerInsights') {
                tabsRendered.providerInsights = true;
                await loadProviderInsights(true); // force refresh
            }
            
            showToast('Data refreshed and cache updated!', 'success');
        }
        
        // ============================================
        // REPORT FUNCTIONS
        // ============================================
        
        function showReportFilterPrompt() {
            const container = document.getElementById('reportTableContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    <h3>Apply Filters to View Reports</h3>
                    <p>Use the filters above to search for service reports by client name, date range, status, or time period.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">This helps load data faster and saves resources.</p>
                </div>
            `;
        }
        
        async function loadReportData(filters = {}) {
            const container = document.getElementById('reportTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading service report...</p>
                </div>
            `;
            
            try {
                const params = { action: 'getServiceReport', ...filters };
                const result = await jsonpFetch(params);
                
                if (result.success) {
                    reportData = result.data;
                    renderReportTable();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <h3>Failed to load service report</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="loadReportData()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function renderReportTable() {
            const container = document.getElementById('reportTableContainer');
            
            if (reportData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <h3>No service records found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }
            
            const totalPages = Math.ceil(reportData.length / ROWS_PER_PAGE);
            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const pageData = reportData.slice(start, start + ROWS_PER_PAGE);
            
            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Date</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Provider</th>
                                <th>Duration HRS</th>
                                <th>$/Hr</th>
                                <th>Total $</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageData.forEach(row => {
                const duration = parseFloat(row['Service Duration']) || 0;
                const durationHrs = (duration / 60).toFixed(2);
                const costToCustomer = parseFloat(row['Cost To Customer']) || 0;
                const ratePerHour = durationHrs > 0 ? (costToCustomer / durationHrs).toFixed(2) : '0.00';
                
                html += `
                    <tr style="cursor: pointer;" onclick="viewClientFromReport('${escapeHtml(row['Customer Name'])}')">
                        <td><strong>${escapeHtml(row['Customer Name'])}</strong></td>
                        <td>${formatDate(row['Scheduled Date'])}</td>
                        <td>${formatTime(row['STxTime'])}</td>
                        <td>${formatTime(row['ETxTime'])}</td>
                        <td>${escapeHtml(row['Provider Name'] || 'Unassigned')}</td>
                        <td>${durationHrs}</td>
                        <td>$${ratePerHour}</td>
                        <td><strong>$${costToCustomer.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            renderPagination('reportPagination', totalPages, currentPage, (page) => {
                currentPage = page;
                renderReportTable();
            });
        }
        
        function applyFilters() {
            const filters = {};
            
            const clientName = document.getElementById('filterClient').value.trim();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const status = document.getElementById('filterStatus').value;
            const week = document.getElementById('filterWeek').value.trim();
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            
            if (clientName) filters.clientName = clientName;
            if (startDate) filters.startDate = startDate;
            if (endDate) filters.endDate = endDate;
            if (status) filters.status = status;
            if (week) filters.week = week;
            if (month) filters.month = month;
            if (year) filters.year = year;
            
            currentPage = 1;
            loadReportData(filters);
        }
        
        function clearFilters() {
            document.getElementById('filterClient').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterWeek').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            currentPage = 1;
            reportData = [];  // Clear the data
            showReportFilterPrompt();  // Show filter prompt instead of loading all data
        }
        
        // ============================================
        // CLIENT FUNCTIONS
        // ============================================
        let appConfig = { billingEmail: 'billing@alicecare.com' };
        let clientCurrentPage = 1;
        let editingClient = false;
        
        async function loadConfig() {
            try {
                const result = await jsonpFetch({ action: 'getConfig' });
                if (result.success && result.config) {
                    appConfig = result.config;
                    const billingEl = document.getElementById('configBillingEmail');
                    if (billingEl) billingEl.textContent = appConfig.billingEmail;
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }
        
        async function loadClientData() {
            const container = document.getElementById('clientTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading clients...</p>
                </div>
            `;
            
            try {
                const result = await jsonpFetch({ action: 'getClientList' });
                
                if (result.success) {
                    clientData = result.data;
                    if (result.config) appConfig = result.config;
                    updateClientStats();
                    populateInsuranceFilter();
                    renderClientTable();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <h3>Failed to load clients</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="loadClientData()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function updateClientStats() {
            const total = clientData.length;
            const billing = clientData.filter(c => String(c['Assigment_Y1_N0']) === '1').length;
            const insurance = total - billing;
            
            document.getElementById('totalClientsCount').textContent = total;
            document.getElementById('billingAssignedCount').textContent = billing;
            document.getElementById('insuranceAssignedCount').textContent = insurance;
        }
        
        function populateInsuranceFilter() {
            const select = document.getElementById('filterInsurance');
            if (!select) return;
            const insuranceNames = [...new Set(clientData.map(c => c['Insurance_Name']).filter(Boolean))];
            
            select.innerHTML = '<option value="">All Insurance</option>';
            insuranceNames.sort().forEach(name => {
                select.innerHTML += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            });
        }
        
        // ============================================
        // INSURANCE AUTOCOMPLETE FUNCTIONS
        // ============================================
        
        // Get unique insurance companies with their data from client database
        function getInsuranceList() {
            const insuranceMap = new Map();
            
            clientData.forEach(client => {
                const insuranceName = (client['Insurance_Name'] || '').trim();
                if (insuranceName) {
                    if (!insuranceMap.has(insuranceName)) {
                        insuranceMap.set(insuranceName, {
                            name: insuranceName,
                            email: client['eMail_Insurance'] || '',
                            clientCount: 1
                        });
                    } else {
                        const existing = insuranceMap.get(insuranceName);
                        existing.clientCount++;
                        // Keep the first non-empty email found
                        if (!existing.email && client['eMail_Insurance']) {
                            existing.email = client['eMail_Insurance'];
                        }
                    }
                }
            });
            
            return Array.from(insuranceMap.values()).sort((a, b) => 
                a.name.localeCompare(b.name)
            );
        }
        
        function searchInsurance(query) {
            const dropdown = document.getElementById('insuranceDropdown');
            const insuranceList = getInsuranceList();
            
            if (!query || query.length === 0) {
                // Show all insurance companies when focused with empty query
                if (insuranceList.length > 0) {
                    showInsuranceDropdown(insuranceList);
                } else {
                    dropdown.style.display = 'none';
                }
                return;
            }
            
            const searchTerm = query.toLowerCase().trim();
            const filtered = insuranceList.filter(ins => 
                ins.name.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length > 0) {
                showInsuranceDropdown(filtered);
            } else {
                dropdown.innerHTML = `
                    <div class="autocomplete-item" style="color: #999; cursor: default;">
                        No matching insurance found. You can enter a new one.
                    </div>
                `;
                dropdown.style.display = 'block';
            }
        }
        
        function showInsuranceDropdown(insuranceList) {
            const dropdown = document.getElementById('insuranceDropdown');
            
            dropdown.innerHTML = insuranceList.map(ins => `
                <div class="autocomplete-item" onclick="selectInsurance('${escapeHtml(ins.name)}', '${escapeHtml(ins.email)}')">
                    <div class="insurance-name">${escapeHtml(ins.name)}</div>
                    ${ins.email ? `<div class="insurance-email">${escapeHtml(ins.email)}</div>` : ''}
                    <div class="client-count">${ins.clientCount} client${ins.clientCount > 1 ? 's' : ''} with this insurance</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectInsurance(name, email) {
            document.getElementById('formInsuranceName').value = name;
            document.getElementById('formInsuranceEmail').value = email;
            document.getElementById('insuranceDropdown').style.display = 'none';
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('insuranceDropdown');
            const input = document.getElementById('formInsuranceName');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
            }
        });
        
        function getFilteredClientData() {
            let filtered = [...clientData];
            
            const nameFilter = (document.getElementById('filterClientName')?.value || '').toLowerCase().trim();
            const insuranceFilter = document.getElementById('filterInsurance')?.value || '';
            const assignmentFilter = document.getElementById('filterAssignment')?.value || '';
            
            if (nameFilter) {
                filtered = filtered.filter(c => {
                    const fullName = `${c['F_Name'] || ''} ${c['L_Name'] || ''}`.toLowerCase();
                    const email = (c['email'] || '').toLowerCase();
                    const customerName = (c['Customer Name'] || '').toLowerCase();
                    return fullName.includes(nameFilter) || email.includes(nameFilter) || customerName.includes(nameFilter);
                });
            }
            
            if (insuranceFilter) {
                filtered = filtered.filter(c => c['Insurance_Name'] === insuranceFilter);
            }
            
            if (assignmentFilter !== '') {
                filtered = filtered.filter(c => String(c['Assigment_Y1_N0']) === assignmentFilter);
            }
            
            return filtered;
        }
        
        function renderClientTable() {
            const container = document.getElementById('clientTableContainer');
            const filteredData = getFilteredClientData();
            
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <h3>No clients found</h3>
                        <p>Add your first client to get started</p>
                    </div>
                `;
                return;
            }
            
            const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
            const start = (clientCurrentPage - 1) * PAGE_SIZE;
            const pageData = filteredData.slice(start, start + PAGE_SIZE);
            
            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Insurance</th>
                                <th>Assignment</th>
                                <th>Subscription</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageData.forEach(client => {
                const isAssigned = String(client['Assigment_Y1_N0']) === '1';
                const assignmentBadge = isAssigned 
                    ? '<span class="badge" style="background: #F3E5F5; color: #9C27B0;">Assignment Benefits</span>'
                    : '<span class="badge" style="background: #E3F2FD; color: #2196F3;">CC Pay</span>';
                
                const subscription = (client['Subscription'] || '').toLowerCase();
                let subscriptionBadges = [];
                if (subscription.includes('weekly')) {
                    subscriptionBadges.push('<span class="badge" style="background: #E3F2FD; color: #2196F3;">W</span>');
                }
                if (subscription.includes('monthly')) {
                    subscriptionBadges.push('<span class="badge" style="background: #E0F1E9; color: #62B790;">M</span>');
                }
                if (subscription.includes('yearly')) {
                    subscriptionBadges.push('<span class="badge" style="background: #FFF3E0; color: #F57600;">Y</span>');
                }
                const subscriptionBadge = subscriptionBadges.length > 0 
                    ? subscriptionBadges.join(' ') 
                    : '<span class="badge" style="background: #F5F5F5; color: #999;">None</span>';
                
                html += `
                    <tr>
                        <td><strong>${escapeHtml(client['Customer Name'] || '--')}</strong></td>
                        <td>${escapeHtml(client['email'] || '--')}</td>
                        <td>${escapeHtml(client['Phone'] || '--')}</td>
                        <td>${escapeHtml(client['Insurance_Name'] || '--')}</td>
                        <td>${assignmentBadge}</td>
                        <td>${subscriptionBadge}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 6px 14px; font-size: 12px;" 
                                    onclick="openClientDetail('${escapeHtml(client['Customer Name'] || client['email'])}')">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            renderPagination('clientPagination', totalPages, clientCurrentPage, (page) => {
                clientCurrentPage = page;
                renderClientTable();
            });
        }
        
        function applyClientFilters() {
            clientCurrentPage = 1;
            renderClientTable();
        }
        
        function clearClientFilters() {
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterInsurance').value = '';
            document.getElementById('filterAssignment').value = '';
            clientCurrentPage = 1;
            renderClientTable();
        }
        
        async function openClientDetail(identifier) {
            if (!identifier) {
                showToast('No client identifier provided', 'error');
                return;
            }
            
            // Show sidebar immediately with loading state
            document.getElementById('sidebarOverlay').classList.add('active');
            document.getElementById('clientSidebar').classList.add('active');
            document.getElementById('detailClientName').textContent = 'Loading...';
            document.getElementById('detailCustomerName').textContent = identifier;
            
            try {
                let clientResult = null;
                
                // First try to find in local cached data for instant display
                const localClient = clientData.find(c => {
                    const customerName = String(c['Customer Name'] || '').toLowerCase().trim();
                    const email = String(c['email'] || '').toLowerCase().trim();
                    const searchId = identifier.toLowerCase().trim();
                    return customerName === searchId || email === searchId || customerName.includes(searchId);
                });
                
                // If found locally, display immediately while fetching fresh data
                if (localClient) {
                    displayClientDetails({ success: true, client: localClient });
                }
                
                // Try all lookup methods in parallel for speed
                const [byNameResult, byEmailResult, byCustomerNameResult] = await Promise.all([
                    jsonpFetch({ action: 'getClientByCustomerName', customerName: identifier }).catch(() => ({ success: false })),
                    jsonpFetch({ action: 'getClientByEmail', email: identifier }).catch(() => ({ success: false })),
                    jsonpFetch({ action: 'getClientByName', name: identifier }).catch(() => ({ success: false }))
                ]);
                
                // Use the first successful result
                clientResult = byNameResult.success ? byNameResult : 
                              (byEmailResult.success ? byEmailResult : 
                              (byCustomerNameResult.success ? byCustomerNameResult : null));
                
                // If server lookup failed but we have local data, use that
                if (!clientResult && localClient) {
                    console.log('Using local client data:', localClient);
                    clientResult = { success: true, client: localClient };
                }
                
                if (!clientResult || !clientResult.success) {
                    showToast('Client not found', 'error');
                    closeClientDetail();
                    return;
                }
                
                // Display the fresh data
                displayClientDetails(clientResult);
                
            } catch (error) {
                showToast('Error loading client details', 'error');
                console.error(error);
                closeClientDetail();
            }
        }
        
        function displayClientDetails(clientResult) {
            selectedClient = clientResult.client;
            console.log('Selected client data:', selectedClient);
            const fullName = `${selectedClient['F_Name'] || ''} ${selectedClient['L_Name'] || ''}`.trim();
            const isAssigned = String(selectedClient['Assigment_Y1_N0']) === '1';
            
            // Update header
            document.getElementById('detailClientName').textContent = fullName || selectedClient['Customer Name'] || 'Unknown Client';
            document.getElementById('detailCustomerName').textContent = selectedClient['Customer Name'] || 'No customer name';
            
            // Update email routing indicator
            const routeIndicator = document.getElementById('emailRouteIndicator');
            if (isAssigned) {
                routeIndicator.style.background = '#F3E5F5';
                routeIndicator.style.borderColor = '#9C27B0';
                routeIndicator.querySelector('svg').style.stroke = '#9C27B0';
            } else {
                routeIndicator.style.background = '#E3F2FD';
                routeIndicator.style.borderColor = '#2196F3';
                routeIndicator.querySelector('svg').style.stroke = '#2196F3';
            }
            document.getElementById('routeType').textContent = isAssigned ? 'Routed to Billing' : 'Routed to Insurance';
            document.getElementById('routeEmail').textContent = isAssigned ? appConfig.billingEmail : (selectedClient['eMail_Insurance'] || 'No email');
            
            // Update contact info
            document.getElementById('sidebarClientEmail').value = selectedClient['email'] || '';
            document.getElementById('detailPhone').textContent = selectedClient['Phone'] || '--';
            document.getElementById('detailAddress').textContent = selectedClient['Address'] || '--';
            
            // Update insurance info
            document.getElementById('detailInsurance').textContent = selectedClient['Insurance_Name'] || '--';
            document.getElementById('sidebarInsuranceEmail').value = selectedClient['eMail_Insurance'] || '';
            document.getElementById('detailPolicy').textContent = selectedClient['Policy'] || '--';
            document.getElementById('detailClaim').textContent = selectedClient['Claim'] || '--';
            document.getElementById('emailSaveStatus').style.display = 'none';
            
            // Update service codes
            const serviceCodes = ['BA', 'DR', 'TR', 'CO', 'TO', 'EA', 'AM', 'CS', 'HM'];
            const codesContainer = document.getElementById('detailServiceCodes');
            codesContainer.innerHTML = serviceCodes.map(code => `
                <div style="background: #F9FAFB; padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-weight: 700; color: #1A365C; font-size: 14px;">${code}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 2px;">${selectedClient[code] || '--'}</div>
                </div>
            `).join('');
            
            // Update service summary from cached dashboard data if available
            const customerName = selectedClient['Customer Name'];
            if (customerName) {
                const currentYear = new Date().getFullYear();
                const yearData = dashboardDataCache[currentYear] || [];
                const clientServices = yearData.filter(r => r['Customer Name'] === customerName);
                
                if (clientServices.length > 0) {
                    const totalServices = clientServices.length;
                    const completedServices = clientServices.filter(r => r['Status'] === 'COMPLETED').length;
                    const totalHours = clientServices.reduce((sum, r) => sum + ((parseFloat(r['Service Duration']) || 0) / 60), 0);
                    const totalCost = clientServices.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
                    
                    document.getElementById('detailTotalServices').textContent = totalServices;
                    document.getElementById('detailCompleted').textContent = completedServices;
                    document.getElementById('detailTotalHours').textContent = `${totalHours.toFixed(1)} hrs`;
                    document.getElementById('detailTotalSpent').textContent = `$${formatNumber(totalCost)}`;
                } else if (clientResult.reportSummary) {
                    const s = clientResult.reportSummary;
                    document.getElementById('detailTotalServices').textContent = s.totalServices;
                    document.getElementById('detailCompleted').textContent = s.completedServices;
                    document.getElementById('detailTotalHours').textContent = `${s.totalHours} hrs`;
                    document.getElementById('detailTotalSpent').textContent = `$${s.totalCost}`;
                }
            }
            
            // Update subscription checkboxes
            const subscription = (selectedClient['Subscription'] || '').toLowerCase();
            document.getElementById('sidebarSubWeekly').checked = subscription.includes('weekly');
            document.getElementById('sidebarSubMonthly').checked = subscription.includes('monthly');
            document.getElementById('sidebarSubYearly').checked = subscription.includes('yearly');
            document.getElementById('subscriptionSaveStatus').style.display = 'none';
        }
        
        function closeClientDetail() {
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.getElementById('clientSidebar').classList.remove('active');
            selectedClient = null;
        }
        
        // Show the send report modal
        function sendClientReport() {
            if (!selectedClient || !selectedClient['Customer Name']) {
                showToast('No customer name available', 'error');
                return;
            }
            
            // Populate modal with client info
            document.getElementById('sendReportClientName').textContent = selectedClient['Customer Name'];
            
            // Show destination email
            const isAssigned = String(selectedClient['Assigment_Y1_N0']) === '1';
            const targetEmail = isAssigned ? appConfig.billingEmail : (selectedClient['eMail_Insurance'] || 'No email');
            document.getElementById('sendReportEmail').textContent = targetEmail;
            
            const destBox = document.getElementById('sendReportDestination');
            if (isAssigned) {
                destBox.style.background = '#F3E5F5';
            } else {
                destBox.style.background = '#E3F2FD';
            }
            
            // Reset inputs
            document.getElementById('reportPeriodType').value = 'week';
            document.getElementById('reportWeekNumber').value = '';
            document.getElementById('reportMonth').value = new Date().getMonth() + 1;
            document.getElementById('reportYear').value = new Date().getFullYear();
            toggleReportPeriodInputs();
            
            // Show modal
            document.getElementById('sendReportModal').classList.add('active');
        }
        
        function closeSendReportModal() {
            document.getElementById('sendReportModal').classList.remove('active');
        }
        
        function toggleReportPeriodInputs() {
            const periodType = document.getElementById('reportPeriodType').value;
            document.getElementById('weekInputGroup').style.display = periodType === 'week' ? 'block' : 'none';
            document.getElementById('monthInputGroup').style.display = periodType === 'month' ? 'block' : 'none';
            document.getElementById('yearlyReportNote').style.display = periodType === 'year' ? 'block' : 'none';
        }
        
        async function confirmSendReport() {
            if (!selectedClient || !selectedClient['Customer Name']) {
                showToast('No customer name available', 'error');
                return;
            }
            
            const periodType = document.getElementById('reportPeriodType').value;
            const year = document.getElementById('reportYear').value;
            let periodValue;
            
            if (periodType === 'week') {
                periodValue = document.getElementById('reportWeekNumber').value;
                if (!periodValue || periodValue < 1 || periodValue > 53) {
                    showToast('Please enter a valid week number (1-53)', 'warning');
                    return;
                }
            } else if (periodType === 'month') {
                periodValue = document.getElementById('reportMonth').value;
            } else {
                // Yearly report - periodValue is the year itself
                periodValue = year;
            }
            
            const btn = document.getElementById('confirmSendReportBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Sending...';
            
            // Show loading overlay
            let periodLabel;
            if (periodType === 'week') periodLabel = 'Week ' + periodValue;
            else if (periodType === 'month') periodLabel = 'Month ' + periodValue;
            else periodLabel = 'Year ' + year;
            showLoading('Generating Report', `Creating ${periodLabel} report for ${selectedClient['Customer Name']}...`);
            
            try {
                updateLoadingText('Sending Report', 'Sending email with PDF attachment...');
                
                const result = await jsonpFetch({ 
                    action: 'sendClientInvoice', 
                    customerName: selectedClient['Customer Name'],
                    periodType: periodType,
                    periodValue: periodValue,
                    year: year
                });
                
                hideLoading();
                console.log('Send report result:', result);
                
                if (result.success) {
                    showToast(`Report for ${periodLabel} sent to ${result.sentTo}`, 'success');
                    closeSendReportModal();
                } else {
                    // Log debug info if available
                    if (result.debug) {
                        console.log('Debug info:', result.debug);
                    }
                    throw new Error(result.error || 'Failed to send report');
                }
            } catch (error) {
                hideLoading();
                showToast(error.message, 'error');
                console.error('Send report error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Send Report
                `;
            }
        }
        
        async function viewClientReports() {
            if (!selectedClient || !selectedClient['Customer Name']) {
                showToast('No customer name available', 'error');
                return;
            }
            
            const customerName = selectedClient['Customer Name'];
            closeClientDetail();
            
            // Switch to report tab
            switchTab('report');
            
            // Set the filter value
            document.getElementById('filterClient').value = customerName;
            
            // Load report data with the client filter applied
            await loadReportData({ clientName: customerName });
            
            showToast(`Showing reports for ${customerName}`, 'info');
        }
        
        function editClient() {
            if (!selectedClient) return;
            
            editingClient = true;
            document.getElementById('clientModalTitle').textContent = 'Edit Client';
            
            // Populate form
            document.getElementById('formFName').value = selectedClient['F_Name'] || '';
            document.getElementById('formLName').value = selectedClient['L_Name'] || '';
            document.getElementById('formAddress').value = selectedClient['Address'] || '';
            document.getElementById('formEmail').value = selectedClient['email'] || '';
            document.getElementById('formPhone').value = selectedClient['Phone'] || '';
            document.getElementById('formInsuranceName').value = selectedClient['Insurance_Name'] || '';
            document.getElementById('formInsuranceEmail').value = selectedClient['eMail_Insurance'] || '';
            document.getElementById('formPolicy').value = selectedClient['Policy'] || '';
            document.getElementById('formClaim').value = selectedClient['Claim'] || '';
            document.getElementById('formAssignment').value = String(selectedClient['Assigment_Y1_N0']) || '0';
            document.getElementById('formCustomerName').value = selectedClient['Customer Name'] || '';
            
            // Populate subscription checkboxes
            const subscription = (selectedClient['Subscription'] || '').toLowerCase();
            document.getElementById('formSubWeekly').checked = subscription.includes('weekly');
            document.getElementById('formSubMonthly').checked = subscription.includes('monthly');
            document.getElementById('formSubYearly').checked = subscription.includes('yearly');
            
            // Service codes
            ['BA', 'DR', 'TR', 'CO', 'TO', 'EA', 'AM', 'CS', 'HM'].forEach(code => {
                const el = document.getElementById('form' + code);
                if (el) el.value = selectedClient[code] || '';
            });
            
            closeClientDetail();
            document.getElementById('clientModal').classList.add('active');
        }
        
        async function showAddClientModal() {
            editingClient = false;
            document.getElementById('clientModalTitle').textContent = 'Add New Client';
            document.getElementById('clientForm').reset();
            document.getElementById('formSubWeekly').checked = false;
            document.getElementById('formSubMonthly').checked = false;
            document.getElementById('formSubYearly').checked = false;
            document.getElementById('insuranceDropdown').style.display = 'none';
            
            // Ensure client data is loaded for insurance autocomplete
            if (clientData.length === 0) {
                try {
                    const result = await jsonpFetch({ action: 'getClientList' });
                    if (result.success) {
                        clientData = result.data;
                    }
                } catch (e) {
                    console.log('Could not load client data for autocomplete');
                }
            }
            
            document.getElementById('clientModal').classList.add('active');
        }
        
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            editingClient = false;
        }
        
        function getSubscriptionValue() {
            const subs = [];
            if (document.getElementById('formSubWeekly').checked) subs.push('Weekly');
            if (document.getElementById('formSubMonthly').checked) subs.push('Monthly');
            if (document.getElementById('formSubYearly').checked) subs.push('Yearly');
            return subs.join(',') || 'None';
        }
        
        async function updateSubscription() {
            if (!selectedClient) return;
            const subs = [];
            if (document.getElementById('sidebarSubWeekly').checked) subs.push('Weekly');
            if (document.getElementById('sidebarSubMonthly').checked) subs.push('Monthly');
            if (document.getElementById('sidebarSubYearly').checked) subs.push('Yearly');
            const subscriptionValue = subs.join(',') || 'None';
            try {
                const params = {
                    action: 'updateClient',
                    originalEmail: selectedClient['email'],
                    'Customer Name': selectedClient['Customer Name'],
                    'Subscription': subscriptionValue
                };
                const result = await jsonpFetch(params);
                if (result.success) {
                    selectedClient['Subscription'] = subscriptionValue;
                    const idx = clientData.findIndex(c => c['Customer Name'] === selectedClient['Customer Name']);
                    if (idx !== -1) clientData[idx]['Subscription'] = subscriptionValue;
                    document.getElementById('subscriptionSaveStatus').style.display = 'block';
                    setTimeout(() => { document.getElementById('subscriptionSaveStatus').style.display = 'none'; }, 2000);
                    renderClientTable();
                }
            } catch (error) {
                showToast('Error updating subscription', 'error');
            }
        }
        
        async function updateClientEmail() {
            if (!selectedClient) return;
            const newEmail = document.getElementById('sidebarClientEmail').value.trim();
            const oldEmail = selectedClient['email'] || '';
            const customerName = selectedClient['Customer Name'] || '';
            
            if (!newEmail) { showToast('Please enter a valid email', 'error'); return; }
            if (!customerName && !oldEmail) { showToast('Cannot identify client to update', 'error'); return; }
            
            try {
                const params = {
                    action: 'updateClient',
                    'Customer Name': customerName,
                    'email': newEmail
                };
                // Only include originalEmail if we have one
                if (oldEmail) {
                    params.originalEmail = oldEmail;
                }
                
                console.log('Updating client email with params:', params);
                const result = await jsonpFetch(params);
                console.log('Update result:', result);
                
                if (result.success) {
                    selectedClient['email'] = newEmail;
                    const idx = clientData.findIndex(c => c['Customer Name'] === customerName || c['email'] === oldEmail);
                    if (idx !== -1) clientData[idx]['email'] = newEmail;
                    const statusEl = document.getElementById('emailSaveStatus');
                    statusEl.textContent = '‚úì Client email updated';
                    statusEl.style.display = 'block';
                    setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                    renderClientTable();
                    showToast('Client email updated', 'success');
                } else {
                    throw new Error(result.error || 'Failed to update email');
                }
            } catch (error) {
                showToast('Error updating email: ' + error.message, 'error');
                console.error('Update client email error:', error);
            }
        }
        
        async function updateInsuranceEmail() {
            if (!selectedClient) return;
            const newEmail = document.getElementById('sidebarInsuranceEmail').value.trim();
            const customerName = selectedClient['Customer Name'] || '';
            const clientEmail = selectedClient['email'] || '';
            
            if (!customerName && !clientEmail) { showToast('Cannot identify client to update', 'error'); return; }
            
            try {
                const params = {
                    action: 'updateClient',
                    'Customer Name': customerName,
                    'eMail_Insurance': newEmail
                };
                // Only include originalEmail if we have one
                if (clientEmail) {
                    params.originalEmail = clientEmail;
                }
                
                console.log('Updating insurance email with params:', params);
                const result = await jsonpFetch(params);
                console.log('Update result:', result);
                
                if (result.success) {
                    selectedClient['eMail_Insurance'] = newEmail;
                    const idx = clientData.findIndex(c => c['Customer Name'] === customerName);
                    if (idx !== -1) clientData[idx]['eMail_Insurance'] = newEmail;
                    const isAssigned = String(selectedClient['Assigment_Y1_N0']) === '1';
                    if (!isAssigned) document.getElementById('routeEmail').textContent = newEmail || 'No email';
                    const statusEl = document.getElementById('emailSaveStatus');
                    statusEl.textContent = '‚úì Insurance email updated';
                    statusEl.style.display = 'block';
                    setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                    renderClientTable();
                    showToast('Insurance email updated', 'success');
                } else {
                    throw new Error(result.error || 'Failed to update insurance email');
                }
            } catch (error) {
                showToast('Error updating email: ' + error.message, 'error');
                console.error('Update insurance email error:', error);
            }
        }
        
        async function saveClient() {
            // Validate required fields
            const firstName = document.getElementById('formFName').value.trim();
            const lastName = document.getElementById('formLName').value.trim();
            const customerName = document.getElementById('formCustomerName').value.trim();
            
            if (!firstName || !lastName) {
                showToast('First Name and Last Name are required', 'error');
                return;
            }
            
            // Auto-generate Customer Name if not provided
            const finalCustomerName = customerName || `${firstName} ${lastName}`;
            
            const btn = document.getElementById('saveClientBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Saving...';
            
            try {
                const params = {
                    action: editingClient ? 'updateClient' : 'addClient',
                    'F_Name': firstName,
                    'L_Name': lastName,
                    'Address': document.getElementById('formAddress').value.trim(),
                    'email': document.getElementById('formEmail').value.trim(),
                    'Phone': document.getElementById('formPhone').value.trim(),
                    'Insurance_Name': document.getElementById('formInsuranceName').value.trim(),
                    'eMail_Insurance': document.getElementById('formInsuranceEmail').value.trim(),
                    'Policy': document.getElementById('formPolicy').value.trim(),
                    'Claim': document.getElementById('formClaim').value.trim(),
                    'Assigment_Y1_N0': document.getElementById('formAssignment').value,
                    'Customer Name': finalCustomerName,
                    'BA': document.getElementById('formBA').value.trim(),
                    'DR': document.getElementById('formDR').value.trim(),
                    'TR': document.getElementById('formTR').value.trim(),
                    'CO': document.getElementById('formCO').value.trim(),
                    'TO': document.getElementById('formTO').value.trim(),
                    'EA': document.getElementById('formEA').value.trim(),
                    'AM': document.getElementById('formAM').value.trim(),
                    'CS': document.getElementById('formCS').value.trim(),
                    'HM': document.getElementById('formHM').value.trim(),
                    'Subscription': getSubscriptionValue()
                };
                
                // For updates, include the original identifier
                if (editingClient && selectedClient) {
                    params.originalEmail = selectedClient['email'] || '';
                    // Also pass original Customer Name in case it changed
                    if (selectedClient['Customer Name']) {
                        params.originalCustomerName = selectedClient['Customer Name'];
                    }
                }
                
                console.log('Saving client with params:', params);
                const result = await jsonpFetch(params);
                console.log('Save result:', result);
                
                if (result.success) {
                    showToast(editingClient ? 'Client updated successfully' : 'Client added successfully', 'success');
                    closeClientModal();
                    loadClientData();
                } else {
                    throw new Error(result.error || 'Failed to save client');
                }
            } catch (error) {
                showToast(error.message, 'error');
                console.error('Save client error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Client';
            }
        }
        
        function viewClientFromReport(clientName) {
            openClientDetail(clientName);
        }
        
        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        
        // Chart instances
        let weeklyRevenueChart = null;
        let weeklyVolumeChart = null;
        let monthlyRevenueChart = null;
        let monthlyVolumeChart = null;
        let quarterlyChart = null;
        let peakHoursChart = null;
        
        // Register and configure datalabels plugin
        Chart.register(ChartDataLabels);
        // Disable datalabels plugin by default for all charts
        Chart.defaults.plugins.datalabels.display = false;
        
        /**
         * Load available years from the server and populate the year dropdown
         */
        async function loadAvailableYears() {
            try {
                console.log('Fetching available years...');
                const result = await jsonpFetch({ action: 'getAvailableYears' });
                console.log('Available years result:', result);
                
                if (result.success) {
                    availableYears = result.years || [];
                    
                    // Populate dashboard year dropdown
                    const yearSelect = document.getElementById('dashboardYear');
                    if (yearSelect && availableYears.length > 0) {
                        yearSelect.innerHTML = '';
                        availableYears.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            if (result.yearCounts && result.yearCounts[year]) {
                                option.textContent += ` (${result.yearCounts[year].toLocaleString()} records)`;
                            }
                            yearSelect.appendChild(option);
                        });
                        
                        // Default to current year if available, otherwise first year
                        const currentYear = new Date().getFullYear();
                        if (availableYears.includes(currentYear)) {
                            yearSelect.value = currentYear;
                        }
                    }
                    
                    console.log('Year dropdown populated with:', availableYears);
                    return availableYears;
                } else {
                    console.error('Failed to load available years:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('Error loading available years:', error);
                return [];
            }
        }
        
        async function loadDashboardData(forceRefresh = false) {
            const selectedYear = parseInt(document.getElementById('dashboardYear')?.value || new Date().getFullYear());
            document.getElementById('dashboardYearLabel').textContent = selectedYear;
            
            // Check if we have cached data for this year (memory)
            const hasCachedData = !forceRefresh && dashboardDataCache[selectedYear] && dashboardDataCache[selectedYear].length > 0;
            
            if (hasCachedData) {
                console.log(`Using memory cache for ${selectedYear} (${dashboardDataCache[selectedYear].length} records)`);
                // Don't show loading for cached data - render immediately
            } else {
                showLoading('Loading Dashboard', forceRefresh ? 'Refreshing data...' : `Loading ${selectedYear} data...`);
            }
            
            try {
                // Use smart loading - tries Google Sheets cache first, then source
                if (!hasCachedData) {
                    const loadResult = await loadDashboardDataSmart(selectedYear, forceRefresh);
                    console.log(`Data loaded from: ${loadResult.source}`, loadResult.cacheAgeHours ? `(${loadResult.cacheAgeHours.toFixed(1)}h old)` : '');
                    
                    if (loadResult.source === 'google_sheets_cache') {
                        showToast(`Using cached data (${loadResult.cacheAgeHours.toFixed(1)} hours old)`, 'info');
                    } else if (loadResult.source === 'fresh' && forceRefresh) {
                        showToast('Data refreshed and cache updated!', 'success');
                    }
                }
                
                // Use cached data
                const yearData = dashboardDataCache[selectedYear];
                
                if (!yearData || yearData.length === 0) {
                    hideLoading();
                    console.log('No data available for ' + selectedYear);
                    showToast(`No data found for ${selectedYear}`, 'warning');
                    return;
                }
                
                updateLoadingText('Loading Dashboard', 'Calculating metrics...');
                
                // Calculate dashboard metrics
                const metrics = calculateDashboardMetrics(yearData, selectedYear);
                console.log('Calculated metrics:', metrics);
                
                // Update YTD KPIs
                document.getElementById('ytdServices').textContent = metrics.ytd.services.toLocaleString();
                document.getElementById('ytdHours').textContent = metrics.ytd.hours.toLocaleString(undefined, {maximumFractionDigits: 1});
                document.getElementById('ytdRevenue').textContent = '$' + metrics.ytd.revenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                document.getElementById('ytdAvgRevenue').textContent = '$' + metrics.ytd.avgRevenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                // Update YoY changes
                updateYoYChange('ytdServicesChange', metrics.yoy.servicesChange);
                updateYoYChange('ytdHoursChange', metrics.yoy.hoursChange);
                updateYoYChange('ytdRevenueChange', metrics.yoy.revenueChange);
                updateYoYChange('ytdAvgRevenueChange', metrics.yoy.avgRevenueChange);
                
                // Update current period stats
                document.getElementById('weekServices').textContent = metrics.thisWeek.services.toLocaleString();
                document.getElementById('weekHours').textContent = metrics.thisWeek.hours.toLocaleString(undefined, {maximumFractionDigits: 1});
                document.getElementById('weekRevenue').textContent = metrics.thisWeek.revenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                document.getElementById('monthServices').textContent = metrics.thisMonth.services.toLocaleString();
                document.getElementById('monthHours').textContent = metrics.thisMonth.hours.toLocaleString(undefined, {maximumFractionDigits: 1});
                document.getElementById('monthRevenue').textContent = metrics.thisMonth.revenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                document.getElementById('quarterServices').textContent = metrics.thisQuarter.services.toLocaleString();
                document.getElementById('quarterHours').textContent = metrics.thisQuarter.hours.toLocaleString(undefined, {maximumFractionDigits: 1});
                document.getElementById('quarterRevenue').textContent = metrics.thisQuarter.revenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                document.getElementById('activeClients').textContent = metrics.activeClients;
                
                // Update period labels
                document.getElementById('lastWeekLabel').textContent = '(Week ' + metrics.thisWeek.weekNum + ')';
                document.getElementById('lastMonthLabel').textContent = '(' + metrics.thisMonth.monthName + ')';
                document.getElementById('lastQuarterLabel').textContent = '(' + metrics.thisQuarter.quarterLabel + ')';
                
                // Update period change indicators
                updatePeriodChange('weekChange', metrics.thisWeek.revenueChange, 'week');
                updatePeriodChange('monthChange', metrics.thisMonth.revenueChange, 'month');
                updatePeriodChange('quarterChange', metrics.thisQuarter.revenueChange, 'quarter');
                
                // Update week/month labels for top clients
                document.getElementById('topClientsWeekLabel').textContent = '(Week ' + metrics.lastWeekNum + ')';
                document.getElementById('topClientsMonthLabel').textContent = '(' + metrics.lastMonthName + ')';
                
                // Update weekly chart labels to show the last week number
                document.getElementById('weeklyChartEndLabel').textContent = 'Week ' + metrics.lastWeekNum;
                document.getElementById('weeklyVolumeEndLabel').textContent = 'Week ' + metrics.lastWeekNum;
                
                // Render charts
                renderWeeklyRevenueChart(metrics.weeklyData);
                renderWeeklyVolumeChart(metrics.weeklyData);
                renderPeakHoursChart(metrics.peakHoursData);
                renderMonthlyRevenueChart(metrics.last13MonthsData);
                renderMonthlyVolumeChart(metrics.last13MonthsData);
                renderQuarterlyChart(metrics.quarterlyData);
                
                // Store full client/provider lists for dynamic display
                fullTopClientsWeek = metrics.topClientsLastWeek || [];
                fullTopClientsMonth = metrics.topClientsMonth || [];
                
                // Render top clients tables with default limit (5)
                updateTopClientsDisplay('week');
                updateTopClientsDisplay('month');
                
                // Initialize provider filter and render tables
                initProviderFilters();
                updateProviderTables();
                
                // Update provider activity monitor
                updateProviderActivityMonitor();
                
                // Load automation config
                loadAutomationConfig();
                
                // Update cache status display
                updateCacheStatus();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Failed to load dashboard data:', error);
                showToast('Error loading dashboard', 'error');
            }
        }
        
        // Provider filter functions
        function initProviderFilters() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            const currentWeek = getWeekNumber(now);
            
            // Set current values
            document.getElementById('providerFilterYear').value = currentYear;
            document.getElementById('providerFilterMonth').value = currentMonth;
            
            // Populate week dropdown (1-53)
            const weekSelect = document.getElementById('providerFilterWeek');
            weekSelect.innerHTML = '';
            for (let w = 1; w <= 53; w++) {
                const option = document.createElement('option');
                option.value = w;
                option.textContent = 'Week ' + w;
                weekSelect.appendChild(option);
            }
            weekSelect.value = currentWeek;
            
            // Show/hide appropriate filter
            updateProviderFilter();
        }
        
        /**
         * Clear dashboard data cache (memory + localStorage) and reload
         */
        function clearDashboardCache() {
            dashboardDataCache = {};
            clearStorageCache();
            showToast('Cache cleared. Fetching fresh data...', 'info');
            loadDashboardData();
        }
        
        /**
         * Update the cache status display
         */
        function updateCacheStatus() {
            const cachedYears = Object.keys(dashboardDataCache);
            const infoDiv = document.getElementById('cachedYearsInfo');
            if (infoDiv) {
                if (cachedYears.length > 0) {
                    const cacheAge = getCacheAge();
                    const currentYear = new Date().getFullYear();
                    const ageText = cacheAge !== null ? `(${currentYear} cached ${cacheAge < 1 ? 'just now' : cacheAge + 'h ago'})` : '(session only)';
                    const details = cachedYears.map(y => 
                        `${y}: ${dashboardDataCache[y].length.toLocaleString()}`
                    ).join(' | ');
                    infoDiv.innerHTML = `<strong>In Memory:</strong> ${details}<br><span style="font-size: 11px; color: #999;">${ageText} - Click "Refresh Data" for latest</span>`;
                } else {
                    infoDiv.innerHTML = '<em>No data cached yet</em>';
                }
            }
        }
        
        function updateProviderFilter() {
            const filterType = document.getElementById('providerFilterType').value;
            document.getElementById('providerFilterMonth').style.display = filterType === 'month' ? 'inline-block' : 'none';
            document.getElementById('providerFilterWeek').style.display = filterType === 'week' ? 'inline-block' : 'none';
            updateProviderTables();
        }
        
        function updateProviderTables() {
            const filterType = document.getElementById('providerFilterType').value;
            const year = parseInt(document.getElementById('providerFilterYear').value);
            const month = parseInt(document.getElementById('providerFilterMonth').value);
            const week = parseInt(document.getElementById('providerFilterWeek').value);
            const displayLimit = parseInt(document.getElementById('providerDisplayLimit')?.value || 5);
            
            // Use cached dashboard data if available, otherwise use reportData
            const sourceData = dashboardDataCache[year] || reportData;
            
            // Filter data based on selection (data is already completed from getDashboardData)
            let filteredData = sourceData.filter(r => parseInt(r.Year) === year);
            
            if (filterType === 'month') {
                filteredData = filteredData.filter(r => parseInt(r.Month) === month);
            } else if (filterType === 'week') {
                filteredData = filteredData.filter(r => parseInt(r.Week) === week);
            }
            
            // Calculate ALL top providers (up to 50 for storage)
            fullTopProvidersByHours = calculateTopProviders(filteredData, 50, 'hours');
            fullTopProvidersByServices = calculateTopProviders(filteredData, 50, 'services');
            
            // Render tables with display limit
            renderTopProvidersTable('topProvidersByHours', fullTopProvidersByHours.slice(0, displayLimit), 'hours');
            renderTopProvidersTable('topProvidersByServices', fullTopProvidersByServices.slice(0, displayLimit), 'services');
        }
        
        function calculateTopProviders(data, limit = 10, sortBy = 'hours') {
            // Aggregate by provider
            const providerStats = {};
            data.forEach(r => {
                const name = r['Provider Name'] || 'Unknown';
                if (!providerStats[name]) {
                    providerStats[name] = { name, services: 0, hours: 0 };
                }
                providerStats[name].services += 1;
                providerStats[name].hours += (parseFloat(r['Service Duration']) || 0) / 60;
            });
            
            // Sort by specified field and take top N
            return Object.values(providerStats)
                .sort((a, b) => sortBy === 'hours' ? b.hours - a.hours : b.services - a.services)
                .slice(0, limit);
        }
        
        function renderTopProvidersTable(containerId, providers, sortBy) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (!providers || providers.length === 0) {
                container.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 15px;">No data available</td></tr>';
                return;
            }
            
            container.innerHTML = providers.map((p, i) => `
                <tr>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3;">
                        <span style="background: ${i < 3 ? '#1A365C' : '#E5ECF3'}; color: ${i < 3 ? 'white' : '#666'}; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">${i + 1}</span>
                    </td>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3; font-weight: 500; font-size: 13px;">${escapeHtml(p.name)}</td>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${p.services}</td>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #1A365C; font-size: 13px;">${p.hours.toLocaleString(undefined, {maximumFractionDigits: 1})}</td>
                </tr>
            `).join('');
        }
        
        // Store full provider activity data for filtering/searching
        let allProviderActivityData = [];
        let providerActivitySearchTerm = '';
        
        // Sorting state for provider activity table
        let providerActivitySortColumn = 'status';  // Default sort by status (priority)
        let providerActivitySortDirection = 'asc';  // 'asc' or 'desc'
        
        /**
         * Sort provider activity table by column
         */
        function sortProviderActivity(column) {
            // Toggle direction if same column, otherwise default to appropriate direction
            if (providerActivitySortColumn === column) {
                providerActivitySortDirection = providerActivitySortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                providerActivitySortColumn = column;
                // Default directions: name ascending, numbers descending
                providerActivitySortDirection = (column === 'name') ? 'asc' : 'desc';
            }
            
            // Update sort indicators in headers
            updateSortIndicators();
            
            // Re-render the table with current filters
            const statusFilter = document.getElementById('activityStatusFilter')?.value || 'concerns';
            const displayLimit = document.getElementById('activityDisplayLimit')?.value || '10';
            renderProviderActivityTable(statusFilter, displayLimit);
        }
        
        /**
         * Update sort arrow indicators in column headers
         */
        function updateSortIndicators() {
            const columns = ['status', 'name', 'lastPeriodHours', 'priorPeriodHours', 'change', 'lastService', 'ytdHours'];
            columns.forEach(col => {
                const indicator = document.getElementById(`sort-${col}`);
                if (indicator) {
                    if (col === providerActivitySortColumn) {
                        indicator.textContent = providerActivitySortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                    } else {
                        indicator.textContent = '';
                    }
                }
            });
        }
        
        /**
         * Apply sorting to provider activity data
         */
        function applySorting(data) {
            const col = providerActivitySortColumn;
            const dir = providerActivitySortDirection;
            
            return [...data].sort((a, b) => {
                let valA, valB;
                
                switch (col) {
                    case 'status':
                        valA = a.sortPriority;
                        valB = b.sortPriority;
                        break;
                    case 'name':
                        valA = (a.displayName || a.name || '').toLowerCase();
                        valB = (b.displayName || b.name || '').toLowerCase();
                        break;
                    case 'lastPeriodHours':
                        valA = a.lastPeriodHours || 0;
                        valB = b.lastPeriodHours || 0;
                        break;
                    case 'priorPeriodHours':
                        valA = a.priorPeriodHours || 0;
                        valB = b.priorPeriodHours || 0;
                        break;
                    case 'change':
                        valA = a.changePercent || 0;
                        valB = b.changePercent || 0;
                        break;
                    case 'lastService':
                        valA = a.lastServiceDate ? a.lastServiceDate.getTime() : 0;
                        valB = b.lastServiceDate ? b.lastServiceDate.getTime() : 0;
                        break;
                    case 'ytdHours':
                        valA = a.ytdHours || 0;
                        valB = b.ytdHours || 0;
                        break;
                    default:
                        valA = a.sortPriority;
                        valB = b.sortPriority;
                }
                
                // Compare values
                let comparison = 0;
                if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB);
                } else {
                    comparison = valA - valB;
                }
                
                return dir === 'asc' ? comparison : -comparison;
            });
        }
        
        /**
         * Normalize a name for comparison
         * - Trims whitespace
         * - Collapses multiple spaces
         * - Converts to lowercase
         * - Removes accents/diacritics
         * - Removes common suffixes/prefixes
         */
        function normalizeName(name) {
            if (!name) return '';
            
            return name
                .trim()
                .replace(/\s+/g, ' ')           // Collapse multiple spaces
                .toLowerCase()
                .normalize('NFD')                // Decompose accents
                .replace(/[\u0300-\u036f]/g, '') // Remove accent marks
                .replace(/[^a-z0-9\s]/g, '')     // Remove special characters
                .trim();
        }
        
        /**
         * Calculate string similarity using Levenshtein distance
         * Returns a value between 0 (completely different) and 1 (identical)
         */
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (!str1 || !str2) return 0;
            
            const len1 = str1.length;
            const len2 = str2.length;
            
            // Quick check - if lengths are very different, likely not a match
            if (Math.abs(len1 - len2) > Math.max(len1, len2) * 0.3) return 0;
            
            // Levenshtein distance calculation
            const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(null));
            
            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,      // deletion
                        matrix[j - 1][i] + 1,      // insertion
                        matrix[j - 1][i - 1] + cost // substitution
                    );
                }
            }
            
            const distance = matrix[len2][len1];
            const maxLen = Math.max(len1, len2);
            return 1 - (distance / maxLen);
        }
        
        /**
         * Get the most common variant of a name from the source data
         */
        function getMostCommonVariant(variants, sourceData, fieldName = 'Provider Name') {
            if (variants.length === 1) return variants[0];
            
            // Count occurrences of each variant
            const counts = {};
            variants.forEach(v => counts[v] = 0);
            
            sourceData.forEach(r => {
                const name = r[fieldName];
                if (counts.hasOwnProperty(name)) {
                    counts[name]++;
                }
            });
            
            // Return the most common one
            return variants.reduce((a, b) => counts[a] >= counts[b] ? a : b);
        }
        
        /**
         * Apply fuzzy matching to merge similar provider names
         * Uses 90% similarity threshold
         */
        function applyFuzzyMatching(providerStats, nameVariants) {
            const SIMILARITY_THRESHOLD = 0.85; // 85% similarity to merge
            const normalizedNames = Object.keys(providerStats);
            const merged = {};
            const alreadyMerged = new Set();
            
            for (let i = 0; i < normalizedNames.length; i++) {
                const name1 = normalizedNames[i];
                if (alreadyMerged.has(name1)) continue;
                
                // Start with this provider's data
                const mergedEntry = { ...providerStats[name1] };
                const allVariants = new Set(mergedEntry.variants || []);
                
                // Find similar names to merge
                for (let j = i + 1; j < normalizedNames.length; j++) {
                    const name2 = normalizedNames[j];
                    if (alreadyMerged.has(name2)) continue;
                    
                    const similarity = calculateSimilarity(name1, name2);
                    
                    if (similarity >= SIMILARITY_THRESHOLD) {
                        // Merge the data
                        const p2 = providerStats[name2];
                        mergedEntry.lastPeriodServices += p2.lastPeriodServices;
                        mergedEntry.lastPeriodHours += p2.lastPeriodHours;
                        mergedEntry.priorPeriodServices += p2.priorPeriodServices;
                        mergedEntry.priorPeriodHours += p2.priorPeriodHours;
                        mergedEntry.ytdServices += p2.ytdServices;
                        mergedEntry.ytdHours += p2.ytdHours;
                        
                        // Keep the most recent last service date
                        if (p2.lastServiceDate && (!mergedEntry.lastServiceDate || p2.lastServiceDate > mergedEntry.lastServiceDate)) {
                            mergedEntry.lastServiceDate = p2.lastServiceDate;
                        }
                        
                        // Add variants
                        (p2.variants || []).forEach(v => allVariants.add(v));
                        
                        alreadyMerged.add(name2);
                    }
                }
                
                // Update variants info
                mergedEntry.variants = Array.from(allVariants);
                mergedEntry.variantCount = allVariants.size;
                
                // Use the most frequent variant as display name
                if (allVariants.size > 1) {
                    // Pick the longest/most complete looking name as primary
                    const sortedVariants = mergedEntry.variants.sort((a, b) => b.length - a.length);
                    mergedEntry.displayName = sortedVariants[0];
                } else {
                    mergedEntry.displayName = mergedEntry.name;
                }
                
                merged[name1] = mergedEntry;
                alreadyMerged.add(name1);
            }
            
            return merged;
        }
        
        /**
         * Apply fuzzy matching to merge similar CLIENT names
         * Similar to provider matching but with client-specific fields
         */
        function applyClientFuzzyMatching(clientStats, nameVariants) {
            const SIMILARITY_THRESHOLD = 0.85; // 85% similarity to merge
            const normalizedNames = Object.keys(clientStats);
            const merged = {};
            const alreadyMerged = new Set();
            
            for (let i = 0; i < normalizedNames.length; i++) {
                const name1 = normalizedNames[i];
                if (alreadyMerged.has(name1)) continue;
                
                // Start with this client's data
                const mergedEntry = { ...clientStats[name1] };
                // Deep copy objects
                mergedEntry.monthlyHours = { ...clientStats[name1].monthlyHours };
                mergedEntry.weeklyHours = { ...clientStats[name1].weeklyHours };
                const allVariants = new Set(mergedEntry.variants || []);
                
                // Find similar names to merge
                for (let j = i + 1; j < normalizedNames.length; j++) {
                    const name2 = normalizedNames[j];
                    if (alreadyMerged.has(name2)) continue;
                    
                    const similarity = calculateSimilarity(name1, name2);
                    
                    if (similarity >= SIMILARITY_THRESHOLD) {
                        // Merge the data
                        const c2 = clientStats[name2];
                        mergedEntry.totalRevenue += c2.totalRevenue;
                        mergedEntry.totalServices += c2.totalServices;
                        mergedEntry.totalHours += c2.totalHours;
                        
                        // Keep earliest first service date
                        if (c2.firstServiceDate < mergedEntry.firstServiceDate) {
                            mergedEntry.firstServiceDate = c2.firstServiceDate;
                        }
                        // Keep latest last service date
                        if (c2.lastServiceDate > mergedEntry.lastServiceDate) {
                            mergedEntry.lastServiceDate = c2.lastServiceDate;
                        }
                        
                        // Merge monthly hours
                        Object.keys(c2.monthlyHours).forEach(key => {
                            mergedEntry.monthlyHours[key] = (mergedEntry.monthlyHours[key] || 0) + c2.monthlyHours[key];
                        });
                        
                        // Merge weekly hours
                        Object.keys(c2.weeklyHours).forEach(key => {
                            mergedEntry.weeklyHours[key] = (mergedEntry.weeklyHours[key] || 0) + c2.weeklyHours[key];
                        });
                        
                        // Add variants
                        (c2.variants || []).forEach(v => allVariants.add(v));
                        
                        alreadyMerged.add(name2);
                    }
                }
                
                // Update variants info
                mergedEntry.variants = Array.from(allVariants);
                mergedEntry.variantCount = allVariants.size;
                
                // Use the longest/most complete looking name as display name
                if (allVariants.size > 1) {
                    const sortedVariants = mergedEntry.variants.sort((a, b) => b.length - a.length);
                    mergedEntry.displayName = sortedVariants[0];
                } else {
                    mergedEntry.displayName = mergedEntry.name;
                }
                
                merged[name1] = mergedEntry;
                alreadyMerged.add(name1);
            }
            
            return merged;
        }
        
        /**
         * Filter by clicking on status summary boxes
         */
        function filterByStatus(status) {
            document.getElementById('activityStatusFilter').value = status;
            const displayLimit = document.getElementById('activityDisplayLimit')?.value || '10';
            renderProviderActivityTable(status, displayLimit);
        }
        
        /**
         * Calculate and display provider activity monitor
         * Compares recent period vs prior period to identify declining engagement
         * Now tracks both services AND hours
         */
        function updateProviderActivityMonitor() {
            const periodDays = parseInt(document.getElementById('activityPeriodDays')?.value || 45);
            const statusFilter = document.getElementById('activityStatusFilter')?.value || 'concerns';
            const displayLimit = document.getElementById('activityDisplayLimit')?.value || '10';
            
            // Get current year's data from cache
            const currentYear = new Date().getFullYear();
            const sourceData = dashboardDataCache[currentYear] || reportData;
            
            if (!sourceData || sourceData.length === 0) {
                document.getElementById('providerActivityList').innerHTML = 
                    '<tr><td colspan="10" style="text-align: center; color: #999; padding: 15px;">No data available</td></tr>';
                updateActivitySummaryCounts(0, 0, 0, 0);
                return;
            }
            
            const now = new Date();
            const periodEnd = now;
            const periodStart = new Date(now.getTime() - (periodDays * 24 * 60 * 60 * 1000));
            const priorPeriodEnd = periodStart;
            const priorPeriodStart = new Date(priorPeriodEnd.getTime() - (periodDays * 24 * 60 * 60 * 1000));
            
            // Update period info tooltips with definitions and date ranges
            const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const lastPeriodInfo = document.getElementById('lastPeriodInfo');
            const priorPeriodInfo = document.getElementById('priorPeriodInfo');
            if (lastPeriodInfo) {
                lastPeriodInfo.title = `LAST PERIOD: The most recent ${periodDays} days of activity (${formatDate(periodStart)} ‚Äì ${formatDate(periodEnd)}). This shows current engagement level.`;
            }
            if (priorPeriodInfo) {
                priorPeriodInfo.title = `PRIOR PERIOD: The ${periodDays} days before the Last Period (${formatDate(priorPeriodStart)} ‚Äì ${formatDate(priorPeriodEnd)}). Used as a baseline to measure change in activity.`;
            }
            
            // Aggregate data by NORMALIZED provider name for both periods
            const providerStats = {};
            const nameVariants = {}; // Track original name variants for each normalized name
            
            sourceData.forEach(r => {
                const originalName = r['Provider Name'];
                if (!originalName || originalName === 'Unknown') return;
                
                const normalizedName = normalizeName(originalName);
                if (!normalizedName) return;
                
                const serviceDate = new Date(r['Scheduled Date']);
                if (isNaN(serviceDate.getTime())) return;
                
                const hours = (parseFloat(r['Service Duration']) || 0) / 60;
                
                if (!providerStats[normalizedName]) {
                    providerStats[normalizedName] = {
                        name: originalName, // Keep first encountered original name as primary
                        normalizedName,
                        lastPeriodServices: 0,
                        lastPeriodHours: 0,
                        priorPeriodServices: 0,
                        priorPeriodHours: 0,
                        lastServiceDate: null,
                        ytdServices: 0,
                        ytdHours: 0
                    };
                    nameVariants[normalizedName] = new Set([originalName]);
                } else {
                    // Track this variant
                    nameVariants[normalizedName].add(originalName);
                }
                
                // Track last service date
                if (!providerStats[normalizedName].lastServiceDate || serviceDate > providerStats[normalizedName].lastServiceDate) {
                    providerStats[normalizedName].lastServiceDate = serviceDate;
                }
                
                // Count services and hours in each period
                if (serviceDate >= periodStart && serviceDate <= periodEnd) {
                    providerStats[normalizedName].lastPeriodServices++;
                    providerStats[normalizedName].lastPeriodHours += hours;
                } else if (serviceDate >= priorPeriodStart && serviceDate < priorPeriodEnd) {
                    providerStats[normalizedName].priorPeriodServices++;
                    providerStats[normalizedName].priorPeriodHours += hours;
                }
                
                // YTD totals
                if (parseInt(r.Year) === currentYear) {
                    providerStats[normalizedName].ytdServices++;
                    providerStats[normalizedName].ytdHours += hours;
                }
            });
            
            // Add variant info to each provider
            Object.keys(providerStats).forEach(normalizedName => {
                const variants = Array.from(nameVariants[normalizedName]);
                providerStats[normalizedName].variants = variants;
                providerStats[normalizedName].variantCount = variants.length;
                // Use the most common variant as the display name
                providerStats[normalizedName].displayName = getMostCommonVariant(variants, sourceData);
            });
            
            // Now apply fuzzy matching to merge similar normalized names
            const mergedStats = applyFuzzyMatching(providerStats, nameVariants);
            
            // Calculate status for each provider based on HOURS (more accurate than service count)
            // Minimum threshold: provider must have had at least 10 hours in prior period to be considered
            const MIN_PRIOR_HOURS = 10;
            
            allProviderActivityData = Object.values(mergedStats).map(p => {
                const lastHours = p.lastPeriodHours;
                const priorHours = p.priorPeriodHours;
                
                let changePercent = 0;
                let status = 'active';
                let statusLabel = 'üü¢ Active';
                let statusColor = '#4CAF50';
                let sortPriority = 4; // Lower = higher priority in list
                
                if (priorHours >= MIN_PRIOR_HOURS) {
                    // Provider was active in prior period, check for decline based on hours
                    changePercent = ((lastHours - priorHours) / priorHours) * 100;
                    
                    if (lastHours === 0) {
                        // 100% drop - completely inactive
                        status = 'inactive';
                        statusLabel = 'üî¥ Inactive';
                        statusColor = '#F44336';
                        sortPriority = 1;
                    } else if (changePercent <= -50) {
                        // 50%+ drop - at risk
                        status = 'atrisk';
                        statusLabel = 'üü† At Risk';
                        statusColor = '#FF9800';
                        sortPriority = 2;
                    } else if (changePercent <= -25) {
                        // 25-50% drop - declining
                        status = 'declining';
                        statusLabel = 'üü° Declining';
                        statusColor = '#FFC107';
                        sortPriority = 3;
                    }
                } else if (priorHours === 0 && lastHours > 0) {
                    // New or returning provider
                    status = 'active';
                    statusLabel = 'üü¢ Active';
                    changePercent = 100; // Show as increase
                } else if (priorHours === 0 && lastHours === 0) {
                    // No recent activity at all - skip unless they have significant YTD hours
                    if (p.ytdHours < MIN_PRIOR_HOURS) {
                        status = 'minimal';
                        statusLabel = '‚ö™ Minimal';
                        statusColor = '#9E9E9E';
                        sortPriority = 5;
                    } else {
                        // Had hours earlier in year but not recently
                        status = 'inactive';
                        statusLabel = 'üî¥ Inactive';
                        statusColor = '#F44336';
                        sortPriority = 1;
                    }
                }
                
                return {
                    ...p,
                    changePercent,
                    status,
                    statusLabel,
                    statusColor,
                    sortPriority
                };
            });
            
            // Sort by priority (worst first), then by change percent
            allProviderActivityData.sort((a, b) => {
                if (a.sortPriority !== b.sortPriority) return a.sortPriority - b.sortPriority;
                return a.changePercent - b.changePercent;
            });
            
            // Update summary counts
            const counts = {
                active: allProviderActivityData.filter(p => p.status === 'active').length,
                declining: allProviderActivityData.filter(p => p.status === 'declining').length,
                atrisk: allProviderActivityData.filter(p => p.status === 'atrisk').length,
                inactive: allProviderActivityData.filter(p => p.status === 'inactive').length
            };
            updateActivitySummaryCounts(counts.active, counts.declining, counts.atrisk, counts.inactive);
            
            // Apply filters and render
            renderProviderActivityTable(statusFilter, displayLimit);
        }
        
        function updateActivitySummaryCounts(active, declining, atrisk, inactive) {
            document.getElementById('activeProvidersCount').textContent = active;
            document.getElementById('decliningProvidersCount').textContent = declining;
            document.getElementById('atRiskProvidersCount').textContent = atrisk;
            document.getElementById('inactiveProvidersCount').textContent = inactive;
        }
        
        function renderProviderActivityTable(statusFilter, displayLimit) {
            let filteredData = [...allProviderActivityData];
            
            // Apply status filter
            if (statusFilter === 'concerns') {
                filteredData = filteredData.filter(p => ['inactive', 'atrisk', 'declining'].includes(p.status));
            } else if (statusFilter !== 'all') {
                filteredData = filteredData.filter(p => p.status === statusFilter);
            }
            
            // Apply search filter - search across display name and all variants
            if (providerActivitySearchTerm) {
                const searchLower = providerActivitySearchTerm.toLowerCase();
                filteredData = filteredData.filter(p => {
                    // Check display name
                    if ((p.displayName || p.name).toLowerCase().includes(searchLower)) return true;
                    // Check all variants
                    if (p.variants && p.variants.some(v => v.toLowerCase().includes(searchLower))) return true;
                    return false;
                });
            }
            
            // Apply sorting
            filteredData = applySorting(filteredData);
            
            // Update sort indicators
            updateSortIndicators();
            
            // Apply display limit
            const totalCount = filteredData.length;
            if (displayLimit !== 'all') {
                filteredData = filteredData.slice(0, parseInt(displayLimit));
            }
            
            // Render table
            const container = document.getElementById('providerActivityList');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999; padding: 15px;">No providers match the current filters</td></tr>';
                document.getElementById('providerActivityFooter').textContent = '';
                return;
            }
            
            container.innerHTML = filteredData.map(p => {
                const changeDisplay = p.priorPeriodHours > 0 
                    ? `<span style="color: ${p.changePercent >= 0 ? '#4CAF50' : p.statusColor}; font-weight: 600;">${p.changePercent >= 0 ? '+' : ''}${p.changePercent.toFixed(0)}%</span>`
                    : '<span style="color: #999;">--</span>';
                
                const lastServiceDisplay = p.lastServiceDate 
                    ? p.lastServiceDate.toLocaleDateString()
                    : '--';
                
                // Show variant indicator if there are multiple name variants
                const variantIndicator = p.variantCount > 1 
                    ? `<span title="Merged from ${p.variantCount} name variations: ${p.variants.join(', ')}" 
                             style="margin-left: 6px; background: #E3F2FD; color: #1976D2; font-size: 10px; padding: 2px 5px; border-radius: 10px; cursor: help;">+${p.variantCount - 1}</span>`
                    : '';
                
                const displayName = p.displayName || p.name;
                
                return `
                    <tr>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3;">
                            <span style="display: inline-flex; align-items: center; gap: 6px;">
                                <span style="display: inline-block; width: 10px; height: 10px; background: ${p.statusColor}; border-radius: 50%;"></span>
                                <span style="font-size: 12px; color: #666;">${p.statusLabel.split(' ')[1]}</span>
                            </span>
                        </td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; font-weight: 500;">${escapeHtml(displayName)}${variantIndicator}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${p.lastPeriodServices}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px; color: #1A365C; font-weight: 500;">${p.lastPeriodHours.toFixed(1)}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${p.priorPeriodServices}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px; color: #666;">${p.priorPeriodHours.toFixed(1)}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${changeDisplay}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${lastServiceDisplay}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; font-size: 13px;">${p.ytdServices}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; font-size: 13px; font-weight: 500; color: #1A365C;">${p.ytdHours.toFixed(1)}</td>
                    </tr>
                `;
            }).join('');
            
            // Update footer
            const footerText = displayLimit !== 'all' && totalCount > parseInt(displayLimit)
                ? `Showing ${filteredData.length} of ${totalCount} providers`
                : `${totalCount} provider${totalCount !== 1 ? 's' : ''}`;
            document.getElementById('providerActivityFooter').textContent = footerText;
        }
        
        function searchProviderActivity() {
            providerActivitySearchTerm = document.getElementById('providerActivitySearch')?.value?.trim() || '';
            const statusFilter = document.getElementById('activityStatusFilter')?.value || 'concerns';
            const displayLimit = document.getElementById('activityDisplayLimit')?.value || '10';
            
            // If searching, show all statuses to find the provider
            if (providerActivitySearchTerm) {
                document.getElementById('activityStatusFilter').value = 'all';
                renderProviderActivityTable('all', 'all');
            } else {
                renderProviderActivityTable(statusFilter, displayLimit);
            }
        }
        
        function clearProviderActivitySearch() {
            document.getElementById('providerActivitySearch').value = '';
            providerActivitySearchTerm = '';
            document.getElementById('activityStatusFilter').value = 'concerns';
            const displayLimit = document.getElementById('activityDisplayLimit')?.value || '10';
            renderProviderActivityTable('concerns', displayLimit);
        }
        
        function calculateDashboardMetrics(data, year) {
            const now = new Date();
            const currentActualYear = now.getFullYear();
            const isHistoricalYear = year < currentActualYear;
            
            // For historical years, use end of that year as reference point
            // For current year, use today's date
            const referenceDate = isHistoricalYear ? new Date(year, 11, 31) : now;
            const currentMonth = isHistoricalYear ? 12 : (now.getMonth() + 1);
            const currentQuarter = Math.ceil(currentMonth / 3);
            const currentWeek = isHistoricalYear ? 52 : getWeekNumber(now);
            
            // Filter data by year
            const yearData = data.filter(r => parseInt(r.Year) === year);
            const lastYearData = data.filter(r => parseInt(r.Year) === year - 1);
            
            // Filter completed services only
            const completedYearData = yearData.filter(r => (r.Status || '').toUpperCase() === 'COMPLETED');
            const completedLastYearData = lastYearData.filter(r => (r.Status || '').toUpperCase() === 'COMPLETED');
            
            // YTD calculations
            const ytdServices = completedYearData.length;
            const ytdHours = completedYearData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0);
            const ytdRevenue = completedYearData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            const ytdAvgRevenue = ytdServices > 0 ? ytdRevenue / ytdServices : 0;
            
            // Last year YTD (same period)
            const lyServices = completedLastYearData.length;
            const lyHours = completedLastYearData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0);
            const lyRevenue = completedLastYearData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            const lyAvgRevenue = lyServices > 0 ? lyRevenue / lyServices : 0;
            
            // YoY changes
            const calcChange = (current, previous) => previous > 0 ? ((current - previous) / previous * 100) : 0;
            
            // LAST WEEK (completed week, not current week)
            const lastWeek = isHistoricalYear ? 52 : (currentWeek > 1 ? currentWeek - 1 : 52);
            const lastWeekYear = isHistoricalYear ? year : (currentWeek > 1 ? year : year - 1);
            const lastWeekData = data.filter(r => 
                (r.Status || '').toUpperCase() === 'COMPLETED' &&
                parseInt(r.Year) === lastWeekYear && 
                parseInt(r.Week) === lastWeek
            );
            const weekServices = lastWeekData.length;
            const weekHours = lastWeekData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0);
            const weekRevenue = lastWeekData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            
            // Week before last (for comparison)
            const weekBeforeLast = lastWeek > 1 ? lastWeek - 1 : 52;
            const weekBeforeLastYear = lastWeek > 1 ? lastWeekYear : lastWeekYear - 1;
            const weekBeforeLastData = data.filter(r => 
                (r.Status || '').toUpperCase() === 'COMPLETED' &&
                parseInt(r.Year) === weekBeforeLastYear && 
                parseInt(r.Week) === weekBeforeLast
            );
            const prevWeekServices = weekBeforeLastData.length;
            const prevWeekRevenue = weekBeforeLastData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            
            // LAST MONTH (completed month, not current month)
            const lastMonth = isHistoricalYear ? 12 : (currentMonth > 1 ? currentMonth - 1 : 12);
            const lastMonthYear = isHistoricalYear ? year : (currentMonth > 1 ? year : year - 1);
            const lastMonthData = data.filter(r => 
                (r.Status || '').toUpperCase() === 'COMPLETED' &&
                parseInt(r.Year) === lastMonthYear && 
                parseInt(r.Month) === lastMonth
            );
            const monthServices = lastMonthData.length;
            const monthHours = lastMonthData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0);
            const monthRevenue = lastMonthData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            
            // Month before last (for comparison)
            const monthBeforeLast = lastMonth > 1 ? lastMonth - 1 : 12;
            const monthBeforeLastYear = lastMonth > 1 ? lastMonthYear : lastMonthYear - 1;
            const monthBeforeLastData = data.filter(r => 
                (r.Status || '').toUpperCase() === 'COMPLETED' &&
                parseInt(r.Year) === monthBeforeLastYear && 
                parseInt(r.Month) === monthBeforeLast
            );
            const prevMonthServices = monthBeforeLastData.length;
            const prevMonthRevenue = monthBeforeLastData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            
            // LAST QUARTER (completed quarter, not current quarter)
            const lastQuarter = isHistoricalYear ? 4 : (currentQuarter > 1 ? currentQuarter - 1 : 4);
            const lastQuarterYear = isHistoricalYear ? year : (currentQuarter > 1 ? year : year - 1);
            const lastQuarterMonths = [(lastQuarter - 1) * 3 + 1, (lastQuarter - 1) * 3 + 2, (lastQuarter - 1) * 3 + 3];
            const lastQuarterData = data.filter(r => 
                (r.Status || '').toUpperCase() === 'COMPLETED' &&
                parseInt(r.Year) === lastQuarterYear && 
                lastQuarterMonths.includes(parseInt(r.Month))
            );
            const quarterServices = lastQuarterData.length;
            const quarterHours = lastQuarterData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0);
            const quarterRevenue = lastQuarterData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            
            // Quarter before last (for comparison)
            const quarterBeforeLast = lastQuarter > 1 ? lastQuarter - 1 : 4;
            const quarterBeforeLastYear = lastQuarter > 1 ? lastQuarterYear : lastQuarterYear - 1;
            const quarterBeforeLastMonths = [(quarterBeforeLast - 1) * 3 + 1, (quarterBeforeLast - 1) * 3 + 2, (quarterBeforeLast - 1) * 3 + 3];
            const quarterBeforeLastData = data.filter(r => 
                (r.Status || '').toUpperCase() === 'COMPLETED' &&
                parseInt(r.Year) === quarterBeforeLastYear && 
                quarterBeforeLastMonths.includes(parseInt(r.Month))
            );
            const prevQuarterServices = quarterBeforeLastData.length;
            const prevQuarterRevenue = quarterBeforeLastData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0);
            
            // Active clients
            const activeClients = new Set(completedYearData.map(r => r['Customer Name'])).size;
            
            // Month names for labels
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const fullMonthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // All completed data (for charts)
            const allCompletedData = data.filter(r => (r.Status || '').toUpperCase() === 'COMPLETED');
            
            // Last 13 months data - for historical years, show that year's 12 months
            const last13MonthsData = [];
            if (isHistoricalYear) {
                // For historical year, show all 12 months of that year
                for (let m = 1; m <= 12; m++) {
                    const monthData = completedYearData.filter(r => parseInt(r.Month) === m);
                    last13MonthsData.push({
                        label: monthNames[m - 1] + ' ' + String(year).slice(2),
                        month: m,
                        year: year,
                        services: monthData.length,
                        hours: monthData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0),
                        revenue: monthData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0)
                    });
                }
            } else {
                // For current year, show rolling 13 months
                for (let i = 12; i >= 0; i--) {
                    const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const targetYear = targetDate.getFullYear();
                    const targetMonth = targetDate.getMonth() + 1;
                    
                    const monthData = allCompletedData.filter(r => 
                        parseInt(r.Year) === targetYear && parseInt(r.Month) === targetMonth
                    );
                    
                    last13MonthsData.push({
                        label: monthNames[targetMonth - 1] + ' ' + String(targetYear).slice(2),
                        month: targetMonth,
                        year: targetYear,
                        services: monthData.length,
                        hours: monthData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0),
                        revenue: monthData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0)
                    });
                }
            }
            
            // Quarterly data for selected year
            const quarterlyData = [];
            for (let q = 1; q <= 4; q++) {
                const qMonths = [(q - 1) * 3 + 1, (q - 1) * 3 + 2, (q - 1) * 3 + 3];
                const qData = completedYearData.filter(r => qMonths.includes(parseInt(r.Month)));
                quarterlyData.push({
                    quarter: q,
                    services: qData.length,
                    hours: qData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0),
                    revenue: qData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0)
                });
            }
            
            // Weekly data (last 12 weeks) - for historical years, show last 12 weeks of that year
            const weeklyData = [];
            if (isHistoricalYear) {
                // For historical year, show weeks 41-52 (last 12 weeks of year)
                for (let w = 41; w <= 52; w++) {
                    const weekData = completedYearData.filter(r => parseInt(r.Week) === w);
                    weeklyData.push({
                        week: w,
                        label: 'W' + w,
                        services: weekData.length,
                        hours: weekData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0),
                        revenue: weekData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0)
                    });
                }
            } else {
                // For current year, show rolling 12 weeks ENDING AT LAST WEEK (exclude current incomplete week)
                // Start from 12 weeks before last week, end at last week
                for (let i = 12; i >= 1; i--) {
                    const targetDate = new Date(now);
                    targetDate.setDate(targetDate.getDate() - (i * 7));  // i=12 means 12 weeks ago, i=1 means last week
                    const targetWeek = getWeekNumber(targetDate);
                    const targetYear = targetDate.getFullYear();
                    
                    const weekData = allCompletedData.filter(r => 
                        parseInt(r.Year) === targetYear && parseInt(r.Week) === targetWeek
                    );
                    
                    weeklyData.push({
                        week: targetWeek,
                        label: 'W' + targetWeek,
                        services: weekData.length,
                        hours: weekData.reduce((sum, r) => sum + (parseFloat(r['Service Duration']) || 0) / 60, 0),
                        revenue: weekData.reduce((sum, r) => sum + (parseFloat(r['Cost To Customer']) || 0), 0)
                    });
                }
            }
            
            // Peak hours data - analyze start times from the year's data
            const peakHoursData = calculatePeakHours(completedYearData, referenceDate);
            
            // For "last week" - use lastWeek data
            const thisWeek = {
                services: weekServices,
                hours: weekHours,
                revenue: weekRevenue,
                prevServices: prevWeekServices,
                prevRevenue: prevWeekRevenue,
                servicesChange: calcChange(weekServices, prevWeekServices),
                revenueChange: calcChange(weekRevenue, prevWeekRevenue),
                weekNum: lastWeek
            };
            
            // For "last month" - use lastMonth data
            const thisMonth = {
                services: monthServices,
                hours: monthHours,
                revenue: monthRevenue,
                prevServices: prevMonthServices,
                prevRevenue: prevMonthRevenue,
                servicesChange: calcChange(monthServices, prevMonthServices),
                revenueChange: calcChange(monthRevenue, prevMonthRevenue),
                monthName: fullMonthNames[lastMonth - 1]
            };
            
            // For "last quarter" - use lastQuarter data
            const thisQuarter = {
                services: quarterServices,
                hours: quarterHours,
                revenue: quarterRevenue,
                prevServices: prevQuarterServices,
                prevRevenue: prevQuarterRevenue,
                servicesChange: calcChange(quarterServices, prevQuarterServices),
                revenueChange: calcChange(quarterRevenue, prevQuarterRevenue),
                quarterNum: lastQuarter,
                quarterLabel: 'Q' + lastQuarter
            };
            
            return {
                ytd: { services: ytdServices, hours: ytdHours, revenue: ytdRevenue, avgRevenue: ytdAvgRevenue },
                yoy: {
                    servicesChange: calcChange(ytdServices, lyServices),
                    hoursChange: calcChange(ytdHours, lyHours),
                    revenueChange: calcChange(ytdRevenue, lyRevenue),
                    avgRevenueChange: calcChange(ytdAvgRevenue, lyAvgRevenue)
                },
                thisWeek: thisWeek,
                thisMonth: thisMonth,
                thisQuarter: thisQuarter,
                activeClients,
                currentWeekNum: currentWeek,
                lastWeekNum: lastWeek,
                lastMonthName: fullMonthNames[lastMonth - 1],
                lastQuarterLabel: 'Q' + lastQuarter,
                currentMonthName: fullMonthNames[currentMonth - 1],
                currentQuarter: currentQuarter,
                last13MonthsData,
                quarterlyData,
                weeklyData,
                peakHoursData,
                topClientsMonth: calculateTopClients(lastMonthData, 30),
                topClientsLastWeek: calculateTopClients(lastWeekData, 30),
                isHistoricalYear: isHistoricalYear
            };
        }
        
        function calculatePeakHours(data, now) {
            // Get data from last 12 weeks
            const twelveWeeksAgo = new Date(now);
            twelveWeeksAgo.setDate(twelveWeeksAgo.getDate() - 84); // 12 weeks * 7 days
            
            // Initialize hourly buckets (5 AM to 10 PM to cover typical service hours)
            const hourlyData = {};
            for (let h = 5; h <= 22; h++) {
                hourlyData[h] = { hour: h, totalServices: 0, days: new Set() };
            }
            
            // Analyze each service's start time
            data.forEach(r => {
                // Try to get start time from STxTime or StartTIME column
                const startTime = r['STxTime'] || r['StartTIME'] || r['Start Time'] || '';
                if (!startTime) return;
                
                // Parse the time to get hour
                let hour = null;
                if (typeof startTime === 'string') {
                    // Handle formats like "9:00 AM", "14:00", "9:00"
                    const timeMatch = startTime.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                    if (timeMatch) {
                        hour = parseInt(timeMatch[1]);
                        const isPM = timeMatch[3] && timeMatch[3].toUpperCase() === 'PM';
                        const isAM = timeMatch[3] && timeMatch[3].toUpperCase() === 'AM';
                        if (isPM && hour !== 12) hour += 12;
                        if (isAM && hour === 12) hour = 0;
                    }
                } else if (typeof startTime === 'number') {
                    // Handle Excel serial time (fraction of day)
                    hour = Math.floor(startTime * 24);
                }
                
                if (hour !== null && hour >= 5 && hour <= 22 && hourlyData[hour]) {
                    hourlyData[hour].totalServices++;
                    // Track unique days to calculate average
                    const dateKey = r['Scheduled Date'] || r['Year'] + '-' + r['Month'] + '-' + r['Week'];
                    hourlyData[hour].days.add(dateKey);
                }
            });
            
            // Calculate daily average for each hour
            const result = [];
            for (let h = 5; h <= 22; h++) {
                const dayCount = hourlyData[h].days.size || 1;
                const avgServices = hourlyData[h].totalServices / Math.max(dayCount / 7, 1); // Normalize to weekly average
                result.push({
                    hour: h,
                    label: formatHour(h),
                    avgServices: avgServices,
                    totalServices: hourlyData[h].totalServices
                });
            }
            
            return result;
        }
        
        function formatHour(hour) {
            if (hour === 0 || hour === 24) return '12 AM';
            if (hour === 12) return '12 PM';
            if (hour < 12) return hour + ' AM';
            return (hour - 12) + ' PM';
        }
        
        function calculateTopClients(data, limit = 10) {
            // Aggregate revenue by client
            const clientRevenue = {};
            data.forEach(r => {
                const name = r['Customer Name'] || 'Unknown';
                if (!clientRevenue[name]) {
                    clientRevenue[name] = { name, revenue: 0, services: 0, hours: 0 };
                }
                clientRevenue[name].revenue += parseFloat(r['Cost To Customer']) || 0;
                clientRevenue[name].services += 1;
                clientRevenue[name].hours += (parseFloat(r['Service Duration']) || 0) / 60;
            });
            
            // Sort by revenue and take top N
            return Object.values(clientRevenue)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, limit);
        }
        
        function renderTopClientsTable(containerId, clients) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (!clients || clients.length === 0) {
                container.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 15px;">No data available</td></tr>';
                return;
            }
            
            container.innerHTML = clients.map((c, i) => `
                <tr>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3;">
                        <span style="background: ${i < 3 ? '#F57600' : '#E5ECF3'}; color: ${i < 3 ? 'white' : '#666'}; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">${i + 1}</span>
                    </td>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3; font-weight: 500; font-size: 13px;">${escapeHtml(c.name)}</td>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${c.services}</td>
                    <td style="padding: 6px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #2E7D32; font-size: 13px;">$${c.revenue.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                </tr>
            `).join('');
        }
        
        function updateTopClientsDisplay(type) {
            const limitSelect = document.getElementById(type === 'week' ? 'topClientsWeekLimit' : 'topClientsMonthLimit');
            const limit = parseInt(limitSelect?.value || 5);
            const fullList = type === 'week' ? fullTopClientsWeek : fullTopClientsMonth;
            const containerId = type === 'week' ? 'topClientsWeek' : 'topClientsMonth';
            
            const displayList = fullList.slice(0, limit);
            renderTopClientsTable(containerId, displayList);
        }
        
        function updateYoYChange(elementId, changePercent) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            const isPositive = changePercent >= 0;
            const arrow = isPositive ? '‚Üë' : '‚Üì';
            const color = isPositive ? '#62B790' : '#EF5350';
            
            el.innerHTML = `<span style="color: ${color};">${arrow} ${Math.abs(changePercent).toFixed(1)}%</span> vs last year`;
        }
        
        function updatePeriodChange(elementId, changePercent, periodType = 'week') {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (changePercent === 0 || isNaN(changePercent)) {
                el.innerHTML = '<span style="color: #999;">No prior data</span>';
                return;
            }
            
            const isPositive = changePercent >= 0;
            const arrow = isPositive ? '‚Üë' : '‚Üì';
            const color = isPositive ? '#62B790' : '#EF5350';
            
            let vsText = '';
            switch(periodType) {
                case 'week':
                    vsText = 'revenue vs prior week';
                    break;
                case 'month':
                    vsText = 'revenue vs prior month';
                    break;
                case 'quarter':
                    vsText = 'revenue vs prior quarter';
                    break;
                default:
                    vsText = 'vs prior period';
            }
            
            el.innerHTML = `<span style="color: ${color};">${arrow} ${Math.abs(changePercent).toFixed(1)}%</span> ${vsText}`;
        }
        
        function renderWeeklyRevenueChart(weeklyData) {
            const ctx = document.getElementById('weeklyRevenueChart');
            if (!ctx) return;
            
            if (weeklyRevenueChart) weeklyRevenueChart.destroy();
            
            weeklyRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyData.map(d => d.label),
                    datasets: [{
                        label: 'Revenue',
                        data: weeklyData.map(d => d.revenue),
                        borderColor: '#F57600',
                        backgroundColor: 'rgba(245, 118, 0, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString(undefined, {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderWeeklyVolumeChart(weeklyData) {
            const ctx = document.getElementById('weeklyVolumeChart');
            if (!ctx) return;
            
            if (weeklyVolumeChart) weeklyVolumeChart.destroy();
            
            weeklyVolumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyData.map(d => d.label),
                    datasets: [
                        {
                            label: 'Services',
                            data: weeklyData.map(d => d.services),
                            backgroundColor: '#62B790',
                            borderRadius: 4,
                            yAxisID: 'y',
                            order: 2  // Higher order = rendered first (behind)
                        },
                        {
                            label: 'Hours',
                            data: weeklyData.map(d => d.hours),
                            type: 'line',
                            borderColor: '#1A365C',
                            backgroundColor: 'rgba(26, 54, 92, 0.1)',
                            tension: 0.3,
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#1A365C',
                            yAxisID: 'y1',
                            order: 1  // Lower order = rendered last (in front)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { position: 'top', labels: { boxWidth: 12, padding: 8 } } },
                    scales: {
                        y: { 
                            type: 'linear', 
                            position: 'left', 
                            beginAtZero: true,
                            title: { display: true, text: 'Services' }
                        },
                        y1: { 
                            type: 'linear', 
                            position: 'right', 
                            beginAtZero: true,
                            title: { display: true, text: 'Hours' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        function renderPeakHoursChart(peakHoursData) {
            const ctx = document.getElementById('peakHoursChart');
            if (!ctx) return;
            
            if (peakHoursChart) peakHoursChart.destroy();
            
            peakHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: peakHoursData.map(d => d.label),
                    datasets: [{
                        label: 'Avg Services',
                        data: peakHoursData.map(d => d.avgServices),
                        backgroundColor: peakHoursData.map(d => {
                            // Color code by intensity
                            const maxVal = Math.max(...peakHoursData.map(x => x.avgServices));
                            const intensity = d.avgServices / maxVal;
                            if (intensity > 0.7) return '#F57600'; // Peak hours - orange
                            if (intensity > 0.4) return '#1A365C'; // Moderate - navy
                            return '#E5ECF3'; // Low - light gray
                        }),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Avg: ' + context.raw.toFixed(1) + ' services/day';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Avg Services' }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        function renderMonthlyRevenueChart(monthlyData) {
            const ctx = document.getElementById('monthlyRevenueChart');
            if (!ctx) return;
            
            if (monthlyRevenueChart) monthlyRevenueChart.destroy();
            
            monthlyRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.label),
                    datasets: [{
                        label: 'Revenue',
                        data: monthlyData.map(d => d.revenue),
                        borderColor: '#F57600',
                        backgroundColor: 'rgba(245, 118, 0, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.raw.toLocaleString(undefined, {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderMonthlyVolumeChart(monthlyData) {
            const ctx = document.getElementById('monthlyVolumeChart');
            if (!ctx) return;
            
            if (monthlyVolumeChart) monthlyVolumeChart.destroy();
            
            monthlyVolumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(d => d.label),
                    datasets: [{
                        label: 'Services',
                        data: monthlyData.map(d => d.services),
                        backgroundColor: '#1A365C',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Services' } }
                    }
                }
            });
        }
        
        function renderQuarterlyChart(quarterlyData) {
            const ctx = document.getElementById('quarterlyChart');
            if (!ctx) return;
            
            if (quarterlyChart) quarterlyChart.destroy();
            
            quarterlyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [{
                        data: quarterlyData.map(d => d.revenue),
                        backgroundColor: ['#1A365C', '#F57600', '#62B790', '#2196F3'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '40%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return context.label + ': $' + value.toLocaleString(undefined, {maximumFractionDigits: 0});
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value, context) {
                                const label = context.chart.data.labels[context.dataIndex];
                                if (value > 0) {
                                    return label;
                                }
                                return '';
                            },
                            anchor: 'center',
                            align: 'center'
                        }
                    }
                }
            });
        }
        
        // ============================================
        // ARCHIVE DATA FUNCTIONS
        // ============================================
        
        let archiveData = [];
        let archiveYears = [];
        
        async function loadArchiveYears() {
            try {
                console.log('Calling getArchiveYears...');
                const result = await jsonpFetch({ action: 'getArchiveYears' });
                console.log('getArchiveYears result:', result);
                
                if (result.success) {
                    archiveYears = result.years || [];
                    console.log('Archive years found:', archiveYears);
                    
                    // Update UI
                    document.getElementById('archiveNotConfigured').style.display = 'none';
                    document.getElementById('archiveContent').style.display = 'block';
                    
                    // Populate year dropdown
                    const select = document.getElementById('archiveYearSelect');
                    select.innerHTML = '<option value="">All Years</option>';
                    archiveYears.forEach(year => {
                        select.innerHTML += `<option value="${year}">${year}</option>`;
                    });
                    
                    // Update stats
                    document.getElementById('archiveStatsContent').innerHTML = `
                        <div style="font-weight: 600;">${result.totalRecords?.toLocaleString() || 0} records archived</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Years: ${archiveYears.length > 0 ? archiveYears.join(', ') : 'None'}
                        </div>
                    `;
                    
                    showToast(`Found ${archiveYears.length} years in archive`, 'success');
                } else if (result.error && result.error.includes('not configured')) {
                    document.getElementById('archiveNotConfigured').style.display = 'block';
                    document.getElementById('archiveContent').style.display = 'none';
                    showToast('Archive not configured', 'warning');
                } else {
                    console.error('Archive error:', result.error);
                    showToast('Error loading archive: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error loading archive years:', error);
                showToast('Error loading archive years: ' + error.message, 'error');
            }
        }
        
        async function loadArchiveData() {
            const year = document.getElementById('archiveYearSelect').value;
            console.log('Loading archive data for year:', year || 'all');
            
            try {
                showLoading('Loading Archive Data', year ? `Retrieving ${year} records...` : 'Retrieving all historical records...');
                
                const params = { action: 'getArchiveData' };
                if (year) params.year = year;
                
                console.log('Calling getArchiveData with params:', params);
                const result = await jsonpFetch(params);
                console.log('getArchiveData result:', result);
                hideLoading();
                
                if (result.success) {
                    archiveData = result.data || [];
                    console.log('Archive data loaded:', archiveData.length, 'records');
                    console.log('Sample archive record:', archiveData[0]);
                    
                    if (archiveData.length === 0) {
                        showToast('No archive data found' + (year ? ' for ' + year : ''), 'warning');
                        return;
                    }
                    
                    showToast(`Loaded ${archiveData.length} archive records${year ? ' from ' + year : ''}`, 'success');
                    
                    // Ask if user wants to view archive data in dashboard
                    if (confirm(`Loaded ${archiveData.length} archive records.\n\nWould you like to view this data in the dashboard?\n\nNote: This will temporarily show historical data.`)) {
                        showLoading('Updating Dashboard', 'Calculating metrics for archive data...');
                        
                        // Add archive year to dropdown if not present
                        const yearSelect = document.getElementById('dashboardYear');
                        archiveYears.forEach(y => {
                            if (!Array.from(yearSelect.options).some(opt => opt.value == y)) {
                                const option = document.createElement('option');
                                option.value = y;
                                option.textContent = y;
                                yearSelect.appendChild(option);
                            }
                        });
                        
                        // Sort options descending
                        const options = Array.from(yearSelect.options);
                        options.sort((a, b) => parseInt(b.value) - parseInt(a.value));
                        yearSelect.innerHTML = '';
                        options.forEach(opt => yearSelect.appendChild(opt));
                        
                        // Set the year selector to the archive year
                        const targetYear = year ? parseInt(year) : (archiveYears.length > 0 ? archiveYears[0] : new Date().getFullYear());
                        yearSelect.value = targetYear;
                        document.getElementById('dashboardYearLabel').textContent = targetYear;
                        
                        // Calculate metrics using ONLY archive data for historical view
                        const metrics = calculateDashboardMetrics(archiveData, targetYear);
                        console.log('Archive metrics calculated:', metrics);
                        
                        // Update YTD KPIs with archive data
                        document.getElementById('ytdServices').textContent = metrics.ytd.services.toLocaleString();
                        document.getElementById('ytdHours').textContent = metrics.ytd.hours.toLocaleString(undefined, {maximumFractionDigits: 1});
                        document.getElementById('ytdRevenue').textContent = '$' + metrics.ytd.revenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                        document.getElementById('ytdAvgRevenue').textContent = '$' + metrics.ytd.avgRevenue.toLocaleString(undefined, {maximumFractionDigits: 0});
                        
                        // Clear YoY changes for archive (no comparison available)
                        document.getElementById('ytdServicesChange').textContent = 'Archive';
                        document.getElementById('ytdServicesChange').style.color = '#666';
                        document.getElementById('ytdHoursChange').textContent = 'Archive';
                        document.getElementById('ytdHoursChange').style.color = '#666';
                        document.getElementById('ytdRevenueChange').textContent = 'Archive';
                        document.getElementById('ytdRevenueChange').style.color = '#666';
                        document.getElementById('ytdAvgRevenueChange').textContent = 'Archive';
                        document.getElementById('ytdAvgRevenueChange').style.color = '#666';
                        
                        // Update period stats
                        document.getElementById('thisWeekServices').textContent = metrics.thisWeek.services.toLocaleString();
                        document.getElementById('thisWeekLabel').textContent = `Week ${metrics.currentWeekNum}`;
                        document.getElementById('thisMonthServices').textContent = metrics.thisMonth.services.toLocaleString();
                        document.getElementById('thisMonthLabel').textContent = metrics.currentMonthName;
                        document.getElementById('thisQuarterServices').textContent = metrics.thisQuarter.services.toLocaleString();
                        document.getElementById('thisQuarterLabel').textContent = `Q${metrics.currentQuarter}`;
                        document.getElementById('activeClients').textContent = metrics.activeClients.toLocaleString();
                        
                        // Update charts with archive data
                        renderWeeklyRevenueChart(metrics.weeklyData);
                        renderWeeklyVolumeChart(metrics.weeklyData);
                        renderPeakHoursChart(metrics.peakHoursData);
                        renderMonthlyRevenueChart(metrics.last13MonthsData);
                        renderMonthlyVolumeChart(metrics.last13MonthsData);
                        renderQuarterlyChart(metrics.quarterlyData);
                        
                        // Update top clients tables
                        renderTopClientsTable('topClientsLastWeek', metrics.topClientsLastWeek);
                        renderTopClientsTable('topClientsMonth', metrics.topClientsMonth);
                        
                        hideLoading();
                        showToast(`Dashboard updated with ${targetYear} archive data`, 'success');
                    }
                    
                    // Update archive stats
                    document.getElementById('archiveStatsContent').innerHTML = `
                        <div style="font-weight: 600; color: #2E7D32;">‚úì ${archiveData.length} records loaded</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${year ? 'Year: ' + year : 'All archived years'}
                        </div>
                        <button class="btn btn-secondary" onclick="loadDashboardData()" style="margin-top: 10px; padding: 6px 12px; font-size: 12px;">
                            ‚Üª Return to Current Data
                        </button>
                    `;
                } else {
                    showToast('Error loading archive: ' + result.error, 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Error loading archive data:', error);
                showToast('Error loading archive data', 'error');
            }
        }
        
        // ============================================
        // AUTOMATION CONFIGURATION FUNCTIONS
        // ============================================
        
        const DEFAULT_AUTOMATION_CONFIG = {
            pauseAll: false,
            testMode: false,
            testEmail: '',
            weekly: {
                enabled: true,
                uploadDays: 'Mon-Tue',
                delayHours: 2
            },
            monthly: {
                enabled: true,
                sendDay: 10,
                sendTime: '09:00'
            },
            yearly: {
                enabled: true,
                sendMonth: 1,
                sendDay: 15,
                sendTime: '09:00'
            }
        };
        
        function openAutomationSettings() {
            loadAutomationConfig();
            document.getElementById('automationModal').classList.add('active');
        }
        
        function closeAutomationSettings() {
            document.getElementById('automationModal').classList.remove('active');
        }
        
        function loadAutomationConfig() {
            const saved = localStorage.getItem('aliceCareAutomationConfig');
            const config = saved ? JSON.parse(saved) : DEFAULT_AUTOMATION_CONFIG;
            
            // Global controls
            document.getElementById('configPauseAll').checked = config.pauseAll || false;
            document.getElementById('pauseAllLabel').textContent = config.pauseAll ? 'Paused' : 'Active';
            document.getElementById('configTestMode').checked = config.testMode || false;
            document.getElementById('testModeLabel').textContent = config.testMode ? 'On' : 'Off';
            document.getElementById('configTestEmail').value = config.testEmail || '';
            document.getElementById('testEmailContainer').style.display = config.testMode ? 'block' : 'none';
            
            // Weekly
            document.getElementById('configWeeklyEnabled').checked = config.weekly?.enabled !== false;
            document.getElementById('configWeeklyUploadDays').value = config.weekly?.uploadDays || 'Mon-Tue';
            document.getElementById('configWeeklyDelay').value = config.weekly?.delayHours || 2;
            toggleReportType('weekly', false);
            
            // Monthly
            document.getElementById('configMonthlyEnabled').checked = config.monthly?.enabled !== false;
            document.getElementById('configMonthlySendDay').value = config.monthly?.sendDay || 10;
            document.getElementById('configMonthlySendTime').value = config.monthly?.sendTime || '09:00';
            toggleReportType('monthly', false);
            
            // Yearly
            document.getElementById('configYearlyEnabled').checked = config.yearly?.enabled !== false;
            document.getElementById('configYearlySendMonth').value = config.yearly?.sendMonth || 1;
            document.getElementById('configYearlySendDay').value = config.yearly?.sendDay || 15;
            document.getElementById('configYearlySendTime').value = config.yearly?.sendTime || '09:00';
            toggleReportType('yearly', false);
            
            // Update dashboard status
            updateDashboardStatus(config);
        }
        
        function updateDashboardStatus(config) {
            const content = document.getElementById('automationStatusContent');
            if (!content) return;
            
            const weeklyStatus = config.pauseAll ? 'paused' : (config.weekly?.enabled !== false ? 'active' : 'disabled');
            const monthlyStatus = config.pauseAll ? 'paused' : (config.monthly?.enabled !== false ? 'active' : 'disabled');
            const yearlyStatus = config.pauseAll ? 'paused' : (config.yearly?.enabled !== false ? 'active' : 'disabled');
            
            const getStatusBadge = (status) => {
                if (status === 'active') return '<span style="background: #62B790; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Active</span>';
                if (status === 'paused') return '<span style="background: #F57600; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paused</span>';
                return '<span style="background: #999; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Disabled</span>';
            };
            
            content.innerHTML = `
                <div style="text-align: center; padding: 15px; background: #E3F2FD; border-radius: 8px;">
                    <div style="font-weight: 600; color: #2196F3; margin-bottom: 5px;">Weekly</div>
                    ${getStatusBadge(weeklyStatus)}
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">${config.weekly?.delayHours || 2}h delay</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #E0F1E9; border-radius: 8px;">
                    <div style="font-weight: 600; color: #62B790; margin-bottom: 5px;">Monthly</div>
                    ${getStatusBadge(monthlyStatus)}
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">Day ${config.monthly?.sendDay || 10}</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #FFF3E0; border-radius: 8px;">
                    <div style="font-weight: 600; color: #F57600; margin-bottom: 5px;">Yearly</div>
                    ${getStatusBadge(yearlyStatus)}
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">Jan ${config.yearly?.sendDay || 15}</div>
                </div>
            `;
            
            // Show test mode indicator if enabled
            if (config.testMode) {
                content.innerHTML += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 10px; background: #E8F5E9; border-radius: 8px; margin-top: 10px;">
                        üß™ <strong>Test Mode Active</strong> - Reports will be sent to: ${config.testEmail || 'Not set'}
                    </div>
                `;
            }
        }
        
        function togglePauseAll() {
            const paused = document.getElementById('configPauseAll').checked;
            document.getElementById('pauseAllLabel').textContent = paused ? 'Paused' : 'Active';
        }
        
        function toggleTestMode() {
            const testMode = document.getElementById('configTestMode').checked;
            document.getElementById('testModeLabel').textContent = testMode ? 'On' : 'Off';
            document.getElementById('testEmailContainer').style.display = testMode ? 'block' : 'none';
        }
        
        function toggleReportType(type, showToastMsg = true) {
            const enabled = document.getElementById(`config${type.charAt(0).toUpperCase() + type.slice(1)}Enabled`).checked;
            const card = document.getElementById(`${type}ConfigCard`);
            const fields = document.getElementById(`${type}ConfigFields`);
            
            if (enabled) {
                card.style.opacity = '1';
                fields.style.pointerEvents = 'auto';
            } else {
                card.style.opacity = '0.5';
                fields.style.pointerEvents = 'none';
            }
        }
        
        async function saveAutomationConfig() {
            const config = {
                pauseAll: document.getElementById('configPauseAll').checked,
                testMode: document.getElementById('configTestMode').checked,
                testEmail: document.getElementById('configTestEmail').value.trim(),
                weekly: {
                    enabled: document.getElementById('configWeeklyEnabled').checked,
                    uploadDays: document.getElementById('configWeeklyUploadDays').value,
                    delayHours: parseInt(document.getElementById('configWeeklyDelay').value) || 2
                },
                monthly: {
                    enabled: document.getElementById('configMonthlyEnabled').checked,
                    sendDay: parseInt(document.getElementById('configMonthlySendDay').value) || 10,
                    sendTime: document.getElementById('configMonthlySendTime').value || '09:00'
                },
                yearly: {
                    enabled: document.getElementById('configYearlyEnabled').checked,
                    sendMonth: parseInt(document.getElementById('configYearlySendMonth').value) || 1,
                    sendDay: parseInt(document.getElementById('configYearlySendDay').value) || 15,
                    sendTime: document.getElementById('configYearlySendTime').value || '09:00'
                }
            };
            
            // Validate test email if test mode is on
            if (config.testMode && !config.testEmail) {
                showToast('Please enter a test email address', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('aliceCareAutomationConfig', JSON.stringify(config));
            
            // Update dashboard display
            updateDashboardStatus(config);
            
            // Save to backend
            try {
                const result = await jsonpFetch({ 
                    action: 'saveAutomationConfig', 
                    config: JSON.stringify(config)
                });
                
                if (result.success) {
                    showToast('Automation configuration saved!', 'success');
                    closeAutomationSettings();
                } else {
                    showToast('Saved locally. Backend save failed: ' + (result.error || 'Unknown error'), 'warning');
                }
            } catch (error) {
                showToast('Saved locally. Could not sync with server.', 'warning');
            }
        }
        
        async function testSendSingleReport() {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            
            if (!config.testMode || !config.testEmail) {
                showToast('Please enable Test Mode and enter a test email first', 'warning');
                return;
            }
            
            // Load client data if not already loaded
            if (clientData.length === 0) {
                showToast('Loading client data...', 'info');
                await loadClientData();
            }
            
            // Update modal with test email
            document.getElementById('testReportEmailDisplay').textContent = config.testEmail;
            document.getElementById('testClientSearch').value = '';
            document.getElementById('testClientSelected').value = '';
            document.getElementById('testClientInfo').style.display = 'none';
            document.getElementById('testReportStatus').style.display = 'none';
            document.getElementById('testClientDropdown').style.display = 'none';
            
            // Reset report type selection
            document.querySelector('input[name="testReportType"][value="weekly"]').checked = true;
            updateReportTypeSelection();
            
            // Set default period values (previous week/month/year)
            const now = new Date();
            const currentWeek = getWeekNumber(now);
            const previousWeek = currentWeek === 1 ? 52 : currentWeek - 1;
            const previousMonth = now.getMonth() === 0 ? 12 : now.getMonth();
            const weekYear = currentWeek === 1 ? now.getFullYear() - 1 : now.getFullYear();
            const monthYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
            
            document.getElementById('testPeriodWeek').value = previousWeek;
            document.getElementById('testPeriodMonth').value = previousMonth;
            document.getElementById('testPeriodYear').value = weekYear;
            
            // Show modal
            document.getElementById('testReportModal').classList.add('active');
        }
        
        function updateReportTypeSelection() {
            const selected = document.querySelector('input[name="testReportType"]:checked')?.value || 'weekly';
            
            // Update visual styling
            ['weekly', 'monthly', 'yearly'].forEach(type => {
                const opt = document.getElementById('opt' + type.charAt(0).toUpperCase() + type.slice(1));
                if (opt) {
                    if (type === selected) {
                        opt.style.borderColor = '#2196F3';
                        opt.style.background = '#E3F2FD';
                        opt.querySelector('span').style.color = '#2196F3';
                    } else {
                        opt.style.borderColor = '#ddd';
                        opt.style.background = 'white';
                        opt.querySelector('span').style.color = '#666';
                    }
                }
            });
            
            // Show/hide period selectors
            document.getElementById('testPeriodWeekContainer').style.display = selected === 'weekly' ? 'block' : 'none';
            document.getElementById('testPeriodMonthContainer').style.display = selected === 'monthly' ? 'block' : 'none';
            
            // Update year based on selection
            const now = new Date();
            if (selected === 'weekly') {
                const currentWeek = getWeekNumber(now);
                document.getElementById('testPeriodYear').value = currentWeek === 1 ? now.getFullYear() - 1 : now.getFullYear();
            } else if (selected === 'monthly') {
                document.getElementById('testPeriodYear').value = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
            } else {
                document.getElementById('testPeriodYear').value = now.getFullYear() - 1;
            }
        }
        
        function closeTestReportModal() {
            document.getElementById('testReportModal').classList.remove('active');
        }
        
        function searchTestClients() {
            const query = document.getElementById('testClientSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('testClientDropdown');
            
            if (!query || query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = clientData.filter(client => {
                const name = (client['Customer Name'] || '').toLowerCase();
                const email = (client['email'] || '').toLowerCase();
                return name.includes(query) || email.includes(query);
            }).slice(0, 10);
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color: #999;">No matching clients found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = matches.map(client => {
                const name = client['Customer Name'] || 'Unknown';
                const email = client['email'] || 'No email';
                const subscription = client['Subscription'] || 'No subscription';
                return `
                    <div class="autocomplete-item" onclick="selectTestClient('${escapeHtml(name)}')">
                        <div class="client-name" style="font-weight: 600;">${escapeHtml(name)}</div>
                        <div style="font-size: 11px; color: #666;">${escapeHtml(email)}</div>
                        <div style="font-size: 10px; color: #999;">Subscription: ${escapeHtml(subscription)}</div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectTestClient(customerName) {
            const client = clientData.find(c => c['Customer Name'] === customerName);
            if (!client) return;
            
            document.getElementById('testClientSearch').value = customerName;
            document.getElementById('testClientSelected').value = customerName;
            document.getElementById('testClientDropdown').style.display = 'none';
            
            // Show client info
            document.getElementById('testClientName').textContent = customerName;
            document.getElementById('testClientEmail').textContent = 'Email: ' + (client['email'] || 'Not set');
            document.getElementById('testClientSubscription').textContent = 'Subscription: ' + (client['Subscription'] || 'None');
            document.getElementById('testClientInfo').style.display = 'block';
            
            // Reset invoice preview
            document.getElementById('invoicePreviewResult').style.display = 'none';
        }
        
        // Preview Invoice Info for selected client
        async function previewInvoice() {
            const customerName = document.getElementById('testClientSelected').value;
            
            if (!customerName) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const resultDiv = document.getElementById('invoicePreviewResult');
            resultDiv.innerHTML = '<div style="color: #666; font-size: 12px;"><span class="spinner" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></span> Loading invoice info...</div>';
            resultDiv.style.display = 'block';
            
            try {
                const result = await jsonpFetch({
                    action: 'previewInvoice',
                    customerName: customerName
                });
                
                if (result.success) {
                    const info = result.invoiceInfo;
                    
                    let html = '<div style="background: white; border: 1px solid #E5ECF3; border-radius: 6px; padding: 12px; font-size: 12px;">';
                    html += '<div style="font-weight: 600; color: #1A365C; margin-bottom: 10px;">üìã Invoice Preview</div>';
                    
                    // AOB Status
                    html += `<div style="margin-bottom: 8px;">
                        <span style="color: #666;">Assignment of Benefits:</span> 
                        <span style="font-weight: 600; color: ${info.isAOB ? '#059669' : '#666'};">${info.isAOB ? '‚úì Yes' : '‚úó No'}</span>
                    </div>`;
                    
                    // Insurance
                    html += `<div style="margin-bottom: 8px;">
                        <span style="color: #666;">Insurance:</span> 
                        <span style="font-weight: 600;">${info.insuranceName || 'N/A'}</span>
                        ${info.isExempt ? '<span style="background: #FEE2E2; color: #991B1B; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px;">EXEMPT</span>' : ''}
                    </div>`;
                    
                    // Invoice Number
                    if (info.willGetInvoice) {
                        html += `<div style="background: #FFF7ED; border: 1px solid #F57600; border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <div style="color: #F57600; font-weight: 600;">üßæ Invoice Number: #${info.nextInvoiceNumber}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">This client WILL receive an invoice number on their next report.</div>
                        </div>`;
                    } else {
                        html += `<div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <div style="color: #666; font-weight: 600;">No Invoice Number</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${!info.isAOB ? 'Reason: Not an Assignment of Benefits client' : ''}
                                ${info.isAOB && info.isExempt ? 'Reason: Insurance is in exemption list' : ''}
                            </div>
                        </div>`;
                    }
                    
                    // Email Routing
                    html += `<div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #E5ECF3;">
                        <div style="font-weight: 600; color: #1A365C; margin-bottom: 6px;">üìß Email Routing</div>
                        <div style="font-size: 11px; color: #666;">
                            <div><strong>TO:</strong> ${info.emailTo || 'Insurance email'}</div>
                            <div><strong>BCC:</strong> ${info.emailBcc || 'Client email'}</div>
                        </div>
                    </div>`;
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div style="color: #DC2626; font-size: 12px;">‚ùå Error: ${result.error || 'Failed to load invoice info'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div style="color: #DC2626; font-size: 12px;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        async function sendTestReportFromModal() {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            const customerName = document.getElementById('testClientSelected').value;
            const reportType = document.querySelector('input[name="testReportType"]:checked')?.value || 'weekly';
            const statusDiv = document.getElementById('testReportStatus');
            const sendBtn = document.getElementById('sendTestBtn');
            
            if (!customerName) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            // Get period values
            let periodValue, year;
            if (reportType === 'weekly') {
                periodValue = parseInt(document.getElementById('testPeriodWeek').value) || 1;
            } else if (reportType === 'monthly') {
                periodValue = parseInt(document.getElementById('testPeriodMonth').value) || 1;
            } else {
                periodValue = null; // yearly doesn't need periodValue
            }
            year = parseInt(document.getElementById('testPeriodYear').value) || new Date().getFullYear();
            
            // Show sending status
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#E3F2FD';
            statusDiv.style.border = '1px solid #2196F3';
            statusDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;"><div class="spinner" style="width: 20px; height: 20px;"></div><span>Sending test report...</span></div>';
            sendBtn.disabled = true;
            
            try {
                const params = {
                    action: 'sendTestReport',
                    customerName: customerName,
                    reportType: reportType,
                    testEmail: config.testEmail,
                    year: year
                };
                
                if (periodValue !== null) {
                    params.periodValue = periodValue;
                }
                
                const result = await jsonpFetch(params);
                
                if (result.success) {
                    statusDiv.style.background = '#E8F5E9';
                    statusDiv.style.border = '1px solid #4CAF50';
                    statusDiv.innerHTML = `
                        <div style="color: #2E7D32;">
                            <strong>‚úì Test report sent successfully!</strong>
                            <p style="margin: 5px 0 0; font-size: 12px;">Sent to: ${config.testEmail}</p>
                            <p style="margin: 5px 0 0; font-size: 12px;">Original recipients would be: ${result.originalRecipients || 'N/A'}</p>
                        </div>
                    `;
                    showToast('Test report sent!', 'success');
                } else {
                    statusDiv.style.background = '#FFEBEE';
                    statusDiv.style.border = '1px solid #EF5350';
                    statusDiv.innerHTML = `
                        <div style="color: #C62828;">
                            <strong>‚úó Failed to send test report</strong>
                            <p style="margin: 5px 0 0; font-size: 12px;">${result.error || 'Unknown error'}</p>
                        </div>
                    `;
                    showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                statusDiv.style.background = '#FFEBEE';
                statusDiv.style.border = '1px solid #EF5350';
                statusDiv.innerHTML = `
                    <div style="color: #C62828;">
                        <strong>‚úó Error sending test report</strong>
                        <p style="margin: 5px 0 0; font-size: 12px;">${error.message}</p>
                    </div>
                `;
                showToast('Error: ' + error.message, 'error');
            }
            
            sendBtn.disabled = false;
        }
        
        // Add click listener to close test client dropdown
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('testClientDropdown');
            const search = document.getElementById('testClientSearch');
            if (dropdown && !dropdown.contains(e.target) && e.target !== search) {
                dropdown.style.display = 'none';
            }
        });
        
        function triggerManualSend(type) {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            
            let confirmMsg = `Are you sure you want to send all ${type} reports now?`;
            if (config.testMode) {
                confirmMsg += `\n\nüß™ TEST MODE: Reports will be sent to ${config.testEmail || 'test email'}`;
            } else {
                confirmMsg += `\n\n‚ö†Ô∏è This will send to actual recipients!`;
            }
            
            if (!confirm(confirmMsg)) return;
            
            sendBulkReports(type);
        }
        
        async function sendBulkReports(reportType) {
            showLoading('Sending Reports', `Preparing ${reportType} reports for all clients...`);
            
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            
            try {
                updateLoadingText('Sending Reports', 'This may take a few minutes...');
                
                const result = await jsonpFetch({ 
                    action: 'sendBulkReports', 
                    reportType: reportType,
                    testMode: config.testMode ? 'true' : 'false',
                    testEmail: config.testEmail || ''
                });
                
                hideLoading();
                
                if (result.success) {
                    showToast(`${reportType} reports sent! ${result.sentCount} emails sent.`, 'success');
                } else {
                    showToast('Failed to send reports: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Error sending reports: ' + error.message, 'error');
            }
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function getMonthName(month) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month - 1] || 'Unknown';
        }
        
        // ============================================
        // NEW CLIENTS PER WEEK CHART
        // ============================================
        
        // Global chart reference for cleanup
        let newClientsChartInstance = null;
        
        /**
         * Calculate new clients per week
         * New Client = First time a client appears in the data (first service ever)
         */
        function calculateNewClientsPerWeek(allData, weeksToShow = 12) {
            // Step 1: Find each client's first service date using normalized names
            const clientFirstService = {};
            
            allData.forEach(record => {
                const clientName = record['Customer Name'] || record['Client Name'] || record['Client_Name'] || '';
                const scheduledDate = record['Scheduled Date'] || record['Scheduled_Date'] || '';
                const hours = (parseFloat(record['Service Duration']) || 0) / 60; // Convert minutes to hours
                const recordWeek = parseInt(record['Week']) || 0;
                const recordYear = parseInt(record['Year']) || 0;
                
                if (!clientName || clientName === 'Unknown' || !scheduledDate) return;
                
                const dateObj = new Date(scheduledDate);
                if (isNaN(dateObj.getTime())) return;
                
                const normalizedClient = normalizeName(clientName);
                if (!normalizedClient) return;
                
                // Calculate week/year from date if not in record
                const week = recordWeek || getWeekNumber(dateObj);
                const year = recordYear || dateObj.getFullYear();
                
                if (!clientFirstService[normalizedClient]) {
                    clientFirstService[normalizedClient] = {
                        clientName: clientName,
                        firstDate: dateObj,
                        firstWeek: week,
                        firstYear: year,
                        firstWeekHours: hours
                    };
                } else {
                    // Update if this service is earlier
                    if (dateObj < clientFirstService[normalizedClient].firstDate) {
                        clientFirstService[normalizedClient].firstDate = dateObj;
                        clientFirstService[normalizedClient].firstWeek = week;
                        clientFirstService[normalizedClient].firstYear = year;
                        clientFirstService[normalizedClient].firstWeekHours = hours;
                    }
                }
            });
            
            // Step 2: Aggregate all hours for clients in their first week
            Object.keys(clientFirstService).forEach(normalizedClient => {
                const client = clientFirstService[normalizedClient];
                let totalFirstWeekHours = 0;
                
                allData.forEach(record => {
                    const recordClient = normalizeName(record['Customer Name'] || record['Client Name'] || record['Client_Name'] || '');
                    const recordWeek = parseInt(record['Week']) || 0;
                    const recordYear = parseInt(record['Year']) || 0;
                    const hours = (parseFloat(record['Service Duration']) || 0) / 60;
                    
                    // Get week/year from date if not available
                    let week = recordWeek;
                    let year = recordYear;
                    if (!week || !year) {
                        const dateObj = new Date(record['Scheduled Date'] || record['Scheduled_Date'] || '');
                        if (!isNaN(dateObj.getTime())) {
                            week = week || getWeekNumber(dateObj);
                            year = year || dateObj.getFullYear();
                        }
                    }
                    
                    if (recordClient === normalizedClient &&
                        week === client.firstWeek &&
                        year === client.firstYear) {
                        totalFirstWeekHours += hours;
                    }
                });
                
                client.firstWeekHours = totalFirstWeekHours;
            });
            
            // Step 3: Build week-by-week aggregation
            const weeklyNewClients = {};
            
            Object.values(clientFirstService).forEach(client => {
                const weekKey = `${client.firstYear}-W${String(client.firstWeek).padStart(2, '0')}`;
                
                if (!weeklyNewClients[weekKey]) {
                    weeklyNewClients[weekKey] = {
                        week: client.firstWeek,
                        year: client.firstYear,
                        count: 0,
                        totalHours: 0,
                        clients: []
                    };
                }
                
                weeklyNewClients[weekKey].count++;
                weeklyNewClients[weekKey].totalHours += client.firstWeekHours;
                weeklyNewClients[weekKey].clients.push({
                    name: client.clientName,
                    hours: Math.round(client.firstWeekHours * 10) / 10
                });
            });
            
            // Step 4: Get last N weeks (ending with last week, not current week)
            const today = new Date();
            const currentWeek = getWeekNumber(today);
            const currentYear = today.getFullYear();
            
            // Go back one week to start from "last week"
            let targetWeek = currentWeek - 1;
            let targetYear = currentYear;
            if (targetWeek < 1) {
                targetWeek = 52;
                targetYear--;
            }
            
            const labels = [];
            const newClientCounts = [];
            const newClientHours = [];
            const weekDetails = [];
            
            // Build from oldest to newest (for chart display)
            for (let i = 0; i < weeksToShow; i++) {
                let w = targetWeek - (weeksToShow - 1 - i);
                let y = targetYear;
                
                while (w < 1) {
                    w += 52;
                    y--;
                }
                
                const weekKey = `${y}-W${String(w).padStart(2, '0')}`;
                const data = weeklyNewClients[weekKey] || { count: 0, totalHours: 0, clients: [] };
                
                labels.push(`W${w}`);
                newClientCounts.push(data.count);
                newClientHours.push(Math.round(data.totalHours * 10) / 10);
                weekDetails.push({
                    week: w,
                    year: y,
                    weekKey: weekKey,
                    clients: data.clients
                });
            }
            
            const totalNewClients = newClientCounts.reduce((a, b) => a + b, 0);
            const totalFirstWeekHours = newClientHours.reduce((a, b) => a + b, 0);
            
            return {
                labels,
                newClientCounts,
                newClientHours,
                weekDetails,
                summary: {
                    totalNewClients: totalNewClients,
                    totalFirstWeekHours: Math.round(totalFirstWeekHours * 10) / 10,
                    avgNewClientsPerWeek: Math.round((totalNewClients / weeksToShow) * 10) / 10,
                    avgHoursPerNewClient: totalNewClients > 0 
                        ? Math.round((totalFirstWeekHours / totalNewClients) * 10) / 10
                        : 0
                }
            };
        }
        
        /**
         * Render the New Clients Per Week chart
         * Uses dual Y-axes: left for count, right for hours
         */
        function renderNewClientsChart(data) {
            const ctx = document.getElementById('newClientsChart');
            if (!ctx) return;
            
            // Destroy existing chart if present
            if (newClientsChartInstance) {
                newClientsChartInstance.destroy();
            }
            
            newClientsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'New Clients',
                            data: data.newClientCounts,
                            backgroundColor: 'rgba(26, 54, 92, 0.8)',  // Navy
                            borderColor: '#1A365C',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'First Week Hours',
                            data: data.newClientHours,
                            type: 'line',
                            borderColor: '#F57600',  // Orange
                            backgroundColor: 'rgba(245, 118, 0, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#F57600',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const weekIndex = context[0].dataIndex;
                                    const weekDetail = data.weekDetails[weekIndex];
                                    if (weekDetail && weekDetail.clients.length > 0) {
                                        let lines = ['', 'New clients this week:'];
                                        weekDetail.clients.slice(0, 5).forEach(c => {
                                            lines.push(`  ‚Ä¢ ${c.name}: ${c.hours} hrs`);
                                        });
                                        if (weekDetail.clients.length > 5) {
                                            lines.push(`  ... and ${weekDetail.clients.length - 5} more`);
                                        }
                                        return lines;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: { size: 11 }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'New Clients',
                                color: '#1A365C',
                                font: { weight: '500', size: 11 }
                            },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#1A365C',
                                font: { size: 10 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'First Week Hours',
                                color: '#F57600',
                                font: { weight: '500', size: 11 }
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#F57600',
                                font: { size: 10 }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Load and render the new clients chart
         * Called from calculateClientInsights
         */
        function loadNewClientsChart(allData) {
            try {
                const newClientsData = calculateNewClientsPerWeek(allData, 12);
                
                // Update summary stats
                const totalEl = document.getElementById('newClientsTotal');
                const avgCountEl = document.getElementById('newClientsAvgCount');
                const avgHoursEl = document.getElementById('newClientsAvgHours');
                
                if (totalEl) totalEl.textContent = newClientsData.summary.totalNewClients;
                if (avgCountEl) avgCountEl.textContent = newClientsData.summary.avgNewClientsPerWeek;
                if (avgHoursEl) avgHoursEl.textContent = newClientsData.summary.avgHoursPerNewClient + ' hrs';
                
                // Render chart
                renderNewClientsChart(newClientsData);
                
                console.log('New Clients Chart loaded:', newClientsData.summary);
            } catch (e) {
                console.error('Error loading new clients chart:', e);
            }
        }
        
        async function quickClientLookup() {
            const input = document.getElementById('quickLookupInput').value.trim();
            const container = document.getElementById('quickLookupResult');
            
            if (!input) {
                showToast('Please enter a client name or email', 'warning');
                return;
            }
            
            container.innerHTML = `
                <div class="loading" style="padding: 30px;">
                    <div class="spinner"></div>
                    <p>Searching...</p>
                </div>
            `;
            
            try {
                let result = await jsonpFetch({ action: 'getClientByEmail', email: input });
                
                if (!result.success) {
                    result = await jsonpFetch({ action: 'getClientByName', name: input });
                }
                
                if (result.success && result.client) {
                    const client = result.client;
                    const fullName = `${client['Name'] || ''} ${client['Last_Name'] || ''}`.trim();
                    
                    container.innerHTML = `
                        <div class="lookup-result-card">
                            <h4>${escapeHtml(fullName)}</h4>
                            <p>${escapeHtml(client['eMails'] || 'No email')}</p>
                            <button class="btn btn-primary" onclick="openClientDetail('${escapeHtml(client['eMails'])}')">
                                View Full Profile
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #999;">
                            <p>No client found matching "<strong>${escapeHtml(input)}</strong>"</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #FF7475;">
                        <p>Error searching for client</p>
                    </div>
                `;
            }
        }
        
        async function quickClientLookupByName(name) {
            try {
                const result = await jsonpFetch({ action: 'getClientByName', name: name });
                
                if (result.success && result.client && result.client['eMails']) {
                    openClientDetail(result.client['eMails']);
                } else {
                    showToast('Client details not found in directory', 'warning');
                }
            } catch (error) {
                showToast('Error looking up client', 'error');
            }
        }
        
        // ============================================
        // CLIENT INSIGHTS FUNCTIONS
        // ============================================
        
        let clientInsightsData = null;
        let allClientsLTV = [];
        let insightsLoading = false;
        
        async function loadClientInsights() {
            // Prevent multiple simultaneous loads
            if (insightsLoading) {
                console.log('Client Insights already loading, skipping...');
                return;
            }
            insightsLoading = true;
            
            const loadingEl = document.getElementById('insightsLoading');
            const contentEl = document.getElementById('insightsContent');
            const yearSelect = document.getElementById('insightsYearSelect');
            
            try {
                // Populate year dropdown if not done
                if (yearSelect.options.length <= 1 || yearSelect.options[0].value === '') {
                    if (availableYears.length === 0) {
                        await loadAvailableYears();
                    }
                    yearSelect.innerHTML = availableYears.map(y => 
                        `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`
                    ).join('');
                }
                
                const selectedYear = parseInt(yearSelect.value) || new Date().getFullYear();
                console.log('Loading Client Insights for year:', selectedYear);
                console.log('Available years:', availableYears);
                
                // Find which years need to be loaded (not already in cache)
                const yearsToLoad = availableYears.filter(year => !dashboardDataCache[year]);
                console.log('Years to load:', yearsToLoad);
                
                // Only show loading if we need to fetch data
                if (yearsToLoad.length > 0) {
                    loadingEl.style.display = 'block';
                    contentEl.style.display = 'none';
                    
                    console.log('Fetching missing years data...');
                    await Promise.all(yearsToLoad.map(year => loadDashboardDataForYear(year)));
                    // Save to localStorage after loading all years
                    saveCacheToStorage();
                }
                
                // Log cache state before calculating
                console.log('Cache state before calculation:');
                Object.keys(dashboardDataCache).forEach(year => {
                    console.log(`  ${year}: ${dashboardDataCache[year]?.length || 0} records`);
                });
                
                // Calculate insights
                calculateClientInsights(selectedYear);
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (e) {
                console.error('Error loading client insights:', e);
                loadingEl.innerHTML = `<p style="color: red;">Error loading insights: ${e.message}</p>`;
            } finally {
                insightsLoading = false;
            }
        }
        
        async function loadDashboardDataForYear(year) {
            try {
                // Check if already in memory cache
                if (dashboardDataCache[year] && dashboardDataCache[year].length > 0) {
                    console.log(`Year ${year} already in memory cache (${dashboardDataCache[year].length} records)`);
                    return;
                }
                
                console.log(`Loading data for year ${year}...`);
                
                // Try Google Sheets cache first
                const cacheResult = await loadFromGoogleSheetsCache(year);
                
                if (cacheResult.success && cacheResult.data && cacheResult.data.length > 0) {
                    dashboardDataCache[year] = cacheResult.data;
                    console.log(`Loaded ${cacheResult.data.length} records for ${year} from Google Sheets cache (${cacheResult.cacheAgeHours?.toFixed(1) || '?'}h old)`);
                    return;
                }
                
                // Fall back to fetching from source
                console.log(`Fetching data for year ${year} from source...`);
                const result = await jsonpFetch({ action: 'getDashboardData', year: year, includeLastYear: false });
                if (result.success) {
                    dashboardDataCache[year] = result.data;
                    console.log(`Cached ${result.data.length} records for ${year}`);
                    
                    // Update Google Sheets cache in background
                    updateGoogleSheetsCache(year).catch(e => 
                        console.warn(`Background cache update failed for ${year}:`, e)
                    );
                }
            } catch (e) {
                console.error('Error loading data for year', year, e);
            }
        }
        
        function calculateClientInsights(selectedYear) {
            const now = new Date();
            const currentYear = now.getFullYear();
            
            console.log('calculateClientInsights called with year:', selectedYear);
            console.log('Available years:', availableYears);
            console.log('Dashboard cache keys:', Object.keys(dashboardDataCache));
            
            // Combine all years data for lifetime calculations
            let allData = [];
            availableYears.forEach(year => {
                if (dashboardDataCache[year]) {
                    console.log(`Adding ${dashboardDataCache[year].length} records from ${year}`);
                    allData = allData.concat(dashboardDataCache[year]);
                }
            });
            
            console.log('Total allData records:', allData.length);
            
            // Get selected year data for current period calculations
            const yearData = dashboardDataCache[selectedYear] || [];
            console.log('Selected year data records:', yearData.length);
            
            if (allData.length === 0) {
                console.warn('No data available for client insights');
                return;
            }
            
            // Log sample record to check field names
            if (allData.length > 0) {
                console.log('Sample record fields:', Object.keys(allData[0]));
                console.log('Sample record:', allData[0]);
            }
            
            // Calculate client-level metrics with name normalization
            const clientStats = {};
            const clientNameVariants = {}; // Track original name variants
            
            allData.forEach(r => {
                const originalName = r['Customer Name'];  // Field is 'Customer Name' not 'Client Name'
                if (!originalName || originalName === 'Unknown') return;
                
                const normalizedName = normalizeName(originalName);
                if (!normalizedName) return;
                
                const serviceDate = new Date(r['Scheduled Date']);
                if (isNaN(serviceDate.getTime())) return;
                
                const revenue = parseFloat(r['Cost To Customer']) || 0;  // Field is 'Cost To Customer' not 'Total Revenue'
                const hours = (parseFloat(r['Service Duration']) || 0) / 60;
                
                if (!clientStats[normalizedName]) {
                    clientStats[normalizedName] = {
                        name: originalName,
                        normalizedName,
                        totalRevenue: 0,
                        totalServices: 0,
                        totalHours: 0,
                        firstServiceDate: serviceDate,
                        lastServiceDate: serviceDate,
                        monthlyHours: {},  // Track hours by month for progression analysis
                        weeklyHours: {}    // Track hours by week
                    };
                    clientNameVariants[normalizedName] = new Set([originalName]);
                } else {
                    clientNameVariants[normalizedName].add(originalName);
                }
                
                const cs = clientStats[normalizedName];
                cs.totalRevenue += revenue;
                cs.totalServices += 1;
                cs.totalHours += hours;
                
                if (serviceDate < cs.firstServiceDate) cs.firstServiceDate = serviceDate;
                if (serviceDate > cs.lastServiceDate) cs.lastServiceDate = serviceDate;
                
                // Track monthly hours
                const monthKey = `${serviceDate.getFullYear()}-${String(serviceDate.getMonth() + 1).padStart(2, '0')}`;
                cs.monthlyHours[monthKey] = (cs.monthlyHours[monthKey] || 0) + hours;
                
                // Track weekly hours
                const weekNum = getWeekNumber(serviceDate);
                const weekKey = `${serviceDate.getFullYear()}-W${weekNum}`;
                cs.weeklyHours[weekKey] = (cs.weeklyHours[weekKey] || 0) + hours;
            });
            
            // Add variant info to each client
            Object.keys(clientStats).forEach(normalizedName => {
                const variants = Array.from(clientNameVariants[normalizedName]);
                clientStats[normalizedName].variants = variants;
                clientStats[normalizedName].variantCount = variants.length;
                clientStats[normalizedName].displayName = getMostCommonVariant(variants, allData, 'Customer Name');
            });
            
            // Apply fuzzy matching to merge similar client names
            const mergedClientStats = applyClientFuzzyMatching(clientStats, clientNameVariants);
            
            // Process each client for additional metrics
            Object.values(mergedClientStats).forEach(cs => {
                // Calculate tenure in months
                const tenureMs = cs.lastServiceDate - cs.firstServiceDate;
                cs.tenureMonths = Math.max(1, Math.round(tenureMs / (30 * 24 * 60 * 60 * 1000)));
                
                // Calculate average monthly revenue
                cs.avgMonthlyRevenue = cs.totalRevenue / cs.tenureMonths;
                
                // Calculate weekly hours progression
                const monthKeys = Object.keys(cs.monthlyHours).sort();
                cs.firstMonthHours = cs.monthlyHours[monthKeys[0]] || 0;
                cs.thirdMonthHours = monthKeys.length >= 3 ? cs.monthlyHours[monthKeys[2]] : null;
                cs.sixthMonthHours = monthKeys.length >= 6 ? cs.monthlyHours[monthKeys[5]] : null;
                
                // Find peak weekly hours
                const weeklyValues = Object.values(cs.weeklyHours);
                cs.peakWeeklyHours = weeklyValues.length > 0 ? Math.max(...weeklyValues) : 0;
                
                // Calculate average weekly hours (total hours / weeks active)
                const weeksActive = Object.keys(cs.weeklyHours).length || 1;
                cs.avgWeeklyHours = cs.totalHours / weeksActive;
                
                // Find current weekly hours (last 4 weeks average)
                const recentWeeks = Object.keys(cs.weeklyHours).sort().slice(-4);
                cs.currentWeeklyHours = recentWeeks.length > 0 
                    ? recentWeeks.reduce((sum, wk) => sum + cs.weeklyHours[wk], 0) / recentWeeks.length 
                    : 0;
                
                // Determine if active (service in last 30 days)
                const daysSinceLastService = (now - cs.lastServiceDate) / (24 * 60 * 60 * 1000);
                cs.isActive = daysSinceLastService <= 30;
                cs.daysSinceLastService = Math.floor(daysSinceLastService);
                
                // Find peak month and calculate time since peak
                const peakMonth = monthKeys.reduce((max, key) => 
                    cs.monthlyHours[key] > (cs.monthlyHours[max] || 0) ? key : max, monthKeys[0]);
                cs.peakMonth = peakMonth;
                const peakDate = new Date(peakMonth + '-01');
                cs.monthsSincePeak = Math.floor((cs.lastServiceDate - peakDate) / (30 * 24 * 60 * 60 * 1000));
            });
            
            // Store for LTV table
            allClientsLTV = Object.values(mergedClientStats).sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            console.log(`Client insights: ${allClientsLTV.length} unique clients after fuzzy matching`);
            
            // ============================================
            // INVESTOR-GRADE LTV CALCULATION
            // ============================================
            
            const grossMargin = (parseFloat(document.getElementById('ltvGrossMargin')?.value) || 70) / 100;
            const activeClients = allClientsLTV.filter(c => c.isActive);
            const inactiveClients = allClientsLTV.filter(c => !c.isActive);
            const totalClients = allClientsLTV.length;
            
            // 1. Calculate ARPU (Average Revenue Per User - Monthly)
            // Use last 3 months of data for active clients
            const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
            let recentRevenue = 0;
            let recentMonthCount = 0;
            
            activeClients.forEach(c => {
                const recentMonths = Object.keys(c.monthlyHours).filter(mk => {
                    const [y, m] = mk.split('-').map(Number);
                    return new Date(y, m - 1, 1) >= threeMonthsAgo;
                });
                recentMonths.forEach(mk => {
                    // Calculate revenue for this month (proportional to hours)
                    const monthHours = c.monthlyHours[mk] || 0;
                    const avgHourlyRate = c.totalRevenue / c.totalHours;
                    recentRevenue += monthHours * avgHourlyRate;
                    recentMonthCount++;
                });
            });
            
            const monthlyARPU = activeClients.length > 0 && recentMonthCount > 0
                ? recentRevenue / recentMonthCount
                : (activeClients.length > 0 
                    ? activeClients.reduce((sum, c) => sum + c.avgMonthlyRevenue, 0) / activeClients.length 
                    : 0);
            
            // 2. Calculate Monthly Churn Rate from cohort analysis
            // Look at clients who started 6+ months ago and calculate monthly churn
            const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            const matureClients = allClientsLTV.filter(c => c.firstServiceDate < sixMonthsAgo);
            const maturedAndChurned = matureClients.filter(c => !c.isActive);
            
            // Calculate average monthly churn over the cohort's lifetime
            let totalChurnEvents = maturedAndChurned.length;
            let totalClientMonths = matureClients.reduce((sum, c) => sum + c.tenureMonths, 0);
            
            // Monthly churn rate = churned clients / total client-months
            const monthlyChurnRate = totalClientMonths > 0 
                ? (totalChurnEvents / totalClientMonths)
                : 0.05; // Default 5% if no data
            
            // Cap churn rate at reasonable bounds (1% - 20% monthly)
            const cappedChurnRate = Math.max(0.01, Math.min(0.20, monthlyChurnRate));
            
            // 3. Customer Lifespan = 1 / Monthly Churn Rate
            const customerLifespan = 1 / cappedChurnRate;
            
            // 4. Calculate LTV (Investor Standard)
            // LTV = ARPU √ó Gross Margin √ó Customer Lifespan
            const investorLTV = monthlyARPU * grossMargin * customerLifespan;
            
            // 5. Calculate Average Retention (real cohort data)
            const avgRetentionMonths = allClientsLTV.length > 0
                ? allClientsLTV.reduce((sum, c) => sum + c.tenureMonths, 0) / allClientsLTV.length
                : 0;
            
            // 6. Sensitivity Analysis
            const ltvWorstCase = monthlyARPU * grossMargin * (1 / (cappedChurnRate * 1.5)); // +50% churn
            const ltvBestCase = monthlyARPU * grossMargin * (1 / (cappedChurnRate * 0.75)); // -25% churn
            
            // 7. Total Lifetime Revenue (all time)
            const totalLifetimeRevenue = allClientsLTV.reduce((sum, c) => sum + c.totalRevenue, 0);
            
            // Store LTV data for recalculation
            window.ltvData = {
                arpu: monthlyARPU,
                churnRate: cappedChurnRate,
                lifespan: customerLifespan,
                totalClients: totalClients,
                activeClients: activeClients.length,
                avgRetention: avgRetentionMonths,
                totalRevenue: totalLifetimeRevenue
            };
            
            // Update KPI cards
            document.getElementById('insightsLTV').textContent = '$' + formatNumber(investorLTV);
            document.getElementById('insightsARPU').textContent = '$' + formatNumber(monthlyARPU);
            document.getElementById('insightsChurnRate').textContent = (cappedChurnRate * 100).toFixed(1) + '%';
            document.getElementById('insightsRetention').textContent = customerLifespan.toFixed(1) + ' mo';
            
            // Secondary metrics
            document.getElementById('insightsTotalClients').textContent = totalClients.toLocaleString();
            document.getElementById('insightsActiveClients').textContent = activeClients.length.toLocaleString();
            document.getElementById('insightsAvgTenure').textContent = avgRetentionMonths.toFixed(1) + ' mo';
            document.getElementById('insightsTotalRevenue').textContent = '$' + formatNumber(totalLifetimeRevenue);
            
            // Sensitivity display
            document.getElementById('ltvWorst').textContent = '$' + formatNumber(ltvWorstCase);
            document.getElementById('ltvBase').textContent = '$' + formatNumber(investorLTV);
            document.getElementById('ltvBest').textContent = '$' + formatNumber(ltvBestCase);
            
            // Assumptions panel
            document.getElementById('ltvAssumptions').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <div>‚Ä¢ <strong>ARPU:</strong> $${formatNumber(monthlyARPU)}/month</div>
                    <div>‚Ä¢ <strong>Gross Margin:</strong> ${(grossMargin * 100).toFixed(0)}%</div>
                    <div>‚Ä¢ <strong>Monthly Churn:</strong> ${(cappedChurnRate * 100).toFixed(1)}%</div>
                    <div>‚Ä¢ <strong>Customer Lifespan:</strong> ${customerLifespan.toFixed(1)} months</div>
                    <div>‚Ä¢ <strong>Active Clients:</strong> ${activeClients.length} of ${totalClients}</div>
                    <div>‚Ä¢ <strong>Avg Actual Tenure:</strong> ${avgRetentionMonths.toFixed(1)} months</div>
                </div>
            `;
            
            // Investor-ready summary line
            document.getElementById('ltvSummaryLine').innerHTML = `
                <strong>LTV: $${formatNumber(investorLTV)}</strong> &nbsp;|&nbsp; 
                Assumptions: ARPU $${formatNumber(monthlyARPU)}, Gross Margin ${(grossMargin * 100).toFixed(0)}%, Churn ${(cappedChurnRate * 100).toFixed(1)}% monthly
                <span style="color: #666; font-weight: 400; margin-left: 10px;">(Based on ${totalClients} clients, ${activeClients.length} active)</span>
            `;
            
            // Calculate journey metrics (for clients with 3+ months tenure)
            const journeyMatureClients = allClientsLTV.filter(c => c.tenureMonths >= 3);
            const avgFirstMonth = journeyMatureClients.length > 0 
                ? journeyMatureClients.reduce((sum, c) => sum + (c.firstMonthHours / 4), 0) / journeyMatureClients.length 
                : 0;
            const avgThirdMonth = journeyMatureClients.filter(c => c.thirdMonthHours).length > 0 
                ? journeyMatureClients.filter(c => c.thirdMonthHours).reduce((sum, c) => sum + (c.thirdMonthHours / 4), 0) / journeyMatureClients.filter(c => c.thirdMonthHours).length 
                : 0;
            const sixMonthClients = allClientsLTV.filter(c => c.tenureMonths >= 6 && c.sixthMonthHours);
            const avgSixthMonth = sixMonthClients.length > 0 
                ? sixMonthClients.reduce((sum, c) => sum + (c.sixthMonthHours / 4), 0) / sixMonthClients.length 
                : 0;
            const avgPeakWeekly = allClientsLTV.length > 0 
                ? allClientsLTV.reduce((sum, c) => sum + c.peakWeeklyHours, 0) / allClientsLTV.length 
                : 0;
            
            document.getElementById('insightsFirstMonthHours').textContent = avgFirstMonth.toFixed(1);
            document.getElementById('insightsThirdMonthHours').textContent = avgThirdMonth.toFixed(1);
            document.getElementById('insightsSixthMonthHours').textContent = avgSixthMonth.toFixed(1);
            document.getElementById('insightsPeakHours').textContent = avgPeakWeekly.toFixed(1);
            
            // Calculate progression rate (clients who increased hours from 1st to 3rd month)
            const progressedClients = journeyMatureClients.filter(c => c.thirdMonthHours && c.thirdMonthHours > c.firstMonthHours);
            const progressionRate = journeyMatureClients.length > 0 
                ? (progressedClients.length / journeyMatureClients.length * 100) 
                : 0;
            document.getElementById('insightsProgressionRate').textContent = progressionRate.toFixed(0) + '%';
            
            // Calculate avg time to peak
            const avgTimeToPeak = allClientsLTV.filter(c => c.monthsSincePeak !== undefined).length > 0
                ? allClientsLTV.reduce((sum, c) => sum + (c.tenureMonths - (c.monthsSincePeak || 0)), 0) / allClientsLTV.length
                : 0;
            document.getElementById('insightsTimeToPeak').textContent = avgTimeToPeak.toFixed(1);
            
            // End of care analysis
            const HIGH_CARE_THRESHOLD = 30; // hours per week
            const highCareClients = allClientsLTV.filter(c => c.peakWeeklyHours >= HIGH_CARE_THRESHOLD);
            const highCareActive = highCareClients.filter(c => c.isActive);
            const highCareEnded = highCareClients.filter(c => !c.isActive);
            const avgTimeAfterPeak = highCareEnded.length > 0 
                ? highCareEnded.reduce((sum, c) => sum + c.monthsSincePeak, 0) / highCareEnded.length 
                : 0;
            
            document.getElementById('insightsHighCareCount').textContent = highCareClients.length;
            document.getElementById('insightsHighCareActive').textContent = highCareActive.length;
            document.getElementById('insightsTimeAfterPeak').textContent = avgTimeAfterPeak.toFixed(1);
            
            // Render top clients tables
            renderInsightsTopClients();
            
            // Render transition risk table
            renderTransitionRiskTable(highCareActive, avgTimeAfterPeak);
            
            // Render LTV table
            renderLTVTable();
            
            // Render New Clients Per Week chart
            loadNewClientsChart(allData);
        }
        
        // Recalculate LTV when gross margin changes
        function recalculateLTV() {
            if (!window.ltvData) return;
            
            const grossMargin = (parseFloat(document.getElementById('ltvGrossMargin')?.value) || 70) / 100;
            const { arpu, churnRate, lifespan, totalClients, activeClients, avgRetention, totalRevenue } = window.ltvData;
            
            // Recalculate customer lifespan based on churn
            const customerLifespan = 1 / churnRate;
            
            // LTV = ARPU √ó Gross Margin √ó Customer Lifespan
            const investorLTV = arpu * grossMargin * customerLifespan;
            
            // Sensitivity
            const ltvWorstCase = arpu * grossMargin * (1 / (churnRate * 1.5));
            const ltvBestCase = arpu * grossMargin * (1 / (churnRate * 0.75));
            
            // Update displays
            document.getElementById('insightsLTV').textContent = '$' + formatNumber(investorLTV);
            document.getElementById('ltvWorst').textContent = '$' + formatNumber(ltvWorstCase);
            document.getElementById('ltvBase').textContent = '$' + formatNumber(investorLTV);
            document.getElementById('ltvBest').textContent = '$' + formatNumber(ltvBestCase);
            
            // Update assumptions
            document.getElementById('ltvAssumptions').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <div>‚Ä¢ <strong>ARPU:</strong> $${formatNumber(arpu)}/month</div>
                    <div>‚Ä¢ <strong>Gross Margin:</strong> ${(grossMargin * 100).toFixed(0)}%</div>
                    <div>‚Ä¢ <strong>Monthly Churn:</strong> ${(churnRate * 100).toFixed(1)}%</div>
                    <div>‚Ä¢ <strong>Customer Lifespan:</strong> ${customerLifespan.toFixed(1)} months</div>
                    <div>‚Ä¢ <strong>Active Clients:</strong> ${activeClients} of ${totalClients}</div>
                    <div>‚Ä¢ <strong>Avg Actual Tenure:</strong> ${avgRetention.toFixed(1)} months</div>
                </div>
            `;
            
            // Update summary line
            document.getElementById('ltvSummaryLine').innerHTML = `
                <strong>LTV: $${formatNumber(investorLTV)}</strong> &nbsp;|&nbsp; 
                Assumptions: ARPU $${formatNumber(arpu)}, Gross Margin ${(grossMargin * 100).toFixed(0)}%, Churn ${(churnRate * 100).toFixed(1)}% monthly
                <span style="color: #666; font-weight: 400; margin-left: 10px;">(Based on ${totalClients} clients, ${activeClients} active)</span>
            `;
        }
        
        function renderInsightsTopClients() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentWeek = getWeekNumber(now);
            const currentMonth = now.getMonth() + 1;
            
            // Calculate last week (previous completed week)
            const lastWeekDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const lastWeek = getWeekNumber(lastWeekDate);
            const lastWeekYear = lastWeekDate.getFullYear();
            
            // Calculate last month (previous completed month)
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonth = lastMonthDate.getMonth() + 1;
            const lastMonthYear = lastMonthDate.getFullYear();
            const lastMonthName = lastMonthDate.toLocaleString('default', { month: 'long' });
            
            const yearData = dashboardDataCache[currentYear] || [];
            // Also check previous year data if we're at the beginning of the year
            const prevYearData = currentYear !== lastWeekYear ? (dashboardDataCache[lastWeekYear] || []) : [];
            // Also get last month's year data if different
            const lastMonthYearData = lastMonthYear !== currentYear && lastMonthYear !== lastWeekYear ? (dashboardDataCache[lastMonthYear] || []) : [];
            const allYearData = [...yearData, ...prevYearData, ...lastMonthYearData];
            
            // Calculate weekly and monthly client stats
            const weeklyClients = {};
            const monthlyClients = {};
            
            allYearData.forEach(r => {
                const clientName = r['Customer Name'];  // Fixed field name
                if (!clientName || clientName === 'Unknown') return;
                
                const serviceDate = new Date(r['Scheduled Date']);
                const week = getWeekNumber(serviceDate);
                const month = serviceDate.getMonth() + 1;
                const year = serviceDate.getFullYear();
                
                const revenue = parseFloat(r['Cost To Customer']) || 0;  // Fixed field name
                const hours = (parseFloat(r['Service Duration']) || 0) / 60;
                
                // Last week (not current week - we want completed week data)
                if (year === lastWeekYear && week === lastWeek) {
                    if (!weeklyClients[clientName]) {
                        weeklyClients[clientName] = { name: clientName, services: 0, hours: 0, revenue: 0 };
                    }
                    weeklyClients[clientName].services++;
                    weeklyClients[clientName].hours += hours;
                    weeklyClients[clientName].revenue += revenue;
                }
                
                // Last month (not current month - we want completed month data)
                if (year === lastMonthYear && month === lastMonth) {
                    if (!monthlyClients[clientName]) {
                        monthlyClients[clientName] = { name: clientName, services: 0, hours: 0, revenue: 0 };
                    }
                    monthlyClients[clientName].services++;
                    monthlyClients[clientName].hours += hours;
                    monthlyClients[clientName].revenue += revenue;
                }
            });
            
            const weekLimit = parseInt(document.getElementById('insightsWeekLimit')?.value || 5);
            const monthLimit = parseInt(document.getElementById('insightsMonthLimit')?.value || 5);
            
            const topWeekly = Object.values(weeklyClients).sort((a, b) => b.revenue - a.revenue).slice(0, weekLimit);
            const topMonthly = Object.values(monthlyClients).sort((a, b) => b.revenue - a.revenue).slice(0, monthLimit);
            
            // Update the week header to show week number
            const weekHeader = document.querySelector('#insightsTopClientsWeek')?.closest('.div')?.querySelector('h3') 
                || document.querySelector('h3:has(+ table #insightsTopClientsWeek)');
            const weekTitleEl = document.getElementById('insightsWeekTitle');
            if (weekTitleEl) {
                weekTitleEl.textContent = `üèÜ Top Clients Last Week (Week ${lastWeek})`;
            }
            
            // Update the month header to show month name
            const monthLabelEl = document.getElementById('insightsMonthLabel');
            if (monthLabelEl) {
                monthLabelEl.textContent = `(${lastMonthName})`;
            }
            
            // Render weekly
            const weekContainer = document.getElementById('insightsTopClientsWeek');
            if (topWeekly.length === 0) {
                weekContainer.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">No data for Week ${lastWeek}</td></tr>`;
            } else {
                weekContainer.innerHTML = topWeekly.map((c, i) => `
                    <tr>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3;">
                            <span style="background: ${i < 3 ? '#1A365C' : '#E5ECF3'}; color: ${i < 3 ? 'white' : '#666'}; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">${i + 1}</span>
                        </td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; font-weight: 500; font-size: 13px;">${escapeHtml(c.name)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${c.services}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-size: 13px;">${c.hours.toFixed(1)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #62B790; font-size: 13px;">$${formatNumber(c.revenue)}</td>
                    </tr>
                `).join('');
            }
            
            // Render monthly
            const monthContainer = document.getElementById('insightsTopClientsMonth');
            if (topMonthly.length === 0) {
                monthContainer.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">No data for ${lastMonthName}</td></tr>`;
            } else {
                monthContainer.innerHTML = topMonthly.map((c, i) => `
                    <tr>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3;">
                            <span style="background: ${i < 3 ? '#1A365C' : '#E5ECF3'}; color: ${i < 3 ? 'white' : '#666'}; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">${i + 1}</span>
                        </td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; font-weight: 500; font-size: 13px;">${escapeHtml(c.name)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${c.services}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-size: 13px;">${c.hours.toFixed(1)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #62B790; font-size: 13px;">$${formatNumber(c.revenue)}</td>
                    </tr>
                `).join('');
            }
        }
        
        function renderTransitionRiskTable(highCareActive, avgTimeAfterPeak) {
            const container = document.getElementById('insightsTransitionRisk');
            
            // Clients with 25+ hrs/week who might be approaching transition
            const atRiskClients = highCareActive
                .filter(c => c.currentWeeklyHours >= 25)
                .sort((a, b) => b.currentWeeklyHours - a.currentWeeklyHours)
                .slice(0, 10);
            
            if (atRiskClients.length === 0) {
                container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #059669; padding: 20px;">‚úì No clients currently in high-care transition zone</td></tr>';
                return;
            }
            
            container.innerHTML = atRiskClients.map(c => {
                // Estimate transition window based on historical avg
                const estimatedMonthsLeft = Math.max(0, avgTimeAfterPeak - c.monthsSincePeak).toFixed(0);
                const urgency = estimatedMonthsLeft <= 2 ? '#DC2626' : (estimatedMonthsLeft <= 4 ? '#D97706' : '#666');
                
                return `
                    <tr>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #FDE68A; font-weight: 500;">${escapeHtml(c.name)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #FDE68A; text-align: center; font-weight: 600; color: #DC2626;">${c.currentWeeklyHours.toFixed(1)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #FDE68A; text-align: center;">${c.peakWeeklyHours.toFixed(1)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #FDE68A; text-align: center;">${c.tenureMonths} mo</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #FDE68A; text-align: center; font-weight: 600; color: ${urgency};">${estimatedMonthsLeft} mo</td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderLTVTable() {
            const container = document.getElementById('insightsLTVTable');
            const limit = document.getElementById('insightsLTVLimit')?.value || '10';
            const searchTerm = (document.getElementById('insightsLTVSearch')?.value || '').toLowerCase().trim();
            
            let filteredData = [...allClientsLTV];
            
            if (searchTerm) {
                // Search in displayName and all variants
                filteredData = filteredData.filter(c => {
                    if (c.displayName?.toLowerCase().includes(searchTerm)) return true;
                    if (c.name?.toLowerCase().includes(searchTerm)) return true;
                    if (c.variants && c.variants.some(v => v.toLowerCase().includes(searchTerm))) return true;
                    return false;
                });
            }
            
            const displayData = limit === 'all' ? filteredData : filteredData.slice(0, parseInt(limit));
            
            if (displayData.length === 0) {
                container.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999; padding: 20px;">No clients found</td></tr>';
                return;
            }
            
            container.innerHTML = displayData.map((c, i) => {
                const statusBadge = c.isActive 
                    ? '<span style="background: #D1FAE5; color: #065F46; padding: 2px 8px; border-radius: 12px; font-size: 11px;">Active</span>'
                    : `<span style="background: #FEE2E2; color: #991B1B; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${c.daysSinceLastService}d ago</span>`;
                
                // Show variant badge if multiple name variants were merged
                const displayName = c.displayName || c.name;
                const variantBadge = c.variantCount > 1 
                    ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px; cursor: help;" title="Merged from ${c.variantCount} name variations: ${c.variants.join(', ')}">+${c.variantCount - 1}</span>` 
                    : '';
                
                return `
                    <tr>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3;">
                            <span style="background: ${i < 3 ? '#F57600' : '#E5ECF3'}; color: ${i < 3 ? 'white' : '#666'}; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">${i + 1}</span>
                        </td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; font-weight: 500;">${escapeHtml(displayName)}${variantBadge}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 700; color: #1A365C;">$${formatNumber(c.totalRevenue)}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${c.totalServices.toLocaleString()}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${c.totalHours.toFixed(1)}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${c.tenureMonths} mo</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${statusBadge}</td>
                        <td style="padding: 8px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 12px; color: #666;">${c.lastServiceDate.toLocaleDateString()}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterLTVTable() {
            renderLTVTable();
        }
        
        // ============================================
        // GLOBAL SEARCH
        // ============================================
        document.getElementById('globalSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    switchTab('dashboard');
                    document.getElementById('quickLookupInput').value = query;
                    quickClientLookup();
                }
            }
        });
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return num.toLocaleString(undefined, { maximumFractionDigits: decimals });
        }
        
        function getStatusClass(status) {
            if (!status) return 'badge-pending';
            const s = status.toUpperCase();
            if (s === 'COMPLETED') return 'badge-completed';
            if (s === 'ASSIGNED') return 'badge-assigned';
            if (s === 'UNASSIGNED') return 'badge-unassigned';
            if (s.includes('CANCELLED')) return 'badge-cancelled';
            return 'badge-pending';
        }
        
        function getPaymentClass(status) {
            if (!status) return 'badge-pending';
            const s = status.toUpperCase();
            if (s === 'PAID' || s === 'PAID_BY_CC') return 'badge-paid';
            return 'badge-pending';
        }
        
        function formatStatus(status) {
            if (!status) return 'Pending';
            return status.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '--';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }
        
        function formatTime(timeVal) {
            if (!timeVal && timeVal !== 0) return '--';
            // If it's a decimal time (e.g., 0.29166 for 7:00 AM)
            if (typeof timeVal === 'number' && timeVal < 1) {
                const totalMinutes = Math.round(timeVal * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }
            // If it's already a string time
            if (typeof timeVal === 'string') {
                return timeVal;
            }
            return String(timeVal);
        }
        
        function getSubscriptionBadge(sub) {
            if (!sub || sub.toLowerCase() === 'none') {
                return '<span class="badge badge-none">None</span>';
            }
            const subLower = sub.toLowerCase();
            let badges = [];
            if (subLower.includes('weekly')) badges.push('<span class="badge badge-weekly">W</span>');
            if (subLower.includes('monthly')) badges.push('<span class="badge badge-monthly">M</span>');
            if (subLower.includes('yearly')) badges.push('<span class="badge badge-yearly">Y</span>');
            return badges.length > 0 ? badges.join(' ') : '<span class="badge badge-none">None</span>';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        function renderPagination(containerId, totalPages, current, onPageChange) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<button ${current === 1 ? 'disabled' : ''}>¬´ Prev</button>`;
            
            const maxPages = 5;
            let startPage = Math.max(1, current - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === current ? 'active' : ''}">${i}</button>`;
            }
            
            html += `<button ${current === totalPages ? 'disabled' : ''}>Next ¬ª</button>`;
            html += `<span class="page-info">Page ${current} of ${totalPages}</span>`;
            
            container.innerHTML = html;
            
            container.querySelectorAll('button').forEach((btn, idx) => {
                btn.addEventListener('click', () => {
                    if (idx === 0 && current > 1) {
                        onPageChange(current - 1);
                    } else if (idx === container.querySelectorAll('button').length - 1 && current < totalPages) {
                        onPageChange(current + 1);
                    } else {
                        const pageNum = parseInt(btn.textContent);
                        if (!isNaN(pageNum)) {
                            onPageChange(pageNum);
                        }
                    }
                });
            });
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Loading Spinner Functions
        function showLoading(text = 'Loading...', subtext = 'Please wait') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        function updateLoadingText(text, subtext) {
            if (text) document.getElementById('loadingText').textContent = text;
            if (subtext) document.getElementById('loadingSubtext').textContent = subtext;
        }
        
        function exportReport() {
            if (reportData.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            // Export headers
            const exportHeaders = ['Customer Name', 'Date', 'Start Time', 'End Time', 'Provider', 'Duration HRS', '$/Hr', 'Total $'];
            
            let csv = exportHeaders.join(',') + '\n';
            
            reportData.forEach(row => {
                const duration = parseFloat(row['Service Duration']) || 0;
                const durationHrs = (duration / 60).toFixed(2);
                const costToCustomer = parseFloat(row['Cost To Customer']) || 0;
                const ratePerHour = durationHrs > 0 ? (costToCustomer / durationHrs).toFixed(2) : '0.00';
                
                const values = [
                    row['Customer Name'] || '',
                    row['Scheduled Date'] || '',
                    row['STxTime'] || '',
                    row['ETxTime'] || '',
                    row['Provider Name'] || '',
                    durationHrs,
                    ratePerHour,
                    costToCustomer.toFixed(2)
                ].map(val => {
                    val = String(val).replace(/"/g, '""');
                    return `"${val}"`;
                });
                
                csv += values.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `service_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Report exported successfully', 'success');
        }
        
        // ============================================
        // CSV UPLOAD FUNCTIONS
        // ============================================
        let selectedFile = null;
        let csvContent = '';
        
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
        }
        
        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            clearFileSelection();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                showToast('Please select a CSV file', 'error');
                return;
            }
            
            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                csvContent = e.target.result;
                
                // Parse to get stats
                const lines = csvContent.split('\n').filter(line => line.trim());
                const headers = lines[0] ? lines[0].split(',').length : 0;
                
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('rowCount').textContent = lines.length - 1; // Exclude header
                document.getElementById('colCount').textContent = headers;
                
                document.getElementById('uploadArea').querySelector('.upload-dropzone').style.display = 'none';
                document.getElementById('filePreview').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false;
            };
            reader.readAsText(file);
        }
        
        function clearFileSelection() {
            selectedFile = null;
            csvContent = '';
            document.getElementById('csvFileInput').value = '';
            document.getElementById('uploadArea').querySelector('.upload-dropzone').style.display = 'block';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function uploadCSVFile() {
            if (!csvContent) {
                showToast('No file selected', 'error');
                return;
            }
            
            const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
            const uploadBtn = document.getElementById('uploadBtn');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Uploading...';
            
            // Show loading overlay
            const rowCount = (csvContent.match(/\n/g) || []).length;
            showLoading('Uploading Data', `Processing ${rowCount.toLocaleString()} rows (${uploadMode} mode)...`);
            
            try {
                updateLoadingText('Uploading Data', 'Sending data to server...');
                
                // Create form data for POST
                const formData = new FormData();
                formData.append('action', 'uploadCSV');
                formData.append('csvData', csvContent);
                formData.append('mode', uploadMode);
                
                // Use fetch with POST
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'uploadCSV',
                        csvData: csvContent,
                        mode: uploadMode
                    })
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showToast(`Successfully uploaded ${result.rowsAdded} rows!`, 'success');
                    closeUploadModal();
                    // Reload the report data
                    currentPage = 1;
                    loadReportData();
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                // Try JSONP fallback for CORS issues
                try {
                    updateLoadingText('Uploading Data', 'Retrying with alternate method...');
                    const result = await uploadViaJSONP(csvContent, uploadMode);
                    hideLoading();
                    if (result.success) {
                        showToast(`Successfully uploaded ${result.rowsAdded} rows!`, 'success');
                        closeUploadModal();
                        currentPage = 1;
                        loadReportData();
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (jsonpError) {
                    hideLoading();
                    showToast('Upload failed: ' + jsonpError.message, 'error');
                }
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload
                `;
            }
        }
        
        function uploadViaJSONP(csvData, mode) {
            return new Promise((resolve, reject) => {
                const callbackName = 'upload_callback_' + Math.round(100000 * Math.random());
                
                // For large CSV, we need to chunk or encode it
                const encodedCSV = encodeURIComponent(csvData);
                
                // Check if data is too large for URL
                if (encodedCSV.length > 8000) {
                    reject(new Error('CSV file too large for this upload method. Please use a smaller file or contact support.'));
                    return;
                }
                
                const script = document.createElement('script');
                const url = `${WEBAPP_URL}?action=uploadCSV&csvData=${encodedCSV}&mode=${mode}&callback=${callbackName}`;
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Upload request failed'));
                };
                
                script.src = url;
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        reject(new Error('Upload timeout'));
                    }
                }, 60000);
            });
        }
        
        // Drag and drop support
        document.addEventListener('DOMContentLoaded', function() {
            const dropzone = document.querySelector('.upload-dropzone');
            if (dropzone) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'), false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'), false);
                });
                
                dropzone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        processFile(files[0]);
                    }
                }, false);
            }
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            if (WEBAPP_URL === 'YOUR_WEBAPP_URL_HERE') {
                document.getElementById('reportTableContainer').innerHTML = `
                    <div class="notice-box">
                        <h3>‚ö†Ô∏è Configuration Required</h3>
                        <p>Please update the <code style="background: #1A365C; color: white; padding: 2px 6px; border-radius: 4px;">WEBAPP_URL</code> in the JavaScript section with your deployed Google Apps Script Web App URL.</p>
                               </div>
                `;
                return;
            }
            
            // Initialize tabs - use the switchTab function
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });
            
            // Try loading data in this order:
            // 1. Google Sheets cache (shared across all users) - fastest for everyone
            // 2. LocalStorage cache (individual user) - fast offline fallback
            // 3. Fresh fetch from source - slowest but always up-to-date
            
            const currentYear = new Date().getFullYear();
            let cacheSource = null;
            let cacheAge = null;
            
            // First try Google Sheets cache (shared)
            try {
                showLoading('Loading Dashboard', 'Checking shared cache...');
                const gsCache = await loadFromGoogleSheetsCache(currentYear);
                
                if (gsCache.success && gsCache.isFresh) {
                    dashboardDataCache[currentYear] = gsCache.data;
                    cacheSource = 'shared';
                    cacheAge = gsCache.cacheAgeHours;
                    console.log('Loaded from Google Sheets cache');
                }
            } catch (e) {
                console.warn('Google Sheets cache check failed:', e);
            }
            
            // If no shared cache, try localStorage
            if (!cacheSource) {
                const localCache = initializeCacheFromStorage();
                if (localCache.loaded && localCache.isFresh) {
                    cacheSource = 'local';
                    cacheAge = localCache.ageHours;
                    availableYears = localCache.years.sort((a, b) => b - a);
                    console.log('Loaded from localStorage cache');
                }
            }
            
            // Set up year selectors
            if (availableYears.length === 0) {
                availableYears = [currentYear];
            }
            updateYearSelectors();
            
            hideLoading();
            
            // Switch to dashboard (will use cached data if available)
            if (cacheSource) {
                initialDataLoaded = true;
                switchTab('dashboard');
                
                setTimeout(() => {
                    const sourceLabel = cacheSource === 'shared' ? 'shared cache' : 'local cache';
                    showToast(`Using ${sourceLabel} (${cacheAge.toFixed(1)} hours old). Click Refresh to update.`, 'info');
                }, 500);
            } else {
                // No cache - fetch fresh data
                console.log('No cache available, fetching fresh data');
                switchTab('dashboard');
            }
            
            // Global search handler
            const globalSearchInput = document.getElementById('globalSearch');
            if (globalSearchInput) {
                globalSearchInput.placeholder = 'Press Enter to open Client Insights';

                globalSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        switchTab('clientInsights');
                    }
                });
            }
        });
        
        // Update all year selector dropdowns
        function updateYearSelectors() {
            const currentYear = new Date().getFullYear();
            const yearsHtml = availableYears.map(y => 
                `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
            ).join('');
            
            const dashboardYearSelect = document.getElementById('dashboardYear');
            const insightsYearSelect = document.getElementById('insightsYearSelect');
            const providerYearSelect = document.getElementById('providerInsightsYearSelect');
            
            if (dashboardYearSelect) dashboardYearSelect.innerHTML = yearsHtml;
            if (insightsYearSelect) insightsYearSelect.innerHTML = yearsHtml;
            if (providerYearSelect) providerYearSelect.innerHTML = yearsHtml;
        }
        
        // ============================================
        // LTC IMPORT FUNCTIONS
        // ============================================
        
        async function showLTCImportModal() {
            document.getElementById('ltcImportModal').classList.add('active');
            document.getElementById('ltcLoadingState').style.display = 'block';
            document.getElementById('ltcRecordsList').style.display = 'none';
            document.getElementById('ltcNoRecords').style.display = 'none';
            document.getElementById('ltcError').style.display = 'none';
            
            try {
                const result = await jsonpFetch({ action: 'getLTCIntakeRecords' });
                
                if (result.success) {
                    ltcRecords = result.records || [];
                    
                    if (ltcRecords.length === 0) {
                        document.getElementById('ltcLoadingState').style.display = 'none';
                        document.getElementById('ltcNoRecords').style.display = 'block';
                    } else {
                        document.getElementById('ltcLoadingState').style.display = 'none';
                        document.getElementById('ltcRecordsList').style.display = 'block';
                        renderLTCRecords(ltcRecords);
                    }
                } else {
                    throw new Error(result.error || 'Failed to load records');
                }
            } catch (error) {
                document.getElementById('ltcLoadingState').style.display = 'none';
                document.getElementById('ltcError').style.display = 'block';
                document.getElementById('ltcErrorMessage').textContent = error.message;
            }
        }
        
        function closeLTCImportModal() {
            document.getElementById('ltcImportModal').classList.remove('active');
        }
        
        function filterLTCRecords() {
            const query = document.getElementById('ltcSearchInput').value.toLowerCase().trim();
            
            if (!query) {
                renderLTCRecords(ltcRecords);
                return;
            }
            
            const filtered = ltcRecords.filter(record => {
                const name = (record.insuredName || '').toLowerCase();
                const email = (record.email || '').toLowerCase();
                const insurance = (record.insurance || '').toLowerCase();
                const phone = (record.phone || '').toLowerCase();
                
                return name.includes(query) || email.includes(query) || 
                       insurance.includes(query) || phone.includes(query);
            });
            
            renderLTCRecords(filtered);
        }
        
        function renderLTCRecords(records) {
            const container = document.getElementById('ltcRecordsTable');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No matching records found.</p>';
                return;
            }
            
            const html = `
                <table class="data-table" style="font-size: 12px;">
                    <thead>
                        <tr>
                            <th>ReqN</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Insurance</th>
                            <th>Policy</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr>
                                <td>${record.reqN || '--'}</td>
                                <td><strong>${escapeHtml(record.insuredName || '--')}</strong></td>
                                <td>${escapeHtml(record.email || '--')}</td>
                                <td>${escapeHtml(record.phone || '--')}</td>
                                <td>${escapeHtml(record.insurance || '--')}</td>
                                <td>${escapeHtml(record.policy || '--')}</td>
                                <td>${record.startServiceDate || '--'}</td>
                                <td>
                                    <button class="btn btn-small" onclick="selectLTCRecord(${record.rowIndex})" style="padding: 6px 12px; font-size: 11px;">
                                        Select
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function selectLTCRecord(rowIndex) {
            selectedLTCRecord = ltcRecords.find(r => r.rowIndex === rowIndex);
            
            if (!selectedLTCRecord) {
                showToast('Record not found', 'error');
                return;
            }
            
            // Show confirmation modal
            const content = document.getElementById('ltcConfirmContent');
            content.innerHTML = `
                <div style="background: #F9FAFB; border-radius: 8px; padding: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #1A365C;">Client Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Name</label>
                            <p style="margin: 5px 0; font-weight: 600;">${escapeHtml(selectedLTCRecord.insuredName || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Email</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.email || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Phone</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.phone || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Address</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.address || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Insurance</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.insurance || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Policy / Claim</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.policy || '--')} / ${escapeHtml(selectedLTCRecord.claim || '--')}</p>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: #1A365C;">ADL Services</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${renderADLServices(selectedLTCRecord.adlServices)}
                    </div>
                    ${selectedLTCRecord.adlServices ? '' : '<p style="color: #999; font-size: 12px; margin-top: 5px;">No ADL services specified</p>'}
                </div>
            `;
            
            // Reset duplicate warning
            document.getElementById('ltcDuplicateWarning').style.display = 'none';
            document.getElementById('ltcConfirmBtn').style.display = 'inline-flex';
            document.getElementById('ltcForceImportBtn').style.display = 'none';
            
            // Show confirm modal
            document.getElementById('ltcConfirmModal').classList.add('active');
        }
        
        // Helper function to render ADL service codes as badges
        function renderADLServices(adlServicesStr) {
            if (!adlServicesStr) return '';
            
            const codeLabels = {
                'BA': 'Bathing',
                'DR': 'Dressing',
                'TR': 'Transferring',
                'CO': 'Continence',
                'TO': 'Toileting',
                'EA': 'Eating',
                'AM': 'Ambulation',
                'CS': 'Cognitive Supervision',
                'HM': 'Homemaker'
            };
            
            const codes = adlServicesStr.toUpperCase().split(',').map(s => s.trim()).filter(s => s);
            
            return codes.map(code => {
                const label = codeLabels[code] || code;
                return `<span style="background: #E8F5E9; color: #2E7D32; padding: 4px 10px; border-radius: 4px; font-size: 12px;">${code} - ${label}</span>`;
            }).join('');
        }
        
        function closeLTCConfirmModal() {
            document.getElementById('ltcConfirmModal').classList.remove('active');
            selectedLTCRecord = null;
        }
        
        async function confirmLTCImport() {
            if (!selectedLTCRecord) {
                showToast('No record selected', 'error');
                return;
            }
            
            const btn = document.getElementById('ltcConfirmBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Importing...';
            
            try {
                const result = await jsonpFetch({
                    action: 'importFromLTC',
                    ...selectedLTCRecord
                });
                
                if (result.success) {
                    showToast('Client imported successfully!', 'success');
                    closeLTCConfirmModal();
                    closeLTCImportModal();
                    // Reload client data
                    await loadClientData();
                } else if (result.duplicates && result.duplicates.length > 0) {
                    // Show duplicate warning
                    const duplicateHtml = result.duplicates.map(dup => `
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 8px;">
                            <strong>${escapeHtml(dup.customerName)}</strong>
                            <div style="font-size: 12px; color: #666;">
                                ${dup.email ? 'Email: ' + escapeHtml(dup.email) : ''}
                                ${dup.phone ? ' | Phone: ' + escapeHtml(dup.phone) : ''}
                            </div>
                            <div style="font-size: 11px; color: #F57600; margin-top: 4px;">
                                Match: ${dup.matchType.replace('_', ' ')} (${dup.matchScore}%)
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('ltcDuplicateDetails').innerHTML = duplicateHtml;
                    document.getElementById('ltcDuplicateWarning').style.display = 'block';
                    document.getElementById('ltcConfirmBtn').style.display = 'none';
                    document.getElementById('ltcForceImportBtn').style.display = 'inline-flex';
                    
                    showToast('Potential duplicate found - review and confirm', 'warning');
                } else {
                    showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Import Client
            `;
        }
        
        async function forceImportLTC() {
            if (!selectedLTCRecord) {
                showToast('No record selected', 'error');
                return;
            }
            
            const btn = document.getElementById('ltcForceImportBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Importing...';
            
            try {
                const result = await jsonpFetch({
                    action: 'forceImportFromLTC',
                    ...selectedLTCRecord
                });
                
                if (result.success) {
                    showToast('Client imported successfully!', 'success');
                    closeLTCConfirmModal();
                    closeLTCImportModal();
                    // Reload client data
                    await loadClientData();
                } else {
                    showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Import Anyway';
        }
        
        // ============================================
        // PROVIDER INSIGHTS FUNCTIONS
        // ============================================
        
        let providerInsightsData = null;
        let piTrendsChart = null;
        
        async function loadProviderInsights(forceRefresh = false) {
            const loadingEl = document.getElementById('providerInsightsLoading');
            const contentEl = document.getElementById('providerInsightsContent');
            const yearSelect = document.getElementById('providerInsightsYearSelect');
            
            // Initialize year selector if needed
            if (yearSelect.options.length <= 1) {
                if (availableYears.length === 0) {
                    await loadAvailableYears();
                }
                yearSelect.innerHTML = availableYears.map(y => 
                    `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`
                ).join('');
            }
            
            const selectedYear = parseInt(yearSelect.value) || new Date().getFullYear();
            const prevYear = selectedYear - 1;
            
            // Check if we need to fetch data
            const needsFetch = forceRefresh || !dashboardDataCache[selectedYear] || !dashboardDataCache[prevYear];
            
            // Only show loading if we need to fetch data
            if (needsFetch) {
                loadingEl.style.display = 'block';
                contentEl.style.display = 'none';
            }
            
            try {
                // Use smart loading with Google Sheets cache
                if (forceRefresh) {
                    // Clear memory cache for these years
                    delete dashboardDataCache[selectedYear];
                    delete dashboardDataCache[prevYear];
                }
                
                // Load data for the selected year (uses Google Sheets cache)
                await loadDashboardDataForYear(selectedYear);
                
                // Also load previous year for comparison
                await loadDashboardDataForYear(prevYear);
                
                // Calculate provider insights
                calculateProviderInsights(selectedYear);
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                
                // Also load on-call utilization data
                loadOncallUtilization(forceRefresh);
                
            } catch (error) {
                console.error('Error loading provider insights:', error);
                loadingEl.innerHTML = '<p style="color: #DC2626;">Error loading data. Please try again.</p>';
            }
        }
        
        function calculateProviderInsights(year) {
            const now = new Date();
            const data = dashboardDataCache[year] || [];
            const prevYearData = dashboardDataCache[year - 1] || [];
            const allData = [...data, ...prevYearData];
            
            // Build provider profiles
            const providers = {};
            
            allData.forEach(r => {
                const name = r['Provider Name'];
                if (!name || name === 'Unassigned' || name === 'Unknown') return;
                
                const serviceDate = new Date(r['Scheduled Date']);
                const hours = (parseFloat(r['Service Duration']) || 0) / 60;
                const revenue = parseFloat(r['Cost To Customer']) || 0;  // Revenue to company
                const month = serviceDate.getMonth() + 1;
                const serviceYear = serviceDate.getFullYear();
                
                if (!providers[name]) {
                    providers[name] = {
                        name,
                        firstService: serviceDate,
                        lastService: serviceDate,
                        totalServices: 0,
                        totalHours: 0,
                        totalRevenue: 0,
                        monthlyData: {}
                    };
                }
                
                const p = providers[name];
                if (serviceDate < p.firstService) p.firstService = serviceDate;
                if (serviceDate > p.lastService) p.lastService = serviceDate;
                p.totalServices++;
                p.totalHours += hours;
                p.totalRevenue += revenue;
                
                // Track monthly data
                const monthKey = `${serviceYear}-${String(month).padStart(2, '0')}`;
                if (!p.monthlyData[monthKey]) {
                    p.monthlyData[monthKey] = { services: 0, hours: 0, revenue: 0 };
                }
                p.monthlyData[monthKey].services++;
                p.monthlyData[monthKey].hours += hours;
                p.monthlyData[monthKey].revenue += revenue;
            });
            
            // Calculate status and metrics for each provider
            const providerList = Object.values(providers).map(p => {
                const daysSinceLastService = Math.floor((now - p.lastService) / (1000 * 60 * 60 * 24));
                const tenureMonths = Math.floor((p.lastService - p.firstService) / (1000 * 60 * 60 * 24 * 30)) + 1;
                const avgHoursPerMonth = p.totalHours / Math.max(tenureMonths, 1);
                
                let status;
                if (daysSinceLastService <= 30) status = 'active';
                else if (daysSinceLastService <= 60) status = 'declining';
                else if (daysSinceLastService <= 90) status = 'at-risk';
                else status = 'inactive';
                
                return {
                    ...p,
                    daysSinceLastService,
                    tenureMonths,
                    avgHoursPerMonth,
                    status
                };
            });
            
            providerInsightsData = providerList;
            
            // Calculate KPIs
            const totalProviders = providerList.length;
            const activeProviders = providerList.filter(p => p.status === 'active').length;
            const decliningProviders = providerList.filter(p => p.status === 'declining').length;
            const atRiskProviders = providerList.filter(p => p.status === 'at-risk').length;
            const inactiveProviders = providerList.filter(p => p.status === 'inactive').length;
            
            // Calculate retention rate (providers who were active last month and still active this month)
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
            const priorMonthDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
            const priorMonthKey = `${priorMonthDate.getFullYear()}-${String(priorMonthDate.getMonth() + 1).padStart(2, '0')}`;
            
            const activePriorMonth = providerList.filter(p => p.monthlyData[priorMonthKey]);
            const retainedToLastMonth = activePriorMonth.filter(p => p.monthlyData[lastMonthKey]);
            const retentionRate = activePriorMonth.length > 0 ? 
                Math.round((retainedToLastMonth.length / activePriorMonth.length) * 100) : 100;
            
            // Average hours per active provider per month
            const activeProviderHours = providerList
                .filter(p => p.status === 'active')
                .reduce((sum, p) => sum + p.avgHoursPerMonth, 0);
            const avgHoursPerProvider = activeProviders > 0 ? 
                (activeProviderHours / activeProviders).toFixed(1) : '0';
            
            // Update KPI displays
            document.getElementById('piTotalProviders').textContent = totalProviders;
            document.getElementById('piActiveProviders').textContent = activeProviders;
            document.getElementById('piAvgHoursPerProvider').textContent = avgHoursPerProvider;
            document.getElementById('piRetentionRate').textContent = retentionRate + '%';
            document.getElementById('piChurnedProviders').textContent = inactiveProviders;
            
            document.getElementById('piStatusActive').textContent = activeProviders;
            document.getElementById('piStatusDeclining').textContent = decliningProviders;
            document.getElementById('piStatusAtRisk').textContent = atRiskProviders;
            document.getElementById('piStatusInactive').textContent = inactiveProviders;
            
            // Render all components
            renderPITenureDistribution(providerList);
            renderPITrendsChart(providerList, year);
            renderPITopPerformers();
            renderPIAtRiskProviders();
            renderPINewProviders();
            renderPIChurnedProviders();
            renderPIAllProviders();
        }
        
        function renderPITenureDistribution(providers) {
            const container = document.getElementById('piTenureDistribution');
            
            const buckets = {
                '0-3 months': 0,
                '3-6 months': 0,
                '6-12 months': 0,
                '1-2 years': 0,
                '2+ years': 0
            };
            
            providers.forEach(p => {
                if (p.tenureMonths <= 3) buckets['0-3 months']++;
                else if (p.tenureMonths <= 6) buckets['3-6 months']++;
                else if (p.tenureMonths <= 12) buckets['6-12 months']++;
                else if (p.tenureMonths <= 24) buckets['1-2 years']++;
                else buckets['2+ years']++;
            });
            
            const maxCount = Math.max(...Object.values(buckets), 1);
            const colors = ['#93C5FD', '#60A5FA', '#3B82F6', '#2563EB', '#1D4ED8'];
            
            container.innerHTML = Object.entries(buckets).map(([label, count], i) => {
                const pct = (count / maxCount) * 100;
                return `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 80px; font-size: 12px; color: #666;">${label}</div>
                        <div style="flex: 1; background: #E5ECF3; border-radius: 4px; height: 24px; overflow: hidden;">
                            <div style="width: ${pct}%; height: 100%; background: ${colors[i]}; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;">
                                <span style="color: white; font-size: 11px; font-weight: 600;">${count}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderPITrendsChart(providers, year) {
            const ctx = document.getElementById('piTrendsChart').getContext('2d');
            
            if (piTrendsChart) {
                piTrendsChart.destroy();
            }
            
            // Get last 12 months of data
            const months = [];
            const now = new Date();
            for (let i = 11; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    key: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: d.toLocaleString('default', { month: 'short', year: '2-digit' })
                });
            }
            
            // Calculate monthly stats
            const monthlyStats = months.map(m => {
                let activeCount = 0;
                let totalHours = 0;
                providers.forEach(p => {
                    if (p.monthlyData[m.key]) {
                        activeCount++;
                        totalHours += p.monthlyData[m.key].hours;
                    }
                });
                return { activeCount, totalHours };
            });
            
            piTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(m => m.label),
                    datasets: [
                        {
                            label: 'Active Providers',
                            data: monthlyStats.map(s => s.activeCount),
                            borderColor: '#1A365C',
                            backgroundColor: 'rgba(26, 54, 92, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Total Hours',
                            data: monthlyStats.map(s => s.totalHours.toFixed(1)),
                            borderColor: '#F57600',
                            backgroundColor: 'rgba(245, 118, 0, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Active Providers' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Total Hours' },
                            grid: { drawOnChartArea: false },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderPITopPerformers() {
            if (!providerInsightsData) return;
            
            const container = document.getElementById('piTopPerformers');
            const limit = parseInt(document.getElementById('piTopPerformersLimit')?.value || 5);
            
            // Get last month
            const now = new Date();
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
            const lastMonthName = lastMonthDate.toLocaleString('default', { month: 'long' });
            
            document.getElementById('piTopPerformersMonth').textContent = `(${lastMonthName})`;
            
            // Get providers with last month data, sorted by hours
            const topPerformers = providerInsightsData
                .filter(p => p.monthlyData[lastMonthKey])
                .map(p => ({
                    name: p.name,
                    services: p.monthlyData[lastMonthKey].services,
                    hours: p.monthlyData[lastMonthKey].hours,
                    revenue: p.monthlyData[lastMonthKey].revenue
                }))
                .sort((a, b) => b.hours - a.hours)
                .slice(0, limit);
            
            if (topPerformers.length === 0) {
                container.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">No data for ${lastMonthName}</td></tr>`;
                return;
            }
            
            container.innerHTML = topPerformers.map((p, i) => `
                <tr>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3;">
                        <span style="background: ${i < 3 ? '#1A365C' : '#E5ECF3'}; color: ${i < 3 ? 'white' : '#666'}; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">${i + 1}</span>
                    </td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; font-weight: 500; font-size: 13px;">${escapeHtml(p.name)}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 13px;">${p.services}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-size: 13px;">${p.hours.toFixed(1)}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #62B790; font-size: 13px;">$${formatNumber(p.revenue)}</td>
                </tr>
            `).join('');
        }
        
        function renderPIAtRiskProviders() {
            if (!providerInsightsData) return;
            
            const container = document.getElementById('piAtRiskProviders');
            const limit = parseInt(document.getElementById('piAtRiskLimit')?.value || 5);
            const now = new Date();
            
            // Get last and prior month keys
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
            const priorMonthDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
            const priorMonthKey = `${priorMonthDate.getFullYear()}-${String(priorMonthDate.getMonth() + 1).padStart(2, '0')}`;
            
            // Find providers with significant drop in hours
            const atRisk = providerInsightsData
                .filter(p => p.monthlyData[priorMonthKey] && p.monthlyData[priorMonthKey].hours > 0)
                .map(p => {
                    const priorHours = p.monthlyData[priorMonthKey]?.hours || 0;
                    const lastHours = p.monthlyData[lastMonthKey]?.hours || 0;
                    const change = priorHours > 0 ? ((lastHours - priorHours) / priorHours) * 100 : 0;
                    return {
                        name: p.name,
                        lastHours,
                        priorHours,
                        change,
                        lastService: p.lastService
                    };
                })
                .filter(p => p.change < -30) // More than 30% drop
                .sort((a, b) => a.change - b.change)
                .slice(0, limit);
            
            if (atRisk.length === 0) {
                container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #059669; padding: 20px;">‚úì No providers with significant hour drops</td></tr>';
                return;
            }
            
            container.innerHTML = atRisk.map(p => `
                <tr>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; font-weight: 500; font-size: 13px;">${escapeHtml(p.name)}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: center; font-size: 13px;">${p.lastHours.toFixed(1)} hrs</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: center; font-size: 13px;">${p.priorHours.toFixed(1)} hrs</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: center; font-weight: 600; color: #DC2626; font-size: 13px;">${p.change.toFixed(0)}%</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: center; font-size: 12px; color: #666;">${new Date(p.lastService).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }
        
        function renderPINewProviders() {
            if (!providerInsightsData) return;
            
            const container = document.getElementById('piNewProviders');
            const limit = parseInt(document.getElementById('piNewProvidersLimit')?.value || 5);
            const now = new Date();
            const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            
            // Providers whose first service was in the last 90 days
            const newProviders = providerInsightsData
                .filter(p => p.firstService >= ninetyDaysAgo)
                .sort((a, b) => b.firstService - a.firstService)
                .slice(0, limit);
            
            if (newProviders.length === 0) {
                container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">No new providers in the last 90 days</td></tr>';
                return;
            }
            
            const statusColors = {
                'active': { bg: '#DCFCE7', color: '#166534', label: 'Active' },
                'declining': { bg: '#FEF3C7', color: '#92400E', label: 'Declining' },
                'at-risk': { bg: '#FFEDD5', color: '#9A3412', label: 'At Risk' },
                'inactive': { bg: '#FEE2E2', color: '#991B1B', label: 'Inactive' }
            };
            
            container.innerHTML = newProviders.map(p => {
                const sc = statusColors[p.status];
                return `
                    <tr>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #BBF7D0; font-weight: 500; font-size: 13px;">${escapeHtml(p.name)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #BBF7D0; text-align: center; font-size: 12px;">${new Date(p.firstService).toLocaleDateString()}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #BBF7D0; text-align: center; font-size: 13px;">${p.totalServices}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #BBF7D0; text-align: right; font-size: 13px;">${p.totalHours.toFixed(1)}</td>
                        <td style="padding: 8px 10px; border-bottom: 1px solid #BBF7D0; text-align: center;">
                            <span style="background: ${sc.bg}; color: ${sc.color}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${sc.label}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderPIChurnedProviders() {
            if (!providerInsightsData) return;
            
            const container = document.getElementById('piChurnedProvidersList');
            const limit = parseInt(document.getElementById('piChurnedLimit')?.value || 5);
            
            // Get recently churned (inactive for 90+ days but were active in the selected year)
            const churned = providerInsightsData
                .filter(p => p.status === 'inactive')
                .sort((a, b) => b.lastService - a.lastService)
                .slice(0, limit);
            
            if (churned.length === 0) {
                container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #059669; padding: 20px;">‚úì No recently churned providers</td></tr>';
                return;
            }
            
            container.innerHTML = churned.map(p => `
                <tr>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; font-weight: 500; font-size: 13px;">${escapeHtml(p.name)}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: center; font-size: 12px;">${new Date(p.lastService).toLocaleDateString()}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: center; font-size: 13px;">${p.tenureMonths} mo</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: right; font-size: 13px;">${p.totalHours.toFixed(1)}</td>
                    <td style="padding: 8px 10px; border-bottom: 1px solid #FECACA; text-align: right; font-weight: 600; color: #666; font-size: 13px;">$${formatNumber(p.totalRevenue)}</td>
                </tr>
            `).join('');
        }
        
        function renderPIAllProviders() {
            if (!providerInsightsData) return;
            
            const container = document.getElementById('piAllProvidersTable');
            const limit = document.getElementById('piProviderLimit')?.value || '5';
            const statusFilter = document.getElementById('piProviderStatusFilter')?.value || 'all';
            const searchTerm = (document.getElementById('piProviderSearch')?.value || '').toLowerCase();
            
            let filtered = providerInsightsData;
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filtered = filtered.filter(p => p.status === statusFilter);
            }
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
            }
            
            // Sort by total hours descending
            filtered = filtered.sort((a, b) => b.totalHours - a.totalHours);
            
            // Apply limit
            if (limit !== 'all') {
                filtered = filtered.slice(0, parseInt(limit));
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999; padding: 20px;">No providers match the filter criteria</td></tr>';
                return;
            }
            
            const statusColors = {
                'active': { bg: '#DCFCE7', color: '#166534', label: 'Active' },
                'declining': { bg: '#FEF3C7', color: '#92400E', label: 'Declining' },
                'at-risk': { bg: '#FFEDD5', color: '#9A3412', label: 'At Risk' },
                'inactive': { bg: '#FEE2E2', color: '#991B1B', label: 'Inactive' }
            };
            
            container.innerHTML = filtered.map((p, i) => {
                const sc = statusColors[p.status];
                return `
                    <tr>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3;">${i + 1}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; font-weight: 500;">${escapeHtml(p.name)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">
                            <span style="background: ${sc.bg}; color: ${sc.color}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${sc.label}</span>
                        </td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${p.tenureMonths} mo</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${p.totalServices}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: right;">${p.totalHours.toFixed(1)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #62B790;">$${formatNumber(p.totalRevenue)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${p.avgHoursPerMonth.toFixed(1)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center; font-size: 12px; color: #666;">${new Date(p.lastService).toLocaleDateString()}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterPIProviderTable() {
            renderPIAllProviders();
        }
        
        // ============================================
        // ON-CALL UTILIZATION FUNCTIONS
        // ============================================
        
        const ONCALL_SHEET_ID = '1Z8AJQbIVMP-12IKjTuMHCwu_szLcjtCOv1nAgTIviqw';
        
        async function loadOncallUtilization(forceRefresh = false) {
            const loadingEl = document.getElementById('oncallLoading');
            const tableContainer = document.getElementById('oncallTableContainer');
            const noDataEl = document.getElementById('oncallNoData');
            const periodLabel = document.getElementById('oncallPeriodLabel');
            const periodFilter = document.getElementById('oncallPeriodFilter');
            
            // Populate week dropdown if empty
            if (periodFilter && periodFilter.options.length === 0) {
                populateOncallWeekDropdown();
            }
            
            loadingEl.style.display = 'block';
            tableContainer.style.display = 'none';
            noDataEl.style.display = 'none';
            
            // Get the period filter value
            const filterValue = periodFilter?.value || 'last-month';
            
            // Calculate date range based on filter
            let cutoffDate, endDate, periodLabelText;
            const now = new Date();
            
            if (filterValue === 'last-month') {
                // Last month
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                lastMonthEnd.setHours(23, 59, 59, 999); // End of day
                cutoffDate = lastMonth;
                endDate = lastMonthEnd;
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                periodLabelText = `${monthNames[lastMonth.getMonth()]} ${lastMonth.getFullYear()}`;
            } else {
                // Week number - format: "week-YYYY-WW"
                const [, year, week] = filterValue.split('-');
                const weekDates = getWeekDateRange(parseInt(year), parseInt(week));
                cutoffDate = weekDates.start;
                endDate = weekDates.end;
                periodLabelText = `Week ${week} (${formatShortDate(weekDates.start)} - ${formatShortDate(weekDates.end)})`;
            }
            
            if (periodLabel) {
                periodLabel.textContent = 'Showing: ' + periodLabelText;
            }
            
            try {
                // Fetch on-call schedule data (use cache if available and not forcing refresh)
                let oncallData;
                if (oncallDataCache && !forceRefresh) {
                    oncallData = oncallDataCache;
                } else {
                    oncallData = await fetchOncallScheduleData();
                    oncallDataCache = oncallData; // Cache the data
                }
                
                if (!oncallData || oncallData.length === 0) {
                    loadingEl.style.display = 'none';
                    noDataEl.style.display = 'block';
                    updateOncallKPIs([]);
                    return;
                }
                
                // Filter on-call data by date range
                const filteredOncall = oncallData.filter(row => {
                    const scheduleDate = parseOncallDate(row.scheduleDate);
                    return scheduleDate && scheduleDate >= cutoffDate && scheduleDate <= endDate;
                });
                
                if (filteredOncall.length === 0) {
                    loadingEl.style.display = 'none';
                    noDataEl.style.display = 'block';
                    updateOncallKPIs([]);
                    return;
                }
                
                // Get service data for the same period (pass oncall data to match time windows)
                const serviceByProvider = getServiceDataForDateRange(cutoffDate, endDate, filteredOncall);
                
                // Calculate utilization
                const utilization = calculateOncallUtilization(filteredOncall, serviceByProvider);
                
                // Update KPIs
                updateOncallKPIs(utilization);
                
                // Render table
                renderOncallUtilizationTable(utilization);
                
                loadingEl.style.display = 'none';
                tableContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading on-call utilization:', error);
                loadingEl.style.display = 'none';
                noDataEl.style.display = 'block';
                document.querySelector('#oncallNoData p').textContent = 'Error loading on-call data: ' + error.message;
            }
        }
        
        function populateOncallWeekDropdown() {
            const periodFilter = document.getElementById('oncallPeriodFilter');
            if (!periodFilter) return;
            
            const now = new Date();
            const options = [];
            
            // Add last month option
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            options.push(`<option value="last-month">Last Month (${monthNames[lastMonth.getMonth()]})</option>`);
            
            // Add last 8 weeks
            for (let i = 1; i <= 8; i++) {
                const weekDate = new Date(now);
                weekDate.setDate(weekDate.getDate() - (i * 7));
                const weekNum = getISOWeek(weekDate);
                const weekYear = getISOWeekYear(weekDate);
                const weekDates = getWeekDateRange(weekYear, weekNum);
                
                const label = `Week ${weekNum} (${formatShortDate(weekDates.start)} - ${formatShortDate(weekDates.end)})`;
                options.push(`<option value="week-${weekYear}-${weekNum}">${label}</option>`);
            }
            
            periodFilter.innerHTML = options.join('');
        }
        
        function getISOWeek(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayNum = d.getDay() || 7;
            d.setDate(d.getDate() + 4 - dayNum);
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function getISOWeekYear(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayNum = d.getDay() || 7;
            d.setDate(d.getDate() + 4 - dayNum);
            return d.getFullYear();
        }
        
        function getWeekDateRange(year, week) {
            // Find the first Thursday of the year (ISO week 1 contains the first Thursday)
            const jan4 = new Date(year, 0, 4);
            const dayOfWeek = jan4.getDay() || 7;
            const firstMonday = new Date(jan4);
            firstMonday.setDate(jan4.getDate() - dayOfWeek + 1);
            
            // Calculate the Monday of the requested week
            const weekStart = new Date(firstMonday);
            weekStart.setDate(firstMonday.getDate() + (week - 1) * 7);
            
            // Sunday is 6 days after Monday
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            // Set to end of day for proper comparison
            weekEnd.setHours(23, 59, 59, 999);
            
            return { start: weekStart, end: weekEnd };
        }
        
        function formatShortDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}`;
        }
        
        function getServiceDataForDateRange(startDate, endDate, oncallData) {
            // Get service data from the dashboardDataCache for the specific date range
            // Returns services grouped by provider with details for expandable view
            const serviceByProvider = {};
            
            // First, build a lookup of on-call time segments by provider and date
            // Now using Time Card (actual worked time) instead of planned start/end
            const oncallWindows = {};
            
            oncallData.forEach(row => {
                const provider = row.provider?.trim();
                const scheduleDate = parseOncallDate(row.scheduleDate);
                if (!provider || !scheduleDate) return;
                
                const dateKey = scheduleDate.toDateString();
                const key = `${provider}|||${dateKey}`;
                
                if (!oncallWindows[key]) {
                    oncallWindows[key] = [];
                }
                
                // Parse Time Card segments (e.g., "08:00-10:40,10:55-16:15,17:00-17:00")
                const timeCard = row.timeCard || '';
                if (timeCard) {
                    const segments = parseTimeCardSegments(timeCard);
                    segments.forEach(seg => {
                        oncallWindows[key].push({
                            start: seg.start,
                            end: seg.end,
                            startStr: seg.startStr,
                            endStr: seg.endStr
                        });
                    });
                } else {
                    // Fall back to planned start/end if no time card
                    oncallWindows[key].push({
                        start: parseOncallTime(row.startTime),
                        end: parseOncallTime(row.endTime),
                        startStr: row.startTime,
                        endStr: row.endTime
                    });
                }
            });
            
            // Aggregate from all cached years
            Object.values(dashboardDataCache).forEach(yearData => {
                if (!Array.isArray(yearData)) return;
                
                yearData.forEach(r => {
                    const providerName = r['Provider Name'];
                    if (!providerName || providerName === 'Unassigned' || providerName === 'Unknown') return;
                    
                    // Only count COMPLETED services
                    const status = (r['Status'] || r.Status || '').toUpperCase();
                    if (status !== 'COMPLETED') return;
                    
                    const serviceDate = new Date(r['Scheduled Date']);
                    if (serviceDate < startDate || serviceDate > endDate) return;
                    
                    // Service Duration is in minutes, convert to hours
                    const hours = (parseFloat(r['Service Duration']) || 0) / 60;
                    // Scheduled Time from Reports tab Column C
                    const serviceTime = r['Scheduled Time'] || r['Start Time'] || r['STxTime'] || r['StartTIME'] || '';
                    const clientName = r['Customer Name'] || 'Unknown';
                    
                    // Check if this provider has on-call windows for this date
                    const dateKey = serviceDate.toDateString();
                    const windowKey = `${providerName}|||${dateKey}`;
                    const windows = oncallWindows[windowKey] || [];
                    
                    // Parse service time
                    const parsedServiceTime = parseServiceTime(serviceTime);
                    
                    // Check if service falls within any on-call window segment
                    let isWithinWindow = false;
                    let matchedWindow = null;
                    
                    if (windows.length > 0 && parsedServiceTime) {
                        for (const window of windows) {
                            if (window.start && window.end && isTimeWithinWindow(parsedServiceTime, window.start, window.end)) {
                                isWithinWindow = true;
                                matchedWindow = window;
                                break;
                            }
                        }
                    }
                    
                    // Initialize provider data structure
                    if (!serviceByProvider[providerName]) {
                        serviceByProvider[providerName] = {
                            services: 0,
                            hours: 0,
                            servicesOutside: 0,
                            hoursOutside: 0,
                            details: [],
                            detailsOutside: []
                        };
                    }
                    
                    const serviceDetail = {
                        date: serviceDate.toLocaleDateString(),
                        time: serviceTime,
                        client: clientName,
                        hours: hours,
                        window: matchedWindow ? `${matchedWindow.startStr}-${matchedWindow.endStr}` : null
                    };
                    
                    if (isWithinWindow) {
                        // Service is within on-call window - count it
                        serviceByProvider[providerName].services++;
                        serviceByProvider[providerName].hours += hours;
                        serviceByProvider[providerName].details.push(serviceDetail);
                    } else if (windows.length > 0) {
                        // Provider has on-call windows but service is outside - track separately
                        serviceByProvider[providerName].servicesOutside++;
                        serviceByProvider[providerName].hoursOutside += hours;
                        serviceByProvider[providerName].detailsOutside.push(serviceDetail);
                    }
                    // If no windows exist for this provider on this date, we don't count it at all
                });
            });
            
            return serviceByProvider;
        }
        
        function parseTimeCardSegments(timeCard) {
            // Parse Time Card format: "08:00-10:40,10:55-16:15,17:00-17:00"
            // Returns array of { start, end, startStr, endStr }
            const segments = [];
            
            if (!timeCard) return segments;
            
            const parts = timeCard.split(',');
            
            parts.forEach(part => {
                const trimmed = part.trim();
                if (!trimmed) return;
                
                // Split by dash to get start and end
                const times = trimmed.split('-');
                if (times.length >= 2) {
                    const startStr = times[0].trim();
                    const endStr = times[1].trim();
                    
                    const start = parseOncallTime(startStr);
                    const end = parseOncallTime(endStr);
                    
                    if (start && end) {
                        segments.push({
                            start,
                            end,
                            startStr,
                            endStr
                        });
                    }
                }
            });
            
            return segments;
        }
        
        function calculateTimeCardHours(timeCard) {
            // Calculate total hours from time card segments
            const segments = parseTimeCardSegments(timeCard);
            let totalHours = 0;
            
            segments.forEach(seg => {
                if (seg.start && seg.end) {
                    let startMinutes = seg.start.hours * 60 + seg.start.minutes;
                    let endMinutes = seg.end.hours * 60 + seg.end.minutes;
                    
                    // Handle overnight shifts
                    if (endMinutes < startMinutes) {
                        endMinutes += 24 * 60;
                    }
                    
                    const segmentHours = (endMinutes - startMinutes) / 60;
                    if (segmentHours > 0) {
                        totalHours += segmentHours;
                    }
                }
            });
            
            return totalHours;
        }
        
        function parseServiceTime(timeStr) {
            if (!timeStr) return null;
            
            const str = timeStr.toString().trim();
            
            // Handle ISO datetime format: "2025-11-30T14:55:00.000Z"
            // The Z means UTC - need to convert to local time
            if (str.includes('T')) {
                try {
                    const date = new Date(str);
                    if (!isNaN(date.getTime())) {
                        return { 
                            hours: date.getHours(),  // getHours() returns local time
                            minutes: date.getMinutes() 
                        };
                    }
                } catch (e) {
                    // Fall through to other parsing methods
                }
            }
            
            // Handle various time formats: "8:00 AM", "14:30", "2:30 PM", "8:00:00 AM", etc.
            const upperStr = str.toUpperCase();
            
            // Try HH:MM:SS AM/PM or HH:MM AM/PM format
            const ampmMatch = upperStr.match(/(\d{1,2}):(\d{2})(?::\d{2})?\s*(AM|PM)?/i);
            if (ampmMatch) {
                let hours = parseInt(ampmMatch[1]);
                const minutes = parseInt(ampmMatch[2]);
                const ampm = ampmMatch[3];
                
                if (ampm === 'PM' && hours < 12) hours += 12;
                if (ampm === 'AM' && hours === 12) hours = 0;
                
                return { hours, minutes };
            }
            
            return null;
        }
        
        function formatServiceTime(timeStr) {
            // Format time for display in local time
            if (!timeStr) return '-';
            
            const str = timeStr.toString().trim();
            
            // Handle ISO datetime format - convert to local time
            if (str.includes('T')) {
                try {
                    const date = new Date(str);
                    if (!isNaN(date.getTime())) {
                        let hours = date.getHours();
                        const minutes = date.getMinutes().toString().padStart(2, '0');
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        if (hours > 12) hours -= 12;
                        if (hours === 0) hours = 12;
                        return `${hours}:${minutes} ${ampm}`;
                    }
                } catch (e) {
                    // Fall through
                }
            }
            
            // Already in readable format
            return str;
        }
        
        function isTimeWithinWindow(serviceTime, windowStart, windowEnd) {
            if (!serviceTime || !windowStart || !windowEnd) return false;
            
            const serviceMinutes = serviceTime.hours * 60 + serviceTime.minutes;
            const startMinutes = windowStart.hours * 60 + windowStart.minutes;
            const endMinutes = windowEnd.hours * 60 + windowEnd.minutes;
            
            // Handle overnight shifts (e.g., 22:00 - 06:00)
            if (endMinutes < startMinutes) {
                // Overnight shift - service is within if it's after start OR before end
                return serviceMinutes >= startMinutes || serviceMinutes <= endMinutes;
            }
            
            // Regular shift - service must be between start and end
            return serviceMinutes >= startMinutes && serviceMinutes <= endMinutes;
        }
        
        async function fetchOncallScheduleData() {
            // Use JSONP to fetch from the on-call Google Sheet
            return new Promise((resolve, reject) => {
                const callbackName = 'oncallCallback_' + Date.now();
                const script = document.createElement('script');
                
                // Build the Apps Script URL for fetching on-call data
                const params = new URLSearchParams({
                    action: 'getOncallData',
                    sheetId: ONCALL_SHEET_ID,
                    callback: callbackName
                });
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (response.success) {
                        oncallDataCache = response.data;
                        resolve(response.data);
                    } else {
                        reject(new Error(response.error || 'Failed to fetch on-call data'));
                    }
                };
                
                script.src = `${WEBAPP_URL}?${params.toString()}`;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Network error loading on-call data'));
                };
                
                document.body.appendChild(script);
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        reject(new Error('Request timed out'));
                    }
                }, 30000);
            });
        }
        
        function parseOncallDate(dateStr) {
            if (!dateStr) return null;
            // Handle MM/DD/YYYY format
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const month = parseInt(parts[0]) - 1;
                const day = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
            return new Date(dateStr);
        }
        
        function parseOncallTime(timeStr) {
            if (!timeStr) return null;
            // Handle HH:MM format (24-hour)
            const parts = timeStr.split(':');
            if (parts.length >= 2) {
                return {
                    hours: parseInt(parts[0]),
                    minutes: parseInt(parts[1])
                };
            }
            return null;
        }
        
        function calculateShiftHours(startStr, endStr) {
            const start = parseOncallTime(startStr);
            const end = parseOncallTime(endStr);
            
            if (!start || !end) return 0;
            
            let startMinutes = start.hours * 60 + start.minutes;
            let endMinutes = end.hours * 60 + end.minutes;
            
            // Handle overnight shifts
            if (endMinutes < startMinutes) {
                endMinutes += 24 * 60;
            }
            
            return (endMinutes - startMinutes) / 60;
        }
        
        function calculateOncallUtilization(oncallData, serviceByProvider) {
            // Group on-call shifts by provider and sum actual worked hours from Time Card
            const oncallByProvider = {};
            
            oncallData.forEach(row => {
                const provider = row.provider?.trim();
                if (!provider) return;
                
                // Use Time Card for actual worked hours, fall back to planned if not available
                const timeCard = row.timeCard || '';
                let shiftHours;
                let shiftDisplay;
                
                if (timeCard) {
                    shiftHours = calculateTimeCardHours(timeCard);
                    shiftDisplay = timeCard; // Show actual time card segments
                } else {
                    shiftHours = calculateShiftHours(row.startTime, row.endTime);
                    shiftDisplay = `${row.startTime}-${row.endTime}`;
                }
                
                const scheduleDate = parseOncallDate(row.scheduleDate);
                
                if (!oncallByProvider[provider]) {
                    oncallByProvider[provider] = {
                        provider,
                        shifts: 0,
                        scheduledHours: 0,
                        shiftDetails: []
                    };
                }
                
                oncallByProvider[provider].shifts++;
                oncallByProvider[provider].scheduledHours += shiftHours;
                oncallByProvider[provider].shiftDetails.push({
                    date: scheduleDate ? scheduleDate.toLocaleDateString() : row.scheduleDate,
                    timeCard: shiftDisplay,
                    hours: shiftHours
                });
            });
            
            // Calculate utilization for each on-call provider
            const utilization = Object.values(oncallByProvider).map(oncall => {
                // Get the actual worked hours from service data
                const serviceData = serviceByProvider[oncall.provider] || { 
                    services: 0, 
                    hours: 0, 
                    servicesOutside: 0, 
                    hoursOutside: 0,
                    details: [],
                    detailsOutside: []
                };
                
                const utilizationPct = oncall.scheduledHours > 0 
                    ? (serviceData.hours / oncall.scheduledHours) * 100 
                    : 0;
                
                const idleHours = Math.max(0, oncall.scheduledHours - serviceData.hours);
                
                // Calculate trend based on utilization percentage
                let trend = 'stable';
                if (utilizationPct >= 70) trend = 'high';
                else if (utilizationPct >= 40) trend = 'good';
                else if (utilizationPct >= 20) trend = 'low';
                else trend = 'very-low';
                
                return {
                    provider: oncall.provider,
                    shifts: oncall.shifts,
                    scheduledHours: oncall.scheduledHours,
                    services: serviceData.services,
                    serviceHours: serviceData.hours,
                    servicesOutside: serviceData.servicesOutside,
                    hoursOutside: serviceData.hoursOutside,
                    utilization: utilizationPct,
                    idleHours,
                    trend,
                    // Details for expandable view
                    shiftDetails: oncall.shiftDetails,
                    serviceDetails: serviceData.details,
                    serviceDetailsOutside: serviceData.detailsOutside
                };
            });
            
            // Sort by scheduled hours descending
            return utilization.sort((a, b) => b.scheduledHours - a.scheduledHours);
        }
        
        function updateOncallKPIs(utilization) {
            const totalStaff = utilization.length;
            const totalScheduled = utilization.reduce((sum, u) => sum + u.scheduledHours, 0);
            const totalWorked = utilization.reduce((sum, u) => sum + u.serviceHours, 0);
            const avgUtilization = totalScheduled > 0 ? (totalWorked / totalScheduled) * 100 : 0;
            
            document.getElementById('oncallTotalStaff').textContent = totalStaff;
            document.getElementById('oncallScheduledHours').textContent = totalScheduled.toFixed(1);
            document.getElementById('oncallWorkedHours').textContent = totalWorked.toFixed(1);
            document.getElementById('oncallAvgUtilization').textContent = avgUtilization.toFixed(0) + '%';
        }
        
        function renderOncallUtilizationTable(utilization) {
            // Store globally for re-rendering when limit changes
            window.oncallUtilizationData = utilization;
            
            const container = document.getElementById('oncallUtilizationTable');
            const limit = parseInt(document.getElementById('oncallLimit')?.value || 5);
            
            if (!utilization || utilization.length === 0) {
                container.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999; padding: 20px;">No on-call providers found</td></tr>';
                return;
            }
            
            const limitedData = utilization.slice(0, limit);
            
            const trendConfig = {
                'high': { color: '#059669', bg: '#DCFCE7', label: 'üî• High', icon: '‚Üë' },
                'good': { color: '#0369A1', bg: '#E0F2FE', label: '‚úì Good', icon: '‚Üí' },
                'low': { color: '#D97706', bg: '#FEF3C7', label: '‚ö† Low', icon: '‚Üì' },
                'very-low': { color: '#DC2626', bg: '#FEE2E2', label: '‚ö° Very Low', icon: '‚Üì‚Üì' },
                'stable': { color: '#666', bg: '#F3F4F6', label: '‚Äî Stable', icon: '‚Üí' }
            };
            
            container.innerHTML = limitedData.map((u, idx) => {
                const trend = trendConfig[u.trend] || trendConfig['stable'];
                const utilizationColor = u.utilization >= 70 ? '#059669' : 
                                        u.utilization >= 40 ? '#0369A1' : 
                                        u.utilization >= 20 ? '#D97706' : '#DC2626';
                
                const hasDetails = (u.serviceDetails && u.serviceDetails.length > 0) || 
                                  (u.serviceDetailsOutside && u.serviceDetailsOutside.length > 0) ||
                                  (u.shiftDetails && u.shiftDetails.length > 0);
                
                // Build expandable details section
                let detailsHtml = '';
                if (hasDetails) {
                    detailsHtml = `
                        <tr id="oncall-details-${idx}" style="display: none;">
                            <td colspan="8" style="padding: 0; background: #F8FAFC;">
                                <div style="padding: 15px 20px; border-bottom: 2px solid #E5ECF3;">
                                    ${u.shiftDetails && u.shiftDetails.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: 600; color: #1A365C; margin-bottom: 8px; font-size: 12px;">üìÖ Actual Time Card (${u.shiftDetails.length} days)</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${u.shiftDetails.map(s => `
                                                <span style="background: #FEF3C7; color: #92400E; padding: 4px 10px; border-radius: 6px; font-size: 11px;" title="${s.timeCard}">
                                                    ${s.date} ‚Ä¢ ${s.timeCard.length > 25 ? s.timeCard.substring(0, 25) + '...' : s.timeCard} (${s.hours.toFixed(1)}h)
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    ${u.serviceDetails && u.serviceDetails.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: 600; color: #166534; margin-bottom: 8px; font-size: 12px;">‚úÖ Services Within On-Call Window (${u.serviceDetails.length})</div>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="background: #DCFCE7;">
                                                        <th style="padding: 6px 8px; text-align: left;">Date</th>
                                                        <th style="padding: 6px 8px; text-align: left;">Time</th>
                                                        <th style="padding: 6px 8px; text-align: left;">Client</th>
                                                        <th style="padding: 6px 8px; text-align: right;">Hours</th>
                                                        <th style="padding: 6px 8px; text-align: left;">Window</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${u.serviceDetails.map(s => `
                                                        <tr style="border-bottom: 1px solid #E5ECF3;">
                                                            <td style="padding: 5px 8px;">${s.date}</td>
                                                            <td style="padding: 5px 8px;">${formatServiceTime(s.time)}</td>
                                                            <td style="padding: 5px 8px;">${escapeHtml(s.client)}</td>
                                                            <td style="padding: 5px 8px; text-align: right; font-weight: 500;">${s.hours.toFixed(2)}</td>
                                                            <td style="padding: 5px 8px; color: #166534;">${s.window || '-'}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    ` : '<div style="color: #999; font-size: 12px; margin-bottom: 15px;">No services within on-call windows</div>'}
                                    
                                    ${u.serviceDetailsOutside && u.serviceDetailsOutside.length > 0 ? `
                                    <div>
                                        <div style="font-weight: 600; color: #DC2626; margin-bottom: 8px; font-size: 12px;">‚ö†Ô∏è Services Outside On-Call Window (${u.serviceDetailsOutside.length}) - Not Counted</div>
                                        <div style="max-height: 150px; overflow-y: auto;">
                                            <table style="width: 100%; font-size: 11px; border-collapse: collapse; opacity: 0.8;">
                                                <thead>
                                                    <tr style="background: #FEE2E2;">
                                                        <th style="padding: 6px 8px; text-align: left;">Date</th>
                                                        <th style="padding: 6px 8px; text-align: left;">Time</th>
                                                        <th style="padding: 6px 8px; text-align: left;">Client</th>
                                                        <th style="padding: 6px 8px; text-align: right;">Hours</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${u.serviceDetailsOutside.map(s => `
                                                        <tr style="border-bottom: 1px solid #FECACA; color: #991B1B;">
                                                            <td style="padding: 5px 8px;">${s.date}</td>
                                                            <td style="padding: 5px 8px;">${formatServiceTime(s.time)}</td>
                                                            <td style="padding: 5px 8px;">${escapeHtml(s.client)}</td>
                                                            <td style="padding: 5px 8px; text-align: right;">${s.hours.toFixed(2)}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div style="margin-top: 8px; font-size: 11px; color: #991B1B;">
                                            Total outside window: ${u.servicesOutside} services, ${u.hoursOutside.toFixed(1)} hours
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                return `
                    <tr style="cursor: ${hasDetails ? 'pointer' : 'default'};" onclick="${hasDetails ? `toggleOncallDetails(${idx})` : ''}">
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; font-weight: 500;">
                            ${hasDetails ? `<span id="oncall-toggle-${idx}" style="display: inline-block; width: 18px; color: #0369A1; font-weight: bold;">+</span>` : '<span style="display: inline-block; width: 18px;"></span>'}
                            ${escapeHtml(u.provider)}
                            ${u.servicesOutside > 0 ? `<span style="color: #DC2626; font-size: 10px; margin-left: 5px;" title="${u.servicesOutside} services outside window">(+${u.servicesOutside})</span>` : ''}
                        </td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${u.shifts}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">${u.services}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #92400E;">${u.scheduledHours.toFixed(1)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; font-weight: 600; color: #166534;">${u.serviceHours.toFixed(1)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">
                            <span style="background: ${utilizationColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${u.utilization.toFixed(0)}%</span>
                        </td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: right; color: #DC2626;">${u.idleHours.toFixed(1)}</td>
                        <td style="padding: 10px 12px; border-bottom: 1px solid #E5ECF3; text-align: center;">
                            <span style="background: ${trend.bg}; color: ${trend.color}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${trend.label}</span>
                        </td>
                    </tr>
                    ${detailsHtml}
                `;
            }).join('');
        }
        
        function toggleOncallDetails(idx) {
            const detailsRow = document.getElementById(`oncall-details-${idx}`);
            const toggleBtn = document.getElementById(`oncall-toggle-${idx}`);
            
            if (detailsRow) {
                const isHidden = detailsRow.style.display === 'none';
                detailsRow.style.display = isHidden ? 'table-row' : 'none';
                if (toggleBtn) {
                    toggleBtn.textContent = isHidden ? '‚àí' : '+';
                }
            }
        }
        
        // ============================================
        // INVESTOR RELATIONS FUNCTIONS
        // ============================================
        
        // Cache for IR data
        let irEventsCache = {};
        let irEmailsCache = [];
        
        // Get current quarter info
        function getCurrentQuarterInfo() {
            const now = new Date();
            const quarter = Math.ceil((now.getMonth() + 1) / 3);
            const year = now.getFullYear();
            return { quarter, year, key: `Q${quarter}-${year}` };
        }
        
        // Load events from server
        async function loadInvestorEvents(quarterKey) {
            try {
                const params = { action: 'getIREvents' };
                if (quarterKey) params.quarterKey = quarterKey;
                const result = await jsonpFetch(params);
                if (result.success) {
                    irEventsCache = result.events || {};
                    return irEventsCache;
                }
                return {};
            } catch (e) {
                console.warn('Failed to load IR events:', e);
                return {};
            }
        }
        
        // Save event to server
        async function saveEventToServer(eventData) {
            try {
                const result = await jsonpFetch({
                    action: 'saveIREvent',
                    quarter: eventData.quarter,
                    year: eventData.year,
                    quarterKey: eventData.quarterKey,
                    date: eventData.date,
                    category: eventData.category,
                    title: eventData.title,
                    description: eventData.description || '',
                    highlight: eventData.highlight ? 'true' : 'false'
                });
                return result;
            } catch (e) {
                console.error('Failed to save event:', e);
                return { success: false, error: e.message };
            }
        }
        
        // Delete event from server
        async function deleteEventFromServer(eventId) {
            try {
                const result = await jsonpFetch({
                    action: 'deleteIREvent',
                    eventId: eventId
                });
                return result;
            } catch (e) {
                console.error('Failed to delete event:', e);
                return { success: false, error: e.message };
            }
        }
        
        // Load email history from server
        async function loadEmailHistory() {
            try {
                const result = await jsonpFetch({ action: 'getIREmails' });
                if (result.success) {
                    irEmailsCache = result.emails || [];
                    return irEmailsCache;
                }
                return [];
            } catch (e) {
                console.warn('Failed to load email history:', e);
                return [];
            }
        }
        
        // Save email to server
        async function saveEmailToServer(emailData) {
            try {
                // Truncate body if too long for URL (JSONP uses GET with ~8KB practical limit)
                // After encoding, URLs shouldn't exceed ~6000 chars to be safe
                const maxBodyLength = 4000; // ~4KB raw = ~6KB encoded
                let bodyToSave = emailData.body || '';
                
                if (bodyToSave.length > maxBodyLength) {
                    bodyToSave = bodyToSave.substring(0, maxBodyLength) + 
                        '\n\n--- Content truncated for storage (' + emailData.body.length + ' chars total) ---';
                }
                
                const result = await jsonpFetch({
                    action: 'saveIREmail',
                    id: emailData.id || '',
                    quarter: emailData.quarter,
                    year: emailData.year,
                    quarterKey: emailData.quarterKey,
                    subject: emailData.subject || '',
                    body: bodyToSave,
                    status: emailData.status
                });
                return result;
            } catch (e) {
                console.error('Failed to save email:', e);
                return { success: false, error: e.message };
            }
        }
        
        // Delete email from server
        async function deleteEmailFromServer(emailId) {
            try {
                const result = await jsonpFetch({
                    action: 'deleteIREmail',
                    emailId: emailId
                });
                return result;
            } catch (e) {
                console.error('Failed to delete email:', e);
                return { success: false, error: e.message };
            }
        }
        
        // Initialize IR section display
        async function initInvestorRelations() {
            const { quarter, year } = getCurrentQuarterInfo();
            const qEl = document.getElementById('irCurrentQuarter');
            const yEl = document.getElementById('irCurrentYear');
            if (qEl) qEl.textContent = quarter;
            if (yEl) yEl.textContent = year;
            
            await renderQuarterEvents();
        }
        
        // Render quarter events list
        async function renderQuarterEvents() {
            const { key } = getCurrentQuarterInfo();
            const listEl = document.getElementById('irEventsList');
            const countEl = document.getElementById('irEventCount');
            
            if (listEl) {
                listEl.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 10px;">Loading events...</div>';
            }
            
            await loadInvestorEvents();
            const quarterEvents = irEventsCache[key] || [];
            
            if (countEl) countEl.textContent = quarterEvents.length;
            
            if (!listEl) return;
            
            if (quarterEvents.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px; font-size: 13px;">
                        No events logged for this quarter yet.<br>
                        <span style="font-size: 11px;">Click "Log Event" to add milestones, wins, or notable updates.</span>
                    </div>
                `;
                return;
            }
            
            const categoryIcons = {
                milestone: 'üéØ', client: 'üë•', partnership: 'ü§ù', product: 'üöÄ',
                team: 'üëî', financial: 'üí∞', recognition: 'üèÜ', challenge: '‚ö†Ô∏è', other: 'üìå'
            };
            
            listEl.innerHTML = quarterEvents.sort((a, b) => new Date(b.date) - new Date(a.date)).map((evt) => `
                <div style="display: flex; gap: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 6px; ${evt.highlight ? 'border-left: 3px solid #F57600;' : ''}">
                    <span style="font-size: 16px;">${categoryIcons[evt.category] || 'üìå'}</span>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <span style="font-weight: 500; font-size: 13px;">${escapeHtml(evt.title)}</span>
                            <button onclick="deleteEvent('${evt.id}')" style="background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-size: 12px; padding: 0;">‚úï</button>
                        </div>
                        <div style="font-size: 11px; opacity: 0.6; margin-top: 2px;">${new Date(evt.date).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Show log event modal
        function showLogEventModal() {
            document.getElementById('logEventModal').classList.add('active');
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('eventCategory').value = 'milestone';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventHighlight').checked = false;
        }
        
        // Close log event modal
        function closeLogEventModal() {
            document.getElementById('logEventModal').classList.remove('active');
        }
        
        // Save event
        async function saveEvent() {
            const date = document.getElementById('eventDate').value;
            const category = document.getElementById('eventCategory').value;
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const highlight = document.getElementById('eventHighlight').checked;
            
            if (!title) {
                showToast('Please enter an event title', 'error');
                return;
            }
            
            const { quarter, year, key } = getCurrentQuarterInfo();
            
            // Show spinner and disable button
            const btn = document.querySelector('#logEventModal .btn-primary');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;margin-right:8px;"></span> Saving...';
            
            const result = await saveEventToServer({
                quarter,
                year,
                quarterKey: key,
                date,
                category,
                title,
                description,
                highlight
            });
            
            // Restore button
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (result.success) {
                closeLogEventModal();
                await renderQuarterEvents();
                showToast('Event logged successfully', 'success');
            } else {
                showToast('Failed to save event: ' + (result.error || 'Unknown error'), 'error');
            }
        }
        
        // Delete event
        async function deleteEvent(eventId) {
            if (!confirm('Delete this event?')) return;
            
            // Find and disable the delete button
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';
            
            const result = await deleteEventFromServer(eventId);
            
            if (result.success) {
                await renderQuarterEvents();
                showToast('Event deleted', 'info');
            } else {
                btn.disabled = false;
                btn.textContent = originalText;
                showToast('Failed to delete event', 'error');
            }
        }
        
        // Generate investor email
        async function generateInvestorEmail() {
            const { quarter, year, key } = getCurrentQuarterInfo();
            
            document.getElementById('investorEmailModal').classList.add('active');
            document.getElementById('emailQuarter').textContent = quarter;
            document.getElementById('emailYear').textContent = year;
            
            // Show loading states
            document.getElementById('emailEventsList').innerHTML = '<span style="color: #999;">Loading events...</span>';
            document.getElementById('emailPastReferences').innerHTML = '<span style="color: #999;">Loading...</span>';
            document.getElementById('emailMetricsSummary').innerHTML = '<span style="color: #999;">Loading metrics...</span>';
            document.getElementById('emailSubject').value = 'Loading...';
            document.getElementById('emailBody').value = 'Loading data from server...';
            
            // Load events for sidebar
            await loadInvestorEvents();
            const quarterEvents = irEventsCache[key] || [];
            document.getElementById('emailEventCount').textContent = quarterEvents.length;
            
            if (quarterEvents.length > 0) {
                const categoryIcons = {
                    milestone: 'üéØ', client: 'üë•', partnership: 'ü§ù', product: 'üöÄ',
                    team: 'üëî', financial: 'üí∞', recognition: 'üèÜ', challenge: '‚ö†Ô∏è', other: 'üìå'
                };
                document.getElementById('emailEventsList').innerHTML = quarterEvents.map(evt => `
                    <div style="margin-bottom: 6px;">
                        ${categoryIcons[evt.category] || 'üìå'} <strong>${escapeHtml(evt.title)}</strong>
                        ${evt.highlight ? '‚≠ê' : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('emailEventsList').innerHTML = '<span style="color: #999;">No events logged</span>';
            }
            
            // Load past emails for reference sidebar
            await loadEmailHistory();
            if (irEmailsCache.length > 0) {
                document.getElementById('emailPastReferences').innerHTML = irEmailsCache.slice(0, 5).map(email => `
                    <div style="margin-bottom: 4px;">
                        <span style="color: #1A365C;">Q${email.quarter} ${email.year}</span>
                        <span style="color: #999; font-size: 10px;">${email.status}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('emailPastReferences').innerHTML = '<span style="color: #999;">No past emails</span>';
            }
            
            // Load metrics summary
            loadEmailMetricsSummary();
            
            // Generate the email draft
            generateEmailDraft(quarter, year, quarterEvents);
        }
        
        // Load metrics for email sidebar
        function loadEmailMetricsSummary() {
            const metricsEl = document.getElementById('emailMetricsSummary');
            
            if (window.ltvData) {
                const d = window.ltvData;
                metricsEl.innerHTML = `
                    <div>‚Ä¢ <strong>LTV:</strong> $${formatNumber(d.arpu * 0.7 * (1/d.churnRate))}</div>
                    <div>‚Ä¢ <strong>ARPU:</strong> $${formatNumber(d.arpu)}/mo</div>
                    <div>‚Ä¢ <strong>Churn:</strong> ${(d.churnRate * 100).toFixed(1)}%</div>
                    <div>‚Ä¢ <strong>Total Clients:</strong> ${d.totalClients}</div>
                    <div>‚Ä¢ <strong>Active Clients:</strong> ${d.activeClients}</div>
                    <div>‚Ä¢ <strong>Avg Retention:</strong> ${d.avgRetention?.toFixed(1) || '--'} mo</div>
                    <div>‚Ä¢ <strong>Total Revenue:</strong> $${formatNumber(d.totalRevenue)}</div>
                `;
            } else {
                metricsEl.innerHTML = '<span style="color: #999;">Metrics not loaded. Visit Client Insights first.</span>';
            }
        }
        
        // Generate email draft content
        function generateEmailDraft(quarter, year, events) {
            const quarterName = ['Q1 (Jan-Mar)', 'Q2 (Apr-Jun)', 'Q3 (Jul-Sep)', 'Q4 (Oct-Dec)'][quarter - 1];
            
            // Get metrics
            let metricsText = '';
            if (window.ltvData) {
                const d = window.ltvData;
                const ltv = d.arpu * 0.7 * (1/d.churnRate);
                metricsText = `
Key Metrics:
‚Ä¢ Customer Lifetime Value (LTV): $${formatNumber(ltv)}
‚Ä¢ Monthly ARPU: $${formatNumber(d.arpu)}
‚Ä¢ Monthly Churn Rate: ${(d.churnRate * 100).toFixed(1)}%
‚Ä¢ Total Clients: ${d.totalClients} (${d.activeClients} active)
‚Ä¢ Average Client Retention: ${d.avgRetention?.toFixed(1) || '--'} months
‚Ä¢ Total Lifetime Revenue: $${formatNumber(d.totalRevenue)}`;
            }
            
            // Format events
            let eventsText = '';
            const highlights = events.filter(e => e.highlight);
            const others = events.filter(e => !e.highlight);
            
            if (highlights.length > 0) {
                eventsText += '\n\nKey Highlights:\n' + highlights.map(e => `‚Ä¢ ${e.title}: ${e.description || ''}`).join('\n');
            }
            if (others.length > 0) {
                eventsText += '\n\nOther Updates:\n' + others.map(e => `‚Ä¢ ${e.title}${e.description ? ': ' + e.description : ''}`).join('\n');
            }
            
            // Set subject
            document.getElementById('emailSubject').value = `Alice Care ${quarterName} ${year} Investor Update`;
            
            // Set body
            const emailBody = `Dear Investors,

I hope this message finds you well. I'm pleased to share our ${quarterName} ${year} update for Alice Care.

EXECUTIVE SUMMARY
[Add 2-3 sentence summary of the quarter]
${metricsText}
${eventsText || '\n[No events logged for this quarter]'}

LOOKING AHEAD
[Add outlook for next quarter and key priorities]

Thank you for your continued support and partnership.

Best regards,
[Your Name]
Alice Care

---
This update contains confidential information intended for investors only.`;

            document.getElementById('emailBody').value = emailBody;
        }
        
        // Regenerate email
        async function regenerateEmail() {
            const btn = document.querySelector('#investorEmailModal button[onclick="regenerateEmail()"]');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Regenerating...';
            }
            
            const { quarter, year, key } = getCurrentQuarterInfo();
            await loadInvestorEvents();
            const quarterEvents = irEventsCache[key] || [];
            generateEmailDraft(quarter, year, quarterEvents);
            
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Regenerate Draft';
            }
            showToast('Email draft regenerated', 'info');
        }
        
        // Close investor email modal
        function closeInvestorEmailModal() {
            document.getElementById('investorEmailModal').classList.remove('active');
        }
        
        // Handle past email upload (kept for reference documents)
        function handlePastEmailUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Extract quarter/year from filename first (e.g., "Q3_2024_update.txt")
            const filename = file.name.replace(/\.[^/.]+$/, '');
            let quarter = null;
            let year = null;
            
            const quarterMatch = filename.match(/Q(\d)[-_\s]?(\d{4})/i);
            if (quarterMatch) {
                quarter = parseInt(quarterMatch[1]);
                year = parseInt(quarterMatch[2]);
            }
            
            // If not found in filename, prompt user
            if (!quarter || !year) {
                const currentQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
                const currentYear = new Date().getFullYear();
                const quarterInput = prompt(
                    `Enter quarter and year for "${file.name}" (e.g., Q3 2024):`,
                    `Q${currentQuarter} ${currentYear}`
                );
                if (!quarterInput) return;
                
                const match = quarterInput.match(/Q(\d)\s*(\d{4})/i);
                if (!match) {
                    showToast('Invalid format. Use Q1 2024 format.', 'error');
                    return;
                }
                quarter = parseInt(match[1]);
                year = parseInt(match[2]);
            }
            
            const key = `Q${quarter}-${year}`;
            
            // Show uploading state
            document.getElementById('emailPastReferences').innerHTML = '<span style="color: #999;">‚è≥ Uploading...</span>';
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result;
                
                // Use filename as subject (clean it up)
                let subject = filename
                    .replace(/Q\d[-_\s]?\d{4}[-_\s]?/i, '') // Remove quarter-year
                    .replace(/[-_]/g, ' ')  // Replace dashes/underscores with spaces
                    .trim();
                
                if (!subject) {
                    subject = `Q${quarter} ${year} Investor Update`;
                }
                
                // Try to extract subject from email content if present
                const subjectMatch = content.match(/Subject:\s*(.+)/i);
                if (subjectMatch) subject = subjectMatch[1].trim();
                
                const result = await saveEmailToServer({
                    quarter,
                    year,
                    quarterKey: key,
                    subject,
                    body: content,
                    status: 'imported'
                });
                
                if (result.success) {
                    showToast('Past email uploaded successfully', 'success');
                    // Refresh past references
                    await loadEmailHistory();
                    if (irEmailsCache.length > 0) {
                        document.getElementById('emailPastReferences').innerHTML = irEmailsCache.slice(0, 5).map(email => `
                            <div style="margin-bottom: 4px;">
                                <span style="color: #1A365C;">Q${email.quarter} ${email.year}</span>
                                <span style="color: #999; font-size: 10px;">${email.status}</span>
                            </div>
                        `).join('');
                    }
                } else {
                    document.getElementById('emailPastReferences').innerHTML = '<span style="color: #999;">Upload failed: ' + (result.error || 'Unknown error') + '</span>';
                    showToast('Failed to upload email: ' + (result.error || 'Unknown error'), 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Save draft email
        async function saveDraftEmail() {
            const { quarter, year, key } = getCurrentQuarterInfo();
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            
            // Find and disable the save draft button
            const btn = document.getElementById('btnSaveDraft');
            if (!btn) return;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:12px;height:12px;border-width:2px;margin-right:6px;display:inline-block;"></span> Saving...';
            
            const result = await saveEmailToServer({
                quarter,
                year,
                quarterKey: key,
                subject,
                body,
                status: 'draft'
            });
            
            // Restore button
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            if (result.success) {
                showToast('Draft saved to server', 'success');
            } else {
                showToast('Failed to save draft', 'error');
            }
        }
        
        // Mark email as sent
        async function markEmailSent() {
            const { quarter, year, key } = getCurrentQuarterInfo();
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            
            if (!confirm('Mark this email as sent? This will save it to your history.')) return;
            
            // Find and disable all footer buttons
            const btn = document.getElementById('btnMarkSent');
            const btnSave = document.getElementById('btnSaveDraft');
            const btnCopy = document.getElementById('btnCopyEmail');
            
            if (!btn) return;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:12px;height:12px;border-width:2px;margin-right:6px;display:inline-block;"></span> Saving...';
            if (btnSave) btnSave.disabled = true;
            if (btnCopy) btnCopy.disabled = true;
            
            const result = await saveEmailToServer({
                quarter,
                year,
                quarterKey: key,
                subject,
                body,
                status: 'sent'
            });
            
            // Restore buttons
            btn.disabled = false;
            btn.innerHTML = originalText;
            if (btnSave) btnSave.disabled = false;
            if (btnCopy) btnCopy.disabled = false;
            
            if (result.success) {
                closeInvestorEmailModal();
                showToast('Email marked as sent and saved to history', 'success');
            } else {
                showToast('Failed to save email', 'error');
            }
        }
        
        // Copy email to clipboard
        function copyEmailToClipboard() {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            
            const fullText = `Subject: ${subject}\n\n${body}`;
            
            navigator.clipboard.writeText(fullText).then(() => {
                showToast('Email copied to clipboard', 'success');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = fullText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Email copied to clipboard', 'success');
            });
        }
        
        // Show email history modal
        async function showEmailHistoryModal() {
            document.getElementById('emailHistoryModal').classList.add('active');
            document.getElementById('emailHistoryList').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                    Loading email history...
                </div>
            `;
            await renderEmailHistory();
        }
        
        // Close email history modal
        function closeEmailHistoryModal() {
            document.getElementById('emailHistoryModal').classList.remove('active');
        }
        
        // Render email history
        async function renderEmailHistory() {
            const listEl = document.getElementById('emailHistoryList');
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading...</div>';
            
            await loadEmailHistory();
            
            if (irEmailsCache.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        No email history yet.<br>
                        <span style="font-size: 12px;">Generate your first investor update or import past emails.</span>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = irEmailsCache.map((email, idx) => `
                <div style="background: white; border: 1px solid #E5ECF3; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <span style="background: #1A365C; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">Q${email.quarter} ${email.year}</span>
                            <span style="margin-left: 10px; font-size: 12px; color: ${email.status === 'sent' ? '#059669' : (email.status === 'imported' ? '#6366F1' : '#F57600')};">
                                ${email.status === 'sent' ? '‚úì Sent' : (email.status === 'imported' ? 'üì• Imported' : 'üìù Draft')}
                            </span>
                        </div>
                        <span style="font-size: 11px; color: #999;">${new Date(email.sentAt || email.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div style="font-weight: 600; color: #1A365C; margin-bottom: 8px;">${escapeHtml(email.subject)}</div>
                    <div style="font-size: 12px; color: #666; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                        ${escapeHtml((email.body || '').substring(0, 200))}...
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="viewHistoryEmail('${email.id}')" style="background: #E5ECF3; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            üëÅÔ∏è View
                        </button>
                        <button onclick="editHistoryEmail('${email.id}')" style="background: #E5ECF3; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="deleteHistoryEmail('${email.id}')" style="background: #FEE2E2; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; color: #991B1B;">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // View history email
        function viewHistoryEmail(emailId) {
            const email = irEmailsCache.find(e => e.id.toString() === emailId.toString());
            if (!email) return;
            
            closeEmailHistoryModal();
            document.getElementById('investorEmailModal').classList.add('active');
            document.getElementById('emailQuarter').textContent = email.quarter;
            document.getElementById('emailYear').textContent = email.year;
            document.getElementById('emailSubject').value = email.subject;
            document.getElementById('emailBody').value = email.body;
            loadEmailMetricsSummary();
            
            // Load events for that quarter
            const quarterEvents = irEventsCache[email.quarterKey] || [];
            document.getElementById('emailEventCount').textContent = quarterEvents.length;
        }
        
        // Edit history email
        function editHistoryEmail(emailId) {
            viewHistoryEmail(emailId);
        }
        
        // Delete history email
        async function deleteHistoryEmail(emailId) {
            if (!confirm('Delete this email from history?')) return;
            
            // Show loading in the list
            const listEl = document.getElementById('emailHistoryList');
            const originalHtml = listEl.innerHTML;
            
            // Find and update the specific card
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥';
            
            const result = await deleteEmailFromServer(emailId);
            
            if (result.success) {
                await renderEmailHistory();
                showToast('Email deleted from history', 'info');
            } else {
                btn.disabled = false;
                btn.innerHTML = 'üóëÔ∏è Delete';
                showToast('Failed to delete email', 'error');
            }
        }
        
        // Import past emails (bulk upload supported)
        async function importPastEmails(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            // Show loading in history list
            const listEl = document.getElementById('emailHistoryList');
            listEl.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                    Importing ${files.length} file(s)...
                </div>
            `;
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Extract quarter/year from filename (e.g., "Q3_2024_update.txt" or "Q3-2024.eml")
                const filename = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
                let quarter = null;
                let year = null;
                
                // Try to parse quarter from filename
                const quarterMatch = filename.match(/Q(\d)[-_\s]?(\d{4})/i);
                if (quarterMatch) {
                    quarter = parseInt(quarterMatch[1]);
                    year = parseInt(quarterMatch[2]);
                }
                
                // If not found in filename, prompt for first file only or use current
                if (!quarter || !year) {
                    if (i === 0 || files.length === 1) {
                        const quarterInput = prompt(
                            `Enter quarter and year for "${file.name}" (e.g., Q3 2024):`,
                            `Q${Math.ceil((new Date().getMonth() + 1) / 3)} ${new Date().getFullYear()}`
                        );
                        if (!quarterInput) {
                            errorCount++;
                            continue;
                        }
                        const match = quarterInput.match(/Q(\d)\s*(\d{4})/i);
                        if (!match) {
                            showToast(`Invalid format for ${file.name}. Skipped.`, 'error');
                            errorCount++;
                            continue;
                        }
                        quarter = parseInt(match[1]);
                        year = parseInt(match[2]);
                    } else {
                        // For bulk, skip files without quarter in filename
                        showToast(`Skipped ${file.name} - no quarter found in filename`, 'warning');
                        errorCount++;
                        continue;
                    }
                }
                
                // Read file content
                try {
                    const content = await readFileAsText(file);
                    
                    // Use filename as subject (clean it up)
                    let subject = filename
                        .replace(/Q\d[-_\s]?\d{4}[-_\s]?/i, '') // Remove quarter-year
                        .replace(/[-_]/g, ' ')  // Replace dashes/underscores with spaces
                        .trim();
                    
                    if (!subject) {
                        subject = `Q${quarter} ${year} Investor Update`;
                    }
                    
                    // Try to extract subject from email content
                    const subjectMatch = content.match(/Subject:\s*(.+)/i);
                    if (subjectMatch) {
                        subject = subjectMatch[1].trim();
                    }
                    
                    const key = `Q${quarter}-${year}`;
                    
                    // Truncate body if too long for JSONP (max ~30KB safe)
                    const maxBodyLength = 30000;
                    let bodyToSave = content;
                    let truncated = false;
                    
                    if (content.length > maxBodyLength) {
                        bodyToSave = content.substring(0, maxBodyLength) + '\n\n[... Content truncated for storage. Full content was ' + content.length + ' characters ...]';
                        truncated = true;
                    }
                    
                    const result = await saveEmailToServer({
                        quarter,
                        year,
                        quarterKey: key,
                        subject,
                        body: bodyToSave,
                        status: 'imported'
                    });
                    
                    if (result.success) {
                        successCount++;
                        if (truncated) {
                            console.log(`Note: ${file.name} was truncated from ${content.length} to ${maxBodyLength} characters`);
                        }
                    } else {
                        errorCount++;
                        console.error(`Failed to import ${file.name}:`, result.error);
                    }
                } catch (err) {
                    errorCount++;
                    console.error(`Error reading ${file.name}:`, err);
                }
            }
            
            // Show results
            if (successCount > 0) {
                showToast(`Imported ${successCount} email(s) successfully${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success');
            } else {
                showToast(`Import failed: ${errorCount} error(s)`, 'error');
            }
            
            // Refresh the list
            await renderEmailHistory();
            event.target.value = '';
        }
        
        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }
        
        // Legacy single file import (kept for backward compatibility)
        function importSingleEmail(event) {
            // Redirect to the bulk import handler
            importPastEmails(event);
        }
    </script>
</body>
</html>