<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="identity-credentials-get=()">
    <title>Business Development Tracker | alicecare</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- ✅ Chart.js for dashboard visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --navy: #1A365C;
            --navy-light: #2D4A6F;
            --navy-dark: #0F2340;
            --orange: #F57600;
            --orange-light: #FF8C1A;
            --orange-dark: #CC6200;
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --info: #3B82F6;
            --info-light: #DBEAFE;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            color: var(--white);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: 700;
        }

        .logo-text {
            display: inline;
        }

        .logo-alice { color: var(--white); }
        .logo-care { color: var(--orange); }
        .logo-subtitle {
            font-size: 12px;
            font-weight: 400;
            opacity: 0.8;
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid rgba(255,255,255,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
        }

        .zone-badge {
            background: var(--orange);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        #signedInSection {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        #signedOutSection {
            display: flex;
            align-items: center;
        }

        /* Navigation */
        .nav-tabs {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 2px;
            padding: 0 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            padding: 14px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-tab:hover { color: var(--navy); background: var(--gray-50); }
        .nav-tab.active { color: var(--navy); border-bottom-color: var(--orange); }
        .nav-tab .badge {
            background: var(--danger);
            color: var(--white);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body { padding: 20px; }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border-radius: var(--radius);
            border: none;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--orange); color: var(--white); }
        .btn-primary:hover { background: var(--orange-dark); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn-navy { background: var(--navy); color: var(--white); }
        .btn-navy:hover { background: var(--navy-dark); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-lg { padding: 14px 28px; font-size: 16px; }
        .btn-block { width: 100%; justify-content: center; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }

        .form-textarea { min-height: 100px; resize: vertical; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--gray-200); vertical-align: middle; }
        th {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            background: var(--gray-50);
        }
        tr:hover td { background: var(--gray-50); }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-active { background: var(--success-light); color: #065F46; }
        .status-pending { background: var(--warning-light); color: #92400E; }
        .status-inactive { background: var(--gray-200); color: var(--gray-600); }
        .status-due { background: var(--danger-light); color: #991B1B; }
        .status-sent { background: var(--info-light); color: #1E40AF; }

        /* Search & Filters */
        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-box input { padding-left: 40px; }
        .search-box .material-icons-outlined {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 20px;
        }

        .filter-select { min-width: 140px; }

        /* Mobile Check-in Card */
        .checkin-card {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 100%);
            color: var(--white);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
        }

        .checkin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .checkin-title {
            font-size: 20px;
            font-weight: 600;
        }

        .checkin-gps {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            opacity: 0.9;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .checkin-gps.active { background: var(--success); }
        .checkin-gps.error { background: var(--danger); }

        .checkin-org-select {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius);
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: var(--white);
            font-size: 16px;
            margin-bottom: 16px;
        }

        .checkin-org-select option { color: var(--gray-800); background: var(--white); }

        .brochure-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .brochure-item {
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 12px;
            text-align: center;
        }

        .brochure-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .brochure-input {
            width: 70px;
            height: 44px;
            border-radius: var(--radius);
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            color: var(--white);
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            font-family: inherit;
        }

        .brochure-input:focus {
            outline: none;
            border-color: var(--orange);
            background: rgba(255,255,255,0.2);
        }

        .brochure-input::-webkit-inner-spin-button,
        .brochure-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .checkin-btn {
            width: 100%;
            padding: 16px;
            background: var(--orange);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checkin-btn:active { background: var(--orange-dark); }
        .checkin-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Email Layout */
        .email-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
            min-height: 500px;
        }

        .email-list {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .email-list-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-list-content { flex: 1; overflow-y: auto; }

        .email-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: all 0.2s;
        }

        .email-item:hover { background: var(--gray-50); }
        .email-item.active { background: var(--info-light); border-left: 3px solid var(--info); }
        .email-item.unread { background: rgba(245, 118, 0, 0.05); }
        .email-item.unread .email-subject { font-weight: 600; }

        .email-from {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-800);
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .email-date { font-size: 11px; color: var(--gray-400); }
        .email-subject {
            font-size: 13px;
            color: var(--gray-700);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .email-snippet {
            font-size: 12px;
            color: var(--gray-500);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .email-org-badge {
            font-size: 10px;
            background: var(--navy);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 6px;
            display: inline-block;
        }

        .email-viewer {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .email-viewer-header { padding: 20px; border-bottom: 1px solid var(--gray-200); }
        .email-viewer-subject { font-size: 18px; font-weight: 600; color: var(--navy); margin-bottom: 12px; }
        .email-viewer-body { flex: 1; padding: 20px; overflow-y: auto; white-space: pre-wrap; font-size: 14px; line-height: 1.7; }
        .email-viewer-actions { padding: 16px 20px; border-top: 1px solid var(--gray-200); display: flex; gap: 12px; }

        .email-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray-400);
        }

        .email-empty .material-icons-outlined { font-size: 64px; margin-bottom: 16px; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-lg { max-width: 800px; }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }

        .modal-title { font-size: 18px; font-weight: 600; color: var(--navy); }
        .modal-close { background: none; border: none; cursor: pointer; color: var(--gray-400); font-size: 28px; line-height: 1; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .stat-icon.orange { background: rgba(245, 118, 0, 0.1); color: var(--orange); }
        .stat-icon.navy { background: rgba(26, 54, 92, 0.1); color: var(--navy); }
        .stat-icon.success { background: var(--success-light); color: var(--success); }
        .stat-icon.warning { background: var(--warning-light); color: var(--warning); }

        .stat-value { font-size: 24px; font-weight: 700; color: var(--navy); }
        .stat-label { font-size: 12px; color: var(--gray-500); }

        /* Template Cards */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .template-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 16px;
            transition: all 0.2s;
        }

        .template-card:hover { border-color: var(--orange); box-shadow: var(--shadow-md); }

        .template-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .template-name { font-weight: 600; color: var(--navy); }
        .template-category {
            font-size: 10px;
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .template-subject { font-size: 13px; color: var(--gray-600); margin-bottom: 8px; }
        .template-preview { font-size: 12px; color: var(--gray-400); line-height: 1.4; }
        .template-actions { margin-top: 12px; display: flex; gap: 8px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            border-radius: var(--radius);
            color: var(--white);
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .toast.show { display: block; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--info); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-overlay.active { display: flex; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Action Buttons */
        .action-btns { display: flex; gap: 4px; }
        .action-btn {
            padding: 6px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .action-btn:hover { background: var(--gray-100); color: var(--navy); }
        .action-btn.danger:hover { background: var(--danger-light); color: var(--danger); }

        .clickable-row { cursor: pointer; }
        .clickable-row:hover td { background: rgba(245, 118, 0, 0.05); }

        /* Responsive */
        @media (max-width: 1024px) {
            .email-layout { grid-template-columns: 1fr; height: auto; }
            .email-viewer { display: none; min-height: 400px; }
            .email-viewer.active { display: flex; }
        }

        @media (max-width: 768px) {
            .header { padding: 0 16px; height: 56px; }
            .logo { font-size: 20px; }
            .logo-subtitle { display: none; }
            .nav-tabs { padding: 0 12px; }
            .nav-tab { padding: 12px 10px; font-size: 12px; }
            .nav-tab span.material-icons-outlined { font-size: 18px; }
            .main-content { padding: 12px; }
            .card-header { padding: 14px 16px; }
            .card-body { padding: 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stat-card { padding: 14px; }
            .stat-value { font-size: 20px; }
            .brochure-grid { grid-template-columns: repeat(2, 1fr); }
            .modal { margin: 10px; max-height: calc(100vh - 20px); }
        }

        /* Template Selector in Compose */
        .template-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: var(--radius);
            border-bottom: 1px solid var(--gray-200);
            align-items: center;
        }

        .template-selector:empty { display: none; }

        /* Quill Editor Customization */
        .ql-container { font-family: inherit; font-size: 14px; }
        .ql-editor { min-height: 150px; }
        .ql-toolbar { background: var(--gray-50); border-color: var(--gray-300); border-radius: var(--radius) var(--radius) 0 0; }
        .ql-container { border-color: var(--gray-300); border-radius: 0 0 var(--radius) var(--radius); }
        .ql-editor:focus { outline: none; }
        .ql-editor.ql-blank::before { color: var(--gray-400); font-style: normal; }
        
        /* Variable Insert Section */
        .variable-insert-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 12px;
            margin-top: 12px;
        }
        
        .variable-label {
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .variable-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .variable-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
            color: var(--navy);
            transition: all 0.2s;
        }
        
        .variable-btn:hover {
            background: var(--orange);
            color: var(--white);
            border-color: var(--orange);
            transform: translateY(-1px);
        }
        
        .variable-btn:active {
            transform: translateY(0);
        }
        
        .custom-variable-row {
            display: flex;
            gap: 8px;
            align-items: center;
            padding-top: 10px;
            border-top: 1px dashed var(--gray-300);
        }
        
        .custom-variable-row .form-input {
            font-size: 13px;
            padding: 8px 12px;
        }
        
        .subject-with-vars {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .subject-with-vars .form-select {
            font-size: 12px;
            color: var(--orange);
            border-color: var(--orange);
        }
        
        /* Custom Variables Section in Compose */
        .custom-vars-section {
            background: linear-gradient(135deg, var(--warning-light) 0%, #FFF9E6 100%);
            border: 1px solid var(--warning);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .custom-vars-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 12px;
        }
        
        .custom-vars-header .material-icons-outlined {
            font-size: 20px;
        }
        
        .custom-vars-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .custom-var-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .custom-var-input-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .custom-var-input-group input {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }
        
        .custom-var-input-group input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        /* Settings Page */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .setting-item:last-child { border-bottom: none; }
        
        .setting-info { flex: 1; }
        .setting-label { font-weight: 500; color: var(--gray-800); margin-bottom: 4px; }
        .setting-desc { font-size: 12px; color: var(--gray-500); }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }
        
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--gray-300);
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .toggle-switch input:checked + .toggle-slider { background: var(--success); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        
        .setting-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }
        
        .setting-list-item:hover { background: var(--gray-100); }
        
        .setting-list-item-name {
            font-weight: 500;
            color: var(--gray-800);
        }
        
        .setting-list-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .setting-list-item-actions button {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        /* Assets Page */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .asset-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .asset-card:hover { box-shadow: var(--shadow-md); }
        .asset-card.low-stock { border-color: var(--danger); background: var(--danger-light); }
        
        .asset-card-icon {
            width: 50px;
            height: 50px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            color: var(--navy);
        }
        
        .asset-card.low-stock .asset-card-icon { background: var(--danger); color: white; }
        
        .asset-card-name { font-weight: 600; color: var(--navy); margin-bottom: 4px; }
        .asset-card-qty { font-size: 28px; font-weight: 700; color: var(--gray-800); }
        .asset-card.low-stock .asset-card-qty { color: var(--danger); }
        .asset-card-threshold { font-size: 11px; color: var(--gray-500); margin-top: 4px; }
        
        .asset-card-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, var(--danger-light) 0%, #FFF0F0 100%);
            border: 1px solid var(--danger);
            border-radius: var(--radius);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--danger);
        }
        
        .alert-banner .material-icons-outlined { font-size: 24px; }
        .alert-banner span { flex: 1; font-weight: 500; }
        
        /* Category Headers */
        .checkin-category-header {
            grid-column: 1 / -1;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 0 4px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 4px;
        }
        
        .asset-category-section {
            margin-bottom: 24px;
        }
        
        .asset-category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
            padding: 12px 0;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 16px;
        }
        
        .asset-category-header .material-icons-outlined {
            color: var(--orange);
        }
        
        .assets-grid-inner {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .low-stock-item {
            background: var(--danger-light) !important;
            border-color: var(--danger) !important;
        }
        
        /* Zone Selector */
        .zone-selector {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 12px;
        }
        
        .zone-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 0;
        }
        
        .zone-checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .zone-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--gray-200);
        }
        
        .zone-checkboxes label {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 6px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            cursor: pointer;
            font-size: 13px;
        }
        
        .zone-checkboxes label:has(input:checked) {
            background: var(--primary-light);
            border-color: var(--navy);
        }
        
        .zone-checkboxes.disabled label {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .zone-tags {
            display: inline-flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .zone-tag {
            display: inline-block;
            background: var(--gray-100);
            color: var(--gray-600);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .zone-tag.all-zones {
            background: var(--success-light);
            color: var(--success);
        }
        
        /* Directory Layout */
        .directory-container {
            display: flex;
            height: calc(100vh - 180px);
            position: relative;
            overflow: hidden;
        }
        
        .directory-list-panel {
            flex: 1;
            overflow: auto;
            transition: margin-right 0.3s ease;
        }
        
        .directory-list-panel .card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .directory-list-panel .card-body {
            flex: 1;
            overflow: auto;
        }
        
        .directory-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* Searchable Select Dropdown */
        .searchable-select {
            position: relative;
        }
        
        .searchable-input {
            cursor: pointer;
        }
        
        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .select-options.show {
            display: block;
        }
        
        .select-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .select-option:hover {
            background: var(--gray-50);
        }
        
        .select-option.selected {
            background: var(--primary-light);
            color: var(--navy);
        }
        
        /* Sortable Table Headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        
        .sortable-header:hover {
            background: var(--gray-100);
        }
        
        .sort-icon::after {
            content: '⇅';
            margin-left: 4px;
            opacity: 0.3;
            font-size: 12px;
        }
        
        .sortable-header.sort-asc .sort-icon::after {
            content: '↑';
            opacity: 1;
        }
        
        .sortable-header.sort-desc .sort-icon::after {
            content: '↓';
            opacity: 1;
        }
        
        .directory-detail-panel {
            position: absolute;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100%;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .directory-detail-panel.open {
            right: 0;
        }
        
        .directory-container.detail-open .directory-list-panel {
            margin-right: 500px;
        }
        
        .detail-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .detail-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .detail-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .detail-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--navy), var(--orange));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
        }
        
        .detail-icon.contact-icon {
            background: linear-gradient(135deg, var(--orange), #ff8c42);
        }
        
        .detail-info h2 {
            font-size: 20px;
            color: var(--navy);
            margin: 0 0 4px;
        }
        
        .detail-info .subtitle {
            color: var(--gray-500);
            font-size: 14px;
        }
        
        .detail-section {
            margin-bottom: 24px;
        }
        
        .detail-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .detail-field {
            background: var(--gray-50);
            padding: 10px 12px;
            border-radius: var(--radius);
        }
        
        .detail-field-label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .detail-field-value {
            font-size: 14px;
            color: var(--navy);
        }
        
        .detail-field.full-width {
            grid-column: 1 / -1;
        }
        
        /* Contact mini cards in org detail */
        .contact-mini-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .contact-mini-card:hover {
            background: var(--primary-light);
        }
        
        .contact-mini-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .contact-mini-info {
            flex: 1;
        }
        
        .contact-mini-name {
            font-weight: 500;
            color: var(--navy);
        }
        
        .contact-mini-title {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        /* Activity timeline */
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .activity-icon.visit { background: var(--success-light); color: var(--success); }
        .activity-icon.email { background: var(--info-light); color: var(--info); }
        .activity-icon.note { background: var(--warning-light); color: var(--warning); }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: var(--navy);
            font-size: 13px;
        }
        
        .activity-meta {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        /* Last visit date colors */
        .visit-date-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .visit-recent { background: var(--success-light); color: var(--success); }
        .visit-moderate { background: var(--warning-light); color: var(--warning); }
        .visit-overdue { background: var(--danger-light); color: var(--danger); }
        .visit-never { background: var(--gray-100); color: var(--gray-500); }
        
        /* Directory table enhancements */
        #directoryTable .type-cell {
            width: 40px;
        }
        
        #directoryTable .type-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        #directoryTable .type-icon.org { background: var(--primary-light); color: var(--navy); }
        #directoryTable .type-icon.contact { background: var(--warning-light); color: var(--orange); }
        
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: var(--gray-100); }
        
        .low-stock-row { background: var(--danger-light); }
        .low-stock-row:hover { background: #ffcdd2; }
        
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: var(--gray-50); }
        
        @media (max-width: 1200px) {
            .directory-detail-panel {
                width: 100%;
                right: -100%;
            }
            .directory-container.detail-open .directory-list-panel {
                margin-right: 0;
                display: none;
            }
        }

        .template-pill {
            padding: 6px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: var(--white);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .template-pill:hover { border-color: var(--orange); color: var(--orange); }
        .template-pill.active { background: var(--orange); color: var(--white); border-color: var(--orange); }
        
        /* LOGIN GATE */
        .login-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--navy) 0%, #1a3a4d 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .login-gate.hidden {
            display: none;
            opacity: 0;
            pointer-events: none;
        }
        
        .login-gate-content {
            text-align: center;
            color: white;
        }
        
        .login-gate-logo {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }
        
        .login-gate-logo .logo-alice {
            color: var(--orange);
        }
        
        .login-gate-subtitle {
            font-size: 16px;
            margin-bottom: 50px;
            opacity: 0.9;
        }
        
        .login-gate-button {
            background: var(--orange);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }
        
        .login-gate-button:hover {
            background: #ff8c00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.3);
        }

        /* ============================================
           ROUTE PLANNER STYLES
           ============================================ */

        .route-planner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .route-planner-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            transition: background 0.2s;
        }

        .route-planner-header:hover {
            background: rgba(0,0,0,0.1);
        }

        .route-planner-toggle {
            display: inline-block;
            transition: transform 0.3s;
            font-size: 16px;
        }

        .route-planner-toggle.open {
            transform: rotate(90deg);
        }

        .route-planner-content {
            padding: 0 20px 20px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .route-planner h3 {
            margin: 0;
            font-size: 18px;
            display: inline;
        }

        .route-planner-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .route-planner-controls > div {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .route-planner-controls select,
        .route-planner-controls input {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            font-family: inherit;
        }

        .route-planner-controls label {
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .route-planner-controls button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .route-planner-controls button:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .route-planner-controls button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .route-planner-controls button:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .route-city-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .route-city-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            margin-bottom: 4px;
        }

        .route-city-checkbox:hover {
            background: #efefef;
            border-color: #667eea;
        }

        .route-city-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .route-city-checkbox input[type="checkbox"]:checked {
            accent-color: #28a745;
        }

        .route-city-checkbox label {
            cursor: pointer;
            margin: 0;
            font-size: 14px;
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .route-city-checkbox input[type="checkbox"]:checked + label {
            color: #28a745;
            font-weight: 600;
        }

        .route-results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            color: #333;
            margin-top: 15px;
        }

        .route-results h4 {
            margin-top: 0;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .route-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: #e7f3ff;
            color: #0066cc;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .route-stops-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
        }

        .route-stop {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .route-stop:hover {
            background: #f8f9fa;
            border-radius: 6px;
        }

        .route-stop:last-child {
            border-bottom: none;
        }

        .route-stop-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .route-stop-content {
            flex: 1;
        }

        .route-stop-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            color: #333;
        }

        .route-stop-details {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr;
            gap: 10px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .detail-address,
        .detail-time,
        .detail-overdue {
            color: #666;
        }

        .route-stop-footer {
            font-size: 12px;
            color: #999;
        }

        .phone-link {
            color: #0066cc;
            cursor: pointer;
            text-decoration: none;
        }

        .phone-link:hover {
            text-decoration: underline;
        }

        .route-stop-include {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 10px;
            flex-shrink: 0;
        }

        .route-results button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .route-results button:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .route-planner-controls {
                grid-template-columns: 1fr;
            }
            
            .route-stop-details {
                grid-template-columns: 1fr;
            }
            
            .route-stop {
                flex-direction: column;
                align-items: stretch;
            }
            
            .route-stop-number {
                align-self: flex-start;
            }
        }

    </style>
</head>
<body>
    <!-- LOGIN GATE (shown until user signs in) -->
    <div id="loginGate" class="login-gate">
        <div class="login-gate-content">
            <div class="login-gate-logo">
                <span style="color: var(--orange);">alice.</span><span>care</span>
            </div>
            <div class="login-gate-subtitle">Business Development Tracker</div>
            <div id="googleSignInBtnGate" class="login-gate-button" style="margin-top: 30px;">
                <span class="material-icons-outlined">login</span>
                <span>Sign in with Google</span>
            </div>
        </div>
    </div>
    
    <!-- MAIN APP (hidden until login) -->
    <div id="mainApp" style="display: none;">
    
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-text"><span class="logo-alice">alice.</span><span class="logo-care">care</span></span>
            <span class="logo-subtitle">Business Development</span>
        </div>
        <div class="user-info">
            <div id="signedInSection" style="display: none;">
                <div class="user-badge">
                    <span class="material-icons-outlined">person</span>
                    <span id="userName">Loading...</span>
                    <span class="zone-badge" id="userZones">--</span>
                </div>
                <button class="btn btn-sm" onclick="googleSignOut()" title="Sign out" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                    <span class="material-icons-outlined" style="font-size: 18px;">logout</span>
                </button>
            </div>
            <div id="signedOutSection">
                <button id="googleSignInBtn" class="btn btn-sm" style="background: white; color: var(--navy); font-weight: 600;">
                    <span class="material-icons-outlined" style="font-size: 18px;">login</span>
                    Sign in with Google
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <button class="nav-tab active" data-tab="checkin">
            <span class="material-icons-outlined">login</span>
            <span>Check-In</span>
        </button>
        <button class="nav-tab" data-tab="dashboard">
            <span class="material-icons-outlined">dashboard</span>
            <span>Dashboard</span>
        </button>
        <button class="nav-tab" data-tab="directory">
            <span class="material-icons-outlined">folder_shared</span>
            <span>Directory</span>
        </button>
        <button class="nav-tab" data-tab="visits">
            <span class="material-icons-outlined">place</span>
            <span>Visits</span>
        </button>
        <button class="nav-tab" data-tab="emails">
            <span class="material-icons-outlined">email</span>
            <span>Emails</span>
            <span class="badge" id="unreadBadge" style="display:none;">0</span>
        </button>
        <button class="nav-tab" data-tab="assets">
            <span class="material-icons-outlined">inventory_2</span>
            <span>Assets</span>
            <span class="badge" id="lowStockBadge" style="display:none;">0</span>
        </button>
        <button class="nav-tab" data-tab="settings">
            <span class="material-icons-outlined">settings</span>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Tab -->
        <div class="tab-content" id="tab-dashboard">
            <!-- Key Metrics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon orange"><span class="material-icons-outlined">business</span></div>
                    <div class="stat-value" id="statOrgs">0</div>
                    <div class="stat-label">Organizations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon navy"><span class="material-icons-outlined">event</span></div>
                    <div class="stat-value" id="statVisitsMonth">0</div>
                    <div class="stat-label">Visits This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning"><span class="material-icons-outlined">schedule</span></div>
                    <div class="stat-value" id="statDue">0</div>
                    <div class="stat-label">Due for Visit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success"><span class="material-icons-outlined">inventory_2</span></div>
                    <div class="stat-value" id="statBrochures">0</div>
                    <div class="stat-label">Brochures Dropped</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><span class="material-icons-outlined">person_add</span></div>
                    <div class="stat-value" id="statContacts">0</div>
                    <div class="stat-label">Total Contacts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><span class="material-icons-outlined">trending_up</span></div>
                    <div class="stat-value" id="statVisitsYear">0</div>
                    <div class="stat-label">Visits This Year</div>
                </div>
            </div>

            <!-- ✅ DASHBOARD FILTERS -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">filter_alt</span> Dashboard Filters</h2>
                </div>
                <div class="card-body" style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                    <div style="flex: 1; min-width: 250px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Zones:</label>
                        <div id="zoneFilterCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                            <!-- Zone checkboxes will be rendered here -->
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="applyDashboardFilters()">Apply Filters</button>
                        <button class="btn btn-secondary" onclick="resetDashboardFilters()">Reset All</button>
                    </div>
                </div>
            </div>

            <!-- ✅ ORGANIZATION CHART CONTROLS -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: flex-end;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="radio" name="orgChartView" value="top5" onchange="updateOrganizationsChart()">
                    <span>Top 5</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="radio" name="orgChartView" value="top10" onchange="updateOrganizationsChart()" checked>
                    <span>Top 10</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="radio" name="orgChartView" value="all" onchange="updateOrganizationsChart()">
                    <span>All</span>
                </label>
            </div>

            <!-- ✅ CHARTS SECTION -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Monthly Trends Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">trending_up</span> Visit Trends - Last 6 Months</h2>
                    </div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>

                <!-- Organizations Pie Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">pie_chart</span> Organizations by Type</h2>
                    </div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="organizationsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weekly and Monthly Comparison -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Weekly Activity Chart -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">calendar_today</span> This Week's Activity</h2>
                    </div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Comparison -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">bar_chart</span> Month Comparison</h2>
                    </div>
                    <div class="card-body" style="position: relative; height: 300px;">
                        <canvas id="monthlyComparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Enhanced Activity Timeline -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">history</span> Recent Activity Timeline</h2>
                </div>
                <div class="card-body">
                    <div id="activityTimelineContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                        <div style="color: var(--gray-400); text-align: center; padding: 40px; grid-column: 1/-1;">Loading activity...</div>
                    </div>
                </div>
            </div>

            <!-- Zone Performance -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">insights</span> Zone Performance</h2>
                </div>
                <div class="card-body">
                    <div id="zonePerformanceContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <!-- Zone stats will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Due for Visit Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">warning</span> Due for Visit</h2>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="dueOrgsTable">
                            <thead><tr><th>Organization</th><th>Type</th><th>Zone</th><th>Last Visit</th><th>Due Date</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check-In Tab (Mobile Friendly) -->
        <div class="tab-content active" id="tab-checkin">
            <div class="checkin-card">
                <div class="checkin-header">
                    <div class="checkin-title">Visit Check-In</div>
                    <div class="checkin-gps" id="gpsStatus">
                        <span class="material-icons-outlined">location_searching</span>
                        <span>Getting GPS...</span>
                    </div>
                </div>

                <!-- ✅ NEW: Searchable Organization Input for Check-In -->
                <div style="position: relative; margin-bottom: 16px;">
                    <input type="text" class="checkin-org-select" id="checkinOrgSearch" placeholder="Search and select organization..." oninput="filterCheckinOrganizations()" style="width: 100%;" autocomplete="off">
                    <div id="checkinOrgSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-top: none; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; border-radius: 0 0 4px 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                </div>
                <input type="hidden" id="checkinOrg">

                <div class="brochure-grid" id="checkinAssetsGrid">
                    <!-- Dynamic assets will be rendered here -->
                </div>

                <select class="checkin-org-select" id="checkinOutcome" style="margin-bottom: 16px;">
                    <option value="Not Available - Left Materials">Not Available - Left Materials</option>
                    <option value="Interested - Schedule Follow-up">Interested - Schedule Follow-up</option>
                    <option value="Meeting Scheduled">Meeting Scheduled</option>
                    <option value="Referral Received">Referral Received</option>
                    <option value="Not Interested">Not Interested</option>
                </select>

                <button class="checkin-btn" onclick="submitCheckin()" id="checkinBtn">
                    <span class="material-icons-outlined">check_circle</span>
                    Complete Check-In
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">history</span> Today's Visits</h2>
                </div>
                <div class="card-body">
                    <div id="todayVisits" style="color: var(--gray-400); text-align: center; padding: 20px;">No visits logged today</div>
                </div>
            </div>
        </div>

        <!-- Directory Tab (Organizations & Contacts Combined) -->
        <div class="tab-content" id="tab-directory">
            <div class="directory-container">
                <!-- Directory List Panel -->
                <div class="directory-list-panel" id="directoryListPanel">
                    <div class="card">
                        <div class="card-header" style="justify-content: flex-start; flex-wrap: wrap; gap: 12px;">
                            <h2 class="card-title"><span class="material-icons-outlined">folder_shared</span> Directory</h2>
                            <div class="directory-toolbar">
                                <div class="search-box" style="min-width: 200px;">
                                    <span class="material-icons-outlined">search</span>
                                    <input type="text" class="form-input" id="directorySearch" placeholder="Search..." oninput="renderDirectory()">
                                </div>
                                <div class="searchable-select" style="min-width: 120px;">
                                    <input type="text" class="form-input searchable-input" id="directoryZoneInput" placeholder="Zone" onfocus="showSelectOptions('directoryZone')" oninput="filterSelectOptions('directoryZone')">
                                    <input type="hidden" id="directoryZoneFilter" value="">
                                    <div class="select-options" id="directoryZoneOptions"></div>
                                </div>
                                <select class="form-select" id="directoryOrgTypeFilter" onchange="renderDirectory()" style="min-width: 140px;">
                                    <option value="">All Org Types</option>
                                </select>
                                <select class="form-select" id="directoryTypeFilter" onchange="renderDirectory()" style="min-width: 100px;">
                                    <option value="">All Types</option>
                                    <option value="org">Orgs</option>
                                    <option value="contact">Contacts</option>
                                </select>
                                <select class="form-select" id="directorySortBy" onchange="renderDirectory()" style="min-width: 120px;">
                                    <option value="name">Sort: Name</option>
                                    <option value="lastVisit">Sort: Last Visit</option>
                                    <option value="zone">Sort: Zone</option>
                                </select>
                                <button class="btn btn-primary btn-sm" onclick="openOrgModal()" title="Add Organization">
                                    <span class="material-icons-outlined">add_business</span>
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="openContactModal()" title="Add Contact">
                                    <span class="material-icons-outlined">person_add</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div class="table-container">
                                <table id="directoryTable" class="sortable-table">
                                    <thead>
                                        <tr>
                                            <th class="sortable-header" data-sort="name" onclick="sortDirectory('name')">Name <span class="sort-icon"></span></th>
                                            <th>Organization</th>
                                            <th class="sortable-header" data-sort="zone" onclick="sortDirectory('zone')">Zone <span class="sort-icon"></span></th>
                                            <th>Contact Info</th>
                                            <th class="sortable-header" data-sort="lastVisit" onclick="sortDirectory('lastVisit')">Last Visit <span class="sort-icon"></span></th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detail Panel (slides in from right) -->
                <div class="directory-detail-panel" id="directoryDetailPanel">
                    <div class="detail-panel-header">
                        <button class="btn btn-sm btn-secondary" onclick="closeDetailPanel()">
                            <span class="material-icons-outlined">arrow_back</span> Back
                        </button>
                        <div class="detail-panel-actions" id="detailPanelActions"></div>
                    </div>
                    <div class="detail-panel-content" id="detailPanelContent">
                        <!-- Dynamic content loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Visits Tab -->
        <div class="tab-content" id="tab-visits">

            <!-- ROUTE PLANNER PANEL - COLLAPSIBLE -->
            <div id="routePlannerPanel" class="route-planner">
                <div class="route-planner-header" onclick="toggleRoutePlanner()">
                    <span class="route-planner-toggle">▶</span>
                    <h3 style="margin: 0; display: inline; cursor: pointer;">🗺️ Smart Route Planner</h3>
                </div>
                
                <div id="routePlannerContent" class="route-planner-content" style="display: none;">
                    <div class="route-planner-controls">
                    <div style="min-width: 180px;">
                        <label for="routeZone" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px;">Select Zone</label>
                        <select id="routeZone" class="form-select" onchange="updateRouteCitiesForZone()">
                            <option value="">All Zones</option>
                        </select>
                    </div>
                    
                    <div style="min-width: 280px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px;">Select Cities (Multiple)</label>
                        <div id="routeCityCheckboxes" class="route-city-checkboxes" style="background: white; border-radius: 6px; padding: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #ddd;">
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </div>
                    
                    <div style="min-width: 140px;">
                        <label for="routePlanDate" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px;">Plan Date</label>
                        <input type="date" id="routePlanDate" class="form-input">
                    </div>
                    
                    <div style="min-width: 130px;">
                        <label for="routeStartTime" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px;">Start Time</label>
                        <input type="time" id="routeStartTime" class="form-input" value="09:00">
                    </div>
                    
                    <div style="min-width: 140px;">
                        <label for="routeVisitDuration" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px;">Visit (min)</label>
                        <input type="number" id="routeVisitDuration" class="form-input" 
                               min="15" max="120" step="5" value="30">
                    </div>
                    
                    <div style="min-width: 140px;">
                        <label for="routeTravelBuffer" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px;">Travel (min)</label>
                        <input type="number" id="routeTravelBuffer" class="form-input" 
                               min="0" max="60" step="5" value="15">
                    </div>
                    
                    <div style="display: flex; align-items: flex-end; gap: 10px; min-width: 280px;">
                        <button onclick="generateRoutePlan()" class="btn btn-primary" style="flex: 1; height: 40px; margin: 0; font-weight: bold;">
                            Generate
                        </button>
                        <button onclick="clearRoutePlanner()" class="btn btn-secondary" style="flex: 1; height: 40px; margin: 0; font-weight: bold;">
                            Clear
                        </button>
                    </div>
                </div>
                
                <div id="routeResults" class="route-results" style="display: none;">
                    <h4>📍 Route Plan for <span id="routeResultsCity"></span> on <span id="routeResultsDate"></span></h4>
                    <div id="routeStops" class="route-stops">
                        <!-- Generated list of stops will appear here -->
                    </div>
                    
                    <button onclick="exportRouteToCalendar()" class="btn btn-success" style="width: 100%;">
                        📅 Export to Google Calendar (ICS)
                    </button>
                    
                    <button onclick="saveRoutePlan()" class="btn btn-info" style="width: 100%; margin-top: 10px;">
                        💾 Save Route Plan
                    </button>
                    
                    <button onclick="clearRoutePlanner()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                        🔄 Start Over
                    </button>
                </div>
                    </div>
                </div>
            <div class="card">
                <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
                    <h2 class="card-title"><span class="material-icons-outlined">history</span> Visit History</h2>
                    <div class="directory-toolbar">
                        <div class="search-box" style="min-width: 180px;">
                            <span class="material-icons-outlined">search</span>
                            <input type="text" class="form-input" id="visitSearch" placeholder="Search..." oninput="renderVisits()">
                        </div>
                        <select class="form-select" id="visitZoneFilter" onchange="renderVisits()" style="min-width: 100px;">
                            <option value="">All Zones</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="openVisitModal()">
                            <span class="material-icons-outlined">add</span> Log Visit
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="visitsTable" class="sortable-table">
                            <thead><tr>
                                <th class="sortable-header" data-sort="date" onclick="sortVisits('date')">Date <span class="sort-icon"></span></th>
                                <th class="sortable-header" data-sort="org" onclick="sortVisits('org')">Organization <span class="sort-icon"></span></th>
                                <th>Outcome</th>
                                <th>Assets Used</th>
                                <th>Rep</th>
                                <th>Actions</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emails Tab -->
        <div class="tab-content" id="tab-emails">
            <div class="email-layout">
                <div class="email-list">
                    <div class="email-list-header">
                        <span style="font-weight: 600; color: var(--navy);">Inbox</span>
                        <button class="btn btn-sm btn-primary" onclick="openComposeModal()">
                            <span class="material-icons-outlined">edit</span> Compose
                        </button>
                    </div>
                    <div style="padding: 10px; border-bottom: 1px solid var(--gray-200);">
                        <select class="form-select" id="emailZoneFilter" onchange="loadInbox()" style="font-size: 13px;">
                            <option value="">All My Zones</option>
                            <option value="SMF">SMF Only</option>
                            <option value="SDG">SDG Only</option>
                        </select>
                    </div>
                    <div class="email-list-content" id="emailList">
                        <div class="email-empty">
                            <span class="material-icons-outlined">inbox</span>
                            <div>Loading emails...</div>
                        </div>
                    </div>
                </div>
                <div class="email-viewer" id="emailViewer">
                    <div class="email-empty">
                        <span class="material-icons-outlined">mail</span>
                        <div>Select an email to view</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets/Inventory Tab -->
        <div class="tab-content" id="tab-assets">
            <!-- Low Stock Alert Banner -->
            <div class="alert-banner" id="lowStockAlert" style="display: none;">
                <span class="material-icons-outlined">warning</span>
                <span id="lowStockMessage">Some items are running low!</span>
                <button class="btn btn-sm" onclick="document.getElementById('lowStockAlert').style.display='none'">Dismiss</button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">inventory_2</span> Asset Inventory</h2>
                    <div class="search-filters">
                        <select class="form-select filter-select" id="assetCategoryFilter" onchange="renderAssets()">
                            <option value="">All Categories</option>
                        </select>
                        <select class="form-select filter-select" id="assetZoneFilter" onchange="renderAssets()">
                            <option value="">All Zones</option>
                        </select>
                        <button class="btn btn-primary" onclick="openAddStockModal()">
                            <span class="material-icons-outlined">add</span> Add Stock
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="assetsTable" class="sortable-table">
                            <thead>
                                <tr>
                                    <th class="sortable-header" data-sort="category" onclick="sortAssets('category')">Category <span class="sort-icon"></span></th>
                                    <th class="sortable-header" data-sort="name" onclick="sortAssets('name')">Item Name <span class="sort-icon"></span></th>
                                    <th>Zones</th>
                                    <th class="sortable-header" data-sort="quantity" onclick="sortAssets('quantity')">Quantity <span class="sort-icon"></span></th>
                                    <th>Threshold</th>
                                    <th class="sortable-header" data-sort="status" onclick="sortAssets('status')">Status <span class="sort-icon"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2 class="card-title"><span class="material-icons-outlined">history</span> Stock History</h2>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="stockHistoryTable" class="sortable-table">
                            <thead><tr>
                                <th class="sortable-header" data-sort="date" onclick="sortStockHistory('date')">Date <span class="sort-icon"></span></th>
                                <th>Asset</th>
                                <th>Type</th>
                                <th>Qty</th>
                                <th>By</th>
                                <th>Notes</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
            <div class="settings-grid">
                <!-- Asset Categories Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">folder</span> Asset Categories</h2>
                        <button class="btn btn-primary btn-sm" onclick="openAssetCategoryModal()">
                            <span class="material-icons-outlined">add</span> Add Category
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
                            Categories group related assets (e.g., Brochures, Business Cards).
                        </p>
                        <div id="assetCategoriesList"></div>
                    </div>
                </div>

                <!-- Asset Items Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">inventory_2</span> Asset Items</h2>
                        <button class="btn btn-primary btn-sm" onclick="openAssetItemModal()">
                            <span class="material-icons-outlined">add</span> Add Item
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
                            Specific items within each category (e.g., General Brochure, Hospice Brochure).
                        </p>
                        <div id="assetItemsList"></div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">notifications</span> Notifications</h2>
                    </div>
                    <div class="card-body">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Low Stock Email Alerts</div>
                                <div class="setting-desc">Send email to <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5230272136372412333e3b3137313320377c313d3f">[email&#160;protected]</a> when stock falls below threshold</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="settingLowStockEmail" checked onchange="saveSetting('lowStockEmailEnabled', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Default Low Stock Threshold</div>
                                <div class="setting-desc">Alert when quantity falls below this number</div>
                            </div>
                            <input type="number" class="form-input" id="settingLowStockThreshold" value="50" min="1" max="500" style="width: 80px;" onchange="saveSetting('lowStockThreshold', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Visit Outcomes Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">checklist</span> Visit Outcomes</h2>
                        <button class="btn btn-primary btn-sm" onclick="openOutcomeModal()">
                            <span class="material-icons-outlined">add</span> Add
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
                            Manage visit outcome options for Check-In.
                        </p>
                        <div id="outcomesList"></div>
                    </div>
                </div>

                <!-- Organization Types Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">business</span> Organization Types</h2>
                        <button class="btn btn-primary btn-sm" onclick="openOrgTypeModal()">
                            <span class="material-icons-outlined">add</span> Add
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
                            Manage organization types for classification (e.g., Hospice, Hospital, Nursing Home).
                        </p>
                        <div id="orgTypesList"></div>
                    </div>
                </div>

                <!-- Zone Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">map</span> Zones</h2>
                        <button class="btn btn-primary btn-sm" onclick="openZoneModal()">
                            <span class="material-icons-outlined">add</span> Add
                        </button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--gray-500); font-size: 13px; margin-bottom: 16px;">
                            Manage geographic zones for organizations.
                        </p>
                        <div id="zonesList"></div>
                    </div>
                </div>

                <!-- Email Templates Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="material-icons-outlined">description</span> Email Templates</h2>
                        <div class="search-filters">
                            <select class="form-select filter-select" id="templateCategoryFilter" onchange="renderTemplates()">
                                <option value="">All Categories</option>
                                <option value="intro">Introduction</option>
                                <option value="followup">Follow-up</option>
                                <option value="meeting">Meeting Request</option>
                                <option value="thankyou">Thank You</option>
                                <option value="checkin">Check-in</option>
                                <option value="general">General</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="openTemplateModal()">
                                <span class="material-icons-outlined">add</span> New Template
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="background: var(--info-light); color: var(--info); padding: 12px 16px; border-radius: var(--radius); margin-bottom: 16px; font-size: 13px;">
                            <strong>Template Variables:</strong> {{contact_name}}, {{organization}}, {{zone}}, {{rep_name}}, {{rep_email}}, {{rep_phone}}, {{visit_date}}
                        </div>
                        <div class="template-grid" id="templateGrid"></div>
                    </div>
                </div>

                <!-- Team Members Settings -->
                <div class="card">
                    <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
                        <h2 class="card-title"><span class="material-icons-outlined">groups</span> Team Members</h2>
                        <div class="directory-toolbar">
                            <div class="search-box" style="min-width: 180px;">
                                <span class="material-icons-outlined">search</span>
                                <input type="text" class="form-input" id="teamSearch" placeholder="Search..." oninput="renderTeam()">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="openTeamModal()">
                                <span class="material-icons-outlined">add</span> Add Member
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="teamTable" class="sortable-table">
                                <thead><tr>
                                    <th class="sortable-header" data-sort="name" onclick="sortTeam('name')">Name <span class="sort-icon"></span></th>
                                    <th>Email</th>
                                    <th>Zones</th>
                                    <th class="sortable-header" data-sort="role" onclick="sortTeam('role')">Role <span class="sort-icon"></span></th>
                                    <th class="sortable-header" data-sort="status" onclick="sortTeam('status')">Status <span class="sort-icon"></span></th>
                                    <th>Actions</th>
                                </tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Organization Modal -->
    <div class="modal-overlay" id="orgModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="orgModalTitle">Add Organization</h3>
                <button class="modal-close" onclick="closeModal('orgModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="orgId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="orgName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="orgType">
                            <option value="">Select</option>
                            <option value="Hospice">Hospice</option>
                            <option value="Assisted Living">Assisted Living</option>
                            <option value="Skilled Nursing">Skilled Nursing</option>
                            <option value="Hospital">Hospital</option>
                            <option value="Home Health">Home Health</option>
                            <option value="Senior Center">Senior Center</option>
                            <option value="Physician Office">Physician Office</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Zone *</label>
                        <select class="form-select" id="orgZone" required>
                            <option value="SMF">SMF - Sacramento</option>
                            <option value="SDG">SDG - San Diego</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="orgStatus">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Prospect">Prospect</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="orgAddress">
                </div>
                <div class="form-group">
                    <label class="form-label">Address 2 (Suite, Building, etc.)</label>
                    <input type="text" class="form-input" id="orgAddress2">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" class="form-input" id="orgCity">
                    </div>
                    <div class="form-group">
                        <label class="form-label">State</label>
                        <input type="text" class="form-input" id="orgState" value="CA">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zip</label>
                        <input type="text" class="form-input" id="orgZip">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="orgPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Visit Frequency</label>
                        <select class="form-select" id="orgFrequency">
                            <option value="Weekly">Weekly</option>
                            <option value="Bi-Weekly">Bi-Weekly</option>
                            <option value="Monthly" selected>Monthly</option>
                            <option value="Quarterly">Quarterly</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="orgNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orgModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveOrganization()">Save</button>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="contactModalTitle">Add Contact</h3>
                <button class="modal-close" onclick="closeModal('contactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contactId">
                <div class="form-group">
                    <label class="form-label">Organization *</label>
                    <div class="searchable-select">
                        <input type="text" class="form-input searchable-input" id="contactOrgSearch" placeholder="Type to search organizations..." autocomplete="off" onfocus="showOrgOptions()" oninput="filterOrgOptions()">
                        <input type="hidden" id="contactOrg" required>
                        <div class="select-options" id="contactOrgOptions"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-input" id="contactFirstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-input" id="contactLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="contactTitle">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="contactEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="contactPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="contactPrimary"> Primary Contact</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('contactModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveContact()">Save</button>
            </div>
        </div>
    </div>

    <!-- Visit Modal -->
    <div class="modal-overlay" id="visitModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="visitModalTitle">Log Visit</h3>
                <button class="modal-close" onclick="closeModal('visitModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="visitId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Organization * (Search or Type)</label>
                        <div style="position: relative;">
                            <input type="text" class="form-input" id="visitOrgSearch" placeholder="Type organization name..." oninput="filterVisitOrganizations()" style="width: 100%;" autocomplete="off">
                            <div id="visitOrgSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-top: none; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; border-radius: 0 0 4px 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                        </div>
                        <input type="hidden" id="visitOrg" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Met</label>
                        <select class="form-select" id="visitContact"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-input" id="visitDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Outcome *</label>
                        <select class="form-select" id="visitOutcome" required>
                            <option value="">Select</option>
                            <option value="Interested - Schedule Follow-up">Interested - Schedule Follow-up</option>
                            <option value="Meeting Scheduled">Meeting Scheduled</option>
                            <option value="Referral Received">Referral Received</option>
                            <option value="Not Available - Left Materials">Not Available - Left Materials</option>
                            <option value="Not Interested">Not Interested</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="background: var(--gray-50); padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">General</label>
                        <input type="number" class="form-input" id="brochGeneral" value="0" min="0">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Hospice</label>
                        <input type="number" class="form-input" id="brochHospice" value="0" min="0">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Home Health</label>
                        <input type="number" class="form-input" id="brochHomeHealth" value="0" min="0">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Cards</label>
                        <input type="number" class="form-input" id="brochCards" value="0" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="visitNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('visitModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveVisit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Compose Email Modal -->
    <div class="modal-overlay" id="composeModal">
        <div class="modal modal-lg">
            <div class="modal-header" style="background: var(--navy); color: white;">
                <h3 class="modal-title" style="color: white;">Compose Email</h3>
                <button class="modal-close" onclick="closeModal('composeModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-selector" id="templateSelector"></div>
                
                <!-- Custom Variables Section (shown when template has custom vars) -->
                <div class="custom-vars-section" id="customVarsSection" style="display: none;">
                    <div class="custom-vars-header">
                        <span class="material-icons-outlined">edit_note</span>
                        <span>Fill in custom variables:</span>
                    </div>
                    <div class="custom-vars-inputs" id="customVarsInputs"></div>
                    <button type="button" class="btn btn-sm btn-primary" onclick="applyCustomVariables()" style="margin-top: 10px;">
                        <span class="material-icons-outlined" style="font-size: 14px;">check</span> Apply Variables
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Organization</label>
                        <select class="form-select" id="composeOrg" onchange="populateContactsForOrg()"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <select class="form-select" id="composeContact"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">To Email *</label>
                    <input type="email" class="form-input" id="composeToEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Subject *</label>
                    <input type="text" class="form-input" id="composeSubject" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Message *</label>
                    <div id="composeBodyEditor" style="height: 200px; background: white;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('composeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="sendEmail()">
                    <span class="material-icons-outlined">send</span> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="templateModalTitle">New Template</h3>
                <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="templateId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Template Name *</label>
                        <input type="text" class="form-input" id="templateName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="templateCategory">
                            <option value="intro">Introduction</option>
                            <option value="followup">Follow-up</option>
                            <option value="meeting">Meeting Request</option>
                            <option value="thankyou">Thank You</option>
                            <option value="checkin">Check-in</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Subject Line *</label>
                    <div class="subject-with-vars">
                        <input type="text" class="form-input" id="templateSubject" required style="flex: 1;">
                        <select class="form-select" id="subjectVarSelect" onchange="insertSubjectVar(this)" style="width: auto; min-width: 140px;">
                            <option value="">+ Variable</option>
                            <option value="contact_name">{{contact_name}}</option>
                            <option value="organization">{{organization}}</option>
                            <option value="zone">{{zone}}</option>
                            <option value="rep_name">{{rep_name}}</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Body * (Rich Text)</label>
                    <div id="templateBodyEditor" style="height: 250px; background: white;"></div>
                    <div class="variable-insert-section">
                        <div class="variable-label">Click to insert variable:</div>
                        <div class="variable-buttons" id="templateVariableButtons">
                            <button type="button" class="variable-btn" onclick="insertVariable('contact_name', 'template')">{{contact_name}}</button>
                            <button type="button" class="variable-btn" onclick="insertVariable('organization', 'template')">{{organization}}</button>
                            <button type="button" class="variable-btn" onclick="insertVariable('zone', 'template')">{{zone}}</button>
                            <button type="button" class="variable-btn" onclick="insertVariable('rep_name', 'template')">{{rep_name}}</button>
                            <button type="button" class="variable-btn" onclick="insertVariable('rep_email', 'template')">{{rep_email}}</button>
                            <button type="button" class="variable-btn" onclick="insertVariable('rep_phone', 'template')">{{rep_phone}}</button>
                            <button type="button" class="variable-btn" onclick="insertVariable('visit_date', 'template')">{{visit_date}}</button>
                        </div>
                        <div class="custom-variable-row">
                            <input type="text" class="form-input" id="customVariableName" placeholder="Custom variable name..." style="flex: 1;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="insertCustomVariable('template')">
                                <span class="material-icons-outlined" style="font-size: 14px;">add</span> Add Custom
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('templateModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Team Modal -->
    <div class="modal-overlay" id="teamModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="teamModalTitle">Add Team Member</h3>
                <button class="modal-close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="teamId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="teamName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="teamEmail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="teamPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="teamRole">
                            <option value="Rep">Rep</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Zones</label>
                    <div style="display: flex; gap: 16px;">
                        <label><input type="checkbox" id="zoneSMF" value="SMF" checked> SMF</label>
                        <label><input type="checkbox" id="zoneSDG" value="SDG"> SDG</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('teamModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTeamMember()">Save</button>
            </div>
        </div>
    </div>

    <!-- Asset Category Modal -->
    <div class="modal-overlay" id="assetCategoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="assetCategoryModalTitle">Add Asset Category</h3>
                <button class="modal-close" onclick="closeModal('assetCategoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assetCategoryId">
                <div class="form-group">
                    <label class="form-label">Category Name *</label>
                    <input type="text" class="form-input" id="assetCategoryName" placeholder="e.g., Brochures, Business Cards" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Icon</label>
                    <select class="form-select" id="assetCategoryIcon">
                        <option value="description">📄 Document</option>
                        <option value="contact_page">💳 Card</option>
                        <option value="folder">📁 Folder</option>
                        <option value="inventory_2">📦 Box</option>
                        <option value="redeem">🎁 Gift</option>
                        <option value="local_offer">🏷️ Tag</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="assetCategoryShowInCheckin" checked> Show in Check-In</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('assetCategoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAssetCategory()">Save</button>
            </div>
        </div>
    </div>

    <!-- Asset Item Modal -->
    <div class="modal-overlay" id="assetItemModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="assetItemModalTitle">Add Asset Item</h3>
                <button class="modal-close" onclick="closeModal('assetItemModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assetItemId">
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="assetItemCategory" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Item Name *</label>
                    <input type="text" class="form-input" id="assetItemName" placeholder="e.g., General Brochure, Hospice Brochure" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Zones *</label>
                    <div class="zone-selector">
                        <label class="zone-checkbox-label">
                            <input type="checkbox" id="assetItemAllZones" onchange="toggleAllZones()"> 
                            <strong>All Zones</strong>
                        </label>
                        <div id="assetItemZonesList" class="zone-checkboxes"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" class="form-input" id="assetItemThreshold" value="50" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initial Quantity</label>
                        <input type="number" class="form-input" id="assetItemInitialQty" value="0" min="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('assetItemModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAssetItem()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal-overlay" id="addStockModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Stock</h3>
                <button class="modal-close" onclick="closeModal('addStockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Asset Item *</label>
                    <select class="form-select" id="addStockAsset" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity to Add *</label>
                    <input type="number" class="form-input" id="addStockQty" min="1" value="100" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-input" id="addStockNotes" placeholder="e.g., Ordered from vendor XYZ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addStockModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addStock()">Add Stock</button>
            </div>
        </div>
    </div>

    <!-- Outcome Modal -->
    <div class="modal-overlay" id="outcomeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Visit Outcome</h3>
                <button class="modal-close" onclick="closeModal('outcomeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="outcomeId">
                <div class="form-group">
                    <label class="form-label">Outcome Name *</label>
                    <input type="text" class="form-input" id="outcomeName" placeholder="e.g., Meeting Scheduled" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('outcomeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveOutcome()">Save</button>
            </div>
        </div>
    </div>

    <!-- Organization Type Modal -->
    <div class="modal-overlay" id="orgTypeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Organization Type</h3>
                <button class="modal-close" onclick="closeModal('orgTypeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="orgTypeId">
                <div class="form-group">
                    <label class="form-label">Organization Type Name *</label>
                    <input type="text" class="form-input" id="orgTypeName" placeholder="e.g., Hospice, Hospital, Nursing Home" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orgTypeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveOrgType()">Save</button>
            </div>
        </div>
    </div>

    <!-- Zone Modal -->
    <div class="modal-overlay" id="zoneModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Zone</h3>
                <button class="modal-close" onclick="closeModal('zoneModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="zoneId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Zone Code *</label>
                        <input type="text" class="form-input" id="zoneCode" placeholder="e.g., SMF" maxlength="5" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone Name *</label>
                        <input type="text" class="form-input" id="zoneName" placeholder="e.g., Sacramento" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('zoneModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveZone()">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading -->
    <div class="loading-overlay" id="loading"><div class="spinner"></div></div>
    
    <!-- Toast Container -->
    <div id="toastContainer" style="position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;pointer-events:none;"></div>
    
    </div><!-- END mainApp -->

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwBAdA9ijNvFI2ZO_9h17NpPZ9IyjrDOg9IAvopqKoahbUHseKJwqS9Ry8c4YX_Dua/exec';
        
        // Google Sign-In Configuration
        const GOOGLE_CLIENT_ID = '308629843682-7ocsqbf8sa9na26511700pdiakvbi9l2.apps.googleusercontent.com';
        let googleIdToken = null;

        // ============================================
        // GOOGLE AUTHENTICATION
        // ============================================
        function initGoogleSignIn() {
            console.log('Initializing Google Sign-In...');
            console.log('Current origin:', window.location.origin);
            console.log('Client ID:', GOOGLE_CLIENT_ID);
            
            try {
                // Initialize with FedCM disabled
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleSignInResponse,
                    itp_support: false  // Disable FedCM
                });
                
                console.log('✅ Google accounts initialized');
                
                // Render button without FedCM features
                const signInBtn = document.getElementById('googleSignInBtn');
                if (signInBtn) {
                    google.accounts.id.renderButton(
                        signInBtn,
                        { 
                            theme: 'outline', 
                            size: 'large',
                            text: 'signin_with',
                            logo_alignment: 'left'
                        }
                    );
                    console.log('✅ Google Sign-In button rendered successfully');
                } else {
                    console.warn('⚠️ Sign-in button element not found');
                }
                
                // Also set up the login gate button
                const gateBtn = document.getElementById('googleSignInBtnGate');
                if (gateBtn) {
                    google.accounts.id.renderButton(
                        gateBtn,
                        { 
                            theme: 'outline', 
                            size: 'large',
                            text: 'signin_with'
                        }
                    );
                    console.log('✅ Login gate button rendered');
                }
            } catch (e) {
                console.error('❌ Error during Google Sign-In init:', e);
                // Fallback: show manual sign-in button
                const signInBtn = document.getElementById('googleSignInBtn');
                if (signInBtn) {
                    signInBtn.innerHTML = '<span class="material-icons-outlined">login</span> Sign in with Google (Manual)';
                    signInBtn.onclick = () => manualGoogleSignIn();
                }
            }
        }
        
        function manualGoogleSignIn() {
            console.log('Opening manual Google Sign-In...');
            // This would open Google's OAuth consent screen
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${GOOGLE_CLIENT_ID}&` +
                `redirect_uri=${window.location.origin}/&` +
                `response_type=token&` +
                `scope=openid email profile`;
            window.location.href = authUrl;
        }
        
        function handleGoogleSignInResponse(response) {
            console.log('✅ Google Sign-In response received');
            
            try {
                if (!response || !response.credential) {
                    console.error('❌ No credential in response:', response);
                    showToast('Sign-in failed: No credential received', 'error');
                    return;
                }
                
                googleIdToken = response.credential;
                console.log('✅ JWT Token received');
                
                // Decode JWT to get user info
                const decodedToken = decodeJwtToken(googleIdToken);
                console.log('✅ Token decoded successfully');
                
                // 🔐 SECURITY: Domain Restriction - Only @alicecare.com
                const allowedDomain = 'alicecare.com';
                const userDomain = decodedToken.hd; // hd = hosted domain from JWT
                
                console.log('Domain check:', { userDomain, allowedDomain, match: userDomain === allowedDomain });
                
                if (userDomain !== allowedDomain) {
                    console.error('❌ DOMAIN RESTRICTED: User domain is', userDomain);
                    showToast('❌ Access Denied: You must use your Alice Care (@alicecare.com) email to access this application', 'error');
                    googleSignOut();
                    return;
                }
                
                console.log('✅ Domain authorized: alicecare.com');
                
                // 🔐 SESSION: Set 8-hour timeout (28,800,000 milliseconds)
                const sessionExpirationTime = Date.now() + (8 * 60 * 60 * 1000);
                localStorage.setItem('sessionExpiration', sessionExpirationTime);
                localStorage.setItem('sessionStartTime', Date.now());
                
                console.log('✅ Session set for 8 hours');
                console.log('Session expires at:', new Date(sessionExpirationTime).toLocaleString());
                
                // Start session monitoring
                startSessionMonitoring();
                
                state.user = {
                    email: decodedToken.email,
                    name: decodedToken.name,
                    picture: decodedToken.picture,
                    hd: decodedToken.hd,
                    zones: extractZonesFromEmail(decodedToken.email)
                };
                
                console.log('✅ User info set:', state.user.email);
                updateAuthUI();
                
                // Load app data after auth UI updates
                setTimeout(() => {
                    renderAll();
                    showToast('✅ Signed in as ' + state.user.email + ' (Session: 8 hours)', 'success');
                }, 100);
            } catch (e) {
                console.error('❌ Error processing sign-in response:', e);
                showToast('Error processing sign-in: ' + e.message, 'error');
            }
        }
        
        function extractZonesFromEmail(email) {
            // Extract zones from email - you can customize this logic
            // For example: john.smf@company.com -> ['SMF']
            // or: john@company.com -> ['All']
            const match = email.match(/\.([A-Z]+)@/);
            if (match && match[1]) {
                return [match[1]];
            }
            return ['All']; // Default to all zones
        }
        
        function decodeJwtToken(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map((c) => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        function googleSignOut() {
            console.log('🔓 Signing out...');
            google.accounts.id.disableAutoSelect();
            googleIdToken = null;
            state.user = null;
            
            // 🔐 Clear session data
            localStorage.removeItem('sessionExpiration');
            localStorage.removeItem('sessionStartTime');
            
            console.log('✅ Session cleared');
            
            updateAuthUI();
            showToast('✅ Signed out', 'info');
            
            // Redirect to reset app
            location.reload();
        }
        
        // ============================================
        // 🔐 SESSION MANAGEMENT (8 HOUR TIMEOUT)
        // ============================================
        
        function startSessionMonitoring() {
            console.log('⏱️ Session monitoring started (8 hour timeout)');
            // Check session every minute
            setInterval(checkSessionExpiration, 60 * 1000);
        }
        
        function checkSessionExpiration() {
            if (!state.user) return; // No user logged in
            
            const sessionExpiration = parseInt(localStorage.getItem('sessionExpiration')) || 0;
            const now = Date.now();
            const timeRemaining = sessionExpiration - now;
            
            if (timeRemaining <= 0) {
                // Session expired
                console.log('❌ Session expired - auto logout');
                showToast('⚠️ Your session has expired. Please sign in again.', 'error');
                googleSignOut();
                return;
            }
            
            // Warn at 30 minutes before expiry
            const warningThreshold = 30 * 60 * 1000;
            if (timeRemaining <= warningThreshold && timeRemaining > 0) {
                const minutesRemaining = Math.floor(timeRemaining / (60 * 1000));
                console.log('⚠️ Session expires in', minutesRemaining, 'minutes');
                
                // Show warning once per session (not every minute)
                if (!window.sessionWarningShown) {
                    showToast('⚠️ Your session will expire in ' + minutesRemaining + ' minutes. Click Extend to stay logged in.', 'warning');
                    window.sessionWarningShown = true;
                }
            }
        }
        
        function getSessionTimeRemaining() {
            const sessionExpiration = parseInt(localStorage.getItem('sessionExpiration')) || 0;
            const now = Date.now();
            const timeRemaining = Math.max(0, sessionExpiration - now);
            const hours = Math.floor(timeRemaining / (60 * 60 * 1000));
            const minutes = Math.floor((timeRemaining % (60 * 60 * 1000)) / (60 * 1000));
            return { milliseconds: timeRemaining, hours, minutes };
        }
        
        function extendSession() {
            const newExpiration = Date.now() + (8 * 60 * 60 * 1000);
            localStorage.setItem('sessionExpiration', newExpiration);
            window.sessionWarningShown = false;
            console.log('✅ Session extended to 8 hours');
            console.log('New expiration:', new Date(newExpiration).toLocaleString());
            showToast('✅ Session extended for 8 more hours', 'success');
        }
        
        function updateAuthUI() {
            const signedInSection = document.getElementById('signedInSection');
            const signedOutSection = document.getElementById('signedOutSection');
            const loginGate = document.getElementById('loginGate');
            const mainApp = document.getElementById('mainApp');
            
            if (state.user) {
                // User is authenticated
                signedInSection.style.display = 'flex';
                signedOutSection.style.display = 'none';
                document.getElementById('userName').textContent = state.user.name || state.user.email;
                document.getElementById('userZones').textContent = state.user.zones?.join(', ') || 'All';
                
                // Show main app, hide login gate
                if (loginGate) loginGate.classList.add('hidden');
                if (mainApp) mainApp.style.display = 'block';
            } else {
                // User is not authenticated
                signedInSection.style.display = 'none';
                signedOutSection.style.display = 'block';
                
                // Hide main app, show login gate
                if (loginGate) loginGate.classList.remove('hidden');
                if (mainApp) mainApp.style.display = 'none';
            }
        }
        let state = {
            user: null,
            organizations: [],
            contacts: [],
            visits: [],
            teamMembers: [],
            emailTemplates: [],
            emails: [],
            currentLocation: null,
            selectedEmail: null,
            // Assets & Inventory (two-level hierarchy)
            assetCategories: [],  // e.g., Brochures, Business Cards
            assetItems: [],       // e.g., General Brochure, Hospice Brochure
            stockHistory: [],
            // Settings
            settings: {
                lowStockEmailEnabled: true,
                lowStockThreshold: 50,
                outcomes: [
                    'Not Available - Left Materials',
                    'Interested - Schedule Follow-up',
                    'Meeting Scheduled',
                    'Referral Received',
                    'Not Interested'
                ],
                organizationTypes: [
                    'Hospice',
                    'Hospital',
                    'Skilled Nursing Facility',
                    'Assisted Living',
                    'Home Health Agency',
                    'Private Practice',
                    'Clinic',
                    'Healthcare Facility',
                    'Venture Capital',
                    'Other'
                ],
                zones: [
                    { code: 'SMF', name: 'Sacramento' },
                    { code: 'SDG', name: 'San Diego' }
                ]
            }
        };
        
        // Quill editors
        let templateEditor = null;
        let composeEditor = null;
        
        const quillToolbar = [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['link', 'image'],
            ['clean']
        ];



        // ============================================
        // 🗺️ SMART ROUTE PLANNER - COMPLETE CODE
        // ============================================

        function getRoutePlannerCities() {
            const citiesSet = new Set();
            
            console.log('🔍 Getting all cities from database...');
            console.log('Total organizations:', state.organizations.length);
            
            // Get ALL unique cities from Active organizations
            state.organizations.forEach((org) => {
                if (org.City && org.Status === 'Active') {
                    citiesSet.add(org.City);
                }
            });
            
            const cities = Array.from(citiesSet).sort();
            console.log('✅ All cities found:', cities);
            return cities;
        }

        function getOverdueOrganizations(city) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            console.log(`🏙️ Getting organizations for city: ${city}`);
            
            const orgs = state.organizations.filter(org => 
                org.City === city && org.Status === 'Active'
            );
            
            console.log(`  Found ${orgs.length} active organizations in ${city}`);
            
            return orgs.map(org => {
                let nextVisitDue = null;
                
                if (org.Next_Visit_Due) {
                    nextVisitDue = new Date(org.Next_Visit_Due);
                    // Handle date parsing issues
                    if (isNaN(nextVisitDue.getTime())) {
                        nextVisitDue = new Date(org.Next_Visit_Due.replace(/-/g, '/'));
                    }
                }
                
                let daysOverdue = 0;
                if (nextVisitDue && !isNaN(nextVisitDue.getTime())) {
                    daysOverdue = Math.floor((today - nextVisitDue) / (1000*60*60*24));
                }
                
                return {
                    ...org,
                    DaysOverdue: daysOverdue,
                    IsOverdue: daysOverdue > 0
                };
            }).sort((a, b) => b.DaysOverdue - a.DaysOverdue); // CHANGED: Show ALL organizations, not just overdue
        }

        function sortByDistance(organizations) {
            return organizations.sort((a, b) => {
                if (a.Zip !== b.Zip) return a.Zip.localeCompare(b.Zip);
                return a.Address.localeCompare(b.Address);
            });
        }

        function generateRoute(city, startTime, durationMinutes, travelBuffer = 0, planDate = null) {
            let overdue = getOverdueOrganizations(city);
            let sorted = sortByDistance(overdue);
            
            if (sorted.length === 0) {
                showToast('No organizations in ' + city, 'warning');
                return [];
            }
            
            let [hours, minutes] = startTime.split(':').map(Number);
            
            // Use the selected plan date if provided
            let currentTime;
            if (planDate) {
                // Parse date string in local timezone (NOT UTC)
                const [year, month, day] = planDate.split('-').map(Number);
                currentTime = new Date(year, month - 1, day, hours, minutes, 0, 0);
                console.log(`📅 Created time for date: ${planDate} at ${startTime} => ${currentTime}`);
            } else {
                currentTime = new Date();
                currentTime.setHours(hours, minutes, 0, 0);
            }
            
            return sorted.map((org, index) => {
                const arrivalTime = new Date(currentTime);
                const departureTime = new Date(currentTime.getTime() + durationMinutes * 60000);
                
                const result = {
                    ...org,
                    Order: index + 1,
                    EstimatedArrivalTime: arrivalTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true}),
                    EstimatedDepartureTime: departureTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true}),
                    _arrivalDate: arrivalTime,
                    _departureDate: departureTime,
                    Include: true
                };
                
                currentTime = new Date(departureTime.getTime() + travelBuffer * 60000);
                return result;
            });
        }

        function generateICSFile(route, city, planDate = null) {
            // Use the selected plan date, not today's date
            const dateStr = planDate || new Date().toISOString().split('T')[0];
            
            console.log(`📅 ICS Generation started for ${city} on ${dateStr}`);
            console.log(`   Total stops in route: ${route.length}`);
            
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Alice Care Business Development//Route Plan//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${city} Route - ${dateStr}
X-WR-TIMEZONE:America/Los_Angeles
X-WR-CALDESC:Route plan for visiting organizations in ${city} on ${dateStr}
BEGIN:VTIMEZONE
TZID:America/Los_Angeles
BEGIN:DAYLIGHT
TZOFFSETFROM:-0800
TZOFFSETTO:-0700
TZNAME:PDT
DTSTART:20250309T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU
END:DAYLIGHT
BEGIN:STANDARD
TZOFFSETFROM:-0700
TZOFFSETTO:-0800
TZNAME:PST
DTSTART:20251102T020000
RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
END:STANDARD
END:VTIMEZONE
`;

            let eventCount = 0;
            route.forEach((stop, index) => {
                if (!stop.Include) {
                    console.log(`   Skip ${index}: Include=false (${stop.Name})`);
                    return;
                }
                
                eventCount++;
                const startDateTime = formatDateTimeForICS(stop._arrivalDate);
                const endDateTime = formatDateTimeForICS(stop._departureDate);
                const uid = `route-${city}-stop${stop.Order}-${Date.now()}-${eventCount}@alicecare.com`;
                
                console.log(`   Add event ${eventCount}: Stop ${stop.Order} - ${stop.Name} @ ${startDateTime}-${endDateTime}`);
                
                const description = `Organization: ${stop.Name}
Address: ${stop.Address}, ${stop.City}, ${stop.State} ${stop.Zip}
Phone: ${stop.Phone || 'N/A'}
Last Visited: ${stop.Last_Visit ? new Date(stop.Last_Visit).toLocaleDateString() : 'Never'}
Days Overdue: ${stop.DaysOverdue}
Status: ${stop.Status}`;

                icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${formatDateTimeForICS(new Date())}
DTSTART;TZID=America/Los_Angeles:${startDateTime}
DTEND;TZID=America/Los_Angeles:${endDateTime}
SUMMARY:Stop ${stop.Order}: ${stop.Name}
DESCRIPTION:${escapeICSString(description)}
LOCATION:${stop.Address}, ${stop.City}, ${stop.State} ${stop.Zip}
CATEGORIES:Route Planning,Alice Care,Business Development
PRIORITY:5
TRANSP:OPAQUE
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT
`;
            });

            icsContent += `END:VCALENDAR`;
            console.log(`✅ ICS file generated with ${eventCount} events`);
            return icsContent;
        }

        function formatDateTimeForICS(date) {
            // Format date in LOCAL timezone, not UTC
            // This prevents the timezone conversion issue
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        }

        function escapeICSString(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/,/g, '\\,')
                .replace(/;/g, '\\;')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r');
        }

        function downloadICS(icsContent, filename) {
            try {
                const element = document.createElement('a');
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                element.setAttribute('href', url);
                element.setAttribute('download', filename);
                element.style.display = 'none';
                
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                URL.revokeObjectURL(url);
                showToast(`✅ Downloaded: ${filename}`, 'success');
            } catch (err) {
                console.error('Download error:', err);
                showToast('Failed to download ICS file', 'error');
            }
        }

        // Alias for backward compatibility
        function populateRoutePlannerCities() {
            populateRouteCities();
        }

        function generateRoutePlan() {
            console.log('🚀 GENERATE ROUTE PLAN STARTED');
            
            // Get selected cities from checkboxes
            const checkedBoxes = document.querySelectorAll('.route-city-checkbox input[type="checkbox"]:checked');
            const selectedOptions = Array.from(checkedBoxes).map(box => box.value);
            
            const zone = document.getElementById('routeZone').value;
            const planDate = document.getElementById('routePlanDate').value;
            const startTime = document.getElementById('routeStartTime').value;
            const duration = parseInt(document.getElementById('routeVisitDuration').value);
            const travelBuffer = parseInt(document.getElementById('routeTravelBuffer').value) || 0;
            
            console.log('  Cities selected:', selectedOptions);
            console.log('  Zone:', zone);
            console.log('  Plan Date:', planDate);
            console.log('  Start Time:', startTime);
            console.log('  Visit Duration:', duration);
            console.log('  Travel Buffer:', travelBuffer);
            
            if (!selectedOptions || selectedOptions.length === 0) {
                showToast('Please select at least one city', 'warning');
                return;
            }
            
            if (!startTime) {
                showToast('Please select a start time', 'warning');
                return;
            }
            
            if (!duration || duration < 15) {
                showToast('Visit duration must be at least 15 minutes', 'warning');
                return;
            }
            
            console.log('✅ All validations passed');
            
            // Combine routes from all selected cities
            let combinedRoute = [];
            selectedOptions.forEach(city => {
                console.log('📞 Generating route for city:', city);
                const route = generateRoute(city, startTime, duration, travelBuffer, planDate);
                combinedRoute = combinedRoute.concat(route);
            });
            
            // Re-sequence the combined route with travel buffer
            combinedRoute.forEach((stop, index) => {
                stop.Order = index + 1;
                
                // Create date using selected planDate in LOCAL timezone (not UTC)
                let arrivalTime;
                if (planDate) {
                    const [year, month, day] = planDate.split('-').map(Number);
                    arrivalTime = new Date(year, month - 1, day, parseInt(startTime.split(':')[0]), parseInt(startTime.split(':')[1]), 0);
                } else {
                    arrivalTime = new Date();
                    arrivalTime.setHours(parseInt(startTime.split(':')[0]), parseInt(startTime.split(':')[1]), 0);
                }
                
                // Add cumulative time: (index * (duration + travel))
                const cumulativeMinutes = index * (duration + travelBuffer);
                arrivalTime.setTime(arrivalTime.getTime() + cumulativeMinutes * 60000);
                
                const departureTime = new Date(arrivalTime);
                departureTime.setTime(departureTime.getTime() + duration * 60000);
                
                stop.EstimatedArrivalTime = arrivalTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
                stop.EstimatedDepartureTime = departureTime.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
                stop._arrivalDate = arrivalTime;
                stop._departureDate = departureTime;
            });
            
            console.log('Route generated:', combinedRoute.length, 'total stops');
            
            if (combinedRoute.length === 0) {
                console.warn('⚠️ No organizations found for selected cities');
                showToast('No organizations found. Check that organizations have Status=Active.', 'warning');
                return;
            }
            
            state.currentRoute = combinedRoute;
            state.currentRouteCity = selectedOptions.join(', ');
            state.currentRouteZone = zone;
            state.currentRoutePlanDate = planDate;
            state.currentTravelBuffer = travelBuffer;
            
            console.log('✅ Route plan ready for display');
            displayRoute(combinedRoute, selectedOptions.join(', '), duration, planDate, travelBuffer);
        }

        function displayRoute(route, city, durationMinutes, planDate = '', travelBuffer = 0) {
            const resultsDiv = document.getElementById('routeResults');
            const stopsDiv = document.getElementById('routeStops');
            
            if (!resultsDiv || !stopsDiv) return;
            
            document.getElementById('routeResultsCity').textContent = city;
            
            // Format date for display
            let dateDisplay = planDate ? new Date(planDate).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'}) : 'Unscheduled';
            document.getElementById('routeResultsDate').textContent = dateDisplay;
            
            let stopsHTML = `<div class="route-stats">
                <span class="stat-badge">📍 ${route.length} stops</span>
                <span class="stat-badge">⏱️ ${route[route.length - 1].EstimatedDepartureTime}</span>
                <span class="stat-badge">⏰ ${durationMinutes} min each</span>
            </div>`;
            
            stopsHTML += '<div class="route-stops-list">';
            
            route.forEach((stop, index) => {
                const daysOverdueColor = stop.DaysOverdue > 60 ? '#dc3545' : stop.DaysOverdue > 30 ? '#fd7e14' : '#28a745';
                
                stopsHTML += `
                <div class="route-stop">
                    <div class="route-stop-number">${stop.Order}</div>
                    <div class="route-stop-content">
                        <div class="route-stop-name">${stop.Name}</div>
                        <div class="route-stop-details">
                            <div class="detail-address">📍 ${stop.Address}, ${stop.City}</div>
                            <div class="detail-time">🕐 ${stop.EstimatedArrivalTime} - ${stop.EstimatedDepartureTime}</div>
                            <div class="detail-overdue" style="color: ${daysOverdueColor};">
                                📅 ${stop.DaysOverdue} days overdue
                            </div>
                        </div>
                        <div class="route-stop-footer">
                            <span class="phone-link">☎️ ${stop.Phone || 'No phone'}</span>
                        </div>
                    </div>
                    <input type="checkbox" class="route-stop-include" data-index="${index}" 
                           ${stop.Include ? 'checked' : ''} onchange="updateRouteSelection(${index})">
                </div>
                `;
            });
            
            stopsHTML += '</div>';
            stopsDiv.innerHTML = stopsHTML;
            resultsDiv.style.display = 'block';
            
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateRouteSelection(index) {
            if (!state.currentRoute) return;
            const checkbox = document.querySelector(`[data-index="${index}"]`);
            state.currentRoute[index].Include = checkbox.checked;
        }

        function exportRouteToCalendar() {
            if (!state.currentRoute || state.currentRoute.length === 0) {
                showToast('No route to export', 'warning');
                return;
            }
            
            const includedStops = state.currentRoute.filter(stop => stop.Include);
            
            if (includedStops.length === 0) {
                showToast('Please select at least one stop', 'warning');
                return;
            }
            
            try {
                const planDate = state.currentRoutePlanDate || new Date().toISOString().split('T')[0];
                const icsContent = generateICSFile(state.currentRoute, state.currentRouteCity, planDate);
                const filename = `${state.currentRouteCity}_Route_${planDate}.ics`;
                downloadICS(icsContent, filename);
                console.log('✅ Exported route with', includedStops.length, 'stops for date:', planDate);
            } catch (err) {
                console.error('Export error:', err);
                showToast('Failed to export route', 'error');
            }
        }

        // ============================================
        // ZONE & CITY FILTERING FUNCTIONS
        // ============================================

        function getRoutePlannerZones() {
            const zonesArray = []; // Array of {code, name} objects
            if (state.settings && state.settings.zones) {
                state.settings.zones.forEach(z => {
                    if (typeof z === 'object' && z.code && z.name) {
                        zonesArray.push({ code: z.code, name: z.name });
                    } else if (typeof z === 'string') {
                        zonesArray.push({ code: z, name: z });
                    }
                });
            }
            return zonesArray.sort((a, b) => a.name.localeCompare(b.name));
        }

        function populateRouteZones() {
            const select = document.getElementById('routeZone');
            if (!select) return;
            
            const zones = getRoutePlannerZones();
            console.log('📍 Loading zones:', zones.map(z => `${z.code}-${z.name}`));
            
            // Clear except "All Zones"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.code; // Use CODE as value
                option.textContent = zone.name; // Show NAME to user
                select.appendChild(option);
            });
            
            console.log('✅ Route zones populated');
        }

        function getCitiesForZone(zone) {
            if (!zone) {
                // Return all cities
                return getRoutePlannerCities();
            }
            
            console.log(`🔍 Filtering cities for zone CODE: "${zone}"`);
            console.log(`📊 Total organizations: ${state.organizations.length}`);
            
            // Show what zones exist in the database
            const zonesInDB = new Set();
            state.organizations.forEach(org => {
                if (org.Zone) {
                    zonesInDB.add(org.Zone);
                }
            });
            if (zonesInDB.size > 0) {
                console.log('   Zone codes in database:', Array.from(zonesInDB).sort());
            }
            
            // Filter cities by zone CODE (not name)
            // The zone parameter is the CODE (e.g., "SMF", "SDG")
            const citiesSet = new Set();
            let matchCount = 0;
            
            state.organizations.forEach(org => {
                if (org.Status === 'Active' && org.City && org.Zone) {
                    // Match organization ZONE field against the zone CODE parameter
                    if (org.Zone.trim() === zone.trim()) {
                        citiesSet.add(org.City);
                        matchCount++;
                    }
                }
            });
            
            const cities = Array.from(citiesSet).sort();
            console.log(`✅ Found ${cities.length} cities for zone code "${zone}" (${matchCount} active organizations)`);
            if (cities.length > 0) {
                console.log('   Cities:', cities);
            } else {
                console.warn(`⚠️ No cities found for zone code "${zone}". Check that organization ZONE field matches exactly.`);
            }
            
            return cities;
        }

        function updateRouteCitiesForZone() {
            const zoneSelect = document.getElementById('routeZone');
            const citiesContainer = document.getElementById('routeCityCheckboxes');
            
            if (!zoneSelect || !citiesContainer) return;
            
            const selectedZone = zoneSelect.value;
            const cities = getCitiesForZone(selectedZone);
            
            // Clear existing checkboxes
            citiesContainer.innerHTML = '';
            
            console.log(`📍 Cities for zone "${selectedZone}":`, cities);
            
            if (cities.length === 0) {
                citiesContainer.innerHTML = '<div style="padding: 8px; color: #999;">No cities in this zone</div>';
                return;
            }
            
            // Add checkboxes for each city
            cities.forEach(city => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'route-city-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = city;
                checkbox.id = `city_${city.replace(/\s+/g, '_')}`;
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = city;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                citiesContainer.appendChild(checkboxDiv);
            });
            
            console.log('✅ City checkboxes populated:', cities);
        }

        function updateRouteCitiesDisplay() {
            // This function is no longer needed but kept for compatibility
        }

        // Initial population of city checkboxes
        function populateRouteCities() {
            const citiesContainer = document.getElementById('routeCityCheckboxes');
            if (!citiesContainer) return;
            
            const cities = getRoutePlannerCities();
            console.log('📍 Initial cities available:', cities);
            
            citiesContainer.innerHTML = '';
            
            cities.forEach(city => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'route-city-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = city;
                checkbox.id = `city_${city.replace(/\s+/g, '_')}`;
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = city;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                citiesContainer.appendChild(checkboxDiv);
            });
        }

        function saveRoutePlan() {
            if (!state.currentRoute || state.currentRoute.length === 0) {
                showToast('No route to save', 'warning');
                return;
            }
            
            const planDate = state.currentRoutePlanDate;
            const zone = state.currentRouteZone;
            const city = state.currentRouteCity;
            const stops = state.currentRoute;
            
            if (!state.routePlans) {
                state.routePlans = [];
            }
            
            const routePlan = {
                id: 'plan_' + Date.now(),
                date: planDate,
                zone: zone,
                city: city,
                stops: stops.filter(s => s.Include).map(s => ({
                    orgId: s.ID,
                    orgName: s.Name,
                    address: s.Address,
                    arrivalTime: s.EstimatedArrivalTime,
                    departureTime: s.EstimatedDepartureTime,
                    completed: false
                })),
                createdAt: new Date().toISOString(),
                status: 'active'
            };
            
            state.routePlans.push(routePlan);
            
            console.log('💾 Route plan saved:', routePlan);
            showToast(`✅ Route plan saved for ${new Date(planDate).toLocaleDateString()}`, 'success');
            
            // You can sync this to your backend later
            // apiCall('saveRoutePlan', routePlan);
        }

        // ============================================
        // ROUTE PLANNER TOGGLE
        // ============================================

        function toggleRoutePlanner() {
            const content = document.getElementById('routePlannerContent');
            const toggle = document.querySelector('.route-planner-toggle');
            
            if (!content || !toggle) return;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.classList.add('open');
                console.log('✅ Route Planner expanded');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('open');
                console.log('✅ Route Planner collapsed');
            }
        }

        function clearRoutePlanner() {
            console.log('🔄 Clearing route planner...');
            
            // Reset form inputs
            document.getElementById('routeZone').value = '';
            document.getElementById('routePlanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('routeStartTime').value = '09:00';
            document.getElementById('routeVisitDuration').value = '30';
            document.getElementById('routeTravelBuffer').value = '15';
            
            // Uncheck all city checkboxes
            document.querySelectorAll('.route-city-checkbox input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Hide results
            const routeResults = document.getElementById('routeResults');
            const routeControls = document.getElementById('routePlannerContent');
            if (routeResults) routeResults.style.display = 'none';
            if (routeControls) routeControls.style.display = 'block';
            
            // Reset state
            state.currentRoute = [];
            state.currentRouteCity = '';
            state.currentRouteZone = '';
            state.currentRoutePlanDate = new Date().toISOString().split('T')[0];
            state.currentTravelBuffer = 0;
            
            console.log('✅ Route planner cleared - ready for new route');
            showToast('Route planner cleared. Ready to plan a new route!', 'success');
        }

        function initializeRoutePlanner() {
            populateRouteZones();
            populateRouteCities();  // Use the new checkbox population function
            
            // Set today as default date
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('routePlanDate');
            if (dateInput) dateInput.value = today;
            
            state.currentRoute = [];
            state.currentRouteCity = '';
            state.currentRouteZone = '';
            state.currentRoutePlanDate = today;
            state.currentTravelBuffer = 0;
            state.routePlans = state.routePlans || [];
            
            console.log('✅ Route Planner initialized');
        }


                // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initQuillEditors();
            setupEventListeners();
            getLocation();
            
            // Wait for Google library to load
            if (typeof google !== 'undefined') {
                initGoogleSignIn();
            } else {
                setTimeout(() => {
                    if (typeof google !== 'undefined') {
                        initGoogleSignIn();
                    }
                }, 1000);
            }
            
            initApp();
        });
        
        function initQuillEditors() {
            // Template editor
            templateEditor = new Quill('#templateBodyEditor', {
                theme: 'snow',
                modules: { toolbar: quillToolbar },
                placeholder: 'Compose your email template here...'
            });
            
            // Compose editor
            composeEditor = new Quill('#composeBodyEditor', {
                theme: 'snow',
                modules: { toolbar: quillToolbar },
                placeholder: 'Write your message...'
            });
        }
        
        function insertVariable(varName, editorType) {
            const variable = `{{${varName}}}`;
            const editor = editorType === 'template' ? templateEditor : composeEditor;
            
            // Get current cursor position or end of content
            const range = editor.getSelection();
            const position = range ? range.index : editor.getLength();
            
            // Insert the variable at cursor position
            editor.insertText(position, variable);
            
            // Move cursor after the inserted variable
            editor.setSelection(position + variable.length);
            
            // Focus the editor
            editor.focus();
        }
        
        function insertCustomVariable(editorType) {
            const inputId = 'customVariableName';
            const input = document.getElementById(inputId);
            const varName = input.value.trim();
            
            if (!varName) {
                showToast('Enter a variable name', 'error');
                input.focus();
                return;
            }
            
            // Clean the variable name (remove spaces, special chars)
            const cleanName = varName.toLowerCase().replace(/[^a-z0-9_]/g, '_');
            
            insertVariable(cleanName, editorType);
            
            // Clear input
            input.value = '';
            
            showToast(`Inserted {{${cleanName}}}`, 'success');
        }
        
        function insertVariableToSubject(varName) {
            const input = document.getElementById('templateSubject');
            const variable = `{{${varName}}}`;
            
            // Get cursor position
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            
            // Insert at cursor or append
            input.value = value.substring(0, start) + variable + value.substring(end);
            
            // Move cursor after inserted variable
            input.selectionStart = input.selectionEnd = start + variable.length;
            input.focus();
        }
        
        function insertSubjectVar(selectEl) {
            const varName = selectEl.value;
            if (!varName) return;
            
            insertVariableToSubject(varName);
            
            // Reset dropdown
            selectEl.value = '';
        }

        async function initApp() {
            // Try to load cached data first for instant display
            const cachedData = localStorage.getItem('busdev_cache');
            if (cachedData) {
                try {
                    const cached = JSON.parse(cachedData);
                    state.organizations = cached.organizations || [];
                    state.contacts = cached.contacts || [];
                    state.visits = cached.visits || [];
                    state.teamMembers = cached.teamMembers || [];
                    state.emailTemplates = cached.emailTemplates || [];
                    state.assetCategories = cached.assetCategories || getDefaultAssetCategories();
                    state.assetItems = cached.assetItems || getDefaultAssetItems();
                    state.stockHistory = cached.stockHistory || [];
                    state.settings = cached.settings || state.settings;
                    state.user = cached.user || null;
                    ensureSettingsDefaults();
                    updateUserDisplay();
                    renderAll();
                    console.log('✅ Loaded from cache - Orgs:', state.organizations.length, 'Visits:', state.visits.length);
                } catch (e) { 
                    console.log('Cache parse error', e); 
                }
            } else {
                // Initialize with defaults if no cache
                state.assetCategories = getDefaultAssetCategories();
                state.assetItems = getDefaultAssetItems();
                ensureSettingsDefaults();
            }
            
            showLoading(true);
            try {
                console.log('📡 Fetching data from Google Apps Script...');
                console.log('Apps Script URL:', APPS_SCRIPT_URL);
                console.log('Google ID Token present:', !!googleIdToken);
                
                // Fetch data and user in parallel for speed
                const promises = [
                    apiCall('getAllData').catch(err => { console.warn('getAllData failed:', err); return { success: false }; }),
                    apiCall('getCurrentUser').catch(err => { console.warn('getCurrentUser failed:', err); return { success: false }; })
                ];
                
                const [dataResponse, userResponse] = await Promise.all(promises);
                
                console.log('Data Response:', dataResponse);
                console.log('User Response:', userResponse);
                
                if (dataResponse && dataResponse.success) {
                    console.log('✅ Data received from server');
                    state.organizations = dataResponse.data?.organizations || [];
                    state.contacts = dataResponse.data?.contacts || [];
                    state.visits = dataResponse.data?.visits || [];
                    state.teamMembers = dataResponse.data?.teamMembers || [];
                    state.emailTemplates = dataResponse.data?.emailTemplates || [];
                    state.assetCategories = dataResponse.data?.assetCategories || state.assetCategories || getDefaultAssetCategories();
                    state.assetItems = dataResponse.data?.assetItems || state.assetItems || getDefaultAssetItems();
                    state.stockHistory = dataResponse.data?.stockHistory || [];
                    if (dataResponse.data?.settings) {
                        state.settings = { ...state.settings, ...dataResponse.data.settings };
                    }
                    
                    console.log('✅ State updated - Orgs:', state.organizations.length, 'Visits:', state.visits.length);
                    
                                        initializeRoutePlanner();                    // Ensure all settings have proper defaults
                    ensureSettingsDefaults();
                    
                    if (userResponse?.success) {
                        state.user = userResponse.user;
                    }
                    
                    // Cache the data for faster next load
                    localStorage.setItem('busdev_cache', JSON.stringify({
                        organizations: state.organizations,
                        contacts: state.contacts,
                        visits: state.visits,
                        teamMembers: state.teamMembers,
                        emailTemplates: state.emailTemplates,
                        assetCategories: state.assetCategories,
                        assetItems: state.assetItems,
                        stockHistory: state.stockHistory,
                        settings: state.settings,
                        user: state.user,
                        timestamp: Date.now()
                    }));
                    
                    updateUserDisplay();
                    renderAll();
                    checkLowStock();
                    if (!cachedData) showToast('✅ Data loaded from server', 'success');
                } else {
                    console.warn('⚠️ Server returned error or no data');
                    if (!cachedData) {
                        showToast('Working offline - using default data', 'info');
                    }
                }
            } catch (err) {
                console.error('❌ Failed to fetch from server:', err);
                if (!cachedData) {
                    showToast('Unable to connect to server. Using defaults.', 'warning');
                }
            }
            showLoading(false);
        }
        
        function ensureSettingsDefaults() {
            if (!state.settings) state.settings = {};
            if (!state.settings.outcomes) state.settings.outcomes = [
                'Not Available - Left Materials',
                'Interested - Schedule Follow-up',
                'Meeting Scheduled',
                'Referral Received',
                'Not Interested'
            ];
            if (!state.settings.zones) state.settings.zones = [
                { code: 'SMF', name: 'Sacramento' },
                { code: 'SDG', name: 'San Diego' }
            ];
            if (!state.settings.lowStockThreshold) state.settings.lowStockThreshold = 50;
            if (state.settings.lowStockEmailEnabled === undefined) state.settings.lowStockEmailEnabled = true;
            
            // Initialize organization types from actual data
            initializeOrgTypes();
        }
        
        function getUniqueOrgTypes() {
            const types = new Set(state.organizations
                .map(org => org.Type)
                .filter(type => type && type.trim())
            );
            return Array.from(types).sort();
        }
        
        function initializeOrgTypes() {
            if (!state.settings.organizationTypes) {
                state.settings.organizationTypes = [];
            }
            // Merge with types from actual organizations data
            const existingTypes = getUniqueOrgTypes();
            const merged = new Set([...state.settings.organizationTypes, ...existingTypes]);
            state.settings.organizationTypes = Array.from(merged).sort();
        }
        
        function getDefaultAssetCategories() {
            return [
                { ID: 'cat_brochures', Name: 'Brochures', Icon: 'description', ShowInCheckin: true },
                { ID: 'cat_cards', Name: 'Business Cards', Icon: 'contact_page', ShowInCheckin: true }
            ];
        }
        
        function getDefaultAssetItems() {
            return [
                { ID: 'item_1', Category_ID: 'cat_brochures', Name: 'General Brochure', Quantity: 0, Threshold: 50, Zones: ['all'] },
                { ID: 'item_2', Category_ID: 'cat_brochures', Name: 'Hospice Brochure', Quantity: 0, Threshold: 50, Zones: ['all'] },
                { ID: 'item_3', Category_ID: 'cat_brochures', Name: 'Home Health Brochure', Quantity: 0, Threshold: 50, Zones: ['all'] },
                { ID: 'item_4', Category_ID: 'cat_cards', Name: 'Standard Business Card', Quantity: 0, Threshold: 100, Zones: ['all'] }
            ];
        }
        
        function ensureSettingsDefaults() {
            // Ensure all required settings exist with defaults
            if (!state.settings) state.settings = {};
            if (!state.settings.outcomes) {
                state.settings.outcomes = [
                    'Not Available - Left Materials',
                    'Interested - Schedule Follow-up',
                    'Meeting Scheduled',
                    'Referral Received',
                    'Not Interested'
                ];
            }
            if (!state.settings.organizationTypes) {
                state.settings.organizationTypes = [
                    'Hospice',
                    'Hospital',
                    'Skilled Nursing Facility',
                    'Assisted Living',
                    'Home Health Agency',
                    'Private Practice',
                    'Clinic',
                    'Healthcare Facility',
                    'Venture Capital',
                    'Other'
                ];
            }
            if (!state.settings.zones) {
                state.settings.zones = [
                    { code: 'SMF', name: 'Sacramento' },
                    { code: 'SDG', name: 'San Diego' }
                ];
            }
            if (state.settings.lowStockEmailEnabled === undefined) {
                state.settings.lowStockEmailEnabled = true;
            }
            if (!state.settings.lowStockThreshold) {
                state.settings.lowStockThreshold = 50;
            }
        }

        function showConnectionError(message) {
            document.getElementById('userName').textContent = 'Not Connected';
            document.getElementById('userZones').textContent = '--';
            
            // Show error in main content area
            document.querySelector('.main-content').innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px;">
                    <span class="material-icons-outlined" style="font-size: 80px; color: var(--danger); margin-bottom: 20px;">cloud_off</span>
                    <h2 style="color: var(--navy); margin-bottom: 12px;">Connection Error</h2>
                    <p style="color: var(--gray-600); max-width: 500px; margin-bottom: 24px;">${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <span class="material-icons-outlined">refresh</span> Retry Connection
                    </button>
                </div>
            `
        }

        // ============================================
        // API
        // ============================================
        function apiCall(action, params = {}) {
            return new Promise((resolve, reject) => {
                console.log('📤 API Call:', action);
                
                // Build URL with query parameters
                let url = APPS_SCRIPT_URL + '?callback=cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '&action=' + action;
                if (googleIdToken) url += '&token=' + encodeURIComponent(googleIdToken);
                for (let key in params) url += '&' + key + '=' + encodeURIComponent(params[key]);
                
                console.log('URL:', url);
                
                // Use JSONP for Google Apps Script (only reliable method)
                const callbackName = url.match(/callback=([^&]+)/)[1];
                
                window[callbackName] = function(response) {
                    console.log('✅ JSONP Response:', response);
                    delete window[callbackName];
                    const script = document.getElementById(callbackName);
                    if (script) script.remove();
                    resolve(response);
                };
                
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = url;
                script.onerror = () => {
                    console.error('❌ JSONP request failed for:', action);
                    delete window[callbackName]; 
                    script.remove(); 
                    reject(new Error('Request failed: ' + action)); 
                };
                document.body.appendChild(script);
                
                // Timeout after 15 seconds
                setTimeout(() => { 
                    if (window[callbackName]) { 
                        console.error('❌ JSONP timeout for:', action);
                        delete window[callbackName]; 
                        const s = document.getElementById(callbackName);
                        if (s) s.remove();
                        reject(new Error('Timeout: ' + action)); 
                    } 
                }, 15000);
            });
        }

        async function apiPost(action, data) {
            try {
                console.log('📤 POST Request:', action);
                console.log('Data:', data);
                
                // Google Apps Script doesn't support CORS with JSON, so use no-cors
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',  // Bypass CORS check - required for Google Apps Script
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, token: googleIdToken, ...data })
                });
                
                console.log('✅ POST sent (no-cors mode - cannot read response)');
                console.log('Data was sent to server. Reloading to verify...');
                
                // Since we can't read the response with no-cors, assume success and reload data
                // This verifies the change was actually saved
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief delay for server processing
                
                return { success: true, message: 'Data sent to server' };
            } catch (err) { 
                console.error('❌ POST error:', err);
                return { success: false, error: err.message }; 
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Defensively attach listeners only if elements exist
            const attachIfExists = (id, event, handler) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener(event, handler);
            };
            
            attachIfExists('orgSearch', 'input', renderOrganizations);
            attachIfExists('contactSearch', 'input', renderContacts);
            attachIfExists('orgZoneFilter', 'change', renderOrganizations);
            attachIfExists('visitZoneFilter', 'change', renderVisits);
        }

        function switchTab(tabId) {
            console.log('switchTab called with:', tabId);
            try {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
                const tabContent = document.getElementById(`tab-${tabId}`);
                
                console.log('Tab button found:', !!tabButton);
                console.log('Tab content found:', !!tabContent);
                
                if (tabButton) {
                    tabButton.classList.add('active');
                } else {
                    console.warn('Tab button not found for:', tabId);
                }
                
                if (tabContent) {
                    tabContent.classList.add('active');
                } else {
                    console.warn('Tab content not found for:', tabId);
                }
                
                if (tabId === 'emails') loadInbox();
                if (tabId === 'templates') renderTemplates();
                if (tabId === 'assets') { renderAssets(); checkLowStock(); }
                if (tabId === 'settings') renderSettings();
                if (tabId === 'checkin') renderCheckinAssets();
                if (tabId === 'directory') { renderDirectory(); closeDetailPanel(); }
            } catch (err) {
                console.error('Error in switchTab:', err);
            }
        }

        // ============================================
        // RENDER
        // ============================================
        function renderAll() {
            try {
                updateDashboard();
            } catch (e) { console.warn('Error updating dashboard:', e); }
            
            try {
                renderDirectory();
            } catch (e) { console.warn('Error rendering directory:', e); }
            
            try {
                renderVisits();
            } catch (e) { console.warn('Error rendering visits:', e); }
            
            try {
                renderTeam();
            } catch (e) { console.warn('Error rendering team:', e); }
            
            try {
                renderTemplates();
            } catch (e) { console.warn('Error rendering templates:', e); }
            
            try {
                populateDropdowns();
            } catch (e) { console.warn('Error populating dropdowns:', e); }
            
            try {
                renderTodayVisits();
            } catch (e) { console.warn('Error rendering today visits:', e); }
            
            try {
                renderCheckinAssets();
            } catch (e) { console.warn('Error rendering checkin assets:', e); }
            
            try {
                renderAssets();
            } catch (e) { console.warn('Error rendering assets:', e); }
            
            try {
                renderSettings();
            } catch (e) { console.warn('Error rendering settings:', e); }
        }

        function updateUserDisplay() {
            if (state.user) {
                document.getElementById('userName').textContent = state.user.name || state.user.email;
                document.getElementById('userZones').textContent = state.user.zones?.join(', ') || 'All';
            }
        }

        // Store chart instances globally to destroy them before creating new ones
        let dashboardCharts = {};
        
        // ✅ NEW: Dashboard filter state
        let dashboardZoneFilter = []; // Empty = all zones

        function updateDashboard() {
            // ✅ NEW: Render zone filter checkboxes on first load
            const zoneFilterDiv = document.getElementById('zoneFilterCheckboxes');
            if (zoneFilterDiv) {
                // ✅ FIXED: Always render zones and preserve checked state
                const zones = state.settings?.zones || [];
                if (zones.length > 0) {
                    zoneFilterDiv.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" value="all-zones" onchange="toggleAllZones()" id="allZonesCheckbox">
                            <span>All Zones</span>
                        </label>
                    ` + zones.map(zone => `
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" value="${zone.code}" class="zone-filter-checkbox" ${dashboardZoneFilter.includes(zone.code) ? 'checked' : ''}>
                            <span>${zone.name}</span>
                        </label>
                    `).join('');
                }
            }
            
            // Defensive checks - elements might not exist if dashboard not loaded
            const statOrgs = document.getElementById('statOrgs');
            const statVisitsMonth = document.getElementById('statVisitsMonth');
            const statDue = document.getElementById('statDue');
            const statBrochures = document.getElementById('statBrochures');
            const statContacts = document.getElementById('statContacts');
            const statVisitsYear = document.getElementById('statVisitsYear');
            
            if (!statOrgs || !statVisitsMonth || !statDue || !statBrochures) {
                console.log('Dashboard elements not found, skipping update');
                return;
            }
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const userZones = state.user?.zones || [];
            
            // ✅ FIXED: Use dashboardZoneFilter if set, otherwise use userZones
            const selectedZones = dashboardZoneFilter.length > 0 ? dashboardZoneFilter : userZones;
            const filteredOrgs = selectedZones.length ? state.organizations.filter(o => selectedZones.includes(o.Zone)) : state.organizations;
            const filteredVisits = selectedZones.length ? state.visits.filter(v => {
                const org = state.organizations.find(org => org.ID === v.Org_ID);
                return org && selectedZones.includes(org.Zone);
            }) : state.visits;
            
            statOrgs.textContent = filteredOrgs.length;
            statVisitsMonth.textContent = filteredVisits.filter(v => new Date(v.Visit_Date) >= monthStart).length;
            statVisitsYear.textContent = filteredVisits.filter(v => new Date(v.Visit_Date) >= yearStart).length;
            statContacts.textContent = state.contacts.filter(c => {
                const org = state.organizations.find(org => org.ID === c.Org_ID);
                return org && (selectedZones.length === 0 || selectedZones.includes(org.Zone));
            }).length;
            
            const dueOrgs = filteredOrgs.filter(o => o.Next_Visit_Due && new Date(o.Next_Visit_Due) <= now);
            statDue.textContent = dueOrgs.length;
            
            const totalBrochures = filteredVisits.reduce((sum, v) => sum + (parseInt(v.Brochures_General) || 0) + (parseInt(v.Brochures_Hospice) || 0) + (parseInt(v.Brochures_HomeHealth) || 0), 0);
            statBrochures.textContent = totalBrochures;
            
            const tbody = document.querySelector('#dueOrgsTable tbody');
            if (tbody) {
                tbody.innerHTML = dueOrgs.slice(0, 10).map(org => {
                    const lastVisit = getLastVisitDate(org.ID);
                    const visitClass = getVisitDateClass(lastVisit);
                    const visitText = formatVisitDate(lastVisit);
                    return `
                <tr class="clickable-row" onclick="switchTab('directory'); setTimeout(() => openDetailPanel('org', '${org.ID}'), 100);">
                    <td><strong>${esc(org.Name)}</strong></td>
                    <td>${esc(org.Type || '-')}</td>
                    <td><span class="zone-badge">${org.Zone}</span></td>
                    <td><span class="visit-date-badge ${visitClass}">${visitText}</span></td>
                    <td><span class="status-badge status-due">${org.Next_Visit_Due}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openVisitForOrg('${org.ID}')">Log Visit</button></td>
                </tr>
            `}).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--gray-400);">All caught up!</td></tr>';
            }
            
            // ✅ Render all dashboard visualizations
            setTimeout(() => {
                renderMonthlyTrendsChart();
                renderOrganizationsChart();
                renderWeeklyChart();
                renderMonthlyComparisonChart();
                renderActivityTimeline();
                renderZonePerformance();
            }, 100);
        }
        
        // ✅ NEW: Dashboard filter functions
        function applyDashboardFilters() {
            const checkboxes = document.querySelectorAll('.zone-filter-checkbox:checked');
            dashboardZoneFilter = Array.from(checkboxes).map(cb => cb.value);
            updateDashboard();
        }
        
        function resetDashboardFilters() {
            dashboardZoneFilter = [];
            document.querySelectorAll('.zone-filter-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('allZonesCheckbox').checked = false;
            updateDashboard();
        }
        
        function toggleAllZones() {
            const allCheckbox = document.getElementById('allZonesCheckbox');
            const zoneCheckboxes = document.querySelectorAll('.zone-filter-checkbox');
            zoneCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
        }
        
        // ✅ NEW: Monthly Trends Chart (Last 6 months)
        function renderMonthlyTrendsChart() {
            const canvas = document.getElementById('monthlyTrendsChart');
            if (!canvas) return;
            
            // Get last 6 months of data
            const months = [];
            const visitCounts = [];
            const now = new Date();
            
            // ✅ FIXED: Apply zone filter to visits
            const filteredVisits = dashboardZoneFilter.length > 0 ? state.visits.filter(v => {
                const org = state.organizations.find(org => org.ID === v.Org_ID);
                return org && dashboardZoneFilter.includes(org.Zone);
            }) : state.visits;
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = date.toLocaleString('default', { month: 'short', year: '2-digit' });
                months.push(monthName);
                
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 1);
                const monthVisits = filteredVisits.filter(v => {
                    const vDate = new Date(v.Visit_Date);
                    return vDate >= monthStart && vDate < monthEnd;
                });
                visitCounts.push(monthVisits.length);
            }
            
            // Destroy old chart if exists
            if (dashboardCharts.monthlyTrends) {
                dashboardCharts.monthlyTrends.destroy();
            }
            
            dashboardCharts.monthlyTrends = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Visits',
                        data: visitCounts,
                        borderColor: '#F57600',
                        backgroundColor: 'rgba(245, 118, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#F57600',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        // ✅ NEW: Organizations Pie Chart
        // ✅ NEW: Updated Organizations Chart with Zone Filter and View Options
        function updateOrganizationsChart() {
            renderOrganizationsChart();
        }
        
        function renderOrganizationsChart() {
            const canvas = document.getElementById('organizationsChart');
            if (!canvas) return;
            
            // ✅ NEW: Get zone filter
            const selectedZones = dashboardZoneFilter.length > 0 ? dashboardZoneFilter : null;
            
            // ✅ NEW: Get view option (top5, top10, all)
            const viewOption = document.querySelector('input[name="orgChartView"]:checked')?.value || 'top10';
            
            // Count organizations by type, filtered by zones
            const typeCount = {};
            const colors = ['#F57600', '#1A365C', '#10B981', '#F59E0B', '#3B82F6', '#EF4444', '#8B5CF6', '#EC4899', '#F97316', '#14B8A6'];
            
            state.organizations.forEach(org => {
                // Apply zone filter
                if (selectedZones && !selectedZones.includes(org.Zone)) return;
                
                const type = org.Type || 'Other';
                typeCount[type] = (typeCount[type] || 0) + 1;
            });
            
            // ✅ NEW: Sort and limit by view option
            let entries = Object.entries(typeCount).sort((a, b) => b[1] - a[1]);
            
            if (viewOption === 'top5') {
                entries = entries.slice(0, 5);
            } else if (viewOption === 'top10') {
                entries = entries.slice(0, 10);
            }
            // else: all (no limit)
            
            const labels = entries.map(e => e[0]);
            const data = entries.map(e => e[1]);
            
            // Destroy old chart if exists
            if (dashboardCharts.organizations) {
                dashboardCharts.organizations.destroy();
            }
            
            dashboardCharts.organizations = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            display: labels.length > 0  // ✅ Only show legend if there are items
                        }
                    }
                }
            });
        }
        
        // ✅ NEW: Weekly Activity Chart
        function renderWeeklyChart() {
            const canvas = document.getElementById('weeklyChart');
            if (!canvas) return;
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const visitsByDay = [0, 0, 0, 0, 0, 0, 0];
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            
            // ✅ FIXED: Apply zone filter to visits
            const filteredVisits = dashboardZoneFilter.length > 0 ? state.visits.filter(v => {
                const org = state.organizations.find(org => org.ID === v.Org_ID);
                return org && dashboardZoneFilter.includes(org.Zone);
            }) : state.visits;
            
            filteredVisits.forEach(v => {
                const vDate = new Date(v.Visit_Date);
                if (vDate >= weekStart) {
                    const dayIndex = vDate.getDay();
                    visitsByDay[dayIndex]++;
                }
            });
            
            // Destroy old chart if exists
            if (dashboardCharts.weekly) {
                dashboardCharts.weekly.destroy();
            }
            
            dashboardCharts.weekly = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Visits',
                        data: visitsByDay,
                        backgroundColor: '#1A365C',
                        borderColor: '#0F2340',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        // ✅ NEW: Monthly Comparison Chart
        function renderMonthlyComparisonChart() {
            const canvas = document.getElementById('monthlyComparisonChart');
            if (!canvas) return;
            
            const now = new Date();
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const currentMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const previousMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const previousMonthEnd = currentMonthStart;
            
            // ✅ FIXED: Apply zone filter to visits
            const filteredVisits = dashboardZoneFilter.length > 0 ? state.visits.filter(v => {
                const org = state.organizations.find(org => org.ID === v.Org_ID);
                return org && dashboardZoneFilter.includes(org.Zone);
            }) : state.visits;
            
            const currentVisits = filteredVisits.filter(v => {
                const vDate = new Date(v.Visit_Date);
                return vDate >= currentMonthStart && vDate < currentMonthEnd;
            }).length;
            
            const previousVisits = filteredVisits.filter(v => {
                const vDate = new Date(v.Visit_Date);
                return vDate >= previousMonthStart && vDate < previousMonthEnd;
            }).length;
            
            const currentMonth = now.toLocaleString('default', { month: 'long' });
            const previousMonth = new Date(now.getFullYear(), now.getMonth() - 1).toLocaleString('default', { month: 'long' });
            
            // Destroy old chart if exists
            if (dashboardCharts.monthlyComparison) {
                dashboardCharts.monthlyComparison.destroy();
            }
            
            dashboardCharts.monthlyComparison = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: [previousMonth, currentMonth],
                    datasets: [{
                        label: 'Visits',
                        data: [previousVisits, currentVisits],
                        backgroundColor: ['#cbd5e1', '#F57600'],
                        borderColor: ['#94a3b8', '#CC6200'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        // ✅ NEW: Enhanced Activity Timeline (Card-based, not a list)
        function renderActivityTimeline() {
            const container = document.getElementById('activityTimelineContainer');
            if (!container) return;
            
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Build activity list from visits
            const activities = [];
            
            // ✅ FIXED: Apply zone filter to visits
            const filteredVisits = dashboardZoneFilter.length > 0 ? state.visits.filter(v => {
                const org = state.organizations.find(org => org.ID === v.Org_ID);
                return org && dashboardZoneFilter.includes(org.Zone);
            }) : state.visits;
            
            filteredVisits.forEach(v => {
                const visitDate = new Date(v.Visit_Date);
                if (visitDate >= thirtyDaysAgo) {
                    const org = state.organizations.find(o => o.ID === v.Org_ID);
                    const contact = state.contacts.find(c => c.ID === v.Contact_ID);
                    activities.push({
                        date: visitDate,
                        type: 'Visit',
                        orgName: org?.Name || 'Organization',
                        contactName: contact ? `${contact.First_Name} ${contact.Last_Name}` : 'General',
                        outcome: v.Outcome || 'No outcome recorded',
                        repName: v.Rep_Name || 'Unknown'
                    });
                }
            });
            
            // Sort by date (newest first)
            activities.sort((a, b) => b.date - a.date);
            
            if (activities.length === 0) {
                container.innerHTML = '<div style="color: var(--gray-400); text-align: center; padding: 40px; grid-column: 1/-1;">No recent activity</div>';
                return;
            }
            
            container.innerHTML = activities.slice(0, 12).map(activity => {
                const daysDiff = Math.floor((now - activity.date) / (1000 * 60 * 60 * 24));
                let timeText = formatDate(activity.date.toISOString().split('T')[0]);
                if (daysDiff === 0) timeText = 'Today';
                else if (daysDiff === 1) timeText = 'Yesterday';
                else if (daysDiff < 7) timeText = `${daysDiff} days ago`;
                
                return `
                    <div style="background: var(--gray-50); border-radius: 8px; padding: 16px; border-left: 4px solid #F57600;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary);">${esc(activity.orgName)}</div>
                            <span style="font-size: 12px; background: #FFF3E0; color: #F57600; padding: 4px 8px; border-radius: 4px;">Visit</span>
                        </div>
                        <div style="font-size: 14px; color: var(--gray-600); margin-bottom: 6px;">
                            <span style="font-weight: 500;">Contact:</span> ${esc(activity.contactName)}
                        </div>
                        <div style="font-size: 14px; color: var(--gray-600); margin-bottom: 6px;">
                            <span style="font-weight: 500;">Rep:</span> ${esc(activity.repName)}
                        </div>
                        <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 8px;">
                            <span style="font-weight: 500;">Outcome:</span> ${esc(activity.outcome)}
                        </div>
                        <div style="font-size: 12px; color: var(--gray-400);">
                            <span class="material-icons-outlined" style="font-size: 14px; vertical-align: middle;">schedule</span> ${timeText}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ✅ NEW: Enhanced Zone Performance
        function renderZonePerformance() {
            const container = document.getElementById('zonePerformanceContainer');
            if (!container) return;
            
            const zones = state.settings?.zones || [];
            if (zones.length === 0) {
                container.innerHTML = '<div style="color: var(--gray-400);">No zones configured</div>';
                return;
            }
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const yearStart = new Date(now.getFullYear(), 0, 1);
            
            // ✅ FIXED: Filter zones if dashboard filter applied
            const displayZones = dashboardZoneFilter.length > 0 
                ? zones.filter(z => dashboardZoneFilter.includes(z.code))
                : zones;
            
            container.innerHTML = displayZones.map(zone => {
                const zoneOrgs = state.organizations.filter(o => o.Zone === zone.code);
                const zoneVisitsMonth = state.visits.filter(v => {
                    const org = state.organizations.find(o => o.ID === v.Org_ID);
                    return org?.Zone === zone.code && new Date(v.Visit_Date) >= monthStart;
                });
                const zoneVisitsYear = state.visits.filter(v => {
                    const org = state.organizations.find(o => o.ID === v.Org_ID);
                    return org?.Zone === zone.code && new Date(v.Visit_Date) >= yearStart;
                });
                
                const dueInZone = zoneOrgs.filter(o => o.Next_Visit_Due && new Date(o.Next_Visit_Due) <= now).length;
                
                return `
                    <div style="background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%); border-radius: 8px; padding: 16px; border: 1px solid #E2E8F0;">
                        <div style="font-weight: 700; color: var(--navy); margin-bottom: 12px; font-size: 15px;">${zone.name}</div>
                        <div style="display: grid; gap: 8px; font-size: 13px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray-600);">Organizations:</span>
                                <span style="font-weight: 600; color: var(--navy);">${zoneOrgs.length}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray-600);">This Month:</span>
                                <span style="font-weight: 600; color: #F57600;">${zoneVisitsMonth.length}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray-600);">This Year:</span>
                                <span style="font-weight: 600; color: var(--navy);">${zoneVisitsYear.length}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #E2E8F0;">
                                <span style="color: var(--gray-600);">Due for Visit:</span>
                                <span style="font-weight: 600; color: #EF4444;">${dueInZone}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // DIRECTORY FUNCTIONS (Combined Orgs + Contacts)
        // ============================================
        let directorySortColumn = 'name';
        let directorySortAsc = true;
        
        function getLastVisitDate(orgId) {
            const orgVisits = state.visits.filter(v => v.Org_ID === orgId);
            if (orgVisits.length === 0) return null;
            return orgVisits.sort((a, b) => new Date(b.Visit_Date) - new Date(a.Visit_Date))[0].Visit_Date;
        }
        
        
        // ✅ NEW: Format date as mm/dd/yyyy
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function getVisitDateClass(dateStr) {
            if (!dateStr) return 'visit-never';
            const visitDate = new Date(dateStr);
            const today = new Date();
            const daysDiff = Math.floor((today - visitDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 14) return 'visit-recent';      // Within 2 weeks - green
            if (daysDiff <= 30) return 'visit-moderate';    // Within 1 month - yellow
            return 'visit-overdue';                          // Over 1 month - red
        }
        
        function formatVisitDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const today = new Date();
            const daysDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 0) return 'Today';
            if (daysDiff === 1) return 'Yesterday';
            if (daysDiff < 7) return `${daysDiff} days ago`;
            if (daysDiff < 30) return `${Math.floor(daysDiff / 7)} weeks ago`;
            return date.toLocaleDateString();
        }
        
        function renderDirectory() {
            const tableBody = document.querySelector('#directoryTable tbody');
            if (!tableBody) return;
            
            const search = (document.getElementById('directorySearch')?.value || '').toLowerCase();
            const zoneFilter = document.getElementById('directoryZoneFilter')?.value || '';
            const orgTypeFilter = document.getElementById('directoryOrgTypeFilter')?.value || '';  // ✅ NEW: Org type filter
            const typeFilter = document.getElementById('directoryTypeFilter')?.value || '';
            const sortBy = document.getElementById('directorySortBy')?.value || 'name';
            
            // Populate zone filter options if not yet populated
            const zoneOptionsDiv = document.getElementById('directoryZoneOptions');
            if (zoneOptionsDiv && zoneOptionsDiv.children.length === 0) {
                populateZoneOptions('directoryZone');
            }
            
            // ✅ NEW: Populate organization type dropdown
            const orgTypeFilterSelect = document.getElementById('directoryOrgTypeFilter');
            if (orgTypeFilterSelect) {
                const currentValue = orgTypeFilterSelect.value;
                const orgTypes = [...new Set(state.organizations.map(o => o.Type).filter(Boolean))].sort();
                const currentOptions = Array.from(orgTypeFilterSelect.querySelectorAll('option')).map(o => o.value);
                
                // Only update if org types have changed
                if (JSON.stringify(currentOptions.slice(1)) !== JSON.stringify(orgTypes)) {
                    orgTypeFilterSelect.innerHTML = '<option value="">All Org Types</option>' + 
                        orgTypes.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
                    orgTypeFilterSelect.value = currentValue;
                }
            }
            
            // Build combined list
            let items = [];
            
            // Add organizations
            if (typeFilter !== 'contact') {
                state.organizations.forEach(org => {
                    const lastVisit = getLastVisitDate(org.ID);
                    items.push({
                        type: 'org',
                        id: org.ID,
                        name: org.Name || '',
                        orgName: '',
                        orgId: org.ID,
                        zone: org.Zone || '',
                        orgType: org.Type || '',  // ✅ NEW: Add org type to item
                        contactInfo: `${org.City || ''} ${org.Phone ? '• ' + org.Phone : ''}`,
                        lastVisit: lastVisit,
                        email: org.Email || '',
                        data: org
                    });
                });
            }
            
            // Add contacts
            if (typeFilter !== 'org') {
                state.contacts.forEach(c => {
                    const org = state.organizations.find(o => o.ID === c.Org_ID);
                    const lastVisit = org ? getLastVisitDate(org.ID) : null;
                    items.push({
                        type: 'contact',
                        id: c.ID,
                        name: `${c.First_Name || ''} ${c.Last_Name || ''}`.trim(),
                        orgName: org?.Name || '',
                        orgId: c.Org_ID,
                        zone: org?.Zone || '',
                        orgType: org?.Type || '',  // ✅ NEW: Add org type to item
                        contactInfo: `${c.Email || ''} ${c.Phone ? '• ' + c.Phone : ''}`,
                        lastVisit: lastVisit,
                        email: c.Email || '',
                        title: c.Title || '',
                        data: c
                    });
                });
            }
            
            // Apply filters
            if (search) {
                items = items.filter(i => 
                    i.name.toLowerCase().includes(search) || 
                    i.orgName.toLowerCase().includes(search) ||
                    i.contactInfo.toLowerCase().includes(search) ||
                    i.email.toLowerCase().includes(search)
                );
            }
            if (zoneFilter) {
                items = items.filter(i => i.zone === zoneFilter);
            }
            // ✅ NEW: Filter by organization type
            if (orgTypeFilter) {
                items = items.filter(i => i.orgType === orgTypeFilter);
            }
            
            // Sort
            items.sort((a, b) => {
                let cmp = 0;
                switch (sortBy) {
                    case 'name': cmp = a.name.localeCompare(b.name); break;
                    case 'lastVisit': 
                        const aDate = a.lastVisit ? new Date(a.lastVisit) : new Date(0);
                        const bDate = b.lastVisit ? new Date(b.lastVisit) : new Date(0);
                        cmp = bDate - aDate;
                        break;
                    case 'zone': cmp = a.zone.localeCompare(b.zone); break;
                    case 'type': cmp = a.type.localeCompare(b.type); break;
                }
                return directorySortAsc ? cmp : -cmp;
            });
            
            // Render table
            tableBody.innerHTML = items.map(item => {
                const visitClass = getVisitDateClass(item.lastVisit);
                const visitText = formatVisitDate(item.lastVisit);
                
                const safeId = String(item.id).replace(/'/g, "\\'");
                return `
                    <tr class="clickable-row" onclick="openDetailPanel('${item.type}', '${safeId}')">
                        <td><strong>${esc(item.name)}</strong>${item.type === 'contact' && item.title ? `<br><small style="color:var(--gray-500)">${esc(item.title)}</small>` : (item.type === 'org' ? `<br><small style="color:var(--gray-500)">${esc(item.data?.Type || 'Organization')}</small>` : '')}</td>
                        <td>${item.type === 'contact' ? esc(item.orgName) : '-'}</td>
                        <td>${item.zone ? `<span class="zone-badge">${item.zone}</span>` : '-'}</td>
                        <td style="font-size: 13px; color: var(--gray-600);">${esc(item.contactInfo) || '-'}</td>
                        <td><span class="visit-date-badge ${visitClass}">${visitText}</span></td>
                        <td class="action-btns">
                            ${item.type === 'org' ? `
                                <button class="action-btn" onclick="event.stopPropagation(); openVisitForOrg('${safeId}')" title="Log Visit"><span class="material-icons-outlined">place</span></button>
                                <button class="action-btn" onclick="event.stopPropagation(); composeEmailForOrg('${safeId}')" title="Email"><span class="material-icons-outlined">email</span></button>
                                <button class="action-btn" onclick="event.stopPropagation(); editOrg('${safeId}')" title="Edit"><span class="material-icons-outlined">edit</span></button>
                            ` : `
                                <button class="action-btn" onclick="event.stopPropagation(); composeEmailForContact('${safeId}')" title="Email"><span class="material-icons-outlined">email</span></button>
                                <button class="action-btn" onclick="event.stopPropagation(); editContact('${safeId}')" title="Edit"><span class="material-icons-outlined">edit</span></button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--gray-400);padding:40px;">No organizations or contacts found</td></tr>';
            
            // Update sort arrows
            updateSortArrows('directoryTable', directorySortColumn, directorySortAsc);
        }
        
        function sortDirectory(column) {
            const sortBySelect = document.getElementById('directorySortBy');
            if (sortBySelect) {
                sortBySelect.value = column;
            }
            if (directorySortColumn === column) {
                directorySortAsc = !directorySortAsc;
            } else {
                directorySortColumn = column;
                directorySortAsc = true;
            }
            updateSortArrows('directoryTable', directorySortColumn, directorySortAsc);
            renderDirectory();
        }
        
        function directoryEdit(type, id) {
            console.log('directoryEdit called:', type, id);
            if (type === 'org') {
                editOrg(id);
            } else {
                editContact(id);
            }
        }
        
        function updateSortArrows(tableId, column, asc) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            // Remove all sort classes
            table.querySelectorAll('.sortable-header').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add sort class to active column
            const activeHeader = table.querySelector(`.sortable-header[data-sort="${column}"]`);
            if (activeHeader) {
                activeHeader.classList.add(asc ? 'sort-asc' : 'sort-desc');
            }
        }
        
        // ============================================
        // SEARCHABLE SELECT FUNCTIONS
        // ============================================
        function showOrgOptions() {
            const optionsDiv = document.getElementById('contactOrgOptions');
            filterOrgOptions();
            optionsDiv.classList.add('show');
        }
        
        function filterOrgOptions() {
            const searchVal = document.getElementById('contactOrgSearch').value.toLowerCase();
            const optionsDiv = document.getElementById('contactOrgOptions');
            const selectedId = document.getElementById('contactOrg').value;
            
            const filtered = state.organizations.filter(o => 
                o.Name?.toLowerCase().includes(searchVal) || 
                o.City?.toLowerCase().includes(searchVal) ||
                o.Zone?.toLowerCase().includes(searchVal)
            ).slice(0, 20); // Limit to 20 results
            
            optionsDiv.innerHTML = filtered.map(o => `
                <div class="select-option ${o.ID === selectedId ? 'selected' : ''}" 
                     onclick="selectOrg('${o.ID}', '${esc(o.Name)}')">
                    <strong>${esc(o.Name)}</strong>
                    <span style="color:var(--gray-500);font-size:12px;margin-left:8px;">
                        ${o.Zone ? `<span class="zone-badge" style="font-size:10px;padding:1px 4px;">${o.Zone}</span>` : ''}
                        ${o.City || ''}
                    </span>
                </div>
            `).join('') || '<div class="select-option" style="color:var(--gray-400);">No matches found</div>';
        }
        
        function selectOrg(id, name) {
            document.getElementById('contactOrg').value = id;
            document.getElementById('contactOrgSearch').value = name;
            document.getElementById('contactOrgOptions').classList.remove('show');
        }
        
        // Zone filter searchable select
        function showSelectOptions(prefix) {
            const optionsDiv = document.getElementById(prefix + 'Options');
            populateZoneOptions(prefix);
            optionsDiv.classList.add('show');
        }
        
        function populateZoneOptions(prefix) {
            const searchVal = document.getElementById(prefix + 'Input')?.value?.toLowerCase() || '';
            const optionsDiv = document.getElementById(prefix + 'Options');
            const hiddenInput = document.getElementById(prefix + 'Filter');
            const selectedVal = hiddenInput?.value || '';
            
            if (!optionsDiv) return;
            
            const zones = state.settings?.zones || [];
            let options = [{ code: '', name: 'All Zones' }, ...zones];
            if (searchVal) {
                options = options.filter(z => 
                    z.code.toLowerCase().includes(searchVal) || 
                    z.name.toLowerCase().includes(searchVal)
                );
            }
            
            optionsDiv.innerHTML = options.map(z => `
                <div class="select-option ${z.code === selectedVal ? 'selected' : ''}" 
                     onclick="selectZoneFilter('${prefix}', '${z.code}', '${z.code ? z.code + ' - ' + z.name : 'All Zones'}')">
                    ${z.code ? `<span class="zone-badge" style="margin-right:8px;">${z.code}</span>${z.name}` : 'All Zones'}
                </div>
            `).join('');
        }
        
        function populateOrgTypeDropdown() {
            const orgTypeSelect = document.getElementById('orgType');
            if (!orgTypeSelect) return;
            
            const orgTypes = state.settings?.organizationTypes || [];
            const currentValue = orgTypeSelect.value;
            
            orgTypeSelect.innerHTML = '<option value="">Select</option>' + 
                orgTypes.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
            
            orgTypeSelect.value = currentValue;
        }
        
        function filterSelectOptions(prefix) {
            populateZoneOptions(prefix);
        }
        
        function selectZoneFilter(prefix, code, displayText) {
            document.getElementById(prefix + 'Filter').value = code;
            document.getElementById(prefix + 'Input').value = code ? displayText : '';
            document.getElementById(prefix + 'Options').classList.remove('show');
            renderDirectory();
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.searchable-select')) {
                document.querySelectorAll('.select-options').forEach(d => d.classList.remove('show'));
            }
        });
        
        function openDetailPanel(type, id) {
            const panel = document.getElementById('directoryDetailPanel');
            const container = document.querySelector('.directory-container');
            const content = document.getElementById('detailPanelContent');
            const actions = document.getElementById('detailPanelActions');
            
            if (type === 'org') {
                const org = state.organizations.find(o => String(o.ID) === String(id));
                if (!org) return;
                
                const contacts = state.contacts.filter(c => String(c.Org_ID) === String(id));
                const visits = state.visits.filter(v => String(v.Org_ID) === String(id)).sort((a, b) => new Date(b.Visit_Date) - new Date(a.Visit_Date));
                const emails = state.emails.filter(e => String(e.org_id) === String(id) || contacts.some(c => c.Email === e.from || c.Email === e.to));
                
                actions.innerHTML = `
                    <button class="btn btn-sm btn-primary" onclick="editOrg('${id}')">
                        <span class="material-icons-outlined">edit</span> Edit
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="openVisitForOrg('${id}')">
                        <span class="material-icons-outlined">place</span> Log Visit
                    </button>
                `;
                
                content.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-icon">
                            <span class="material-icons-outlined">business</span>
                        </div>
                        <div class="detail-info">
                            <h2>${esc(org.Name)}</h2>
                            <div class="subtitle">${esc(org.Type || 'Organization')} ${org.Zone ? `• <span class="zone-badge">${org.Zone}</span>` : ''}</div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Details</div>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <div class="detail-field-label">Address</div>
                                <div class="detail-field-value">${esc(org.Address || '-')}</div>
                            </div>
                            ${org.Address2 ? `<div class="detail-field">
                                <div class="detail-field-label">Address 2</div>
                                <div class="detail-field-value">${esc(org.Address2)}</div>
                            </div>` : ''}
                            <div class="detail-field">
                                <div class="detail-field-label">City</div>
                                <div class="detail-field-value">${esc(org.City || '-')}</div>
                            </div>
                            <div class="detail-field">
                                <div class="detail-field-label">Phone</div>
                                <div class="detail-field-value">${org.Phone ? `<a href="tel:${org.Phone}" style="color: var(--primary-color); text-decoration: none; cursor: pointer;">${esc(org.Phone)}</a>` : '-'}</div>
                            </div>
                            <div class="detail-field">
                                <div class="detail-field-label">Email</div>
                                <div class="detail-field-value">${esc(org.Email || '-')}</div>
                            </div>
                            ${org.Notes ? `<div class="detail-field full-width"><div class="detail-field-label">Notes</div><div class="detail-field-value">${esc(org.Notes)}</div></div>` : ''}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">
                            Contacts (${contacts.length})
                            <button class="btn btn-sm btn-secondary" onclick="openContactModalForOrg('${id}')">
                                <span class="material-icons-outlined">person_add</span> Add
                            </button>
                        </div>
                        ${contacts.length > 0 ? contacts.map(c => `
                            <div class="contact-mini-card" onclick="openDetailPanel('contact', '${c.ID}')">
                                <div class="contact-mini-avatar">${(c.First_Name || '?')[0]}${(c.Last_Name || '')[0]}</div>
                                <div class="contact-mini-info">
                                    <div class="contact-mini-name">${esc(c.First_Name)} ${esc(c.Last_Name)} ${c.Is_Primary === 'Yes' ? '<span class="status-badge status-active" style="font-size:10px;">Primary</span>' : ''}</div>
                                    <div class="contact-mini-title">${esc(c.Title || '')} ${c.Email ? `• ${c.Email}` : ''}</div>
                                </div>
                                <button class="action-btn" onclick="event.stopPropagation(); editContact('${c.ID}')"><span class="material-icons-outlined">edit</span></button>
                            </div>
                        `).join('') : '<div style="color:var(--gray-400);text-align:center;padding:20px;">No contacts yet</div>'}
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Recent Activity</div>
                        ${visits.length > 0 || emails.length > 0 ? `
                            ${visits.slice(0, 5).map(v => {
                                const visitDate = new Date(v.Visit_Date);
                                const month = String(visitDate.getMonth() + 1).padStart(2, '0');
                                const day = String(visitDate.getDate()).padStart(2, '0');
                                const year = visitDate.getFullYear();
                                const formattedDate = month + '/' + day + '/' + year;
                                
                                // ✅ NEW: Format time in 12H format if available
                                let timeStr = '';
                                if (v.Check_In_Time) {
                                    const [hours, minutes] = v.Check_In_Time.split(':');
                                    const h = parseInt(hours);
                                    const ampm = h >= 12 ? 'PM' : 'AM';
                                    const displayHours = h % 12 || 12;
                                    timeStr = ` at ${displayHours}:${minutes} ${ampm}`;
                                }
                                
                                return `
                                <div class="activity-item">
                                    <div class="activity-icon visit"><span class="material-icons-outlined">place</span></div>
                                    <div class="activity-content">
                                        <div class="activity-title">${esc(v.Outcome || 'Visit')}</div>
                                        <div class="activity-meta">${formattedDate}${timeStr} ${v.Rep_Name ? `by ${v.Rep_Name}` : ''}</div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        ` : '<div style="color:var(--gray-400);text-align:center;padding:20px;">No activity yet</div>'}
                    </div>
                `;
            } else {
                // Contact detail
                const contact = state.contacts.find(c => String(c.ID) === String(id));
                if (!contact) return;
                
                const org = state.organizations.find(o => String(o.ID) === String(contact.Org_ID));
                const visits = org ? state.visits.filter(v => String(v.Org_ID) === String(org.ID)).sort((a, b) => new Date(b.Visit_Date) - new Date(a.Visit_Date)) : [];
                
                actions.innerHTML = `
                    <button class="btn btn-sm btn-primary" onclick="editContact('${id}')">
                        <span class="material-icons-outlined">edit</span> Edit
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="composeEmailForContact('${id}')">
                        <span class="material-icons-outlined">email</span> Email
                    </button>
                `;
                
                content.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-icon contact-icon">
                            <span class="material-icons-outlined">person</span>
                        </div>
                        <div class="detail-info">
                            <h2>${esc(contact.First_Name)} ${esc(contact.Last_Name)}</h2>
                            <div class="subtitle">${esc(contact.Title || '')} ${org ? `at <a href="#" onclick="openDetailPanel('org', '${org.ID}'); return false;">${esc(org.Name)}</a>` : ''}</div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Contact Info</div>
                        <div class="detail-grid">
                            <div class="detail-field">
                                <div class="detail-field-label">Email</div>
                                <div class="detail-field-value">${contact.Email ? `<a href="mailto:${contact.Email}">${esc(contact.Email)}</a>` : '-'}</div>
                            </div>
                            <div class="detail-field">
                                <div class="detail-field-label">Phone</div>
                                <div class="detail-field-value">${contact.Phone ? `<a href="tel:${contact.Phone}">${esc(contact.Phone)}</a>` : '-'}</div>
                            </div>
                            <div class="detail-field">
                                <div class="detail-field-label">Primary Contact</div>
                                <div class="detail-field-value">${contact.Is_Primary === 'Yes' ? 'Yes' : 'No'}</div>
                            </div>
                            <div class="detail-field">
                                <div class="detail-field-label">Organization Zone</div>
                                <div class="detail-field-value">${org?.Zone ? `<span class="zone-badge">${org.Zone}</span>` : '-'}</div>
                            </div>
                            ${contact.Notes ? `<div class="detail-field full-width"><div class="detail-field-label">Notes</div><div class="detail-field-value">${esc(contact.Notes)}</div></div>` : ''}
                        </div>
                    </div>
                    
                    ${org ? `
                    <div class="detail-section">
                        <div class="detail-section-title">Organization</div>
                        <div class="contact-mini-card" onclick="openDetailPanel('org', '${org.ID}')">
                            <div class="contact-mini-avatar" style="background: var(--navy);"><span class="material-icons-outlined" style="font-size: 18px;">business</span></div>
                            <div class="contact-mini-info">
                                <div class="contact-mini-name">${esc(org.Name)}</div>
                                <div class="contact-mini-title">${esc(org.Type || '')} • ${esc(org.City || '')}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Recent Activity</div>
                        ${visits.length > 0 ? visits.slice(0, 5).map(v => `
                            <div class="activity-item">
                                <div class="activity-icon visit"><span class="material-icons-outlined">place</span></div>
                                <div class="activity-content">
                                    <div class="activity-title">${esc(v.Outcome || 'Visit')} at ${esc(org?.Name || '')}</div>
                                    <div class="activity-meta">${v.Visit_Date} ${v.Rep_Name ? `by ${v.Rep_Name}` : ''}</div>
                                </div>
                            </div>
                        `).join('') : '<div style="color:var(--gray-400);text-align:center;padding:20px;">No activity yet</div>'}
                    </div>
                `;
            }
            
            // ✅ FIXED: Remove display:none so panel can show
            panel.style.display = '';
            panel.classList.add('open');
            container.classList.add('detail-open');
        }
        
        function closeDetailPanel() {
            const panel = document.getElementById('directoryDetailPanel');
            const container = document.querySelector('.directory-container');
            if (panel) {
                panel.classList.remove('open');
                panel.style.display = 'none';
            }
            if (container) {
                container.classList.remove('detail-open');
            }
            // Ensure directory is still visible
            const directoryTab = document.querySelector('[data-tab="directory"]');
            if (directoryTab) {
                directoryTab.style.display = 'block';
            }
        }
        
        function openContactModalForOrg(orgId) {
            const org = state.organizations.find(o => o.ID === orgId);
            openContactModal();
            setTimeout(() => {
                document.getElementById('contactOrg').value = orgId;
                document.getElementById('contactOrgSearch').value = org?.Name || '';
            }, 100);
        }
        
        // Legacy render functions (for backward compatibility)
        function renderOrganizations() {
            renderDirectory();
        }

        function renderContacts() {
            renderDirectory();
        }

        let visitSortColumn = 'date';
        let visitSortAsc = false;
        
        function sortVisits(column) {
            if (visitSortColumn === column) {
                visitSortAsc = !visitSortAsc;
            } else {
                visitSortColumn = column;
                visitSortAsc = column === 'org'; // Ascending for org, descending for date
            }
            updateSortArrows('visitsTable', visitSortColumn, visitSortAsc);
            renderVisits();
        }

        function renderVisits() {
            // Update route planner cities when visiting the Visits tab
            try { populateRouteCities(); } catch (e) { console.warn('Error populating route cities:', e); }
            
            // Populate zone filter dynamically
            const zoneSelect = document.getElementById('visitZoneFilter');
            if (zoneSelect && zoneSelect.options.length <= 1 && state.settings?.zones) {
                state.settings.zones.forEach(z => {
                    zoneSelect.add(new Option(`${z.code} - ${z.name}`, z.code));
                });
            }
            
            const zoneFilter = document.getElementById('visitZoneFilter')?.value || '';
            const searchVal = document.getElementById('visitSearch')?.value?.toLowerCase() || '';
            
            let filtered = [...state.visits];
            
            // Apply filters
            if (zoneFilter) {
                const zoneOrgIds = state.organizations.filter(o => o.Zone === zoneFilter).map(o => o.ID);
                filtered = filtered.filter(v => zoneOrgIds.includes(v.Org_ID));
            }
            
            if (searchVal) {
                filtered = filtered.filter(v => {
                    const org = state.organizations.find(o => o.ID === v.Org_ID);
                    return org?.Name?.toLowerCase().includes(searchVal) ||
                           v.Outcome?.toLowerCase().includes(searchVal) ||
                           v.Rep_Name?.toLowerCase().includes(searchVal);
                });
            }
            
            // Sort
            filtered.sort((a, b) => {
                let cmp = 0;
                if (visitSortColumn === 'date') {
                    cmp = new Date(b.Visit_Date) - new Date(a.Visit_Date);
                } else if (visitSortColumn === 'org') {
                    const orgA = state.organizations.find(o => o.ID === a.Org_ID)?.Name || '';
                    const orgB = state.organizations.find(o => o.ID === b.Org_ID)?.Name || '';
                    cmp = orgA.localeCompare(orgB);
                }
                return visitSortAsc ? cmp : -cmp;
            });
            
            // Safely update visits table if it exists
            const visitsTableBody = document.querySelector('#visitsTable tbody');
            if (visitsTableBody) {
                visitsTableBody.innerHTML = filtered.slice(0, 100).map(v => {
                    const org = state.organizations.find(o => o.ID === v.Org_ID);
                    // Parse Assets_Used JSON if present
                    let assetsUsed = 0;
                    if (v.Assets_Used) {
                        try {
                            const assets = JSON.parse(v.Assets_Used);
                            assetsUsed = Object.values(assets).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                        } catch(e) {}
                    }
                    // Fallback to old brochure columns
                    const total = assetsUsed || (parseInt(v.Brochures_General) || 0) + (parseInt(v.Brochures_Hospice) || 0) + (parseInt(v.Brochures_HomeHealth) || 0);
                    
                    return `
                        <tr class="clickable-row" onclick="viewVisitDetails('${v.ID}')">
                            <td>${formatDate(v.Visit_Date)}</td>
                            <td><strong>${esc(org?.Name || '-')}</strong></td>
                            <td><span class="status-badge status-active">${esc(v.Outcome || '-')}</span></td>
                            <td>${total}</td>
                            <td>${esc(v.Rep_Name || '-')}</td>
                            <td class="action-btns">
                                <button class="action-btn" onclick="event.stopPropagation(); editVisit('${v.ID}')"><span class="material-icons-outlined">edit</span></button>
                                <button class="action-btn danger" onclick="event.stopPropagation(); deleteVisit('${v.ID}')"><span class="material-icons-outlined">delete</span></button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--gray-400);">No visits found</td></tr>';
            } else {
                console.log('Visits table not found in DOM');
            }
            
            // Update sort arrows
            updateSortArrows('visitsTable', visitSortColumn, visitSortAsc);
        }
        
        function viewVisitDetails(visitId) {
            // Navigate to organization detail for this visit
            const visit = state.visits.find(v => v.ID === visitId);
            if (visit && visit.Org_ID) {
                switchTab('directory');
                setTimeout(() => openDetailPanel('org', visit.Org_ID), 100);
            }
        }

        let teamSortColumn = 'name';
        let teamSortAsc = true;
        
        function sortTeam(column) {
            if (teamSortColumn === column) {
                teamSortAsc = !teamSortAsc;
            } else {
                teamSortColumn = column;
                teamSortAsc = true;
            }
            updateSortArrows('teamTable', teamSortColumn, teamSortAsc);
            renderTeam();
        }

        function renderTeam() {
            const tableBody = document.querySelector('#teamTable tbody');
            if (!tableBody) {
                console.log('Team table not found in DOM');
                return;
            }
            
            const searchVal = document.getElementById('teamSearch')?.value?.toLowerCase() || '';
            
            let filtered = state.teamMembers.filter(m => {
                if (!searchVal) return true;
                return m.Name?.toLowerCase().includes(searchVal) ||
                       m.Email?.toLowerCase().includes(searchVal) ||
                       m.Role?.toLowerCase().includes(searchVal);
            });
            
            // Sort
            filtered.sort((a, b) => {
                let cmp = 0;
                if (teamSortColumn === 'name') cmp = (a.Name || '').localeCompare(b.Name || '');
                else if (teamSortColumn === 'role') cmp = (a.Role || '').localeCompare(b.Role || '');
                else if (teamSortColumn === 'status') cmp = (a.Active || '').localeCompare(b.Active || '');
                return teamSortAsc ? cmp : -cmp;
            });
            
            tableBody.innerHTML = filtered.map(m => `
                <tr>
                    <td><strong>${esc(m.Name)}</strong></td>
                    <td>${esc(m.Email || '-')}</td>
                    <td>${m.Zones?.split(',').map(z => `<span class="zone-badge">${z}</span>`).join(' ') || '-'}</td>
                    <td>${m.Role}</td>
                    <td><span class="status-badge ${m.Active === 'Yes' ? 'status-active' : 'status-inactive'}">${m.Active === 'Yes' ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-btns">
                        <button class="action-btn" onclick="editTeamMember('${m.ID}')"><span class="material-icons-outlined">edit</span></button>
                        <button class="action-btn danger" onclick="deleteTeamMember('${m.ID}')"><span class="material-icons-outlined">delete</span></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--gray-400);">No team members</td></tr>';
            
            // Update sort arrows
            updateSortArrows('teamTable', teamSortColumn, teamSortAsc);
        }

        function renderTemplates() {
            const templateGrid = document.getElementById('templateGrid');
            const templateSelector = document.getElementById('templateSelector');
            
            if (!templateGrid && !templateSelector) {
                console.log('Template elements not found in DOM');
                return;
            }
            
            const categoryFilter = document.getElementById('templateCategoryFilter')?.value || '';
            const filteredTemplates = categoryFilter 
                ? state.emailTemplates.filter(t => t.Category === categoryFilter)
                : state.emailTemplates;
            
            if (templateGrid) {
                templateGrid.innerHTML = filteredTemplates.map(t => {
                    // Strip HTML for preview text
                    const previewText = stripHtml(t.Body || '').substring(0, 120);
                    return `
                <div class="template-card">
                    <div class="template-card-header">
                        <span class="template-name">${esc(t.Name)}</span>
                        <span class="template-category">${t.Category || 'general'}</span>
                    </div>
                    <div class="template-subject"><strong>Subject:</strong> ${esc(t.Subject)}</div>
                    <div class="template-preview">${esc(previewText)}...</div>
                    <div class="template-actions">
                        <button class="btn btn-sm btn-secondary" onclick="previewTemplate('${t.ID}')">
                            <span class="material-icons-outlined" style="font-size: 14px;">visibility</span> Preview
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editTemplate('${t.ID}')">
                            <span class="material-icons-outlined" style="font-size: 14px;">edit</span> Edit
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteTemplate('${t.ID}')" style="color: var(--danger);">
                            <span class="material-icons-outlined" style="font-size: 14px;">delete</span>
                        </button>
                    </div>
                </div>`;
                }).join('') || '<div style="color: var(--gray-400); text-align: center; padding: 40px;">No templates yet. Click "New Template" to create one.</div>';
            }
            
            // Also update compose modal template selector
            if (templateSelector) {
                templateSelector.innerHTML = state.emailTemplates.length 
                    ? '<span style="font-size: 12px; color: var(--gray-500); margin-right: 8px;">Templates:</span>' + state.emailTemplates.map(t => `
                        <button type="button" class="template-pill" onclick="applyTemplate('${t.ID}')">${esc(t.Name)}</button>
                `).join('')
                : '';
            }
        }
        
        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html || '';
            return tmp.textContent || tmp.innerText || '';
        }
        
        function previewTemplate(id) {
            const t = state.emailTemplates.find(x => x.ID === id);
            if (!t) return;
            
            // Create preview modal
            const previewHtml = `
                <div class="modal-overlay active" id="previewModal" onclick="if(event.target === this) closeModal('previewModal')">
                    <div class="modal modal-lg">
                        <div class="modal-header" style="background: var(--navy); color: white;">
                            <h3 class="modal-title" style="color: white;">Template Preview: ${esc(t.Name)}</h3>
                            <button class="modal-close" onclick="closeModal('previewModal')" style="color: white;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-200);">
                                <strong>Subject:</strong> ${esc(t.Subject)}
                            </div>
                            <div style="background: var(--gray-50); padding: 20px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
                                ${t.Body || '<em style="color: var(--gray-400);">No content</em>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('previewModal')">Close</button>
                            <button class="btn btn-primary" onclick="closeModal('previewModal'); editTemplate('${t.ID}')">
                                <span class="material-icons-outlined">edit</span> Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', previewHtml);
        }

        function renderTodayVisits() {
            const today = new Date().toISOString().split('T')[0];
            const todayVisits = state.visits.filter(v => v.Visit_Date === today);
            const container = document.getElementById('todayVisits');
            
            if (todayVisits.length === 0) {
                container.innerHTML = '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No visits logged today</div>';
                return;
            }
            
            container.innerHTML = todayVisits.map(v => {
                const org = state.organizations.find(o => o.ID === v.Org_ID);
                return `<div style="padding: 12px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${esc(org?.Name || 'Unknown')}</strong>
                        <div style="font-size: 12px; color: var(--gray-500);">${v.Check_In_Time || ''} - ${esc(v.Outcome || '')}</div>
                    </div>
                    <span class="status-badge status-active">Complete</span>
                </div>`;
            }).join('');
        }

        function populateDropdowns() {
            const orgOptions = '<option value="">Select Organization</option>' + state.organizations.map(o => `<option value="${o.ID}">${esc(o.Name)}</option>`).join('');
            document.getElementById('contactOrg').innerHTML = orgOptions;
            document.getElementById('visitOrg').innerHTML = orgOptions;
            document.getElementById('composeOrg').innerHTML = orgOptions;
            // Note: checkinOrg is now a hidden input, search field handles selection
        }

        // ============================================
        // GPS LOCATION
        // ============================================
        function getLocation() {
            const gpsEl = document.getElementById('gpsStatus');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        state.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        gpsEl.className = 'checkin-gps active';
                        gpsEl.innerHTML = `<span class="material-icons-outlined">location_on</span><span>GPS Ready</span>`;
                    },
                    err => {
                        gpsEl.className = 'checkin-gps error';
                        gpsEl.innerHTML = `<span class="material-icons-outlined">location_off</span><span>No GPS</span>`;
                    }
                );
            }
        }

        // ============================================
        // CHECK-IN
        // ============================================
        async function submitCheckin() {
            const orgId = document.getElementById('checkinOrg').value;
            if (!orgId) { showToast('Please select an organization', 'error'); return; }
            
            const now = new Date();
            
            // Collect asset quantities from dynamic inputs
            const assetInputs = document.querySelectorAll('#checkinAssetsGrid input[data-asset-id]');
            const assetsUsed = {};
            let totalAssetsUsed = 0;
            
            assetInputs.forEach(input => {
                const itemId = input.dataset.assetId;
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    assetsUsed[itemId] = qty;
                    totalAssetsUsed += qty;
                    
                    // Deduct from inventory
                    const item = state.assetItems.find(a => a.ID === itemId);
                    if (item) {
                        item.Quantity = Math.max(0, (item.Quantity || 0) - qty);
                        
                        // Add to stock history
                        state.stockHistory.unshift({
                            ID: 'sh_' + Date.now() + '_' + itemId,
                            Asset_ID: itemId,
                            Type: 'remove',
                            Quantity: qty,
                            Date: now.toISOString(),
                            By: state.user?.name || '',
                            Notes: 'Check-in at ' + (state.organizations.find(o => o.ID === orgId)?.Name || 'organization')
                        });
                    }
                }
            });
            
            const visit = {
                Org_ID: orgId,
                Visit_Date: now.toISOString().split('T')[0],
                Check_In_Time: now.toTimeString().slice(0, 5),
                Outcome: document.getElementById('checkinOutcome').value,
                Assets_Used: JSON.stringify(assetsUsed),
                Rep_Name: state.user?.name || '',
                Rep_Email: state.user?.email || '',
                GPS_Lat: state.currentLocation?.lat || '',
                GPS_Lng: state.currentLocation?.lng || ''
            };
            
            showLoading(true);
            try {
                await apiPost('addVisit', { visit, assetUpdates: state.assetItems, stockHistory: state.stockHistory.slice(0, Object.keys(assetsUsed).length) });
                visit.ID = 'temp_' + Date.now();
                state.visits.push(visit);
                
                // Reset form
                document.getElementById('checkinOrg').value = '';
                document.getElementById('checkinOrgSearch').value = '';
                assetInputs.forEach(input => input.value = '0');
                
                const org = state.organizations.find(o => o.ID === orgId);
                showToast(`Checked in at ${org?.Name || 'organization'}!`, 'success');
                
                // Check for low stock and send alert
                checkLowStock();
                const lowStockItems = state.assetItems.filter(a => (a.Quantity || 0) < (a.Threshold || 50));
                if (lowStockItems.length > 0 && state.settings.lowStockEmailEnabled) {
                    apiPost('sendLowStockAlert', { items: lowStockItems });
                }
                
                renderAll();
            } catch (err) {
                showToast('Check-in failed', 'error');
            }
            showLoading(false);
        }

        // ============================================
        // EMAIL FUNCTIONS
        // ============================================
        async function loadInbox() {
            const emailListEl = document.getElementById('emailList');
            emailListEl.innerHTML = '<div class="email-empty"><div class="spinner"></div><div style="margin-top: 10px;">Loading emails...</div></div>';
            
            try {
                const response = await apiCall('getEmailLog');
                if (response.success) {
                    state.emails = response.emails || [];
                } else {
                    state.emails = [];
                }
            } catch (err) {
                console.error('Failed to load inbox:', err);
                state.emails = [];
            }
            renderEmailList();
        }

        function renderEmailList() {
            const el = document.getElementById('emailList');
            if (!state.emails.length) { el.innerHTML = '<div class="email-empty"><span class="material-icons-outlined">inbox</span><div>No emails</div></div>'; return; }
            
            el.innerHTML = state.emails.map(e => {
                const d = new Date(e.date);
                return `<div class="email-item ${e.isUnread ? 'unread' : ''} ${state.selectedEmail?.id === e.id ? 'active' : ''}" onclick="selectEmail('${e.id}')">
                    <div class="email-from"><span>${esc(e.from?.split('<')[0] || e.from)}</span><span class="email-date">${d.toLocaleDateString()}</span></div>
                    <div class="email-subject">${esc(e.subject || '(No subject)')}</div>
                    <div class="email-snippet">${esc(e.snippet || '')}</div>
                    ${e.orgName ? `<span class="email-org-badge">${esc(e.orgName)}</span>` : ''}
                </div>`;
            }).join('');
        }

        function selectEmail(id) {
            state.selectedEmail = state.emails.find(e => e.id === id);
            renderEmailList();
            const viewer = document.getElementById('emailViewer');
            if (!state.selectedEmail) return;
            const e = state.selectedEmail;
            viewer.innerHTML = `
                <div class="email-viewer-header">
                    <div class="email-viewer-subject">${esc(e.subject)}</div>
                    <div style="font-size: 13px; color: var(--gray-600);">
                        <strong>From:</strong> ${esc(e.from)}<br>
                        <strong>To:</strong> ${esc(e.to)}<br>
                        <strong>Date:</strong> ${new Date(e.date).toLocaleString()}
                    </div>
                </div>
                <div class="email-viewer-body">${esc(e.body || e.snippet)}</div>
                <div class="email-viewer-actions">
                    <button class="btn btn-primary" onclick="replyToEmail()"><span class="material-icons-outlined">reply</span> Reply</button>
                </div>
            `;
        }

        function openComposeModal() { openModal('composeModal'); populateComposeDropdowns(); clearComposeForm(); }
        function populateComposeDropdowns() {
            document.getElementById('composeOrg').innerHTML = '<option value="">Select</option>' + state.organizations.map(o => `<option value="${o.ID}">${esc(o.Name)}</option>`).join('');
        }

        function populateContactsForOrg() {
            const orgId = document.getElementById('composeOrg').value;
            const contacts = state.contacts.filter(c => c.Org_ID === orgId);
            document.getElementById('composeContact').innerHTML = '<option value="">Select</option>' + contacts.map(c => `<option value="${c.ID}" data-email="${c.Email}">${esc(c.First_Name + ' ' + c.Last_Name)}</option>`).join('');
            document.getElementById('composeContact').onchange = function() {
                const opt = this.options[this.selectedIndex];
                if (opt.dataset.email) document.getElementById('composeToEmail').value = opt.dataset.email;
            };
        }

        function clearComposeForm() {
            ['composeOrg', 'composeToEmail', 'composeSubject'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('composeContact').innerHTML = '<option value="">Select</option>';
            document.querySelectorAll('.template-pill').forEach(b => b.classList.remove('active'));
            composeEditor.root.innerHTML = '';
            // Hide custom vars section
            document.getElementById('customVarsSection').style.display = 'none';
            document.getElementById('customVarsInputs').innerHTML = '';
        }

        function applyTemplate(id) {
            const t = state.emailTemplates.find(x => x.ID === id);
            if (!t) return;
            document.querySelectorAll('.template-pill').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const orgId = document.getElementById('composeOrg').value;
            const contactId = document.getElementById('composeContact').value;
            const org = state.organizations.find(o => o.ID === orgId);
            const contact = state.contacts.find(c => c.ID === contactId);
            
            // Standard variables that come from database
            const standardVars = {
                '{{contact_name}}': contact ? (contact.First_Name + ' ' + contact.Last_Name) : '[Contact Name]',
                '{{organization}}': org?.Name || '[Organization]',
                '{{zone}}': org?.Zone || '[Zone]',
                '{{rep_name}}': state.user?.name || '[Your Name]',
                '{{rep_email}}': state.user?.email || 'busdev@alicecare.com',
                '{{rep_phone}}': state.user?.phone || '',
                '{{visit_date}}': new Date().toLocaleDateString()
            };
            
            let subject = t.Subject || '';
            let body = t.Body || '';
            
            // Replace standard variables
            for (let k in standardVars) { 
                subject = subject.replace(new RegExp(k.replace(/[{}]/g, '\\$&'), 'g'), standardVars[k]); 
                body = body.replace(new RegExp(k.replace(/[{}]/g, '\\$&'), 'g'), standardVars[k]); 
            }
            
            // Find remaining custom variables (not in standard list)
            const allVarsInContent = [...subject.matchAll(/\{\{([^}]+)\}\}/g), ...body.matchAll(/\{\{([^}]+)\}\}/g)];
            const customVarNames = [...new Set(allVarsInContent.map(m => m[1]))];
            
            // Show custom variables section if there are any
            const customVarsSection = document.getElementById('customVarsSection');
            const customVarsInputs = document.getElementById('customVarsInputs');
            
            if (customVarNames.length > 0) {
                // Build input fields for each custom variable
                customVarsInputs.innerHTML = customVarNames.map(varName => {
                    const displayName = varName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    return `
                        <div class="custom-var-input-group">
                            <label>{{${varName}}}</label>
                            <input type="text" data-var="${varName}" placeholder="Enter ${displayName}...">
                        </div>
                    `;
                }).join('');
                customVarsSection.style.display = 'block';
            } else {
                customVarsSection.style.display = 'none';
                customVarsInputs.innerHTML = '';
            }
            
            document.getElementById('composeSubject').value = subject;
            // Set Quill content
            if (body.includes('<')) {
                composeEditor.root.innerHTML = body;
            } else {
                composeEditor.setText(body);
            }
        }
        
        function applyCustomVariables() {
            const inputs = document.querySelectorAll('#customVarsInputs input[data-var]');
            let subject = document.getElementById('composeSubject').value;
            let body = composeEditor.root.innerHTML;
            
            let allFilled = true;
            inputs.forEach(input => {
                const varName = input.dataset.var;
                const value = input.value.trim();
                
                if (!value) {
                    allFilled = false;
                    input.style.borderColor = 'var(--danger)';
                } else {
                    input.style.borderColor = 'var(--success)';
                    const regex = new RegExp(`\\{\\{${varName}\\}\\}`, 'g');
                    subject = subject.replace(regex, value);
                    body = body.replace(regex, value);
                }
            });
            
            if (!allFilled) {
                showToast('Please fill in all custom variables', 'error');
                return;
            }
            
            // Update the fields
            document.getElementById('composeSubject').value = subject;
            composeEditor.root.innerHTML = body;
            
            // Hide the custom vars section
            document.getElementById('customVarsSection').style.display = 'none';
            
            showToast('Variables applied!', 'success');
        }

        async function sendEmail() {
            const to = document.getElementById('composeToEmail').value;
            const subject = document.getElementById('composeSubject').value;
            const bodyHtml = composeEditor.root.innerHTML;
            const bodyText = composeEditor.getText().trim();
            
            if (!to || !subject || !bodyText) { showToast('Fill all fields', 'error'); return; }
            
            showLoading(true);
            try {
                await apiPost('sendEmail', { emailData: { to, subject, body: bodyHtml, orgId: document.getElementById('composeOrg').value, sentBy: state.user?.email } });
                showToast('Email sent!', 'success');
                closeModal('composeModal');
            } catch (err) { showToast('Send failed', 'error'); }
            showLoading(false);
        }

        function composeEmailForOrg(orgId) {
            switchTab('emails');
            setTimeout(() => { openComposeModal(); document.getElementById('composeOrg').value = orgId; populateContactsForOrg(); }, 100);
        }

        function composeEmailForContact(contactId) {
            const c = state.contacts.find(x => String(x.ID) === String(contactId));
            if (!c) return;
            switchTab('emails');
            setTimeout(() => {
                openComposeModal();
                document.getElementById('composeOrg').value = c.Org_ID;
                populateContactsForOrg();
                setTimeout(() => { document.getElementById('composeContact').value = contactId; if (c.Email) document.getElementById('composeToEmail').value = c.Email; }, 50);
            }, 100);
        }

        function replyToEmail() {
            if (!state.selectedEmail) return;
            openComposeModal();
            document.getElementById('composeToEmail').value = state.selectedEmail.from;
            document.getElementById('composeSubject').value = 'Re: ' + state.selectedEmail.subject;
        }

        // ============================================
        // TEMPLATE FUNCTIONS
        // ============================================
        function openTemplateModal() {
            document.getElementById('templateModalTitle').textContent = 'New Template';
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateCategory').value = 'general';
            document.getElementById('templateSubject').value = '';
            templateEditor.root.innerHTML = '';
            openModal('templateModal');
        }

        function editTemplate(id) {
            const t = state.emailTemplates.find(x => x.ID === id);
            if (!t) return;
            document.getElementById('templateModalTitle').textContent = 'Edit Template';
            document.getElementById('templateId').value = t.ID;
            document.getElementById('templateName').value = t.Name || '';
            document.getElementById('templateCategory').value = t.Category || 'general';
            document.getElementById('templateSubject').value = t.Subject || '';
            // Set Quill content - check if it's HTML or plain text
            if (t.Body && t.Body.includes('<')) {
                templateEditor.root.innerHTML = t.Body;
            } else {
                templateEditor.setText(t.Body || '');
            }
            openModal('templateModal');
        }

        async function saveTemplate() {
            const bodyHtml = templateEditor.root.innerHTML;
            const bodyText = templateEditor.getText().trim();
            
            const template = {
                ID: document.getElementById('templateId').value,
                Name: document.getElementById('templateName').value,
                Category: document.getElementById('templateCategory').value,
                Subject: document.getElementById('templateSubject').value,
                Body: bodyHtml,
                Created_By: state.user?.email || ''
            };
            if (!template.Name || !template.Subject || !bodyText) { showToast('Fill all fields', 'error'); return; }
            
            showLoading(true);
            try {
                await apiPost('saveEmailTemplate', { template });
                if (template.ID) {
                    const idx = state.emailTemplates.findIndex(t => t.ID === template.ID);
                    if (idx >= 0) state.emailTemplates[idx] = { ...state.emailTemplates[idx], ...template };
                } else {
                    template.ID = 'temp_' + Date.now();
                    state.emailTemplates.push(template);
                }
                closeModal('templateModal');
                renderTemplates();
                showToast('Template saved', 'success');
            } catch (err) { showToast('Save failed', 'error'); }
            showLoading(false);
        }

        async function deleteTemplate(id) {
            if (!confirm('Delete this template?')) return;
            showLoading(true);
            try {
                await apiPost('deleteEmailTemplate', { id });
                state.emailTemplates = state.emailTemplates.filter(t => t.ID !== id);
                renderTemplates();
                showToast('Template deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }

        // ============================================
        // CRUD FUNCTIONS (Organizations, Contacts, Visits, Team)
        // ============================================
        function openModal(id) { 
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('Modal not found:', id);
            }
        }
        function closeModal(id) { 
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('active');
                // Remove preview modal from DOM after closing
                if (id === 'previewModal') {
                    setTimeout(() => modal.remove(), 300);
                }
            }
        }

        // Organization
        function openOrgModal() {
            document.getElementById('orgModalTitle').textContent = 'Add Organization';
            ['orgId', 'orgName', 'orgAddress', 'orgAddress2', 'orgCity', 'orgZip', 'orgPhone', 'orgNotes'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('orgType').value = '';
            document.getElementById('orgZone').value = 'SMF';
            document.getElementById('orgStatus').value = 'Active';
            document.getElementById('orgState').value = 'CA';
            document.getElementById('orgFrequency').value = 'Monthly';
            populateOrgTypeDropdown();
            openModal('orgModal');
        }

        function editOrg(id) {
            console.log('editOrg called with id:', id, 'type:', typeof id);
            console.log('state.organizations:', state.organizations?.length);
            // Normalize ID comparison - convert both to strings since onclick passes string
            const o = state.organizations.find(x => String(x.ID) === String(id));
            console.log('Found org:', o);
            if (!o) {
                console.error('Organization not found:', id, 'Available IDs:', state.organizations.map(x => x.ID));
                showToast('Organization not found', 'error');
                return;
            }
            // Close detail panel if open
            closeDetailPanel();
            
            document.getElementById('orgModalTitle').textContent = 'Edit Organization';
            document.getElementById('orgId').value = o.ID;
            document.getElementById('orgName').value = o.Name || '';
            document.getElementById('orgType').value = o.Type || '';
            document.getElementById('orgZone').value = o.Zone || 'SMF';
            document.getElementById('orgStatus').value = o.Status || 'Active';
            document.getElementById('orgAddress').value = o.Address || '';
            document.getElementById('orgAddress2').value = o.Address2 || '';  // ✅ NEW: Load Address2
            document.getElementById('orgCity').value = o.City || '';
            document.getElementById('orgState').value = o.State || 'CA';
            document.getElementById('orgZip').value = o.Zip || '';
            document.getElementById('orgPhone').value = o.Phone || '';
            document.getElementById('orgFrequency').value = o.Visit_Frequency || 'Monthly';
            document.getElementById('orgNotes').value = o.Notes || '';
            
            populateOrgTypeDropdown();
            console.log('About to open modal');
            openModal('orgModal');
            console.log('Modal opened');
        }

        async function saveOrganization() {
            const org = {
                ID: document.getElementById('orgId').value,
                Name: document.getElementById('orgName').value,
                Type: document.getElementById('orgType').value,
                Zone: document.getElementById('orgZone').value,
                Status: document.getElementById('orgStatus').value,
                Address: document.getElementById('orgAddress').value,
                Address2: document.getElementById('orgAddress2').value,  // ✅ NEW: Second address line
                City: document.getElementById('orgCity').value,
                State: document.getElementById('orgState').value,
                Zip: document.getElementById('orgZip').value,
                Phone: document.getElementById('orgPhone').value,
                Visit_Frequency: document.getElementById('orgFrequency').value,
                Notes: document.getElementById('orgNotes').value
            };
            if (!org.Name) { showToast('Name required', 'error'); return; }
            
            console.log('💾 Saving organization:', org);
            
            // Auto-add new organization types
            if (org.Type && org.Type.trim()) {
                if (!state.settings.organizationTypes) {
                    state.settings.organizationTypes = [];
                }
                if (!state.settings.organizationTypes.includes(org.Type)) {
                    state.settings.organizationTypes.push(org.Type);
                    state.settings.organizationTypes.sort();
                    await apiPost('saveSetting', { key: 'organizationTypes', value: state.settings.organizationTypes });
                }
            }
            
            showLoading(true);
            try {
                const result = await apiPost(org.ID ? 'updateOrganization' : 'addOrganization', { organization: org });
                console.log('Save result:', result);
                
                if (result.success) {
                    // Wait a moment then reload data from server to verify save worked
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    console.log('🔄 Reloading data from server to verify save...');
                    const dataResponse = await apiCall('getAllData');
                    
                    if (dataResponse.success && dataResponse.data) {
                        state.organizations = dataResponse.data.organizations || [];
                        console.log('✅ Data reloaded successfully');
                        closeModal('orgModal');
                        renderAll();
                        populateOrgTypeDropdown();
                        showToast('✅ Organization saved', 'success');
                    } else {
                        console.warn('Could not reload data, but save may have succeeded');
                        showToast('⚠️ Saved but could not verify. Refresh page to see changes.', 'warning');
                    }
                } else {
                    showToast('❌ Save failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (err) { 
                console.error('Save error:', err);
                showToast('❌ Save failed: ' + err.message, 'error'); 
            }
            showLoading(false);
        }

        async function deleteOrg(id) {
            if (!confirm('Delete organization?')) return;
            showLoading(true);
            try {
                await apiPost('deleteOrganization', { id });
                state.organizations = state.organizations.filter(o => o.ID !== id);
                renderAll();
                showToast('Deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }

        // Contact
        function openContactModal() {
            document.getElementById('contactModalTitle').textContent = 'Add Contact';
            ['contactId', 'contactFirstName', 'contactLastName', 'contactTitle', 'contactEmail', 'contactPhone'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('contactOrg').value = '';
            document.getElementById('contactOrgSearch').value = '';
            document.getElementById('contactPrimary').checked = false;
            openModal('contactModal');
        }

        function editContact(id) {
            const c = state.contacts.find(x => String(x.ID) === String(id));
            if (!c) {
                console.error('Contact not found:', id);
                return;
            }
            // Close detail panel if open
            closeDetailPanel();
            
            const org = state.organizations.find(o => String(o.ID) === String(c.Org_ID));
            document.getElementById('contactModalTitle').textContent = 'Edit Contact';
            document.getElementById('contactId').value = c.ID;
            document.getElementById('contactOrg').value = c.Org_ID || '';
            document.getElementById('contactOrgSearch').value = org?.Name || '';
            document.getElementById('contactFirstName').value = c.First_Name || '';
            document.getElementById('contactLastName').value = c.Last_Name || '';
            document.getElementById('contactTitle').value = c.Title || '';
            document.getElementById('contactEmail').value = c.Email || '';
            document.getElementById('contactPhone').value = c.Phone || '';
            document.getElementById('contactPrimary').checked = c.Is_Primary === 'Yes';
            
            openModal('contactModal');
        }

        async function saveContact() {
            const contact = {
                ID: document.getElementById('contactId').value,
                Org_ID: document.getElementById('contactOrg').value,
                First_Name: document.getElementById('contactFirstName').value,
                Last_Name: document.getElementById('contactLastName').value,
                Title: document.getElementById('contactTitle').value,
                Email: document.getElementById('contactEmail').value,
                Phone: document.getElementById('contactPhone').value,
                Is_Primary: document.getElementById('contactPrimary').checked ? 'Yes' : 'No'
            };
            if (!contact.Org_ID || !contact.First_Name) { showToast('Org and name required', 'error'); return; }
            
            showLoading(true);
            try {
                await apiPost(contact.ID ? 'updateContact' : 'addContact', { contact });
                if (contact.ID) {
                    const idx = state.contacts.findIndex(c => c.ID === contact.ID);
                    if (idx >= 0) state.contacts[idx] = { ...state.contacts[idx], ...contact };
                } else {
                    contact.ID = 'temp_' + Date.now();
                    state.contacts.push(contact);
                }
                closeModal('contactModal');
                renderAll();
                showToast('Contact saved', 'success');
            } catch (err) { showToast('Save failed', 'error'); }
            showLoading(false);
        }

        async function deleteContact(id) {
            if (!confirm('Delete contact?')) return;
            showLoading(true);
            try {
                await apiPost('deleteContact', { id });
                state.contacts = state.contacts.filter(c => c.ID !== id);
                renderAll();
                showToast('Deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }

        // Visit
        function openVisitModal() {
            document.getElementById('visitModalTitle').textContent = 'Log Visit';
            document.getElementById('visitId').value = '';
            document.getElementById('visitOrg').value = '';
            document.getElementById('visitContact').innerHTML = '<option value="">Select</option>';
            document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('visitOutcome').value = '';
            ['brochGeneral', 'brochHospice', 'brochHomeHealth', 'brochCards'].forEach(id => document.getElementById(id).value = '0');
            document.getElementById('visitNotes').value = '';
            openModal('visitModal');
        }

        function openVisitForOrg(orgId) {
            openVisitModal();
            document.getElementById('visitOrg').value = orgId;
            populateVisitContacts();
        }

        // ✅ NEW: Filter organizations for visit check-in search
        function filterVisitOrganizations() {
            const searchInput = document.getElementById('visitOrgSearch');
            const suggestionsDiv = document.getElementById('visitOrgSuggestions');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Filter organizations by name (case insensitive, partial match)
            const matches = state.organizations.filter(org => 
                org.Name.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions
            
            if (matches.length === 0) {
                suggestionsDiv.innerHTML = '<div style="padding: 10px; color: var(--gray-500);">No organizations found</div>';
                suggestionsDiv.style.display = 'block';
                return;
            }
            
            // Create suggestion items
            suggestionsDiv.innerHTML = matches.map(org => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; background-color: white; color: var(--gray-800);" 
                     onmouseover="this.style.background='var(--gray-100)'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectOrganizationFromSearch('${org.ID}', '${esc(org.Name)}', '${org.Zone || ''}')">
                    <strong>${esc(org.Name)}</strong> <span style="color: var(--gray-500); font-size: 12px;">[${org.Zone || 'No Zone'}]</span>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        function selectOrganizationFromSearch(orgId, orgName, zone) {
            document.getElementById('visitOrg').value = orgId;
            document.getElementById('visitOrgSearch').value = orgName;
            document.getElementById('visitOrgSuggestions').style.display = 'none';
            populateVisitContacts();
        }
        
        // ✅ NEW: Filter organizations for Check-In search
        function filterCheckinOrganizations() {
            const searchInput = document.getElementById('checkinOrgSearch');
            const suggestionsDiv = document.getElementById('checkinOrgSuggestions');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Filter organizations by name (case insensitive, partial match)
            const matches = state.organizations.filter(org => 
                org.Name.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions
            
            if (matches.length === 0) {
                suggestionsDiv.innerHTML = '<div style="padding: 10px; color: var(--gray-500);">No organizations found</div>';
                suggestionsDiv.style.display = 'block';
                return;
            }
            
            // Create suggestion items
            suggestionsDiv.innerHTML = matches.map(org => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; background-color: white; color: var(--gray-800);" 
                     onmouseover="this.style.background='var(--gray-100)'" 
                     onmouseout="this.style.background='white'"
                     onclick="selectCheckinOrganization('${org.ID}', '${esc(org.Name)}')">
                    <strong>${esc(org.Name)}</strong> <span style="color: var(--gray-500); font-size: 12px;">[${org.Zone || 'No Zone'}]</span>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        function selectCheckinOrganization(orgId, orgName) {
            document.getElementById('checkinOrg').value = orgId;
            document.getElementById('checkinOrgSearch').value = orgName;
            document.getElementById('checkinOrgSuggestions').style.display = 'none';
            renderCheckinAssets();
        }

        function populateVisitContacts() {
            const orgId = document.getElementById('visitOrg').value;
            const contacts = state.contacts.filter(c => String(c.Org_ID) === String(orgId));
            document.getElementById('visitContact').innerHTML = '<option value="">Select</option>' + contacts.map(c => `<option value="${c.ID}">${esc(c.First_Name + ' ' + c.Last_Name)}</option>`).join('');
        }

        function editVisit(id) {
            const v = state.visits.find(x => String(x.ID) === String(id));
            if (!v) return;
            document.getElementById('visitModalTitle').textContent = 'Edit Visit';
            document.getElementById('visitId').value = v.ID;
            document.getElementById('visitOrg').value = v.Org_ID || '';
            populateVisitContacts();
            setTimeout(() => document.getElementById('visitContact').value = v.Contact_ID || '', 50);
            document.getElementById('visitDate').value = v.Visit_Date || '';
            document.getElementById('visitOutcome').value = v.Outcome || '';
            document.getElementById('brochGeneral').value = v.Brochures_General || 0;
            document.getElementById('brochHospice').value = v.Brochures_Hospice || 0;
            document.getElementById('brochHomeHealth').value = v.Brochures_HomeHealth || 0;
            document.getElementById('brochCards').value = v.Business_Cards || 0;
            document.getElementById('visitNotes').value = v.Notes || '';
            openModal('visitModal');
        }

        async function saveVisit() {
            const visit = {
                ID: document.getElementById('visitId').value,
                Org_ID: document.getElementById('visitOrg').value,
                Contact_ID: document.getElementById('visitContact').value,
                Visit_Date: document.getElementById('visitDate').value,
                Outcome: document.getElementById('visitOutcome').value,
                Brochures_General: parseInt(document.getElementById('brochGeneral').value) || 0,
                Brochures_Hospice: parseInt(document.getElementById('brochHospice').value) || 0,
                Brochures_HomeHealth: parseInt(document.getElementById('brochHomeHealth').value) || 0,
                Business_Cards: parseInt(document.getElementById('brochCards').value) || 0,
                Notes: document.getElementById('visitNotes').value,
                Rep_Name: state.user?.name || '',
                Rep_Email: state.user?.email || ''
            };
            if (!visit.Org_ID || !visit.Visit_Date || !visit.Outcome) { showToast('Fill required fields', 'error'); return; }
            
            showLoading(true);
            try {
                await apiPost(visit.ID ? 'updateVisit' : 'addVisit', { visit });
                if (visit.ID) {
                    const idx = state.visits.findIndex(v => v.ID === visit.ID);
                    if (idx >= 0) state.visits[idx] = { ...state.visits[idx], ...visit };
                } else {
                    visit.ID = 'temp_' + Date.now();
                    state.visits.push(visit);
                }
                closeModal('visitModal');
                renderAll();
                showToast('Visit saved', 'success');
            } catch (err) { showToast('Save failed', 'error'); }
            showLoading(false);
        }

        async function deleteVisit(id) {
            if (!confirm('Delete visit?')) return;
            showLoading(true);
            try {
                await apiPost('deleteVisit', { id });
                state.visits = state.visits.filter(v => v.ID !== id);
                renderAll();
                showToast('Deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }

        // Team
        function openTeamModal() {
            document.getElementById('teamModalTitle').textContent = 'Add Team Member';
            ['teamId', 'teamName', 'teamEmail', 'teamPhone'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('teamRole').value = 'Rep';
            document.getElementById('zoneSMF').checked = true;
            document.getElementById('zoneSDG').checked = false;
            openModal('teamModal');
        }

        function editTeamMember(id) {
            const m = state.teamMembers.find(x => x.ID === id);
            if (!m) return;
            document.getElementById('teamModalTitle').textContent = 'Edit Team Member';
            document.getElementById('teamId').value = m.ID;
            document.getElementById('teamName').value = m.Name || '';
            document.getElementById('teamEmail').value = m.Email || '';
            document.getElementById('teamPhone').value = m.Phone || '';
            document.getElementById('teamRole').value = m.Role || 'Rep';
            const zones = (m.Zones || '').split(',');
            document.getElementById('zoneSMF').checked = zones.includes('SMF');
            document.getElementById('zoneSDG').checked = zones.includes('SDG');
            openModal('teamModal');
        }

        async function saveTeamMember() {
            const zones = [];
            if (document.getElementById('zoneSMF').checked) zones.push('SMF');
            if (document.getElementById('zoneSDG').checked) zones.push('SDG');
            
            const member = {
                ID: document.getElementById('teamId').value,
                Name: document.getElementById('teamName').value,
                Email: document.getElementById('teamEmail').value,
                Phone: document.getElementById('teamPhone').value,
                Role: document.getElementById('teamRole').value,
                Zones: zones.join(','),
                Active: 'Yes'
            };
            if (!member.Name || !member.Email) { showToast('Name and email required', 'error'); return; }
            
            showLoading(true);
            try {
                await apiPost(member.ID ? 'updateTeamMember' : 'addTeamMember', { member });
                if (member.ID) {
                    const idx = state.teamMembers.findIndex(m => m.ID === member.ID);
                    if (idx >= 0) state.teamMembers[idx] = { ...state.teamMembers[idx], ...member };
                } else {
                    member.ID = 'temp_' + Date.now();
                    state.teamMembers.push(member);
                }
                closeModal('teamModal');
                renderTeam();
                showToast('Team member saved', 'success');
            } catch (err) { showToast('Save failed', 'error'); }
            showLoading(false);
        }

        async function deleteTeamMember(id) {
            if (!confirm('Delete team member?')) return;
            showLoading(true);
            try {
                await apiPost('deleteTeamMember', { id });
                state.teamMembers = state.teamMembers.filter(m => m.ID !== id);
                renderTeam();
                showToast('Deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }

        // ============================================
        // ASSETS & INVENTORY (Two-Level: Categories + Items)
        // ============================================
        // Helper to check if item is available for user's zones
        function isItemAvailableForUser(item) {
            const itemZones = Array.isArray(item.Zones) ? item.Zones : (item.Zones ? JSON.parse(item.Zones) : ['all']);
            
            // If item is available for all zones, always show
            if (itemZones.includes('all')) return true;
            
            // Get user's zones
            const userZones = state.user?.zones || [];
            if (userZones.length === 0) return true; // If user has no zones assigned, show all
            
            // Check if any user zone matches item zones
            return userZones.some(uz => itemZones.includes(uz));
        }
        
        function renderCheckinAssets() {
            const grid = document.getElementById('checkinAssetsGrid');
            if (!grid) return;
            
            // Filter categories that should show in check-in
            const checkinCategories = state.assetCategories.filter(c => c.ShowInCheckin !== false);
            
            if (checkinCategories.length === 0) {
                grid.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">No assets configured. Go to Settings to add.</div>';
                return;
            }
            
            // Group items by category, filtered by user's zones AND items with quantities
            let html = '';
            checkinCategories.forEach(cat => {
                const items = state.assetItems.filter(item => 
                    item.Category_ID === cat.ID && 
                    isItemAvailableForUser(item) &&
                    (item.Quantity && item.Quantity > 0)  // ✅ Only show items with quantity > 0
                );
                if (items.length > 0) {
                    html += `<div class="checkin-category-header">${esc(cat.Name)}</div>`;
                    items.forEach(item => {
                        html += `
                            <div class="brochure-item">
                                <div class="brochure-label">${esc(item.Name)}</div>
                                <input type="number" class="brochure-input" data-asset-id="${item.ID}" value="0" min="0" max="99" inputmode="numeric">
                            </div>
                        `;
                    });
                }
            });
            
            grid.innerHTML = html || '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">No items available for your zone(s) or all items are out of stock. Go to Settings to add inventory.</div>';
        }
        
        let assetSortColumn = 'name';
        let assetSortAsc = true;
        let stockHistorySortAsc = false;
        
        function sortAssets(column) {
            if (assetSortColumn === column) {
                assetSortAsc = !assetSortAsc;
            } else {
                assetSortColumn = column;
                assetSortAsc = true;
            }
            updateSortArrows('assetsTable', assetSortColumn, assetSortAsc);
            renderAssets();
        }
        
        function sortStockHistory(column) {
            stockHistorySortAsc = !stockHistorySortAsc;
            updateSortArrows('stockHistoryTable', 'date', stockHistorySortAsc);
            renderAssets();
        }
        
        function renderAssets() {
            const tableBody = document.getElementById('assetsTable')?.querySelector('tbody');
            if (!tableBody) return;
            
            // Populate filter dropdowns
            const categoryFilter = document.getElementById('assetCategoryFilter');
            const zoneFilter = document.getElementById('assetZoneFilter');
            
            if (categoryFilter && categoryFilter.options.length <= 1) {
                state.assetCategories.forEach(cat => {
                    categoryFilter.add(new Option(cat.Name, cat.ID));
                });
            }
            
            if (zoneFilter && zoneFilter.options.length <= 1 && state.settings?.zones) {
                state.settings.zones.forEach(z => {
                    zoneFilter.add(new Option(`${z.code} - ${z.name}`, z.code));
                });
            }
            
            // Get filter values
            const catFilterVal = categoryFilter?.value || '';
            const zoneFilterVal = zoneFilter?.value || '';
            
            // Filter items
            let filteredItems = state.assetItems.filter(item => {
                if (catFilterVal && item.Category_ID !== catFilterVal) return false;
                if (zoneFilterVal) {
                    const itemZones = Array.isArray(item.Zones) ? item.Zones : (item.Zones ? JSON.parse(item.Zones) : ['all']);
                    if (!itemZones.includes('all') && !itemZones.includes(zoneFilterVal)) return false;
                }
                return true;
            });
            
            // Sort items
            filteredItems.sort((a, b) => {
                let cmp = 0;
                const catA = state.assetCategories.find(c => c.ID === a.Category_ID);
                const catB = state.assetCategories.find(c => c.ID === b.Category_ID);
                const isLowA = (a.Quantity || 0) < (a.Threshold || 50);
                const isLowB = (b.Quantity || 0) < (b.Threshold || 50);
                
                switch (assetSortColumn) {
                    case 'category': cmp = (catA?.Name || '').localeCompare(catB?.Name || ''); break;
                    case 'name': cmp = (a.Name || '').localeCompare(b.Name || ''); break;
                    case 'quantity': cmp = (a.Quantity || 0) - (b.Quantity || 0); break;
                    case 'status': cmp = isLowB - isLowA; break; // Low stock first when descending
                }
                return assetSortAsc ? cmp : -cmp;
            });
            
            // Render table
            tableBody.innerHTML = filteredItems.map(item => {
                const cat = state.assetCategories.find(c => c.ID === item.Category_ID);
                const isLow = (item.Quantity || 0) < (item.Threshold || 50);
                const itemZones = Array.isArray(item.Zones) ? item.Zones : (item.Zones ? JSON.parse(item.Zones) : ['all']);
                const zonesHtml = itemZones.includes('all') 
                    ? '<span class="zone-tag all-zones">All</span>'
                    : itemZones.map(z => `<span class="zone-tag">${z}</span>`).join(' ');
                
                const statusBadge = isLow 
                    ? '<span class="status-badge status-inactive">⚠️ Low Stock</span>'
                    : '<span class="status-badge status-active">OK</span>';
                
                return `<tr class="${isLow ? 'low-stock-row' : ''}">
                    <td>
                        <span class="material-icons-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px; color: var(--orange);">${cat?.Icon || 'folder'}</span>
                        ${esc(cat?.Name || '-')}
                    </td>
                    <td><strong>${esc(item.Name)}</strong></td>
                    <td><span class="zone-tags">${zonesHtml}</span></td>
                    <td style="font-weight: 600; font-size: 16px; ${isLow ? 'color: var(--danger);' : 'color: var(--navy);'}">${item.Quantity || 0}</td>
                    <td>${item.Threshold || 50}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn btn-sm btn-primary" onclick="quickAddStock('${item.ID}')" title="Add Stock">+</button>
                            <button class="btn btn-sm btn-secondary" onclick="quickRemoveStock('${item.ID}')" title="Remove Stock">−</button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--gray-400); padding: 40px;">No assets. Go to Settings to add categories and items.</td></tr>';
            
            // Render stock history (sorted)
            const historyTable = document.getElementById('stockHistoryTable')?.querySelector('tbody');
            if (historyTable) {
                let sortedHistory = [...state.stockHistory].sort((a, b) => {
                    const dateA = new Date(a.Date);
                    const dateB = new Date(b.Date);
                    return stockHistorySortAsc ? dateA - dateB : dateB - dateA;
                });
                
                historyTable.innerHTML = sortedHistory.slice(0, 50).map(h => {
                    const item = state.assetItems.find(a => a.ID === h.Asset_ID);
                    const cat = item ? state.assetCategories.find(c => c.ID === item.Category_ID) : null;
                    return `<tr>
                        <td>${new Date(h.Date).toLocaleDateString()}</td>
                        <td>${esc(item?.Name || h.Asset_ID)}${cat ? ` <small style="color:var(--gray-400)">(${cat.Name})</small>` : ''}</td>
                        <td><span class="status-badge ${h.Type === 'add' ? 'status-active' : 'status-inactive'}">${h.Type === 'add' ? '+' : '-'}</span></td>
                        <td>${h.Quantity}</td>
                        <td>${esc(h.By || '')}</td>
                        <td>${esc(h.Notes || '')}</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="6" style="text-align: center; color: var(--gray-400);">No stock history</td></tr>';
            }
            
            // Update sort arrows
            updateSortArrows('assetsTable', assetSortColumn, assetSortAsc);
            updateSortArrows('stockHistoryTable', 'date', stockHistorySortAsc);
        }
        
        function checkLowStock() {
            const lowStockItems = state.assetItems.filter(a => (a.Quantity || 0) < (a.Threshold || 50));
            const badge = document.getElementById('lowStockBadge');
            const alert = document.getElementById('lowStockAlert');
            
            if (lowStockItems.length > 0) {
                if (badge) { badge.textContent = lowStockItems.length; badge.style.display = 'inline'; }
                if (alert) {
                    document.getElementById('lowStockMessage').textContent = 
                        `${lowStockItems.length} item(s) running low: ${lowStockItems.map(i => i.Name).join(', ')}`;
                    alert.style.display = 'flex';
                }
            } else {
                if (badge) badge.style.display = 'none';
                if (alert) alert.style.display = 'none';
            }
        }
        
        function openAddStockModal() {
            // Populate with items grouped by category
            let options = '<option value="">Select Item</option>';
            state.assetCategories.forEach(cat => {
                const items = state.assetItems.filter(i => i.Category_ID === cat.ID);
                if (items.length > 0) {
                    options += `<optgroup label="${esc(cat.Name)}">`;
                    items.forEach(item => {
                        options += `<option value="${item.ID}">${esc(item.Name)} (${item.Quantity || 0})</option>`;
                    });
                    options += '</optgroup>';
                }
            });
            document.getElementById('addStockAsset').innerHTML = options;
            document.getElementById('addStockQty').value = 100;
            document.getElementById('addStockNotes').value = '';
            openModal('addStockModal');
        }
        
        async function addStock() {
            const itemId = document.getElementById('addStockAsset').value;
            const newQuantity = parseInt(document.getElementById('addStockQty').value) || 0;
            const notes = document.getElementById('addStockNotes').value;
            
            if (!itemId || newQuantity < 0) { showToast('Select item and enter valid quantity', 'error'); return; }
            
            showLoading(true);
            try {
                const item = state.assetItems.find(a => a.ID === itemId);
                if (item) {
                    const oldQuantity = item.Quantity || 0;
                    // ✅ SET quantity to exact value (NOT add)
                    item.Quantity = newQuantity;
                    
                    state.stockHistory.unshift({
                        ID: 'sh_' + Date.now(),
                        Asset_ID: itemId,
                        Type: newQuantity > oldQuantity ? 'adjustment_increase' : 'adjustment_decrease',
                        Quantity: newQuantity,
                        Date: new Date().toISOString(),
                        By: state.user?.name || '',
                        Notes: `Set to ${newQuantity} (was ${oldQuantity})${notes ? ': ' + notes : ''}`
                    });
                    
                    // ✅ Send exact quantity to database
                    await apiPost('updateAssetStock', { assetId: itemId, quantity: newQuantity, history: state.stockHistory[0] });
                    
                    renderAssets();
                    checkLowStock();
                    closeModal('addStockModal');
                    showToast(`Set ${item.Name} to ${newQuantity} units`, 'success');
                }
            } catch (err) { showToast('Failed to update stock', 'error'); }
            showLoading(false);
        }
        
        function quickAddStock(itemId) {
            const newQty = prompt('Enter new quantity (this SETS the value, not adds to it):');
            if (newQty !== null && !isNaN(newQty) && parseInt(newQty) >= 0) {
                const item = state.assetItems.find(a => a.ID === itemId);
                if (item) {
                    const oldQty = item.Quantity || 0;
                    const newQuantity = parseInt(newQty);
                    // ✅ SET the quantity
                    item.Quantity = newQuantity;
                    state.stockHistory.unshift({
                        ID: 'sh_' + Date.now(),
                        Asset_ID: itemId,
                        Type: newQuantity > oldQty ? 'adjustment_increase' : 'adjustment_decrease',
                        Quantity: newQuantity,
                        Date: new Date().toISOString(),
                        By: state.user?.name || '',
                        Notes: `Adjusted from ${oldQty} to ${newQuantity}`
                    });
                    apiPost('updateAssetStock', { assetId: itemId, quantity: newQuantity, history: state.stockHistory[0] });
                    renderAssets();
                    checkLowStock();
                    showToast(`${item.Name} set to ${newQuantity}`, 'success');
                }
            }
        }
        
        function quickRemoveStock(itemId) {
            const newQty = prompt('Enter new quantity (this SETS the value, not subtracts from it):');
            if (newQty !== null && !isNaN(newQty) && parseInt(newQty) >= 0) {
                const item = state.assetItems.find(a => a.ID === itemId);
                if (item) {
                    const oldQty = item.Quantity || 0;
                    const newQuantity = parseInt(newQty);
                    // ✅ SET the quantity
                    item.Quantity = newQuantity;
                    state.stockHistory.unshift({
                        ID: 'sh_' + Date.now(),
                        Asset_ID: itemId,
                        Type: newQuantity < oldQty ? 'adjustment_decrease' : 'adjustment_increase',
                        Quantity: newQuantity,
                        Date: new Date().toISOString(),
                        By: state.user?.name || '',
                        Notes: `Adjusted from ${oldQty} to ${newQuantity}`
                    });
                    apiPost('updateAssetStock', { assetId: itemId, quantity: newQuantity, history: state.stockHistory[0] });
                    renderAssets();
                    checkLowStock();
                    showToast(`${item.Name} set to ${newQuantity}`, 'success');
                }
            }
        }

        // ============================================
        // SETTINGS
        // ============================================
        function renderSettings() {
            // Asset Categories List
            const categoriesList = document.getElementById('assetCategoriesList');
            if (categoriesList) {
                categoriesList.innerHTML = state.assetCategories.map(c => `
                    <div class="setting-list-item">
                        <div>
                            <span class="material-icons-outlined" style="vertical-align: middle; margin-right: 8px;">${c.Icon || 'folder'}</span>
                            <span class="setting-list-item-name">${esc(c.Name)}</span>
                            <span style="color: var(--gray-400); font-size: 12px; margin-left: 8px;">
                                (${state.assetItems.filter(i => i.Category_ID === c.ID).length} items${c.ShowInCheckin !== false ? ', In Check-In' : ''})
                            </span>
                        </div>
                        <div class="setting-list-item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editAssetCategory('${c.ID}')">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="deleteAssetCategory('${c.ID}')" style="color: var(--danger);">Delete</button>
                        </div>
                    </div>
                `).join('') || '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No categories. Add one to get started.</div>';
            }
            
            // Asset Items List (grouped by category)
            const itemsList = document.getElementById('assetItemsList');
            if (itemsList) {
                let html = '';
                state.assetCategories.forEach(cat => {
                    const items = state.assetItems.filter(i => i.Category_ID === cat.ID);
                    items.forEach(item => {
                        const isLow = (item.Quantity || 0) < (item.Threshold || 50);
                        const itemZones = Array.isArray(item.Zones) ? item.Zones : (item.Zones ? JSON.parse(item.Zones) : ['all']);
                        const zonesHtml = itemZones.includes('all') 
                            ? '<span class="zone-tag all-zones">All Zones</span>'
                            : itemZones.map(z => `<span class="zone-tag">${z}</span>`).join('');
                        
                        html += `
                            <div class="setting-list-item ${isLow ? 'low-stock-item' : ''}">
                                <div>
                                    <span class="setting-list-item-name">${esc(item.Name)}</span>
                                    <span style="color: var(--gray-400); font-size: 12px; margin-left: 8px;">
                                        (${cat.Name} • Qty: ${item.Quantity || 0})
                                    </span>
                                    <span class="zone-tags" style="margin-left: 8px;">${zonesHtml}</span>
                                    ${isLow ? '<span style="color: var(--danger); font-size: 11px; margin-left: 8px;">⚠️ Low</span>' : ''}
                                </div>
                                <div class="setting-list-item-actions">
                                    <button class="btn btn-sm btn-secondary" onclick="editAssetItem('${item.ID}')">Edit</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteAssetItem('${item.ID}')" style="color: var(--danger);">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                });
                itemsList.innerHTML = html || '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No items. Add a category first, then add items.</div>';
            }
            
            // Outcomes List
            const outcomesList = document.getElementById('outcomesList');
            if (outcomesList) {
                outcomesList.innerHTML = state.settings.outcomes.map((o, i) => `
                    <div class="setting-list-item">
                        <span class="setting-list-item-name">${esc(o)}</span>
                        <div class="setting-list-item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="deleteOutcome(${i})" style="color: var(--danger);">Delete</button>
                        </div>
                    </div>
                `).join('') || '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No outcomes configured</div>';
            }
            
            // Organization Types List
            const orgTypesList = document.getElementById('orgTypesList');
            if (orgTypesList) {
                const orgTypes = state.settings?.organizationTypes || [];
                orgTypesList.innerHTML = orgTypes.map((t, i) => `
                    <div class="setting-list-item">
                        <span class="setting-list-item-name">${esc(t)}</span>
                        <div class="setting-list-item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="deleteOrgType(${i})" style="color: var(--danger);">Delete</button>
                        </div>
                    </div>
                `).join('') || '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No organization types configured</div>';
            }
            
            // Zones List
            const zonesList = document.getElementById('zonesList');
            if (zonesList) {
                const zones = state.settings?.zones || [];
                zonesList.innerHTML = zones.map((z, i) => `
                    <div class="setting-list-item">
                        <div>
                            <span class="zone-badge">${z.code}</span>
                            <span class="setting-list-item-name" style="margin-left: 8px;">${esc(z.name)}</span>
                        </div>
                        <div class="setting-list-item-actions">
                            <button class="btn btn-sm btn-secondary" onclick="deleteZone(${i})" style="color: var(--danger);">Delete</button>
                        </div>
                    </div>
                `).join('') || '<div style="color: var(--gray-400); text-align: center; padding: 20px;">No zones configured</div>';
            }
            
            // Load saved settings
            const emailCheck = document.getElementById('settingLowStockEmail');
            const thresholdInput = document.getElementById('settingLowStockThreshold');
            if (emailCheck) emailCheck.checked = state.settings.lowStockEmailEnabled !== false;
            if (thresholdInput) thresholdInput.value = state.settings.lowStockThreshold || 50;
            
            // Update outcome dropdown in check-in
            const outcomeSelect = document.getElementById('checkinOutcome');
            if (outcomeSelect && state.settings.outcomes.length) {
                outcomeSelect.innerHTML = state.settings.outcomes.map(o => `<option value="${esc(o)}">${esc(o)}</option>`).join('');
            }
        }
        
        function saveSetting(key, value) {
            state.settings[key] = value;
            apiPost('saveSetting', { key, value });
            showToast('Setting saved', 'success');
        }
        
        // Asset Category CRUD
        function openAssetCategoryModal() {
            document.getElementById('assetCategoryModalTitle').textContent = 'Add Asset Category';
            document.getElementById('assetCategoryId').value = '';
            document.getElementById('assetCategoryName').value = '';
            document.getElementById('assetCategoryIcon').value = 'description';
            document.getElementById('assetCategoryShowInCheckin').checked = true;
            openModal('assetCategoryModal');
        }
        
        function editAssetCategory(id) {
            const c = state.assetCategories.find(x => x.ID === id);
            if (!c) return;
            document.getElementById('assetCategoryModalTitle').textContent = 'Edit Category';
            document.getElementById('assetCategoryId').value = c.ID;
            document.getElementById('assetCategoryName').value = c.Name || '';
            document.getElementById('assetCategoryIcon').value = c.Icon || 'description';
            document.getElementById('assetCategoryShowInCheckin').checked = c.ShowInCheckin !== false;
            openModal('assetCategoryModal');
        }
        
        async function saveAssetCategory() {
            const category = {
                ID: document.getElementById('assetCategoryId').value || 'cat_' + Date.now(),
                Name: document.getElementById('assetCategoryName').value,
                Icon: document.getElementById('assetCategoryIcon').value,
                ShowInCheckin: document.getElementById('assetCategoryShowInCheckin').checked
            };
            
            if (!category.Name) { showToast('Enter category name', 'error'); return; }
            
            showLoading(true);
            try {
                const existingIdx = state.assetCategories.findIndex(c => c.ID === category.ID);
                if (existingIdx >= 0) {
                    state.assetCategories[existingIdx] = category;
                } else {
                    state.assetCategories.push(category);
                }
                
                await apiPost('saveAssetCategory', { category });
                closeModal('assetCategoryModal');
                renderAll();
                showToast('Category saved', 'success');
            } catch (err) { showToast('Save failed', 'error'); }
            showLoading(false);
        }
        
        async function deleteAssetCategory(id) {
            const itemsInCat = state.assetItems.filter(i => i.Category_ID === id);
            if (itemsInCat.length > 0) {
                showToast(`Cannot delete: ${itemsInCat.length} items in this category`, 'error');
                return;
            }
            if (!confirm('Delete this category?')) return;
            showLoading(true);
            try {
                await apiPost('deleteAssetCategory', { id });
                state.assetCategories = state.assetCategories.filter(c => c.ID !== id);
                renderAll();
                showToast('Deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }
        
        // Asset Item CRUD
        function toggleAllZones() {
            const allChecked = document.getElementById('assetItemAllZones').checked;
            const zonesContainer = document.getElementById('assetItemZonesList');
            zonesContainer.classList.toggle('disabled', allChecked);
            
            // Uncheck individual zones when "All" is selected
            if (allChecked) {
                zonesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        }
        
        function populateZoneCheckboxes(selectedZones = ['all']) {
            const zonesContainer = document.getElementById('assetItemZonesList');
            const isAllZones = selectedZones.includes('all');
            
            document.getElementById('assetItemAllZones').checked = isAllZones;
            
            const zones = state.settings?.zones || [];
            zonesContainer.innerHTML = zones.map(z => `
                <label>
                    <input type="checkbox" value="${z.code}" ${!isAllZones && selectedZones.includes(z.code) ? 'checked' : ''}>
                    ${z.code} - ${esc(z.name)}
                </label>
            `).join('');
            
            zonesContainer.classList.toggle('disabled', isAllZones);
        }
        
        function getSelectedZones() {
            if (document.getElementById('assetItemAllZones').checked) {
                return ['all'];
            }
            const zones = [];
            document.querySelectorAll('#assetItemZonesList input[type="checkbox"]:checked').forEach(cb => {
                zones.push(cb.value);
            });
            return zones.length > 0 ? zones : ['all']; // Default to all if none selected
        }
        
        function openAssetItemModal() {
            document.getElementById('assetItemModalTitle').textContent = 'Add Asset Item';
            document.getElementById('assetItemId').value = '';
            document.getElementById('assetItemName').value = '';
            document.getElementById('assetItemThreshold').value = 50;
            document.getElementById('assetItemInitialQty').value = 0;
            
            // Populate category dropdown
            document.getElementById('assetItemCategory').innerHTML = 
                '<option value="">Select Category</option>' +
                state.assetCategories.map(c => `<option value="${c.ID}">${esc(c.Name)}</option>`).join('');
            
            // Populate zone checkboxes (default to All)
            populateZoneCheckboxes(['all']);
            
            openModal('assetItemModal');
        }
        
        function editAssetItem(id) {
            const item = state.assetItems.find(x => x.ID === id);
            if (!item) return;
            document.getElementById('assetItemModalTitle').textContent = 'Edit Item';
            document.getElementById('assetItemId').value = item.ID;
            document.getElementById('assetItemName').value = item.Name || '';
            document.getElementById('assetItemThreshold').value = item.Threshold || 50;
            document.getElementById('assetItemInitialQty').value = item.Quantity || 0;
            
            // Populate category dropdown
            document.getElementById('assetItemCategory').innerHTML = 
                '<option value="">Select Category</option>' +
                state.assetCategories.map(c => `<option value="${c.ID}" ${c.ID === item.Category_ID ? 'selected' : ''}>${esc(c.Name)}</option>`).join('');
            
            // Populate zone checkboxes with item's zones
            const itemZones = Array.isArray(item.Zones) ? item.Zones : (item.Zones ? JSON.parse(item.Zones) : ['all']);
            populateZoneCheckboxes(itemZones);
            
            openModal('assetItemModal');
        }
        
        async function saveAssetItem() {
            const selectedZones = getSelectedZones();
            
            const item = {
                ID: document.getElementById('assetItemId').value || 'item_' + Date.now(),
                Category_ID: document.getElementById('assetItemCategory').value,
                Name: document.getElementById('assetItemName').value,
                Threshold: parseInt(document.getElementById('assetItemThreshold').value) || 50,
                Quantity: parseInt(document.getElementById('assetItemInitialQty').value) || 0,  // ✅ Use form value
                Zones: selectedZones
            };
            
            if (!item.Category_ID) { showToast('Select a category', 'error'); return; }
            if (!item.Name) { showToast('Enter item name', 'error'); return; }
            
            showLoading(true);
            try {
                const existingIdx = state.assetItems.findIndex(i => i.ID === item.ID);
                if (existingIdx >= 0) {
                    // ✅ FIXED: Don't override quantity - use the value from the form
                    state.assetItems[existingIdx] = item;
                } else {
                    state.assetItems.push(item);
                }
                
                // ✅ FIXED: Send all asset items to update database
                await apiPost('saveAssetItem', { item, allAssets: state.assetItems });
                closeModal('assetItemModal');
                renderAll();
                showToast('Item saved', 'success');
            } catch (err) { showToast('Save failed', 'error'); }
            showLoading(false);
        }
        
        async function deleteAssetItem(id) {
            if (!confirm('Delete this item?')) return;
            showLoading(true);
            try {
                await apiPost('deleteAssetItem', { id });
                state.assetItems = state.assetItems.filter(i => i.ID !== id);
                renderAll();
                showToast('Deleted', 'success');
            } catch (err) { showToast('Delete failed', 'error'); }
            showLoading(false);
        }
        
        // Outcome CRUD
        function openOutcomeModal() {
            document.getElementById('outcomeId').value = '';
            document.getElementById('outcomeName').value = '';
            openModal('outcomeModal');
        }
        
        async function saveOutcome() {
            const name = document.getElementById('outcomeName').value.trim();
            if (!name) { showToast('Enter outcome name', 'error'); return; }
            
            if (!state.settings.outcomes.includes(name)) {
                state.settings.outcomes.push(name);
                await apiPost('saveSetting', { key: 'outcomes', value: state.settings.outcomes });
                closeModal('outcomeModal');
                renderSettings();
                showToast('Outcome added', 'success');
            } else {
                showToast('Outcome already exists', 'error');
            }
        }
        
        async function deleteOutcome(index) {
            if (!confirm('Delete this outcome?')) return;
            state.settings.outcomes.splice(index, 1);
            await apiPost('saveSetting', { key: 'outcomes', value: state.settings.outcomes });
            renderSettings();
            showToast('Deleted', 'success');
        }
        
        // Organization Type CRUD
        function openOrgTypeModal() {
            document.getElementById('orgTypeId').value = '';
            document.getElementById('orgTypeName').value = '';
            openModal('orgTypeModal');
        }
        
        async function saveOrgType() {
            const name = document.getElementById('orgTypeName').value.trim();
            if (!name) { showToast('Enter organization type name', 'error'); return; }
            
            // Initialize organizationTypes if it doesn't exist
            if (!state.settings.organizationTypes) {
                state.settings.organizationTypes = [];
            }
            
            if (!state.settings.organizationTypes.includes(name)) {
                state.settings.organizationTypes.push(name);
                state.settings.organizationTypes.sort();
                await apiPost('saveSetting', { key: 'organizationTypes', value: state.settings.organizationTypes });
                closeModal('orgTypeModal');
                renderSettings();
                populateOrgTypeDropdown();
                showToast('Organization type added', 'success');
            } else {
                showToast('Organization type already exists', 'error');
            }
        }
        
        async function deleteOrgType(index) {
            if (!confirm('Delete this organization type?')) return;
            
            // Initialize organizationTypes if it doesn't exist
            if (!state.settings.organizationTypes) {
                state.settings.organizationTypes = [];
            }
            
            state.settings.organizationTypes.splice(index, 1);
            await apiPost('saveSetting', { key: 'organizationTypes', value: state.settings.organizationTypes });
            renderSettings();
            populateOrgTypeDropdown();
            showToast('Deleted', 'success');
        }
        
        // Zone CRUD
        function openZoneModal() {
            document.getElementById('zoneId').value = '';
            document.getElementById('zoneCode').value = '';
            document.getElementById('zoneName').value = '';
            openModal('zoneModal');
        }
        
        async function saveZone() {
            const code = document.getElementById('zoneCode').value.trim().toUpperCase();
            const name = document.getElementById('zoneName').value.trim();
            if (!code || !name) { showToast('Enter code and name', 'error'); return; }
            
            if (!state.settings.zones.find(z => z.code === code)) {
                state.settings.zones.push({ code, name });
                await apiPost('saveSetting', { key: 'zones', value: state.settings.zones });
                closeModal('zoneModal');
                renderSettings();
                showToast('Zone added', 'success');
            } else {
                showToast('Zone code already exists', 'error');
            }
        }
        
        async function deleteZone(index) {
            if (!confirm('Delete this zone?')) return;
            state.settings.zones.splice(index, 1);
            await apiPost('saveSetting', { key: 'zones', value: state.settings.zones });
            renderSettings();
            showToast('Deleted', 'success');
        }

        // ============================================
        // UTILITIES
        // ============================================
        function esc(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function showLoading(show) { document.getElementById('loading').classList.toggle('active', show); }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) {
                // Fallback: create container if it doesn't exist
                const newContainer = document.createElement('div');
                newContainer.id = 'toastContainer';
                newContainer.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;pointer-events:none;';
                document.body.appendChild(newContainer);
            }
            
            const actualContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            toast.style.animation = 'slideIn 0.3s ease-out';
            toast.style.cssText += 'padding:12px 16px;border-radius:6px;background:var(--gray-800);color:var(--white);font-size:14px;box-shadow:var(--shadow-lg);pointer-events:auto;';
            actualContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function formatVisitDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            
            const days = Math.floor((today - date) / (1000 * 60 * 60 * 24));
            if (days < 7) return days + 'd ago';
            if (days < 30) return Math.floor(days / 7) + 'w ago';
            if (days < 365) return Math.floor(days / 30) + 'm ago';
            return Math.floor(days / 365) + 'y ago';
        }
        
        function getVisitDateClass(dateStr) {
            if (!dateStr) return 'never-visited';
            const days = Math.floor((new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
            if (days <= 30) return 'visited-recent';
            if (days <= 90) return 'visited-moderate';
            return 'visited-overdue';
        }
        
        function getLastVisitDate(orgId) {
            const visits = state.visits.filter(v => String(v.Org_ID) === String(orgId));
            if (visits.length === 0) return null;
            return visits.reduce((latest, v) => {
                const latestDate = new Date(latest.Visit_Date || 0);
                const visitDate = new Date(v.Visit_Date || 0);
                return visitDate > latestDate ? v : latest;
            }).Visit_Date;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
    </script>
</body>
</html>