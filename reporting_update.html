<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alice.care: Client Service Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #E5ECF3;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Loading Spinner Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 54, 92, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(3px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 40px 60px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #E5ECF3;
            border-top: 5px solid #F57600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #1A365C;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .loading-subtext {
            color: #666;
            font-size: 13px;
        }
        
        /* Tab Navigation */
        .nav-tabs {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: #1A365C;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            background: #F57600;
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: #E5ECF3;
        }
        
        .tab-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Sortable Table Headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background 0.2s;
        }
        
        .sortable-header:hover {
            background: rgba(245, 118, 0, 0.1);
        }
        
        .sortable-header .sort-icon {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.4;
            font-size: 10px;
            transition: opacity 0.2s;
        }
        
        .sortable-header:hover .sort-icon {
            opacity: 0.7;
        }
        
        .sortable-header.sort-asc .sort-icon,
        .sortable-header.sort-desc .sort-icon {
            opacity: 1;
            color: #F57600;
        }
        
        .sortable-header.sort-asc .sort-icon::after {
            content: 'â–²';
        }
        
        .sortable-header.sort-desc .sort-icon::after {
            content: 'â–¼';
        }
        
        .sortable-header:not(.sort-asc):not(.sort-desc) .sort-icon::after {
            content: 'â‡…';
        }
        
        /* Expected Reports Styles */
        .expected-reports-section {
            margin-top: 20px;
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .period-type-buttons {
            display: flex;
            gap: 5px;
        }
        
        .period-type-btn {
            padding: 10px 20px;
            border: 2px solid #E5ECF3;
            background: white;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: #1A365C;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .period-type-btn:hover {
            border-color: #F57600;
        }
        
        .period-type-btn.active {
            background: #F57600;
            border-color: #F57600;
            color: white;
        }
        
        .period-inputs {
            display: flex;
            gap: 10px;
        }
        
        .expandable-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .expandable-row:hover {
            background: rgba(245, 118, 0, 0.05);
        }
        
        .expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: 2px solid #E5ECF3;
            border-radius: 50%;
            background: white;
            color: #1A365C;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 8px;
        }
        
        .expand-btn:hover {
            border-color: #F57600;
            color: #F57600;
        }
        
        .expand-btn.expanded {
            background: #F57600;
            border-color: #F57600;
            color: white;
            transform: rotate(45deg);
        }
        
        .service-details-row {
            display: none;
            background: #F9FAFB;
        }
        
        .service-details-row.expanded {
            display: table-row;
        }
        
        .service-details-cell {
            padding: 0 !important;
        }
        
        .service-details-wrapper {
            padding: 15px 20px;
            border-left: 3px solid #F57600;
            margin: 0 15px 15px 15px;
            background: white;
            border-radius: 0 8px 8px 0;
        }
        
        .service-details-table {
            width: 100%;
            font-size: 12px;
        }
        
        .service-details-table th {
            background: #E5ECF3;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            color: #1A365C;
        }
        
        .service-details-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #E5ECF3;
        }
        
        .summary-row {
            font-weight: 600;
            background: #FFF8F0;
        }
        
        .summary-row td {
            border-top: 2px solid #F57600;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.15);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: #1A365C;
            color: white;
            padding: 40px 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            border: 40px solid rgba(245, 118, 0, 0.1);
            border-radius: 50%;
            top: -150px;
            right: -100px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .header-left {
            flex: 1;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .logo .alice { color: #F57600; font-weight: 700; }
        .logo .dot { color: #F57600; font-weight: 700; margin: 0 -2px; }
        .logo .care { color: white; font-weight: 400; }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
            font-weight: 400;
        }
        
        .header-search {
            position: relative;
        }
        
        .header-search input {
            width: 300px;
            padding: 12px 16px 12px 44px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .header-search input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .header-search input:focus {
            outline: none;
            border-color: #F57600;
            background: rgba(255,255,255,0.15);
        }
        
        .header-search svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            stroke: rgba(255,255,255,0.6);
        }
        
        /* Content Area */
        .content {
            padding: 30px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Section Title */
        .section-title {
            font-size: 18px;
            color: #1A365C;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #F57600;
            border-radius: 2px;
        }
        
        /* Notice Box */
        .notice-box {
            background: #E5ECF3;
            border-left: 4px solid #F57600;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .notice-box h3 {
            color: #1A365C;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .notice-box p {
            color: #3D3D3D;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .notice-box p:last-child { margin-bottom: 0; }
        
        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #F57600;
            box-shadow: 0 2px 10px rgba(26, 54, 92, 0.08);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(26, 54, 92, 0.12);
        }
        
        .stat-card.green { border-left-color: #62B790; }
        .stat-card.blue { border-left-color: #2196F3; }
        
        .stat-card h3 {
            font-size: 12px;
            color: #3D3D3D;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .number {
            font-size: 32px;
            color: #1A365C;
            font-weight: 700;
        }
        
        .stat-card .subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #E5ECF3;
            padding: 20px;
            border-radius: 8px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1A365C;
            font-size: 13px;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            background: white;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #F57600;
            color: white;
        }
        
        .btn-primary:hover {
            background: #e06d00;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 118, 0, 0.3);
        }
        
        .btn-secondary {
            background: #E5ECF3;
            color: #1A365C;
        }
        
        .btn-secondary:hover {
            background: #D3D7DF;
        }
        
        .btn-green {
            background: #62B790;
            color: white;
        }
        
        .btn-green:hover {
            background: #54A07E;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #E5ECF3;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }
        
        .data-table thead {
            background: #1A365C;
            color: white;
        }
        
        .data-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #E5ECF3;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background: #F9FAFB;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Badge Styles */
        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
        }
        
        .badge-pending { background: #FFF3E0; color: #F57600; }
        .badge-completed { background: #E0F1E9; color: #62B790; }
        .badge-assigned { background: #E3F2FD; color: #2196F3; }
        .badge-unassigned { background: #F5F5F5; color: #999; }
        .badge-cancelled { background: #FFE3E3; color: #FF7475; }
        .badge-paid { background: #E0F1E9; color: #62B790; }
        .badge-weekly { background: #E3F2FD; color: #2196F3; }
        .badge-monthly { background: #E0F1E9; color: #62B790; }
        .badge-yearly { background: #FFF3E0; color: #F57600; }
        .badge-none { background: #F5F5F5; color: #999; }
        
        /* Client Detail Sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.8);
            z-index: 1000;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .client-sidebar {
            position: fixed;
            top: 0;
            right: -500px;
            width: 480px;
            max-width: 100%;
            height: 100vh;
            background: white;
            z-index: 1001;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
        }
        
        .client-sidebar.active {
            right: 0;
        }
        
        .sidebar-header {
            background: #1A365C;
            color: white;
            padding: 30px;
            position: relative;
        }
        
        .sidebar-header::before {
            content: '';
            position: absolute;
            width: 150px;
            height: 150px;
            border: 20px solid rgba(245, 118, 0, 0.1);
            border-radius: 50%;
            top: -75px;
            right: -50px;
        }
        
        .close-sidebar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .close-sidebar:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .close-sidebar svg {
            pointer-events: none;
        }
        
        .sidebar-header h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-header p {
            opacity: 0.8;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-body {
            padding: 30px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #E5ECF3;
        }
        
        .sidebar-section:last-child {
            border-bottom: none;
        }
        
        .sidebar-section h3 {
            font-size: 14px;
            color: #1A365C;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-section h3::before {
            content: '';
            width: 3px;
            height: 16px;
            background: #F57600;
            border-radius: 2px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #F5F5F5;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-row .label {
            color: #999;
            font-size: 13px;
        }
        
        .detail-row .value {
            font-weight: 600;
            color: #1A365C;
            font-size: 13px;
        }
        
        /* Subscription Options */
        .subscription-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .subscription-option {
            flex: 1;
            position: relative;
        }
        
        .subscription-option input {
            position: absolute;
            opacity: 0;
        }
        
        .subscription-option label {
            display: block;
            padding: 15px;
            text-align: center;
            background: #F9FAFB;
            border: 2px solid #E5ECF3;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .subscription-option input:checked + label {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .subscription-option label:hover {
            border-color: #D3D7DF;
        }
        
        .subscription-option .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .subscription-option .name {
            font-weight: 600;
            color: #1A365C;
            font-size: 13px;
        }
        
        .subscription-option .desc {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        
        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #E5ECF3;
            border-top-color: #F57600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            stroke: #D3D7DF;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            color: #1A365C;
            margin-bottom: 8px;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 25px;
        }
        
        .pagination button {
            padding: 8px 14px;
            border: 2px solid #E5ECF3;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 13px;
            color: #1A365C;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #F57600;
            color: white;
            border-color: #F57600;
        }
        
        .page-info {
            font-size: 13px;
            color: #999;
            margin-left: 10px;
        }
        
        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            border: 1px solid #E5ECF3;
            border-radius: 8px;
            background: white;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(26, 54, 92, 0.15);
        }
        
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #F0F0F0;
            transition: background 0.2s;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: #FFF8F0;
        }
        
        .autocomplete-item .insurance-name {
            font-weight: 600;
            color: #1A365C;
            font-size: 14px;
        }
        
        .autocomplete-item .insurance-email {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .autocomplete-item .client-count {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(26, 54, 92, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            max-width: 360px;
            border-left: 4px solid #F57600;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-left-color: #62B790; }
        .toast.error { border-left-color: #FF7475; }
        .toast.warning { border-left-color: #F57600; }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #1A365C;
            font-weight: 500;
        }
        
        /* Quick Lookup */
        .quick-lookup {
            background: #F9FAFB;
            border: 2px solid #E5ECF3;
            border-radius: 12px;
            padding: 25px;
        }
        
        .quick-lookup-input {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .quick-lookup-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #D3D7DF;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
        }
        
        .quick-lookup-input input:focus {
            outline: none;
            border-color: #F57600;
            box-shadow: 0 0 0 3px rgba(245, 118, 0, 0.1);
        }
        
        #quickLookupResult {
            margin-top: 20px;
        }
        
        .lookup-result-card {
            background: white;
            border: 2px solid #E5ECF3;
            border-radius: 8px;
            padding: 20px;
        }
        
        .lookup-result-card h4 {
            color: #1A365C;
            margin-bottom: 5px;
        }
        
        .lookup-result-card p {
            color: #999;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .header-search input {
                width: 100%;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .stats-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .client-sidebar {
                width: 100%;
            }
            
            .subscription-options {
                flex-direction: column;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 54, 92, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(26, 54, 92, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #1A365C;
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(90vh - 150px);
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #E5ECF3;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Upload Area */
        .upload-dropzone {
            border: 2px dashed #D3D7DF;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #F9FAFB;
        }
        
        .upload-dropzone:hover {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .upload-dropzone.dragover {
            border-color: #F57600;
            background: #FFF8F0;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #E0F1E9;
            border-radius: 8px;
            border: 1px solid #62B790;
        }
        
        /* Upload Progress */
        .upload-progress {
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 8px;
            background: #E5ECF3;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #F57600;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 13px;
            color: #3D3D3D;
            margin-top: 8px;
            text-align: center;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #ccc;
            border-radius: 26px;
            transition: 0.3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #62B790;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .toggle-switch.small .toggle-slider {
            width: 40px;
            height: 22px;
        }
        
        .toggle-switch.small .toggle-slider:before {
            height: 16px;
            width: 16px;
        }
        
        .toggle-switch.small input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }
        
        .toggle-label {
            font-size: 13px;
            font-weight: 600;
            color: #1A365C;
        }
        
        /* Paused state */
        .config-card-paused {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .btn-blue {
            background: #2196F3;
            color: white;
            border: none;
        }
        
        .btn-blue:hover {
            background: #1976D2;
        }
        
        /* Report type radio styling */
        input[name="testReportType"]:checked + .report-type-option {
            border-color: #2196F3 !important;
            background: #E3F2FD !important;
        }
        
        input[name="testReportType"]:checked + .report-type-option span {
            color: #2196F3 !important;
        }
        
        .report-type-option:hover {
            border-color: #999 !important;
        }
        
        /* Info tooltip styles */
        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            font-size: 11px !important;
            font-weight: 600;
        }
        
        .info-tooltip:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: pre-line;
            width: 280px;
            max-width: 320px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            line-height: 1.5;
            text-transform: none;
        }
        
        .info-tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.9);
            z-index: 1001;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
            <div class="loading-subtext" id="loadingSubtext">Please wait</div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Tab Navigation -->
    <nav class="nav-tabs">
        <button class="tab-btn" data-tab="report">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            Service Report
        </button>
        <button class="tab-btn active" data-tab="client">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
            Clients
        </button>
        <button class="tab-btn" data-tab="expected">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
                <path d="M9 16l2 2 4-4"/>
            </svg>
            Expected Reports
        </button>
    </nav>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo">
                        <span class="alice">alice</span><span class="dot">.</span><span class="care">care</span>
                    </div>
                    <h1>Client Service Portal</h1>
                    <p>View service records, manage subscriptions, and generate reports</p>
                </div>
                <div class="header-search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="globalSearch" placeholder="Search client by name or email...">
                </div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="content">
            <!-- Report Tab -->
            <div class="tab-panel" id="report-panel">
                <h2 class="section-title">Service Report</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Client Name</label>
                        <input type="text" id="filterClient" placeholder="Search client...">
                    </div>
                    <div class="filter-group">
                         <label>Week Number <a href="week_number_reference.html" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #F57600; color: white; text-decoration: none; border-radius: 50%; font-weight: bold; font-size: 16px;" title="Find Week Number">?</a></span></label>
                        <input type="number" id="filterWeek" placeholder="Week #" min="1" max="53">
                    </div>
                    <div class="filter-group">
                        <label>Month</label>
                        <select id="filterMonth">
                            <option value="">All Months</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Year</label>
                        <select id="filterYear">
                            <option value="">All Years</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterStatus">
                            <option value="">All Status</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="ASSIGNED">Assigned</option>
                            <option value="UNASSIGNED">Unassigned</option>
                            <option value="CANCELLED_BY_CUSTOMER">Cancelled by Customer</option>
                            <option value="CANCELLED_BY_PROVIDER">Cancelled by Provider</option>
                        </select>
                    </div>
                </div>
                <div class="filters" style="margin-top: -10px; padding-top: 15px;">
                    <div class="filter-group">
                        <label>Start Date</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="filter-group">
                        <label>End Date</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div class="filter-buttons">
                        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="showUploadModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload CSV
                    </button>
                    <button class="btn btn-green" onclick="exportReport()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export CSV
                    </button>
                </div>
                
                <div id="reportTableContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading service report...</p>
                    </div>
                </div>
                
                <div class="pagination" id="reportPagination"></div>
            </div>
            
            <!-- Client Tab -->
            <div class="tab-panel active" id="client-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Client Directory</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="showLTCImportModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Import from LTC
                        </button>
                        <button class="btn btn-primary" onclick="showAddClientModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Client
                        </button>
                    </div>
                </div>
                
                <div class="notice-box">
                    <h3>ðŸ“‹ Email Routing Information</h3>
                    <p><strong>Assignment = 1:</strong> Reports/invoices are sent to <strong id="configBillingEmail">jennie@alice.care</strong></p>
                    <p><strong>Assignment = 0:</strong> Reports/invoices are sent to the <strong>Insurance Email</strong> specified for each client</p>
                </div>
                
                <div class="stats-row" id="clientStats">
                    <div class="stat-card">
                        <h3>Total Clients</h3>
                        <div class="number" id="totalClientsCount">--</div>
                        <div class="subtitle">In directory</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #9C27B0;">
                        <h3>Assignment Benefits</h3>
                        <div class="number" id="billingAssignedCount">--</div>
                        <div class="subtitle">Routed to billing</div>
                    </div>
                    <div class="stat-card blue">
                        <h3>CC Pay</h3>
                        <div class="number" id="insuranceAssignedCount">--</div>
                        <div class="subtitle">Direct payment</div>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Search Client</label>
                        <input type="text" id="filterClientName" placeholder="Name, email, or customer name..." oninput="applyClientFilters()" onkeypress="if(event.key==='Enter') applyClientFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Insurance</label>
                        <select id="filterInsurance" onchange="applyClientFilters()">
                            <option value="">All Insurance</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Assignment</label>
                        <select id="filterAssignment" onchange="applyClientFilters()">
                            <option value="">All Assignments</option>
                            <option value="1">Assignment Benefits (1)</option>
                            <option value="0">CC Pay (0)</option>
                        </select>
                    </div>
                    <div class="filter-buttons">
                        <button class="btn btn-primary" onclick="applyClientFilters()">Apply</button>
                        <button class="btn btn-secondary" onclick="clearClientFilters()">Clear</button>
                    </div>
                </div>
                
                <div id="clientTableContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading clients...</p>
                    </div>
                </div>
                
                <div class="pagination" id="clientPagination"></div>
                
                <!-- Automation Status Summary (collapsed view) -->
                <div id="automationStatusSummary" style="background: #F9FAFB; border: 1px solid #E5ECF3; border-radius: 12px; padding: 20px; margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1A365C; margin: 0; font-size: 16px;">ðŸ“Š Report Automation Status</h3>
                        <button class="btn btn-secondary" onclick="openAutomationSettings()" style="padding: 8px 12px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                            Settings
                        </button>
                    </div>
                    <div id="automationStatusContent" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Expected Reports Tab -->
            <div class="tab-panel" id="expected-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Expected Reports</h2>
                    <button class="btn btn-green" onclick="exportExpectedReport()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export CSV
                    </button>
                </div>
                
                <div class="notice-box" style="background: #E3F2FD; border-color: #2196F3;">
                    <h3>ðŸ“Š Report Preview</h3>
                    <p>Select a period to view expected billing reports. Click <strong>+</strong> on any client to expand and view individual service details.</p>
                </div>
                
                <div class="expected-reports-section">
                    <div class="period-selector">
                        <div class="filter-group">
                            <label>Period Type</label>
                            <div class="period-type-buttons">
                                <button class="period-type-btn active" data-period="week" onclick="selectPeriodType('week')">Week</button>
                                <button class="period-type-btn" data-period="month" onclick="selectPeriodType('month')">Month</button>
                                <button class="period-type-btn" data-period="year" onclick="selectPeriodType('year')">Year</button>
                            </div>
                        </div>
                        
                        <div class="filter-group" id="weekSelector">
                            <label>Week Number <a href="week_number_reference.html" target="_blank" style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #F57600; color: white; text-decoration: none; border-radius: 50%; font-weight: bold; font-size: 12px;" title="Find Week Number">?</a></label>
                            <input type="number" id="expectedWeek" placeholder="Week #" min="1" max="53" style="width: 100px;">
                        </div>
                        
                        <div class="filter-group" id="monthSelector" style="display: none;">
                            <label>Month</label>
                            <select id="expectedMonth">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Year</label>
                            <select id="expectedYear">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        
                        <div class="filter-buttons">
                            <button class="btn btn-primary" onclick="loadExpectedReports()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                </svg>
                                Load Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Additional Filters Row -->
                    <div class="filters" style="margin-top: -10px; padding-top: 15px; border-top: 1px solid #E5ECF3;">
                        <div class="filter-group">
                            <label>Insurance</label>
                            <select id="expectedInsurance" onchange="applyExpectedFilters()">
                                <option value="">All Insurance</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Report Frequency</label>
                            <select id="expectedFrequency" onchange="applyExpectedFilters()">
                                <option value="">All Frequencies</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Assignment of Benefits</label>
                            <select id="expectedAssignment" onchange="applyExpectedFilters()">
                                <option value="">All</option>
                                <option value="1">Yes (Assignment Benefits)</option>
                                <option value="0">No (CC Pay)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Sent Status</label>
                            <select id="expectedSentStatus" onchange="applyExpectedFilters()">
                                <option value="">All</option>
                                <option value="sent">Sent âœ“</option>
                                <option value="pending">Pending â€”</option>
                            </select>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-secondary" onclick="clearExpectedFilters()">Clear Filters</button>
                        </div>
                    </div>
                    
                    <div class="stats-row" id="expectedStats" style="display: none;">
                        <div class="stat-card">
                            <h3>Total Clients</h3>
                            <div class="number" id="expectedClientCount">--</div>
                            <div class="subtitle">With services</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #2196F3;">
                            <h3>Services</h3>
                            <div class="number" id="expectedServiceCount">--</div>
                            <div class="subtitle">Completed / Total</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #62B790;">
                            <h3>Completed Revenue</h3>
                            <div class="number" id="expectedTotalRevenue">--</div>
                            <div class="subtitle">Billable amount</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #4CAF50;">
                            <h3>Reports Sent</h3>
                            <div class="number" id="expectedSentCount">--</div>
                            <div class="subtitle">Completed</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #F57600;">
                            <h3>Reports Pending</h3>
                            <div class="number" id="expectedPendingCount">--</div>
                            <div class="subtitle">Not yet sent</div>
                        </div>
                    </div>
                    
                    <div id="expectedTableContainer">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <h3>Select a Period</h3>
                            <p>Choose a week, month, or year and click "Load Report" to view expected billing</p>
                        </div>
                    </div>
                    
                    <div class="pagination" id="expectedPagination"></div>
                    
                    <!-- No Services Section -->
                    <div id="noServicesSection" style="display: none; margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #C62828; margin: 0; display: flex; align-items: center; gap: 8px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="8" x2="12" y2="12"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                                Clients with No Services
                            </h3>
                            <span id="noServicesCount" class="badge" style="background: #FFEBEE; color: #C62828; padding: 6px 12px; font-size: 13px;">0 clients</span>
                        </div>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">These clients have a report subscription for this frequency but no services recorded in the selected period.</p>
                        <div id="noServicesTableContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeClientDetail()"></div>
    
    <!-- Client Detail Sidebar -->
    <div class="client-sidebar" id="clientSidebar">
        <div class="sidebar-header">
            <button class="close-sidebar" onclick="closeClientDetail()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <h2 id="detailClientName">Client Name</h2>
            <p id="detailCustomerName">Customer Name (links to Report)</p>
        </div>
        <div class="sidebar-body">
            <!-- Email Routing Section -->
            <div class="sidebar-section">
                <h3>Email Routing</h3>
                <div id="emailRouteIndicator" style="display: flex; align-items: center; gap: 10px; padding: 15px; border-radius: 8px; background: #E3F2FD; border: 1px solid #2196F3;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2" style="width: 24px; height: 24px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <div>
                        <div id="routeType" style="font-weight: 600; font-size: 13px; color: #1A365C;">Routing to Insurance</div>
                        <div id="routeEmail" style="font-size: 12px; color: #666;">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="sidebar-section">
                <h3>Contact Information</h3>
                <div class="detail-row" style="flex-direction: column; align-items: stretch;">
                    <span class="label">Client Email</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="sidebarClientEmail" style="flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="email1@example.com, email2@example.com">
                        <button onclick="updateClientEmail()" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;">Save</button>
                    </div>
                    <p style="font-size: 10px; color: #999; margin-top: 4px;">Multiple emails separated by comma</p>
                </div>
                <div class="detail-row">
                    <span class="label">Phone</span>
                    <span class="value" id="detailPhone">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Address</span>
                    <span class="value" id="detailAddress">--</span>
                </div>
            </div>
            
            <!-- Insurance Information -->
            <div class="sidebar-section">
                <h3>Insurance Information</h3>
                <div class="detail-row">
                    <span class="label">Insurance Name</span>
                    <span class="value" id="detailInsurance">--</span>
                </div>
                <div class="detail-row" style="flex-direction: column; align-items: stretch;">
                    <span class="label">Insurance Email</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="sidebarInsuranceEmail" style="flex: 1; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="claims@ins.com, adjuster@ins.com">
                        <button onclick="updateInsuranceEmail()" class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;">Save</button>
                    </div>
                    <p style="font-size: 10px; color: #999; margin-top: 4px;">Multiple emails separated by comma</p>
                </div>
                <div class="detail-row">
                    <span class="label">Policy #</span>
                    <span class="value" id="detailPolicy">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Claim #</span>
                    <span class="value" id="detailClaim">--</span>
                </div>
                <div id="emailSaveStatus" style="font-size: 11px; color: #62B790; margin-top: 8px; display: none;">
                    âœ“ Email updated
                </div>
            </div>
            
            <!-- Service Codes -->
            <div class="sidebar-section">
                <h3>Service Codes</h3>
                <div id="detailServiceCodes" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Service Summary</h3>
                <div class="detail-row">
                    <span class="label">Total Services</span>
                    <span class="value" id="detailTotalServices">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Completed</span>
                    <span class="value" id="detailCompleted">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Total Hours</span>
                    <span class="value" id="detailTotalHours">--</span>
                </div>
                <div class="detail-row">
                    <span class="label">Total Spent</span>
                    <span class="value" id="detailTotalSpent">--</span>
                </div>
            </div>
            
            <!-- Report Subscription -->
            <div class="sidebar-section">
                <h3>Report Subscription</h3>
                <p style="font-size: 13px; color: #999; margin-bottom: 15px;">
                    Select which reports to auto-send.
                </p>
                <div style="display: flex; flex-direction: column; gap: 10px; padding: 15px; border-radius: 8px; background: #F9FAFB;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sidebarSubWeekly" onchange="updateSubscription()" style="width: 18px; height: 18px; accent-color: #2196F3;">
                        <span style="background: #E3F2FD; color: #2196F3; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500;">Weekly</span>
                        <span style="font-size: 11px; color: #999;">Every Monday</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sidebarSubMonthly" onchange="updateSubscription()" style="width: 18px; height: 18px; accent-color: #62B790;">
                        <span style="background: #E0F1E9; color: #62B790; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500;">Monthly</span>
                        <span style="font-size: 11px; color: #999;">1st of month</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sidebarSubYearly" onchange="updateSubscription()" style="width: 18px; height: 18px; accent-color: #F57600;">
                        <span style="background: #FFF3E0; color: #F57600; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 500;">Yearly</span>
                        <span style="font-size: 11px; color: #999;">January 1st</span>
                    </label>
                </div>
                <div id="subscriptionSaveStatus" style="font-size: 11px; color: #62B790; margin-top: 8px; display: none;">
                    âœ“ Subscription updated
                </div>
            </div>
            
            <!-- Actions -->
            <div class="sidebar-section">
                <h3>Actions</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="sendClientReport()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        Send Report/Invoice
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="viewClientReports()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        View All Reports
                    </button>
                    <button class="btn btn-green" style="width: 100%;" onclick="editClient()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Edit Client
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="clientModalTitle">Add New Client</h2>
                <button class="close-modal" onclick="closeClientModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="filter-group">
                            <label>First Name *</label>
                            <input type="text" id="formFName" required>
                        </div>
                        <div class="filter-group">
                            <label>Last Name *</label>
                            <input type="text" id="formLName" required>
                        </div>
                        <div class="filter-group" style="grid-column: 1 / -1;">
                            <label>Address</label>
                            <input type="text" id="formAddress" placeholder="Street address, City, State ZIP">
                        </div>
                        <div class="filter-group">
                            <label>Email</label>
                            <input type="text" id="formEmail" placeholder="email1@example.com, email2@example.com">
                            <p style="font-size: 10px; color: #999; margin-top: 2px;">Multiple emails separated by comma</p>
                        </div>
                        <div class="filter-group">
                            <label>Phone</label>
                            <input type="tel" id="formPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="filter-group" style="position: relative;">
                            <label>Insurance Name</label>
                            <input type="text" id="formInsuranceName" placeholder="Start typing to search..." autocomplete="off" oninput="searchInsurance(this.value)" onfocus="searchInsurance(this.value)">
                            <div id="insuranceDropdown" class="autocomplete-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                        </div>
                        <div class="filter-group">
                            <label>Insurance Email</label>
                            <input type="text" id="formInsuranceEmail" placeholder="claims@ins.com, adjuster@ins.com">
                            <p style="font-size: 10px; color: #999; margin-top: 2px;">Auto-filled when selecting insurance, or enter manually</p>
                        </div>
                        <div class="filter-group">
                            <label>Policy #</label>
                            <input type="text" id="formPolicy" placeholder="Policy number">
                        </div>
                        <div class="filter-group">
                            <label>Claim #</label>
                            <input type="text" id="formClaim" placeholder="Claim number">
                        </div>
                        <div class="filter-group">
                            <label>Assignment</label>
                            <select id="formAssignment">
                                <option value="0">0 - Route to Insurance</option>
                                <option value="1">1 - Route to Billing</option>
                            </select>
                        </div>
                        <div class="filter-group" style="grid-column: 1 / -1;">
                            <label>Report Subscription</label>
                            <div style="display: flex; gap: 20px; padding: 12px; background: #F9FAFB; border-radius: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="formSubWeekly" style="width: 18px; height: 18px; accent-color: #2196F3;">
                                    <span style="background: #E3F2FD; color: #2196F3; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Weekly</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="formSubMonthly" style="width: 18px; height: 18px; accent-color: #62B790;">
                                    <span style="background: #E0F1E9; color: #62B790; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Monthly</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="formSubYearly" style="width: 18px; height: 18px; accent-color: #F57600;">
                                    <span style="background: #FFF3E0; color: #F57600; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Yearly</span>
                                </label>
                            </div>
                        </div>
                        <div class="filter-group" style="grid-column: 1 / -1;">
                            <label>Customer Name (Links to Reports)</label>
                            <input type="text" id="formCustomerName" placeholder="Must match Customer Name in Report tab">
                            <p style="font-size: 11px; color: #999; margin-top: 4px;">This field links the client to their service reports</p>
                        </div>
                    </div>
                    
                    <h4 style="color: #1A365C; margin: 20px 0 15px; font-size: 14px;">Service Codes</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #F9FAFB; padding: 15px; border-radius: 8px;">
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">BA</label>
                            <input type="text" id="formBA" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">DR</label>
                            <input type="text" id="formDR" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">TR</label>
                            <input type="text" id="formTR" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">CO</label>
                            <input type="text" id="formCO" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">TO</label>
                            <input type="text" id="formTO" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">EA</label>
                            <input type="text" id="formEA" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">AM</label>
                            <input type="text" id="formAM" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">CS</label>
                            <input type="text" id="formCS" style="padding: 8px;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px;">HM</label>
                            <input type="text" id="formHM" style="padding: 8px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeClientModal()">Cancel</button>
                <button class="btn btn-primary" id="saveClientBtn" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <!-- Send Report Modal -->
    <div class="modal-overlay" id="sendReportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Send Report</h2>
                <button class="close-modal" onclick="closeSendReportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #3D3D3D;">
                    Select the time period for the report to be sent to: <strong id="sendReportClientName">Client</strong>
                </p>
                
                <div class="filter-group" style="margin-bottom: 15px;">
                    <label>Report Type</label>
                    <select id="reportPeriodType" onchange="toggleReportPeriodInputs()">
                        <option value="week">Weekly Report</option>
                        <option value="month">Monthly Report</option>
                        <option value="year">Yearly Report</option>
                    </select>
                </div>
                
                <div id="weekInputGroup" class="filter-group" style="margin-bottom: 15px;">
                    <label>Week Number</label>
                    <input type="number" id="reportWeekNumber" placeholder="Enter week number (1-53)" min="1" max="53">
                </div>
                
                <div id="monthInputGroup" class="filter-group" style="margin-bottom: 15px; display: none;">
                    <label>Month</label>
                    <select id="reportMonth">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                
                <div id="yearInputGroup" class="filter-group" style="margin-bottom: 15px;">
                    <label>Year</label>
                    <select id="reportYear">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                
                <div id="yearlyReportNote" style="display: none; padding: 12px; background: #E8F5E9; border-radius: 8px; margin-bottom: 15px; font-size: 13px; color: #2E7D32;">
                    ðŸ“Š Yearly reports include a summary of all services for the selected year.
                </div>
                
                <div id="sendReportDestination" style="padding: 15px; border-radius: 8px; background: #E3F2FD; margin-top: 15px;">
                    <div style="font-size: 13px; color: #666;">Report will be sent to:</div>
                    <div id="sendReportEmail" style="font-weight: 600; color: #1A365C; margin-top: 5px;">Loading...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSendReportModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmSendReportBtn" onclick="confirmSendReport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Send Report
                </button>
            </div>
        </div>
    </div>

    <!-- Upload CSV Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Service Report CSV</h2>
                <button class="close-modal" onclick="closeUploadModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="notice-box">
                    <h3>ðŸ“‹ Upload Instructions</h3>
                    <p>Upload your service report CSV file. The data will replace existing records, and formula columns (Week, Month, Year, StartTIME, EndTIME, STxTime, ETxTime) will be automatically extended to all new rows.</p>
                    <p><strong>Expected columns:</strong> Customer Name, Scheduled Date, Scheduled Time, Provider Name, Start Time, Completion Time, Service Duration, Provider Pay, Cost To Customer, Service Plan, Payment Status, Status</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileSelect(event)" style="display: none;">
                    <div class="upload-dropzone" onclick="document.getElementById('csvFileInput').click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 15px; stroke: #F57600;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p style="font-weight: 600; color: #1A365C; margin-bottom: 5px;">Click to select CSV file</p>
                        <p style="font-size: 13px; color: #999;">or drag and drop here</p>
                    </div>
                </div>
                
                <div id="filePreview" style="display: none; margin-top: 20px;">
                    <div class="file-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; stroke: #62B790;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <div>
                            <p id="fileName" style="font-weight: 600; color: #1A365C;"></p>
                            <p id="fileSize" style="font-size: 12px; color: #999;"></p>
                        </div>
                        <button class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px;" onclick="clearFileSelection()">Remove</button>
                    </div>
                    <div id="previewStats" style="margin-top: 15px; padding: 15px; background: #E5ECF3; border-radius: 8px;">
                        <p style="font-size: 13px; color: #3D3D3D;"><strong>Rows detected:</strong> <span id="rowCount">0</span></p>
                        <p style="font-size: 13px; color: #3D3D3D;"><strong>Columns:</strong> <span id="colCount">0</span></p>
                    </div>
                </div>
                
                <div class="upload-options" style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="radio" name="uploadMode" value="replace" checked style="accent-color: #F57600;">
                        <span><strong>Replace</strong> - Clear existing data and upload new</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                        <input type="radio" name="uploadMode" value="append" style="accent-color: #F57600;">
                        <span><strong>Append</strong> - Add to existing data</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadCSVFile()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Automation Settings Modal -->
    <div class="modal-overlay" id="automationModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; display: inline; vertical-align: middle; margin-right: 8px;">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Report Automation Settings
                </h2>
                <button class="close-modal" onclick="closeAutomationSettings()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- Global Pause Control -->
                <div style="background: #FFF3E0; border: 2px solid #F57600; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #1A365C; margin: 0 0 5px 0; font-size: 16px;">â¸ï¸ Master Control</h3>
                            <p style="color: #666; font-size: 13px; margin: 0;">Pause all automated report sending</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="configPauseAll" onchange="togglePauseAll()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label" id="pauseAllLabel">Active</span>
                        </label>
                    </div>
                </div>
                
                <!-- Test Mode -->
                <div style="background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 12px; padding: 15px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #1A365C; margin: 0 0 5px 0; font-size: 14px;">ðŸ§ª Test Mode</h3>
                            <p style="color: #666; font-size: 12px; margin: 0;">Send all test reports to a single email instead of actual recipients</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="configTestMode" onchange="toggleTestMode()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label" id="testModeLabel">Off</span>
                        </label>
                    </div>
                    <div id="testEmailContainer" style="margin-top: 15px; display: none;">
                        <label style="font-size: 12px; color: #666;">Test Email Address</label>
                        <input type="email" id="configTestEmail" placeholder="your-test-email@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <!-- Weekly Reports Config -->
                    <div id="weeklyConfigCard" style="background: #E3F2FD; border: 1px solid #2196F3; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #2196F3; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">WEEKLY</span>
                            </div>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="configWeeklyEnabled" checked onchange="toggleReportType('weekly')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="weeklyConfigFields">
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Upload Window</label>
                                <select id="configWeeklyUploadDays" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="Mon-Tue">Monday - Tuesday</option>
                                    <option value="Mon-Wed">Monday - Wednesday</option>
                                    <option value="Tue-Wed">Tuesday - Wednesday</option>
                                </select>
                            </div>
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send Delay (hours)</label>
                                <input type="number" id="configWeeklyDelay" value="2" min="0" max="48" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px;">
                                ðŸ“Œ Sends <strong>previous week</strong> data
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Reports Config -->
                    <div id="monthlyConfigCard" style="background: #E0F1E9; border: 1px solid #62B790; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #62B790; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">MONTHLY</span>
                            </div>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="configMonthlyEnabled" checked onchange="toggleReportType('monthly')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="monthlyConfigFields">
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send On Day</label>
                                <input type="number" id="configMonthlySendDay" value="10" min="1" max="28" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send Time</label>
                                <input type="time" id="configMonthlySendTime" value="09:00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px;">
                                ðŸ“Œ Sends <strong>previous month</strong> data
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yearly Reports Config -->
                    <div id="yearlyConfigCard" style="background: #FFF3E0; border: 1px solid #F57600; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: #F57600; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">YEARLY</span>
                            </div>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="configYearlyEnabled" checked onchange="toggleReportType('yearly')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="yearlyConfigFields">
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send On Date</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="configYearlySendMonth" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="1" selected>January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                    </select>
                                    <input type="number" id="configYearlySendDay" value="15" min="1" max="28" style="width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            <div class="filter-group" style="margin-bottom: 12px;">
                                <label style="font-size: 12px; color: #666;">Send Time</label>
                                <input type="time" id="configYearlySendTime" value="09:00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="font-size: 11px; color: #666; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px;">
                                ðŸ“Œ Sends <strong>previous year</strong> data
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Test Actions -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #E5ECF3;">
                    <h3 style="color: #1A365C; margin: 0 0 15px 0; font-size: 14px;">ðŸ§ª Test & Manual Actions</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn btn-secondary" onclick="testSendSingleReport()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Test Single Report
                        </button>
                        <button class="btn btn-blue" onclick="triggerManualSend('weekly')">
                            Send All Weekly
                        </button>
                        <button class="btn btn-green" onclick="triggerManualSend('monthly')">
                            Send All Monthly
                        </button>
                        <button class="btn btn-primary" onclick="triggerManualSend('yearly')">
                            Send All Yearly
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAutomationSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAutomationConfig()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Test Report Modal -->
    <div class="modal-overlay" id="testReportModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ðŸ§ª Send Test Report</h2>
                <button class="close-modal" onclick="closeTestReportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 13px; color: #333;">
                        <strong>Test Email:</strong> <span id="testReportEmailDisplay">Not set</span>
                    </p>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Search Client</label>
                    <div style="position: relative;">
                        <input type="text" id="testClientSearch" placeholder="Type to search clients..." 
                               oninput="searchTestClients()" onfocus="searchTestClients()"
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <div id="testClientDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    <input type="hidden" id="testClientSelected">
                </div>
                
                <div id="testClientInfo" style="display: none; background: #F9FAFB; border: 1px solid #E5ECF3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1A365C; font-size: 14px;">Selected Client</h4>
                    <p style="margin: 0; font-size: 13px;" id="testClientName">--</p>
                    <p style="margin: 5px 0 0; font-size: 12px; color: #666;" id="testClientEmail">--</p>
                    <p style="margin: 5px 0 0; font-size: 12px; color: #666;" id="testClientSubscription">--</p>
                    
                    <!-- Invoice Preview Section -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #E5ECF3;">
                        <button onclick="previewInvoice()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            ðŸ§¾ Preview Invoice Info
                        </button>
                        <div id="invoicePreviewResult" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Report Type</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="testReportType" value="weekly" checked style="display: none;" onchange="updateReportTypeSelection()">
                            <div class="report-type-option" id="optWeekly" style="padding: 12px; border: 2px solid #2196F3; background: #E3F2FD; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #2196F3;">Weekly</span>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="testReportType" value="monthly" style="display: none;" onchange="updateReportTypeSelection()">
                            <div class="report-type-option" id="optMonthly" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #666;">Monthly</span>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="testReportType" value="yearly" style="display: none;" onchange="updateReportTypeSelection()">
                            <div class="report-type-option" id="optYearly" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #666;">Yearly</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Period Selection -->
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Period to Send</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <div id="testPeriodWeekContainer">
                            <label style="font-size: 12px; color: #666;">Week Number</label>
                            <input type="number" id="testPeriodWeek" min="1" max="52" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div id="testPeriodMonthContainer" style="display: none;">
                            <label style="font-size: 12px; color: #666;">Month</label>
                            <select id="testPeriodMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Year</label>
                            <input type="number" id="testPeriodYear" min="2020" max="2030" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #999; margin-top: 8px;">Leave defaults for previous period, or specify a custom period to test</p>
                </div>
                
                <div id="testReportStatus" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTestReportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendTestReportFromModal()" id="sendTestBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                    Send Test Report
                </button>
            </div>
        </div>
    </div>

    <!-- LTC Import Modal -->
    <div class="modal-overlay" id="ltcImportModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2>ðŸ“¥ Import Client from LTC Intake</h2>
                <button class="close-modal" onclick="closeLTCImportModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
                <div id="ltcLoadingState" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Loading LTC Intake records...</p>
                </div>
                
                <div id="ltcRecordsList" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="ltcSearchInput" placeholder="Search by name, email, or insurance..." 
                               oninput="filterLTCRecords()" 
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div id="ltcRecordsTable" style="overflow-x: auto;">
                        <!-- Records will be populated here -->
                    </div>
                </div>
                
                <div id="ltcNoRecords" style="display: none; text-align: center; padding: 40px;">
                    <p style="color: #666;">No LTC Intake records found.</p>
                </div>
                
                <div id="ltcError" style="display: none; text-align: center; padding: 40px;">
                    <p style="color: #C62828;" id="ltcErrorMessage">Error loading records.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLTCImportModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- LTC Import Confirmation Modal -->
    <div class="modal-overlay" id="ltcConfirmModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Confirm Import</h2>
                <button class="close-modal" onclick="closeLTCConfirmModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="ltcConfirmContent">
                    <!-- Will be populated dynamically -->
                </div>
                
                <div id="ltcDuplicateWarning" style="display: none; background: #FFF3E0; border: 1px solid #F57600; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 style="color: #F57600; margin: 0 0 10px 0;">âš ï¸ Potential Duplicate Found</h4>
                    <div id="ltcDuplicateDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLTCConfirmModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmLTCImport()" id="ltcConfirmBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Import Client
                </button>
                <button class="btn btn-warning" onclick="forceImportLTC()" id="ltcForceImportBtn" style="display: none; background: #F57600;">
                    Import Anyway
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Report Send Modal -->
    <div class="modal-overlay" id="bulkSendModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ðŸ“§ Send Bulk Reports</h2>
                <button class="close-modal" onclick="closeBulkSendModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="bulkSendTestModeNotice" style="display: none; background: #E8F5E9; border: 1px solid #4CAF50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 13px; color: #333;">
                        <strong>ðŸ§ª TEST MODE:</strong> Reports will be sent to <span id="bulkSendTestEmail">test email</span>
                    </p>
                </div>
                
                <div id="bulkSendLiveModeNotice" style="display: none; background: #FFF3E0; border: 1px solid #F57600; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 13px; color: #333;">
                        <strong>âš ï¸ LIVE MODE:</strong> Reports will be sent to actual recipients!
                    </p>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Report Type</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="bulkReportType" value="weekly" checked style="display: none;" onchange="updateBulkReportTypeSelection()">
                            <div class="report-type-option" id="bulkOptWeekly" style="padding: 12px; border: 2px solid #2196F3; background: #E3F2FD; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #2196F3;">Weekly</span>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="bulkReportType" value="monthly" style="display: none;" onchange="updateBulkReportTypeSelection()">
                            <div class="report-type-option" id="bulkOptMonthly" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #666;">Monthly</span>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="bulkReportType" value="yearly" style="display: none;" onchange="updateBulkReportTypeSelection()">
                            <div class="report-type-option" id="bulkOptYearly" style="padding: 12px; border: 2px solid #ddd; background: white; border-radius: 8px; text-align: center;">
                                <span style="font-weight: 600; color: #666;">Yearly</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Period Selection -->
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1A365C;">Period to Send</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                        <div id="bulkPeriodWeekContainer">
                            <label style="font-size: 12px; color: #666;">Week Number</label>
                            <input type="number" id="bulkPeriodWeek" min="1" max="53" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div id="bulkPeriodMonthContainer" style="display: none;">
                            <label style="font-size: 12px; color: #666;">Month</label>
                            <select id="bulkPeriodMonth" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Year</label>
                            <input type="number" id="bulkPeriodYear" min="2020" max="2030" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #999; margin-top: 8px;">Specify the period for reports to be sent</p>
                </div>
                
                <div id="bulkSendStatus" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBulkSendModal()">Cancel</button>
                <button class="btn btn-primary" onclick="executeBulkSend()" id="bulkSendBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                    Send Reports
                </button>
            </div>
        </div>
    </div>


    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby9_bAzLkMv85BLy8OGbTav9hnX4vPp0hiTF-0xzgUo4Bpk2Nh_XkBuJWThpyqq-bpl/exec'; // Replace with your deployed Web App URL
        const ROWS_PER_PAGE = 25;
        const PAGE_SIZE = 20;  // For client pagination
        
        // LTC Import state
        let ltcRecords = [];
        let selectedLTCRecord = null;
        
        // State
        let currentTab = 'report';
        let reportData = [];
        let clientData = [];
        let currentPage = 1;
        let selectedClient = null;
        
        // Sorting state
        let reportSortColumn = null;
        let reportSortDirection = 'asc';
        let clientSortColumn = null;
        let clientSortDirection = 'asc';
        
        // Expected reports state
        let expectedReportData = [];
        let expectedCurrentPage = 1;
        let expectedPeriodType = 'week';
        let expandedClients = new Set();
        let sentStatusMap = new Map(); // Tracks which clients have reports already sent
        
        
        // ============================================
        // JSONP FETCH (No-CORS compatible)
        // ============================================
        // Track active JSONP requests for cleanup
        const activeJsonpRequests = new Map();
        
        function jsonpFetch(params, options = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                
                // Use longer timeout for bulk operations (5 minutes)
                const timeout = options.timeout || (params.action === 'sendBulkReports' ? 300000 : 60000);
                
                const url = new URL(WEBAPP_URL);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                url.searchParams.append('callback', callbackName);
                
                let isCompleted = false;
                let timeoutId = null;
                
                const cleanup = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    activeJsonpRequests.delete(callbackName);
                    // Keep callback defined to prevent "not defined" errors from late responses
                    // but make it a no-op that cleans up the script
                    window[callbackName] = function() {
                        if (script.parentNode) {
                            document.body.removeChild(script);
                        }
                        delete window[callbackName];
                    };
                    // Schedule final cleanup after a delay
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                        }
                    }, 5000);
                };
                
                window[callbackName] = function(data) {
                    if (isCompleted) return; // Ignore if already completed
                    isCompleted = true;
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    if (timeoutId) clearTimeout(timeoutId);
                    activeJsonpRequests.delete(callbackName);
                    delete window[callbackName];
                    resolve(data);
                };
                
                script.onerror = function() {
                    if (isCompleted) return;
                    isCompleted = true;
                    cleanup();
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('JSONP request failed'));
                };
                
                script.src = url.toString();
                document.body.appendChild(script);
                
                // Store reference for potential manual cleanup
                activeJsonpRequests.set(callbackName, { script, cleanup });
                
                timeoutId = setTimeout(() => {
                    if (!isCompleted) {
                        isCompleted = true;
                        cleanup();
                        if (script.parentNode) {
                            document.body.removeChild(script);
                        }
                        reject(new Error('Request timeout - the server may still be processing. Check results later.'));
                    }
                }, timeout);
            });
        }
        
        // ============================================
        // TAB NAVIGATION
        // ============================================
        // Tab handlers are set up in DOMContentLoaded below
        
        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `${tab}-panel`);
            });
            
            if (tab === 'report' && reportData.length === 0) {
                showReportFilterPrompt();  // Show filter prompt instead of loading all data
            } else if (tab === 'client' && clientData.length === 0) {
                loadClientData();
            } else if (tab === 'expected') {
                // Set default week/month to current
                initializeExpectedReportPeriod();
                // Load client data if needed for insurance filter
                if (clientData.length === 0) {
                    loadClientDataForExpected();
                } else {
                    populateExpectedInsuranceFilter();
                }
            }
        }
        
        async function loadClientDataForExpected() {
            try {
                const result = await jsonpFetch({ action: 'getClientList' });
                if (result.success) {
                    clientData = result.data;
                    if (result.config) appConfig = result.config;
                    populateExpectedInsuranceFilter();
                }
            } catch (error) {
                console.error('Failed to load client data for filters:', error);
            }
        }
        
        // ============================================
        // SORTING FUNCTIONS
        // ============================================
        
        function sortData(data, column, direction, columnMappings) {
            return [...data].sort((a, b) => {
                let aVal = a[columnMappings[column]] || '';
                let bVal = b[columnMappings[column]] || '';
                
                // Handle numeric columns
                if (column === 'duration' || column === 'rate' || column === 'total' || column === 'costToCustomer') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (column === 'date') {
                    aVal = new Date(aVal) || new Date(0);
                    bVal = new Date(bVal) || new Date(0);
                } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function handleReportSort(column) {
            if (reportSortColumn === column) {
                reportSortDirection = reportSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                reportSortColumn = column;
                reportSortDirection = 'asc';
            }
            renderReportTable();
        }
        
        function handleClientSort(column) {
            if (clientSortColumn === column) {
                clientSortDirection = clientSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                clientSortColumn = column;
                clientSortDirection = 'asc';
            }
            renderClientTable();
        }
        
        function getSortHeaderClass(currentColumn, sortColumn, sortDirection) {
            if (currentColumn !== sortColumn) return 'sortable-header';
            return `sortable-header sort-${sortDirection}`;
        }
        
        // ============================================
        // REPORT FUNCTIONS
        // ============================================
        
        function showReportFilterPrompt() {
            const container = document.getElementById('reportTableContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    <h3>Apply Filters to View Reports</h3>
                    <p>Use the filters above to search for service reports by client name, date range, status, or time period.</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">This helps load data faster and saves resources.</p>
                </div>
            `;
        }
        
        async function loadReportData(filters = {}) {
            const container = document.getElementById('reportTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading service report...</p>
                </div>
            `;
            
            try {
                const params = { action: 'getServiceReport', ...filters };
                const result = await jsonpFetch(params);
                
                if (result.success) {
                    reportData = result.data;
                    renderReportTable();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <h3>Failed to load service report</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="loadReportData()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function renderReportTable() {
            const container = document.getElementById('reportTableContainer');
            
            if (reportData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <h3>No service records found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }
            
            // Apply sorting if set
            const reportColumnMappings = {
                'customerName': 'Customer Name',
                'date': 'Scheduled Date',
                'startTime': 'STxTime',
                'endTime': 'ETxTime',
                'provider': 'Provider Name',
                'duration': 'Service Duration',
                'rate': '_rate',
                'total': 'Cost To Customer'
            };
            
            let sortedData = [...reportData];
            if (reportSortColumn) {
                // Add calculated rate for sorting
                sortedData = sortedData.map(row => ({
                    ...row,
                    '_rate': ((parseFloat(row['Cost To Customer']) || 0) / ((parseFloat(row['Service Duration']) || 1) / 60))
                }));
                sortedData = sortData(sortedData, reportSortColumn, reportSortDirection, reportColumnMappings);
            }
            
            const totalPages = Math.ceil(sortedData.length / ROWS_PER_PAGE);
            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const pageData = sortedData.slice(start, start + ROWS_PER_PAGE);
            
            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="${getSortHeaderClass('customerName', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('customerName')">Customer Name <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('date', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('date')">Date <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('startTime', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('startTime')">Start Time <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('endTime', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('endTime')">End Time <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('provider', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('provider')">Provider <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('duration', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('duration')">Duration HRS <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('rate', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('rate')">$/Hr <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('total', reportSortColumn, reportSortDirection)}" onclick="handleReportSort('total')">Total $ <span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageData.forEach(row => {
                const duration = parseFloat(row['Service Duration']) || 0;
                const durationHrs = (duration / 60).toFixed(2);
                const costToCustomer = parseFloat(row['Cost To Customer']) || 0;
                const ratePerHour = durationHrs > 0 ? (costToCustomer / durationHrs).toFixed(2) : '0.00';
                
                html += `
                    <tr style="cursor: pointer;" onclick="viewClientFromReport('${escapeHtml(row['Customer Name'])}')">
                        <td><strong>${escapeHtml(row['Customer Name'])}</strong></td>
                        <td>${formatDate(row['Scheduled Date'])}</td>
                        <td>${formatTime(row['STxTime'])}</td>
                        <td>${formatTime(row['ETxTime'])}</td>
                        <td>${escapeHtml(row['Provider Name'] || 'Unassigned')}</td>
                        <td>${durationHrs}</td>
                        <td>$${ratePerHour}</td>
                        <td><strong>$${costToCustomer.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            renderPagination('reportPagination', totalPages, currentPage, (page) => {
                currentPage = page;
                renderReportTable();
            });
        }
        
        function applyFilters() {
            const filters = {};
            
            const clientName = document.getElementById('filterClient').value.trim();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const status = document.getElementById('filterStatus').value;
            const week = document.getElementById('filterWeek').value.trim();
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            
            if (clientName) filters.clientName = clientName;
            if (startDate) filters.startDate = startDate;
            if (endDate) filters.endDate = endDate;
            if (status) filters.status = status;
            if (week) filters.week = week;
            if (month) filters.month = month;
            if (year) filters.year = year;
            
            currentPage = 1;
            loadReportData(filters);
        }
        
        function clearFilters() {
            document.getElementById('filterClient').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterWeek').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            currentPage = 1;
            reportData = [];  // Clear the data
            showReportFilterPrompt();  // Show filter prompt instead of loading all data
        }
        
        // ============================================
        // CLIENT FUNCTIONS
        // ============================================
        let appConfig = { billingEmail: 'billing@alicecare.com' };
        let clientCurrentPage = 1;
        let editingClient = false;
        
        async function loadConfig() {
            try {
                const result = await jsonpFetch({ action: 'getConfig' });
                if (result.success && result.config) {
                    appConfig = result.config;
                    const billingEl = document.getElementById('configBillingEmail');
                    if (billingEl) billingEl.textContent = appConfig.billingEmail;
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }
        
        async function loadClientData() {
            const container = document.getElementById('clientTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading clients...</p>
                </div>
            `;
            
            try {
                const result = await jsonpFetch({ action: 'getClientList' });
                
                if (result.success) {
                    clientData = result.data;
                    if (result.config) appConfig = result.config;
                    updateClientStats();
                    populateInsuranceFilter();
                    renderClientTable();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <h3>Failed to load clients</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="loadClientData()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function updateClientStats() {
            const total = clientData.length;
            const billing = clientData.filter(c => String(c['Assigment_Y1_N0']) === '1').length;
            const insurance = total - billing;
            
            document.getElementById('totalClientsCount').textContent = total;
            document.getElementById('billingAssignedCount').textContent = billing;
            document.getElementById('insuranceAssignedCount').textContent = insurance;
        }
        
        function populateInsuranceFilter() {
            const select = document.getElementById('filterInsurance');
            if (!select) return;
            const insuranceNames = [...new Set(clientData.map(c => c['Insurance_Name']).filter(Boolean))];
            
            select.innerHTML = '<option value="">All Insurance</option>';
            insuranceNames.sort().forEach(name => {
                select.innerHTML += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            });
        }
        
        // ============================================
        // INSURANCE AUTOCOMPLETE FUNCTIONS
        // ============================================
        
        // Get unique insurance companies with their data from client database
        function getInsuranceList() {
            const insuranceMap = new Map();
            
            clientData.forEach(client => {
                const insuranceName = (client['Insurance_Name'] || '').trim();
                if (insuranceName) {
                    if (!insuranceMap.has(insuranceName)) {
                        insuranceMap.set(insuranceName, {
                            name: insuranceName,
                            email: client['eMail_Insurance'] || '',
                            clientCount: 1
                        });
                    } else {
                        const existing = insuranceMap.get(insuranceName);
                        existing.clientCount++;
                        // Keep the first non-empty email found
                        if (!existing.email && client['eMail_Insurance']) {
                            existing.email = client['eMail_Insurance'];
                        }
                    }
                }
            });
            
            return Array.from(insuranceMap.values()).sort((a, b) => 
                a.name.localeCompare(b.name)
            );
        }
        
        function searchInsurance(query) {
            const dropdown = document.getElementById('insuranceDropdown');
            const insuranceList = getInsuranceList();
            
            if (!query || query.length === 0) {
                // Show all insurance companies when focused with empty query
                if (insuranceList.length > 0) {
                    showInsuranceDropdown(insuranceList);
                } else {
                    dropdown.style.display = 'none';
                }
                return;
            }
            
            const searchTerm = query.toLowerCase().trim();
            const filtered = insuranceList.filter(ins => 
                ins.name.toLowerCase().includes(searchTerm)
            );
            
            if (filtered.length > 0) {
                showInsuranceDropdown(filtered);
            } else {
                dropdown.innerHTML = `
                    <div class="autocomplete-item" style="color: #999; cursor: default;">
                        No matching insurance found. You can enter a new one.
                    </div>
                `;
                dropdown.style.display = 'block';
            }
        }
        
        function showInsuranceDropdown(insuranceList) {
            const dropdown = document.getElementById('insuranceDropdown');
            
            dropdown.innerHTML = insuranceList.map(ins => `
                <div class="autocomplete-item" onclick="selectInsurance('${escapeHtml(ins.name)}', '${escapeHtml(ins.email)}')">
                    <div class="insurance-name">${escapeHtml(ins.name)}</div>
                    ${ins.email ? `<div class="insurance-email">${escapeHtml(ins.email)}</div>` : ''}
                    <div class="client-count">${ins.clientCount} client${ins.clientCount > 1 ? 's' : ''} with this insurance</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectInsurance(name, email) {
            document.getElementById('formInsuranceName').value = name;
            document.getElementById('formInsuranceEmail').value = email;
            document.getElementById('insuranceDropdown').style.display = 'none';
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('insuranceDropdown');
            const input = document.getElementById('formInsuranceName');
            if (dropdown && input && !dropdown.contains(e.target) && e.target !== input) {
                dropdown.style.display = 'none';
            }
        });
        
        function getFilteredClientData() {
            let filtered = [...clientData];
            
            const nameFilter = (document.getElementById('filterClientName')?.value || '').toLowerCase().trim();
            const insuranceFilter = document.getElementById('filterInsurance')?.value || '';
            const assignmentFilter = document.getElementById('filterAssignment')?.value || '';
            
            if (nameFilter) {
                filtered = filtered.filter(c => {
                    const fullName = `${c['F_Name'] || ''} ${c['L_Name'] || ''}`.toLowerCase();
                    const email = (c['email'] || '').toLowerCase();
                    const customerName = (c['Customer Name'] || '').toLowerCase();
                    return fullName.includes(nameFilter) || email.includes(nameFilter) || customerName.includes(nameFilter);
                });
            }
            
            if (insuranceFilter) {
                filtered = filtered.filter(c => c['Insurance_Name'] === insuranceFilter);
            }
            
            if (assignmentFilter !== '') {
                filtered = filtered.filter(c => String(c['Assigment_Y1_N0']) === assignmentFilter);
            }
            
            return filtered;
        }
        
        function renderClientTable() {
            const container = document.getElementById('clientTableContainer');
            let filteredData = getFilteredClientData();
            
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <h3>No clients found</h3>
                        <p>Add your first client to get started</p>
                    </div>
                `;
                return;
            }
            
            // Apply sorting if set
            const clientColumnMappings = {
                'customerName': 'Customer Name',
                'email': 'email',
                'phone': 'Phone',
                'insurance': 'Insurance_Name',
                'assignment': 'Assigment_Y1_N0',
                'subscription': 'Subscription'
            };
            
            if (clientSortColumn) {
                filteredData = sortData(filteredData, clientSortColumn, clientSortDirection, clientColumnMappings);
            }
            
            const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
            const start = (clientCurrentPage - 1) * PAGE_SIZE;
            const pageData = filteredData.slice(start, start + PAGE_SIZE);
            
            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="${getSortHeaderClass('customerName', clientSortColumn, clientSortDirection)}" onclick="handleClientSort('customerName')">Customer Name <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('email', clientSortColumn, clientSortDirection)}" onclick="handleClientSort('email')">Email <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('phone', clientSortColumn, clientSortDirection)}" onclick="handleClientSort('phone')">Phone <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('insurance', clientSortColumn, clientSortDirection)}" onclick="handleClientSort('insurance')">Insurance <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('assignment', clientSortColumn, clientSortDirection)}" onclick="handleClientSort('assignment')">Assignment <span class="sort-icon"></span></th>
                                <th class="${getSortHeaderClass('subscription', clientSortColumn, clientSortDirection)}" onclick="handleClientSort('subscription')">Subscription <span class="sort-icon"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageData.forEach(client => {
                const isAssigned = String(client['Assigment_Y1_N0']) === '1';
                const assignmentBadge = isAssigned 
                    ? '<span class="badge" style="background: #F3E5F5; color: #9C27B0;">Assignment Benefits</span>'
                    : '<span class="badge" style="background: #E3F2FD; color: #2196F3;">CC Pay</span>';
                
                const subscription = (client['Subscription'] || '').toLowerCase();
                let subscriptionBadges = [];
                if (subscription.includes('weekly')) {
                    subscriptionBadges.push('<span class="badge" style="background: #E3F2FD; color: #2196F3;">W</span>');
                }
                if (subscription.includes('monthly')) {
                    subscriptionBadges.push('<span class="badge" style="background: #E0F1E9; color: #62B790;">M</span>');
                }
                if (subscription.includes('yearly')) {
                    subscriptionBadges.push('<span class="badge" style="background: #FFF3E0; color: #F57600;">Y</span>');
                }
                const subscriptionBadge = subscriptionBadges.length > 0 
                    ? subscriptionBadges.join(' ') 
                    : '<span class="badge" style="background: #F5F5F5; color: #999;">None</span>';
                
                html += `
                    <tr>
                        <td><strong>${escapeHtml(client['Customer Name'] || '--')}</strong></td>
                        <td>${escapeHtml(client['email'] || '--')}</td>
                        <td>${escapeHtml(client['Phone'] || '--')}</td>
                        <td>${escapeHtml(client['Insurance_Name'] || '--')}</td>
                        <td>${assignmentBadge}</td>
                        <td>${subscriptionBadge}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 6px 14px; font-size: 12px;" 
                                    onclick="openClientDetail('${escapeHtml(client['Customer Name'] || client['email'])}')">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>>
                </div>
            `;
            
            container.innerHTML = html;
            renderPagination('clientPagination', totalPages, clientCurrentPage, (page) => {
                clientCurrentPage = page;
                renderClientTable();
            });
        }
        
        function applyClientFilters() {
            clientCurrentPage = 1;
            renderClientTable();
        }
        
        function clearClientFilters() {
            document.getElementById('filterClientName').value = '';
            document.getElementById('filterInsurance').value = '';
            document.getElementById('filterAssignment').value = '';
            clientCurrentPage = 1;
            renderClientTable();
        }
        
        async function openClientDetail(identifier) {
            if (!identifier) {
                showToast('No client identifier provided', 'error');
                return;
            }
            
            // Show sidebar immediately with loading state
            document.getElementById('sidebarOverlay').classList.add('active');
            document.getElementById('clientSidebar').classList.add('active');
            document.getElementById('detailClientName').textContent = 'Loading...';
            document.getElementById('detailCustomerName').textContent = identifier;
            
            try {
                let clientResult = null;
                
                // First try to find in local cached data for instant display
                const localClient = clientData.find(c => {
                    const customerName = String(c['Customer Name'] || '').toLowerCase().trim();
                    const email = String(c['email'] || '').toLowerCase().trim();
                    const searchId = identifier.toLowerCase().trim();
                    return customerName === searchId || email === searchId || customerName.includes(searchId);
                });
                
                // If found locally, display immediately while fetching fresh data
                if (localClient) {
                    displayClientDetails({ success: true, client: localClient });
                }
                
                // Try all lookup methods in parallel for speed
                const [byNameResult, byEmailResult, byCustomerNameResult] = await Promise.all([
                    jsonpFetch({ action: 'getClientByCustomerName', customerName: identifier }).catch(() => ({ success: false })),
                    jsonpFetch({ action: 'getClientByEmail', email: identifier }).catch(() => ({ success: false })),
                    jsonpFetch({ action: 'getClientByName', name: identifier }).catch(() => ({ success: false }))
                ]);
                
                // Use the first successful result
                clientResult = byNameResult.success ? byNameResult : 
                              (byEmailResult.success ? byEmailResult : 
                              (byCustomerNameResult.success ? byCustomerNameResult : null));
                
                // If server lookup failed but we have local data, use that
                if (!clientResult && localClient) {
                    console.log('Using local client data:', localClient);
                    clientResult = { success: true, client: localClient };
                }
                
                if (!clientResult || !clientResult.success) {
                    showToast('Client not found', 'error');
                    closeClientDetail();
                    return;
                }
                
                // Display the fresh data
                displayClientDetails(clientResult);
                
            } catch (error) {
                showToast('Error loading client details', 'error');
                console.error(error);
                closeClientDetail();
            }
        }
        
        function displayClientDetails(clientResult) {
            selectedClient = clientResult.client;
            console.log('Selected client data:', selectedClient);
            const fullName = `${selectedClient['F_Name'] || ''} ${selectedClient['L_Name'] || ''}`.trim();
            const isAssigned = String(selectedClient['Assigment_Y1_N0']) === '1';
            
            // Update header
            document.getElementById('detailClientName').textContent = fullName || selectedClient['Customer Name'] || 'Unknown Client';
            document.getElementById('detailCustomerName').textContent = selectedClient['Customer Name'] || 'No customer name';
            
            // Update email routing indicator
            const routeIndicator = document.getElementById('emailRouteIndicator');
            if (isAssigned) {
                routeIndicator.style.background = '#F3E5F5';
                routeIndicator.style.borderColor = '#9C27B0';
                routeIndicator.querySelector('svg').style.stroke = '#9C27B0';
            } else {
                routeIndicator.style.background = '#E3F2FD';
                routeIndicator.style.borderColor = '#2196F3';
                routeIndicator.querySelector('svg').style.stroke = '#2196F3';
            }
            document.getElementById('routeType').textContent = isAssigned ? 'Routed to Billing' : 'Routed to Insurance';
            document.getElementById('routeEmail').textContent = isAssigned ? appConfig.billingEmail : (selectedClient['eMail_Insurance'] || 'No email');
            
            // Update contact info
            document.getElementById('sidebarClientEmail').value = selectedClient['email'] || '';
            document.getElementById('detailPhone').textContent = selectedClient['Phone'] || '--';
            document.getElementById('detailAddress').textContent = selectedClient['Address'] || '--';
            
            // Update insurance info
            document.getElementById('detailInsurance').textContent = selectedClient['Insurance_Name'] || '--';
            document.getElementById('sidebarInsuranceEmail').value = selectedClient['eMail_Insurance'] || '';
            document.getElementById('detailPolicy').textContent = selectedClient['Policy'] || '--';
            document.getElementById('detailClaim').textContent = selectedClient['Claim'] || '--';
            document.getElementById('emailSaveStatus').style.display = 'none';
            
            // Update service codes
            const serviceCodes = ['BA', 'DR', 'TR', 'CO', 'TO', 'EA', 'AM', 'CS', 'HM'];
            const codesContainer = document.getElementById('detailServiceCodes');
            codesContainer.innerHTML = serviceCodes.map(code => `
                <div style="background: #F9FAFB; padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-weight: 700; color: #1A365C; font-size: 14px;">${code}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 2px;">${selectedClient[code] || '--'}</div>
                </div>
            `).join('');
            
            // Update service summary from report data
            if (clientResult.reportSummary) {
                const s = clientResult.reportSummary;
                document.getElementById('detailTotalServices').textContent = s.totalServices;
                document.getElementById('detailCompleted').textContent = s.completedServices;
                document.getElementById('detailTotalHours').textContent = `${s.totalHours} hrs`;
                document.getElementById('detailTotalSpent').textContent = `$${s.totalCost}`;
            }
            
            // Update subscription checkboxes
            const subscription = (selectedClient['Subscription'] || '').toLowerCase();
            document.getElementById('sidebarSubWeekly').checked = subscription.includes('weekly');
            document.getElementById('sidebarSubMonthly').checked = subscription.includes('monthly');
            document.getElementById('sidebarSubYearly').checked = subscription.includes('yearly');
            document.getElementById('subscriptionSaveStatus').style.display = 'none';
        }
        
        function closeClientDetail() {
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.getElementById('clientSidebar').classList.remove('active');
            selectedClient = null;
        }
        
        // Show the send report modal
        function sendClientReport() {
            if (!selectedClient || !selectedClient['Customer Name']) {
                showToast('No customer name available', 'error');
                return;
            }
            
            // Populate modal with client info
            document.getElementById('sendReportClientName').textContent = selectedClient['Customer Name'];
            
            // Show destination email
            const isAssigned = String(selectedClient['Assigment_Y1_N0']) === '1';
            const targetEmail = isAssigned ? appConfig.billingEmail : (selectedClient['eMail_Insurance'] || 'No email');
            document.getElementById('sendReportEmail').textContent = targetEmail;
            
            const destBox = document.getElementById('sendReportDestination');
            if (isAssigned) {
                destBox.style.background = '#F3E5F5';
            } else {
                destBox.style.background = '#E3F2FD';
            }
            
            // Reset inputs
            document.getElementById('reportPeriodType').value = 'week';
            document.getElementById('reportWeekNumber').value = '';
            document.getElementById('reportMonth').value = new Date().getMonth() + 1;
            document.getElementById('reportYear').value = new Date().getFullYear();
            toggleReportPeriodInputs();
            
            // Show modal
            document.getElementById('sendReportModal').classList.add('active');
        }
        
        function closeSendReportModal() {
            document.getElementById('sendReportModal').classList.remove('active');
        }
        
        function toggleReportPeriodInputs() {
            const periodType = document.getElementById('reportPeriodType').value;
            document.getElementById('weekInputGroup').style.display = periodType === 'week' ? 'block' : 'none';
            document.getElementById('monthInputGroup').style.display = periodType === 'month' ? 'block' : 'none';
            document.getElementById('yearlyReportNote').style.display = periodType === 'year' ? 'block' : 'none';
        }
        
        async function confirmSendReport() {
            if (!selectedClient || !selectedClient['Customer Name']) {
                showToast('No customer name available', 'error');
                return;
            }
            
            const periodType = document.getElementById('reportPeriodType').value;
            const year = document.getElementById('reportYear').value;
            let periodValue;
            
            if (periodType === 'week') {
                periodValue = document.getElementById('reportWeekNumber').value;
                if (!periodValue || periodValue < 1 || periodValue > 53) {
                    showToast('Please enter a valid week number (1-53)', 'warning');
                    return;
                }
            } else if (periodType === 'month') {
                periodValue = document.getElementById('reportMonth').value;
            } else {
                // Yearly report - periodValue is the year itself
                periodValue = year;
            }
            
            const btn = document.getElementById('confirmSendReportBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Sending...';
            
            // Show loading overlay
            let periodLabel;
            if (periodType === 'week') periodLabel = 'Week ' + periodValue;
            else if (periodType === 'month') periodLabel = 'Month ' + periodValue;
            else periodLabel = 'Year ' + year;
            showLoading('Generating Report', `Creating ${periodLabel} report for ${selectedClient['Customer Name']}...`);
            
            try {
                updateLoadingText('Sending Report', 'Sending email with PDF attachment...');
                
                const result = await jsonpFetch({ 
                    action: 'sendClientInvoice', 
                    customerName: selectedClient['Customer Name'],
                    periodType: periodType,
                    periodValue: periodValue,
                    year: year
                });
                
                hideLoading();
                console.log('Send report result:', result);
                
                if (result.success) {
                    showToast(`Report for ${periodLabel} sent to ${result.sentTo}`, 'success');
                    closeSendReportModal();
                } else {
                    // Log debug info if available
                    if (result.debug) {
                        console.log('Debug info:', result.debug);
                    }
                    throw new Error(result.error || 'Failed to send report');
                }
            } catch (error) {
                hideLoading();
                showToast(error.message, 'error');
                console.error('Send report error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Send Report
                `;
            }
        }
        
        async function viewClientReports() {
            if (!selectedClient || !selectedClient['Customer Name']) {
                showToast('No customer name available', 'error');
                return;
            }
            
            const customerName = selectedClient['Customer Name'];
            closeClientDetail();
            
            // Switch to report tab
            switchTab('report');
            
            // Set the filter value
            document.getElementById('filterClient').value = customerName;
            
            // Load report data with the client filter applied
            await loadReportData({ clientName: customerName });
            
            showToast(`Showing reports for ${customerName}`, 'info');
        }
        
        function editClient() {
            if (!selectedClient) return;
            
            editingClient = true;
            document.getElementById('clientModalTitle').textContent = 'Edit Client';
            
            // Populate form
            document.getElementById('formFName').value = selectedClient['F_Name'] || '';
            document.getElementById('formLName').value = selectedClient['L_Name'] || '';
            document.getElementById('formAddress').value = selectedClient['Address'] || '';
            document.getElementById('formEmail').value = selectedClient['email'] || '';
            document.getElementById('formPhone').value = selectedClient['Phone'] || '';
            document.getElementById('formInsuranceName').value = selectedClient['Insurance_Name'] || '';
            document.getElementById('formInsuranceEmail').value = selectedClient['eMail_Insurance'] || '';
            document.getElementById('formPolicy').value = selectedClient['Policy'] || '';
            document.getElementById('formClaim').value = selectedClient['Claim'] || '';
            document.getElementById('formAssignment').value = String(selectedClient['Assigment_Y1_N0']) || '0';
            document.getElementById('formCustomerName').value = selectedClient['Customer Name'] || '';
            
            // Populate subscription checkboxes
            const subscription = (selectedClient['Subscription'] || '').toLowerCase();
            document.getElementById('formSubWeekly').checked = subscription.includes('weekly');
            document.getElementById('formSubMonthly').checked = subscription.includes('monthly');
            document.getElementById('formSubYearly').checked = subscription.includes('yearly');
            
            // Service codes
            ['BA', 'DR', 'TR', 'CO', 'TO', 'EA', 'AM', 'CS', 'HM'].forEach(code => {
                const el = document.getElementById('form' + code);
                if (el) el.value = selectedClient[code] || '';
            });
            
            closeClientDetail();
            document.getElementById('clientModal').classList.add('active');
        }
        
        async function showAddClientModal() {
            editingClient = false;
            document.getElementById('clientModalTitle').textContent = 'Add New Client';
            document.getElementById('clientForm').reset();
            document.getElementById('formSubWeekly').checked = false;
            document.getElementById('formSubMonthly').checked = false;
            document.getElementById('formSubYearly').checked = false;
            document.getElementById('insuranceDropdown').style.display = 'none';
            
            // Ensure client data is loaded for insurance autocomplete
            if (clientData.length === 0) {
                try {
                    const result = await jsonpFetch({ action: 'getClientList' });
                    if (result.success) {
                        clientData = result.data;
                    }
                } catch (e) {
                    console.log('Could not load client data for autocomplete');
                }
            }
            
            document.getElementById('clientModal').classList.add('active');
        }
        
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            editingClient = false;
        }
        
        function getSubscriptionValue() {
            const subs = [];
            if (document.getElementById('formSubWeekly').checked) subs.push('Weekly');
            if (document.getElementById('formSubMonthly').checked) subs.push('Monthly');
            if (document.getElementById('formSubYearly').checked) subs.push('Yearly');
            return subs.join(',') || 'None';
        }
        
        async function updateSubscription() {
            if (!selectedClient) return;
            const subs = [];
            if (document.getElementById('sidebarSubWeekly').checked) subs.push('Weekly');
            if (document.getElementById('sidebarSubMonthly').checked) subs.push('Monthly');
            if (document.getElementById('sidebarSubYearly').checked) subs.push('Yearly');
            const subscriptionValue = subs.join(',') || 'None';
            try {
                const params = {
                    action: 'updateClient',
                    originalEmail: selectedClient['email'],
                    'Customer Name': selectedClient['Customer Name'],
                    'Subscription': subscriptionValue
                };
                const result = await jsonpFetch(params);
                if (result.success) {
                    selectedClient['Subscription'] = subscriptionValue;
                    const idx = clientData.findIndex(c => c['Customer Name'] === selectedClient['Customer Name']);
                    if (idx !== -1) clientData[idx]['Subscription'] = subscriptionValue;
                    document.getElementById('subscriptionSaveStatus').style.display = 'block';
                    setTimeout(() => { document.getElementById('subscriptionSaveStatus').style.display = 'none'; }, 2000);
                    renderClientTable();
                }
            } catch (error) {
                showToast('Error updating subscription', 'error');
            }
        }
        
        async function updateClientEmail() {
            if (!selectedClient) return;
            const newEmail = document.getElementById('sidebarClientEmail').value.trim();
            const oldEmail = selectedClient['email'] || '';
            const customerName = selectedClient['Customer Name'] || '';
            
            if (!newEmail) { showToast('Please enter a valid email', 'error'); return; }
            if (!customerName && !oldEmail) { showToast('Cannot identify client to update', 'error'); return; }
            
            try {
                const params = {
                    action: 'updateClient',
                    'Customer Name': customerName,
                    'email': newEmail
                };
                // Only include originalEmail if we have one
                if (oldEmail) {
                    params.originalEmail = oldEmail;
                }
                
                console.log('Updating client email with params:', params);
                const result = await jsonpFetch(params);
                console.log('Update result:', result);
                
                if (result.success) {
                    selectedClient['email'] = newEmail;
                    const idx = clientData.findIndex(c => c['Customer Name'] === customerName || c['email'] === oldEmail);
                    if (idx !== -1) clientData[idx]['email'] = newEmail;
                    const statusEl = document.getElementById('emailSaveStatus');
                    statusEl.textContent = 'âœ“ Client email updated';
                    statusEl.style.display = 'block';
                    setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                    renderClientTable();
                    showToast('Client email updated', 'success');
                } else {
                    throw new Error(result.error || 'Failed to update email');
                }
            } catch (error) {
                showToast('Error updating email: ' + error.message, 'error');
                console.error('Update client email error:', error);
            }
        }
        
        async function updateInsuranceEmail() {
            if (!selectedClient) return;
            const newEmail = document.getElementById('sidebarInsuranceEmail').value.trim();
            const customerName = selectedClient['Customer Name'] || '';
            const clientEmail = selectedClient['email'] || '';
            
            if (!customerName && !clientEmail) { showToast('Cannot identify client to update', 'error'); return; }
            
            try {
                const params = {
                    action: 'updateClient',
                    'Customer Name': customerName,
                    'eMail_Insurance': newEmail
                };
                // Only include originalEmail if we have one
                if (clientEmail) {
                    params.originalEmail = clientEmail;
                }
                
                console.log('Updating insurance email with params:', params);
                const result = await jsonpFetch(params);
                console.log('Update result:', result);
                
                if (result.success) {
                    selectedClient['eMail_Insurance'] = newEmail;
                    const idx = clientData.findIndex(c => c['Customer Name'] === customerName);
                    if (idx !== -1) clientData[idx]['eMail_Insurance'] = newEmail;
                    const isAssigned = String(selectedClient['Assigment_Y1_N0']) === '1';
                    if (!isAssigned) document.getElementById('routeEmail').textContent = newEmail || 'No email';
                    const statusEl = document.getElementById('emailSaveStatus');
                    statusEl.textContent = 'âœ“ Insurance email updated';
                    statusEl.style.display = 'block';
                    setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                    renderClientTable();
                    showToast('Insurance email updated', 'success');
                } else {
                    throw new Error(result.error || 'Failed to update insurance email');
                }
            } catch (error) {
                showToast('Error updating email: ' + error.message, 'error');
                console.error('Update insurance email error:', error);
            }
        }
        
        async function saveClient() {
            // Validate required fields
            const firstName = document.getElementById('formFName').value.trim();
            const lastName = document.getElementById('formLName').value.trim();
            const customerName = document.getElementById('formCustomerName').value.trim();
            
            if (!firstName || !lastName) {
                showToast('First Name and Last Name are required', 'error');
                return;
            }
            
            // Auto-generate Customer Name if not provided
            const finalCustomerName = customerName || `${firstName} ${lastName}`;
            
            const btn = document.getElementById('saveClientBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Saving...';
            
            try {
                const params = {
                    action: editingClient ? 'updateClient' : 'addClient',
                    'F_Name': firstName,
                    'L_Name': lastName,
                    'Address': document.getElementById('formAddress').value.trim(),
                    'email': document.getElementById('formEmail').value.trim(),
                    'Phone': document.getElementById('formPhone').value.trim(),
                    'Insurance_Name': document.getElementById('formInsuranceName').value.trim(),
                    'eMail_Insurance': document.getElementById('formInsuranceEmail').value.trim(),
                    'Policy': document.getElementById('formPolicy').value.trim(),
                    'Claim': document.getElementById('formClaim').value.trim(),
                    'Assigment_Y1_N0': document.getElementById('formAssignment').value,
                    'Customer Name': finalCustomerName,
                    'BA': document.getElementById('formBA').value.trim(),
                    'DR': document.getElementById('formDR').value.trim(),
                    'TR': document.getElementById('formTR').value.trim(),
                    'CO': document.getElementById('formCO').value.trim(),
                    'TO': document.getElementById('formTO').value.trim(),
                    'EA': document.getElementById('formEA').value.trim(),
                    'AM': document.getElementById('formAM').value.trim(),
                    'CS': document.getElementById('formCS').value.trim(),
                    'HM': document.getElementById('formHM').value.trim(),
                    'Subscription': getSubscriptionValue()
                };
                
                // For updates, include the original identifier
                if (editingClient && selectedClient) {
                    params.originalEmail = selectedClient['email'] || '';
                    // Also pass original Customer Name in case it changed
                    if (selectedClient['Customer Name']) {
                        params.originalCustomerName = selectedClient['Customer Name'];
                    }
                }
                
                console.log('Saving client with params:', params);
                const result = await jsonpFetch(params);
                console.log('Save result:', result);
                
                if (result.success) {
                    showToast(editingClient ? 'Client updated successfully' : 'Client added successfully', 'success');
                    closeClientModal();
                    loadClientData();
                } else {
                    throw new Error(result.error || 'Failed to save client');
                }
            } catch (error) {
                showToast(error.message, 'error');
                console.error('Save client error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Client';
            }
        }
        
        function viewClientFromReport(clientName) {
            openClientDetail(clientName);
        }
        
        // ============================================
        // AUTOMATION CONFIGURATION FUNCTIONS
        // ============================================
        
        const DEFAULT_AUTOMATION_CONFIG = {
            pauseAll: false,
            testMode: false,
            testEmail: '',
            weekly: {
                enabled: true,
                uploadDays: 'Mon-Tue',
                delayHours: 2
            },
            monthly: {
                enabled: true,
                sendDay: 10,
                sendTime: '09:00'
            },
            yearly: {
                enabled: true,
                sendMonth: 1,
                sendDay: 15,
                sendTime: '09:00'
            }
        };
        
        function openAutomationSettings() {
            loadAutomationConfig();
            document.getElementById('automationModal').classList.add('active');
        }
        
        function closeAutomationSettings() {
            document.getElementById('automationModal').classList.remove('active');
        }
        
        function loadAutomationConfig() {
            const saved = localStorage.getItem('aliceCareAutomationConfig');
            const config = saved ? JSON.parse(saved) : DEFAULT_AUTOMATION_CONFIG;
            
            // Global controls
            document.getElementById('configPauseAll').checked = config.pauseAll || false;
            document.getElementById('pauseAllLabel').textContent = config.pauseAll ? 'Paused' : 'Active';
            document.getElementById('configTestMode').checked = config.testMode || false;
            document.getElementById('testModeLabel').textContent = config.testMode ? 'On' : 'Off';
            document.getElementById('configTestEmail').value = config.testEmail || '';
            document.getElementById('testEmailContainer').style.display = config.testMode ? 'block' : 'none';
            
            // Weekly
            document.getElementById('configWeeklyEnabled').checked = config.weekly?.enabled !== false;
            document.getElementById('configWeeklyUploadDays').value = config.weekly?.uploadDays || 'Mon-Tue';
            document.getElementById('configWeeklyDelay').value = config.weekly?.delayHours || 2;
            toggleReportType('weekly', false);
            
            // Monthly
            document.getElementById('configMonthlyEnabled').checked = config.monthly?.enabled !== false;
            document.getElementById('configMonthlySendDay').value = config.monthly?.sendDay || 10;
            document.getElementById('configMonthlySendTime').value = config.monthly?.sendTime || '09:00';
            toggleReportType('monthly', false);
            
            // Yearly
            document.getElementById('configYearlyEnabled').checked = config.yearly?.enabled !== false;
            document.getElementById('configYearlySendMonth').value = config.yearly?.sendMonth || 1;
            document.getElementById('configYearlySendDay').value = config.yearly?.sendDay || 15;
            document.getElementById('configYearlySendTime').value = config.yearly?.sendTime || '09:00';
            toggleReportType('yearly', false);
            
            // Update dashboard status
            updateDashboardStatus(config);
        }
        
        function updateDashboardStatus(config) {
            const content = document.getElementById('automationStatusContent');
            if (!content) return;
            
            const weeklyStatus = config.pauseAll ? 'paused' : (config.weekly?.enabled !== false ? 'active' : 'disabled');
            const monthlyStatus = config.pauseAll ? 'paused' : (config.monthly?.enabled !== false ? 'active' : 'disabled');
            const yearlyStatus = config.pauseAll ? 'paused' : (config.yearly?.enabled !== false ? 'active' : 'disabled');
            
            const getStatusBadge = (status) => {
                if (status === 'active') return '<span style="background: #62B790; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Active</span>';
                if (status === 'paused') return '<span style="background: #F57600; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Paused</span>';
                return '<span style="background: #999; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">Disabled</span>';
            };
            
            content.innerHTML = `
                <div style="text-align: center; padding: 15px; background: #E3F2FD; border-radius: 8px;">
                    <div style="font-weight: 600; color: #2196F3; margin-bottom: 5px;">Weekly</div>
                    ${getStatusBadge(weeklyStatus)}
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">${config.weekly?.delayHours || 2}h delay</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #E0F1E9; border-radius: 8px;">
                    <div style="font-weight: 600; color: #62B790; margin-bottom: 5px;">Monthly</div>
                    ${getStatusBadge(monthlyStatus)}
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">Day ${config.monthly?.sendDay || 10}</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #FFF3E0; border-radius: 8px;">
                    <div style="font-weight: 600; color: #F57600; margin-bottom: 5px;">Yearly</div>
                    ${getStatusBadge(yearlyStatus)}
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">Jan ${config.yearly?.sendDay || 15}</div>
                </div>
            `;
            
            // Show test mode indicator if enabled
            if (config.testMode) {
                content.innerHTML += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 10px; background: #E8F5E9; border-radius: 8px; margin-top: 10px;">
                        ðŸ§ª <strong>Test Mode Active</strong> - Reports will be sent to: ${config.testEmail || 'Not set'}
                    </div>
                `;
            }
        }
        
        function togglePauseAll() {
            const paused = document.getElementById('configPauseAll').checked;
            document.getElementById('pauseAllLabel').textContent = paused ? 'Paused' : 'Active';
        }
        
        function toggleTestMode() {
            const testMode = document.getElementById('configTestMode').checked;
            document.getElementById('testModeLabel').textContent = testMode ? 'On' : 'Off';
            document.getElementById('testEmailContainer').style.display = testMode ? 'block' : 'none';
        }
        
        function toggleReportType(type, showToastMsg = true) {
            const enabled = document.getElementById(`config${type.charAt(0).toUpperCase() + type.slice(1)}Enabled`).checked;
            const card = document.getElementById(`${type}ConfigCard`);
            const fields = document.getElementById(`${type}ConfigFields`);
            
            if (enabled) {
                card.style.opacity = '1';
                fields.style.pointerEvents = 'auto';
            } else {
                card.style.opacity = '0.5';
                fields.style.pointerEvents = 'none';
            }
        }
        
        async function saveAutomationConfig() {
            const config = {
                pauseAll: document.getElementById('configPauseAll').checked,
                testMode: document.getElementById('configTestMode').checked,
                testEmail: document.getElementById('configTestEmail').value.trim(),
                weekly: {
                    enabled: document.getElementById('configWeeklyEnabled').checked,
                    uploadDays: document.getElementById('configWeeklyUploadDays').value,
                    delayHours: parseInt(document.getElementById('configWeeklyDelay').value) || 2
                },
                monthly: {
                    enabled: document.getElementById('configMonthlyEnabled').checked,
                    sendDay: parseInt(document.getElementById('configMonthlySendDay').value) || 10,
                    sendTime: document.getElementById('configMonthlySendTime').value || '09:00'
                },
                yearly: {
                    enabled: document.getElementById('configYearlyEnabled').checked,
                    sendMonth: parseInt(document.getElementById('configYearlySendMonth').value) || 1,
                    sendDay: parseInt(document.getElementById('configYearlySendDay').value) || 15,
                    sendTime: document.getElementById('configYearlySendTime').value || '09:00'
                }
            };
            
            // Validate test email if test mode is on
            if (config.testMode && !config.testEmail) {
                showToast('Please enter a test email address', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('aliceCareAutomationConfig', JSON.stringify(config));
            
            // Update dashboard display
            updateDashboardStatus(config);
            
            // Save to backend
            try {
                const result = await jsonpFetch({ 
                    action: 'saveAutomationConfig', 
                    config: JSON.stringify(config)
                });
                
                if (result.success) {
                    showToast('Automation configuration saved!', 'success');
                    closeAutomationSettings();
                } else {
                    showToast('Saved locally. Backend save failed: ' + (result.error || 'Unknown error'), 'warning');
                }
            } catch (error) {
                showToast('Saved locally. Could not sync with server.', 'warning');
            }
        }
        
        async function testSendSingleReport() {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            
            if (!config.testMode || !config.testEmail) {
                showToast('Please enable Test Mode and enter a test email first', 'warning');
                return;
            }
            
            // Load client data if not already loaded
            if (clientData.length === 0) {
                showToast('Loading client data...', 'info');
                await loadClientData();
            }
            
            // Update modal with test email
            document.getElementById('testReportEmailDisplay').textContent = config.testEmail;
            document.getElementById('testClientSearch').value = '';
            document.getElementById('testClientSelected').value = '';
            document.getElementById('testClientInfo').style.display = 'none';
            document.getElementById('testReportStatus').style.display = 'none';
            document.getElementById('testClientDropdown').style.display = 'none';
            
            // Reset report type selection
            document.querySelector('input[name="testReportType"][value="weekly"]').checked = true;
            updateReportTypeSelection();
            
            // Set default period values (previous week/month/year)
            const now = new Date();
            const currentWeek = getWeekNumber(now);
            const previousWeek = currentWeek === 1 ? 52 : currentWeek - 1;
            const previousMonth = now.getMonth() === 0 ? 12 : now.getMonth();
            const weekYear = currentWeek === 1 ? now.getFullYear() - 1 : now.getFullYear();
            const monthYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
            
            document.getElementById('testPeriodWeek').value = previousWeek;
            document.getElementById('testPeriodMonth').value = previousMonth;
            document.getElementById('testPeriodYear').value = weekYear;
            
            // Show modal
            document.getElementById('testReportModal').classList.add('active');
        }
        
        function updateReportTypeSelection() {
            const selected = document.querySelector('input[name="testReportType"]:checked')?.value || 'weekly';
            
            // Update visual styling
            ['weekly', 'monthly', 'yearly'].forEach(type => {
                const opt = document.getElementById('opt' + type.charAt(0).toUpperCase() + type.slice(1));
                if (opt) {
                    if (type === selected) {
                        opt.style.borderColor = '#2196F3';
                        opt.style.background = '#E3F2FD';
                        opt.querySelector('span').style.color = '#2196F3';
                    } else {
                        opt.style.borderColor = '#ddd';
                        opt.style.background = 'white';
                        opt.querySelector('span').style.color = '#666';
                    }
                }
            });
            
            // Show/hide period selectors
            document.getElementById('testPeriodWeekContainer').style.display = selected === 'weekly' ? 'block' : 'none';
            document.getElementById('testPeriodMonthContainer').style.display = selected === 'monthly' ? 'block' : 'none';
            
            // Update year based on selection
            const now = new Date();
            if (selected === 'weekly') {
                const currentWeek = getWeekNumber(now);
                document.getElementById('testPeriodYear').value = currentWeek === 1 ? now.getFullYear() - 1 : now.getFullYear();
            } else if (selected === 'monthly') {
                document.getElementById('testPeriodYear').value = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
            } else {
                document.getElementById('testPeriodYear').value = now.getFullYear() - 1;
            }
        }
        
        function closeTestReportModal() {
            document.getElementById('testReportModal').classList.remove('active');
        }
        
        function searchTestClients() {
            const query = document.getElementById('testClientSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('testClientDropdown');
            
            if (!query || query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = clientData.filter(client => {
                const name = (client['Customer Name'] || '').toLowerCase();
                const email = (client['email'] || '').toLowerCase();
                return name.includes(query) || email.includes(query);
            }).slice(0, 10);
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color: #999;">No matching clients found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = matches.map(client => {
                const name = client['Customer Name'] || 'Unknown';
                const email = client['email'] || 'No email';
                const subscription = client['Subscription'] || 'No subscription';
                return `
                    <div class="autocomplete-item" onclick="selectTestClient('${escapeHtml(name)}')">
                        <div class="client-name" style="font-weight: 600;">${escapeHtml(name)}</div>
                        <div style="font-size: 11px; color: #666;">${escapeHtml(email)}</div>
                        <div style="font-size: 10px; color: #999;">Subscription: ${escapeHtml(subscription)}</div>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectTestClient(customerName) {
            const client = clientData.find(c => c['Customer Name'] === customerName);
            if (!client) return;
            
            document.getElementById('testClientSearch').value = customerName;
            document.getElementById('testClientSelected').value = customerName;
            document.getElementById('testClientDropdown').style.display = 'none';
            
            // Show client info
            document.getElementById('testClientName').textContent = customerName;
            document.getElementById('testClientEmail').textContent = 'Email: ' + (client['email'] || 'Not set');
            document.getElementById('testClientSubscription').textContent = 'Subscription: ' + (client['Subscription'] || 'None');
            document.getElementById('testClientInfo').style.display = 'block';
            
            // Reset invoice preview
            document.getElementById('invoicePreviewResult').style.display = 'none';
        }
        
        // Preview Invoice Info for selected client
        async function previewInvoice() {
            const customerName = document.getElementById('testClientSelected').value;
            
            if (!customerName) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const resultDiv = document.getElementById('invoicePreviewResult');
            resultDiv.innerHTML = '<div style="color: #666; font-size: 12px;"><span class="spinner" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></span> Loading invoice info...</div>';
            resultDiv.style.display = 'block';
            
            try {
                const result = await jsonpFetch({
                    action: 'previewInvoice',
                    customerName: customerName
                });
                
                if (result.success) {
                    const info = result.invoiceInfo;
                    
                    let html = '<div style="background: white; border: 1px solid #E5ECF3; border-radius: 6px; padding: 12px; font-size: 12px;">';
                    html += '<div style="font-weight: 600; color: #1A365C; margin-bottom: 10px;">ðŸ“‹ Invoice Preview</div>';
                    
                    // AOB Status
                    html += `<div style="margin-bottom: 8px;">
                        <span style="color: #666;">Assignment of Benefits:</span> 
                        <span style="font-weight: 600; color: ${info.isAOB ? '#059669' : '#666'};">${info.isAOB ? 'âœ“ Yes' : 'âœ— No'}</span>
                    </div>`;
                    
                    // Insurance
                    html += `<div style="margin-bottom: 8px;">
                        <span style="color: #666;">Insurance:</span> 
                        <span style="font-weight: 600;">${info.insuranceName || 'N/A'}</span>
                        ${info.isExempt ? '<span style="background: #FEE2E2; color: #991B1B; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px;">EXEMPT</span>' : ''}
                    </div>`;
                    
                    // Invoice Number
                    if (info.willGetInvoice) {
                        html += `<div style="background: #FFF7ED; border: 1px solid #F57600; border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <div style="color: #F57600; font-weight: 600;">ðŸ§¾ Invoice Number: #${info.nextInvoiceNumber}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">This client WILL receive an invoice number on their next report.</div>
                        </div>`;
                    } else {
                        html += `<div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 10px; margin-top: 10px;">
                            <div style="color: #666; font-weight: 600;">No Invoice Number</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${!info.isAOB ? 'Reason: Not an Assignment of Benefits client' : ''}
                                ${info.isAOB && info.isExempt ? 'Reason: Insurance is in exemption list' : ''}
                            </div>
                        </div>`;
                    }
                    
                    // Email Routing
                    html += `<div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #E5ECF3;">
                        <div style="font-weight: 600; color: #1A365C; margin-bottom: 6px;">ðŸ“§ Email Routing</div>
                        <div style="font-size: 11px; color: #666;">
                            <div><strong>TO:</strong> ${info.emailTo || 'Insurance email'}</div>
                            <div><strong>BCC:</strong> ${info.emailBcc || 'Client email'}</div>
                        </div>
                    </div>`;
                    
                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div style="color: #DC2626; font-size: 12px;">âŒ Error: ${result.error || 'Failed to load invoice info'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div style="color: #DC2626; font-size: 12px;">âŒ Error: ${e.message}</div>`;
            }
        }
        
        async function sendTestReportFromModal() {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            const customerName = document.getElementById('testClientSelected').value;
            const reportType = document.querySelector('input[name="testReportType"]:checked')?.value || 'weekly';
            const statusDiv = document.getElementById('testReportStatus');
            const sendBtn = document.getElementById('sendTestBtn');
            
            if (!customerName) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            // Get period values
            let periodValue, year;
            if (reportType === 'weekly') {
                periodValue = parseInt(document.getElementById('testPeriodWeek').value) || 1;
            } else if (reportType === 'monthly') {
                periodValue = parseInt(document.getElementById('testPeriodMonth').value) || 1;
            } else {
                periodValue = null; // yearly doesn't need periodValue
            }
            year = parseInt(document.getElementById('testPeriodYear').value) || new Date().getFullYear();
            
            // Show sending status
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#E3F2FD';
            statusDiv.style.border = '1px solid #2196F3';
            statusDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;"><div class="spinner" style="width: 20px; height: 20px;"></div><span>Sending test report...</span></div>';
            sendBtn.disabled = true;
            
            try {
                const params = {
                    action: 'sendTestReport',
                    customerName: customerName,
                    reportType: reportType,
                    testEmail: config.testEmail,
                    year: year
                };
                
                if (periodValue !== null) {
                    params.periodValue = periodValue;
                }
                
                const result = await jsonpFetch(params);
                
                if (result.success) {
                    statusDiv.style.background = '#E8F5E9';
                    statusDiv.style.border = '1px solid #4CAF50';
                    statusDiv.innerHTML = `
                        <div style="color: #2E7D32;">
                            <strong>âœ“ Test report sent successfully!</strong>
                            <p style="margin: 5px 0 0; font-size: 12px;">Sent to: ${config.testEmail}</p>
                            <p style="margin: 5px 0 0; font-size: 12px;">Original recipients would be: ${result.originalRecipients || 'N/A'}</p>
                        </div>
                    `;
                    showToast('Test report sent!', 'success');
                } else {
                    statusDiv.style.background = '#FFEBEE';
                    statusDiv.style.border = '1px solid #EF5350';
                    statusDiv.innerHTML = `
                        <div style="color: #C62828;">
                            <strong>âœ— Failed to send test report</strong>
                            <p style="margin: 5px 0 0; font-size: 12px;">${result.error || 'Unknown error'}</p>
                        </div>
                    `;
                    showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                statusDiv.style.background = '#FFEBEE';
                statusDiv.style.border = '1px solid #EF5350';
                statusDiv.innerHTML = `
                    <div style="color: #C62828;">
                        <strong>âœ— Error sending test report</strong>
                        <p style="margin: 5px 0 0; font-size: 12px;">${error.message}</p>
                    </div>
                `;
                showToast('Error: ' + error.message, 'error');
            }
            
            sendBtn.disabled = false;
        }
        
        // Add click listener to close test client dropdown
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('testClientDropdown');
            const search = document.getElementById('testClientSearch');
            if (dropdown && !dropdown.contains(e.target) && e.target !== search) {
                dropdown.style.display = 'none';
            }
        });
        
        // ============================================
        // BULK SEND MODAL FUNCTIONS
        // ============================================
        
        function triggerManualSend(type) {
            openBulkSendModal(type);
        }
        
        function openBulkSendModal(reportType = 'weekly') {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            
            // Set the report type
            document.querySelector(`input[name="bulkReportType"][value="${reportType}"]`).checked = true;
            updateBulkReportTypeSelection();
            
            // Show test/live mode notice
            if (config.testMode) {
                document.getElementById('bulkSendTestModeNotice').style.display = 'block';
                document.getElementById('bulkSendLiveModeNotice').style.display = 'none';
                document.getElementById('bulkSendTestEmail').textContent = config.testEmail || 'test email';
            } else {
                document.getElementById('bulkSendTestModeNotice').style.display = 'none';
                document.getElementById('bulkSendLiveModeNotice').style.display = 'block';
            }
            
            // Set default period values based on report type
            setDefaultBulkPeriod(reportType);
            
            // Reset status
            document.getElementById('bulkSendStatus').style.display = 'none';
            document.getElementById('bulkSendBtn').disabled = false;
            
            // Show modal
            document.getElementById('bulkSendModal').classList.add('active');
        }
        
        function closeBulkSendModal() {
            document.getElementById('bulkSendModal').classList.remove('active');
        }
        
        function setDefaultBulkPeriod(reportType) {
            const now = new Date();
            
            if (reportType === 'weekly') {
                const currentWeek = getWeekNumber(now);
                const previousWeek = currentWeek === 1 ? 52 : currentWeek - 1;
                const weekYear = currentWeek === 1 ? now.getFullYear() - 1 : now.getFullYear();
                document.getElementById('bulkPeriodWeek').value = previousWeek;
                document.getElementById('bulkPeriodYear').value = weekYear;
            } else if (reportType === 'monthly') {
                const previousMonth = now.getMonth() === 0 ? 12 : now.getMonth();
                const monthYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                document.getElementById('bulkPeriodMonth').value = previousMonth;
                document.getElementById('bulkPeriodYear').value = monthYear;
            } else {
                document.getElementById('bulkPeriodYear').value = now.getFullYear() - 1;
            }
        }
        
        function updateBulkReportTypeSelection() {
            const selected = document.querySelector('input[name="bulkReportType"]:checked')?.value || 'weekly';
            
            // Update visual styling
            ['weekly', 'monthly', 'yearly'].forEach(type => {
                const opt = document.getElementById('bulkOpt' + type.charAt(0).toUpperCase() + type.slice(1));
                if (opt) {
                    if (type === selected) {
                        opt.style.borderColor = '#2196F3';
                        opt.style.background = '#E3F2FD';
                        opt.querySelector('span').style.color = '#2196F3';
                    } else {
                        opt.style.borderColor = '#ddd';
                        opt.style.background = 'white';
                        opt.querySelector('span').style.color = '#666';
                    }
                }
            });
            
            // Show/hide period selectors
            document.getElementById('bulkPeriodWeekContainer').style.display = selected === 'weekly' ? 'block' : 'none';
            document.getElementById('bulkPeriodMonthContainer').style.display = selected === 'monthly' ? 'block' : 'none';
            
            // Set default period values
            setDefaultBulkPeriod(selected);
        }
        
        async function executeBulkSend(forceSend = false) {
            const config = JSON.parse(localStorage.getItem('aliceCareAutomationConfig') || '{}');
            const reportType = document.querySelector('input[name="bulkReportType"]:checked')?.value || 'weekly';
            const statusDiv = document.getElementById('bulkSendStatus');
            const sendBtn = document.getElementById('bulkSendBtn');
            
            // Get period values
            let periodValue, year;
            if (reportType === 'weekly') {
                periodValue = parseInt(document.getElementById('bulkPeriodWeek').value);
                if (!periodValue || periodValue < 1 || periodValue > 53) {
                    showToast('Please enter a valid week number (1-53)', 'warning');
                    return;
                }
            } else if (reportType === 'monthly') {
                periodValue = parseInt(document.getElementById('bulkPeriodMonth').value);
            } else {
                periodValue = null;
            }
            year = parseInt(document.getElementById('bulkPeriodYear').value);
            
            if (!year || year < 2020 || year > 2030) {
                showToast('Please enter a valid year', 'warning');
                return;
            }
            
            // Confirm with user
            const periodLabel = reportType === 'weekly' ? `Week ${periodValue}` : 
                               reportType === 'monthly' ? `${getMonthName(periodValue)}` : 'Year';
            let confirmMsg = `Send all ${reportType} reports for ${periodLabel} ${year}?`;
            if (config.testMode) {
                confirmMsg += `\n\nðŸ§ª TEST MODE: Reports will go to ${config.testEmail}`;
            } else {
                confirmMsg += `\n\nâš ï¸ Reports will be sent to actual recipients!`;
            }
            if (forceSend) {
                confirmMsg += `\n\nâš ï¸ FORCE SEND: This will resend to ALL clients, including those who already received this report!`;
            }
            
            if (!confirm(confirmMsg)) return;
            
            // Disable button and show initial status
            sendBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#E3F2FD';
            statusDiv.style.border = '1px solid #2196F3';
            
            // Use batched processing for reliability
            await executeBulkSendBatched(reportType, periodValue, year, forceSend, config, statusDiv, sendBtn, periodLabel);
        }
        
        async function executeBulkSendBatched(reportType, periodValue, year, forceSend, config, statusDiv, sendBtn, periodLabel) {
            const BATCH_SIZE = 3; // REDUCED: Process 3 clients at a time for reliability
            const MAX_RETRIES = 3; // Retry failed batches up to 3 times
            const RETRY_DELAY_BASE = 2000; // Start with 2 second delay, doubles each retry
            
            let batchOffset = 0;
            let totalSent = 0;
            let totalSkipped = 0;
            let totalErrors = [];
            let allSkipped = [];
            let totalClients = 0;
            let processedClients = 0;
            let isFirstBatch = true;
            let consecutiveFailures = 0;
            
            const updateProgress = (current, total, message, retryInfo = '') => {
                const percent = total > 0 ? Math.round((current / total) * 100) : 0;
                statusDiv.innerHTML = `
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div class="spinner" style="width: 20px; height: 20px;"></div>
                            <span style="font-weight: 600;">Sending ${reportType} reports...</span>
                        </div>
                        <div style="background: #E5ECF3; border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                            <div style="background: #2196F3; height: 100%; width: ${percent}%; transition: width 0.3s;"></div>
                        </div>
                        <p style="margin: 0; font-size: 12px; color: #666;">
                            ${message} (${current}/${total} clients - ${percent}%)
                        </p>
                        <p style="margin: 5px 0 0; font-size: 11px; color: #999;">
                            âœ“ ${totalSent} sent | â­ ${totalSkipped} skipped | âœ— ${totalErrors.length} errors
                        </p>
                        ${retryInfo ? `<p style="margin: 5px 0 0; font-size: 11px; color: #F57600;">${retryInfo}</p>` : ''}
                    </div>
                `;
            };
            
            // Helper function to execute a batch with retry logic
            async function executeBatchWithRetry(params, retryCount = 0) {
                try {
                    // Use longer timeout for optimized batch (90 seconds)
                    const result = await jsonpFetch(params, { timeout: 90000 });
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Batch processing failed');
                    }
                    
                    return result;
                } catch (error) {
                    if (retryCount < MAX_RETRIES) {
                        const delay = RETRY_DELAY_BASE * Math.pow(2, retryCount);
                        updateProgress(processedClients, totalClients, 
                            `Batch failed, retrying in ${delay/1000}s...`,
                            `Retry ${retryCount + 1}/${MAX_RETRIES}: ${error.message}`);
                        
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return executeBatchWithRetry(params, retryCount + 1);
                    }
                    throw error;
                }
            }
            
            try {
                // Process in batches using OPTIMIZED endpoint
                while (true) {
                    const params = {
                        action: 'sendBulkReportsBatchOptimized', // Use optimized version
                        reportType: reportType,
                        testMode: config.testMode ? 'true' : 'false',
                        testEmail: config.testEmail || '',
                        forceSend: forceSend ? 'true' : 'false',
                        year: year.toString(),
                        batchSize: BATCH_SIZE.toString(),
                        batchOffset: batchOffset.toString()
                    };
                    
                    if (periodValue !== null) {
                        params.periodValue = periodValue.toString();
                    }
                    
                    if (isFirstBatch) {
                        updateProgress(0, 0, 'Starting...');
                    }
                    
                    const result = await executeBatchWithRetry(params);
                    consecutiveFailures = 0; // Reset on success
                    
                    // Update totals
                    if (isFirstBatch) {
                        totalClients = result.totalClients || 0;
                        isFirstBatch = false;
                    }
                    
                    totalSent += result.sentCount || 0;
                    totalSkipped += result.skippedCount || 0;
                    if (result.errors) totalErrors = totalErrors.concat(result.errors);
                    if (result.skipped) allSkipped = allSkipped.concat(result.skipped);
                    
                    processedClients = result.processedSoFar || (batchOffset + (result.batchProcessed || 0));
                    
                    // Show execution time if available
                    const execTime = result.executionTimeMs ? ` (${(result.executionTimeMs/1000).toFixed(1)}s)` : '';
                    updateProgress(processedClients, totalClients, `Processing batch ${Math.ceil(processedClients / BATCH_SIZE)}${execTime}...`);
                    
                    // Check if we're done
                    if (result.isComplete || processedClients >= totalClients) {
                        break;
                    }
                    
                    // Move to next batch
                    batchOffset = processedClients;
                    
                    // Delay between batches to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // All batches complete - show final results
                let message = `${totalSent} report(s) sent`;
                if (totalSkipped > 0) {
                    message += `, ${totalSkipped} skipped`;
                }
                if (totalErrors.length > 0) {
                    message += `, ${totalErrors.length} error(s)`;
                }
                
                statusDiv.style.background = '#E8F5E9';
                statusDiv.style.border = '1px solid #4CAF50';
                statusDiv.innerHTML = `
                    <div style="color: #2E7D32;">
                        <strong>âœ“ ${message}</strong>
                        <p style="margin: 5px 0 0; font-size: 12px;">
                            Period: ${periodLabel} ${year}
                            ${config.testMode ? ' (Test Mode)' : ''}
                        </p>
                    </div>
                `;
                
                showToast(message, totalSent > 0 ? 'success' : 'warning');
                
                // If skipped and not forcing, show option to force
                if (totalSkipped > 0 && !forceSend) {
                    statusDiv.innerHTML += `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #C8E6C9;">
                            <p style="margin: 0 0 10px; font-size: 13px; color: #666;">
                                ${totalSkipped} report(s) were skipped because they were already sent.
                            </p>
                            <button class="btn btn-secondary" onclick="showBulkSkippedDetails()" style="font-size: 12px; margin-right: 10px;">
                                View Skipped
                            </button>
                            <button class="btn btn-primary" onclick="executeBulkSend(true)" style="font-size: 12px; background: #F57600;">
                                Force Resend All
                            </button>
                        </div>
                    `;
                    // Store skipped info for later
                    window.lastBulkResult = {
                        skipped: allSkipped,
                        skippedCount: totalSkipped,
                        period: { type: reportType, value: periodValue, year: year }
                    };
                }
                
                // Show errors if any
                if (totalErrors.length > 0) {
                    statusDiv.innerHTML += `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #C8E6C9;">
                            <p style="margin: 0 0 10px; font-size: 13px; color: #C62828;">
                                <strong>${totalErrors.length} error(s) occurred:</strong>
                            </p>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 11px; color: #666; background: #FFF5F5; padding: 8px; border-radius: 4px;">
                                ${totalErrors.slice(0, 10).map(e => `<div>â€¢ ${escapeHtml(e)}</div>`).join('')}
                                ${totalErrors.length > 10 ? `<div>...and ${totalErrors.length - 10} more</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                sendBtn.disabled = false;
                
            } catch (error) {
                statusDiv.style.background = '#FFEBEE';
                statusDiv.style.border = '1px solid #EF5350';
                statusDiv.innerHTML = `
                    <div style="color: #C62828;">
                        <strong>âœ— Error sending reports</strong>
                        <p style="margin: 5px 0 0; font-size: 12px;">${error.message}</p>
                        ${totalSent > 0 ? `<p style="margin: 5px 0 0; font-size: 12px; color: #666;">Progress before error: ${totalSent} sent, ${totalSkipped} skipped</p>` : ''}
                    </div>
                `;
                showToast('Error: ' + error.message, 'error');
                sendBtn.disabled = false;
            }
        }
        
        function showBulkSkippedDetails() {
            const result = window.lastBulkResult;
            if (!result || !result.skipped) return;
            
            const reportType = document.querySelector('input[name="bulkReportType"]:checked')?.value || 'weekly';
            showSkippedReportsModal(result, reportType);
        }
        
        // Legacy function - now opens modal instead
        async function sendBulkReports(reportType, forceSend = false) {
            // Open the modal with the specified report type
            openBulkSendModal(reportType);
        }
        
        function showSkippedReportsModal(result, reportType) {
            // Remove existing modal if any
            const existingModal = document.getElementById('skippedReportsModal');
            if (existingModal) existingModal.remove();
            
            const skippedList = result.skipped || [];
            const periodInfo = result.period || {};
            
            let skippedHtml = '';
            skippedList.forEach(item => {
                const sentDate = item.sentOn ? new Date(item.sentOn).toLocaleString() : 'Unknown date';
                skippedHtml += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #E5ECF3;">${escapeHtml(item.customerName)}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #E5ECF3;">${item.reason}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #E5ECF3; font-size: 12px; color: #666;">${sentDate}</td>
                    </tr>
                `;
            });
            
            const modalHtml = `
                <div id="skippedReportsModal" class="modal-overlay active" onclick="closeSkippedModal(event)">
                    <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2 style="display: flex; align-items: center; gap: 10px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#F57600" stroke-width="2" style="width: 24px; height: 24px;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="8" x2="12" y2="12"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                                Reports Skipped
                            </h2>
                            <button class="modal-close" onclick="closeSkippedModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 15px; color: #666;">
                                The following ${skippedList.length} report(s) were skipped because they were already sent for 
                                <strong>${periodInfo.type || reportType} ${periodInfo.value || ''} ${periodInfo.year || ''}</strong>:
                            </p>
                            
                            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                <table class="data-table" style="font-size: 13px;">
                                    <thead>
                                        <tr>
                                            <th>Customer</th>
                                            <th>Reason</th>
                                            <th>Originally Sent</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${skippedHtml}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #FFF3E0; border-radius: 8px; border-left: 4px solid #F57600;">
                                <p style="margin: 0; font-size: 13px;">
                                    <strong>Need to resend anyway?</strong><br>
                                    Click "Force Resend All" to send reports to ALL clients, including those already sent.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeSkippedModal()">Close</button>
                            <button class="btn btn-primary" onclick="forceResendAll('${reportType}')" style="background: #F57600;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                                </svg>
                                Force Resend All
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeSkippedModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('skippedReportsModal');
            if (modal) modal.remove();
        }
        
        function forceResendAll(reportType) {
            closeSkippedModal();
            // Use the bulk send modal's force send function if modal is open, otherwise re-open it
            const bulkModal = document.getElementById('bulkSendModal');
            if (bulkModal && bulkModal.classList.contains('active')) {
                if (confirm('Are you sure you want to FORCE RESEND to ALL clients, including those who already received this report?\n\nThis will send duplicate reports.')) {
                    executeBulkSend(true);
                }
            } else {
                // Open modal and trigger force send
                openBulkSendModal(reportType);
                setTimeout(() => {
                    if (confirm('Are you sure you want to FORCE RESEND to ALL clients, including those who already received this report?\n\nThis will send duplicate reports.')) {
                        executeBulkSend(true);
                    }
                }, 100);
            }
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function getMonthName(month) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month - 1] || 'Unknown';
        }
        
        async function quickClientLookup() {
            const input = document.getElementById('quickLookupInput').value.trim();
            const container = document.getElementById('quickLookupResult');
            
            if (!input) {
                showToast('Please enter a client name or email', 'warning');
                return;
            }
            
            container.innerHTML = `
                <div class="loading" style="padding: 30px;">
                    <div class="spinner"></div>
                    <p>Searching...</p>
                </div>
            `;
            
            try {
                let result = await jsonpFetch({ action: 'getClientByEmail', email: input });
                
                if (!result.success) {
                    result = await jsonpFetch({ action: 'getClientByName', name: input });
                }
                
                if (result.success && result.client) {
                    const client = result.client;
                    const fullName = `${client['Name'] || ''} ${client['Last_Name'] || ''}`.trim();
                    
                    container.innerHTML = `
                        <div class="lookup-result-card">
                            <h4>${escapeHtml(fullName)}</h4>
                            <p>${escapeHtml(client['eMails'] || 'No email')}</p>
                            <button class="btn btn-primary" onclick="openClientDetail('${escapeHtml(client['eMails'])}')">
                                View Full Profile
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #999;">
                            <p>No client found matching "<strong>${escapeHtml(input)}</strong>"</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #FF7475;">
                        <p>Error searching for client</p>
                    </div>
                `;
            }
        }
        
        async function quickClientLookupByName(name) {
            try {
                const result = await jsonpFetch({ action: 'getClientByName', name: name });
                
                if (result.success && result.client && result.client['eMails']) {
                    openClientDetail(result.client['eMails']);
                } else {
                    showToast('Client details not found in directory', 'warning');
                }
            } catch (error) {
                showToast('Error looking up client', 'error');
            }
        }
        
        // ============================================
        // GLOBAL SEARCH
        // ============================================
        document.getElementById('globalSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    switchTab('client');
                    document.getElementById('filterClientName').value = query;
                    applyClientFilters();
                }
            }
        });
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return num.toLocaleString(undefined, { maximumFractionDigits: decimals });
        }
        
        function getStatusClass(status) {
            if (!status) return 'badge-pending';
            const s = status.toUpperCase();
            if (s === 'COMPLETED') return 'badge-completed';
            if (s === 'ASSIGNED') return 'badge-assigned';
            if (s === 'UNASSIGNED') return 'badge-unassigned';
            if (s.includes('CANCELLED')) return 'badge-cancelled';
            return 'badge-pending';
        }
        
        function getPaymentClass(status) {
            if (!status) return 'badge-pending';
            const s = status.toUpperCase();
            if (s === 'PAID' || s === 'PAID_BY_CC') return 'badge-paid';
            return 'badge-pending';
        }
        
        function formatStatus(status) {
            if (!status) return 'Pending';
            return status.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '--';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }
        
        function formatTime(timeVal) {
            if (!timeVal && timeVal !== 0) return '--';
            // If it's a decimal time (e.g., 0.29166 for 7:00 AM)
            if (typeof timeVal === 'number' && timeVal < 1) {
                const totalMinutes = Math.round(timeVal * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }
            // If it's already a string time
            if (typeof timeVal === 'string') {
                return timeVal;
            }
            return String(timeVal);
        }
        
        function getSubscriptionBadge(sub) {
            if (!sub || sub.toLowerCase() === 'none') {
                return '<span class="badge badge-none">None</span>';
            }
            const subLower = sub.toLowerCase();
            let badges = [];
            if (subLower.includes('weekly')) badges.push('<span class="badge badge-weekly">W</span>');
            if (subLower.includes('monthly')) badges.push('<span class="badge badge-monthly">M</span>');
            if (subLower.includes('yearly')) badges.push('<span class="badge badge-yearly">Y</span>');
            return badges.length > 0 ? badges.join(' ') : '<span class="badge badge-none">None</span>';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        function renderPagination(containerId, totalPages, current, onPageChange) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<button ${current === 1 ? 'disabled' : ''}>Â« Prev</button>`;
            
            const maxPages = 5;
            let startPage = Math.max(1, current - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === current ? 'active' : ''}">${i}</button>`;
            }
            
            html += `<button ${current === totalPages ? 'disabled' : ''}>Next Â»</button>`;
            html += `<span class="page-info">Page ${current} of ${totalPages}</span>`;
            
            container.innerHTML = html;
            
            container.querySelectorAll('button').forEach((btn, idx) => {
                btn.addEventListener('click', () => {
                    if (idx === 0 && current > 1) {
                        onPageChange(current - 1);
                    } else if (idx === container.querySelectorAll('button').length - 1 && current < totalPages) {
                        onPageChange(current + 1);
                    } else {
                        const pageNum = parseInt(btn.textContent);
                        if (!isNaN(pageNum)) {
                            onPageChange(pageNum);
                        }
                    }
                });
            });
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Loading Spinner Functions
        function showLoading(text = 'Loading...', subtext = 'Please wait') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        function updateLoadingText(text, subtext) {
            if (text) document.getElementById('loadingText').textContent = text;
            if (subtext) document.getElementById('loadingSubtext').textContent = subtext;
        }
        
        function exportReport() {
            if (reportData.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            // Export headers
            const exportHeaders = ['Customer Name', 'Date', 'Start Time', 'End Time', 'Provider', 'Duration HRS', '$/Hr', 'Total $'];
            
            let csv = exportHeaders.join(',') + '\n';
            
            reportData.forEach(row => {
                const duration = parseFloat(row['Service Duration']) || 0;
                const durationHrs = (duration / 60).toFixed(2);
                const costToCustomer = parseFloat(row['Cost To Customer']) || 0;
                const ratePerHour = durationHrs > 0 ? (costToCustomer / durationHrs).toFixed(2) : '0.00';
                
                const values = [
                    row['Customer Name'] || '',
                    row['Scheduled Date'] || '',
                    row['STxTime'] || '',
                    row['ETxTime'] || '',
                    row['Provider Name'] || '',
                    durationHrs,
                    ratePerHour,
                    costToCustomer.toFixed(2)
                ].map(val => {
                    val = String(val).replace(/"/g, '""');
                    return `"${val}"`;
                });
                
                csv += values.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `service_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Report exported successfully', 'success');
        }
        
        // ============================================
        // CSV UPLOAD FUNCTIONS
        // ============================================
        let selectedFile = null;
        let csvContent = '';
        
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
        }
        
        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            clearFileSelection();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                showToast('Please select a CSV file', 'error');
                return;
            }
            
            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                csvContent = e.target.result;
                
                // Parse to get stats
                const lines = csvContent.split('\n').filter(line => line.trim());
                const headers = lines[0] ? lines[0].split(',').length : 0;
                
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('rowCount').textContent = lines.length - 1; // Exclude header
                document.getElementById('colCount').textContent = headers;
                
                document.getElementById('uploadArea').querySelector('.upload-dropzone').style.display = 'none';
                document.getElementById('filePreview').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false;
            };
            reader.readAsText(file);
        }
        
        function clearFileSelection() {
            selectedFile = null;
            csvContent = '';
            document.getElementById('csvFileInput').value = '';
            document.getElementById('uploadArea').querySelector('.upload-dropzone').style.display = 'block';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function uploadCSVFile() {
            if (!csvContent) {
                showToast('No file selected', 'error');
                return;
            }
            
            const uploadMode = document.querySelector('input[name="uploadMode"]:checked').value;
            const uploadBtn = document.getElementById('uploadBtn');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Uploading...';
            
            // Show loading overlay
            const rowCount = (csvContent.match(/\n/g) || []).length;
            showLoading('Uploading Data', `Processing ${rowCount.toLocaleString()} rows (${uploadMode} mode)...`);
            
            try {
                updateLoadingText('Uploading Data', 'Sending data to server...');
                
                // Create form data for POST
                const formData = new FormData();
                formData.append('action', 'uploadCSV');
                formData.append('csvData', csvContent);
                formData.append('mode', uploadMode);
                
                // Use fetch with POST
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'uploadCSV',
                        csvData: csvContent,
                        mode: uploadMode
                    })
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showToast(`Successfully uploaded ${result.rowsAdded} rows!`, 'success');
                    closeUploadModal();
                    // Reload the report data
                    currentPage = 1;
                    loadReportData();
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                // Try JSONP fallback for CORS issues
                try {
                    updateLoadingText('Uploading Data', 'Retrying with alternate method...');
                    const result = await uploadViaJSONP(csvContent, uploadMode);
                    hideLoading();
                    if (result.success) {
                        showToast(`Successfully uploaded ${result.rowsAdded} rows!`, 'success');
                        closeUploadModal();
                        currentPage = 1;
                        loadReportData();
                    } else {
                        throw new Error(result.error || 'Upload failed');
                    }
                } catch (jsonpError) {
                    hideLoading();
                    showToast('Upload failed: ' + jsonpError.message, 'error');
                }
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload
                `;
            }
        }
        
        function uploadViaJSONP(csvData, mode) {
            return new Promise((resolve, reject) => {
                const callbackName = 'upload_callback_' + Math.round(100000 * Math.random());
                
                // For large CSV, we need to chunk or encode it
                const encodedCSV = encodeURIComponent(csvData);
                
                // Check if data is too large for URL
                if (encodedCSV.length > 8000) {
                    reject(new Error('CSV file too large for this upload method. Please use a smaller file or contact support.'));
                    return;
                }
                
                const script = document.createElement('script');
                const url = `${WEBAPP_URL}?action=uploadCSV&csvData=${encodedCSV}&mode=${mode}&callback=${callbackName}`;
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Upload request failed'));
                };
                
                script.src = url;
                document.body.appendChild(script);
                
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        reject(new Error('Upload timeout'));
                    }
                }, 60000);
            });
        }
        
        // Drag and drop support
        document.addEventListener('DOMContentLoaded', function() {
            const dropzone = document.querySelector('.upload-dropzone');
            if (dropzone) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'), false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'), false);
                });
                
                dropzone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        processFile(files[0]);
                    }
                }, false);
            }
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            if (WEBAPP_URL === 'YOUR_WEBAPP_URL_HERE') {
                document.getElementById('reportTableContainer').innerHTML = `
                    <div class="notice-box">
                        <h3>âš ï¸ Configuration Required</h3>
                        <p>Please update the <code style="background: #1A365C; color: white; padding: 2px 6px; border-radius: 4px;">WEBAPP_URL</code> in the JavaScript section with your deployed Google Apps Script Web App URL.</p>
                               </div>
                `;
                return;
            }
            
            // Initialize tabs - use the switchTab function
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });
            
            // Load initial data
            loadConfig();
            
            // Default to Client tab on page load
            switchTab('client');
            
            // Global search handler
            const globalSearchInput = document.getElementById('globalSearch');
            if (globalSearchInput) {
                globalSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        if (query) {
                            // Switch to client tab and search
                            switchTab('client');
                            
                            if (clientData.length === 0) {
                                loadClientData().then(() => {
                                    document.getElementById('filterClientName').value = query;
                                    applyClientFilters();
                                });
                            } else {
                                document.getElementById('filterClientName').value = query;
                                applyClientFilters();
                            }
                        }
                    }
                });
            }
        });
        
        // ============================================
        // LTC IMPORT FUNCTIONS
        // ============================================
        
        async function showLTCImportModal() {
            document.getElementById('ltcImportModal').classList.add('active');
            document.getElementById('ltcLoadingState').style.display = 'block';
            document.getElementById('ltcRecordsList').style.display = 'none';
            document.getElementById('ltcNoRecords').style.display = 'none';
            document.getElementById('ltcError').style.display = 'none';
            
            try {
                const result = await jsonpFetch({ action: 'getLTCIntakeRecords' });
                
                if (result.success) {
                    ltcRecords = result.records || [];
                    
                    if (ltcRecords.length === 0) {
                        document.getElementById('ltcLoadingState').style.display = 'none';
                        document.getElementById('ltcNoRecords').style.display = 'block';
                    } else {
                        document.getElementById('ltcLoadingState').style.display = 'none';
                        document.getElementById('ltcRecordsList').style.display = 'block';
                        renderLTCRecords(ltcRecords);
                    }
                } else {
                    throw new Error(result.error || 'Failed to load records');
                }
            } catch (error) {
                document.getElementById('ltcLoadingState').style.display = 'none';
                document.getElementById('ltcError').style.display = 'block';
                document.getElementById('ltcErrorMessage').textContent = error.message;
            }
        }
        
        function closeLTCImportModal() {
            document.getElementById('ltcImportModal').classList.remove('active');
        }
        
        function filterLTCRecords() {
            const query = document.getElementById('ltcSearchInput').value.toLowerCase().trim();
            
            if (!query) {
                renderLTCRecords(ltcRecords);
                return;
            }
            
            const filtered = ltcRecords.filter(record => {
                const name = (record.insuredName || '').toLowerCase();
                const email = (record.email || '').toLowerCase();
                const insurance = (record.insurance || '').toLowerCase();
                const phone = (record.phone || '').toLowerCase();
                
                return name.includes(query) || email.includes(query) || 
                       insurance.includes(query) || phone.includes(query);
            });
            
            renderLTCRecords(filtered);
        }
        
        function renderLTCRecords(records) {
            const container = document.getElementById('ltcRecordsTable');
            
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No matching records found.</p>';
                return;
            }
            
            const html = `
                <table class="data-table" style="font-size: 12px;">
                    <thead>
                        <tr>
                            <th>ReqN</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Insurance</th>
                            <th>Policy</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr>
                                <td>${record.reqN || '--'}</td>
                                <td><strong>${escapeHtml(record.insuredName || '--')}</strong></td>
                                <td>${escapeHtml(record.email || '--')}</td>
                                <td>${escapeHtml(record.phone || '--')}</td>
                                <td>${escapeHtml(record.insurance || '--')}</td>
                                <td>${escapeHtml(record.policy || '--')}</td>
                                <td>${record.startServiceDate || '--'}</td>
                                <td>
                                    <button class="btn btn-small" onclick="selectLTCRecord(${record.rowIndex})" style="padding: 6px 12px; font-size: 11px;">
                                        Select
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function selectLTCRecord(rowIndex) {
            selectedLTCRecord = ltcRecords.find(r => r.rowIndex === rowIndex);
            
            if (!selectedLTCRecord) {
                showToast('Record not found', 'error');
                return;
            }
            
            // Show confirmation modal
            const content = document.getElementById('ltcConfirmContent');
            content.innerHTML = `
                <div style="background: #F9FAFB; border-radius: 8px; padding: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #1A365C;">Client Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Name</label>
                            <p style="margin: 5px 0; font-weight: 600;">${escapeHtml(selectedLTCRecord.insuredName || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Email</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.email || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Phone</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.phone || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Address</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.address || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Insurance</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.insurance || '--')}</p>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; text-transform: uppercase;">Policy / Claim</label>
                            <p style="margin: 5px 0;">${escapeHtml(selectedLTCRecord.policy || '--')} / ${escapeHtml(selectedLTCRecord.claim || '--')}</p>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: #1A365C;">ADL Services</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${renderADLServices(selectedLTCRecord.adlServices)}
                    </div>
                    ${selectedLTCRecord.adlServices ? '' : '<p style="color: #999; font-size: 12px; margin-top: 5px;">No ADL services specified</p>'}
                </div>
            `;
            
            // Reset duplicate warning
            document.getElementById('ltcDuplicateWarning').style.display = 'none';
            document.getElementById('ltcConfirmBtn').style.display = 'inline-flex';
            document.getElementById('ltcForceImportBtn').style.display = 'none';
            
            // Show confirm modal
            document.getElementById('ltcConfirmModal').classList.add('active');
        }
        
        // Helper function to render ADL service codes as badges
        function renderADLServices(adlServicesStr) {
            if (!adlServicesStr) return '';
            
            const codeLabels = {
                'BA': 'Bathing',
                'DR': 'Dressing',
                'TR': 'Transferring',
                'CO': 'Continence',
                'TO': 'Toileting',
                'EA': 'Eating',
                'AM': 'Ambulation',
                'CS': 'Cognitive Supervision',
                'HM': 'Homemaker'
            };
            
            const codes = adlServicesStr.toUpperCase().split(',').map(s => s.trim()).filter(s => s);
            
            return codes.map(code => {
                const label = codeLabels[code] || code;
                return `<span style="background: #E8F5E9; color: #2E7D32; padding: 4px 10px; border-radius: 4px; font-size: 12px;">${code} - ${label}</span>`;
            }).join('');
        }
        
        function closeLTCConfirmModal() {
            document.getElementById('ltcConfirmModal').classList.remove('active');
            selectedLTCRecord = null;
        }
        
        async function confirmLTCImport() {
            if (!selectedLTCRecord) {
                showToast('No record selected', 'error');
                return;
            }
            
            const btn = document.getElementById('ltcConfirmBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Importing...';
            
            try {
                const result = await jsonpFetch({
                    action: 'importFromLTC',
                    ...selectedLTCRecord
                });
                
                if (result.success) {
                    showToast('Client imported successfully!', 'success');
                    closeLTCConfirmModal();
                    closeLTCImportModal();
                    // Reload client data
                    await loadClientData();
                } else if (result.duplicates && result.duplicates.length > 0) {
                    // Show duplicate warning
                    const duplicateHtml = result.duplicates.map(dup => `
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 8px;">
                            <strong>${escapeHtml(dup.customerName)}</strong>
                            <div style="font-size: 12px; color: #666;">
                                ${dup.email ? 'Email: ' + escapeHtml(dup.email) : ''}
                                ${dup.phone ? ' | Phone: ' + escapeHtml(dup.phone) : ''}
                            </div>
                            <div style="font-size: 11px; color: #F57600; margin-top: 4px;">
                                Match: ${dup.matchType.replace('_', ' ')} (${dup.matchScore}%)
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('ltcDuplicateDetails').innerHTML = duplicateHtml;
                    document.getElementById('ltcDuplicateWarning').style.display = 'block';
                    document.getElementById('ltcConfirmBtn').style.display = 'none';
                    document.getElementById('ltcForceImportBtn').style.display = 'inline-flex';
                    
                    showToast('Potential duplicate found - review and confirm', 'warning');
                } else {
                    showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Import Client
            `;
        }
        
        async function forceImportLTC() {
            if (!selectedLTCRecord) {
                showToast('No record selected', 'error');
                return;
            }
            
            const btn = document.getElementById('ltcForceImportBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Importing...';
            
            try {
                const result = await jsonpFetch({
                    action: 'forceImportFromLTC',
                    ...selectedLTCRecord
                });
                
                if (result.success) {
                    showToast('Client imported successfully!', 'success');
                    closeLTCConfirmModal();
                    closeLTCImportModal();
                    // Reload client data
                    await loadClientData();
                } else {
                    showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'Import Anyway';
        }
        
        // ============================================
        // EXPECTED REPORTS FUNCTIONS
        // ============================================
        
        function initializeExpectedReportPeriod() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            
            // Calculate current week number
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            const days = Math.floor((today - startOfYear) / (24 * 60 * 60 * 1000));
            const currentWeek = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            
            // Set default values
            document.getElementById('expectedWeek').value = currentWeek;
            document.getElementById('expectedMonth').value = currentMonth;
            document.getElementById('expectedYear').value = currentYear;
            
            // Populate insurance dropdown if client data is loaded
            populateExpectedInsuranceFilter();
        }
        
        function populateExpectedInsuranceFilter() {
            const select = document.getElementById('expectedInsurance');
            if (!select) return;
            
            // Save current selection
            const currentValue = select.value;
            
            // Get unique insurance names from client data
            const insuranceNames = [...new Set(clientData.map(c => c['Insurance_Name']).filter(Boolean))];
            
            select.innerHTML = '<option value="">All Insurance</option>';
            insuranceNames.sort().forEach(name => {
                select.innerHTML += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            });
            
            // Restore selection if it still exists
            if (currentValue && insuranceNames.includes(currentValue)) {
                select.value = currentValue;
            }
        }
        
        function selectPeriodType(type) {
            expectedPeriodType = type;
            
            // Update button states
            document.querySelectorAll('.period-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === type);
            });
            
            // Show/hide relevant selectors
            document.getElementById('weekSelector').style.display = type === 'week' ? 'block' : 'none';
            document.getElementById('monthSelector').style.display = type === 'month' ? 'block' : 'none';
        }
        
        async function loadExpectedReports() {
            const container = document.getElementById('expectedTableContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading expected reports...</p>
                </div>
            `;
            
            // Hide stats while loading
            document.getElementById('expectedStats').style.display = 'none';
            document.getElementById('noServicesSection').style.display = 'none';
            
            try {
                // Load client data if not already loaded (needed for filtering)
                if (clientData.length === 0) {
                    const clientResult = await jsonpFetch({ action: 'getClientList' });
                    if (clientResult.success) {
                        clientData = clientResult.data;
                        populateExpectedInsuranceFilter();
                    }
                }
                
                const filters = {
                    action: 'getServiceReport',
                    year: document.getElementById('expectedYear').value
                };
                
                if (expectedPeriodType === 'week') {
                    filters.week = document.getElementById('expectedWeek').value;
                } else if (expectedPeriodType === 'month') {
                    filters.month = document.getElementById('expectedMonth').value;
                }
                // For 'year', we only need the year filter which is already set
                
                const result = await jsonpFetch(filters);
                
                if (result.success) {
                    expectedReportData = result.data || [];
                    expandedClients.clear();
                    sentStatusMap.clear();
                    expectedCurrentPage = 1;
                    
                    // Check sent status for all clients with matching subscription
                    await checkAllSentStatus();
                    
                    renderExpectedReportsTable();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <h3>Failed to load expected reports</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-secondary" style="margin-top: 15px;" onclick="loadExpectedReports()">Try Again</button>
                    </div>
                `;
            }
        }
        
        /**
         * Check sent status for all clients with matching subscription
         */
        async function checkAllSentStatus() {
            // Get report type label based on period type
            const reportTypeMap = {
                'week': 'Weekly',
                'month': 'Monthly',
                'year': 'Yearly'
            };
            const reportType = reportTypeMap[expectedPeriodType] || 'Weekly';
            
            // Get period value
            let periodValue;
            if (expectedPeriodType === 'week') {
                periodValue = document.getElementById('expectedWeek').value;
            } else if (expectedPeriodType === 'month') {
                periodValue = document.getElementById('expectedMonth').value;
            } else {
                periodValue = document.getElementById('expectedYear').value;
            }
            const year = document.getElementById('expectedYear').value;
            
            // Get all unique customer names from service data
            const customersWithServices = [...new Set(expectedReportData.map(row => row['Customer Name']).filter(Boolean))];
            
            // Get all clients with matching subscription (for no services section)
            const subscribedClients = getClientsWithMatchingSubscription();
            const allCustomerNames = [...new Set([
                ...customersWithServices,
                ...subscribedClients.map(c => c.customerName)
            ])];
            
            // Check sent status for each client (in batches to avoid overwhelming the server)
            const batchSize = 10;
            for (let i = 0; i < allCustomerNames.length; i += batchSize) {
                const batch = allCustomerNames.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (customerName) => {
                    try {
                        const result = await jsonpFetch({
                            action: 'checkReportSent',
                            customerName: customerName,
                            reportType: reportType,
                            periodValue: periodValue,
                            year: year
                        });
                        
                        if (result.success) {
                            sentStatusMap.set(customerName.toLowerCase().trim(), {
                                sent: result.alreadySent,
                                sentDate: result.logEntry?.timestamp || null
                            });
                        }
                    } catch (e) {
                        console.error('Error checking sent status for', customerName, e);
                    }
                }));
            }
        }
        
        /**
         * Get sent status for a customer
         */
        function getSentStatus(customerName) {
            const key = (customerName || '').toLowerCase().trim();
            return sentStatusMap.get(key) || { sent: false, sentDate: null };
        }
        
        function getClientInfo(customerName) {
            // Find client in clientData by Customer Name
            const client = clientData.find(c => 
                (c['Customer Name'] || '').toLowerCase().trim() === customerName.toLowerCase().trim()
            );
            
            if (client) {
                return {
                    insurance: client['Insurance_Name'] || '--',
                    subscription: client['Subscription'] || 'None',
                    assignment: String(client['Assigment_Y1_N0']) === '1'
                };
            }
            
            return {
                insurance: '--',
                subscription: 'None',
                assignment: false
            };
        }
        
        function applyExpectedFilters() {
            expectedCurrentPage = 1;
            renderExpectedReportsTable();
        }
        
        function clearExpectedFilters() {
            document.getElementById('expectedInsurance').value = '';
            document.getElementById('expectedFrequency').value = '';
            document.getElementById('expectedAssignment').value = '';
            document.getElementById('expectedSentStatus').value = '';
            expectedCurrentPage = 1;
            renderExpectedReportsTable();
        }
        
        function aggregateExpectedReports(data) {
            const clientMap = new Map();
            
            data.forEach(row => {
                const customerName = row['Customer Name'] || 'Unknown';
                const duration = parseFloat(row['Service Duration']) || 0;
                const durationHrs = duration / 60;
                const cost = parseFloat(row['Cost To Customer']) || 0;
                const status = (row['Status'] || '').toUpperCase().trim();
                const paymentStatus = (row['Payment Status'] || '').toUpperCase().trim();
                const isCompleted = status === 'COMPLETED';
                const isPaid = paymentStatus === 'PAID';
                
                if (!clientMap.has(customerName)) {
                    const clientInfo = getClientInfo(customerName);
                    clientMap.set(customerName, {
                        customerName: customerName,
                        insurance: clientInfo.insurance,
                        subscription: clientInfo.subscription,
                        assignment: clientInfo.assignment,
                        services: [],
                        totalHours: 0,
                        totalCost: 0,
                        serviceCount: 0,
                        // Completed-only totals
                        completedHours: 0,
                        completedCost: 0,
                        completedCount: 0,
                        // Billable totals (for AOB: completed + PAID only)
                        billableHours: 0,
                        billableCost: 0,
                        billableCount: 0,
                        // Status counts
                        statusCounts: {},
                        // Payment status counts
                        paymentStatusCounts: {}
                    });
                }
                
                const client = clientMap.get(customerName);
                client.services.push({
                    date: row['Scheduled Date'],
                    startTime: row['STxTime'],
                    endTime: row['ETxTime'],
                    provider: row['Provider Name'] || 'Unassigned',
                    duration: durationHrs,
                    cost: cost,
                    status: status || 'UNKNOWN',
                    paymentStatus: paymentStatus || 'UNKNOWN'
                });
                
                // All services totals
                client.totalHours += durationHrs;
                client.totalCost += cost;
                client.serviceCount++;
                
                // Completed-only totals
                if (isCompleted) {
                    client.completedHours += durationHrs;
                    client.completedCost += cost;
                    client.completedCount++;
                    
                    // Billable totals (completed + PAID for AOB filtering)
                    if (isPaid) {
                        client.billableHours += durationHrs;
                        client.billableCost += cost;
                        client.billableCount++;
                    }
                    
                    // Track payment status counts (for completed services)
                    const paymentKey = paymentStatus || 'UNKNOWN';
                    client.paymentStatusCounts[paymentKey] = (client.paymentStatusCounts[paymentKey] || 0) + 1;
                }
                
                // Track status counts
                const statusKey = status || 'UNKNOWN';
                client.statusCounts[statusKey] = (client.statusCounts[statusKey] || 0) + 1;
            });
            
            // Calculate average rate for each client (based on completed only)
            const aggregated = Array.from(clientMap.values()).map(client => ({
                ...client,
                avgRate: client.completedHours > 0 ? (client.completedCost / client.completedHours) : 0
            }));
            
            // Sort by completed cost descending by default
            return aggregated.sort((a, b) => b.completedCost - a.completedCost);
        }
        
        function getClientsWithMatchingSubscription() {
            // Get the frequency that matches the selected period type
            const frequencyMap = {
                'week': 'weekly',
                'month': 'monthly',
                'year': 'yearly'
            };
            const targetFrequency = frequencyMap[expectedPeriodType] || '';
            
            // Find all clients who have this subscription frequency
            return clientData.filter(client => {
                const subscription = (client['Subscription'] || '').toLowerCase();
                return subscription.includes(targetFrequency);
            }).map(client => ({
                customerName: client['Customer Name'] || '',
                insurance: client['Insurance_Name'] || '--',
                subscription: client['Subscription'] || 'None',
                assignment: String(client['Assigment_Y1_N0']) === '1',
                email: client['email'] || '--',
                phone: client['Phone'] || '--'
            }));
        }
        
        function getFilteredExpectedData() {
            let aggregated = aggregateExpectedReports(expectedReportData);
            
            // Apply filters
            const insuranceFilter = document.getElementById('expectedInsurance')?.value || '';
            const frequencyFilter = document.getElementById('expectedFrequency')?.value || '';
            const assignmentFilter = document.getElementById('expectedAssignment')?.value || '';
            const sentStatusFilter = document.getElementById('expectedSentStatus')?.value || '';
            
            if (insuranceFilter) {
                aggregated = aggregated.filter(c => c.insurance === insuranceFilter);
            }
            
            if (frequencyFilter) {
                aggregated = aggregated.filter(c => {
                    const sub = (c.subscription || '').toLowerCase();
                    return sub.includes(frequencyFilter.toLowerCase());
                });
            }
            
            if (assignmentFilter !== '') {
                const isAssigned = assignmentFilter === '1';
                aggregated = aggregated.filter(c => c.assignment === isAssigned);
            }
            
            if (sentStatusFilter) {
                aggregated = aggregated.filter(c => {
                    const status = getSentStatus(c.customerName);
                    if (sentStatusFilter === 'sent') {
                        return status.sent === true;
                    } else if (sentStatusFilter === 'pending') {
                        return status.sent === false;
                    }
                    return true;
                });
            }
            
            return aggregated;
        }
        
        function getClientsWithNoServices() {
            // Get all clients with matching subscription
            const subscribedClients = getClientsWithMatchingSubscription();
            
            // Get customer names who had services
            const clientsWithServices = new Set(
                expectedReportData.map(row => (row['Customer Name'] || '').toLowerCase().trim())
            );
            
            // Filter to only those without services
            let noServiceClients = subscribedClients.filter(client => 
                !clientsWithServices.has(client.customerName.toLowerCase().trim())
            );
            
            // Apply same filters
            const insuranceFilter = document.getElementById('expectedInsurance')?.value || '';
            const frequencyFilter = document.getElementById('expectedFrequency')?.value || '';
            const assignmentFilter = document.getElementById('expectedAssignment')?.value || '';
            const sentStatusFilter = document.getElementById('expectedSentStatus')?.value || '';
            
            if (insuranceFilter) {
                noServiceClients = noServiceClients.filter(c => c.insurance === insuranceFilter);
            }
            
            if (frequencyFilter) {
                noServiceClients = noServiceClients.filter(c => {
                    const sub = (c.subscription || '').toLowerCase();
                    return sub.includes(frequencyFilter.toLowerCase());
                });
            }
            
            if (assignmentFilter !== '') {
                const isAssigned = assignmentFilter === '1';
                noServiceClients = noServiceClients.filter(c => c.assignment === isAssigned);
            }
            
            if (sentStatusFilter) {
                noServiceClients = noServiceClients.filter(c => {
                    const status = getSentStatus(c.customerName);
                    if (sentStatusFilter === 'sent') {
                        return status.sent === true;
                    } else if (sentStatusFilter === 'pending') {
                        return status.sent === false;
                    }
                    return true;
                });
            }
            
            return noServiceClients.sort((a, b) => a.customerName.localeCompare(b.customerName));
        }
        
        function renderExpectedReportsTable() {
            const container = document.getElementById('expectedTableContainer');
            const noServicesSection = document.getElementById('noServicesSection');
            const noServicesContainer = document.getElementById('noServicesTableContainer');
            
            // Get clients with no services
            const noServiceClients = getClientsWithNoServices();
            
            // Check if we have any data loaded
            if (expectedReportData.length === 0 && noServiceClients.length === 0) {
                document.getElementById('expectedStats').style.display = 'none';
                noServicesSection.style.display = 'none';
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <h3>No services found</h3>
                        <p>No service records found for the selected period</p>
                    </div>
                `;
                return;
            }
            
            const aggregatedData = getFilteredExpectedData();
            
            // Render No Services section
            if (noServiceClients.length > 0) {
                noServicesSection.style.display = 'block';
                document.getElementById('noServicesCount').textContent = `${noServiceClients.length} client${noServiceClients.length !== 1 ? 's' : ''}`;
                
                let noServicesHtml = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Sent</th>
                                    <th>Customer Name</th>
                                    <th>Insurance</th>
                                    <th>Frequency</th>
                                    <th>Assignment</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                noServiceClients.forEach(client => {
                    // Get sent status
                    const sentStatus = getSentStatus(client.customerName);
                    const sentBadge = sentStatus.sent 
                        ? `<span class="badge" style="background: #E8F5E9; color: #4CAF50;" title="Sent: ${sentStatus.sentDate || 'Unknown date'}">âœ“</span>`
                        : '<span class="badge" style="background: #FFF3E0; color: #F57600;">â€”</span>';
                    
                    // Format subscription badges
                    const subscription = (client.subscription || '').toLowerCase();
                    let frequencyBadges = [];
                    if (subscription.includes('weekly')) {
                        frequencyBadges.push('<span class="badge" style="background: #E3F2FD; color: #2196F3;">W</span>');
                    }
                    if (subscription.includes('monthly')) {
                        frequencyBadges.push('<span class="badge" style="background: #E0F1E9; color: #62B790;">M</span>');
                    }
                    if (subscription.includes('yearly')) {
                        frequencyBadges.push('<span class="badge" style="background: #FFF3E0; color: #F57600;">Y</span>');
                    }
                    const frequencyBadge = frequencyBadges.join(' ');
                    
                    // Format assignment badge
                    const assignmentBadge = client.assignment 
                        ? '<span class="badge" style="background: #F3E5F5; color: #9C27B0;">Yes</span>'
                        : '<span class="badge" style="background: #E3F2FD; color: #2196F3;">No</span>';
                    
                    noServicesHtml += `
                        <tr style="background: #FFF8F8;">
                            <td style="text-align: center;">${sentBadge}</td>
                            <td><strong>${escapeHtml(client.customerName)}</strong></td>
                            <td>${escapeHtml(client.insurance)}</td>
                            <td>${frequencyBadge}</td>
                            <td>${assignmentBadge}</td>
                            <td>${escapeHtml(client.email)}</td>
                            <td>${escapeHtml(client.phone)}</td>
                        </tr>
                    `;
                });
                
                noServicesHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                noServicesContainer.innerHTML = noServicesHtml;
            } else {
                noServicesSection.style.display = 'none';
            }
            
            // Handle case where no clients with services match filters
            if (aggregatedData.length === 0) {
                document.getElementById('expectedStats').style.display = 'none';
                if (noServiceClients.length > 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                            </svg>
                            <h3>No clients with services</h3>
                            <p>No clients with services match the current filters. See "No Services" section below for clients expecting reports.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                            </svg>
                            <h3>No matching clients</h3>
                            <p>No clients match the selected filters. Try adjusting your filter criteria.</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Update stats (using completed-only totals)
            document.getElementById('expectedStats').style.display = 'flex';
            document.getElementById('expectedClientCount').textContent = aggregatedData.length;
            const totalCompletedServices = aggregatedData.reduce((sum, c) => sum + c.completedCount, 0);
            const totalAllServices = aggregatedData.reduce((sum, c) => sum + c.serviceCount, 0);
            document.getElementById('expectedServiceCount').textContent = totalCompletedServices + ' / ' + totalAllServices;
            const totalCompletedRevenue = aggregatedData.reduce((sum, c) => sum + c.completedCost, 0);
            document.getElementById('expectedTotalRevenue').textContent = '$' + totalCompletedRevenue.toFixed(2);
            
            // Calculate sent/pending counts (including no-service clients)
            const allClients = [...aggregatedData, ...noServiceClients];
            const sentCount = allClients.filter(c => getSentStatus(c.customerName).sent).length;
            const pendingCount = allClients.length - sentCount;
            document.getElementById('expectedSentCount').textContent = sentCount;
            document.getElementById('expectedPendingCount').textContent = pendingCount;
            
            // Pagination
            const totalPages = Math.ceil(aggregatedData.length / PAGE_SIZE);
            const start = (expectedCurrentPage - 1) * PAGE_SIZE;
            const pageData = aggregatedData.slice(start, start + PAGE_SIZE);
            
            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th style="width: 60px;">Sent</th>
                                <th>Customer Name</th>
                                <th>Insurance</th>
                                <th>Frequency</th>
                                <th>Assignment</th>
                                <th>Status</th>
                                <th>$/Hr (Avg)</th>
                                <th>Completed Hrs</th>
                                <th>Services</th>
                                <th>Completed $</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageData.forEach((client, index) => {
                const clientId = `client_${start + index}`;
                const isExpanded = expandedClients.has(client.customerName);
                
                // Get sent status
                const sentStatus = getSentStatus(client.customerName);
                const sentBadge = sentStatus.sent 
                    ? `<span class="badge" style="background: #E8F5E9; color: #4CAF50;" title="Sent: ${sentStatus.sentDate || 'Unknown date'}">âœ“</span>`
                    : '<span class="badge" style="background: #FFF3E0; color: #F57600;">â€”</span>';
                
                // Format subscription badges
                const subscription = (client.subscription || '').toLowerCase();
                let frequencyBadges = [];
                if (subscription.includes('weekly')) {
                    frequencyBadges.push('<span class="badge" style="background: #E3F2FD; color: #2196F3;">W</span>');
                }
                if (subscription.includes('monthly')) {
                    frequencyBadges.push('<span class="badge" style="background: #E0F1E9; color: #62B790;">M</span>');
                }
                if (subscription.includes('yearly')) {
                    frequencyBadges.push('<span class="badge" style="background: #FFF3E0; color: #F57600;">Y</span>');
                }
                const frequencyBadge = frequencyBadges.length > 0 
                    ? frequencyBadges.join(' ') 
                    : '<span class="badge" style="background: #F5F5F5; color: #999;">None</span>';
                
                // Format assignment badge
                const assignmentBadge = client.assignment 
                    ? '<span class="badge" style="background: #F3E5F5; color: #9C27B0;">Yes</span>'
                    : '<span class="badge" style="background: #E3F2FD; color: #2196F3;">No</span>';
                
                // Format status badges
                let statusBadges = [];
                const statusColors = {
                    'COMPLETED': { bg: '#E8F5E9', color: '#4CAF50' },
                    'CANCELLED': { bg: '#FFEBEE', color: '#F44336' },
                    'PENDING': { bg: '#FFF3E0', color: '#F57600' },
                    'SCHEDULED': { bg: '#E3F2FD', color: '#2196F3' },
                    'IN PROGRESS': { bg: '#E1F5FE', color: '#03A9F4' },
                    'UNKNOWN': { bg: '#F5F5F5', color: '#999' }
                };
                Object.entries(client.statusCounts).forEach(([status, count]) => {
                    const colors = statusColors[status] || statusColors['UNKNOWN'];
                    const shortStatus = status.substring(0, 3).toUpperCase();
                    statusBadges.push(`<span class="badge" style="background: ${colors.bg}; color: ${colors.color};" title="${status}: ${count}">${shortStatus}:${count}</span>`);
                });
                const statusBadge = statusBadges.join(' ');
                
                // Service count display (completed / total)
                const serviceCountDisplay = client.completedCount === client.serviceCount 
                    ? client.serviceCount 
                    : `${client.completedCount}/${client.serviceCount}`;
                
                html += `
                    <tr class="expandable-row" onclick="toggleClientExpand('${escapeHtml(client.customerName)}')">
                        <td>
                            <span class="expand-btn ${isExpanded ? 'expanded' : ''}" id="btn_${clientId}">+</span>
                        </td>
                        <td style="text-align: center;">${sentBadge}</td>
                        <td><strong>${escapeHtml(client.customerName)}</strong></td>
                        <td>${escapeHtml(client.insurance)}</td>
                        <td>${frequencyBadge}</td>
                        <td>${assignmentBadge}</td>
                        <td style="font-size: 11px;">${statusBadge}</td>
                        <td>$${client.avgRate.toFixed(2)}</td>
                        <td>${client.completedHours.toFixed(2)}</td>
                        <td>${serviceCountDisplay}</td>
                        <td><strong>$${client.completedCost.toFixed(2)}</strong></td>
                    </tr>
                    <tr class="service-details-row ${isExpanded ? 'expanded' : ''}" id="details_${clientId}">
                        <td colspan="11" class="service-details-cell">
                            <div class="service-details-wrapper">
                                ${client.assignment ? `
                                <div style="background: #FFF3E0; border-left: 4px solid #F57600; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; font-size: 12px;">
                                    <strong style="color: #E65100;">âš  Assignment of Benefits (AOB)</strong>: Only <span style="background: #E8F5E9; color: #2E7D32; padding: 2px 6px; border-radius: 3px; font-weight: 600;">PAID</span> transactions appear in the report sent to insurance. 
                                    <span style="background: #FFEBEE; color: #C62828; padding: 2px 6px; border-radius: 3px; font-weight: 600;">PAID_BY_CC</span> (client paid out of pocket) transactions are excluded.
                                </div>
                                ` : ''}
                                <table class="service-details-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Provider</th>
                                            <th>Status</th>
                                            <th>Payment</th>
                                            <th>Hours</th>
                                            <th>Cost</th>
                                            ${client.assignment ? '<th style="width: 70px;">In Report</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${client.services.map(s => {
                                            const sColors = statusColors[s.status] || statusColors['UNKNOWN'];
                                            const paymentColors = {
                                                'PAID': { bg: '#E8F5E9', color: '#2E7D32' },
                                                'PAID_BY_CC': { bg: '#FFEBEE', color: '#C62828' },
                                                'PENDING': { bg: '#FFF8E1', color: '#F57F17' },
                                                'DECLINED': { bg: '#FFEBEE', color: '#C62828' },
                                                'UNKNOWN': { bg: '#F5F5F5', color: '#757575' }
                                            };
                                            const pColors = paymentColors[s.paymentStatus] || paymentColors['UNKNOWN'];
                                            const isCompletedService = s.status === 'COMPLETED';
                                            const isPaidToInsurance = s.paymentStatus === 'PAID';
                                            const isExcludedFromAOB = client.assignment && isCompletedService && !isPaidToInsurance;
                                            let rowStyle = '';
                                            if (!isCompletedService) {
                                                rowStyle = 'opacity: 0.5; background: #F5F5F5;';
                                            } else if (isExcludedFromAOB) {
                                                rowStyle = 'background: #FFF8F8; opacity: 0.7;';
                                            }
                                            let inReportBadge = '';
                                            if (client.assignment) {
                                                if (!isCompletedService) {
                                                    inReportBadge = '<span class="badge" style="background: #F5F5F5; color: #999; font-size: 10px;">N/A</span>';
                                                } else if (isPaidToInsurance) {
                                                    inReportBadge = '<span class="badge" style="background: #E8F5E9; color: #2E7D32; font-size: 10px;">âœ“ Yes</span>';
                                                } else {
                                                    inReportBadge = '<span class="badge" style="background: #FFEBEE; color: #C62828; font-size: 10px;">âœ— No</span>';
                                                }
                                            }
                                            return `
                                            <tr style="${rowStyle}">
                                                <td>${formatDate(s.date)}</td>
                                                <td>${formatTime(s.startTime)}</td>
                                                <td>${formatTime(s.endTime)}</td>
                                                <td>${escapeHtml(s.provider)}</td>
                                                <td><span class="badge" style="background: ${sColors.bg}; color: ${sColors.color}; font-size: 10px;">${s.status}</span></td>
                                                <td><span class="badge" style="background: ${pColors.bg}; color: ${pColors.color}; font-size: 10px;">${s.paymentStatus || 'N/A'}</span></td>
                                                <td>${s.duration.toFixed(2)}</td>
                                                <td>$${s.cost.toFixed(2)}</td>
                                                ${client.assignment ? '<td style="text-align: center;">' + inReportBadge + '</td>' : ''}
                                            </tr>
                                        `}).join('')}
                                        ${client.assignment ? `
                                        <tr class="summary-row" style="background: #E8F5E9;">
                                            <td colspan="6" style="text-align: right;"><strong style="color: #2E7D32;">ðŸ“§ In Report (Billable to Insurance):</strong></td>
                                            <td><strong style="color: #2E7D32;">${client.billableHours.toFixed(2)}</strong></td>
                                            <td><strong style="color: #2E7D32;">$${client.billableCost.toFixed(2)}</strong></td>
                                            <td style="text-align: center;"><span class="badge" style="background: #2E7D32; color: white; font-size: 10px;">${client.billableCount}</span></td>
                                        </tr>
                                        ` : ''}
                                        <tr class="summary-row">
                                            <td colspan="${client.assignment ? 6 : 5}" style="text-align: right;"><strong>Completed Totals:</strong></td>
                                            <td><strong>${client.completedHours.toFixed(2)}</strong></td>
                                            <td><strong>$${client.completedCost.toFixed(2)}</strong></td>
                                            ${client.assignment ? '<td></td>' : ''}
                                        </tr>
                                        ${client.completedCount !== client.serviceCount ? `
                                        <tr class="summary-row" style="opacity: 0.6;">
                                            <td colspan="${client.assignment ? 6 : 5}" style="text-align: right; font-size: 11px;">All Services:</td>
                                            <td style="font-size: 11px;">${client.totalHours.toFixed(2)}</td>
                                            <td style="font-size: 11px;">$${client.totalCost.toFixed(2)}</td>
                                            ${client.assignment ? '<td></td>' : ''}
                                        </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            renderPagination('expectedPagination', totalPages, expectedCurrentPage, (page) => {
                expectedCurrentPage = page;
                renderExpectedReportsTable();
            });
        }
        
        function toggleClientExpand(customerName) {
            if (expandedClients.has(customerName)) {
                expandedClients.delete(customerName);
            } else {
                expandedClients.add(customerName);
            }
            renderExpectedReportsTable();
        }
        
        function exportExpectedReport() {
            const aggregatedData = getFilteredExpectedData();
            const noServiceClients = getClientsWithNoServices();
            
            if (aggregatedData.length === 0 && noServiceClients.length === 0) {
                showToast('No data to export. Please load a report first.', 'error');
                return;
            }
            
            // Create CSV content with status and completed totals
            let csv = 'Customer Name,Insurance,Report Frequency,Assignment of Benefits,Status Summary,Avg $/Hr,Completed Hours,Total Hours,Completed Services,Total Services,Completed $,Total $,Report Sent\n';
            
            // Add clients with services
            aggregatedData.forEach(client => {
                const assignmentText = client.assignment ? 'Yes' : 'No';
                const sentStatus = getSentStatus(client.customerName);
                const sentText = sentStatus.sent ? 'Yes' : 'No';
                // Build status summary string
                const statusSummary = Object.entries(client.statusCounts).map(([s, c]) => `${s}:${c}`).join(' | ');
                csv += `"${client.customerName}","${client.insurance}","${client.subscription}","${assignmentText}","${statusSummary}",${client.avgRate.toFixed(2)},${client.completedHours.toFixed(2)},${client.totalHours.toFixed(2)},${client.completedCount},${client.serviceCount},${client.completedCost.toFixed(2)},${client.totalCost.toFixed(2)},"${sentText}"\n`;
            });
            
            // Add clients without services
            noServiceClients.forEach(client => {
                const assignmentText = client.assignment ? 'Yes' : 'No';
                const sentStatus = getSentStatus(client.customerName);
                const sentText = sentStatus.sent ? 'Yes' : 'No';
                csv += `"${client.customerName}","${client.insurance}","${client.subscription}","${assignmentText}","No Services",0,0,0,0,0,0,"${sentText}"\n`;
            });
            
            // Add totals row (completed only)
            if (aggregatedData.length > 0) {
                const completedHours = aggregatedData.reduce((sum, c) => sum + c.completedHours, 0);
            gregatedData.reduce((sum, c) => sum + c.totalHours, 0);
                const totalCost = aggregatedData.reduce((sum, c) => sum + c.totalCost, 0);
                const totalServices = aggregatedData.reduce((sum, c) => sum + c.serviceCount, 0);
                csv += `\n"TOTALS","","","","",${(completedCost/completedHours || 0).toFixed(2)},${completedHours.toFixed(2)},${totalHours.toFixed(2)},${completedServices},${totalServices},${completedCost.toFixed(2)},${totalCost.toFixed(2)},""\n`;
            }
            
            // Calculate sent/pending summary
            const allClients = [...aggregatedData, ...noServiceClients];
            const sentCount = allClients.filter(c => getSentStatus(c.customerName).sent).length;
            const pendingCount = allClients.length - sentCount;
            
            csv += `\n"SUMMARY","","","","","","","","","","","",""\n`;
            csv += `"Clients with Services","","","","","","","","","",${aggregatedData.length},"",""\n`;
            csv += `"Clients without Services","","","","","","","","","",${noServiceClients.length},"",""\n`;
            csv += `"Reports Sent","","","","","","","","","","","",${sentCount}\n`;
            csv += `"Reports Pending","","","","","","","","","","","",${pendingCount}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const periodLabel = expectedPeriodType === 'week' 
                ? `Week${document.getElementById('expectedWeek').value}`
                : expectedPeriodType === 'month'
                ? `Month${document.getElementById('expectedMonth').value}`
                : 'Year';
            const year = document.getElementById('expectedYear').value;
            a.download = `expected_reports_${periodLabel}_${year}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Expected report exported successfully!', 'success');
        }
        
    </script>
</body>
</html>